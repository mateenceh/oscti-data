<!DOCTYPE html>
<html lang="en">

<head class="sans-serif">

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="baidu-site-verification" content="KeThzeyMOr" />
    <meta name="baidu-site-verification" content="code-NIlrS7gNhx" />

    <title>Building even faster interpreters in Rust</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/3.4.1/themes/light.css" />

    <link rel="stylesheet" type="text/css" href="/assets/built/index.css?v=fdf4009e30" />

    <script type="text/javascript" src="/assets/built/index.js?v=fdf4009e30"></script>
    <script src="/assets/js/check-for-tex.js" defer></script>

    <meta name="description" content="Firewall Rules lets customers filter the traffic hitting their site, powered by our Wirefilter engine. We’re excited to share some in-depth optimizations we have recently made to improve the performance of our edge." />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://blog.cloudflare.com/building-even-faster-interpreters-in-rust/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="The Cloudflare Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Building even faster interpreters in Rust" />
    <meta property="og:description" content="Firewall Rules lets customers filter the traffic hitting their site, powered by our Wirefilter engine. We’re excited to share some in-depth optimizations we have recently made to improve the performance of our edge." />
    <meta property="og:url" content="https://blog.cloudflare.com/building-even-faster-interpreters-in-rust/" />
    <meta property="og:image" content="https://blog-cloudflare-com-assets.storage.googleapis.com/2020/09/facebook-shared-image-2.png" />
    <meta property="article:published_time" content="2020-09-24T11:00:00.000Z" />
    <meta property="article:modified_time" content="2020-09-24T21:33:34.000Z" />
    <meta property="article:tag" content="Firewall" />
    <meta property="article:tag" content="Performance" />
    <meta property="article:tag" content="Rust" />
    <meta property="article:tag" content="SIMD" />
    <meta property="article:tag" content="WAF" />
    
    <meta property="article:publisher" content="https://www.facebook.com/cloudflare" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Building even faster interpreters in Rust" />
    <meta name="twitter:description" content="Firewall Rules lets customers filter the traffic hitting their site, powered by our Wirefilter engine. We’re excited to share some in-depth optimizations we have recently made to improve the performance of our edge." />
    <meta name="twitter:url" content="https://blog.cloudflare.com/building-even-faster-interpreters-in-rust/" />
    <meta name="twitter:image" content="https://blog-cloudflare-com-assets.storage.googleapis.com/2020/09/twitter-shared-link-2.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Zak Cutner" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Firewall, Performance, Rust, SIMD, WAF" />
    <meta name="twitter:site" content="@cloudflare" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "The Cloudflare Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg",
            "width": 109,
            "height": 40.5
        }
    },
    "author": {
        "@type": "Person",
        "name": "Zak Cutner",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2020/09/IMG_20200814_120215-2.jpg",
            "width": 2000,
            "height": 2000
        },
        "url": "https://blog.cloudflare.com/author/zak/",
        "sameAs": [
            "https://zakcutner.uk"
        ]
    },
    "headline": "Building even faster interpreters in Rust",
    "url": "https://blog.cloudflare.com/building-even-faster-interpreters-in-rust/",
    "datePublished": "2020-09-24T11:00:00.000Z",
    "dateModified": "2020-09-24T21:33:34.000Z",
    "image": "https://blog.cloudflare.com/content/images/2020/09/Screen-Shot-2020-09-24-at-2.33.23-PM.png",
    "keywords": "Firewall, Performance, Rust, SIMD, WAF",
    "description": "Firewall Rules lets customers filter the traffic hitting their site, powered by our Wirefilter engine. We’re excited to share some in-depth optimizations we have recently made to improve the performance of our edge.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.cloudflare.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.5" />
    <link rel="alternate" type="application/rss+xml" title="The Cloudflare Blog" href="https://blog.cloudflare.com/rss/" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','cfDataLayer','GTM-PKQFGQB');</script>
<!-- End Google Tag Manager -->

<!-- Google Optimize -->
<script src="https://www.googleoptimize.com/optimize.js?id=GTM-N4JSZJ8"></script>

<link rel="shortcut icon" href="https://blog.cloudflare.com/content/images/2019/12/favicon-8.png" type="image/png">

<meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6" />
<meta class="swiftype" name="language" data-type="string" content="en" />
<!--<script src="/assets/js/index.js"></script>-->
<script type="text/javascript" src="//cdn.bizible.com/scripts/bizible.js" async=""></script>
<script>
var trackRecruitingLink = function(role, url) {
   ga('send', 'event', 'recruiting', 'jobscore-click', role, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script> 
<script type="text/javascript">
	(function() {
		var didInit = false;
		function initMunchkin() {
			if(didInit === false) {
				didInit = true;
				Munchkin.init('713-XSC-918');
			}
		}
		var s = document.createElement('script');
		s.type = 'text/javascript';
		s.async = true;
		s.src = '//munchkin.marketo.net/munchkin.js';
		s.onreadystatechange = function() {
			if (this.readyState == 'complete' || this.readyState == 'loaded') {
				initMunchkin();
			}
		};
		s.onload = initMunchkin;
		document.getElementsByTagName('head')[0].appendChild(s);
		})();
</script>
<script>
var HTMLAttrToAdd = document.querySelector("html");
HTMLAttrToAdd.setAttribute("lang", "en");
</script>
<style>
    table {
        background-color: transparent;
    }
    td {
		padding: 5px 1em;
    }
    pre {
        max-height: 500px;
        overflow-y: scroll;
    }
</style>
<!-- Cloudflare Web Analytics -->
<script
        defer
        src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "f446eacb44504e50864bad7c47ffa9e8"}'></script>
<!-- End Cloudflare Web Analytics -->

</head>

<body id="main-body" class="post-template tag-firewall tag-performance tag-rust tag-simd tag-waf sans-serif">

    <div class="site-wrapper">

        <header class="flex flex-row flex-wrap justify-between items-end mw8 center mv3 pl3 pr2">
    <div class="w-100 flex items-end justify-between justify-start-l">
        <div class="w-100 tr">
            <span class="dn di-l">
                <a href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover">Contact Sales:
                </a>
                <a href="tel:+18889935273" class="f1 gray4 no-underline underline-hover">+1 (888) 274-3482</a>
            </span>
        </div>
    </div>
    <div class="w-100 w-50-l flex items-end justify-between justify-start-l">
        <a href="https://blog.cloudflare.com" class="header-logo mr4">
            <img src="https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg" alt="The Cloudflare Blog" class="header-logo" />
        </a>
        <h2 class="mt0 mb1">
            <a href="/" class="fw5 f5 gray3 no-underline">
                <span class="dn di-l">The Cloudflare Blog</span>
            </a>
        </h2>
    </div>
    <div class="w-100 w-50-l dn db-l">
        <div class="w-100 tr mkto-sub-message">
            <p class="f2">Thanks for being here, come back soon. Get notified of new posts:</p>
        </div>
        <div class="w-100 tr">
            <script src="//app-ab13.marketo.com/js/forms2/js/forms2.min.js"></script>
            <div class="marketo-form-container">
                <form id="mktoForm_1653"></form>
            </div>
            <script>
                MktoForms2.loadForm("//app-ab13.marketo.com", "713-XSC-918", 1653, function(form) {
                    document.querySelectorAll('#mktoForm_1653 .mktoEmailField')[0].placeholder = "Email Address";

                    form.onSuccess(function(vals, thanksURL){
                        // Hide form and show success msg
                        document.getElementById("mktoForm_1653").style.display = "none";
                        document.getElementsByClassName("mkto-sub-message")[0].style.display = "none";

                        document.getElementsByClassName("js-form-success-msg")[0].style.display = "block";
                        return false;
                    });
                });
            </script>
        </div>
        <div class="w-100 tr dn js-form-success-msg">
            <p class="f2">Subscription confirmed. Thank you for subscribing!</p>
        </div>
    </div>
</header>

<nav id="nav" class="w-100 bb b--black-10 z-1">
    <div id="desktop-nav-items-container" class="flex flex-row flex-wrap justify-between items-center mw8 center mv3 mv0-l">
        <div class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3" data-tag="product-news">
            <a href="/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="speed-and-reliability">
            <a href="/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="security">
            <a href="/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="serverless">
            <a href="/tag/serverless/" class="no-underline gray1 f2 fw5 pv3">Serverless</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="cloudflare-network">
            <a href="/tag/cloudflare-network/" class="no-underline gray1 f2 fw5 pv3">Cloudflare Network</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="developers">
            <a href="/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="deep-dive">
            <a href="/tag/deep-dive/" class="no-underline gray1 f2 fw5 pv3">Deep Dive</a>
        </div>
        <div class="nav-item nav-item-desktop ml2 mr3 dn db-l pv3" data-tag="life-at-cloudflare">
            <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life @Cloudflare</a>
        </div>
        <a href="/search/"><img src="/assets/images/magnifier.svg?v=fdf4009e30" class="js-search-box-trigger mw2 pointer ph3 ph2-l" />
        </a>
        <img src="/assets/images/hamburger.svg?v=fdf4009e30" class="w2 pointer js-mobile-nav-trigger ph3 db dn-l" />
    </div>

    <div class="js-mobile-nav-container dn">
        <div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-100 ph3 z-1">
            <div class="pv3 ph2">
                <a href="/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/security/" class="no-underline gray1 f4 fw7">Security</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/serverless/" class="no-underline gray1 f4 fw7">Serverless</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/cloudflare-network/" class="no-underline gray1 f4 fw7">Cloudflare Network</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/deep-dive/" class="no-underline gray1 f4 fw7">Deep Dive</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life @Cloudflare</a>
            </div>
        </div>
    </div>
</nav>
        


<main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l">
    <article
        class="post-full mw-100 ph3 ph0-l fs-20px post tag-firewall tag-performance tag-rust tag-simd tag-waf ">
        <h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">Building even faster interpreters in Rust</h1>


        <p class="f3 fw5 gray5 db di-l mt2" localize datetime="2020-09-24T12:00:00+01:00">Loading...</p>
        <noscript>
            <p class="f3 fw5 gray5 db di-l mt2">September 24, 2020 12:00PM</p>
        </noscript>

        <ul class="flex flex-wrap pl0 mt4">
            <li class="list flex items-center ml0 pl0 pb1">
                <a href="/author/zak/" class="static-avatar pr1">
                    <img class="author-profile-image h2 w2 br-100 mr2" src="https://blog-cloudflare-com-assets.storage.googleapis.com/2020/09/IMG_20200814_120215-2.jpg" alt="Zak Cutner" />
                </a>
                <div class="author-name-tooltip">
                    <a href="/author/zak" class="fw5 f3 no-underline black mr3">Zak Cutner</a>
                </div>
            </li>
        </ul>

        <section class="post-full-content">
            <div class="post-content lh-copy gray1">
                <figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/09/Cloudflare-reflections-copy-2@2x.png" class="kg-image"></figure><p>At Cloudflare, we’re <a href="https://blog.cloudflare.com/making-the-waf-40-faster/">constantly working on</a> improving the performance of our edge — and that was exactly what my internship this summer entailed. I’m excited to share some improvements we’ve made to our popular <a href="https://blog.cloudflare.com/how-we-made-firewall-rules/">Firewall Rules</a> product over the past few months.</p><p>Firewall Rules lets customers filter the traffic hitting their site. It’s built using our engine, Wirefilter, which takes powerful boolean expressions written by customers and matches incoming requests against them. Customers can then choose how to respond to traffic which matches these rules. We will discuss some in-depth optimizations we have recently made to Wirefilter, so you may wish to <a href="https://blog.cloudflare.com/building-fast-interpreters-in-rust/">get familiar</a> with how it works if you haven’t already.</p><h3 id="minimizing-cpu-usage">Minimizing CPU usage</h3><p>As a new member of the Firewall team, I quickly learned that performance is important — even in our security products. We look for opportunities to make our customers’ Internet properties faster where it’s safe to do so, maximizing both security and performance.</p><p>Our engine is already heavily used, powering all of Firewall Rules. But we have bigger plans. More and more products like our <a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF">Web Application Firewall</a> (WAF) will be running behind our Wirefilter-based engine, and it will become responsible for eating up a sizable chunk of our total CPU usage before long.</p><h3 id="how-to-measure-performance">How to measure performance?</h3><p>Measuring performance is a notoriously tricky task, and as you can probably imagine trying to do this in a highly distributed environment (aka <a href="https://www.cloudflare.com/learning/serverless/glossary/what-is-edge-computing/">Cloudflare’s edge</a>) does not help. We’ve been surprised in the past by optimizations that look good on paper, but, when tested out in production, just don’t seem to do much.</p><p>Our solution? Performance measurement as a service — an isolated and reproducible benchmark for our Firewall engine and a framework for engineers to easily request runs and view results. It’s worth noting that we took a lot of inspiration from the fantastic <a href="https://perf.rust-lang.org/">Rust Compiler benchmarks</a> to build this.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2020/09/image3-10.png" class="kg-image"><figcaption>Our benchmarking framework, showing how performance during different stages of processing Wirefilter expressions has changed over time [1].</figcaption></figure><h3 id="what-to-measure">What to measure?</h3><p>Our next challenge was to find some meaningful performance metrics. Some experimentation quickly uncovered that time was far too volatile a measure for meaningful comparisons, so we turned to <a href="https://en.wikipedia.org/wiki/Hardware_performance_counter">hardware counters</a> [2]. It’s not hard to find tools to measure these (<a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf</a> and <a href="https://software.intel.com/content/www/us/en/develop/tools/vtune-profiler.html">VTune</a> are two such examples), although they (<a href="https://software.intel.com/content/www/us/en/develop/documentation/vtune-help/top/api-support/instrumentation-and-tracing-technology-apis/instrumentation-and-tracing-technology-api-reference/collection-control-api.html">mostly</a>) don’t allow control over which parts of the program are recorded. In our case, we wished to individually record measurements for different stages of filter processing — parsing, compilation, analysis, and execution.</p><p>Once again we took inspiration from the Rust compiler, and its <a href="https://blog.rust-lang.org/inside-rust/2020/02/25/intro-rustc-self-profile.html">self-profiling options</a>, using the <a href="https://www.man7.org/linux/man-pages/man2/perf_event_open.2.html">perf_event_open</a> API to record counters from <em>inside</em> our binary. We then output something like the following, which our framework can easily ingest and store for later visualization.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2020/09/Screen-Shot-2020-09-24-at-10.20.42.png" class="kg-image"><figcaption>Output of our benchmarks in <a href="https://jsonlines.org/">JSON Lines</a> format, showing a list of recordings for each combination of hardware counter and Wirefilter processing stage. We’ve used 10 repeats here for readability, but we use around 20, in addition to 5 warmup rounds, within our framework.</figcaption></figure><p>Whilst we mainly focussed on metrics relating to CPU usage, we also use a combination of <a href="https://man7.org/linux/man-pages/man2/getrusage.2.html"><code>getrusage</code></a> and <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=695f055936938c674473ea071ca7359a863551e7"><code>clear_refs</code></a> to find the maximum resident set size (RSS). This is useful to understand the memory impact of <a href="https://github.com/BurntSushi/aho-corasick">particular algorithms</a> in addition to CPU.</p><p>But the challenge was not over. Cloudflare’s standard CI agents use virtualization and sandboxing for security and convenience, but this makes accessing hardware counters virtually impossible. Running our benchmarks on a dedicated machine gave us access to these counters, and ensured more reproducible results.</p><h3 id="speeding-up-the-speed-test">Speeding up the speed test</h3><p>Our benchmarks were designed from the outset to take an important place in our development process. For instance, we now perform a full benchmark run before releasing each new version to detect performance regressions.</p><p>But with our benchmarks in place, it quickly became clear that we had a problem. Our benchmarks simply weren’t fast enough — at least if we wanted to complete them in less than a few hours! The problem was we have a very large number  of filters. Since our engine would never usually execute requests against this many filters at once it was proving incredibly costly. We came up with a few tricks to cut this down…</p><ul><li><strong><strong><strong>Deduplication. </strong></strong></strong>It turns out that only around a third of filters are structurally unique (something that is easy to check as Wirefilter can helpfully serialize to JSON). We managed to cut down a great deal of time by ignoring duplicate filters in our benchmarks.</li><li><strong><strong><strong>Sampling.</strong> </strong></strong>Still, we had too many filters and random sampling presented an easy solution. A more subtle challenge was to make sure that the random sample was always the same to maintain reproducibility.</li><li><strong><strong><strong>Partitioning.</strong> </strong></strong>We worried that deduplication and sampling would cause us to miss important cases that are useful to optimize. By first partitioning filters by Wirefilter language feature, we can ensure we’re getting a good range of filters. It also helpfully gives us more detail about where specifically the impact of a performance change is.</li></ul><p>Most of these are trade-offs, but very necessary ones which allow us to run continual benchmarks without development speed grinding to a halt. At the time of writing, we’ve managed to get a benchmark run down to around 20 minutes using these ideas.</p><h3 id="optimizing-our-engine">Optimizing our engine</h3><p>With a benchmarking framework in place, we were ready to begin testing optimizations. But how do you optimize an interpreter like Wirefilter? <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Just-in-time (JIT) compilation</a>, <a href="https://dl.acm.org/doi/10.1145/277652.277743">selective inlining</a> and <a href="http://www.complang.tuwien.ac.at/andi/papers/dotnet_06.pdf">replication</a> were some ideas floating around in the word of interpreters that seemed attractive. After all, we <a href="https://blog.cloudflare.com/building-fast-interpreters-in-rust/">previously wrote</a> about the cost of dynamic dispatch in Wirefilter. All of these techniques aim to reduce that effect.</p><p>However, running some real filters through a profiler tells a different story. Most execution time, around 65%, is spent not resolving dynamic dispatch calls but instead performing <a href="https://developers.cloudflare.com/firewall/cf-firewall-language/operators/#comparison-operators">operations</a> like comparison and searches. Filters currently in production tend to be pretty light on functions, but throw in a few more of these and even less time would be spent on dynamic dispatch. We suspect that even a fair chunk of the remaining 35% is actually spent reading the memory of request fields.</p><!--kg-card-begin: html--><style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-7btt{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
</style>
<table class="tg" width="100%">
<thead>
  <tr>
    <th class="tg-7btt">Function</th>
    <th class="tg-7btt">CPU time</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0pky"><span style="color:#905;background-color:#ddd">`matches`</span> operator</td>
    <td class="tg-0pky">0.6%</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="color:#905;background-color:#ddd">`in`</span> operator</td>
    <td class="tg-0pky">1.1%</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="color:#905;background-color:#ddd">`eq`</span> operator</td>
    <td class="tg-0pky">11.8%</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="color:#905;background-color:#ddd">`contains`</span> operator</td>
    <td class="tg-0pky">51.5%</td>
  </tr>
  <tr>
    <td class="tg-0pky">Everything else</td>
    <td class="tg-0pky">35.0%</td>
  </tr>
</tbody>
</table>
<figcaption>Breakdown of CPU time while executing a typical production filter.</figcaption><!--kg-card-end: html--><p></p><p></p><h3 id="an-adventure-in-substring-searching">An adventure in substring searching</h3><p>By now, you shouldn’t be surprised that the <code>contains</code> operator was one of the first in line for optimization. If you’ve ever written a Firewall Rule, you’re probably already familiar with what it does — it checks whether a substring is present in the field you are matching against. For example, the following expression would match when the host is “example.com” or “www.example.net”, but not when it is “cloudflare.com”. In <a href="https://en.wikipedia.org/wiki/String-searching_algorithm">string searching algorithms</a>, this is commonly referred to as finding a ‘needle’ (“example”) within a ‘haystack’ (“example.com”).</p><p><code>http.host contains “example”</code></p><p>How does this work under the hood? Ordinarily, we may have used Rust’s <a href="https://doc.rust-lang.org/std/string/struct.String.html#method.contains">`String::contains` function</a> but Wirefilter also allows raw byte expressions that don’t necessarily conform to UTF-8.</p><p><code>http.host contains 65:78:61:6d:70:6c:65</code></p><p>We therefore used the <a href="https://crates.io/crates/memmem">memmem crate</a> which performs a <a href="https://en.wikipedia.org/wiki/Two-way_string-matching_algorithm">two-way substring search algorithm</a> on raw bytes.</p><p>Sounds good, right? It was, and it was working pretty well, although we’d noticed that rewriting `contains` filters using regular expressions could bizarrely often make them faster.</p><p><code>http.host matches “example”</code></p><p>Regular expressions are great, but since they’re far more powerful than the `contains` operator, they shouldn’t be faster than a specialized algorithm in simple cases like this one.</p><p>Something was definitely up. It turns out that <a href="https://crates.io/crates/regex">Rust’s regex library</a> comes equipped with <a href="https://github.com/rust-lang/regex/blob/691606773f525be32a59a0c28eae203a79663706/src/literal/imp.rs#L24">a whole host</a> of specialized matchers for what it deems to be simple expressions like this. The obvious question was whether we could therefore simply use the regex library. Interestingly, you may not have realized that the popular ripgrep tool does <a href="https://github.com/BurntSushi/ripgrep/blob/1b2c1dc67583d70d1d16fc93c90db80bead4fb09/crates/core/args.rs#L1479">just that</a> when searching for fixed-string patterns.</p><p>However, our use case is a little different. Since we’re building an interpreter (and we’re using dynamic dispatch in any case), we would prefer to dispatch to a specialized case for `contains` expressions, rather than matching on some enum deep within the regex crate when the filter is executed. What’s more, there are some <a href="http://0x80.pl/articles/simd-strfind.html">pretty</a> <a href="https://github.com/intel/hyperscan">cool</a> <a href="https://github.com/jneem/teddy">things</a> being done to perform substring searching that leverages SIMD instruction sets. So we wired up our engine to some <a href="https://github.com/WojciechMula/sse4-strstr">previous work</a> by Wojciech Muła and the results were fantastic.</p><!--kg-card-begin: html--><style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-7btt{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
</style>
<table class="tg" width="100%">
<thead>
  <tr>
    <th class="tg-7btt">Benchmark</th>
    <th class="tg-7btt">Improvement</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0pky">Expressions using <span style="color:#905;background-color:#ddd">`contains`</span> operator</td>
    <td class="tg-0pky">72.3%</td>
  </tr>
  <tr>
    <td class="tg-0pky">‘Simple’ expressions</td>
    <td class="tg-0pky">0.0%</td>
  </tr>
  <tr>
    <td class="tg-0pky">All expressions</td>
    <td class="tg-0pky">31.6%</td>
  </tr>
</tbody>
</table>
<figcaption>Improvements in instruction count using Wojciech Muła’s sse4-strstr library over the memmem crate with Wirefilter.</figcaption><!--kg-card-end: html--><p></p><p></p><p>I encourage you to <a href="http://0x80.pl/articles/simd-strfind.html">read more</a> on “Algorithm 1”, which we used, but it works something like this (I’ve changed the order a little to help make it clearer). It’s worth <a href="https://en.wikipedia.org/wiki/SIMD">reading up</a> on SIMD instructions if you’re unfamiliar with them — they’re the essence behind what makes this algorithm fast.</p><ol><li>We fill one SIMD register with the first byte of the needle being searched for, simply repeated over and over.</li><li>We load as much of our haystack as we can into another SIMD register and perform a bitwise equality operation with our previous register.</li><li>Now, any position in the resultant register that is 0 cannot be the start of the match since it doesn’t start with the same byte of the needle.</li><li>We now repeat this process with the last byte of the needle, offsetting the haystack, to rule out any positions that don’t end with the same byte as the needle.</li><li>Bitwise ANDing these two results together, we (hopefully) have now drastically reduced our potential matches.</li><li>Each of the remaining potential matches can be checked manually using a memcmp operation. If we find a match, then we’re done.</li><li>If not, we continue with the next part of our haystack and repeat until we’ve checked the entire thing.</li></ol><h3 id="when-it-goes-wrong">When it goes wrong</h3><p>You may be wondering what happens if our haystack doesn’t fit neatly into registers. In the original algorithm, nothing. It simply continues reading into the oblivion after the end of the haystack until the last register is full, and uses a bitmask to ignore potential false-positives from this additional region of memory.</p><p>As we mentioned, security is our priority when it comes to optimizations, so we could never deploy something with this kind of behaviour. We ended up porting Muła’s library to Rust (we’ve also <a href="https://crates.io/crates/sliceslice">open-sourced the crate</a>!) and performed an <a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/coding-for-neon---part-2-dealing-with-leftovers">overlapping registers modification</a> found in ARM’s blog.</p><p>It’s best illustrated by example — notice the difference between how we would fill registers on an imaginary SIMD instruction-set with 4-byte registers.</p><p><strong>Before modification</strong></p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2020/09/image1-16.png" class="kg-image"><figcaption>How registers are filled in the original implementation for the haystack “abcdefghij”, red squares indicate out of bounds memory.</figcaption></figure><p><strong>After modification</strong></p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2020/09/image4-10.png" class="kg-image"><figcaption>How registers are filled with the overlapping modification for the same haystack, notice how ‘g’ and ‘h’ each appear in two registers.</figcaption></figure><p>In our case, repeating some bytes within two different registers will never change the final outcome, so this modification is allowed as-is. However, in reality, we found it was better to use a bitmask to exclude repeated parts of the final register and minimize the number of memcmp calls.</p><p>What if the haystack is too small to even fill a single register? In this case, we can’t use our overlapping trick since there’s nothing to overlap with. Our solution is straightforward: while we were primarily targeting AVX2, which can store 32-bytes in a lane, we can easily move down to another instruction set with smaller registers that the haystack can fit into. In reality, we don’t currently go any smaller than SSE2. Beyond this, we instead use an implementation of the <a href="https://en.wikipedia.org/wiki/Rabin%E2%80%93Karp_algorithm">Rabin-Karp searching algorithm</a> which appears to perform well.</p><!--kg-card-begin: html--><style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-7btt{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
</style>
<table class="tg" width="100%">
<thead>
  <tr>
    <th class="tg-7btt">Instruction set</th>
    <th class="tg-7btt">Register size</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0pky">AVX2</td>
    <td class="tg-0pky">32 bytes</td>
  </tr>
  <tr>
    <td class="tg-0pky">SSE2</td>
    <td class="tg-0pky">16 bytes</td>
  </tr>
  <tr>
    <td class="tg-0pky">SWAR (u64)</td>
    <td class="tg-0pky">8 bytes</td>
  </tr>
  <tr>
    <td class="tg-0pky">SWAR (u32)</td>
    <td class="tg-0pky">4 bytes</td>
  </tr>
  <tr>
    <td class="tg-0pky">...</td>
    <td class="tg-0pky">...</td>
  </tr>
</tbody>
</table>
<figcaption>Register sizes in different SIMD instruction sets [3]. We did not consider AVX512 since support for this is not widespread enough.</figcaption><!--kg-card-end: html--><p></p><p></p><h3 id="is-it-always-fast">Is it always fast?</h3><p>Choosing the first and last bytes of the needle to rule out potential matches is a great idea. It means that when it does come to performing a memcmp, we can ignore these, as we know they already match. Unfortunately, as Muła points out, this also makes the algorithm susceptible to a worst-case attack in some instances.</p><p>Let’s give an expression that a customer might write to illustrate this.</p><p><code>http.request.uri.path contains “/wp-admin/”</code></p><p>If we try to search for this within a very long sequence of ‘/’s, we will find a potential match in every position and make lots of calls to memcmp — essentially performing a slow <a href="https://en.wikipedia.org/wiki/String-searching_algorithm#Na%C3%AFve_string_search">bruteforce substring search</a>.</p><p>Clearly we need to choose different bytes from the needle. But which ones should we choose? For each choice, an adversary can always find a slightly different, but equally troublesome, worst case. We instead use <a href="https://en.wikipedia.org/wiki/Randomized_algorithm">randomness</a> to throw off our would-be adversary, picking the first byte of the needle as before, but then choosing another <em>random</em> byte to use.</p><p>Our new version is unsurprisingly slower than Muła’s, yet it still exhibits a great improvement over both the memmem and regex crates. Performance, but without sacrificing safety.</p><!--kg-card-begin: html--><style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-fymr{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-7btt{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
.tg .tg-0pkz{border-color:inherit;font-weight:bold;text-align:left;vertical-align:top}
</style>
<table class="tg" width="100%">
<thead>
  <tr>
    <th class="tg-fymr">Benchmark</th>
    <th class="tg-7btt" colspan="2">Improvement</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0pky"></td>
    <td class="tg-fymr">sse4-strstr (original)</td>
    <td class="tg-7btt">sliceslice (our version)</td>
  </tr>
  <tr>
    <td class="tg-0pky">Expressions using <span style="color:#905;background-color:#ddd">`contains`</span> operator</td>
    <td class="tg-0pky">72.3%</td>
    <td class="tg-0pkz">49.1%</td>
  </tr>
  <tr>
    <td class="tg-0pky">‘Simple’ expressions</td>
    <td class="tg-0pky">0.0%</td>
    <td class="tg-0pkz">0.1%</td>
  </tr>
  <tr>
    <td class="tg-0pky">All expressions</td>
    <td class="tg-0pky">31.6%</td>
    <td class="tg-0pkz">24.0%</td>
  </tr>
</tbody>
</table>
<figcaption>Improvements in instruction count of using sse4-strstr and sliceslice over the memmem crate with Wirefilter.</figcaption><!--kg-card-end: html--><p></p><p></p><h3 id="what-s-next">What’s next?</h3><p>This is only a small taste of the performance work we’ve been doing, and we have much more yet to come. Nevertheless, none of this would have been possible without the support of my manager Richard and my mentor Elie, who contributed a lot of these ideas. I’ve learned so much over the past few months, but most of all that Cloudflare is an amazing place to be an intern!</p><p>[1] Since our benchmarks are not run within a production environment, results in this post do not represent traffic on our edge.</p><p>[2] We found instruction counts to be a particularly stable measure, and CPU cycles a particularly unstable one.</p><p>[3] Note that <a href="https://en.wikipedia.org/wiki/SWAR">SWAR</a> is technically not an instruction set, but instead uses regular registers like vector registers.</p>
            </div>
        </section>

        <a href="/tag/firewall/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Firewall</a>
        <a href="/tag/performance/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Performance</a>
        <a href="/tag/rust/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Rust</a>
        <a href="/tag/simd/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">SIMD</a>
        <a href="/tag/waf/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">WAF</a>
    </article>
</main>

<div class="pv4 flex flex-row flex-wrap mw7 center">
    <div class="w-100 ph3 bt b--gray8">
        <p class="orange fw5 f4 mt4 ttu">Related Posts</p>
    </div>

    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2020-04-24T12:00:00+01:00">April 24, 2020 12:00PM</p>
        <a href="/stream-firewall-events-directly-to-your-siem/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Stream Firewall Events directly to your SIEM</h2>
        </a>

        <p class="gray1 lh-copy">As of today, customers using Cloudflare Logs can create Logpush jobs that send only Firewall Events. These events arrive much faster than our existing HTTP requests logs: they are typically delivered to your logging platform within 60 seconds of sending the response to the client....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/patrick/" class="fw5 f2 black no-underline">Patrick R. Donahue</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/firewall/" class="no-underline f1 fw2 blue3 underline-hover">Firewall</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/firewall-events/" class="no-underline f1 fw2 blue3 underline-hover">Firewall Events</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/logs/" class="no-underline f1 fw2 blue3 underline-hover">Logs</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/log-push/" class="no-underline f1 fw2 blue3 underline-hover">Log Push</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/terraform/" class="no-underline f1 fw2 blue3 underline-hover">Terraform</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2019-03-04T13:00:00Z">March 04, 2019 1:00PM</p>
        <a href="/how-we-made-firewall-rules/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">How we made Firewall Rules</h2>
        </a>

        <p class="gray1 lh-copy">Recently we launched Firewall Rules, a new feature that allows you to construct expressions that perform complex matching against HTTP requests and then choose how that traffic is handled....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/david-kitchen/" class="fw5 f2 black no-underline">David Kitchen</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/firewall/" class="no-underline f1 fw2 blue3 underline-hover">Firewall</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/page-rules/" class="no-underline f1 fw2 blue3 underline-hover">Page Rules</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/security/" class="no-underline f1 fw2 blue3 underline-hover">Security</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/waf/" class="no-underline f1 fw2 blue3 underline-hover">WAF</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2018-12-21T13:11:00Z">December 21, 2018 1:11PM</p>
        <a href="/firewall-rules-priority-and-ordering/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Firewall Rules - Priority and Ordering</h2>
        </a>

        <p class="gray1 lh-copy">Firewall Rules are one of the best security features we released this year, and have been an overwhelming success. Customers have been using Firewall Rules to solve interesting security related use cases....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/alex-cruz-farmer/" class="fw5 f2 black no-underline">Alex Cruz Farmer</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/firewall/" class="no-underline f1 fw2 blue3 underline-hover">Firewall</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/security/" class="no-underline f1 fw2 blue3 underline-hover">Security</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2013-08-24T02:46:00+01:00">August 24, 2013 2:46AM</p>
        <a href="/recycling-memory-buffers-in-go/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Recycling memory buffers in Go</h2>
        </a>

        <p class="gray1 lh-copy">This blog post is very old now. You probably don't want to use the techniques described here. GO'S sync.Pool is a better way to go....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/john-graham-cumming/" class="fw5 f2 black no-underline">John Graham-Cumming</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/firewall/" class="no-underline f1 fw2 blue3 underline-hover">Firewall</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/go/" class="no-underline f1 fw2 blue3 underline-hover">Go</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/reliability/" class="no-underline f1 fw2 blue3 underline-hover">Reliability</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/railgun/" class="no-underline f1 fw2 blue3 underline-hover">Railgun</a>
        </div>
    </article>

</div>
<div class="pv4 ph3 mw7 center">
    <div id="disqus_thread"></div>
</div>



        <footer class="pt4 pb4 pl1 pr1 main-footer">
  <div class="mw8 center dn db-l ph3">
    <div class="flex flex-row justify-between">
      <div class="main-footer__menu-group">
        <ul id="sales-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="sales-menu"
            class="main-footer__menu-group__header js-toggle-footer-group f1">
            Sales
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/enterprise/contact/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="enterprise_sales"
              class="f1 blue3 no-underline underline-hover">
              Enterprise Sales
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/partners/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="become_a_partner" class="f1 blue3 no-underline underline-hover">
              Become a Partner
            </a>
          </li>
        </ul>
        <p class="phone f1 blue3 no-underline underline-hover">
          <p class="tel f1 blue3 no-underline underline-hover">Contact Sales:</p>
          <p><a data-i18n-phonenumber="" class="tel f1 blue3 no-underline underline-hover" href="tel:+18889935273">+1
              (888) 99 FLARE</a></p>

          <noscript><a class="phone f1 blue3 no-underline underline-hover" href="tel:+16503198930">+1 650 319
              8930</a></noscript>
        </p>
      </div>
      <div class="main-footer__menu-group">
        <ul id="getting-started-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="getting-started-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Getting Started
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="plans" class="f1 blue3 no-underline underline-hover">
              Pricing
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/case-studies/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="case_studies" class="f1 blue3 no-underline underline-hover">
              Case Studies
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/resources/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="white_papers" class="f1 blue3 no-underline underline-hover">
              White Papers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/webinars/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover">
              Webinars
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/learning/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="learning_center" class="f1 blue3 no-underline underline-hover">
              Learning Center
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="community-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="community-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Community
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://community.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover">
              Community Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://blog.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="blog" class="f1 blue3 no-underline underline-hover">
              Blog
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/galileo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover">
              Project Galileo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/athenian/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover">
              Athenian Project
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.tv/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="tv" class="f1 blue3 no-underline underline-hover">
              Cloudflare TV
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="developers-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="developers-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Developers
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://developers.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="developer_hub" class="f1 blue3 no-underline underline-hover">
              Developer Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/technical-resources/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="technical_resources"
              class="f1 blue3 no-underline underline-hover">
              Technical Resources
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/products/cloudflare-workers/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="cloudflare_workers"
              class="f1 blue3 no-underline underline-hover">
              Cloudflare Workers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/integrations/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="integrations" class="f1 blue3 no-underline underline-hover">
              Integrations
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="support-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="support-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Support
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://support.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="support" class="f1 blue3 no-underline underline-hover">
              Support
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://www.cloudflarestatus.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="status" class="f1 blue3 no-underline underline-hover">
              Cloudflare Status
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/compliance/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover">
              Compliance
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/gdpr/introduction/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover">
              GDPR
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="company-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="company-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Company
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/about-overview/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover">
              About Cloudflare
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/people/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover">
              Our Team
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/press/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="press" class="f1 blue3 no-underline underline-hover">
              Press
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/analysts/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="analysts" class="f1 blue3 no-underline underline-hover">
              Analysts
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/careers/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="careers" class="f1 blue3 no-underline underline-hover">
              Careers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/internetsummit/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="internet_summit"
              class="f1 blue3 no-underline underline-hover">
              Internet Summit
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/logo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="logo" class="f1 blue3 no-underline underline-hover">
              Logo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/network/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover">
              Network Map
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="mw8 center ph3">
    <div class="flex flex-row flex-wrap justify-between pt4">
      <div class="flex flex-row items-start w-100 w-50-l pb4 pb0-l">
        <a target="_blank" rel="noopener" href="https://www.facebook.com/Cloudflare/" class="w-10"><img
            src="https://cloudflare.com/img/footer/facebook.svg" class="w-60"></a>
        <a target=" _blank" rel="noopener" href="https://twitter.com/Cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/twitter.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.linkedin.com/company/cloudflare-inc-" class="w-10"><img
            src="https://cloudflare.com/img/footer/linkedin.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.youtube.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/youtube.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.instagram.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/instagram.svg" class="w-60"></a>
      </div>
      <div class="w-100 w-50-l tr-l tl-ns">
        <div>
          <span class="main-footer__copyright f1">© 2020 Cloudflare, Inc.</span>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/privacypolicy/"
            class="main-footer__copyright f1 no-underline underline-hover">Privacy
            Policy</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/website-terms/"
            class="main-footer__copyright f1 no-underline underline-hover">Terms of Use</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/abuse/"
            class="main-footer__copyright f1 no-underline underline-hover">Trust &amp; Safety</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/trademark/"
            class="main-footer__copyright f1 no-underline underline-hover">Trademark</a>
        </div>
      </div>
    </div>
  </div>
</footer>    </div>


    <script type="text/javascript" src="/assets/built/prism.js?v=fdf4009e30"></script>
<script type="text/javascript">
    var disqus_shortname = 'cloudflare';
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>

<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>


    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PKQFGQB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script>
    var links = document.links;

    for (var i = 0, linksLength = links.length; i < linksLength; i++) {  
       if (links[i].hostname != window.location.hostname) {
           links[i].target = '_blank';
       } 
    } 
</script>

</body>

</html>