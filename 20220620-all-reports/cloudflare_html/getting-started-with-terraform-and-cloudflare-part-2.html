<!DOCTYPE html>
<html lang="en">

<head class="sans-serif">

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="baidu-site-verification" content="KeThzeyMOr" />
    <meta name="baidu-site-verification" content="code-NIlrS7gNhx" />

    <title>Getting started with Terraform and Cloudflare (Part 2 of 2)</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/3.4.1/themes/light.css" />

    <link rel="stylesheet" type="text/css" href="/assets/built/index.css?v=fdf4009e30" />

    <script type="text/javascript" src="/assets/built/index.js?v=fdf4009e30"></script>
    <script src="/assets/js/check-for-tex.js" defer></script>

    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="The Cloudflare Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Getting started with Terraform and Cloudflare (Part 2 of 2)" />
    <meta property="og:description" content="Continue exploring Terraform with Cloudflare by enabling load balancing, creating page rules, and rolling back changes." />
    <meta property="og:url" content="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/" />
    <meta property="og:image" content="https://blog.cloudflare.com/content/images/2018/04/Screen-Shot-2018-04-30-at-9.23.27-AM-1.png" />
    <meta property="article:published_time" content="2018-04-30T16:20:45.000Z" />
    <meta property="article:modified_time" content="2020-08-20T17:38:57.000Z" />
    <meta property="article:tag" content="Developers" />
    <meta property="article:tag" content="Terraform" />
    <meta property="article:tag" content="Load Balancing" />
    <meta property="article:tag" content="Page Rules" />
    <meta property="article:tag" content="HashiCorp" />
    <meta property="article:tag" content="Programming" />
    
    <meta property="article:publisher" content="https://www.facebook.com/cloudflare" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Getting started with Terraform and Cloudflare (Part 2 of 2)" />
    <meta name="twitter:description" content="Continue exploring Terraform with Cloudflare by enabling load balancing, creating page rules, and rolling back changes." />
    <meta name="twitter:url" content="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/" />
    <meta name="twitter:image" content="https://blog.cloudflare.com/content/images/2018/04/Screen-Shot-2018-04-30-at-9.23.27-AM-1.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Patrick R. Donahue" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Developers, Terraform, Load Balancing, Page Rules, HashiCorp, Programming" />
    <meta name="twitter:site" content="@cloudflare" />
    <meta name="twitter:creator" content="@prdonahue" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "The Cloudflare Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg",
            "width": 109,
            "height": 40.5
        }
    },
    "author": {
        "@type": "Person",
        "name": "Patrick R. Donahue",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2020/04/me0-1.png",
            "width": 300,
            "height": 291
        },
        "url": "https://blog.cloudflare.com/author/patrick/",
        "sameAs": [
            "https://www.cloudflare.com",
            "https://twitter.com/prdonahue"
        ]
    },
    "headline": "Getting started with Terraform and Cloudflare (Part 2 of 2)",
    "url": "https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/",
    "datePublished": "2018-04-30T16:20:45.000Z",
    "dateModified": "2020-08-20T17:38:57.000Z",
    "image": "https://blog.cloudflare.com/content/images/2018/04/Screen-Shot-2018-04-30-at-9.23.27-AM-1.png",
    "keywords": "Developers, Terraform, Load Balancing, Page Rules, HashiCorp, Programming",
    "description": "Continue exploring Terraform with Cloudflare by enabling load balancing, creating page rules, and rolling back changes.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.cloudflare.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.5" />
    <link rel="alternate" type="application/rss+xml" title="The Cloudflare Blog" href="https://blog.cloudflare.com/rss/" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','cfDataLayer','GTM-PKQFGQB');</script>
<!-- End Google Tag Manager -->

<!-- Google Optimize -->
<script src="https://www.googleoptimize.com/optimize.js?id=GTM-N4JSZJ8"></script>

<link rel="shortcut icon" href="https://blog.cloudflare.com/content/images/2019/12/favicon-8.png" type="image/png">

<meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6" />
<meta class="swiftype" name="language" data-type="string" content="en" />
<!--<script src="/assets/js/index.js"></script>-->
<script type="text/javascript" src="//cdn.bizible.com/scripts/bizible.js" async=""></script>
<script>
var trackRecruitingLink = function(role, url) {
   ga('send', 'event', 'recruiting', 'jobscore-click', role, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script> 
<script type="text/javascript">
	(function() {
		var didInit = false;
		function initMunchkin() {
			if(didInit === false) {
				didInit = true;
				Munchkin.init('713-XSC-918');
			}
		}
		var s = document.createElement('script');
		s.type = 'text/javascript';
		s.async = true;
		s.src = '//munchkin.marketo.net/munchkin.js';
		s.onreadystatechange = function() {
			if (this.readyState == 'complete' || this.readyState == 'loaded') {
				initMunchkin();
			}
		};
		s.onload = initMunchkin;
		document.getElementsByTagName('head')[0].appendChild(s);
		})();
</script>
<script>
var HTMLAttrToAdd = document.querySelector("html");
HTMLAttrToAdd.setAttribute("lang", "en");
</script>
<style>
    table {
        background-color: transparent;
    }
    td {
		padding: 5px 1em;
    }
    pre {
        max-height: 500px;
        overflow-y: scroll;
    }
</style>
<!-- Cloudflare Web Analytics -->
<script
        defer
        src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "f446eacb44504e50864bad7c47ffa9e8"}'></script>
<!-- End Cloudflare Web Analytics -->

</head>

<body id="main-body" class="post-template tag-developers tag-terraform tag-loadbalancing tag-page-rules tag-hashicorp tag-programming sans-serif">

    <div class="site-wrapper">

        <header class="flex flex-row flex-wrap justify-between items-end mw8 center mv3 pl3 pr2">
    <div class="w-100 flex items-end justify-between justify-start-l">
        <div class="w-100 tr">
            <span class="dn di-l">
                <a href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover">Contact Sales:
                </a>
                <a href="tel:+18889935273" class="f1 gray4 no-underline underline-hover">+1 (888) 274-3482</a>
            </span>
        </div>
    </div>
    <div class="w-100 w-50-l flex items-end justify-between justify-start-l">
        <a href="https://blog.cloudflare.com" class="header-logo mr4">
            <img src="https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg" alt="The Cloudflare Blog" class="header-logo" />
        </a>
        <h2 class="mt0 mb1">
            <a href="/" class="fw5 f5 gray3 no-underline">
                <span class="dn di-l">The Cloudflare Blog</span>
            </a>
        </h2>
    </div>
    <div class="w-100 w-50-l dn db-l">
        <div class="w-100 tr mkto-sub-message">
            <p class="f2">Thanks for being here, come back soon. Get notified of new posts:</p>
        </div>
        <div class="w-100 tr">
            <script src="//app-ab13.marketo.com/js/forms2/js/forms2.min.js"></script>
            <div class="marketo-form-container">
                <form id="mktoForm_1653"></form>
            </div>
            <script>
                MktoForms2.loadForm("//app-ab13.marketo.com", "713-XSC-918", 1653, function(form) {
                    document.querySelectorAll('#mktoForm_1653 .mktoEmailField')[0].placeholder = "Email Address";

                    form.onSuccess(function(vals, thanksURL){
                        // Hide form and show success msg
                        document.getElementById("mktoForm_1653").style.display = "none";
                        document.getElementsByClassName("mkto-sub-message")[0].style.display = "none";

                        document.getElementsByClassName("js-form-success-msg")[0].style.display = "block";
                        return false;
                    });
                });
            </script>
        </div>
        <div class="w-100 tr dn js-form-success-msg">
            <p class="f2">Subscription confirmed. Thank you for subscribing!</p>
        </div>
    </div>
</header>

<nav id="nav" class="w-100 bb b--black-10 z-1">
    <div id="desktop-nav-items-container" class="flex flex-row flex-wrap justify-between items-center mw8 center mv3 mv0-l">
        <div class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3" data-tag="product-news">
            <a href="/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="speed-and-reliability">
            <a href="/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="security">
            <a href="/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="serverless">
            <a href="/tag/serverless/" class="no-underline gray1 f2 fw5 pv3">Serverless</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="cloudflare-network">
            <a href="/tag/cloudflare-network/" class="no-underline gray1 f2 fw5 pv3">Cloudflare Network</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="developers">
            <a href="/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="deep-dive">
            <a href="/tag/deep-dive/" class="no-underline gray1 f2 fw5 pv3">Deep Dive</a>
        </div>
        <div class="nav-item nav-item-desktop ml2 mr3 dn db-l pv3" data-tag="life-at-cloudflare">
            <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life @Cloudflare</a>
        </div>
        <a href="/search/"><img src="/assets/images/magnifier.svg?v=fdf4009e30" class="js-search-box-trigger mw2 pointer ph3 ph2-l" />
        </a>
        <img src="/assets/images/hamburger.svg?v=fdf4009e30" class="w2 pointer js-mobile-nav-trigger ph3 db dn-l" />
    </div>

    <div class="js-mobile-nav-container dn">
        <div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-100 ph3 z-1">
            <div class="pv3 ph2">
                <a href="/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/security/" class="no-underline gray1 f4 fw7">Security</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/serverless/" class="no-underline gray1 f4 fw7">Serverless</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/cloudflare-network/" class="no-underline gray1 f4 fw7">Cloudflare Network</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/deep-dive/" class="no-underline gray1 f4 fw7">Deep Dive</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life @Cloudflare</a>
            </div>
        </div>
    </div>
</nav>
        


<main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l">
    <article
        class="post-full mw-100 ph3 ph0-l fs-20px post tag-developers tag-terraform tag-loadbalancing tag-page-rules tag-hashicorp tag-programming ">
        <h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">Getting started with Terraform and Cloudflare (Part 2 of 2)</h1>


        <p class="f3 fw5 gray5 db di-l mt2" localize datetime="2018-04-30T17:20:45+01:00">Loading...</p>
        <noscript>
            <p class="f3 fw5 gray5 db di-l mt2">April 30, 2018 5:20PM</p>
        </noscript>

        <ul class="flex flex-wrap pl0 mt4">
            <li class="list flex items-center ml0 pl0 pb1">
                <a href="/author/patrick/" class="static-avatar pr1">
                    <img class="author-profile-image h2 w2 br-100 mr2" src="https://blog-cloudflare-com-assets.storage.googleapis.com/2020/04/me0-1.png" alt="Patrick R. Donahue" />
                </a>
                <div class="author-name-tooltip">
                    <a href="/author/patrick" class="fw5 f3 no-underline black mr3">Patrick R. Donahue</a>
                </div>
            </li>
        </ul>

        <section class="post-full-content">
            <div class="post-content lh-copy gray1">
                <!--kg-card-begin: markdown--><p><em>In <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1/">Part 1 of Getting Started with Terraform</a>, we explained how Terraform lets developers store Cloudflare configuration in their own source code repository, institute change management processes that include code review, track their configuration versions and history over time, and easily roll back changes as needed.</em></p>
<p><em>We covered <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#installingterraform">installing Terraform</a>, <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#helloworld">provider initialization</a>, <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#trackingchangehistory">storing configuration in git</a>, <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#applyingzonesettings">applying zone settings</a>, and <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#managingratelimits">managing rate limits</a>. This post continues the Cloudflare Terraform provider walkthrough with examples of <a href="#addingloadbalancing">load balancing</a>, <a href="#usingpagerules">page rules</a>, <a href="#reviewingandrollingbackchanges">reviewing and rolling back configuration</a>, and <a href="#importingexistingstateandconfiguration">importing state</a>.</em></p>
<h3 id="reviewingthecurrentconfiguration">Reviewing the current configuration</h3>
<p>Before we build on Part 1, let's quickly review what we configured in that post. Because our configuration is in git, we can easily view the current configuration and change history that got us to this point.</p>
<pre><code>$ git log
commit e1c38cf6f4230a48114ce7b747b77d6435d4646c
Author: Me
Date:   Mon Apr 9 12:34:44 2018 -0700

    Step 4 - Update /login rate limit rule from 'simulate' to 'ban'.

commit 0f7e499c70bf5994b5d89120e0449b8545ffdd24
Author: Me
Date:   Mon Apr 9 12:22:43 2018 -0700

    Step 4 - Add rate limiting rule to protect /login.

commit d540600b942cbd89d03db52211698d331f7bd6d7
Author: Me
Date:   Sun Apr 8 22:21:27 2018 -0700

    Step 3 - Enable TLS 1.3, Always Use HTTPS, and SSL Strict mode.

commit 494c6d61b918fce337ca4c0725c9bbc01e00f0b7
Author: Me
Date:   Sun Apr 8 19:58:56 2018 -0700

    Step 2 - Ignore terraform plugin directory and state file.

commit 5acea176050463418f6ac1029674c152e3056bc6
Author: Me
Date:   Sun Apr 8 19:52:13 2018 -0700

    Step 2 - Initial commit with webserver definition.
</code></pre>
<p>We'll get into more detail about reviewing and rolling back to prior versions of configuration <a href="#reviewingandrollingbackchanges">later in this post</a>, but for now let's review the current version.</p>
<p>In lines 1-4 below, we configured the Cloudflare Terraform provider. Initially we stored our email address and API key in the <code>cloudflare.tf</code> file, but for security reasons we removed them before committing to a git repository.</p>
<p>In lines 6-8, we define a <code>variable</code> that can be interpolated into <code>resources</code> definitions. Terraform can be used to mass configure multiple zones through the use of variables, as we'll explore in a future post.</p>
<p>Lines 10-16 tell Cloudflare to create a DNS <code>A</code> record for <code>www.${var.domain}</code> using IP address <code>203.0.113.10</code>. Later in this post, we'll explore <a https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2/href="">adding a second webserver and load balancing</a> between the two origins.</p>
<p>Lines 18-26 apply zone-wide settings and lines 28-54 define a rate limiting rule to protect against credential stuffing and other brute force attacks.</p>
<pre><code>$ cat -n cloudflare.tf 
     1	provider &quot;cloudflare&quot; {
     2	  # email pulled from $CLOUDFLARE_EMAIL
     3	  # token pulled from $CLOUDFLARE_TOKEN
     4	}
     5	
     6	variable &quot;domain&quot; {
     7	  default = &quot;example.com&quot;
     8	}
     9	
    10	resource &quot;cloudflare_record&quot; &quot;www&quot; {
    11	  domain  = &quot;${var.domain}&quot;
    12	  name    = &quot;www&quot;
    13	  value   = &quot;203.0.113.10&quot;
    14	  type    = &quot;A&quot;
    15	  proxied = true
    16	}
    17	
    18	resource &quot;cloudflare_zone_settings_override&quot; &quot;example-com-settings&quot; {
    19	  name = &quot;${var.domain}&quot;
    20	
    21	  settings {
    22	    tls_1_3 = &quot;on&quot;
    23	    automatic_https_rewrites = &quot;on&quot;
    24	    ssl = &quot;strict&quot;
    25	  }
    26	}
    27	
    28	resource &quot;cloudflare_rate_limit&quot; &quot;login-limit&quot; {
    29	  zone = &quot;${var.domain}&quot;
    30	
    31	  threshold = 5
    32	  period = 60
    33	  match {
    34	    request {
    35	      url_pattern = &quot;${var.domain}/login&quot;
    36	      schemes = [&quot;HTTP&quot;, &quot;HTTPS&quot;]
    37	      methods = [&quot;POST&quot;]
    38	    }
    39	    response {
    40	      statuses = [401, 403]
    41	      origin_traffic = true
    42	    }
    43	  }
    44	  action {
    45	    mode = &quot;ban&quot;
    46	    timeout = 300
    47	    response {
    48	      content_type = &quot;text/plain&quot;
    49	      body = &quot;You have failed to login 5 times in a 60 second period and will be blocked from attempting to login again for the next 5 minutes.&quot;
    50	    }
    51	  }
    52	  disabled = false
    53	  description = &quot;Block failed login attempts (5 in 1 min) for 5 minutes.&quot;
    54	}
</code></pre>
<h3 id="addingloadbalancing">Adding load balancing</h3>
<p>Thanks to the <a href="https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-1#managingratelimits">rate limiting set up in part 1</a>, our login page is protected against credential brute force attacks. Now it's time to focus on performance and reliability. Imagine organic traffic has grown for your webserver, and this traffic is increasingly global. It’s time to spread these requests to your origin over multiple data centers.</p>
<p>Below we'll add a second origin for some basic round robining, and then use the <a href="https://www.cloudflare.com/load-balancing/">Cloudflare Load Balancing</a> product to fail traffic over as needed. We'll then enhance our load balancing configuration through the use of &quot;geo steering&quot; to serve results from an origin server that is geographically closest to your end users.</p>
<h4 id="1addanotherdnsrecordforwww">1. Add another DNS record for <code>www</code></h4>
<p>To get started, we'll add a DNS record for a second web server, which is located in Asia. The IP address for this server is <code>198.51.100.15</code>.</p>
<pre><code>$ git checkout -b step5-loadbalance
Switched to a new branch 'step5-loadbalance'

$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_record&quot; &quot;www-asia&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;www&quot;
  value   = &quot;198.51.100.15&quot;
  type    = &quot;A&quot;
  proxied = true
}
EOF
</code></pre>
<p>Note that while the name of the resource is different as Terraform resources of the same type must be uniquely named, the DNS name, i.e., what your customers will type in their browser, is the same: &quot;www&quot;.</p>
<h4 id="2previewandmergethechanges">2. Preview and merge the changes</h4>
<p>Below we'll check the <code>terraform plan</code>, merge and apply the changes.</p>
<pre><code>$ terraform plan | grep -v &quot;&lt;computed&gt;&quot;
...
Terraform will perform the following actions:

  + cloudflare_record.www-asia
      domain:      &quot;example.com&quot;
      name:        &quot;www&quot;
      proxied:     &quot;true&quot;
      type:        &quot;A&quot;
      value:       &quot;198.51.100.15&quot;


Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre>
<pre><code>$ git add cloudflare.tf
$ git commit -m &quot;Step 5 - Add additional 'www' DNS record for Asia data center.&quot;
[step5-loadbalance 6761a4f] Step 5 - Add additional 'www' DNS record for Asia data center.
 1 file changed, 7 insertions(+)

$ git checkout master
Switched to branch 'master'

$ git merge step5-loadbalance 
Updating e1c38cf..6761a4f
Fast-forward
 cloudflare.tf | 7 +++++++
 1 file changed, 7 insertions(+)
</code></pre>
<h4 id="3applyandverifythechanges">3. Apply and verify the changes</h4>
<p>Let's add the second DNS record for www.example.com:</p>
<pre><code>$ terraform apply --auto-approve
...
cloudflare_record.www-asia: Creating...
  created_on:  &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  domain:      &quot;&quot; =&gt; &quot;example.com&quot;
  hostname:    &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  metadata.%:  &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  modified_on: &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  name:        &quot;&quot; =&gt; &quot;www&quot;
  proxiable:   &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  proxied:     &quot;&quot; =&gt; &quot;true&quot;
  ttl:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  type:        &quot;&quot; =&gt; &quot;A&quot;
  value:       &quot;&quot; =&gt; &quot;198.51.100.15&quot;
  zone_id:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
cloudflare_record.www-asia: Creation complete after 1s (ID: fda39d8c9bf909132e82a36bab992864)

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</code></pre>
<p>With the second DNS record in place, let's try making some requests to see where the traffic is served from:</p>
<pre><code>$ curl https://www.example.com
Hello, this is 203.0.113.10!

$ curl https://www.example.com
Hello, this is 203.0.113.10!

$ curl https://www.example.com
Hello, this is 198.51.100.15!

$ curl https://www.example.com
Hello, this is 203.0.113.10!
</code></pre>
<p>As you can see above, there is no discernible pattern for which origin receives the request. When Cloudflare connects to an origin with multiple DNS records, one of the IP addresses is selected at random. If both of these IPs are in the same data center and sessions can be shared (i.e., it doesn't matter if the same user hops between origin servers), this may work fine. However, for anything more complicated such as origins in different geographies or active health checks, you're going to want to use Cloudflare's Load Balancing product.</p>
<h4 id="4switchtousingcloudflareloadbalancing">4. Switch to using Cloudflare Load Balancing</h4>
<p>Before proceeding, make sure that your account is enabled for Load Balancing. If you're on an Enterprise plan, you should ask your Customer Success Manager to do this; otherwise, you can subscribe to Load Balancing within the Cloudflare Dashboard.</p>
<p>As described in the <a href="https://support.cloudflare.com/hc/en-us/articles/115000081911-Tutorial-How-to-Set-Up-Load-Balancing-Intelligent-Failover-on-Cloudflare">load balancing tutorial</a> on the Cloudflare Support site, you will need to do three things:</p>
<p>i. Create a monitor to run health checks against your origin servers<br>
ii. Create a pool of one or more origin servers that will receive load balanced traffic<br>
iii. Create a load balancer with an external hostname, e.g., www.example.com, and one or more pools</p>
<h5 id="idefineandcreatethehealthcheckmonitor">i. Define and create the health check (&quot;monitor&quot;)</h5>
<p>To monitor our origins we're going to create a basic health check that makes a GET request to each origin on the URL <a href="https://www.example.com">https://www.example.com</a>. If the origin returns the 200/OK status code within 5 seconds, we'll consider it healthy. If it fails to do so three (3) times in a row, we'll consider it unhealthy. This health check will be run once per minute from several regions, and send an email notification to <a href="/cdn-cgi/l/email-protection#e0998f95a08598818d908c85ce838f8d"><span class="__cf_email__" data-cfemail="9ee7f1ebdefbe6fff3eef2fbb0fdf1f3">[email&#160;protected]</span></a> if any failures are detected.</p>
<pre><code>$ git checkout step5-loadbalance
Switched to branch 'step5-loadbalance'

$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_load_balancer_monitor&quot; &quot;get-root-https&quot; {
  expected_body = &quot;alive&quot;
  expected_codes = &quot;200&quot;
  method = &quot;GET&quot;
  timeout = 5
  path = &quot;/&quot;
  interval = 60
  retries = 2
  check_regions = [&quot;WNAM&quot;, &quot;ENAM&quot;, &quot;WEU&quot;, &quot;EEU&quot;, &quot;SEAS&quot;, &quot;NEAS&quot;]
  description = &quot;GET / over HTTPS - expect 200&quot;
}
EOF
</code></pre>
<h5 id="iidefineandcreatethepooloforigins">ii. Define and create the pool of origins</h5>
<p>We will call our pool &quot;www-servers” and add two origins to it: <code>www-us</code> (<code>203.0.113.10</code>) and www-asia (<code>198.51.100.15</code>). For now, we'll skip any sort of <a href="https://support.cloudflare.com/hc/en-us/articles/115000540888-Load-Balancing-Geographic-Regions">geo routing</a>.</p>
<p>Note that we reference the monitor we added in the last step. When applying this confirmation, Terraform will figure out that it first needs to create the monitor so that it can look up the ID and provide to the pool we wish to create.</p>
<pre><code>$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_load_balancer_pool&quot; &quot;www-servers&quot; {
  name = &quot;www-servers&quot;
  monitor = &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;
  origins {
    name = &quot;www-us&quot;
    address = &quot;203.0.113.10&quot;
  }
  origins {
    name = &quot;www-asia&quot;
    address = &quot;198.51.100.15&quot;
  }
  description = &quot;www origins&quot;
  enabled = true
  minimum_origins = 1
  notification_email = &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7b02140e3b1e031a160b171e55181416">[email&#160;protected]</a>&quot;
}
EOF
</code></pre>
<h5 id="iiidefineandcreatetheloadbalancer">iii. Define and create the load balancer</h5>
<p>Note that when you create a load balancer (LB), it will <a href="https://support.cloudflare.com/hc/en-us/articles/115004954407-How-Does-a-Load-Balancer-Interact-with-Existing-DNS-Records-">replace any existing DNS records with the same name</a>. For example, when we create the &quot;www.example.com&quot; LB below, it will supersede the two www DNS records that you have previously defined. One benefit of leaving these DNS records in place is that if you temporarily disable load balancing, connections to this hostname will still be possible <a href="">as shown above</a>.</p>
<pre><code>$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {
  zone = &quot;example.com&quot;
  name = &quot;www-lb&quot;
  default_pool_ids = [&quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;]
  fallback_pool_id = &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;
  description = &quot;example load balancer&quot;
  proxied = true
}
EOF
</code></pre>
<h5 id="ivpreviewandmergethechanges">iv. Preview and merge the changes</h5>
<p>As usual, we take a look at the proposed plan before we apply any changes:</p>
<pre><code>$ terraform plan
...
Terraform will perform the following actions:

  + cloudflare_load_balancer.www-lb
      id:                         &lt;computed&gt;
      created_on:                 &lt;computed&gt;
      default_pool_ids.#:         &lt;computed&gt;
      description:                &quot;example load balancer&quot;
      fallback_pool_id:           &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;
      modified_on:                &lt;computed&gt;
      name:                       &quot;www-lb&quot;
      pop_pools.#:                &lt;computed&gt;
      proxied:                    &quot;true&quot;
      region_pools.#:             &lt;computed&gt;
      ttl:                        &lt;computed&gt;
      zone:                       &quot;example.com&quot;
      zone_id:                    &lt;computed&gt;

  + cloudflare_load_balancer_monitor.get-root-https
      id:                         &lt;computed&gt;
      created_on:                 &lt;computed&gt;
      description:                &quot;GET / over HTTPS - expect 200&quot;
      expected_body:              &quot;alive&quot;
      expected_codes:             &quot;200&quot;
      interval:                   &quot;60&quot;
      method:                     &quot;GET&quot;
      modified_on:                &lt;computed&gt;
      path:                       &quot;/&quot;
      retries:                    &quot;2&quot;
      timeout:                    &quot;5&quot;
      type:                       &quot;http&quot;

  + cloudflare_load_balancer_pool.www-servers
      id:                         &lt;computed&gt;
      check_regions.#:            &quot;6&quot;
      check_regions.1151265357:   &quot;SEAS&quot;
      check_regions.1997072153:   &quot;WEU&quot;
      check_regions.2367191053:   &quot;EEU&quot;
      check_regions.2826842289:   &quot;ENAM&quot;
      check_regions.2992567379:   &quot;WNAM&quot;
      check_regions.3706632574:   &quot;NEAS&quot;
      created_on:                 &lt;computed&gt;
      description:                &quot;www origins&quot;
      enabled:                    &quot;true&quot;
      minimum_origins:            &quot;1&quot;
      modified_on:                &lt;computed&gt;
      monitor:                    &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;
      name:                       &quot;www-servers&quot;
      notification_email:         &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="21584e54614459404c514d440f424e4c">[email&#160;protected]</a>&quot;
      origins.#:                  &quot;2&quot;
      origins.3039426352.address: &quot;198.51.100.15&quot;
      origins.3039426352.enabled: &quot;true&quot;
      origins.3039426352.name:    &quot;www-asia&quot;
      origins.4241861547.address: &quot;203.0.113.10&quot;
      origins.4241861547.enabled: &quot;true&quot;
      origins.4241861547.name:    &quot;www-us&quot;


Plan: 3 to add, 0 to change, 0 to destroy.
</code></pre>
<p>The plan looks good so let's go ahead, merge it in, and apply it.</p>
<pre><code>$ git add cloudflare.tf
$ git commit -m &quot;Step 5 - Create load balancer (LB) monitor, LB pool, and LB.&quot;
[step5-loadbalance bc9aa9a] Step 5 - Create load balancer (LB) monitor, LB pool, and LB.
 1 file changed, 35 insertions(+)

$ terraform apply --auto-approve
...
cloudflare_load_balancer_monitor.get-root-https: Creating...
  created_on:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  description:    &quot;&quot; =&gt; &quot;GET / over HTTPS - expect 200&quot;
  expected_body:  &quot;&quot; =&gt; &quot;alive&quot;
  expected_codes: &quot;&quot; =&gt; &quot;200&quot;
  interval:       &quot;&quot; =&gt; &quot;60&quot;
  method:         &quot;&quot; =&gt; &quot;GET&quot;
  modified_on:    &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  path:           &quot;&quot; =&gt; &quot;/&quot;
  retries:        &quot;&quot; =&gt; &quot;2&quot;
  timeout:        &quot;&quot; =&gt; &quot;5&quot;
  type:           &quot;&quot; =&gt; &quot;http&quot;
cloudflare_load_balancer_monitor.get-root-https: Creation complete after 1s (ID: 4238142473fcd48e89ef1964be72e3e0)
cloudflare_load_balancer_pool.www-servers: Creating...
  check_regions.#:            &quot;&quot; =&gt; &quot;6&quot;
  check_regions.1151265357:   &quot;&quot; =&gt; &quot;SEAS&quot;
  check_regions.1997072153:   &quot;&quot; =&gt; &quot;WEU&quot;
  check_regions.2367191053:   &quot;&quot; =&gt; &quot;EEU&quot;
  check_regions.2826842289:   &quot;&quot; =&gt; &quot;ENAM&quot;
  check_regions.2992567379:   &quot;&quot; =&gt; &quot;WNAM&quot;
  check_regions.3706632574:   &quot;&quot; =&gt; &quot;NEAS&quot;
  created_on:                 &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  description:                &quot;&quot; =&gt; &quot;www origins&quot;
  enabled:                    &quot;&quot; =&gt; &quot;true&quot;
  minimum_origins:            &quot;&quot; =&gt; &quot;1&quot;
  modified_on:                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  monitor:                    &quot;&quot; =&gt; &quot;4238142473fcd48e89ef1964be72e3e0&quot;
  name:                       &quot;&quot; =&gt; &quot;www-servers&quot;
  notification_email:         &quot;&quot; =&gt; &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9ae3f5efdaffe2fbf7eaf6ffb4f9f5f7">[email&#160;protected]</a>&quot;
  origins.#:                  &quot;&quot; =&gt; &quot;2&quot;
  origins.3039426352.address: &quot;&quot; =&gt; &quot;198.51.100.15&quot;
  origins.3039426352.enabled: &quot;&quot; =&gt; &quot;true&quot;
  origins.3039426352.name:    &quot;&quot; =&gt; &quot;www-asia&quot;
  origins.4241861547.address: &quot;&quot; =&gt; &quot;203.0.113.10&quot;
  origins.4241861547.enabled: &quot;&quot; =&gt; &quot;true&quot;
  origins.4241861547.name:    &quot;&quot; =&gt; &quot;www-us&quot;
cloudflare_load_balancer_pool.www-servers: Creation complete after 0s (ID: 906d2a7521634783f4a96c062eeecc6d)
cloudflare_load_balancer.www-lb: Creating...
  created_on:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  default_pool_ids.#: &quot;&quot; =&gt; &quot;1&quot;
  default_pool_ids.0: &quot;&quot; =&gt; &quot;906d2a7521634783f4a96c062eeecc6d&quot;
  description:        &quot;&quot; =&gt; &quot;example load balancer&quot;
  fallback_pool_id:   &quot;&quot; =&gt; &quot;906d2a7521634783f4a96c062eeecc6d&quot;
  modified_on:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  name:               &quot;&quot; =&gt; &quot;www-lb&quot;
  pop_pools.#:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  proxied:            &quot;&quot; =&gt; &quot;true&quot;
  region_pools.#:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  ttl:                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
  zone:               &quot;&quot; =&gt; &quot;example.com&quot;
  zone_id:            &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
cloudflare_load_balancer.www-lb: Creation complete after 1s (ID: cb94f53f150e5c1a65a07e43c5d4cac4)

Apply complete! Resources: 3 added, 0 changed, 0 destroyed.
</code></pre>
<h5 id="ivtestthechanges">iv. Test the changes</h5>
<p>With load balancing in place, let's run those curl requests again to see where the traffic is served from:</p>
<pre><code>$ for i in {1..4}; do curl https://www.example.com &amp;&amp; sleep 5; done
Hello, this is 198.51.100.15!

Hello, this is 203.0.113.10!

Hello, this is 198.51.100.15!

Hello, this is 203.0.113.10!
</code></pre>
<p>Great, we're now seeing each request load balanced evenly across the two origins we defined.</p>
<h3 id="usingpagerules">Using page rules</h3>
<p>Earlier we configured zone settings that apply to all of example.com. Now we're going to add an exception to these settings by using <a href="https://www.cloudflare.com/features-page-rules/">Page Rules</a>.</p>
<p>Specifically, we're going to turn increase the security level for a URL we know is expensive to render (and cannot be cached): <a href="https://www.example.com/expensive-db-call">https://www.example.com/expensive-db-call</a>. Additionally, we're going to add a redirect from the previous URL we used to host this page.</p>
<h4 id="1createanewbranchandappendthepagerule">1. Create a new branch and append the page rule</h4>
<p>As usual we'll create a new branch and append our configuration.</p>
<pre><code>$ git checkout -b step6-pagerule
Switched to a new branch 'step6-pagerule'

$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_page_rule&quot; &quot;increase-security-on-expensive-page&quot; {
  zone = &quot;${var.domain}&quot;
  target = &quot;www.${var.domain}/expensive-db-call&quot;
  priority = 10

  actions = {
    security_level = &quot;under_attack&quot;,
  }
}

resource &quot;cloudflare_page_rule&quot; &quot;redirect-to-new-db-page&quot; {
  zone = &quot;${var.domain}&quot;
  target = &quot;www.${var.domain}/old-location.php&quot;
  priority = 10

  actions = {
    forwarding_url {
      url = &quot;https://www.${var.domain}/expensive-db-call&quot;
      status_code = 301
    }
  }
}
EOF
</code></pre>
<h4 id="2previewandmergethechanges">2. Preview and merge the changes</h4>
<p>You know the drill: preview the changes Terraform is going to make and then merge them into the master branch.</p>
<pre><code>$ terraform plan
...
Terraform will perform the following actions:

  + cloudflare_page_rule.increase-security-on-expensive-page
      id:                                     &lt;computed&gt;
      actions.#:                              &quot;1&quot;
      actions.0.always_use_https:             &quot;false&quot;
      actions.0.disable_apps:                 &quot;false&quot;
      actions.0.disable_performance:          &quot;false&quot;
      actions.0.disable_security:             &quot;false&quot;
      actions.0.security_level:               &quot;under_attack&quot;
      priority:                               &quot;10&quot;
      status:                                 &quot;active&quot;
      target:                                 &quot;www.example.com/expensive-db-call&quot;
      zone:                                   &quot;example.com&quot;
      zone_id:                                &lt;computed&gt;

  + cloudflare_page_rule.redirect-to-new-db-page
      id:                                     &lt;computed&gt;
      actions.#:                              &quot;1&quot;
      actions.0.always_use_https:             &quot;false&quot;
      actions.0.disable_apps:                 &quot;false&quot;
      actions.0.disable_performance:          &quot;false&quot;
      actions.0.disable_security:             &quot;false&quot;
      actions.0.forwarding_url.#:             &quot;1&quot;
      actions.0.forwarding_url.0.status_code: &quot;301&quot;
      actions.0.forwarding_url.0.url:         &quot;https://www.example.com/expensive-db-call&quot;
      priority:                               &quot;10&quot;
      status:                                 &quot;active&quot;
      target:                                 &quot;www.example.com/old-location.php&quot;
      zone:                                   &quot;example.com&quot;
      zone_id:                                &lt;computed&gt;


Plan: 2 to add, 0 to change, 0 to destroy.
</code></pre>
<pre><code>$ git add cloudflare.tf

$ git commit -m &quot;Step 6 - Add two Page Rules.&quot;
[step6-pagerule d4fec16] Step 6 - Add two Page Rules.
 1 file changed, 23 insertions(+)

$ git checkout master
Switched to branch 'master'

$ git merge step6-pagerule 
Updating 7a2ac34..d4fec16
Fast-forward
 cloudflare.tf | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)
3. Apply And Verify The Changes
First we'll test requesting the (now missing) old location of the expensive-to-render page.
</code></pre>
<pre><code>$ curl -vso /dev/null https://www.example.com/old-location.php 2&gt;&amp;1 | grep &quot;&lt; HTTP\|Location&quot;
&lt; HTTP/1.1 404 Not Found
</code></pre>
<p>As expected, it can't be found. Let's apply the Page Rules, including the redirect that should fix this error.</p>
<pre><code>$ terraform apply --auto-approve
...
cloudflare_page_rule.redirect-to-new-db-page: Creating...
  actions.#:                              &quot;0&quot; =&gt; &quot;1&quot;
  actions.0.always_use_https:             &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_apps:                 &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_performance:          &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_security:             &quot;&quot; =&gt; &quot;false&quot;
  actions.0.forwarding_url.#:             &quot;0&quot; =&gt; &quot;1&quot;
  actions.0.forwarding_url.0.status_code: &quot;&quot; =&gt; &quot;301&quot;
  actions.0.forwarding_url.0.url:         &quot;&quot; =&gt; &quot;https://www.example.com/expensive-db-call&quot;
  priority:                               &quot;&quot; =&gt; &quot;10&quot;
  status:                                 &quot;&quot; =&gt; &quot;active&quot;
  target:                                 &quot;&quot; =&gt; &quot;www.example.com/old-location.php&quot;
  zone:                                   &quot;&quot; =&gt; &quot;example.com&quot;
  zone_id:                                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
cloudflare_page_rule.increase-security-on-expensive-page: Creating...
  actions.#:                     &quot;0&quot; =&gt; &quot;1&quot;
  actions.0.always_use_https:    &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_apps:        &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_performance: &quot;&quot; =&gt; &quot;false&quot;
  actions.0.disable_security:    &quot;&quot; =&gt; &quot;false&quot;
  actions.0.security_level:      &quot;&quot; =&gt; &quot;under_attack&quot;
  priority:                      &quot;&quot; =&gt; &quot;10&quot;
  status:                        &quot;&quot; =&gt; &quot;active&quot;
  target:                        &quot;&quot; =&gt; &quot;www.example.com/expensive-db-call&quot;
  zone:                          &quot;&quot; =&gt; &quot;example.com&quot;
  zone_id:                       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;
cloudflare_page_rule.redirect-to-new-db-page: Creation complete after 3s (ID: c5c40ff2dc12416b5fe4d0541980c591)
cloudflare_page_rule.increase-security-on-expensive-page: Creation complete after 6s (ID: 1c13fdb84710c4cc8b11daf7ffcca449)

Apply complete! Resources: 2 added, 0 changed, 0 destroyed.
</code></pre>
<p>With the Page Rules in place, let's try that call again, along with the <a href="https://blog.cloudflare.com/introducing-im-under-attack-mode/">I'm Under Attack Mode</a> test:</p>
<pre><code>$ curl -vso /dev/null https://www.example.com/old-location.php 2&gt;&amp;1 | grep &quot;&lt; HTTP\|Location&quot;
&lt; HTTP/1.1 301 Moved Permanently
&lt; Location: https://www.upinatoms.com/expensive-db-call

$ curl -vso /dev/null https://www.upinatoms.com/expensive-db-call 2&gt;&amp;1 | grep &quot;&lt; HTTP&quot;
&lt; HTTP/1.1 503 Service Temporarily Unavailable
</code></pre>
<p>Great, they work as expected! In the first case, the Cloudflare edge responds with a <code>301</code> redirecting the browser to the new location. In the second case it initially responds with a <code>503</code> (as is consistent with the &quot;I Am Under Attack” mode).</p>
<h3 id="reviewingandrollingbackchanges">Reviewing and rolling back changes</h3>
<p>We've come a long way! Now it's time to tear it all down. Well, maybe just part of it.</p>
<p>Sometimes when you deploy configuration changes you later determine that they need to be rolled back. You could be performance testing a new configuration and want to revert to your previous configuration when done testing. Or maybe you fat-fingered an IP address and brought your entire site down (#hugops).</p>
<p>Either way, if you've determined you want to revert your configuration, all you need to do is check the desired branch out and ask Terraform to move your Cloudflare settings back in time. And note that if you accidentally brought your site down you should consider establishing a good strategy for peer reviewing pull requests (rather than merging directly to primary, as I do here for brevity)!</p>
<h4 id="1reviewingyourconfigurationhistory">1. Reviewing your configuration history</h4>
<p>Before we figure out how far back in time we want to rollback, let's take a look at our (git) versioned history.</p>
<pre><code>$ git log
commit d4fec164581bec44684a4d59bb80aec1f1da5a6e
Author: Me
Date:   Wed Apr 18 22:04:52 2018 -0700

    Step 6 - Add two Page Rules.

commit bc9aa9a465a4c8d6deeaa0491814c9f364e9aa8a
Author: Me
Date:   Sun Apr 15 23:58:35 2018 -0700

    Step 5 - Create load balancer (LB) monitor, LB pool, and LB.

commit 6761a4f754e77322629ba4e90a90a3defa1fd4b6
Author: Me
Date:   Wed Apr 11 11:20:25 2018 -0700

    Step 5 - Add additional 'www' DNS record for Asia data center.

commit e1c38cf6f4230a48114ce7b747b77d6435d4646c
Author: Me
Date:   Mon Apr 9 12:34:44 2018 -0700

    Step 4 - Update /login rate limit rule from 'simulate' to 'ban'.

commit 0f7e499c70bf5994b5d89120e0449b8545ffdd24
Author: Me
Date:   Mon Apr 9 12:22:43 2018 -0700

    Step 4 - Add rate limiting rule to protect /login.

commit d540600b942cbd89d03db52211698d331f7bd6d7
Author: Me
Date:   Sun Apr 8 22:21:27 2018 -0700

    Step 3 - Enable TLS 1.3, Always Use HTTPS, and SSL Strict mode.

commit 494c6d61b918fce337ca4c0725c9bbc01e00f0b7
Author: Me
Date:   Sun Apr 8 19:58:56 2018 -0700

    Step 2 - Ignore terraform plugin directory and state file.

commit 5acea176050463418f6ac1029674c152e3056bc6
Author: Me
Date:   Sun Apr 8 19:52:13 2018 -0700

    Step 2 - Initial commit with webserver definition.

Another nice benefit of storing your Cloudflare configuration in git is that you can see who made the change, as well as who reviewed and approved the change (assuming you're peer reviewing pull requests).
</code></pre>
<h4 id="2examiningspecifichistoricalchanges">2. Examining specific historical changes</h4>
<p>To begin with, let's see what the last change we made was.</p>
<pre><code>$ git show
commit d4fec164581bec44684a4d59bb80aec1f1da5a6e
Author: Me
Date:   Wed Apr 18 22:04:52 2018 -0700

    Step 6 - Add two Page Rules.

diff --git a/cloudflare.tf b/cloudflare.tf
index 0b39450..ef11d8a 100644
--- a/cloudflare.tf
+++ b/cloudflare.tf
@@ -94,3 +94,26 @@ resource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {
   description = &quot;example load balancer&quot;
   proxied = true
 }
+
+resource &quot;cloudflare_page_rule&quot; &quot;increase-security-on-expensive-page&quot; {
+  zone = &quot;${var.domain}&quot;
+  target = &quot;www.${var.domain}/expensive-db-call&quot;
+  priority = 10
+
+  actions = {
+    security_level = &quot;under_attack&quot;,
+  }
+}
+
+resource &quot;cloudflare_page_rule&quot; &quot;redirect-to-new-db-page&quot; {
+  zone = &quot;${var.domain}&quot;
+  target = &quot;www.${var.domain}/old-location.php&quot;
+  priority = 10
+
+  actions = {
+    forwarding_url {
+      url = &quot;https://${var.domain}/expensive-db-call&quot;
+      status_code = 301
+    }
+  }
+}
</code></pre>
<p>Now let's look at the past few changes:</p>
<pre><code>$ git log -p -3

... 
// page rule config from above
...

commit bc9aa9a465a4c8d6deeaa0491814c9f364e9aa8a
Author: Me
Date:   Sun Apr 15 23:58:35 2018 -0700

    Step 5 - Create load balancer (LB) monitor, LB pool, and LB.

diff --git a/cloudflare.tf b/cloudflare.tf
index b92cb6f..195b646 100644
--- a/cloudflare.tf
+++ b/cloudflare.tf
@@ -59,3 +59,38 @@ resource &quot;cloudflare_record&quot; &quot;www-asia&quot; {
   type    = &quot;A&quot;
   proxied = true
 }
+resource &quot;cloudflare_load_balancer_monitor&quot; &quot;get-root-https&quot; {
+  expected_body = &quot;alive&quot;
+  expected_codes = &quot;200&quot;
+  method = &quot;GET&quot;
+  timeout = 5
+  path = &quot;/&quot;
+  interval = 60
+  retries = 2
+  description = &quot;GET / over HTTPS - expect 200&quot;
+}
+resource &quot;cloudflare_load_balancer_pool&quot; &quot;www-servers&quot; {
+  name = &quot;www-servers&quot;
+  monitor = &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;
+  check_regions = [&quot;WNAM&quot;, &quot;ENAM&quot;, &quot;WEU&quot;, &quot;EEU&quot;, &quot;SEAS&quot;, &quot;NEAS&quot;]
+  origins {
+    name = &quot;www-us&quot;
+    address = &quot;203.0.113.10&quot;
+  }
+  origins {
+    name = &quot;www-asia&quot;
+    address = &quot;198.51.100.15&quot;
+  }
+  description = &quot;www origins&quot;
+  enabled = true
+  minimum_origins = 1
+  notification_email = &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b6cfd9c3f6d3ced7dbc6dad398d5d9db">[email&#160;protected]</a>&quot;
+}
+resource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {
+  zone = &quot;${var.domain}&quot;
+  name = &quot;www-lb&quot;
+  default_pool_ids = [&quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;]
+  fallback_pool_id = &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;
+  description = &quot;example load balancer&quot;
+  proxied = true
+}

commit 6761a4f754e77322629ba4e90a90a3defa1fd4b6
Author: Me
Date:   Wed Apr 11 11:20:25 2018 -0700

    Step 5 - Add additional 'www' DNS record for Asia data center.

diff --git a/cloudflare.tf b/cloudflare.tf
index 9f25a0c..b92cb6f 100644
--- a/cloudflare.tf
+++ b/cloudflare.tf
@@ -52,3 +52,10 @@ resource &quot;cloudflare_rate_limit&quot; &quot;login-limit&quot; {
   disabled = false
   description = &quot;Block failed login attempts (5 in 1 min) for 5 minutes.&quot;
 }
+resource &quot;cloudflare_record&quot; &quot;www-asia&quot; {
+  domain  = &quot;${var.domain}&quot;
+  name    = &quot;www&quot;
+  value   = &quot;198.51.100.15&quot;
+  type    = &quot;A&quot;
+  proxied = true
+}
</code></pre>
<h4 id="3redeployingthepreviousconfiguration">3. Redeploying the previous configuration</h4>
<p>Imagine that shortly after we <a href="#usingpagerules">deployed the Page Rules</a>, we got a call from the Product team that manages this page: &quot;The URL was only being used by one customer and is no longer needed, let's drop the security setting and redirect.”</p>
<p>While you could always edit the config file directly and delete those entries, it's easier to let git do it for us. To begin with, let's ask git to revert the last commit (without rewriting history).</p>
<h5 id="irevertthebranchtothepreviouscommit">i. Revert the branch to the previous commit</h5>
<pre><code>$ git revert HEAD~1..HEAD
[master f9a6f7d] Revert &quot;Step 6 - Bug fix.&quot;
 1 file changed, 1 insertion(+), 1 deletion(-)

$ git log -2
commit f9a6f7db72ea1437e146050a5e7556052ecc9a1a
Author: Me
Date:   Wed Apr 18 23:28:09 2018 -0700

    Revert &quot;Step 6 - Add two Page Rules.&quot;
    
    This reverts commit d4fec164581bec44684a4d59bb80aec1f1da5a6e.

commit d4fec164581bec44684a4d59bb80aec1f1da5a6e
Author: Me
Date:   Wed Apr 18 22:04:52 2018 -0700

    Step 6 - Add two Page Rules.
</code></pre>
<h5 id="iipreviewthechanges">ii. Preview the changes</h5>
<p>As expected, Terraform is indicating it will remove the two Page Rules we just created.</p>
<pre><code>$ terraform plan
...
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  - cloudflare_page_rule.increase-security-on-expensive-page

  - cloudflare_page_rule.redirect-to-new-db-page


Plan: 0 to add, 0 to change, 2 to destroy.
</code></pre>
<h5 id="ivapplythechanges">iv. Apply the changes</h5>
<p>The changes look good, so let's ask Terraform to roll our Cloudflare configuration back.</p>
<pre><code>$ terraform apply --auto-approve
...
cloudflare_page_rule.redirect-to-new-db-page: Destroying... (ID: c5c40ff2dc12416b5fe4d0541980c591)
cloudflare_page_rule.increase-security-on-expensive-page: Destroying... (ID: 1c13fdb84710c4cc8b11daf7ffcca449)
cloudflare_page_rule.increase-security-on-expensive-page: Destruction complete after 0s
cloudflare_page_rule.redirect-to-new-db-page: Destruction complete after 1s

Apply complete! Resources: 0 added, 0 changed, 2 destroyed.
</code></pre>
<p>Two resources destroyed, as expected. We've rolled back to the previous version.</p>
<h3 id="importingexistingstateandconfiguration">Importing existing state and configuration</h3>
<p>An important point to understand about Terraform is that it is only able to manage configuration that it created, or was explicitly told about after the fact. The reason for this limitation is that Terraform relies on a local <a href="https://www.terraform.io/docs/state/">state file</a> that maps the resource names defined in your configuration file, e.g., <code>cloudflare_load_balancer.www-lb</code> to the IDs generated by Cloudflare's API.</p>
<p>When Terraform makes calls to Cloudflare's API to create new resources , it persists those IDs to a state file; by default, the <code>terraform.tfstate</code> file in your directory is used, but this can be a remote location as will be discussed in a future blog post. These IDs are later looked up and refreshed when you call <code>terraform plan</code> and <code>terraform apply</code>.</p>
<p>If you've configured Cloudflare through other means, e.g., by logging into the Cloudflare Dashboard or making <code>curl</code> calls to <code>api.cloudflare.com</code>, Terraform does not (yet) have these resource IDs in the state file. To manage this preexisting configuration you will need to first i) reproduce the configuration in your config file and; ii) import resources one-by-one by providing their IDs and resource names.</p>
<h4 id="1reviewingyourcurrentstatefile">1. Reviewing your current state file</h4>
<p>Before importing resources created by other means, let's take a look at how an existing DNS records is represented in the state file.</p>
<pre><code>$ cat terraform.tfstate | jq '.modules[].resources[&quot;cloudflare_record.www&quot;]'
{
  &quot;type&quot;: &quot;cloudflare_record&quot;,
  &quot;depends_on&quot;: [],
  &quot;primary&quot;: {
    &quot;id&quot;: &quot;c38d3103767284e7cd14d5dad3ab8669&quot;,
    &quot;attributes&quot;: {
      &quot;created_on&quot;: &quot;2018-04-08T00:37:33.76321Z&quot;,
      &quot;data.%&quot;: &quot;0&quot;,
      &quot;domain&quot;: &quot;example.com&quot;,
      &quot;hostname&quot;: &quot;www.example.com&quot;,
      &quot;id&quot;: &quot;c38d3103767284e7cd14d5dad3ab8669&quot;,
      &quot;metadata.%&quot;: &quot;2&quot;,
      &quot;metadata.auto_added&quot;: &quot;false&quot;,
      &quot;metadata.managed_by_apps&quot;: &quot;false&quot;,
      &quot;modified_on&quot;: &quot;2018-04-08T00:37:33.76321Z&quot;,
      &quot;name&quot;: &quot;www&quot;,
      &quot;priority&quot;: &quot;0&quot;,
      &quot;proxiable&quot;: &quot;true&quot;,
      &quot;proxied&quot;: &quot;true&quot;,
      &quot;ttl&quot;: &quot;1&quot;,
      &quot;type&quot;: &quot;A&quot;,
      &quot;value&quot;: &quot;203.0.113.10&quot;,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;
    },
    &quot;meta&quot;: {
      &quot;schema_version&quot;: &quot;1&quot;
    },
    &quot;tainted&quot;: false
  },
  &quot;deposed&quot;: [],
  &quot;provider&quot;: &quot;provider.cloudflare&quot;
}
</code></pre>
<p>As shown in the above JSON, the <code>cloudflare_record</code> resource named &quot;www&quot; has a unique ID of <code>c38d3103767284e7cd14d5dad3ab8669</code>. This ID is what gets interpolated into the API call that Terraform makes to Cloudflare to pull the latest configuration during the plan stage, e.g.,</p>
<pre><code>GET https://api.cloudflare.com/client/v4/zones/:zone_id/dns_records/c38d3103767284e7cd14d5dad3ab8669
</code></pre>
<h4 id="2importingexistingcloudflareresources">2. Importing existing Cloudflare resources</h4>
<p>To import an existing record, e.g., another DNS record, you need two things:</p>
<ol>
<li>The unique identifier that Cloudflare uses to identify the record</li>
<li>The resource name to which you wish to map this identifier</li>
</ol>
<h5 id="idownloadidsandconfigurationfromapicloudflarecom">i. Download IDs and configuration from api.cloudflare.com</h5>
<p>We start by making an API call to Cloudflare to enumerate the DNS records in our account. The output below has been filtered to show only MX records, as these are what we'll be importing.</p>
<pre><code>$ curl https://api.cloudflare.com/client/v4/zones/$EXAMPLE_COM_ZONEID \
       -H &quot;X-Auth-Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a8d1c7dde8cdd0c9c5d8c4cd86cbc7c5">[email&#160;protected]</a>&quot; -H &quot;X-Auth-Key: $CF_API_KEY&quot; \
       -H &quot;Content-Type: application/json&quot; | jq .

{
  &quot;result&quot;: [
    {
      &quot;id&quot;: &quot;8ea8c36c8530ee01068c65c0ddc4379b&quot;,
      &quot;type&quot;: &quot;MX&quot;,
      &quot;name&quot;: &quot;example.com&quot;,
      &quot;content&quot;: &quot;alt1.aspmx.l.google.com&quot;,
      &quot;proxiable&quot;: false,
      &quot;proxied&quot;: false,
      &quot;ttl&quot;: 1,
      &quot;priority&quot;: 15,
      &quot;locked&quot;: false,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,
      &quot;zone_name&quot;: &quot;example.com&quot;,
      &quot;modified_on&quot;: &quot;2016-11-06T01:11:50.163221Z&quot;,
      &quot;created_on&quot;: &quot;2016-11-06T01:11:50.163221Z&quot;,
      &quot;meta&quot;: {
        &quot;auto_added&quot;: false,
        &quot;managed_by_apps&quot;: false
      }
    },
    {
      &quot;id&quot;: &quot;ad0e9ff2479b13c5fbde77a02ea6fa2c&quot;,
      &quot;type&quot;: &quot;MX&quot;,
      &quot;name&quot;: &quot;example.com&quot;,
      &quot;content&quot;: &quot;alt2.aspmx.l.google.com&quot;,
      &quot;proxiable&quot;: false,
      &quot;proxied&quot;: false,
      &quot;ttl&quot;: 1,
      &quot;priority&quot;: 15,
      &quot;locked&quot;: false,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,
      &quot;zone_name&quot;: &quot;example.com&quot;,
      &quot;modified_on&quot;: &quot;2016-11-06T01:12:00.915649Z&quot;,
      &quot;created_on&quot;: &quot;2016-11-06T01:12:00.915649Z&quot;,
      &quot;meta&quot;: {
        &quot;auto_added&quot;: false,
        &quot;managed_by_apps&quot;: false
      }
    },
    {
      &quot;id&quot;: &quot;ad6ee69519cd02a0155a56b6d64c278a&quot;,
      &quot;type&quot;: &quot;MX&quot;,
      &quot;name&quot;: &quot;example.com&quot;,
      &quot;content&quot;: &quot;alt3.aspmx.l.google.com&quot;,
      &quot;proxiable&quot;: false,
      &quot;proxied&quot;: false,
      &quot;ttl&quot;: 1,
      &quot;priority&quot;: 20,
      &quot;locked&quot;: false,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,
      &quot;zone_name&quot;: &quot;example.com&quot;,
      &quot;modified_on&quot;: &quot;2016-11-06T01:12:12.899684Z&quot;,
      &quot;created_on&quot;: &quot;2016-11-06T01:12:12.899684Z&quot;,
      &quot;meta&quot;: {
        &quot;auto_added&quot;: false,
        &quot;managed_by_apps&quot;: false
      }
    },
    {
      &quot;id&quot;: &quot;baf6655f33738b7fd902630858878206&quot;,
      &quot;type&quot;: &quot;MX&quot;,
      &quot;name&quot;: &quot;example.com&quot;,
      &quot;content&quot;: &quot;alt4.aspmx.l.google.com&quot;,
      &quot;proxiable&quot;: false,
      &quot;proxied&quot;: false,
      &quot;ttl&quot;: 1,
      &quot;priority&quot;: 20,
      &quot;locked&quot;: false,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,
      &quot;zone_name&quot;: &quot;example.com&quot;,
      &quot;modified_on&quot;: &quot;2016-11-06T01:12:22.599272Z&quot;,
      &quot;created_on&quot;: &quot;2016-11-06T01:12:22.599272Z&quot;,
      &quot;meta&quot;: {
        &quot;auto_added&quot;: false,
        &quot;managed_by_apps&quot;: false
      }
    },
    {
      &quot;id&quot;: &quot;a96d72b3c6afe3077f9e9c677fb0a556&quot;,
      &quot;type&quot;: &quot;MX&quot;,
      &quot;name&quot;: &quot;example.com&quot;,
      &quot;content&quot;: &quot;aspmx.lo.google.com&quot;,
      &quot;proxiable&quot;: false,
      &quot;proxied&quot;: false,
      &quot;ttl&quot;: 1,
      &quot;priority&quot;: 10,
      &quot;locked&quot;: false,
      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,
      &quot;zone_name&quot;: &quot;example.com&quot;,
      &quot;modified_on&quot;: &quot;2016-11-06T01:11:27.700386Z&quot;,
      &quot;created_on&quot;: &quot;2016-11-06T01:11:27.700386Z&quot;,
      &quot;meta&quot;: {
        &quot;auto_added&quot;: false,
        &quot;managed_by_apps&quot;: false
      }
    },

    ...
  ]
}
</code></pre>
<h5 id="iicreateterraformconfigurationforexistingrecords">ii. Create Terraform configuration for existing records</h5>
<p>In the previous step, we found 5 MX records that we wish to add.</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Priority</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>a96d72b3c6afe3077f9e9c677fb0a556</td>
<td>10</td>
<td>aspmx.lo.google.com</td>
</tr>
<tr>
<td>8ea8c36c8530ee01068c65c0ddc4379b</td>
<td>15</td>
<td>alt1.aspmx.l.google.com</td>
</tr>
<tr>
<td>ad0e9ff2479b13c5fbde77a02ea6fa2c</td>
<td>15</td>
<td>alt2.aspmx.l.google.com</td>
</tr>
<tr>
<td>ad6ee69519cd02a0155a56b6d64c278a</td>
<td>20</td>
<td>alt3.aspmx.l.google.com</td>
</tr>
<tr>
<td>baf6655f33738b7fd902630858878206</td>
<td>20</td>
<td>alt4.aspmx.l.google.com</td>
</tr>
</tbody>
</table>
<p>Before importing, we need to create Terraform configuration and give each record a unique name that can be referenced during the import.</p>
<pre><code>$ cat &gt;&gt; cloudflare.tf &lt;&lt;'EOF'
resource &quot;cloudflare_record&quot; &quot;mx-10&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;${var.domain}&quot;
  value   = &quot;aspmx.lo.google.com&quot;
  type    = &quot;MX&quot;
  priority = &quot;10&quot;
}
resource &quot;cloudflare_record&quot; &quot;mx-15-1&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;${var.domain}&quot;
  value   = &quot;alt1.aspmx.l.google.com&quot;
  type    = &quot;MX&quot;
  priority = &quot;15&quot;
}
resource &quot;cloudflare_record&quot; &quot;mx-15-2&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;${var.domain}&quot;
  value   = &quot;alt2.aspmx.l.google.com&quot;
  type    = &quot;MX&quot;
  priority = &quot;15&quot;
}
resource &quot;cloudflare_record&quot; &quot;mx-20-1&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;${var.domain}&quot;
  value   = &quot;alt3.aspmx.l.google.com&quot;
  type    = &quot;MX&quot;
  priority = &quot;20&quot;
}
resource &quot;cloudflare_record&quot; &quot;mx-20-2&quot; {
  domain  = &quot;${var.domain}&quot;
  name    = &quot;${var.domain}&quot;
  value   = &quot;alt3.aspmx.l.google.com&quot;
  type    = &quot;MX&quot;
  priority = &quot;20&quot;
}
EOF
</code></pre>
<h5 id="iiiimportresourcesintoterraformstate">iii. Import resources into Terraform state</h5>
<p>Before we import the records, let's look at what would happen if we ran a <code>terraform apply</code>.</p>
<pre><code>$ terraform plan | grep Plan
Plan: 5 to add, 0 to change, 0 to destroy.
</code></pre>
<p>Terraform does not know that these records already exist on Cloudflare, so until the import completes it will attempt to create them as new records. Below we import them one-by-one, specifying the name of the resource and the <code>zoneName/resourceID</code> returned by api.cloudflare.com.</p>
<pre><code>$ terraform import cloudflare_record.mx-10 example.com/a96d72b3c6afe3077f9e9c677fb0a556
cloudflare_record.mx-10: Importing from ID &quot;example.com/a96d72b3c6afe3077f9e9c677fb0a556&quot;...
cloudflare_record.mx-10: Import complete!
  Imported cloudflare_record (ID: a96d72b3c6afe3077f9e9c677fb0a556)
cloudflare_record.mx-10: Refreshing state... (ID: a96d72b3c6afe3077f9e9c677fb0a556)

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.

$ terraform import cloudflare_record.mx-15-1 example.com/8ea8c36c8530ee01068c65c0ddc4379b
cloudflare_record.mx-15-1: Importing from ID &quot;example.com/8ea8c36c8530ee01068c65c0ddc4379b&quot;...
cloudflare_record.mx-15-1: Import complete!
  Imported cloudflare_record (ID: 8ea8c36c8530ee01068c65c0ddc4379b)
cloudflare_record.mx-15-1: Refreshing state... (ID: 8ea8c36c8530ee01068c65c0ddc4379b)

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.

$ terraform import cloudflare_record.mx-15-2 example.com/ad0e9ff2479b13c5fbde77a02ea6fa2c
cloudflare_record.mx-15-2: Importing from ID &quot;example.com/ad0e9ff2479b13c5fbde77a02ea6fa2c&quot;...
cloudflare_record.mx-15-2: Import complete!
  Imported cloudflare_record (ID: ad0e9ff2479b13c5fbde77a02ea6fa2c)
cloudflare_record.mx-15-2: Refreshing state... (ID: ad0e9ff2479b13c5fbde77a02ea6fa2c)

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.

$ terraform import cloudflare_record.mx-20-1 example.com/ad6ee69519cd02a0155a56b6d64c278a
cloudflare_record.mx-20-1: Importing from ID &quot;example.com/ad6ee69519cd02a0155a56b6d64c278a&quot;...
cloudflare_record.mx-20-1: Import complete!
  Imported cloudflare_record (ID: ad6ee69519cd02a0155a56b6d64c278a)
cloudflare_record.mx-20-1: Refreshing state... (ID: ad6ee69519cd02a0155a56b6d64c278a)

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.

$ terraform import cloudflare_record.mx-20-2 example.com/baf6655f33738b7fd902630858878206
cloudflare_record.mx-20-2: Importing from ID &quot;example.com/baf6655f33738b7fd902630858878206&quot;...
cloudflare_record.mx-20-2: Import complete!
  Imported cloudflare_record (ID: baf6655f33738b7fd902630858878206)
cloudflare_record.mx-20-2: Refreshing state... (ID: baf6655f33738b7fd902630858878206)

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
</code></pre>
<p>Now when we run <code>terraform plan</code> it no longer wants to (re-)create the above records.</p>
<pre><code>$ terraform plan | grep changes
No changes. Infrastructure is up-to-date.
</code></pre>
<h3 id="wrappingup">Wrapping up</h3>
<p>That's it for today! We covered the <a href="#addingloadbalancing">Load Balancing</a> and <a href="#usingpagerules">Page Rules</a> resources, as well as demonstrated how to <a href="#reviewingandrollingbackchanges">review and roll back configuration changes</a>, and <a href="#importingexistingstateandconfiguration">import state</a>.</p>
<p>Stay tuned for future Terraform blog posts, where we plan to show how to manage state effectively in a group setting, go multi-cloud with Terraform, and much more.</p>
<!--kg-card-end: markdown-->
            </div>
        </section>

        <a href="/tag/developers/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Developers</a>
        <a href="/tag/terraform/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Terraform</a>
        <a href="/tag/loadbalancing/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Load Balancing</a>
        <a href="/tag/page-rules/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Page Rules</a>
        <a href="/tag/hashicorp/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">HashiCorp</a>
    </article>
</main>

<div class="pv4 flex flex-row flex-wrap mw7 center">
    <div class="w-100 ph3 bt b--gray8">
        <p class="orange fw5 f4 mt4 ttu">Related Posts</p>
    </div>

    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2019-05-18T01:01:00+01:00">May 18, 2019 1:01AM</p>
        <a href="/moscow-developers-join-cloudflare-yandex-at-our-meetup/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Join Cloudflare &amp; Yandex at our Moscow meetup! Присоединяйтесь к митапу в Москве!</h2>
        </a>

        <p class="gray1 lh-copy">Are you based in Moscow? Cloudflare is partnering with Yandex to produce a meetup this month in Yandex's Moscow headquarters.  We would love to invite you to join us to learn about the newest in the Internet industry....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/andrew/" class="fw5 f2 black no-underline">Andrew Fitch</a>
                </div>
            </li>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    <span class="fw5 f2 black no-underline">,&nbsp;</span>
                    <a href="/author/albina/" class="fw5 f2 black no-underline">Albina Sultangulova</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/russia/" class="no-underline f1 fw2 blue3 underline-hover">Russia</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/cloudflare-meetups/" class="no-underline f1 fw2 blue3 underline-hover">Cloudflare Meetups</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/meetup/" class="no-underline f1 fw2 blue3 underline-hover">MeetUp</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/events/" class="no-underline f1 fw2 blue3 underline-hover">Events</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2018-11-23T15:49:00Z">November 23, 2018 3:49PM</p>
        <a href="/every-7-8us-your-computers-memory-has-a-hiccup/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Every 7.8μs your computer’s memory has a hiccup</h2>
        </a>

        <p class="gray1 lh-copy">I was particularly interested in one of the consequences of how dynamic RAM works. You see, each bit of data is stored by the charge (or lack of it) on a tiny capacitor within the RAM chip. But these capacitors gradually lose their charge over time....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/marek-majkowski/" class="fw5 f2 black no-underline">Marek Majkowski</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/programming/" class="no-underline f1 fw2 blue3 underline-hover">Programming</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2018-05-08T22:28:44+01:00">May 08, 2018 10:28PM</p>
        <a href="/rise-of-edge-compute-the-video/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">The Rise of Edge Compute: The Video</h2>
        </a>

        <p class="gray1 lh-copy">At the end of March, Kenton Varda, tech lead and architect for Cloudflare Workers, traveled to London and led a talk about the Rise of Edge Compute where he laid out our vision for the future of the Internet as a platform....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/andrew/" class="fw5 f2 black no-underline">Andrew Fitch</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/community/" class="no-underline f1 fw2 blue3 underline-hover">Community</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/events/" class="no-underline f1 fw2 blue3 underline-hover">Events</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/video/" class="no-underline f1 fw2 blue3 underline-hover">Video</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/cloudflare-apps/" class="no-underline f1 fw2 blue3 underline-hover">Cloudflare Apps</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2018-04-27T21:18:10+01:00">April 27, 2018 9:18PM</p>
        <a href="/getting-started-with-terraform-and-cloudflare-part-1/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Getting started with Terraform and Cloudflare (Part 1 of 2)</h2>
        </a>

        <p class="gray1 lh-copy">Write code to manage your Cloudflare configuration using Terraform, and store it in your source code repository of choice for versioned history and rollback....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/patrick/" class="fw5 f2 black no-underline">Patrick R. Donahue</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/terraform/" class="no-underline f1 fw2 blue3 underline-hover">Terraform</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/hashicorp/" class="no-underline f1 fw2 blue3 underline-hover">HashiCorp</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/programming/" class="no-underline f1 fw2 blue3 underline-hover">Programming</a>
        </div>
    </article>

</div>
<div class="pv4 ph3 mw7 center">
    <div id="disqus_thread"></div>
</div>



        <footer class="pt4 pb4 pl1 pr1 main-footer">
  <div class="mw8 center dn db-l ph3">
    <div class="flex flex-row justify-between">
      <div class="main-footer__menu-group">
        <ul id="sales-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="sales-menu"
            class="main-footer__menu-group__header js-toggle-footer-group f1">
            Sales
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/enterprise/contact/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="enterprise_sales"
              class="f1 blue3 no-underline underline-hover">
              Enterprise Sales
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/partners/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="become_a_partner" class="f1 blue3 no-underline underline-hover">
              Become a Partner
            </a>
          </li>
        </ul>
        <p class="phone f1 blue3 no-underline underline-hover">
          <p class="tel f1 blue3 no-underline underline-hover">Contact Sales:</p>
          <p><a data-i18n-phonenumber="" class="tel f1 blue3 no-underline underline-hover" href="tel:+18889935273">+1
              (888) 99 FLARE</a></p>

          <noscript><a class="phone f1 blue3 no-underline underline-hover" href="tel:+16503198930">+1 650 319
              8930</a></noscript>
        </p>
      </div>
      <div class="main-footer__menu-group">
        <ul id="getting-started-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="getting-started-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Getting Started
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="plans" class="f1 blue3 no-underline underline-hover">
              Pricing
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/case-studies/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="case_studies" class="f1 blue3 no-underline underline-hover">
              Case Studies
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/resources/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="white_papers" class="f1 blue3 no-underline underline-hover">
              White Papers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/webinars/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover">
              Webinars
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/learning/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="learning_center" class="f1 blue3 no-underline underline-hover">
              Learning Center
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="community-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="community-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Community
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://community.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover">
              Community Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://blog.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="blog" class="f1 blue3 no-underline underline-hover">
              Blog
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/galileo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover">
              Project Galileo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/athenian/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover">
              Athenian Project
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.tv/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="tv" class="f1 blue3 no-underline underline-hover">
              Cloudflare TV
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="developers-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="developers-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Developers
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://developers.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="developer_hub" class="f1 blue3 no-underline underline-hover">
              Developer Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/technical-resources/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="technical_resources"
              class="f1 blue3 no-underline underline-hover">
              Technical Resources
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/products/cloudflare-workers/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="cloudflare_workers"
              class="f1 blue3 no-underline underline-hover">
              Cloudflare Workers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/integrations/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="integrations" class="f1 blue3 no-underline underline-hover">
              Integrations
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="support-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="support-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Support
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://support.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="support" class="f1 blue3 no-underline underline-hover">
              Support
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://www.cloudflarestatus.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="status" class="f1 blue3 no-underline underline-hover">
              Cloudflare Status
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/compliance/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover">
              Compliance
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/gdpr/introduction/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover">
              GDPR
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="company-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="company-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Company
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/about-overview/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover">
              About Cloudflare
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/people/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover">
              Our Team
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/press/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="press" class="f1 blue3 no-underline underline-hover">
              Press
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/analysts/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="analysts" class="f1 blue3 no-underline underline-hover">
              Analysts
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/careers/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="careers" class="f1 blue3 no-underline underline-hover">
              Careers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/internetsummit/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="internet_summit"
              class="f1 blue3 no-underline underline-hover">
              Internet Summit
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/logo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="logo" class="f1 blue3 no-underline underline-hover">
              Logo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/network/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover">
              Network Map
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="mw8 center ph3">
    <div class="flex flex-row flex-wrap justify-between pt4">
      <div class="flex flex-row items-start w-100 w-50-l pb4 pb0-l">
        <a target="_blank" rel="noopener" href="https://www.facebook.com/Cloudflare/" class="w-10"><img
            src="https://cloudflare.com/img/footer/facebook.svg" class="w-60"></a>
        <a target=" _blank" rel="noopener" href="https://twitter.com/Cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/twitter.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.linkedin.com/company/cloudflare-inc-" class="w-10"><img
            src="https://cloudflare.com/img/footer/linkedin.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.youtube.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/youtube.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.instagram.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/instagram.svg" class="w-60"></a>
      </div>
      <div class="w-100 w-50-l tr-l tl-ns">
        <div>
          <span class="main-footer__copyright f1">© 2020 Cloudflare, Inc.</span>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/privacypolicy/"
            class="main-footer__copyright f1 no-underline underline-hover">Privacy
            Policy</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/website-terms/"
            class="main-footer__copyright f1 no-underline underline-hover">Terms of Use</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/abuse/"
            class="main-footer__copyright f1 no-underline underline-hover">Trust &amp; Safety</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/trademark/"
            class="main-footer__copyright f1 no-underline underline-hover">Trademark</a>
        </div>
      </div>
    </div>
  </div>
</footer>    </div>


    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript" src="/assets/built/prism.js?v=fdf4009e30"></script>
<script type="text/javascript">
    var disqus_shortname = 'cloudflare';
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>

<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>


    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PKQFGQB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script>
    var links = document.links;

    for (var i = 0, linksLength = links.length; i < linksLength; i++) {  
       if (links[i].hostname != window.location.hostname) {
           links[i].target = '_blank';
       } 
    } 
</script>

</body>

</html>