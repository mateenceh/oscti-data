<!DOCTYPE html>
<html lang="en">

<head class="sans-serif">

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="baidu-site-verification" content="KeThzeyMOr" />
    <meta name="baidu-site-verification" content="code-NIlrS7gNhx" />

    <title>How to execute an object file: Part 2</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/3.4.1/themes/light.css" />

    <link rel="stylesheet" type="text/css" href="/assets/built/index.css?v=de8f341044" />

    <script type="text/javascript" src="/assets/built/index.js?v=de8f341044"></script>
    <script src="/assets/js/check-for-tex.js" defer></script>

    <meta name="description" content="Continue learning how to import and execute code from an object file. This time we will investigate ELF relocations." />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="canonical" href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="The Cloudflare Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="How to execute an object file: Part 2" />
    <meta property="og:description" content="Continue learning how to import and execute code from an object file. This time we will investigate ELF relocations." />
    <meta property="og:url" content="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/" />
    <meta property="og:image" content="https://blog.cloudflare.com/content/images/2021/03/image1-70.png" />
    <meta property="article:published_time" content="2021-04-02T11:00:00.000Z" />
    <meta property="article:modified_time" content="2021-04-02T11:00:00.000Z" />
    <meta property="article:tag" content="Linux" />
    <meta property="article:tag" content="Compiler" />
    <meta property="article:tag" content="Programming" />
    <meta property="article:tag" content="Software" />
    <meta property="article:tag" content="Deep Dive" />
    
    <meta property="article:publisher" content="https://www.facebook.com/cloudflare" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="How to execute an object file: Part 2" />
    <meta name="twitter:description" content="Continue learning how to import and execute code from an object file. This time we will investigate ELF relocations." />
    <meta name="twitter:url" content="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/" />
    <meta name="twitter:image" content="https://blog.cloudflare.com/content/images/2021/03/image1-69.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ignat Korchagin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Linux, Compiler, Programming, Software, Deep Dive" />
    <meta name="twitter:site" content="@cloudflare" />
    <meta name="twitter:creator" content="@ignatkn" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "The Cloudflare Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg",
            "width": 109,
            "height": 40.5
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ignat Korchagin",
        "image": "https://blog.cloudflare.com/content/images/2018/02/AAEAAQAAAAAAAAepAAAAJGI3NzA4ZDQxLTE1NTYtNDNlNi05M2NjLTE4NDE3ZTE3OWEyZg.jpg",
        "url": "https://blog.cloudflare.com/author/ignat/",
        "sameAs": [
            "https://twitter.com/ignatkn"
        ]
    },
    "headline": "How to execute an object file: Part 2",
    "url": "https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/",
    "datePublished": "2021-04-02T11:00:00.000Z",
    "dateModified": "2021-04-02T11:00:00.000Z",
    "image": "https://blog.cloudflare.com/content/images/2021/03/How-to-execute-an-object-file--Part-2-blog-body-1.png",
    "keywords": "Linux, Compiler, Programming, Software, Deep Dive",
    "description": "Continue learning how to import and execute code from an object file. This time we will investigate ELF relocations.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.cloudflare.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.5" />
    <link rel="alternate" type="application/rss+xml" title="The Cloudflare Blog" href="https://blog.cloudflare.com/rss/" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','cfDataLayer','GTM-PKQFGQB');</script>
<!-- End Google Tag Manager -->

<!-- Google Optimize -->
<script src="https://www.googleoptimize.com/optimize.js?id=GTM-N4JSZJ8"></script>

<meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6" />
<meta class="swiftype" name="language" data-type="string" content="en" />
<!--<script src="/assets/js/index.js"></script>-->
<script type="text/javascript" src="//cdn.bizible.com/scripts/bizible.js" async=""></script>
<script>
var trackRecruitingLink = function(role, url) {
   ga('send', 'event', 'recruiting', 'jobscore-click', role, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script> 
<script type="text/javascript">
	(function() {
		var didInit = false;
		function initMunchkin() {
			if(didInit === false) {
				didInit = true;
				Munchkin.init('713-XSC-918');
			}
		}
		var s = document.createElement('script');
		s.type = 'text/javascript';
		s.async = true;
		s.src = '//munchkin.marketo.net/munchkin.js';
		s.onreadystatechange = function() {
			if (this.readyState == 'complete' || this.readyState == 'loaded') {
				initMunchkin();
			}
		};
		s.onload = initMunchkin;
		document.getElementsByTagName('head')[0].appendChild(s);
		})();
</script>
<script>
var HTMLAttrToAdd = document.querySelector("html");
HTMLAttrToAdd.setAttribute("lang", "en");
</script>
<style>
    table {
        background-color: transparent;
    }
    td {
		padding: 5px 1em;
    }
    pre {
        max-height: 500px;
        overflow-y: scroll;
    }
</style>
<!-- Cloudflare Web Analytics -->
<script
        defer
        src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "f446eacb44504e50864bad7c47ffa9e8"}'></script>
<!-- End Cloudflare Web Analytics -->

</head>

<body id="main-body" class="post-template tag-linux tag-compiler tag-programming tag-software tag-deep-dive sans-serif">

    <div class="site-wrapper">

        <header class="flex flex-row flex-wrap justify-between items-end mw8 center mv3 pl3 pr2">
    <div class="w-100 flex items-end justify-between justify-start-l">
        <div class="w-100 tr">
            <span class="dn di-l">
                <a href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover">Contact Sales:
                </a>
                <a href="tel:+18889935273" class="f1 gray4 no-underline underline-hover">+1 (888) 274-3482</a>
            </span>
        </div>
    </div>
    <div class="w-100 w-50-l flex items-end justify-between justify-start-l">
        <a href="https://blog.cloudflare.com" class="header-logo mr4">
            <img src="https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg" alt="The Cloudflare Blog" class="header-logo" />
        </a>
        <h2 class="mt0 mb1">
            <a href="/" class="fw5 f5 gray3 no-underline">
                <span class="dn di-l">The Cloudflare Blog</span>
            </a>
        </h2>
    </div>
    <div class="w-100 w-50-l dn db-l">
        <div class="w-100 tr mkto-sub-message">
            <p class="f2">Thanks for being here, come back soon. Get notified of new posts:</p>
        </div>
        <div class="w-100 tr">
            <script src="//app-ab13.marketo.com/js/forms2/js/forms2.min.js"></script>
            <div class="marketo-form-container">
                <form id="mktoForm_1653"></form>
            </div>
            <script>
                MktoForms2.loadForm("//app-ab13.marketo.com", "713-XSC-918", 1653, function(form) {
                    document.querySelectorAll('#mktoForm_1653 .mktoEmailField')[0].placeholder = "Email Address";

                    form.onSuccess(function(vals, thanksURL){
                        // Hide form and show success msg
                        document.getElementById("mktoForm_1653").style.display = "none";
                        document.getElementsByClassName("mkto-sub-message")[0].style.display = "none";

                        document.getElementsByClassName("js-form-success-msg")[0].style.display = "block";
                        return false;
                    });
                });
            </script>
        </div>
        <div class="w-100 tr dn js-form-success-msg">
            <p class="f2">Subscription confirmed. Thank you for subscribing!</p>
        </div>
    </div>
</header>

<nav id="nav" class="w-100 bb b--black-10 z-1">
    <div id="desktop-nav-items-container" class="flex flex-row flex-wrap justify-between items-center mw8 center mv3 mv0-l">
        <div class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3" data-tag="product-news">
            <a href="/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="speed-and-reliability">
            <a href="/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="security">
            <a href="/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="serverless">
            <a href="/tag/serverless/" class="no-underline gray1 f2 fw5 pv3">Serverless</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="cloudflare-network">
            <a href="/tag/cloudflare-network/" class="no-underline gray1 f2 fw5 pv3">Cloudflare Network</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="developers">
            <a href="/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="deep-dive">
            <a href="/tag/deep-dive/" class="no-underline gray1 f2 fw5 pv3">Deep Dive</a>
        </div>
        <div class="nav-item nav-item-desktop ml2 mr3 dn db-l pv3" data-tag="life-at-cloudflare">
            <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life @Cloudflare</a>
        </div>
        <a href="/search/"><img src="/assets/images/magnifier.svg?v=de8f341044" class="js-search-box-trigger mw2 pointer ph3 ph2-l" />
        </a>
        <img src="/assets/images/hamburger.svg?v=de8f341044" class="w2 pointer js-mobile-nav-trigger ph3 db dn-l" />
    </div>

    <div class="js-mobile-nav-container dn">
        <div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-100 ph3 z-1">
            <div class="pv3 ph2">
                <a href="/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/security/" class="no-underline gray1 f4 fw7">Security</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/serverless/" class="no-underline gray1 f4 fw7">Serverless</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/cloudflare-network/" class="no-underline gray1 f4 fw7">Cloudflare Network</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/deep-dive/" class="no-underline gray1 f4 fw7">Deep Dive</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life @Cloudflare</a>
            </div>
        </div>
    </div>
</nav>
        


<main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l">
    <article
        class="post-full mw-100 ph3 ph0-l fs-20px post tag-linux tag-compiler tag-programming tag-software tag-deep-dive ">
        <h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">How to execute an object file: Part 2</h1>


        <p class="f3 fw5 gray5 db di-l mt2" localize datetime="2021-04-02T12:00:00+01:00">Loading...</p>
        <noscript>
            <p class="f3 fw5 gray5 db di-l mt2">April 02, 2021 12:00PM</p>
        </noscript>

        <ul class="flex flex-wrap pl0 mt4">
            <li class="list flex items-center ml0 pl0 pb1">
                <a href="/author/ignat/" class="static-avatar pr1">
                    <img class="author-profile-image h2 w2 br-100 mr2" src="/content/images/2018/02/AAEAAQAAAAAAAAepAAAAJGI3NzA4ZDQxLTE1NTYtNDNlNi05M2NjLTE4NDE3ZTE3OWEyZg.jpg" alt="Ignat Korchagin" />
                </a>
                <div class="author-name-tooltip">
                    <a href="/author/ignat" class="fw5 f3 no-underline black mr3">Ignat Korchagin</a>
                </div>
            </li>
        </ul>

        <section class="post-full-content">
            <div class="post-content lh-copy gray1">
                <!--kg-card-begin: markdown--><h2 id="handlingrelocations">Handling relocations</h2>
<p>In the <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-1/">previous post</a>, we learned how to parse an object file and import and execute some functions from it. However, the functions in our toy object file were simple and self-contained: they computed their output solely based on their inputs and didn't have any external code or data dependencies. In this post we will build upon <a href="https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/1">the code from part 1</a>, exploring additional steps needed to handle code with some dependencies.</p>
<p>As an example, we may notice that we can actually rewrite our <code>add10</code> function using our <code>add5</code> function:</p>
<p><em>obj.c</em>:</p>
<pre><code class="language-cpp">int add5(int num)
{
    return num + 5;
}
 
int add10(int num)
{
    num = add5(num);
    return add5(num);
}
</code></pre>
<p>Let's recompile the object file and try to use it as a library with our <code>loader</code> program:</p>
<pre><code class="language-bash">$ gcc -c obj.c
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 42
</code></pre>
<p>Whoa! Something is not right here. <code>add5</code> still produces the correct result, but <code>add10</code> does not . Depending on your environment and code composition, you may even see the <code>loader</code> program crashing instead of outputting incorrect results. To understand what happened, let's investigate the machine code generated by the compiler. We can do that by asking the <a href="https://man7.org/linux/man-pages/man1/objdump.1.html">objdump tool</a> to disassemble the <code>.text</code> section from our <code>obj.o</code>:</p>
<pre><code class="language-bash">$ objdump --disassemble --section=.text obj.o
 
obj.o:     file format elf64-x86-64
 
 
Disassembly of section .text:
 
0000000000000000 &lt;add5&gt;:
   0:	55                   	push   %rbp
   1:	48 89 e5             	mov    %rsp,%rbp
   4:	89 7d fc             	mov    %edi,-0x4(%rbp)
   7:	8b 45 fc             	mov    -0x4(%rbp),%eax
   a:	83 c0 05             	add    $0x5,%eax
   d:	5d                   	pop    %rbp
   e:	c3                   	retq
 
000000000000000f &lt;add10&gt;:
   f:	55                   	push   %rbp
  10:	48 89 e5             	mov    %rsp,%rbp
  13:	48 83 ec 08          	sub    $0x8,%rsp
  17:	89 7d fc             	mov    %edi,-0x4(%rbp)
  1a:	8b 45 fc             	mov    -0x4(%rbp),%eax
  1d:	89 c7                	mov    %eax,%edi
  1f:	e8 00 00 00 00       	callq  24 &lt;add10+0x15&gt;
  24:	89 45 fc             	mov    %eax,-0x4(%rbp)
  27:	8b 45 fc             	mov    -0x4(%rbp),%eax
  2a:	89 c7                	mov    %eax,%edi
  2c:	e8 00 00 00 00       	callq  31 &lt;add10+0x22&gt;
  31:	c9                   	leaveq
  32:	c3                   	retq
</code></pre>
<p>You don't have to understand the full output above. There are only two relevant lines here: <code>1f:	e8 00 00 00 00</code> and <code>2c:	e8 00 00 00 00</code>. These correspond to the two <code>add5</code> function invocations we have in the source code and <a href="https://man7.org/linux/man-pages/man1/objdump.1.html">objdump</a> even conveniently decodes the instruction for us as <code>callq</code>. By looking at descriptions of the <code>callq</code> instruction online (like <a href="https://www.felixcloutier.com/x86/call">this one</a>), we can further see we're dealing with a &quot;near, relative call&quot;, because of the <code>0xe8</code> prefix:</p>
<blockquote>
<p>Call near, relative, displacement relative to next instruction.</p>
</blockquote>
<p>According to the <a href="https://www.felixcloutier.com/x86/call">description</a>, this variant of the <code>callq</code> instruction consists of 5 bytes: the <code>0xe8</code> prefix and a 4-byte (32 bit) argument. This is where &quot;relative&quot; comes from: the argument should contain the “distance” between the function we want to call and the current position — because the way how x86 works this distance is calculated from the next instruction and not our current <code>callq</code> instruction. <a href="https://man7.org/linux/man-pages/man1/objdump.1.html">objdump</a> conveniently outputs each machine instruction's offset in the output above, so we can easily calculate the needed argument. For example, for the first <code>callq</code> instruction (<code>1f:	e8 00 00 00 00</code>) the next instruction is at offset <code>0x24</code>. We know we should be calling the <code>add5</code> function, which starts at offset <code>0x0</code> (beginning of our <code>.text</code> section). So the relative offset is <code>0x0 - 0x24 = -0x24</code>. Notice, we have a negative argument, because the <code>add5</code> function is located before our calling instruction, so we would be instructing the CPU to &quot;jump backwards&quot; from its current position. Lastly, we have to remember that negative numbers — at least on x86 systems — are presented by their <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two's complements</a>, so a 4-byte (32 bit) representation of <code>-0x24</code> would be <code>0xffffffdc</code>. In the same way we can calculate the <code>callq</code> argument for the second <code>add5</code> call: <code>0x0 - 0x31 = -0x31</code>, two's complement - <code>0xffffffcf</code>:</p>
<p><img src="https://blog.cloudflare.com/content/images/2021/03/relative-calls.png" alt="relative-calls"></p>
<p>It seems the compiler does not generate the right <code>callq</code> arguments for us. We've calculated the expected arguments to be <code>0xffffffdc</code> and <code>0xffffffcf</code>, but the compiler has just left <code>0x00000000</code> in both places. Let's check first if our expectations are correct by patching our loaded <code>.text</code> copy before trying to execute it:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
static void parse_obj(void)
{
...
    /* copy the contents of `.text` section from the ELF file */
    memcpy(text_runtime_base, obj.base + text_hdr-&gt;sh_offset, text_hdr-&gt;sh_size);
 
    /* the first add5 callq argument is located at offset 0x20 and should be 0xffffffdc:
     * 0x1f is the instruction offset + 1 byte instruction prefix
     */
    *((uint32_t *)(text_runtime_base + 0x1f + 1)) = 0xffffffdc;
 
    /* the second add5 callq argument is located at offset 0x2d and should be 0xffffffcf */
    *((uint32_t *)(text_runtime_base + 0x2c + 1)) = 0xffffffcf;
 
    /* make the `.text` copy readonly and executable */
    if (mprotect(text_runtime_base, page_align(text_hdr-&gt;sh_size), PROT_READ | PROT_EXEC)) {
...
</code></pre>
<p>And now let's test it out:</p>
<pre><code class="language-bash">$ gcc -o loader loader.c 
$ ./loader 
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
</code></pre>
<p>Clearly our monkey-patching helped: <code>add10</code> executes fine now and produces the correct output. This means our expected <code>callq</code> arguments, which we calculated, are correct. So why did the compiler emit wrong <code>callq</code> arguments?</p>
<h3 id="relocations">Relocations</h3>
<p>The problem with our toy object file is that both functions are declared with external linkage — the default setting for all functions and global variables in C. And, although both functions are declared in the same file, the compiler is not sure where the <code>add5</code> code will end up in the target binary. So the compiler avoids making any assumptions and doesn’t calculate the relative offset argument of the <code>callq</code> instructions. Let's verify this by removing our monkey patching and declaring the <code>add5</code> function as <code>static</code>:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
    /* the first add5 callq argument is located at offset 0x20 and should be 0xffffffdc:
     * 0x1f is the instruction offset + 1 byte instruction prefix
     */
    /* *((uint32_t *)(text_runtime_base + 0x1f + 1)) = 0xffffffdc; */
 
    /* the second add5 callq argument is located at offset 0x2d and should be 0xffffffcf */
    /* *((uint32_t *)(text_runtime_base + 0x2c + 1)) = 0xffffffcf; */
 
...
</code></pre>
<p><em>obj.c</em>:</p>
<pre><code class="language-cpp">/* int add5(int num) */
static int add5(int num)
...
</code></pre>
<p>Recompiling and disassembling <code>obj.o</code> gives us the following:</p>
<pre><code class="language-bash">$ gcc -c obj.c
$ objdump --disassemble --section=.text obj.o
 
obj.o:     file format elf64-x86-64
 
 
Disassembly of section .text:
 
0000000000000000 &lt;add5&gt;:
   0:	55                   	push   %rbp
   1:	48 89 e5             	mov    %rsp,%rbp
   4:	89 7d fc             	mov    %edi,-0x4(%rbp)
   7:	8b 45 fc             	mov    -0x4(%rbp),%eax
   a:	83 c0 05             	add    $0x5,%eax
   d:	5d                   	pop    %rbp
   e:	c3                   	retq
 
000000000000000f &lt;add10&gt;:
   f:	55                   	push   %rbp
  10:	48 89 e5             	mov    %rsp,%rbp
  13:	48 83 ec 08          	sub    $0x8,%rsp
  17:	89 7d fc             	mov    %edi,-0x4(%rbp)
  1a:	8b 45 fc             	mov    -0x4(%rbp),%eax
  1d:	89 c7                	mov    %eax,%edi
  1f:	e8 dc ff ff ff       	callq  0 &lt;add5&gt;
  24:	89 45 fc             	mov    %eax,-0x4(%rbp)
  27:	8b 45 fc             	mov    -0x4(%rbp),%eax
  2a:	89 c7                	mov    %eax,%edi
  2c:	e8 cf ff ff ff       	callq  0 &lt;add5&gt;
  31:	c9                   	leaveq
  32:	c3                   	retq
</code></pre>
<p>Because we re-declared the <code>add5</code> function with internal linkage, the compiler is more confident now and calculates <code>callq</code> arguments correctly (note that x86 systems are <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a>, so multibyte numbers like <code>0xffffffdc</code> will be represented with least significant byte first). We can double check this by recompiling and running our <code>loader</code> test tool:</p>
<pre><code class="language-bash">$ gcc -o loader loader.c
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
</code></pre>
<p>Even though the <code>add5</code> function is declared as <code>static</code>, we can still call it from the <code>loader</code> tool, basically ignoring the fact that it is an &quot;internal&quot; function now. Because of this, the <code>static</code> keyword should not be used as a security feature to hide APIs from potential malicious users.</p>
<p>But let's step back and revert our <code>add5</code> function in <code>obj.c</code> to the one with external linkage:</p>
<p><em>obj.c</em>:</p>
<pre><code class="language-cpp">int add5(int num)
...
</code></pre>
<pre><code class="language-bash">$ gcc -c obj.c
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 42
</code></pre>
<p>As we have established above, the compiler did not compute proper <code>callq</code> arguments for us because it didn't have enough information. But later stages (namely the linker) will have that information, so instead the compiler leaves some clues on how to fix those arguments. These clues — or instructions for the later stages — are called <strong>relocations</strong>. We can inspect them with our friend, the <a href="https://man7.org/linux/man-pages/man1/readelf.1.html">readelf</a> utility. Let's examine <code>obj.o</code> sections table again:</p>
<pre><code class="language-bash">$ readelf --sections obj.o
There are 12 section headers, starting at offset 0x2b0:
 
Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       0000000000000033  0000000000000000  AX       0     0     1
  [ 2] .rela.text        RELA             0000000000000000  000001f0
       0000000000000030  0000000000000018   I       9     1     8
  [ 3] .data             PROGBITS         0000000000000000  00000073
       0000000000000000  0000000000000000  WA       0     0     1
  [ 4] .bss              NOBITS           0000000000000000  00000073
       0000000000000000  0000000000000000  WA       0     0     1
  [ 5] .comment          PROGBITS         0000000000000000  00000073
       000000000000001d  0000000000000001  MS       0     0     1
  [ 6] .note.GNU-stack   PROGBITS         0000000000000000  00000090
       0000000000000000  0000000000000000           0     0     1
  [ 7] .eh_frame         PROGBITS         0000000000000000  00000090
       0000000000000058  0000000000000000   A       0     0     8
  [ 8] .rela.eh_frame    RELA             0000000000000000  00000220
       0000000000000030  0000000000000018   I       9     7     8
  [ 9] .symtab           SYMTAB           0000000000000000  000000e8
       00000000000000f0  0000000000000018          10     8     8
  [10] .strtab           STRTAB           0000000000000000  000001d8
       0000000000000012  0000000000000000           0     0     1
  [11] .shstrtab         STRTAB           0000000000000000  00000250
       0000000000000059  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)
</code></pre>
<p>We see that the compiler created a new section called <code>.rela.text</code>. By convention, a section with relocations for a section named <code>.foo</code> will be called <code>.rela.foo</code>, so we can see that the compiler created a section with relocations for the <code>.text</code> section. We can examine the relocations further:</p>
<pre><code class="language-bash">$ readelf --relocs obj.o
 
Relocation section '.rela.text' at offset 0x1f0 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000800000004 R_X86_64_PLT32    0000000000000000 add5 - 4
00000000002d  000800000004 R_X86_64_PLT32    0000000000000000 add5 - 4
 
Relocation section '.rela.eh_frame' at offset 0x220 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0
000000000040  000200000002 R_X86_64_PC32     0000000000000000 .text + f
</code></pre>
<p>Let's ignore the relocations from the <code>.rela.eh_frame</code> section because they are out of scope of this post. Instead, let’s try to understand the relocations from the <code>.rela.text</code>:</p>
<ul>
<li><code>Offset</code> column tells us exactly where in the target section (<code>.text</code> in this case) the fix/adjustment is needed. Note that these offsets are exactly the same as in our self-calculated monkey-patching above.</li>
<li><code>Info</code> is a combined value: the upper 32 bits — only 16 bits are shown in the output above — represent the index of the symbol in the symbol table, with respect to which the relocation is performed. In our example it is <code>8</code> and if we run <code>readelf --symbols obj.o</code> we will see that it points to an entry corresponding to the <code>add5</code> function. The lower 32 bits (<code>4</code> in our case) is a relocation type (see <code>Type</code> below).</li>
<li><code>Type</code> describes the relocation type. This is a pseudo-column: <code>readelf</code> actually generates it from the lower 32 bits of the <code>Info</code> field. Different relocation types have different formulas we need to apply to perform the relocation.</li>
<li><code>Sym. Value</code> may mean different things depending on the relocation type, but most of the time it is the symbol offset with respect to which we perform the relocation. The offset is calculated from the beginning of that symbol’s section.</li>
<li><code>Addend</code> is a constant we may need to use in the relocation formula. Depending on the relocation type, <a href="https://man7.org/linux/man-pages/man1/readelf.1.html">readelf</a> actually adds the decoded symbol name to the output, so the column name is <code>Sym. Name + Addend</code> above but the actual field stores the addend only.</li>
</ul>
<p>In a nutshell, these entries tell us that we need to patch the <code>.text</code> section at offsets <code>0x20</code> and <code>0x2d</code>. To calculate what to put there, we need to apply the formula for the <code>R_X86_64_PLT32</code> relocation type. Searching online, we can find different ELF specifications — like <a href="https://refspecs.linuxfoundation.org/elf/x86_64-abi-0.95.pdf">this one</a> — which will tell us how to implement the <code>R_X86_64_PLT32</code> relocation. The specification mentions that the result of this relocation is <code>word32</code> — which is what we expect because <code>callq</code> arguments are 32 bit in our case — and the formula we need to apply is <code>L + A - P</code>, where:</p>
<ul>
<li><code>L</code> is the address of the symbol, with respect to which the relocation is performed (<code>add5</code> in our case)</li>
<li><code>A</code> is the constant addend (<code>4</code> in our case)</li>
<li><code>P</code> is the address/offset, where we store the result of the relocation</li>
</ul>
<p>When the relocation formula references some symbol addresses or offsets, we should use the actual — runtime in our case — addresses in the calculations. For example, we will be using <code>text_runtime_base + 0x2d</code> as <code>P</code> for the second relocation and not just <code>0x2d</code>. So let's try to implement this relocation logic in our object loader:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
/* from https://elixir.bootlin.com/linux/v5.11.6/source/arch/x86/include/asm/elf.h#L51 */
#define R_X86_64_PLT32 4
 
...
 
static uint8_t *section_runtime_base(const Elf64_Shdr *section)
{
    const char *section_name = shstrtab + section-&gt;sh_name;
    size_t section_name_len = strlen(section_name);
 
    /* we only mmap .text section so far */
    if (strlen(&quot;.text&quot;) == section_name_len &amp;&amp; !strcmp(&quot;.text&quot;, section_name))
        return text_runtime_base;
 
    fprintf(stderr, &quot;No runtime base address for section %s\n&quot;, section_name);
    exit(ENOENT);
}
 
static void do_text_relocations(void)
{
    /* we actually cheat here - the name .rela.text is a convention, but not a
     * rule: to figure out which section should be patched by these relocations
     * we would need to examine the rela_text_hdr, but we skip it for simplicity
     */
    const Elf64_Shdr *rela_text_hdr = lookup_section(&quot;.rela.text&quot;);
    if (!rela_text_hdr) {
        fputs(&quot;Failed to find .rela.text\n&quot;, stderr);
        exit(ENOEXEC);
    }
 
    int num_relocations = rela_text_hdr-&gt;sh_size / rela_text_hdr-&gt;sh_entsize;
    const Elf64_Rela *relocations = (Elf64_Rela *)(obj.base + rela_text_hdr-&gt;sh_offset);
 
    for (int i = 0; i &lt; num_relocations; i++) {
        int symbol_idx = ELF64_R_SYM(relocations[i].r_info);
        int type = ELF64_R_TYPE(relocations[i].r_info);
 
        /* where to patch .text */
        uint8_t *patch_offset = text_runtime_base + relocations[i].r_offset;
        /* symbol, with respect to which the relocation is performed */
        uint8_t *symbol_address = section_runtime_base(&amp;sections[symbols[symbol_idx].st_shndx]) + symbols[symbol_idx].st_value;
 
        switch (type)
        {
        case R_X86_64_PLT32:
            /* L + A - P, 32 bit output */
            *((uint32_t *)patch_offset) = symbol_address + relocations[i].r_addend - patch_offset;
            printf(&quot;Calculated relocation: 0x%08x\n&quot;, *((uint32_t *)patch_offset));
            break;
        }
    }
}
 
static void parse_obj(void)
{
...
 
    /* copy the contents of `.text` section from the ELF file */
    memcpy(text_runtime_base, obj.base + text_hdr-&gt;sh_offset, text_hdr-&gt;sh_size);
 
    do_text_relocations();
 
    /* make the `.text` copy readonly and executable */
    if (mprotect(text_runtime_base, page_align(text_hdr-&gt;sh_size), PROT_READ | PROT_EXEC)) {
 
...
}
 
...
</code></pre>
<p>We are now calling the <code>do_text_relocations</code> function before marking our <code>.text</code> copy executable. We have also added some debugging output to inspect the result of the relocation calculations. Let's try it out:</p>
<pre><code class="language-bash">$ gcc -o loader loader.c 
$ ./loader 
Calculated relocation: 0xffffffdc
Calculated relocation: 0xffffffcf
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
</code></pre>
<p>Great! Our imported code works as expected now. By following the relocation hints left for us by the compiler, we've got the same results as in our monkey-patching calculations in the beginning of this post. Our relocation calculations also involved <code>text_runtime_base</code> address, which is not available at compile time. That's why the compiler could not calculate the <code>callq</code> arguments in the first place and had to emit the relocations instead.</p>
<h3 id="handlingconstantdataandglobalvariables">Handling constant data and global variables</h3>
<p>So far, we have been dealing with object files containing only executable code with no state. That is, the imported functions could compute their output solely based on the inputs. Let's see what happens if we add some constant data and global variables dependencies to our imported code. First, we add some more functions to our <code>obj.o</code>:</p>
<p><em>obj.c</em>:</p>
<pre><code class="language-cpp">...
 
const char *get_hello(void)
{
    return &quot;Hello, world!&quot;;
}
 
static int var = 5;
 
int get_var(void)
{
    return var;
}
 
void set_var(int num)
{
    var = num;
}
</code></pre>
<p><code>get_hello</code> returns a constant string and <code>get_var</code>/<code>set_var</code> get and set a global variable respectively. Next, let's recompile the <code>obj.o</code> and run our loader:</p>
<pre><code class="language-bash">$ gcc -c obj.c
$ ./loader 
Calculated relocation: 0xffffffdc
Calculated relocation: 0xffffffcf
No runtime base address for section .rodata
</code></pre>
<p>Looks like our loader tried to process more relocations but could not find the runtime address for <code>.rodata</code> section. Previously, we didn't even have a <code>.rodata</code> section, but it was added now because our <code>obj.o</code> needs somewhere to store the constant string <code>Hello, world!:</code></p>
<pre><code class="language-bash">$ readelf --sections obj.o
There are 13 section headers, starting at offset 0x478:
 
Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       000000000000005f  0000000000000000  AX       0     0     1
  [ 2] .rela.text        RELA             0000000000000000  00000320
       0000000000000078  0000000000000018   I      10     1     8
  [ 3] .data             PROGBITS         0000000000000000  000000a0
       0000000000000004  0000000000000000  WA       0     0     4
  [ 4] .bss              NOBITS           0000000000000000  000000a4
       0000000000000000  0000000000000000  WA       0     0     1
  [ 5] .rodata           PROGBITS         0000000000000000  000000a4
       000000000000000d  0000000000000000   A       0     0     1
  [ 6] .comment          PROGBITS         0000000000000000  000000b1
       000000000000001d  0000000000000001  MS       0     0     1
  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  000000ce
       0000000000000000  0000000000000000           0     0     1
  [ 8] .eh_frame         PROGBITS         0000000000000000  000000d0
       00000000000000b8  0000000000000000   A       0     0     8
  [ 9] .rela.eh_frame    RELA             0000000000000000  00000398
       0000000000000078  0000000000000018   I      10     8     8
  [10] .symtab           SYMTAB           0000000000000000  00000188
       0000000000000168  0000000000000018          11    10     8
  [11] .strtab           STRTAB           0000000000000000  000002f0
       000000000000002c  0000000000000000           0     0     1
  [12] .shstrtab         STRTAB           0000000000000000  00000410
       0000000000000061  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)
</code></pre>
<p>We also have more <code>.text</code> relocations:</p>
<pre><code class="language-bash">$ readelf --relocs obj.o
 
Relocation section '.rela.text' at offset 0x320 contains 5 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000a00000004 R_X86_64_PLT32    0000000000000000 add5 - 4
00000000002d  000a00000004 R_X86_64_PLT32    0000000000000000 add5 - 4
00000000003a  000500000002 R_X86_64_PC32     0000000000000000 .rodata - 4
000000000046  000300000002 R_X86_64_PC32     0000000000000000 .data - 4
000000000058  000300000002 R_X86_64_PC32     0000000000000000 .data - 4
...
</code></pre>
<p>The compiler emitted three more <code>R_X86_64_PC32</code> relocations this time. They reference symbols with index <code>3</code> and <code>5</code>, so let's find out what they are:</p>
<pre><code class="language-bash">$ readelf --symbols obj.o
 
Symbol table '.symtab' contains 15 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS obj.c
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     4 OBJECT  LOCAL  DEFAULT    3 var
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
    10: 0000000000000000    15 FUNC    GLOBAL DEFAULT    1 add5
    11: 000000000000000f    36 FUNC    GLOBAL DEFAULT    1 add10
    12: 0000000000000033    13 FUNC    GLOBAL DEFAULT    1 get_hello
    13: 0000000000000040    12 FUNC    GLOBAL DEFAULT    1 get_var
    14: 000000000000004c    19 FUNC    GLOBAL DEFAULT    1 set_var
</code></pre>
<p>Entries <code>3</code> and <code>5</code> don't have any names attached, but they reference something in sections with index <code>3</code> and <code>5</code> respectively. In the output of the section table above, we can see that the section with index <code>3</code> is <code>.data</code> and the section with index <code>5</code> is <code>.rodata</code>. For a refresher on the most common sections in an ELF file check out our <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-1/">previous post</a>. To import our newly added code and make it work, we also need to map <code>.data</code> and <code>.rodata</code> sections in addition to the <code>.text</code> section and process these <code>R_X86_64_PC32</code> relocations.</p>
<p>There is one caveat though. If we check <a href="https://refspecs.linuxfoundation.org/elf/x86_64-abi-0.95.pdf">the specification</a>, we'll see that <code>R_X86_64_PC32</code> relocation produces a 32-bit output similar to the <code>R_X86_64_PLT32</code> relocation. This means that the &quot;distance&quot; in memory between the patched position in <code>.text</code> and the referenced symbol has to be small enough to fit into a 32-bit value (1 bit for the positive/negative sign and 31 bits for the actual data, so less than 2147483647 bytes). Our <code>loader</code> program uses <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap system call</a> to allocate memory for the object section copies, but <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> may allocate the mapping almost anywhere in the process address space. If we modify the <code>loader</code> program to call <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> for each section separately, we may end up having <code>.rodata</code> or <code>.data</code> section mapped too far away from the <code>.text</code> section and will not be able to process the <code>R_X86_64_PC32</code> relocations. In other words, we need to ensure that <code>.data</code> and <code>.rodata</code> sections are located relatively close to the <code>.text</code> section at runtime:</p>
<p><img src="https://blog.cloudflare.com/content/images/2021/03/runtime-diff.png" alt="runtime-diff"></p>
<p>One way to achieve that would be to allocate the memory we need for all the sections with one <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap call</a>. Then, we’d break it in chunks and assign proper access permissions to each chunk. Let's modify our <code>loader</code> program to do just that:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
/* runtime base address of the imported code */
static uint8_t *text_runtime_base;
/* runtime base of the .data section */
static uint8_t *data_runtime_base;
/* runtime base of the .rodata section */
static uint8_t *rodata_runtime_base;
 
...
 
static void parse_obj(void)
{
...
 
    /* find the `.text` entry in the sections table */
    const Elf64_Shdr *text_hdr = lookup_section(&quot;.text&quot;);
    if (!text_hdr) {
        fputs(&quot;Failed to find .text\n&quot;, stderr);
        exit(ENOEXEC);
    }
 
    /* find the `.data` entry in the sections table */
    const Elf64_Shdr *data_hdr = lookup_section(&quot;.data&quot;);
    if (!data_hdr) {
        fputs(&quot;Failed to find .data\n&quot;, stderr);
        exit(ENOEXEC);
    }
 
    /* find the `.rodata` entry in the sections table */
    const Elf64_Shdr *rodata_hdr = lookup_section(&quot;.rodata&quot;);
    if (!rodata_hdr) {
        fputs(&quot;Failed to find .rodata\n&quot;, stderr);
        exit(ENOEXEC);
    }
 
    /* allocate memory for `.text`, `.data` and `.rodata` copies rounding up each section to whole pages */
    text_runtime_base = mmap(NULL, page_align(text_hdr-&gt;sh_size) + page_align(data_hdr-&gt;sh_size) + page_align(rodata_hdr-&gt;sh_size), PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if (text_runtime_base == MAP_FAILED) {
        perror(&quot;Failed to allocate memory&quot;);
        exit(errno);
    }
 
    /* .data will come right after .text */
    data_runtime_base = text_runtime_base + page_align(text_hdr-&gt;sh_size);
    /* .rodata will come after .data */
    rodata_runtime_base = data_runtime_base + page_align(data_hdr-&gt;sh_size);
 
    /* copy the contents of `.text` section from the ELF file */
    memcpy(text_runtime_base, obj.base + text_hdr-&gt;sh_offset, text_hdr-&gt;sh_size);
    /* copy .data */
    memcpy(data_runtime_base, obj.base + data_hdr-&gt;sh_offset, data_hdr-&gt;sh_size);
    /* copy .rodata */
    memcpy(rodata_runtime_base, obj.base + rodata_hdr-&gt;sh_offset, rodata_hdr-&gt;sh_size);
 
    do_text_relocations();
 
    /* make the `.text` copy readonly and executable */
    if (mprotect(text_runtime_base, page_align(text_hdr-&gt;sh_size), PROT_READ | PROT_EXEC)) {
        perror(&quot;Failed to make .text executable&quot;);
        exit(errno);
    }
 
    /* we don't need to do anything with .data - it should remain read/write */
 
    /* make the `.rodata` copy readonly */
    if (mprotect(rodata_runtime_base, page_align(rodata_hdr-&gt;sh_size), PROT_READ)) {
        perror(&quot;Failed to make .rodata readonly&quot;);
        exit(errno);
    }
}
 
...
</code></pre>
<p>Now that we have runtime addresses of <code>.data</code> and <code>.rodata</code>, we can update the relocation runtime address lookup function:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
static uint8_t *section_runtime_base(const Elf64_Shdr *section)
{
    const char *section_name = shstrtab + section-&gt;sh_name;
    size_t section_name_len = strlen(section_name);
 
    if (strlen(&quot;.text&quot;) == section_name_len &amp;&amp; !strcmp(&quot;.text&quot;, section_name))
        return text_runtime_base;
 
    if (strlen(&quot;.data&quot;) == section_name_len &amp;&amp; !strcmp(&quot;.data&quot;, section_name))
        return data_runtime_base;
 
    if (strlen(&quot;.rodata&quot;) == section_name_len &amp;&amp; !strcmp(&quot;.rodata&quot;, section_name))
        return rodata_runtime_base;
 
    fprintf(stderr, &quot;No runtime base address for section %s\n&quot;, section_name);
    exit(ENOENT);
}
</code></pre>
<p>And finally we can import and execute our new functions:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
static void execute_funcs(void)
{
    /* pointers to imported functions */
    int (*add5)(int);
    int (*add10)(int);
    const char *(*get_hello)(void);
    int (*get_var)(void);
    void (*set_var)(int num);
 
...
 
    printf(&quot;add10(%d) = %d\n&quot;, 42, add10(42));
 
    get_hello = lookup_function(&quot;get_hello&quot;);
    if (!get_hello) {
        fputs(&quot;Failed to find get_hello function\n&quot;, stderr);
        exit(ENOENT);
    }
 
    puts(&quot;Executing get_hello...&quot;);
    printf(&quot;get_hello() = %s\n&quot;, get_hello());
 
    get_var = lookup_function(&quot;get_var&quot;);
    if (!get_var) {
        fputs(&quot;Failed to find get_var function\n&quot;, stderr);
        exit(ENOENT);
    }
 
    puts(&quot;Executing get_var...&quot;);
    printf(&quot;get_var() = %d\n&quot;, get_var());
 
    set_var = lookup_function(&quot;set_var&quot;);
    if (!set_var) {
        fputs(&quot;Failed to find set_var function\n&quot;, stderr);
        exit(ENOENT);
    }
 
    puts(&quot;Executing set_var(42)...&quot;);
    set_var(42);
 
    puts(&quot;Executing get_var again...&quot;);
    printf(&quot;get_var() = %d\n&quot;, get_var());
}
...
</code></pre>
<p>Let's try it out:</p>
<pre><code class="language-bash">$ gcc -o loader loader.c 
$ ./loader 
Calculated relocation: 0xffffffdc
Calculated relocation: 0xffffffcf
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
Executing get_hello...
get_hello() = ]�UH��
Executing get_var...
get_var() = 1213580125
Executing set_var(42)...
Segmentation fault
</code></pre>
<p>Uh-oh! We forgot to implement the new <code>R_X86_64_PC32</code> relocation type. The <a href="https://refspecs.linuxfoundation.org/elf/x86_64-abi-0.95.pdf">relocation formula</a> here is <code>S + A - P</code>. We already know about <code>A</code> and <code>P</code>. As for <code>S</code> (quoting from <a href="https://refspecs.linuxfoundation.org/elf/x86_64-abi-0.95.pdf">the spec</a>):</p>
<blockquote>
<p>“the value of the symbol whose index resides in the relocation entry&quot;</p>
</blockquote>
<p>In our case, it is essentially the same as <code>L</code> for <code>R_X86_64_PLT32</code>. We can just reuse the implementation and remove the debug output in the process:</p>
<p><em>loader.c</em>:</p>
<pre><code class="language-cpp">...
 
/* from https://elixir.bootlin.com/linux/v5.11.6/source/arch/x86/include/asm/elf.h#L51 */
#define R_X86_64_PC32 2
#define R_X86_64_PLT32 4
 
...
 
static void do_text_relocations(void)
{
    /* we actually cheat here - the name .rela.text is a convention, but not a
     * rule: to figure out which section should be patched by these relocations
     * we would need to examine the rela_text_hdr, but we skip it for simplicity
     */
    const Elf64_Shdr *rela_text_hdr = lookup_section(&quot;.rela.text&quot;);
    if (!rela_text_hdr) {
        fputs(&quot;Failed to find .rela.text\n&quot;, stderr);
        exit(ENOEXEC);
    }
 
    int num_relocations = rela_text_hdr-&gt;sh_size / rela_text_hdr-&gt;sh_entsize;
    const Elf64_Rela *relocations = (Elf64_Rela *)(obj.base + rela_text_hdr-&gt;sh_offset);
 
    for (int i = 0; i &lt; num_relocations; i++) {
        int symbol_idx = ELF64_R_SYM(relocations[i].r_info);
        int type = ELF64_R_TYPE(relocations[i].r_info);
 
        /* where to patch .text */
        uint8_t *patch_offset = text_runtime_base + relocations[i].r_offset;
        /* symbol, with respect to which the relocation is performed */
        uint8_t *symbol_address = section_runtime_base(&amp;sections[symbols[symbol_idx].st_shndx]) + symbols[symbol_idx].st_value;
 
        switch (type)
        {
        case R_X86_64_PC32:
            /* S + A - P, 32 bit output, S == L here */
        case R_X86_64_PLT32:
            /* L + A - P, 32 bit output */
            *((uint32_t *)patch_offset) = symbol_address + relocations[i].r_addend - patch_offset;
            break;
        }
    }
}
 
...
</code></pre>
<p>Now we should be done. Another try:</p>
<pre><code class="language-bash">$ gcc -o loader loader.c 
$ ./loader 
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
Executing get_hello...
get_hello() = Hello, world!
Executing get_var...
get_var() = 5
Executing set_var(42)...
Executing get_var again...
get_var() = 42
</code></pre>
<p>This time we can successfully import functions that reference static constant data and global variables. We can even manipulate the object file’s internal state through the defined accessor interface. As before, the complete source code for this post is <a href="https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/2">available on GitHub</a>.</p>
<p>In the next post, we will look into importing and executing object code with references to external libraries. Stay tuned!</p>
<!--kg-card-end: markdown-->
            </div>
        </section>

        <a href="/tag/linux/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Linux</a>
        <a href="/tag/compiler/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Compiler</a>
        <a href="/tag/programming/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Programming</a>
        <a href="/tag/software/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Software</a>
        <a href="/tag/deep-dive/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Deep Dive</a>
    </article>
</main>

<div class="pv4 ph3 mw7 center" id="social-buttons">
    <h2>Comments</h2>
    <div class="mt5-l mt4 flex flex-row-ns flex-column flex-wrap">
        <a id="social-button-twitter" title="Discuss on Twitter" href="https://twitter.com/Cloudflare" target="_blank" class="mr2-ns mb0-l white link b pv3 ph3 mb3 dn" style="background-color:#0055DC;">
            <span>Discuss on Twitter</span>
        </a>
        <a id="social-button-hn" title="Discuss on Hacker News" href="https://hn.algolia.com/?dateRange=all&page=0&prefix=false&query=blog.cloudflare.com&sort=byDate&type=story" target="_blank" class="mr2-ns mb0-l white link b pv3 ph3 mb3 dn" style="background-color:#0055DC;">
            <span>Discuss on Hacker News</span>
        </a>
        <a id="social-button-reddit" title="Discuss on Reddit" href="https://www.reddit.com/r/CloudFlare/" target="_blank" class="mr2-ns mb0-l white link b pv3 ph3 mb3 dn" style="background-color:#0055DC;">
            <span>Discuss on Reddit</span>
        </a>
    </div>
</div>

<div class="pv4 flex flex-row flex-wrap mw7 center">
    <div class="w-100 ph3 bt b--gray8">
        <p class="orange fw5 f4 mt4 ttu">Related Posts</p>
    </div>

    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2021-03-02T12:00:00Z">March 02, 2021 12:00PM</p>
        <a href="/how-to-execute-an-object-file-part-1/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">How to execute an object file: Part 1</h2>
        </a>

        <p class="gray1 lh-copy">Ever wondered if it is possible to execute an object file without linking? Or use any object file as a library? Follow along to learn how to decompose an object file and import code from it along the way....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/ignat/" class="fw5 f2 black no-underline">Ignat Korchagin</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/compiler/" class="no-underline f1 fw2 blue3 underline-hover">Compiler</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/programming/" class="no-underline f1 fw2 blue3 underline-hover">Programming</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/software/" class="no-underline f1 fw2 blue3 underline-hover">Software</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2020-07-08T12:00:00+01:00">July 08, 2020 12:00PM</p>
        <a href="/sandboxing-in-linux-with-zero-lines-of-code/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Sandboxing in Linux with zero lines of code</h2>
        </a>

        <p class="gray1 lh-copy">In this post we will review Linux seccomp and learn how to sandbox any (even a proprietary) application without writing a single line of code....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/ignat/" class="fw5 f2 black no-underline">Ignat Korchagin</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/security/" class="no-underline f1 fw2 blue3 underline-hover">Security</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2020-03-25T12:00:00Z">March 25, 2020 12:00PM</p>
        <a href="/speeding-up-linux-disk-encryption/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Speeding up Linux disk encryption</h2>
        </a>

        <p class="gray1 lh-copy">Encrypting data at rest is vital for Cloudflare with more than 200 data centres across the world. In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!...</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/ignat/" class="fw5 f2 black no-underline">Ignat Korchagin</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/kernel/" class="no-underline f1 fw2 blue3 underline-hover">Kernel</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/crypto/" class="no-underline f1 fw2 blue3 underline-hover">Crypto</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/performance/" class="no-underline f1 fw2 blue3 underline-hover">Performance</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/security/" class="no-underline f1 fw2 blue3 underline-hover">Security</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2019-07-10T14:07:21+01:00">July 10, 2019 2:07PM</p>
        <a href="/a-gentle-introduction-to-linux-kernel-fuzzing/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">A gentle introduction to Linux Kernel fuzzing</h2>
        </a>

        <p class="gray1 lh-copy">For some time I’ve wanted to play with coverage-guided fuzzing. I decided to have a go at the Linux Kernel netlink machinery.  It's a good target: it's an obscure part of kernel, and it's relatively easy to automatically craft valid messages....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/marek-majkowski/" class="fw5 f2 black no-underline">Marek Majkowski</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/kernel/" class="no-underline f1 fw2 blue3 underline-hover">Kernel</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive</a>
        </div>
    </article>

</div>




        <footer class="pt4 pb4 pl1 pr1 main-footer">
  <div class="mw8 center dn db-l ph3">
    <div class="flex flex-row justify-between">
      <div class="main-footer__menu-group">
        <ul id="sales-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="sales-menu"
            class="main-footer__menu-group__header js-toggle-footer-group f1">
            Sales
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/enterprise/contact/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="enterprise_sales"
              class="f1 blue3 no-underline underline-hover">
              Enterprise Sales
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/partners/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="become_a_partner" class="f1 blue3 no-underline underline-hover">
              Become a Partner
            </a>
          </li>
        </ul>
        <p class="phone f1 blue3 no-underline underline-hover">
          <p class="tel f1 blue3 no-underline underline-hover">Contact Sales:</p>
          <p><a data-i18n-phonenumber="" class="tel f1 blue3 no-underline underline-hover" href="tel:+18889935273">+1
              (888) 99 FLARE</a></p>

          <noscript><a class="phone f1 blue3 no-underline underline-hover" href="tel:+16503198930">+1 650 319
              8930</a></noscript>
        </p>
      </div>
      <div class="main-footer__menu-group">
        <ul id="getting-started-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="getting-started-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Getting Started
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="plans" class="f1 blue3 no-underline underline-hover">
              Pricing
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/case-studies/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="case_studies" class="f1 blue3 no-underline underline-hover">
              Case Studies
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/resources/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="white_papers" class="f1 blue3 no-underline underline-hover">
              White Papers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/webinars/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover">
              Webinars
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/learning/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="learning_center" class="f1 blue3 no-underline underline-hover">
              Learning Center
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="community-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="community-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Community
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://community.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover">
              Community Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://blog.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="blog" class="f1 blue3 no-underline underline-hover">
              Blog
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/galileo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover">
              Project Galileo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/athenian/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover">
              Athenian Project
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.tv/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="tv" class="f1 blue3 no-underline underline-hover">
              Cloudflare TV
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="developers-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="developers-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Developers
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://developers.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="developer_hub" class="f1 blue3 no-underline underline-hover">
              Developer Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/technical-resources/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="technical_resources"
              class="f1 blue3 no-underline underline-hover">
              Technical Resources
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/products/cloudflare-workers/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="cloudflare_workers"
              class="f1 blue3 no-underline underline-hover">
              Cloudflare Workers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/integrations/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="integrations" class="f1 blue3 no-underline underline-hover">
              Integrations
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="support-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="support-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Support
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://support.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="support" class="f1 blue3 no-underline underline-hover">
              Support
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://www.cloudflarestatus.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="status" class="f1 blue3 no-underline underline-hover">
              Cloudflare Status
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/compliance/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover">
              Compliance
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/gdpr/introduction/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover">
              GDPR
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="company-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="company-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Company
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/about-overview/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover">
              About Cloudflare
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/people/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover">
              Our Team
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/press/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="press" class="f1 blue3 no-underline underline-hover">
              Press
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/analysts/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="analysts" class="f1 blue3 no-underline underline-hover">
              Analysts
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/careers/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="careers" class="f1 blue3 no-underline underline-hover">
              Careers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/internetsummit/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="internet_summit"
              class="f1 blue3 no-underline underline-hover">
              Internet Summit
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/logo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="logo" class="f1 blue3 no-underline underline-hover">
              Logo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/network/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover">
              Network Map
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="mw8 center ph3">
    <div class="flex flex-row flex-wrap justify-between pt4">
      <div class="flex flex-row items-start w-100 w-50-l pb4 pb0-l">
        <a target="_blank" rel="noopener" href="https://www.facebook.com/Cloudflare/" class="w-10"><img
            src="https://cloudflare.com/img/footer/facebook.svg" class="w-60"></a>
        <a target=" _blank" rel="noopener" href="https://twitter.com/Cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/twitter.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.linkedin.com/company/cloudflare-inc-" class="w-10"><img
            src="https://cloudflare.com/img/footer/linkedin.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.youtube.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/youtube.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.instagram.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/instagram.svg" class="w-60"></a>
      </div>
      <div class="w-100 w-50-l tr-l tl-ns">
        <div>
          <span class="main-footer__copyright f1">© 2020 Cloudflare, Inc.</span>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/privacypolicy/"
            class="main-footer__copyright f1 no-underline underline-hover">Privacy
            Policy</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/website-terms/"
            class="main-footer__copyright f1 no-underline underline-hover">Terms of Use</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/abuse/"
            class="main-footer__copyright f1 no-underline underline-hover">Trust &amp; Safety</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/trademark/"
            class="main-footer__copyright f1 no-underline underline-hover">Trademark</a>
        </div>
      </div>
    </div>
  </div>
</footer>    </div>


    <script type="text/javascript">
    (function () {
        // Social media, make request to worker
        var urlObj = new URL(window.location.href);
        var currenturl = urlObj.origin + urlObj.pathname;
        try {
            $.get("https://api.blog.cloudflare.com/social?u=" + currenturl, function( res ) {
                if (!res.data.twitter && !res.data.hn && !res.data.reddit) {
                    $("#social-buttons").hide();
                }

                if (res.data.twitter) {
                    var twitterurl = "https://twitter.com/intent/tweet?in_reply_to=" + res.data.twitter.id;
                    $("#social-button-twitter").attr("href", twitterurl);
                    $("#social-button-twitter").show()
                }

                if (!res.data.hn) {
                    $("#social-button-hn").attr("href", "https://news.ycombinator.com/submitlink?u=" + currenturl);
                    $("#social-button-hn").show();
                }

                if (res.data.hn) {
                    $("#social-button-hn").attr("href", res.data.hn.comments_link);
                    $("#social-button-hn").show();
                }

                if (res.data.reddit) {
                    $("#social-button-reddit").attr("href", res.data.reddit.comments_link);
                    $("#social-button-reddit").show();
                }
            });
        } catch (err) {
            console.error(err);
            $("#social-buttons").hide();
        }
    })();
</script>

<script type="text/javascript" src="/assets/built/prism.js?v=de8f341044"></script>
<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>

<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>


    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PKQFGQB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script>
    var links = document.links;

    for (var i = 0, linksLength = links.length; i < linksLength; i++) {  
       if (links[i].hostname != window.location.hostname) {
           links[i].target = '_blank';
       } 
    } 
</script>

</body>

</html>