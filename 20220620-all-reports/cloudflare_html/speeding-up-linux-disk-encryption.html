<!DOCTYPE html>
<html lang="en">

<head class="sans-serif">

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="baidu-site-verification" content="KeThzeyMOr" />
    <meta name="baidu-site-verification" content="code-NIlrS7gNhx" />

    <title>Speeding up Linux disk encryption</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/3.4.1/themes/light.css" />

    <link rel="stylesheet" type="text/css" href="/assets/built/index.css?v=fdf4009e30" />

    <script type="text/javascript" src="/assets/built/index.js?v=fdf4009e30"></script>
    <script src="/assets/js/check-for-tex.js" defer></script>

    <meta name="description" content="In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!" />
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://blog.cloudflare.com/speeding-up-linux-disk-encryption/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="The Cloudflare Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Speeding up Linux disk encryption" />
    <meta property="og:description" content="Encrypting data at rest is vital for Cloudflare with more than 200 data centres across the world. In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!" />
    <meta property="og:url" content="https://blog.cloudflare.com/speeding-up-linux-disk-encryption/" />
    <meta property="og:image" content="https://blog.cloudflare.com/content/images/2020/03/dm-crypt-1.png" />
    <meta property="article:published_time" content="2020-03-25T12:00:00.000Z" />
    <meta property="article:modified_time" content="2020-12-28T11:35:10.000Z" />
    <meta property="article:tag" content="Linux" />
    <meta property="article:tag" content="Kernel" />
    <meta property="article:tag" content="Crypto" />
    <meta property="article:tag" content="Performance" />
    <meta property="article:tag" content="Security" />
    
    <meta property="article:publisher" content="https://www.facebook.com/cloudflare" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Speeding up Linux disk encryption" />
    <meta name="twitter:description" content="Encrypting data at rest is vital for Cloudflare with more than 200 data centres across the world. In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!" />
    <meta name="twitter:url" content="https://blog.cloudflare.com/speeding-up-linux-disk-encryption/" />
    <meta name="twitter:image" content="https://blog-cloudflare-com-assets.storage.googleapis.com/2020/03/dm-crypt-2.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ignat Korchagin" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Linux, Kernel, Crypto, Performance, Security" />
    <meta name="twitter:site" content="@cloudflare" />
    <meta name="twitter:creator" content="@ignatkn" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "The Cloudflare Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg",
            "width": 109,
            "height": 40.5
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ignat Korchagin",
        "image": "https://blog.cloudflare.com/content/images/2018/02/AAEAAQAAAAAAAAepAAAAJGI3NzA4ZDQxLTE1NTYtNDNlNi05M2NjLTE4NDE3ZTE3OWEyZg.jpg",
        "url": "https://blog.cloudflare.com/author/ignat/",
        "sameAs": [
            "https://twitter.com/ignatkn"
        ]
    },
    "headline": "Speeding up Linux disk encryption",
    "url": "https://blog.cloudflare.com/speeding-up-linux-disk-encryption/",
    "datePublished": "2020-03-25T12:00:00.000Z",
    "dateModified": "2020-12-28T11:35:10.000Z",
    "image": "https://blog.cloudflare.com/content/images/2020/03/dm-crypt-1.png",
    "keywords": "Linux, Kernel, Crypto, Performance, Security",
    "description": "Encrypting data at rest is vital for Cloudflare with more than 200 data centres across the world. In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.cloudflare.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.5" />
    <link rel="alternate" type="application/rss+xml" title="The Cloudflare Blog" href="https://blog.cloudflare.com/rss/" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','cfDataLayer','GTM-PKQFGQB');</script>
<!-- End Google Tag Manager -->

<!-- Google Optimize -->
<script src="https://www.googleoptimize.com/optimize.js?id=GTM-N4JSZJ8"></script>

<link rel="shortcut icon" href="https://blog.cloudflare.com/content/images/2019/12/favicon-8.png" type="image/png">

<meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6" />
<meta class="swiftype" name="language" data-type="string" content="en" />
<!--<script src="/assets/js/index.js"></script>-->
<script type="text/javascript" src="//cdn.bizible.com/scripts/bizible.js" async=""></script>
<script>
var trackRecruitingLink = function(role, url) {
   ga('send', 'event', 'recruiting', 'jobscore-click', role, {
     'transport': 'beacon',
     'hitCallback': function(){document.location = url;}
   });
}
</script> 
<script type="text/javascript">
	(function() {
		var didInit = false;
		function initMunchkin() {
			if(didInit === false) {
				didInit = true;
				Munchkin.init('713-XSC-918');
			}
		}
		var s = document.createElement('script');
		s.type = 'text/javascript';
		s.async = true;
		s.src = '//munchkin.marketo.net/munchkin.js';
		s.onreadystatechange = function() {
			if (this.readyState == 'complete' || this.readyState == 'loaded') {
				initMunchkin();
			}
		};
		s.onload = initMunchkin;
		document.getElementsByTagName('head')[0].appendChild(s);
		})();
</script>
<script>
var HTMLAttrToAdd = document.querySelector("html");
HTMLAttrToAdd.setAttribute("lang", "en");
</script>
<style>
    table {
        background-color: transparent;
    }
    td {
		padding: 5px 1em;
    }
    pre {
        max-height: 500px;
        overflow-y: scroll;
    }
</style>
<!-- Cloudflare Web Analytics -->
<script
        defer
        src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "f446eacb44504e50864bad7c47ffa9e8"}'></script>
<!-- End Cloudflare Web Analytics -->

</head>

<body id="main-body" class="post-template tag-linux tag-kernel tag-crypto tag-performance tag-security sans-serif">

    <div class="site-wrapper">

        <header class="flex flex-row flex-wrap justify-between items-end mw8 center mv3 pl3 pr2">
    <div class="w-100 flex items-end justify-between justify-start-l">
        <div class="w-100 tr">
            <span class="dn di-l">
                <a href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover">Contact Sales:
                </a>
                <a href="tel:+18889935273" class="f1 gray4 no-underline underline-hover">+1 (888) 274-3482</a>
            </span>
        </div>
    </div>
    <div class="w-100 w-50-l flex items-end justify-between justify-start-l">
        <a href="https://blog.cloudflare.com" class="header-logo mr4">
            <img src="https://blog-cloudflare-com-assets.storage.googleapis.com/2019/06/logo-cloudflare-dark-1.svg" alt="The Cloudflare Blog" class="header-logo" />
        </a>
        <h2 class="mt0 mb1">
            <a href="/" class="fw5 f5 gray3 no-underline">
                <span class="dn di-l">The Cloudflare Blog</span>
            </a>
        </h2>
    </div>
    <div class="w-100 w-50-l dn db-l">
        <div class="w-100 tr mkto-sub-message">
            <p class="f2">Thanks for being here, come back soon. Get notified of new posts:</p>
        </div>
        <div class="w-100 tr">
            <script src="//app-ab13.marketo.com/js/forms2/js/forms2.min.js"></script>
            <div class="marketo-form-container">
                <form id="mktoForm_1653"></form>
            </div>
            <script>
                MktoForms2.loadForm("//app-ab13.marketo.com", "713-XSC-918", 1653, function(form) {
                    document.querySelectorAll('#mktoForm_1653 .mktoEmailField')[0].placeholder = "Email Address";

                    form.onSuccess(function(vals, thanksURL){
                        // Hide form and show success msg
                        document.getElementById("mktoForm_1653").style.display = "none";
                        document.getElementsByClassName("mkto-sub-message")[0].style.display = "none";

                        document.getElementsByClassName("js-form-success-msg")[0].style.display = "block";
                        return false;
                    });
                });
            </script>
        </div>
        <div class="w-100 tr dn js-form-success-msg">
            <p class="f2">Subscription confirmed. Thank you for subscribing!</p>
        </div>
    </div>
</header>

<nav id="nav" class="w-100 bb b--black-10 z-1">
    <div id="desktop-nav-items-container" class="flex flex-row flex-wrap justify-between items-center mw8 center mv3 mv0-l">
        <div class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3" data-tag="product-news">
            <a href="/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="speed-and-reliability">
            <a href="/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="security">
            <a href="/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="serverless">
            <a href="/tag/serverless/" class="no-underline gray1 f2 fw5 pv3">Serverless</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="cloudflare-network">
            <a href="/tag/cloudflare-network/" class="no-underline gray1 f2 fw5 pv3">Cloudflare Network</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="developers">
            <a href="/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a>
        </div>
        <div class="nav-item nav-item-desktop mh2 dn db-l pv3" data-tag="deep-dive">
            <a href="/tag/deep-dive/" class="no-underline gray1 f2 fw5 pv3">Deep Dive</a>
        </div>
        <div class="nav-item nav-item-desktop ml2 mr3 dn db-l pv3" data-tag="life-at-cloudflare">
            <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life @Cloudflare</a>
        </div>
        <a href="/search/"><img src="/assets/images/magnifier.svg?v=fdf4009e30" class="js-search-box-trigger mw2 pointer ph3 ph2-l" />
        </a>
        <img src="/assets/images/hamburger.svg?v=fdf4009e30" class="w2 pointer js-mobile-nav-trigger ph3 db dn-l" />
    </div>

    <div class="js-mobile-nav-container dn">
        <div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-100 ph3 z-1">
            <div class="pv3 ph2">
                <a href="/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/security/" class="no-underline gray1 f4 fw7">Security</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/serverless/" class="no-underline gray1 f4 fw7">Serverless</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/cloudflare-network/" class="no-underline gray1 f4 fw7">Cloudflare Network</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/deep-dive/" class="no-underline gray1 f4 fw7">Deep Dive</a>
            </div>
            <div class="pv3 ph2">
                <a href="/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life @Cloudflare</a>
            </div>
        </div>
    </div>
</nav>
        


<main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l">
    <article
        class="post-full mw-100 ph3 ph0-l fs-20px post tag-linux tag-kernel tag-crypto tag-performance tag-security ">
        <h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">Speeding up Linux disk encryption</h1>


        <p class="f3 fw5 gray5 db di-l mt2" localize datetime="2020-03-25T12:00:00Z">Loading...</p>
        <noscript>
            <p class="f3 fw5 gray5 db di-l mt2">March 25, 2020 12:00PM</p>
        </noscript>

        <ul class="flex flex-wrap pl0 mt4">
            <li class="list flex items-center ml0 pl0 pb1">
                <a href="/author/ignat/" class="static-avatar pr1">
                    <img class="author-profile-image h2 w2 br-100 mr2" src="/content/images/2018/02/AAEAAQAAAAAAAAepAAAAJGI3NzA4ZDQxLTE1NTYtNDNlNi05M2NjLTE4NDE3ZTE3OWEyZg.jpg" alt="Ignat Korchagin" />
                </a>
                <div class="author-name-tooltip">
                    <a href="/author/ignat" class="fw5 f3 no-underline black mr3">Ignat Korchagin</a>
                </div>
            </li>
        </ul>

        <section class="post-full-content">
            <div class="post-content lh-copy gray1">
                <!--kg-card-begin: markdown--><p>Data encryption at rest is a must-have for any modern Internet company. Many companies, however, don't encrypt their disks, because they fear the potential performance penalty caused by encryption overhead.</p>
<p>Encrypting data at rest is vital for Cloudflare with <a href="https://www.cloudflare.com/network/">more than 200 data centres across the world</a>. In this post, we will investigate the performance of disk encryption on Linux and explain how we made it at least two times faster for ourselves and our customers!</p>
<h3 id="encryptingdataatrest">Encrypting data at rest</h3>
<p>When it comes to encrypting data at rest there are several ways it can be implemented on a modern operating system (OS). Available techniques are tightly coupled with a <a href="https://en.wikibooks.org/wiki/The_Linux_Kernel/Storage">typical OS storage stack</a>. A simplified version of the storage stack and encryption solutions can be found on the diagram below:</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/storage-stack.png" alt="storage-stack"></p>
<p>On the top of the stack are applications, which read and write data in files (or streams). The file system in the OS kernel keeps track of which blocks of the underlying block device belong to which files and translates these file reads and writes into block reads and writes, however the hardware specifics of the underlying storage device is abstracted away from the filesystem. Finally, the block subsystem actually passes the block reads and writes to the underlying hardware using appropriate device drivers.</p>
<p>The concept of the storage stack is actually similar to the <a href="https://www.cloudflare.com/learning/ddos/glossary/open-systems-interconnection-model-osi/">well-known network OSI model</a>, where each layer has a more high-level view of the information and the implementation details of the lower layers are abstracted away from the upper layers. And, similar to the OSI model, one can apply encryption at different layers (think about <a href="https://www.cloudflare.com/learning/ssl/transport-layer-security-tls/">TLS</a> vs <a href="https://en.wikipedia.org/wiki/IPsec">IPsec</a> or <a href="https://www.cloudflare.com/learning/access-management/what-is-a-vpn/">a VPN</a>).</p>
<p>For data at rest we can apply encryption either at the block layers (either in hardware or in software) or at the file level (either directly in applications or in the filesystem).</p>
<h4 id="blockvsfileencryption">Block vs file encryption</h4>
<p>Generally, the higher in the stack we apply encryption, the more flexibility we have. With application level encryption the application maintainers can apply any encryption code they please to any particular data they need. The downside of this approach is they actually have to implement it themselves and encryption in general is not very developer-friendly: one has to know the ins and outs of a specific cryptographic algorithm, properly generate keys, nonces, IVs etc. Additionally, application level encryption does not leverage OS-level caching and <a href="https://en.wikipedia.org/wiki/Page_cache">Linux page cache</a> in particular: each time the application needs to use the data, it has to either decrypt it again, wasting CPU cycles, or implement its own decrypted “cache”, which introduces more complexity to the code.</p>
<p>File system level encryption makes data encryption transparent to applications, because the file system itself encrypts the data before passing it to the block subsystem, so files are encrypted regardless if the application has crypto support or not. Also, file systems can be configured to encrypt only a particular directory or have different keys for different files. This flexibility, however, comes at a cost of a more complex configuration. File system encryption is also considered less secure than block device encryption as only the contents of the files are encrypted. Files also have associated metadata, like file size, the number of files, the directory tree layout etc., which are still visible to a potential adversary.</p>
<p>Encryption down at the block layer (often referred to as <a href="https://en.wikipedia.org/wiki/Disk_encryption">disk encryption</a> or full disk encryption) also makes data encryption transparent to applications and even whole file systems. Unlike file system level encryption it encrypts all data on the disk including file metadata and even free space. It is less flexible though - one can only encrypt the whole disk with a single key, so there is no per-directory, per-file or per-user configuration. From the crypto perspective, not all cryptographic algorithms can be used as the block layer doesn't have a high-level overview of the data anymore, so it needs to process each block independently. Most <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Common_modes">common algorithms require some sort of block chaining</a> to be secure, so are not applicable to disk encryption. Instead, <a href="https://en.wikipedia.org/wiki/Disk_encryption_theory#Block_cipher-based_modes">special modes were developed</a> just for this specific use-case.</p>
<p>So which layer to choose? As always, it depends... Application and file system level encryption are usually the preferred choice for client systems because of the flexibility. For example, each user on a multi-user desktop may want to encrypt their home directory with a key they own and leave some shared directories unencrypted. On the contrary, on server systems, managed by SaaS/PaaS/IaaS companies (including Cloudflare) the preferred choice is configuration simplicity and security - with full disk encryption enabled any data from any application is automatically encrypted with no exceptions or overrides. We believe that all data needs to be protected without sorting it into &quot;important&quot; vs &quot;not important&quot; buckets, so the selective flexibility the upper layers provide is not needed.</p>
<h4 id="hardwarevssoftwarediskencryption">Hardware vs software disk encryption</h4>
<p>When encrypting data at the block layer it is possible to do it directly in the storage hardware, if the hardware <a href="https://en.wikipedia.org/wiki/Hardware-based_full_disk_encryption">supports it</a>. Doing so usually gives better read/write performance and consumes less resources from the host. However, since most hardware firmware is proprietary, it does not receive as much attention and review from the security community. In the past this led to <a href="https://www.us-cert.gov/ncas/current-activity/2018/11/06/Self-Encrypting-Solid-State-Drive-Vulnerabilities">flaws in some implementations of hardware disk encryption</a>, which render the whole security model useless. Microsoft, for example, <a href="https://support.microsoft.com/en-us/help/4516071/windows-10-update-kb4516071">started to prefer software-based disk encryption</a> since then.</p>
<p>We didn't want to put our data and our customers' data to the risk of using potentially insecure solutions and we <a href="https://blog.cloudflare.com/helping-to-build-cloudflare-part-4/">strongly believe in open-source</a>. That's why we rely only on software disk encryption in the Linux kernel, which is open and has been audited by many security professionals across the world.</p>
<h3 id="linuxdiskencryptionperformance">Linux disk encryption performance</h3>
<p>We aim not only to save bandwidth costs for our customers, but to deliver content to Internet users as fast as possible.</p>
<p>At one point we noticed that our disks were not as fast as we would like them to be. Some profiling as well as a quick A/B test pointed to Linux disk encryption. Because not encrypting the data (even if it is supposed-to-be a public Internet cache) is not a sustainable option, we decided to take a closer look into Linux disk encryption performance.</p>
<h4 id="devicemapperanddmcrypt">Device mapper and dm-crypt</h4>
<p>Linux implements transparent disk encryption via a <a href="https://en.wikipedia.org/wiki/Dm-crypt">dm-crypt module</a> and <code>dm-crypt</code> itself is part of <a href="https://en.wikipedia.org/wiki/Device_mapper">device mapper</a> kernel framework. In a nutshell, the device mapper allows pre/post-process IO requests as they travel between the file system and the underlying block device.</p>
<p><code>dm-crypt</code> in particular encrypts &quot;write&quot; IO requests before sending them further down the stack to the actual block device and decrypts &quot;read&quot; IO requests before sending them up to the file system driver. Simple and easy! Or is it?</p>
<h4 id="benchmarkingsetup">Benchmarking setup</h4>
<p>For the record, the numbers in this post were obtained by running specified commands on an idle <a href="https://blog.cloudflare.com/a-tour-inside-cloudflares-g9-servers/">Cloudflare G9 server</a> out of production. However, the setup should be easily reproducible on any modern x86 laptop.</p>
<p>Generally, benchmarking anything around a storage stack is hard because of the noise introduced by the storage hardware itself. Not all disks are created equal, so for the purpose of this post we will use the fastest disks available out there - that is no disks.</p>
<p>Instead Linux has an option to emulate a disk directly in <a href="https://en.wikipedia.org/wiki/Random-access_memory">RAM</a>. Since RAM is much faster than any persistent storage, it should introduce little bias in our results.</p>
<p>The following command creates a 4GB ramdisk:</p>
<pre><code class="language-bash">$ sudo modprobe brd rd_nr=1 rd_size=4194304
$ ls /dev/ram0
</code></pre>
<p>Now we can set up a <code>dm-crypt</code> instance on top of it thus enabling encryption for the disk. First, we need to generate the disk encryption key, &quot;format&quot; the disk and specify a password to unlock the newly generated key.</p>
<pre><code class="language-bash">$ fallocate -l 2M crypthdr.img
$ sudo cryptsetup luksFormat /dev/ram0 --header crypthdr.img

WARNING!
========
This will overwrite data on crypthdr.img irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase:
Verify passphrase:
</code></pre>
<p>Those who are familiar with <code>LUKS/dm-crypt</code> might have noticed we used a <a href="http://man7.org/linux/man-pages/man8/cryptsetup.8.html">LUKS detached header</a> here. Normally, LUKS stores the password-encrypted disk encryption key on the same disk as the data, but since we want to compare read/write performance between encrypted and unencrypted devices, we might accidentally overwrite the encrypted key during our benchmarking later. Keeping the encrypted key in a separate file avoids this problem for the purposes of this post.</p>
<p>Now, we can actually &quot;unlock&quot; the encrypted device for our testing:</p>
<pre><code class="language-bash">$ sudo cryptsetup open --header crypthdr.img /dev/ram0 encrypted-ram0
Enter passphrase for /dev/ram0:
$ ls /dev/mapper/encrypted-ram0
/dev/mapper/encrypted-ram0
</code></pre>
<p>At this point we can now compare the performance of encrypted vs unencrypted ramdisk: if we read/write data to <code>/dev/ram0</code>, it will be stored in <a href="https://en.wikipedia.org/wiki/Plaintext">plaintext</a>. Likewise, if we read/write data to <code>/dev/mapper/encrypted-ram0</code>, it will be decrypted/encrypted on the way by <code>dm-crypt</code> and stored in <a href="https://en.wikipedia.org/wiki/Ciphertext">ciphertext</a>.</p>
<p>It's worth noting that we're not creating any file system on top of our block devices to avoid biasing results with a file system overhead.</p>
<h4 id="measuringthroughput">Measuring throughput</h4>
<p>When it comes to storage testing/benchmarking <a href="https://fio.readthedocs.io/en/latest/fio_doc.html">Flexible I/O tester</a> is the usual go-to solution. Let's simulate simple sequential read/write load with 4K block size on the ramdisk without encryption:</p>
<pre><code class="language-bash">$ sudo fio --filename=/dev/ram0 --readwrite=readwrite --bs=4k --direct=1 --loops=1000000 --name=plain
plain: (g=0): rw=rw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1
fio-2.16
Starting 1 process
...
Run status group 0 (all jobs):
   READ: io=21013MB, aggrb=1126.5MB/s, minb=1126.5MB/s, maxb=1126.5MB/s, mint=18655msec, maxt=18655msec
  WRITE: io=21023MB, aggrb=1126.1MB/s, minb=1126.1MB/s, maxb=1126.1MB/s, mint=18655msec, maxt=18655msec

Disk stats (read/write):
  ram0: ios=0/0, merge=0/0, ticks=0/0, in_queue=0, util=0.00%
</code></pre>
<p>The above command will run for a long time, so we just stop it after a while. As we can see from the stats, we're able to read and write roughly with the same throughput around <code>1126 MB/s</code>. Let's repeat the test with the encrypted ramdisk:</p>
<pre><code class="language-bash">$ sudo fio --filename=/dev/mapper/encrypted-ram0 --readwrite=readwrite --bs=4k --direct=1 --loops=1000000 --name=crypt
crypt: (g=0): rw=rw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1
fio-2.16
Starting 1 process
...
Run status group 0 (all jobs):
   READ: io=1693.7MB, aggrb=150874KB/s, minb=150874KB/s, maxb=150874KB/s, mint=11491msec, maxt=11491msec
  WRITE: io=1696.4MB, aggrb=151170KB/s, minb=151170KB/s, maxb=151170KB/s, mint=11491msec, maxt=11491msec
</code></pre>
<p>Whoa, that's a drop! We only get <code>~147 MB/s</code> now, which is more than 7 times slower! And this is on a totally idle machine!</p>
<h4 id="maybecryptoisjustslow">Maybe, crypto is just slow</h4>
<p>The first thing we considered is to ensure we use the fastest crypto. <code>cryptsetup</code> allows us to benchmark all the available crypto implementations on the system to select the best one:</p>
<pre><code class="language-bash">$ sudo cryptsetup benchmark
# Tests are approximate using memory only (no storage IO).
PBKDF2-sha1      1340890 iterations per second for 256-bit key
PBKDF2-sha256    1539759 iterations per second for 256-bit key
PBKDF2-sha512    1205259 iterations per second for 256-bit key
PBKDF2-ripemd160  967321 iterations per second for 256-bit key
PBKDF2-whirlpool  720175 iterations per second for 256-bit key
#  Algorithm | Key |  Encryption |  Decryption
     aes-cbc   128b   969.7 MiB/s  3110.0 MiB/s
 serpent-cbc   128b           N/A           N/A
 twofish-cbc   128b           N/A           N/A
     aes-cbc   256b   756.1 MiB/s  2474.7 MiB/s
 serpent-cbc   256b           N/A           N/A
 twofish-cbc   256b           N/A           N/A
     aes-xts   256b  1823.1 MiB/s  1900.3 MiB/s
 serpent-xts   256b           N/A           N/A
 twofish-xts   256b           N/A           N/A
     aes-xts   512b  1724.4 MiB/s  1765.8 MiB/s
 serpent-xts   512b           N/A           N/A
 twofish-xts   512b           N/A           N/A
</code></pre>
<p>It seems <code>aes-xts</code> with a 256-bit data encryption key is the fastest here. But which one are we actually using for our encrypted ramdisk?</p>
<pre><code class="language-bash">$ sudo dmsetup table /dev/mapper/encrypted-ram0
0 8388608 crypt aes-xts-plain64 0000000000000000000000000000000000000000000000000000000000000000 0 1:0 0
</code></pre>
<p>We do use <code>aes-xts</code> with a 256-bit data encryption key (count all the zeroes conveniently masked by <code>dmsetup</code> tool - if you want to see the actual bytes, add the <code>--showkeys</code> option to the above command). The numbers do not add up however: <code>cryptsetup benchmark</code> tells us above not to rely on the results, as &quot;Tests are approximate using memory only (no storage IO)&quot;, but that is exactly how we've set up our experiment using the ramdisk. In a somewhat worse case (assuming we're reading all the data and then encrypting/decrypting it sequentially with no parallelism) doing <a href="https://en.wikipedia.org/wiki/Back-of-the-envelope_calculation">back-of-the-envelope calculation</a> we should be getting around <code>(1126 * 1823) / (1126 + 1823) =~696 MB/s</code>, which is still quite far from the actual <code>147 * 2 = 294 MB/s</code> (total for reads and writes).</p>
<h4 id="dmcryptperformanceflags">dm-crypt performance flags</h4>
<p>While reading the <a href="http://man7.org/linux/man-pages/man8/cryptsetup.8.html">cryptsetup man page</a> we noticed that it has two options prefixed with <code>--perf-</code>, which are probably related to performance tuning. The first one is <code>--perf-same_cpu_crypt</code> with a rather cryptic description:</p>
<pre><code>Perform encryption using the same cpu that IO was submitted on.  The default is to use an unbound workqueue so that encryption work is automatically balanced between available CPUs.  This option is only relevant for open action.
</code></pre>
<p>So we enable the option</p>
<pre><code class="language-bash">$ sudo cryptsetup close encrypted-ram0
$ sudo cryptsetup open --header crypthdr.img --perf-same_cpu_crypt /dev/ram0 encrypted-ram0
</code></pre>
<p>Note: according to the <a href="http://man7.org/linux/man-pages/man8/cryptsetup.8.html">latest man page</a> there is also a <code>cryptsetup refresh</code> command, which can be used to enable these options live without having to &quot;close&quot; and &quot;re-open&quot; the encrypted device. Our <code>cryptsetup</code> however didn't support it yet.</p>
<p>Verifying if the option has been really enabled:</p>
<pre><code class="language-bash">$ sudo dmsetup table encrypted-ram0
0 8388608 crypt aes-xts-plain64 0000000000000000000000000000000000000000000000000000000000000000 0 1:0 0 1 same_cpu_crypt
</code></pre>
<p>Yes, we can now see <code>same_cpu_crypt</code> in the output, which is what we wanted. Let's rerun the benchmark:</p>
<pre><code class="language-bash">$ sudo fio --filename=/dev/mapper/encrypted-ram0 --readwrite=readwrite --bs=4k --direct=1 --loops=1000000 --name=crypt
crypt: (g=0): rw=rw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1
fio-2.16
Starting 1 process
...
Run status group 0 (all jobs):
   READ: io=1596.6MB, aggrb=139811KB/s, minb=139811KB/s, maxb=139811KB/s, mint=11693msec, maxt=11693msec
  WRITE: io=1600.9MB, aggrb=140192KB/s, minb=140192KB/s, maxb=140192KB/s, mint=11693msec, maxt=11693msec
</code></pre>
<p>Hmm, now it is <code>~136 MB/s</code> which is slightly worse than before, so no good. What about the second option <code>--perf-submit_from_crypt_cpus</code>:</p>
<pre><code>Disable offloading writes to a separate thread after encryption.  There are some situations where offloading write bios from the encryption threads to a single thread degrades performance significantly.  The default is to offload write bios to the same thread.  This option is only relevant for open action.
</code></pre>
<p>Maybe, we are in the &quot;some situation&quot; here, so let's try it out:</p>
<pre><code class="language-bash">$ sudo cryptsetup close encrypted-ram0
$ sudo cryptsetup open --header crypthdr.img --perf-submit_from_crypt_cpus /dev/ram0 encrypted-ram0
Enter passphrase for /dev/ram0:
$ sudo dmsetup table encrypted-ram0
0 8388608 crypt aes-xts-plain64 0000000000000000000000000000000000000000000000000000000000000000 0 1:0 0 1 submit_from_crypt_cpus
</code></pre>
<p>And now the benchmark:</p>
<pre><code class="language-bash">$ sudo fio --filename=/dev/mapper/encrypted-ram0 --readwrite=readwrite --bs=4k --direct=1 --loops=1000000 --name=crypt
crypt: (g=0): rw=rw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1
fio-2.16
Starting 1 process
...
Run status group 0 (all jobs):
   READ: io=2066.6MB, aggrb=169835KB/s, minb=169835KB/s, maxb=169835KB/s, mint=12457msec, maxt=12457msec
  WRITE: io=2067.7MB, aggrb=169965KB/s, minb=169965KB/s, maxb=169965KB/s, mint=12457msec, maxt=12457msec
</code></pre>
<p><code>~166 MB/s</code>, which is a bit better, but still not good...</p>
<h4 id="askingthecommunity">Asking the community</h4>
<p>Being desperate we decided to seek support from the Internet and <a href="https://www.spinics.net/lists/dm-crypt/msg07516.html">posted our findings to the <code>dm-crypt</code> mailing list</a>, but the response we got was not very encouraging:</p>
<blockquote>
<p>If the numbers disturb you, then this is from lack of understanding on your side. You are probably unaware that encryption is a heavy-weight operation...</p>
</blockquote>
<p>We decided to make a scientific research on this topic by typing &quot;is encryption expensive&quot; into Google Search and one of the top results, which actually contains meaningful measurements, is... <a href="https://blog.cloudflare.com/how-expensive-is-crypto-anyway/">our own post about cost of encryption</a>, but in the context of <a href="https://www.cloudflare.com/learning/ssl/transport-layer-security-tls/">TLS</a>! This is a fascinating read on its own, but the gist is: modern crypto on modern hardware is very cheap even at Cloudflare scale (doing millions of encrypted HTTP requests per second). In fact, it is so cheap that Cloudflare was the first provider to offer <a href="https://blog.cloudflare.com/introducing-universal-ssl/">free SSL/TLS for everyone</a>.</p>
<h4 id="diggingintothesourcecode">Digging into the source code</h4>
<p>When trying to use the custom <code>dm-crypt</code> options described above we were curious why they exist in the first place and what is that &quot;offloading&quot; all about. Originally we expected <code>dm-crypt</code> to be a simple &quot;proxy&quot;, which just encrypts/decrypts data as it flows through the stack. Turns out <code>dm-crypt</code> does more than just encrypting memory buffers and a (simplified) IO traverse path diagram is presented below:</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/dm-crypt.png" alt="dm-crypt"></p>
<p>When the file system issues a write request, <code>dm-crypt</code> does not process it immediately - instead it puts it into a <a href="https://www.kernel.org/doc/html/v4.19/core-api/workqueue.html">workqueue</a> <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L3124">named &quot;kcryptd&quot;</a>. In a nutshell, a kernel workqueue just schedules some work (encryption in this case) to be performed at some later time, when it is more convenient. When &quot;the time&quot; comes, <code>dm-crypt</code> <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1940">sends the request</a> to <a href="https://www.kernel.org/doc/html/v4.19/crypto/index.html">Linux Crypto API</a> for actual encryption. However, modern Linux Crypto API <a href="https://www.kernel.org/doc/html/v4.19/crypto/api-skcipher.html#symmetric-key-cipher-api">is asynchronous</a> as well, so depending on which particular implementation your system will use, most likely it will not be processed immediately, but queued again for &quot;later time&quot;. When Linux Crypto API will finally <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1980">do the encryption</a>, <code>dm-crypt</code> may try to <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1909-L1910">sort pending write requests by putting each request</a> into a <a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">red-black tree</a>. Then a <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1819">separate kernel thread</a> again at &quot;some time later&quot; actually takes all IO requests in the tree and <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1864">sends them down the stack</a>.</p>
<p>Now for read requests: this time we need to get the encrypted data first from the hardware, but <code>dm-crypt</code> does not just ask for the driver for the data, but queues the request into a different <a href="https://www.kernel.org/doc/html/v4.19/core-api/workqueue.html">workqueue</a> <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L3122">named &quot;kcryptd_io&quot;</a>. At some point later, when we actually have the encrypted data, we <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1742">schedule it for decryption</a> using the now familiar &quot;kcryptd&quot; workqueue. &quot;kcryptd&quot; <a href="https://github.com/torvalds/linux/blob/0d81a3f29c0afb18ba2b1275dcccf21e0dd4da38/drivers/md/dm-crypt.c#L1970">will send the request</a> to Linux Crypto API, which may decrypt the data asynchronously as well.</p>
<p>To be fair the request does not always traverse all these queues, but the important part here is that write requests may be queued up to 4 times in <code>dm-crypt</code> and read requests up to 3 times. At this point we were wondering if all this extra queueing can cause any performance issues. For example, there is a <a href="https://www.usenix.org/conference/srecon19asia/presentation/plenz">nice presentation from Google</a> about the relationship between queueing and tail latency. One key takeaway from the presentation is:</p>
<blockquote>
<p>A significant amount of tail latency is due to queueing effects</p>
</blockquote>
<p>So, why are all these queues there and can we remove them?</p>
<h4 id="gitarcheology">Git archeology</h4>
<p>No-one writes more complex code just for fun, especially for the OS kernel. So all these queues must have been put there for a reason. Luckily, the Linux kernel source is managed by <a href="https://en.wikipedia.org/wiki/Git">git</a>, so we can try to retrace the changes and the decisions around them.</p>
<p>The &quot;kcryptd&quot; workqueue was in the source <a href="https://github.com/torvalds/linux/blob/1da177e4c3f41524e886b7f1b8a0c1fc7321cac2/drivers/md/dm-crypt.c">since the beginning of the available history</a> with the following comment:</p>
<blockquote>
<p>Needed because it would be very unwise to do decryption in an interrupt context, so bios returning from read requests get queued here.</p>
</blockquote>
<p>So it was for reads only, but even then - why do we care if it is interrupt context or not, if Linux Crypto API will likely use a dedicated thread/queue for encryption anyway? Well, back in 2005 Crypto API <a href="https://github.com/torvalds/linux/blob/1da177e4c3f41524e886b7f1b8a0c1fc7321cac2/Documentation/crypto/api-intro.txt">was not asynchronous</a>, so this made perfect sense.</p>
<p>In 2006 <code>dm-crypt</code> <a href="https://github.com/torvalds/linux/commit/23541d2d288cdb54f417ba1001dacc7f3ea10a97">started to use</a> the &quot;kcryptd&quot; workqueue not only for encryption, but for submitting IO requests:</p>
<blockquote>
<p>This patch is designed to help dm-crypt comply with the new constraints imposed by the following patch in -mm: md-dm-reduce-stack-usage-with-stacked-block-devices.patch</p>
</blockquote>
<p>It seems the goal here was not to add more concurrency, but rather reduce kernel stack usage, which makes sense again as the kernel has a common stack across all the code, so it is a quite limited resource. It is worth noting, however, that the <a href="https://github.com/torvalds/linux/commit/6538b8ea886e472f4431db8ca1d60478f838d14b">Linux kernel stack has been expanded</a> in 2014 for x86 platforms, so this might not be a problem anymore.</p>
<p>A <a href="https://github.com/torvalds/linux/commit/cabf08e4d3d1181d7c408edae97fb4d1c31518af">first version of &quot;kcryptd_io&quot; workqueue was added</a> in 2007 with the intent to avoid:</p>
<blockquote>
<p>starvation caused by many requests waiting for memory allocation...</p>
</blockquote>
<p>The request processing was bottlenecking on a single workqueue here, so the solution was to add another one. Makes sense.</p>
<p>We are definitely not the first ones experiencing performance degradation because of extensive queueing: in 2011 a change was introduced to <a href="https://github.com/torvalds/linux/commit/20c82538e4f5ede51bc2b4795bc6e5cae772796d">conditionally revert some of the queueing for read requests</a>:</p>
<blockquote>
<p>If there is enough memory, code can directly submit bio instead queuing this operation in a separate thread.</p>
</blockquote>
<p>Unfortunately, at that time Linux kernel commit messages were not as verbose as today, so there is no performance data available.</p>
<p>In 2015 <a href="https://github.com/torvalds/linux/commit/dc2676210c425ee8e5cb1bec5bc84d004ddf4179">dm-crypt started to sort writes</a> in a separate &quot;dmcrypt_write&quot; thread before sending them down the stack:</p>
<blockquote>
<p>On a multiprocessor machine, encryption requests finish in a different order than they were submitted.  Consequently, write requests would be submitted in a different order and it could cause severe performance degradation.</p>
</blockquote>
<p>It does make sense as sequential disk access used to be much faster than the random one and <code>dm-crypt</code> was breaking the pattern. But this mostly applies to <a href="https://en.wikipedia.org/wiki/Hard_disk_drive">spinning disks</a>, which were still dominant in 2015. It may not be as important with modern fast <a href="https://en.wikipedia.org/wiki/Solid-state_drive">SSDs (including NVME SSDs)</a>.</p>
<p>Another part of the commit message is worth mentioning:</p>
<blockquote>
<p>...in particular it enables IO schedulers like CFQ to sort more effectively...</p>
</blockquote>
<p>It mentions the performance benefits for the <a href="https://www.kernel.org/doc/Documentation/block/cfq-iosched.txt">CFQ IO scheduler</a>, but Linux schedulers have improved since then to the point that <a href="https://github.com/torvalds/linux/commit/f382fb0bcef4c37dc049e9f6963e3baf204d815c">CFQ scheduler has been removed</a> from the kernel in 2018.</p>
<p>The same patchset <a href="https://github.com/torvalds/linux/commit/b3c5fd3052492f1b8d060799d4f18be5a5438">replaces the sorting list with a red-black tree</a>:</p>
<blockquote>
<p>In theory the sorting should be performed by the underlying disk scheduler, however, in practice the disk scheduler only accepts and sorts a finite number of requests.  To allow the sorting of all requests, dm-crypt needs to implement its own sorting.</p>
<p>The overhead associated with rbtree-based sorting is considered negligible so it is not used conditionally.</p>
</blockquote>
<p>All that make sense, but it would be nice to have some backing data.</p>
<p>Interestingly, in the same patchset we see <a href="https://github.com/torvalds/linux/commit/0f5d8e6ee758f7023e4353cca75d785b2d4f6abe">the introduction of our familiar &quot;submit_from_crypt_cpus&quot; option</a>:</p>
<blockquote>
<p>There are some situations where offloading write bios from the encryption threads to a single thread degrades performance significantly</p>
</blockquote>
<p>Overall, we can see that every change was reasonable and needed, however things have changed since then:</p>
<ul>
<li>hardware became faster and smarter</li>
<li>Linux resource allocation was revisited</li>
<li>coupled Linux subsystems were rearchitected</li>
</ul>
<p>And many of the design choices above may not be applicable to modern Linux.</p>
<h3 id="thecleanup">The &quot;clean-up&quot;</h3>
<p>Based on the research above we decided to try to remove all the extra queueing and asynchronous behaviour and revert <code>dm-crypt</code> to its original purpose: simply encrypt/decrypt IO requests as they pass through. But for the sake of stability and further benchmarking we ended up not removing the actual code, but rather adding yet another <code>dm-crypt</code> option, which bypasses all the queues/threads, if enabled. The flag allows us to switch between the current and new behaviour at runtime under full production load, so we can easily revert our changes should we see any side-effects. The resulting patch can be found on the <a href="https://github.com/cloudflare/linux/blob/12a61de6dd06408f4f3c27f8019beb66366e98e3/patches/0023-Add-DM_CRYPT_FORCE_INLINE-flag-to-dm-crypt-target.patch">Cloudflare GitHub Linux repository</a>.</p>
<h4 id="synchronouslinuxcryptoapi">Synchronous Linux Crypto API</h4>
<p>From the diagram above we remember that not all queueing is implemented in <code>dm-crypt</code>. Modern Linux Crypto API may also be asynchronous and for the sake of this experiment we want to eliminate queues there as well. What does &quot;may be&quot; mean, though? The OS may contain different implementations of the same algorithm (for example, <a href="https://en.wikipedia.org/wiki/AES_instruction_set">hardware-accelerated AES-NI on x86 platforms</a> and generic C-code AES implementations). By default the system chooses the &quot;best&quot; one based on <a href="https://www.kernel.org/doc/html/v4.19/crypto/architecture.html#crypto-api-cipher-references-and-priority">the configured algorithm priority</a>. <code>dm-crypt</code> allows overriding this behaviour and <a href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/DMCrypt#mapping-table-for-crypt-target">request a particular cipher implementation</a> using the <code>capi:</code> prefix. However, there is one problem. Let us actually check the available AES-XTS (this is our disk encryption cipher, remember?) implementations on our system:</p>
<pre><code class="language-bash">$ grep -A 11 'xts(aes)' /proc/crypto
name         : xts(aes)
driver       : xts(ecb(aes-generic))
module       : kernel
priority     : 100
refcnt       : 7
selftest     : passed
internal     : no
type         : skcipher
async        : no
blocksize    : 16
min keysize  : 32
max keysize  : 64
--
name         : __xts(aes)
driver       : cryptd(__xts-aes-aesni)
module       : cryptd
priority     : 451
refcnt       : 1
selftest     : passed
internal     : yes
type         : skcipher
async        : yes
blocksize    : 16
min keysize  : 32
max keysize  : 64
--
name         : xts(aes)
driver       : xts-aes-aesni
module       : aesni_intel
priority     : 401
refcnt       : 1
selftest     : passed
internal     : no
type         : skcipher
async        : yes
blocksize    : 16
min keysize  : 32
max keysize  : 64
--
name         : __xts(aes)
driver       : __xts-aes-aesni
module       : aesni_intel
priority     : 401
refcnt       : 7
selftest     : passed
internal     : yes
type         : skcipher
async        : no
blocksize    : 16
min keysize  : 32
max keysize  : 64
</code></pre>
<p>We want to explicitly select a synchronous cipher from the above list to avoid queueing effects in threads, but the only two supported are <code>xts(ecb(aes-generic))</code> (the generic C implementation) and <code>__xts-aes-aesni</code> (the <a href="https://en.wikipedia.org/wiki/AES_instruction_set">x86 hardware-accelerated implementation</a>). We definitely want the latter as it is much faster (we're aiming for performance here), but it is suspiciously marked as internal (see <code>internal: yes</code>). If we <a href="https://github.com/torvalds/linux/blob/fb33c6510d5595144d585aa194d377cf74d31911/include/linux/crypto.h#L91">check the source code</a>:</p>
<blockquote>
<p>Mark a cipher as a service implementation only usable by another cipher and never by a normal user of the kernel crypto API</p>
</blockquote>
<p>So this cipher is meant to be used only by other wrapper code in the Crypto API and not outside it. In practice this means, that the caller of the Crypto API needs to explicitly specify this flag, when requesting a particular cipher implementation, but <code>dm-crypt</code> does not do it, because by design it is not part of the Linux Crypto API, rather an &quot;external&quot; user. We already patch the <code>dm-crypt</code> module, so we could as well just add the relevant flag. However, there is another problem with <a href="https://en.wikipedia.org/wiki/AES_instruction_set">AES-NI</a> in particular: <a href="https://en.wikipedia.org/wiki/X87">x86 FPU</a>. &quot;Floating point&quot; you say? Why do we need floating point math to do symmetric encryption which should only be about bit shifts and XOR operations? We don't need the math, but AES-NI instructions use some of the CPU registers, which are dedicated to the FPU. Unfortunately the Linux kernel <a href="https://github.com/torvalds/linux/blob/fb33c6510d5595144d585aa194d377cf74d31911/arch/x86/kernel/fpu/core.c#L77">does not always preserve these registers in interrupt context</a> for performance reasons (saving/restoring FPU is expensive). But <code>dm-crypt</code> may execute code in interrupt context, so we risk corrupting some other process data and we go back to &quot;it would be very unwise to do decryption in an interrupt context&quot; statement in the original code.</p>
<p>Our solution to address the above was to create another somewhat <a href="https://github.com/cloudflare/linux/blob/master/patches/0024-Add-xtsproxy-Crypto-API-module.patch">&quot;smart&quot; Crypto API module</a>. This module is synchronous and does not roll its own crypto, but is just a &quot;router&quot; of encryption requests:</p>
<ul>
<li>if we can use the FPU (and thus AES-NI) in the current execution context, we just forward the encryption request to the faster, &quot;internal&quot; <code>__xts-aes-aesni</code> implementation (and we can use it here, because now we are part of the Crypto API)</li>
<li>otherwise, we just forward the encryption request to the slower, generic C-based <code>xts(ecb(aes-generic))</code> implementation</li>
</ul>
<h4 id="usingthewholelot">Using the whole lot</h4>
<p>Let's walk through the process of using it all together. The first step is to <a href="https://github.com/cloudflare/linux/blob/master/patches/">grab the patches</a> and recompile the kernel (or just compile <code>dm-crypt</code> and our <code>xtsproxy</code> modules).</p>
<p>Next, let's restart our IO workload in a separate terminal, so we can make sure we can reconfigure the kernel at runtime under load:</p>
<pre><code class="language-bash">$ sudo fio --filename=/dev/mapper/encrypted-ram0 --readwrite=readwrite --bs=4k --direct=1 --loops=1000000 --name=crypt
crypt: (g=0): rw=rw, bs=4K-4K/4K-4K/4K-4K, ioengine=psync, iodepth=1
fio-2.16
Starting 1 process
...
</code></pre>
<p>In the main terminal make sure our new Crypto API module is loaded and available:</p>
<pre><code class="language-bash">$ sudo modprobe xtsproxy
$ grep -A 11 'xtsproxy' /proc/crypto
driver       : xts-aes-xtsproxy
module       : xtsproxy
priority     : 0
refcnt       : 0
selftest     : passed
internal     : no
type         : skcipher
async        : no
blocksize    : 16
min keysize  : 32
max keysize  : 64
ivsize       : 16
chunksize    : 16
</code></pre>
<p>Reconfigure the encrypted disk to use our newly loaded module and enable our patched <code>dm-crypt</code> flag (we have to use low-level <code>dmsetup</code> tool as <code>cryptsetup</code> obviously is not aware of our modifications):</p>
<pre><code class="language-bash">$ sudo dmsetup table encrypted-ram0 --showkeys | sed 's/aes-xts-plain64/capi:xts-aes-xtsproxy-plain64/' | sed 's/$/ 1 force_inline/' | sudo dmsetup reload encrypted-ram0
</code></pre>
<p>We just &quot;loaded&quot; the new configuration, but for it to take effect, we need to suspend/resume the encrypted device:</p>
<pre><code class="language-bash">$ sudo dmsetup suspend encrypted-ram0 &amp;&amp; sudo dmsetup resume encrypted-ram0
</code></pre>
<p>And now observe the result. We may go back to the other terminal running the <code>fio</code> job and look at the output, but to make things nicer, here's a snapshot of the observed read/write throughput in <a href="https://grafana.com/">Grafana</a>:</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/read-throughput-annotated.png" alt="read-throughput-annotated"><br>
<img src="https://blog.cloudflare.com/content/images/2020/03/write-throughput-annotated.png" alt="write-throughput-annotated"></p>
<p>Wow, we have more than doubled the throughput! With the total throughput of <code>~640 MB/s</code> we're now much closer to the expected <code>~696 MB/s</code> from above.  What about the IO latency? (The <code>await</code> statistic from the <a href="http://man7.org/linux/man-pages/man1/iostat.1.html">iostat reporting tool</a>):</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/await-annotated.png" alt="await-annotated"></p>
<p>The latency has been cut in half as well!</p>
<h4 id="toproduction">To production</h4>
<p>So far we have been using a synthetic setup with some parts of the full production stack missing, like file systems, real hardware and most importantly, production workload. To ensure we’re not optimising imaginary things, here is a snapshot of the production impact these changes bring to the caching part of our stack:</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/prod.png" alt="prod"></p>
<p>This graph represents a three-way comparison of the worst-case response times (99th percentile) for a <a href="https://blog.cloudflare.com/how-we-scaled-nginx-and-saved-the-world-54-years-every-day/">cache hit in one of our servers</a>. The green line is from a server with unencrypted disks, which we will use as baseline. The red line is from a server with encrypted disks with the default Linux disk encryption implementation and the blue line is from a server with encrypted disks and our optimisations enabled. As we can see the default Linux disk encryption implementation has a significant impact on our cache latency in worst case scenarios, whereas the patched implementation is indistinguishable from not using encryption at all. In other words the improved encryption implementation does not have any impact at all on our cache response speed, so we basically get it for free! That’s a win!</p>
<h3 id="werejustgettingstarted">We're just getting started</h3>
<p>This post shows how an architecture review can double the performance of a system. Also we <a href="https://blog.cloudflare.com/how-expensive-is-crypto-anyway/">reconfirmed that modern cryptography is not expensive</a> and there is usually no excuse not to protect your data.</p>
<p>We are going to submit this work for inclusion in the main kernel source tree, but most likely not in its current form. Although the results look encouraging we have to remember that Linux is a highly portable operating system: it runs on powerful servers as well as small resource constrained IoT devices and on <a href="https://blog.cloudflare.com/arm-takes-wing/">many other CPU architectures</a> as well. The current version of the patches just optimises disk encryption for a particular workload on a particular architecture, but Linux needs a solution which runs smoothly everywhere.</p>
<p>That said, if you think your case is similar and you want to take advantage of the performance improvements now, you may <a href="https://github.com/cloudflare/linux/blob/master/patches/">grab the patches</a> and hopefully provide feedback. The runtime flag makes it easy to toggle the functionality on the fly and a simple A/B test may be performed to see if it benefits any particular case or setup. These patches have been running across our <a href="https://www.cloudflare.com/network/">wide network of more than 200 data centres</a> on five generations of hardware, so can be reasonably considered stable. Enjoy both performance and security from Cloudflare for all!</p>
<p><img src="https://blog.cloudflare.com/content/images/2020/03/perf-sec.png" alt="perf-sec"></p>
<h3 id="updateoctober112020">Update (October 11, 2020)</h3>
<p>The main patch from this blog (in a slightly updated form) has been <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/md/dm-crypt.c?id=39d42fa96ba1b7d2544db3f8ed5da8fb0d5cb877">merged</a> into mainline Linux kernel and is available since version 5.9 and onwards. The main difference is the mainline version exposes two flags instead of one, which provide the ability to bypass dm-crypt workqueues for reads and writes independently. For details, see <a href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html">the official dm-crypt documentation</a>.</p>
<!--kg-card-end: markdown-->
            </div>
        </section>

        <a href="/tag/linux/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Linux</a>
        <a href="/tag/kernel/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Kernel</a>
        <a href="/tag/crypto/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Crypto</a>
        <a href="/tag/performance/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Performance</a>
        <a href="/tag/security/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2">Security</a>
    </article>
</main>

<div class="pv4 flex flex-row flex-wrap mw7 center">
    <div class="w-100 ph3 bt b--gray8">
        <p class="orange fw5 f4 mt4 ttu">Related Posts</p>
    </div>

    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2021-03-02T12:00:00Z">March 02, 2021 12:00PM</p>
        <a href="/how-to-execute-an-object-file-part-1/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">How to execute an object file: Part 1</h2>
        </a>

        <p class="gray1 lh-copy">Ever wondered if it is possible to execute an object file without linking? Or use any object file as a library? Follow along to learn how to decompose an object file and import code from it along the way....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/ignat/" class="fw5 f2 black no-underline">Ignat Korchagin</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/compiler/" class="no-underline f1 fw2 blue3 underline-hover">Compiler</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/programming/" class="no-underline f1 fw2 blue3 underline-hover">Programming</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/software/" class="no-underline f1 fw2 blue3 underline-hover">Software</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2020-07-08T12:00:00+01:00">July 08, 2020 12:00PM</p>
        <a href="/sandboxing-in-linux-with-zero-lines-of-code/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">Sandboxing in Linux with zero lines of code</h2>
        </a>

        <p class="gray1 lh-copy">In this post we will review Linux seccomp and learn how to sandbox any (even a proprietary) application without writing a single line of code....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/ignat/" class="fw5 f2 black no-underline">Ignat Korchagin</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/security/" class="no-underline f1 fw2 blue3 underline-hover">Security</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2019-07-10T14:07:21+01:00">July 10, 2019 2:07PM</p>
        <a href="/a-gentle-introduction-to-linux-kernel-fuzzing/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">A gentle introduction to Linux Kernel fuzzing</h2>
        </a>

        <p class="gray1 lh-copy">For some time I’ve wanted to play with coverage-guided fuzzing. I decided to have a go at the Linux Kernel netlink machinery.  It's a good target: it's an obscure part of kernel, and it's relatively easy to automatically craft valid messages....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/marek-majkowski/" class="fw5 f2 black no-underline">Marek Majkowski</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/kernel/" class="no-underline f1 fw2 blue3 underline-hover">Kernel</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive</a>
        </div>
    </article>
    <article class="w-100 w-100-m w-50-l ph3 mb4">
        <p class="f3 fw5 gray5" data-iso-date="2019-04-24T19:21:59+01:00">April 24, 2019 7:21PM</p>
        <a href="/xdpcap/" class="no-underline gray1 f4 fw5">
            <h2 class="gray1 f4 fw5 mt2">xdpcap: XDP Packet Capture</h2>
        </a>

        <p class="gray1 lh-copy">Our servers process a lot of network packets, be it legitimate traffic or large denial of service attacks. To do so efficiently, we’ve embraced eXpress Data Path (XDP), a Linux kernel technology that provides a high performance mechanism for low level packet processing....</p>
        <ul class="flex pl0 fw6 f2">
            <span>By&nbsp;</span>
            <li class="list flex items-center">
                <div class="author-name-tooltip">
                    
                    <a href="/author/arthur/" class="fw5 f2 black no-underline">Arthur Fabre</a>
                </div>
            </li>
        </ul>
        <div class="flex flex-row flex-wrap">
            
            <a href="/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>
            <span class="f1 fw2 blue3 no-underline underline-hover">,&nbsp;</span>
            <a href="/tag/programming/" class="no-underline f1 fw2 blue3 underline-hover">Programming</a>
        </div>
    </article>

</div>
<div class="pv4 ph3 mw7 center">
    <div id="disqus_thread"></div>
</div>



        <footer class="pt4 pb4 pl1 pr1 main-footer">
  <div class="mw8 center dn db-l ph3">
    <div class="flex flex-row justify-between">
      <div class="main-footer__menu-group">
        <ul id="sales-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="sales-menu"
            class="main-footer__menu-group__header js-toggle-footer-group f1">
            Sales
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/enterprise/contact/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="enterprise_sales"
              class="f1 blue3 no-underline underline-hover">
              Enterprise Sales
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/partners/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="become_a_partner" class="f1 blue3 no-underline underline-hover">
              Become a Partner
            </a>
          </li>
        </ul>
        <p class="phone f1 blue3 no-underline underline-hover">
          <p class="tel f1 blue3 no-underline underline-hover">Contact Sales:</p>
          <p><a data-i18n-phonenumber="" class="tel f1 blue3 no-underline underline-hover" href="tel:+18889935273">+1
              (888) 99 FLARE</a></p>

          <noscript><a class="phone f1 blue3 no-underline underline-hover" href="tel:+16503198930">+1 650 319
              8930</a></noscript>
        </p>
      </div>
      <div class="main-footer__menu-group">
        <ul id="getting-started-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="getting-started-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Getting Started
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/plans/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="plans" class="f1 blue3 no-underline underline-hover">
              Pricing
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/case-studies/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="case_studies" class="f1 blue3 no-underline underline-hover">
              Case Studies
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/resources/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="white_papers" class="f1 blue3 no-underline underline-hover">
              White Papers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/webinars/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover">
              Webinars
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/learning/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="learning_center" class="f1 blue3 no-underline underline-hover">
              Learning Center
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="community-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="community-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Community
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://community.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover">
              Community Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://blog.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="blog" class="f1 blue3 no-underline underline-hover">
              Blog
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/galileo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover">
              Project Galileo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/athenian/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover">
              Athenian Project
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.tv/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="tv" class="f1 blue3 no-underline underline-hover">
              Cloudflare TV
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="developers-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="developers-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Developers
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://developers.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="developer_hub" class="f1 blue3 no-underline underline-hover">
              Developer Hub
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/technical-resources/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="technical_resources"
              class="f1 blue3 no-underline underline-hover">
              Technical Resources
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/products/cloudflare-workers/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="cloudflare_workers"
              class="f1 blue3 no-underline underline-hover">
              Cloudflare Workers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/integrations/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="integrations" class="f1 blue3 no-underline underline-hover">
              Integrations
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="support-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="support-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Support
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://support.cloudflare.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="support" class="f1 blue3 no-underline underline-hover">
              Support
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://www.cloudflarestatus.com" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="status" class="f1 blue3 no-underline underline-hover">
              Cloudflare Status
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/compliance/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover">
              Compliance
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/gdpr/introduction/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover">
              GDPR
            </a>
          </li>
        </ul>
      </div>
      <div class="main-footer__menu-group">
        <ul id="company-menu" class="list pl0">
          <li class="pt1 pb1 f1" data-submenu="company-menu"
            class="main-footer__menu-group__header js-toggle-footer-group">
            Company
            <i class="icon-caret-down"></i>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/about-overview/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover">
              About Cloudflare
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/people/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover">
              Our Team
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/press/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="press" class="f1 blue3 no-underline underline-hover">
              Press
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/analysts/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="analysts" class="f1 blue3 no-underline underline-hover">
              Analysts
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/careers/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="careers" class="f1 blue3 no-underline underline-hover">
              Careers
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/internetsummit/" data-tracking-category="footer"
              data-tracking-action="click" data-tracking-label="internet_summit"
              class="f1 blue3 no-underline underline-hover">
              Internet Summit
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/logo/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="logo" class="f1 blue3 no-underline underline-hover">
              Logo
            </a>
          </li>
          <li class="pt1 pb1">
            <a href="https://cloudflare.com/network/" data-tracking-category="footer" data-tracking-action="click"
              data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover">
              Network Map
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="mw8 center ph3">
    <div class="flex flex-row flex-wrap justify-between pt4">
      <div class="flex flex-row items-start w-100 w-50-l pb4 pb0-l">
        <a target="_blank" rel="noopener" href="https://www.facebook.com/Cloudflare/" class="w-10"><img
            src="https://cloudflare.com/img/footer/facebook.svg" class="w-60"></a>
        <a target=" _blank" rel="noopener" href="https://twitter.com/Cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/twitter.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.linkedin.com/company/cloudflare-inc-" class="w-10"><img
            src="https://cloudflare.com/img/footer/linkedin.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.youtube.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/youtube.svg" class="w-60"></a>
        <a target="_blank" rel="noopener" href="https://www.instagram.com/cloudflare" class="w-10"><img
            src="https://cloudflare.com/img/footer/instagram.svg" class="w-60"></a>
      </div>
      <div class="w-100 w-50-l tr-l tl-ns">
        <div>
          <span class="main-footer__copyright f1">© 2020 Cloudflare, Inc.</span>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/privacypolicy/"
            class="main-footer__copyright f1 no-underline underline-hover">Privacy
            Policy</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/website-terms/"
            class="main-footer__copyright f1 no-underline underline-hover">Terms of Use</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/abuse/"
            class="main-footer__copyright f1 no-underline underline-hover">Trust &amp; Safety</a>
          <span class="main-footer__copyright f1">|</span>
          <a href="https://cloudflare.com/trademark/"
            class="main-footer__copyright f1 no-underline underline-hover">Trademark</a>
        </div>
      </div>
    </div>
  </div>
</footer>    </div>


    <script type="text/javascript" src="/assets/built/prism.js?v=fdf4009e30"></script>
<script type="text/javascript">
    var disqus_shortname = 'cloudflare';
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>

<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');
</script>
<script>(function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=596756540369391";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
</script>


    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PKQFGQB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script>
    var links = document.links;

    for (var i = 0, linksLength = links.length; i < linksLength; i++) {  
       if (links[i].hostname != window.location.hostname) {
           links[i].target = '_blank';
       } 
    } 
</script>

</body>

</html>