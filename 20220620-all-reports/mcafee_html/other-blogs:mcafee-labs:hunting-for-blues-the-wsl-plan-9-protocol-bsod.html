<!DOCTYPE html>
<html lang="en-US">

    <head>

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="profile" href="https://gmpg.org/xfn/11">
        <link rel="pingback" href="https://www.mcafee.com/xmlrpc.php">
                    <link rel="canonical" href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/">
                            <link rel="shortcut icon" href="https://www.mcafee.com/enterprise/en-us/img/favicon.ico">
        <!--<link rel="stylesheet" href="/wp-content/themes/securingtomorrow/css/responsive/blog.css" type="text/css">
        <link rel="stylesheet" href="/wp-content/themes/securingtomorrow/css/responsive/main.css" type="text/css">-->
        <link rel="stylesheet" href="/enterprise/www/css/main.min.css" type="text/css">
       
        	<script type="text/javascript">function theChampLoadEvent(e){var t=window.onload;if(typeof window.onload!="function"){window.onload=e}else{window.onload=function(){t();e()}}}</script>
		<script type="text/javascript">var theChampDefaultLang = 'en_US', theChampCloseIconPath = 'https://www.mcafee.com/wp-content/plugins/super-socializer/images/close.png';</script>
		<script> var theChampSiteUrl = 'https://www.mcafee.com/blogs', theChampVerified = 0, theChampEmailPopup = 0; </script>
		<style type="text/css">.the_champ_horizontal_sharing .theChampSharing{
					color: #fff;
				border-width: 0px;
		border-style: solid;
		border-color: transparent;
	}
		.the_champ_horizontal_sharing .theChampTCBackground{
		color:#666;
	}
		.the_champ_horizontal_sharing .theChampSharing:hover{
				border-color: transparent;
	}
	.the_champ_vertical_sharing .theChampSharing{
					color: #fff;
				border-width: 0px;
		border-style: solid;
		border-color: transparent;
	}
		.the_champ_vertical_sharing .theChampTCBackground{
		color:#666;
	}
		.the_champ_vertical_sharing .theChampSharing:hover{
				border-color: transparent;
	}
	@media screen and (max-width:783px){.the_champ_vertical_sharing{display:none!important}}div.heateor_ss_mobile_footer{display:none;}@media screen and (max-width:783px){i.theChampTCBackground{background-color:white!important}div.the_champ_bottom_sharing{width:100%!important;left:0!important;}div.the_champ_bottom_sharing li{width:12.5% !important;}div.the_champ_bottom_sharing .theChampSharing{width: 100% !important;}div.the_champ_bottom_sharing div.theChampTotalShareCount{font-size:1em!important;line-height:28px!important}div.the_champ_bottom_sharing div.theChampTotalShareText{font-size:.7em!important;line-height:0px!important}div.heateor_ss_mobile_footer{display:block;height:40px;}.the_champ_bottom_sharing{padding:0!important;display:block!important;width: auto!important;bottom:-2px!important;top: auto!important;}.the_champ_bottom_sharing .the_champ_square_count{line-height: inherit;}.the_champ_bottom_sharing .theChampSharingArrow{display:none;}.the_champ_bottom_sharing .theChampTCBackground{margin-right: 1.1em !important}}</style>
	
	<!-- This site is optimized with the Yoast SEO plugin v14.2 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Hunting for Blues - the WSL Plan 9 Protocol BSOD | McAfee Blogs</title>
	<meta name="description" content="Windows Subsystem for Linux Plan 9 Protocol Research Overview This is the final blog in the McAfee research series trilogy on the Windows Subsystem for" />
	<meta name="robots" content="index, follow" />
	<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Hunting for Blues - the WSL Plan 9 Protocol BSOD | McAfee Blogs" />
	<meta property="og:description" content="Windows Subsystem for Linux Plan 9 Protocol Research Overview This is the final blog in the McAfee research series trilogy on the Windows Subsystem for" />
	<meta property="og:url" content="/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/" />
	<meta property="og:site_name" content="McAfee Blogs" />
	<meta property="article:publisher" content="https://www.facebook.com/mcafee" />
	<meta property="article:published_time" content="2020-07-23T14:53:58+00:00" />
	<meta property="og:image" content="https://www.mcafee.com/wp-content/uploads/2020/02/iStock-954683756-min-1.jpg" />
	<meta property="og:image:width" content="1920" />
	<meta property="og:image:height" content="1280" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:creator" content="@w3knight" />
	<meta name="twitter:site" content="@mcafee" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://www.mcafee.com/blogs/#website","url":"https://www.mcafee.com/blogs/","name":"McAfee Blogs","description":"Securing Tomorrow. Today.","potentialAction":[{"@type":"SearchAction","target":"https://www.mcafee.com/blogs/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/#primaryimage","inLanguage":"en-US","url":"/wp-content/uploads/2020/02/iStock-954683756-min-1.jpg","width":1920,"height":1280},{"@type":"WebPage","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/#webpage","url":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/","name":"Hunting for Blues - the WSL Plan 9 Protocol BSOD | McAfee Blogs","isPartOf":{"@id":"https://www.mcafee.com/blogs/#website"},"primaryImageOfPage":{"@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/#primaryimage"},"datePublished":"2020-07-23T14:53:58+00:00","dateModified":"2020-07-23T14:53:58+00:00","author":{"@id":"https://www.mcafee.com/blogs/#/schema/person/6e361f03260be663c75dcf535cf8594d"},"description":"Windows Subsystem for Linux Plan 9 Protocol Research Overview This is the final blog in the McAfee research series trilogy on the Windows Subsystem for","breadcrumb":{"@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/"]}]},{"@type":"BreadcrumbList","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/blogs/","url":"/blogs/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/","url":"/blogs/other-blogs/","name":"Other Blogs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/mcafee-labs/","url":"/blogs/other-blogs/mcafee-labs/","name":"McAfee Labs"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/","url":"/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/","name":"Hunting for Blues &#8211; the WSL Plan 9 Protocol BSOD"}}]},{"@type":["Person"],"@id":"https://www.mcafee.com/blogs/#/schema/person/6e361f03260be663c75dcf535cf8594d","name":"Eoin Carroll","description":"Eoin Carroll is a Principal Engineer and Senior Vulnerability Researcher on the McAfee Advanced Threat Research team, focused on researching the trustworthiness of emerging computing platforms and protocols. He also analyzes critical industry vulnerabilities and innovates advanced threat defenses. He has 20 years of diverse experience, from electronic engineering to a variety of offensive and defensive security roles. For the first decade of his career he worked as an electronic engineer in both the semiconductor and medical device industries, gaining a wealth of engineering and risk experience. During the second decade he has been building his career in platform security through Product Security, reverse engineering critical industry vulnerabilities and designing exploit protections. In addition, he has lead Product Security teams, mentored many Product Security Engineers/Architects, supported local universities to keep their security curriculum relevant to industry needs and regularly speaks at universities and STEM events to inspire the next generation of security talent. He is very passionate about analyzing the security models of emerging platforms and protocols against the current and future threat landscape. His work experience includes threat modeling, secure platform design, memory forensics, vulnerability and exploit analysis, reverse engineering, product engineering, operating system internals and incident response.","sameAs":["https://www.linkedin.com/in/eoin-carroll-641ba08/","https://twitter.com/w3knight"]}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//stackpath.bootstrapcdn.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="McAfee Blogs &raquo; Feed" href="https://www.mcafee.com/blogs/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.4.2"}};
			/*! This file is auto-generated */
			!function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='/wp-includes/css/dist/block-library/style.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_poll_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/poll/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_trivia_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/trivia/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_personality_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/personality/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_survey_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/survey/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_slideshow_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/slideshow/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_form_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/form/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='mpp_gutenberg-css'  href='/wp-content/plugins/metronet-profile-picture/dist/blocks.style.build.css?ver=2.3.8' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='/wp-includes/css/dashicons.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpmm_css-css'  href='/wp-content/plugins/wp-megamenu/assets/css/wpmm.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp_megamenu_generated_css-css'  href='/wp-content/uploads/wp-megamenu/wp-megamenu.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='featuresbox_css-css'  href='/wp-content/plugins/wp-megamenu/addons/wpmm-featuresbox/wpmm-featuresbox.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='postgrid_css-css'  href='/wp-content/plugins/wp-megamenu/addons/wpmm-gridpost/wpmm-gridpost.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-bootstrap-pro-fontawesome-cdn-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='open-sans-google-font-css'  href='https://fonts.googleapis.com/css?family=Open+Sans%3A300%2C400&#038;ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='theme-css-css'  href='/wp-content/themes/securingtomorrow/style.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='the_champ_frontend_css-css'  href='/wp-content/plugins/super-socializer/css/front.css?ver=7.12.37' type='text/css' media='all' />
<link rel='stylesheet' id='addtoany-css'  href='/wp-content/plugins/add-to-any/addtoany.min.css?ver=1.15' type='text/css' media='all' />
<link rel='stylesheet' id='poppins-css'  href='//fonts.googleapis.com/css?family=Poppins%3A100%2C100italic%2C200%2C200italic%2C300%2C300italic%2Cregular%2Citalic%2C500%2C500italic%2C600%2C600italic%2C700%2C700italic%2C800%2C800italic%2C900%2C900italic&#038;ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='oswald-css'  href='//fonts.googleapis.com/css?family=Oswald%3A200%2C300%2Cregular%2C500%2C600%2C700&#038;ver=1.3.1' type='text/css' media='all' />
<script type='text/javascript' src='/wp-content/plugins/jquery-updater/js/jquery-3.4.1.min.js?ver=3.4.1'></script>
<script type='text/javascript' src='/wp-content/plugins/add-to-any/addtoany.min.js?ver=1.1'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/addons/wpmm-featuresbox/wpmm-featuresbox.js?ver=1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var postgrid_ajax_load = {"ajax_url":"https:\/\/www.mcafee.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/addons/wpmm-gridpost/wpmm-gridpost.js?ver=1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/html5.js?ver=3.7.0'></script>
<![endif]-->
<link rel='https://api.w.org/' href='https://www.mcafee.com/blogs/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.mcafee.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.mcafee.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.2" />
<link rel='shortlink' href='https://www.mcafee.com/blogs/?p=102882' />
<link rel="alternate" type="application/json+oembed" href="https://www.mcafee.com/blogs/wp-json/oembed/1.0/embed?url=%2Fblogs%2Fother-blogs%2Fmcafee-labs%2Fhunting-for-blues-the-wsl-plan-9-protocol-bsod%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://www.mcafee.com/blogs/wp-json/oembed/1.0/embed?url=%2Fblogs%2Fother-blogs%2Fmcafee-labs%2Fhunting-for-blues-the-wsl-plan-9-protocol-bsod%2F&#038;format=xml" />

<script data-cfasync="false">
window.a2a_config=window.a2a_config||{};a2a_config.callbacks=[];a2a_config.overlays=[];a2a_config.templates={};
(function(d,s,a,b){a=d.createElement(s);b=d.getElementsByTagName(s)[0];a.async=1;a.src="https://static.addtoany.com/menu/page.js";b.parentNode.insertBefore(a,b);})(document,"script");
</script>
<script>
var utag_data = {
tm_global_pagename:"",
tm_global_page_publish_date:"",
tm_global_businessunit:"consumer",
tm_global_sitesection:"",
tm_global_sitesection_level2:"",
tm_global_sitesection_level3:"",
tm_global_platform:"web",
tm_global_culture_code:"en-us",
tm_global_country:"united states",
tm_global_geo:"na",
tm_global_channel:"direct",
tm_global_affiliate_id:"",
tm_global_affiliate_name:"",
tm_global_campaign_id:"",
tm_global_page_version:"",
tm_global_pageurl:location.href,
tm_global_clientid :"",
tm_global_trafficsource:"",
tm_global_sourcetype:"blog",
tm_global_wssversion:"",
tm_global_coe:"",
tm_global_coe_level2:"",
tm_local_blogs_author:""
}
var sec=location.pathname.replace("/blogs","").split("/"); utag_data.tm_global_pagename="[consumer:web]";
if(sec.length > 2) {
for(i=1;i<sec.length-1;i++) {
utag_data.tm_global_pagename+="|"+sec[i];
if(i==1){utag_data.tm_global_sitesection=sec[i]}
if(i==2){utag_data.tm_global_sitesection_level2=sec[i]}
if(i==3){utag_data.tm_global_sitesection_level3=sec[i]}
}
}
else {
utag_data.tm_global_sitesection="Homepage"
utag_data.tm_global_pagename+="|Homepage"
}

var today = new Date(); var dd = today.getDate(); var mm = today.getMonth() + 1; var yyyy = today.getFullYear();
if (dd < 10) { dd = '0' + dd;    } 
if (mm < 10) {mm = '0' + mm;  } 
utag_data.tm_global_page_publish_date = dd + '/' + mm + '/' + yyyy;

</script>

<script>
	var ISOTOPE_CACHE 				=  [];
	var ISOTOPE_AJAX_URL 			= 'https://www.mcafee.com/wp-admin/admin-ajax.php';
	var ISOTOPE_AJAX_URL_ENDPOINT 	= 'https://www.mcafee.com/wp-content/plugins/ae-isotope/endpoint.php';
	var ISOTOPE_AJAX_ITEMS			= 25;
	var ISOTOPE_CURRENT_CATEGORY	= '';
</script>		<meta property="fb:app_id" content="346056175795920" />
					<meta property="fb:admins" content="100007220654854" />
			<style type="text/css">.wp-megamenu-wrap .wpmm-nav-wrap > ul.wp-megamenu li.wpmm_dropdown_menu ul.wp-megamenu-sub-menu li.menu-item-has-children.wp-megamenu-item-101284.wpmm-submenu-right > ul.wp-megamenu-sub-menu {left: 100%;}</style><style type="text/css"></style><link rel="icon" href="/wp-content/uploads/2018/11/cropped-favicon-32x32.png" sizes="32x32" />
<link rel="icon" href="/wp-content/uploads/2018/11/cropped-favicon-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="/wp-content/uploads/2018/11/cropped-favicon-180x180.png" />
<meta name="msapplication-TileImage" content="/wp-content/uploads/2018/11/cropped-favicon-270x270.png" />
         <link rel="stylesheet" href="/enterprise/www/css/blog.css" type="text/css">
                <script type="text/javascript">
            var digitalData = {"page":{"pageInfo":{"pageName":"other-blogs:mcafee-labs:hunting-for-blues-the-wsl-plan-9-protocol-bsod","pageNameGlobal":"hunting-for-blues-the-wsl-plan-9-protocol-bsod","pageLanguage":"English","pageType":"","country":"us","geo":"NA","onsiteSearchTerm":"","onsiteSearchType":"","category":{"category":"other-blogs","subCategory1":"mcafee-labs"},"author":"Eoin Carroll","pubDate":"Jul 23, 2020","metaData":{"keywords":""}}},"user":{"userInfo":{"ip":"161.69.31.4"}}}        </script>
                <script type='application/ld+json'>{
            "@context": "http://schema.org",
            "@type": "Article",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://www.mcafee.com/blogs/other-blogs/mcafee-labs/hunting-for-blues-the-wsl-plan-9-protocol-bsod/"
            },
           "headline": "Hunting for Blues &#8211; the WSL Plan 9 Protocol BSOD",
            "image": ["https://www.mcafee.com/wp-content/uploads/2020/02/iStock-954683756-min-1.jpg"],	
            "datePublished": "2020-07-23",
            "dateModified": "Jul 23, 2020",
            "author": {
                "@type": "Person",           
                "name": ["Eoin Carroll"]            
            },
            "publisher": {
                "@type": "Organization",
                "name": "McAfee",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://www.mcafee.com/enterprise/en-us/img/logos/mcafee-logo.png"
                }
            },
            "description": "Windows Subsystem for Linux Plan 9 Protocol Research OverviewThis is the final blog in the McAfee research series trilogy on the Windows Subsystem for Linux (WSL) implementation – see The Twin Journey (part 1) and Knock, Knock–Who’s There (part 2). The previous research discussed file evasion attacks when the Microsoft"        
            }
        </script>
        <style>
            #wp-megamenu-blog>.wpmm-nav-wrap ul.wp-megamenu>li>a{
                color:#ffffff !important;
            }
        </style> 
    
    <script>!function(){function o(n,i){if(n&&i)for(var r in i)i.hasOwnProperty(r)&&(void 0===n[r]?n[r]=i[r]:n[r].constructor===Object&&i[r].constructor===Object?o(n[r],i[r]):n[r]=i[r])}try{var n=decodeURIComponent("%7B%20%22BW%22%3A%20%7B%20%22test_https%22%3A%20true%20%7D%20%7D");if(n.length>0&&window.JSON&&"function"==typeof window.JSON.parse){var i=JSON.parse(n);void 0!==window.BOOMR_config?o(window.BOOMR_config,i):window.BOOMR_config=i}}catch(r){window.console&&"function"==typeof window.console.error&&console.error("mPulse: Could not parse configuration",r)}}();</script>
                          <script>!function(a){var e="https://s.go-mpulse.net/boomerang/",t="addEventListener";if("False"=="True")a.BOOMR_config=a.BOOMR_config||{},a.BOOMR_config.PageParams=a.BOOMR_config.PageParams||{},a.BOOMR_config.PageParams.pci=!0,e="https://s2.go-mpulse.net/boomerang/";if(window.BOOMR_API_key="LXNDQ-3SP7Y-P3JVN-Y4HAH-VQNKC",function(){function n(e){a.BOOMR_onload=e&&e.timeStamp||(new Date).getTime()}if(!a.BOOMR||!a.BOOMR.version&&!a.BOOMR.snippetExecuted){a.BOOMR=a.BOOMR||{},a.BOOMR.snippetExecuted=!0;var i,_,o,r=document.createElement("iframe");if(a[t])a[t]("load",n,!1);else if(a.attachEvent)a.attachEvent("onload",n);r.src="javascript:void(0)",r.title="",r.role="presentation",(r.frameElement||r).style.cssText="width:0;height:0;border:0;display:none;",o=document.getElementsByTagName("script")[0],o.parentNode.insertBefore(r,o);try{_=r.contentWindow.document}catch(O){i=document.domain,r.src="javascript:var d=document.open();d.domain='"+i+"';void(0);",_=r.contentWindow.document}_.open()._l=function(){var a=this.createElement("script");if(i)this.domain=i;a.id="boomr-if-as",a.src=e+"LXNDQ-3SP7Y-P3JVN-Y4HAH-VQNKC",BOOMR_lstart=(new Date).getTime(),this.body.appendChild(a)},_.write("<bo"+'dy onload="document._l();">'),_.close()}}(),"".length>0)if(a&&"performance"in a&&a.performance&&"function"==typeof a.performance.setResourceTimingBufferSize)a.performance.setResourceTimingBufferSize();!function(){if(BOOMR=a.BOOMR||{},BOOMR.plugins=BOOMR.plugins||{},!BOOMR.plugins.AK){var e=""=="true"?1:0,t="",n="fb23dtlilz6gqycyd43a-f-2149442f1-clientnsv4-s.akamaihd.net",i={"ak.v":"30","ak.cp":"108209","ak.ai":parseInt("250743",10),"ak.ol":"0","ak.cr":5,"ak.ipv":4,"ak.proto":"http/1.1","ak.rid":"1a3af5d2","ak.r":30888,"ak.a2":e,"ak.m":"b","ak.n":"essl","ak.bpcip":"40.117.177.0","ak.cport":33484,"ak.gh":"23.201.31.149","ak.quicv":"","ak.tlsv":"tls1.3","ak.0rtt":"","ak.csrc":"-","ak.acc":"reno","ak.t":"1616387894","ak.ak":"hOBiQwZUYzCg5VSAfCLimQ==EHVbJva40BPdq+0AwArb+QNbkmEDOGTtPwKDUS64C7fncjj0oYPx5w57UuKaN+kUgn0h8+6YLhX6a/oKfLlhpFfKZxg0vttxWY1DJFyXrUUTq63pxSkC8v4CLUkV3Dy2Xr8sIUuLHbS2+e21EOj/9coy0UtbLne1rYDkA+Elf87aLqNnL1FX95xLq8nenenBwc2CCm3whf3uT+ojFSSMY8T7PAWTzeTDv+tcEOHEGP3kIYH2gHX2ljsaC7wiJ+1UErtD/YOZkdvpkA5bjlEWVPxzrE1QLCm4VRq6rq4r2x/H153JlT9iUpGxaKBJOZuQuCs22NXf711zZNyGglwHWk0iGmrBq71yHLe0m0AEBSbUhObrL0vAA0Ay0Ybmx/wI7WRLaojh6WpfUQY2e6fqLOKL8ATIse3tAOc8x6P5TME=","ak.pv":"141","ak.dpoabenc":""};if(""!==t)i["ak.ruds"]=t;var _={i:!1,av:function(e){var t="http.initiator";if(e&&(!e[t]||"spa_hard"===e[t]))i["ak.feo"]=void 0!==a.aFeoApplied?1:0,BOOMR.addVar(i)},rv:function(){var a=["ak.bpcip","ak.cport","ak.cr","ak.csrc","ak.gh","ak.ipv","ak.m","ak.n","ak.ol","ak.proto","ak.quicv","ak.tlsv","ak.0rtt","ak.r","ak.acc","ak.t"];BOOMR.removeVar(a)}};BOOMR.plugins.AK={akVars:i,akDNSPreFetchDomain:n,init:function(){if(!_.i){var a=BOOMR.subscribe;a("before_beacon",_.av,null,null),a("onbeacon",_.rv,null,null),_.i=!0}return this},is_complete:function(){return!0}}}}()}(window);</script></head>

    <body  class="post-template-default single single-post postid-102882 single-format-standard wp-megamenu" id="short-header">
        <script src="/wp-content/themes/securingtomorrow/js/header_enterprise.js"></script>
        <div id="wrapper">
            <div class="textwidget custom-html-widget"><style>
	.headerbarContainer {
    background: rgba(0,0,0,0.9);
}
</style>
<header id="header">  
	<div class="headerbarContainer">
		<div class="headerbarContent">
			<div class="logo">
				 <img src="https://www.mcafee.com/enterprise/en-us/img/icons/logo-white.svg" alt="McAfee Logo"/>
			</div>
			<div class="quicklinks">
			 	<a class="symbols-label" href="https://www.mcafee.com/consumer/en-us/store/m0/index.html"><span>For Home</span></a>
			 	<a class="symbols-label" href="/enterprise/en-us/home.html"><span>For Enterprise</span></a>
			 	<a class="symbols-label" href="/enterprise/en-us/global-contact-us.html"><i class="symbol-contact"></i></a>
			</div>
		</div>
	</div>
</header>



<style>


@media screen and (min-width: 1025px) {
.hero{height: 756px !important;}
.hero.medium {
    min-height: 0;
    height: 640px  !important;
}
.hero.small {
    min-height: 0;
    height: 510px  !important;
}
.hero.title {
    height: 350px  !important;
}
	}
</style> 
<script>
$("document").ready(function(){
    $(".hero.title h1").each(function() {
        if ($(this).text().length > 50) {
            $(this).addClass("pt")
        }
    });
});
</script></div>  
		
<section class="hero title">
    <div class="bg-stretch">
        <img src="https://www.mcafee.com/wp-content/themes/securingtomorrow/img/light-shield-pattern.png" alt="">
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12 col-xs-12">
                <h1>Hunting for Blues &#8211; the WSL Plan 9 Protocol BSOD</h1>
            </div>
        </div>
    </div>
</section>

<main id="main">

    <nav class="anchor-links">
        <div class="container medium">
            <div style="float:left">
<nav id="wp-megamenu-blog" class="wp-megamenu-wrap   ">
			<div class="wpmm-fullwidth-wrap"></div>
			<div class="wpmm-nav-wrap wpmm-main-wrap-blog">
				<a href="javascript:;" class="wpmm_mobile_menu_btn show-close-icon"><i class="fa fa-bars"></i> Menu</a> 
					<ul id="menu-mcafee-blog-navigation-new-05020" class="wp-megamenu" ><li id="wp-megamenu-item-101279" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101279  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Consumer <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-6275019198816702345" class="wpmm-row wp-megamenu-item-6275019198816702345 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-1.3980603369681E+19" class="wpmm-col wpmm-col-12 wp-megamenu-item-1.3980603369681E+19 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101279 wpmm-submenu-right"><div class="menu-consumer-category-container"><ul id="menu-consumer-category" class="menu"><li id="menu-item-97453" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97453"><a href="/blogs/consumer/hackable/">Hackable? Podcast</a></li>
<li id="menu-item-97424" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97424"><a href="/blogs/consumer/consumer-threat-notices/">Consumer Threat Notices</a></li>
<li id="menu-item-97425" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97425"><a href="/blogs/consumer/family-safety/">Family Safety</a></li>
<li id="menu-item-97426" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97426"><a href="/blogs/consumer/identity-protection/">Identity Protection</a></li>
<li id="menu-item-97427" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97427"><a href="/blogs/consumer/mobile-and-iot-security/">Mobile and IoT Security</a></li>
<li id="menu-item-101334" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101334"><a href="/blogs/consumer/">All Consumer Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101280" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101280  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Enterprise <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-758408335903549450" class="wpmm-row wp-megamenu-item-758408335903549450 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-8067790050113657729" class="wpmm-col wpmm-col-12 wp-megamenu-item-8067790050113657729 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101280 wpmm-submenu-right"><div class="menu-enterprise-category-container"><ul id="menu-enterprise-category" class="menu"><li id="menu-item-97421" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97421"><a href="/blogs/enterprise/cloud-security/">Cloud Security</a></li>
<li id="menu-item-97451" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97451"><a href="/blogs/enterprise/endpoint-security/">Endpoint Security</a></li>
<li id="menu-item-97422" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97422"><a href="/blogs/enterprise/security-operations/">Security Operations</a></li>
<li id="menu-item-97452" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97452"><a href="/blogs/enterprise/data-security/">Data Security</a></li>
<li id="menu-item-101336" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101336"><a href="/blogs/enterprise/">All Enterprise Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101281" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101281  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Corporate <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-804335598020716555" class="wpmm-row wp-megamenu-item-804335598020716555 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-9.6692707020947E+18" class="wpmm-col wpmm-col-12 wp-megamenu-item-9.6692707020947E+18 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101281 wpmm-submenu-right"><div class="menu-other-blogs-container"><ul id="menu-other-blogs" class="menu"><li id="menu-item-97442" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97442"><a href="/blogs/other-blogs/executive-perspectives/">Executive Perspectives</a></li>
<li id="menu-item-97441" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-97441"><a href="/blogs/other-blogs/mcafee-labs/">McAfee Labs</a></li>
<li id="menu-item-97443" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97443"><a href="/blogs/other-blogs/life-at-mcafee/">Life at McAfee</a></li>
<li id="menu-item-97440" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97440"><a href="/blogs/other-blogs/podcast/">Podcast</a></li>
<li id="menu-item-97444" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97444"><a href="/blogs/other-blogs/mcafee-partners/">McAfee Partners</a></li>
<li id="menu-item-101340" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-101340"><a href="/blogs/other-blogs/">All Corporate Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101282" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101282  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a href="/blogs/authors/">Authors</a></li>
<li id="wp-megamenu-item-101283" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101283  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a href="/blogs/subscribe/">Subscribe</a></li>
<li id="wp-megamenu-item-101284" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101284  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#"><span class='wpmm-selected-icon wpmm-selected-icon-left'><i class='fa fa-globe'></i></span> <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-17069737636391804" class="wpmm-row wp-megamenu-item-17069737636391804 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-2010916045606185459" class="wpmm-col wpmm-col-12 wp-megamenu-item-2010916045606185459 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101284 wpmm-submenu-right"><div class="menu-languages-category-container"><ul id="menu-languages-category" class="menu"><li id="menu-item-97433" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97433"><a href="/blogs/languages/italia/">Italia</a></li>
<li id="menu-item-97434" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97434"><a href="/blogs/languages/japanese/">日本語</a></li>
<li id="menu-item-97435" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97435"><a href="/blogs/languages/espanol/">Español</a></li>
<li id="menu-item-97436" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97436"><a href="/blogs/languages/francais/">Français</a></li>
<li id="menu-item-97437" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97437"><a href="/blogs/languages/german/">German</a></li>
<li id="menu-item-97438" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97438"><a href="/blogs/languages/portugues/">Português</a></li>
<li id="menu-item-101338" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101338"><a href="/blogs/languages/">All Language Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-" class="wpmm-social-link wpmm-social-link- wp-megamenu-item-  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a target="_blank" ><i class=""></i></a></li>
</ul>
			</div>
		</nav>            </div>
            <div class="anchors right">
                <form role="search" method="get" class="blog-search search-form" action="https://www.mcafee.com/blogs/">
                    <button type="submit" class="search-submit"><i class="symbol-arrow-forward"></i></button>
                    <input type="search" class="search-field" placeholder="Search Blogs" value="" name="s" />


                </form>  
            </div>

        </div>
    </nav>

    <div class="wrap-section padding-top-xs"> 
        <div class="container medium">
 
        <div class="breadcrumb-container theme1">
            <ul itemscope itemtype="http://schema.org/BreadcrumbList">
                
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Mcafee" href="/"><span itemprop="name">Mcafee</span></a><span class="separator">/</span><meta itemprop="position" content="1"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Home" href="https://www.mcafee.com/blogs"><span itemprop="name">Home</span></a><span class="separator">/</span><meta itemprop="position" content="2"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Other Blogs" href="/blogs/other-blogs/"><span itemprop="name">Other Blogs</span></a><span class="separator">/</span><meta itemprop="position" content="3"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="McAfee Labs" href="/blogs/other-blogs/mcafee-labs/"><span itemprop="name">McAfee Labs</span></a><span class="separator">/</span><meta itemprop="position" content="4"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Hunting for Blues 8211 the WSL Plan 9 Protocol BSOD" href="#"><span itemprop="name">Hunting for Blues 8211 the WSL Plan 9 Protocol BSOD</span></a><meta itemprop="position" content="5"></li>
                                   </ul>
        </div>
        <style type="text/css">
            .breadcrumb-container {
                font-size: 13px;
            }
            .breadcrumb-container ul {
                margin: 0;
                padding: 0;
            }
            .breadcrumb-container li {
                box-sizing: unset;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            .breadcrumb-container li a {
                box-sizing: unset;
                padding: 0 10px;
            }
            .breadcrumb-container {
                font-size: 12px  !important;
                padding: 0px;
                margin: 0px;
            }
            .breadcrumb-container li a{
                color:  #c01818  !important;
                font-size:  12px  !important;
                line-height:  12px  !important;
            }
            .breadcrumb-container li .separator {
                color: #53565a  !important;
                font-size:  12px  !important;
            }
                            .breadcrumb-container li:last-child .separator {
                    display: none;
                }
                
							
							
.breadcrumb-container.theme1 li {
	margin: 0;
	padding: 0;
}							
							
.breadcrumb-container.theme1 a {
	background: ;
	display: inline-block;
	margin: 0 5px;
	padding: 5px 10px;
	text-decoration: none;
}

.breadcrumb-container{}
.breadcrumb-container ul{}
.breadcrumb-container li{}
.breadcrumb-container a{}
.breadcrumb-container .separator{}
        </style>
                </div>		 
    </div>

    <div class="wrap-section padding-small article">  
        <div class="container medium"> 
            <div class="border-line"></div>

            <div class="author-block padding-bottom-xs">
                <img class="author" src="/wp-content/uploads/2019/03/Eoin-Carroll-Pic-1-300x300.jpg" />
                <div class="meta">By <a href="/blogs/author/eoin-carroll/" title="Posts by Eoin Carroll" class="author url fn" rel="author">Eoin Carroll</a> on Jul 23, 2020</div>
            </div>

                    <h2>Windows Subsystem for Linux Plan 9 Protocol Research Overview</h2>
<p>This is the final blog in the McAfee research series trilogy on the Windows Subsystem for Linux (WSL) implementation – see The Twin Journey (<a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/the-twin-journey-part-1/" target="_blank" rel="noopener noreferrer">part 1</a>) and Knock, Knock–Who’s There (<a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/knock-knock-whos-there/" target="_blank" rel="noopener noreferrer">part 2</a>). The previous research discussed file evasion attacks when the Microsoft P9 server can be hijacked with a malicious P9 (Plan 9 File System Protocol) server. Since Windows 10 version 1903, it is possible to access Linux files from Windows by using the P9 protocol. The Windows 10 operating system comes with the P9 server as part of the WSL install so that it can communicate with a Linux filesystem. In this research we explore the P9 protocol implementation within the Windows kernel and whether we could execute code in it from a malicious P9 server. We created a malicious P9 server by hijacking the Microsoft P9 server and replacing it with code we can control.</p>
<p>In a typical attack scenario, we discovered that if WSL is enabled on Windows 10, then a non-privileged local attacker can hijack the WSL P9 communication channel to cause a local Denial of Service (DoS) or Blue Screen of Death (BSOD) in the Windows kernel. It is not possible to achieve escalation of privilege (EoP) within the Windows kernel due to this vulnerability; the BSOD appears to be as designed by Microsoft within their legitimate fail flow, if malformed P9 server communication packets are received by the Windows kernel. A non-privileged user should not be able to BSOD the Windows kernel, from a local or remote perspective. If WSL is not enabled (disabled by default on Windows 10), the attack can still be executed but requires the attacker to be a privileged user to enable WSL as a pre-requisite.</p>
<p>There have recently been some critical, wormable protocol vulnerabilities within the <a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/rdp-stands-for-really-do-patch-understanding-the-wormable-rdp-vulnerability-cve-2019-0708/" target="_blank" rel="noopener noreferrer">RDP</a> and <a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/smbghost-analysis-of-cve-2020-0796/" target="_blank" rel="noopener noreferrer">SMB</a> protocols in the form of Bluekeep and SMBGhost. Remotely exploitable vulnerabilities are very high risk if they are wormable as they can spread across systems without any user interaction. Local vulnerabilities are lower risk since an attacker must first have a presence on the system; in this case they must have a malicious P9 server executing. The P9 protocol implementation runs locally within the Windows kernel so the objective, as with most local vulnerability hunting, is to find a vulnerability that allows an escalation of privilege (EoP).</p>
<p>In this blog we do a deep dive into the protocol implementation and vulnerability hunting process. There is no risk to WSL users from this research, which has been shared with and validated by Microsoft. We hope this research will help improve understanding of the WSL P9 communications stack and that additional research would be more fruitful further up the stack.</p>
<p>There have been some exploits on WSL such as <a href="https://recon.cx/2018/brussels/resources/slides/RECON-BRX-2018-Linux-Vulnerabilities_Windows-Exploits--Escalating-Privileges-with-WSL.pdf" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://www.youtube.com/watch?v=Ty5l9aslPlY" target="_blank" rel="noopener noreferrer">here</a> but there appears to be no documented research of the P9 protocol implementation other than <a href="https://tyranidslair.blogspot.com/2019/07/digging-into-wsl-p9-file-system.html" target="_blank" rel="noopener noreferrer">this</a>.</p>
<h2>P9 Protocol Overview</h2>
<p>The <a href="https://9fans.github.io/plan9port/man/man9/intro.html" target="_blank" rel="noopener noreferrer">Plan 9 File System Protocol</a> server allows a client to navigate its file system to create, remove, read and write files. The client sends requests (T-messages) to the server and the server responds with R-messages. The P9 protocol has a header consisting of size, type and tag fields which is followed by a message type field depending on the request from the client. The R-message type sent by the server must match the T-message type initiated from the client. The maximum connection size for the data transfer is decided by the client during connection setup; in our analysis below, it is 0x10000 bytes.</p>
<p>P9 protocol header followed by message type union (we have only included the subset of P9 message types which are of interest for vulnerability research):</p>
<table>
<tbody>
<tr>
<td width="276">struct P9Packet {</p>
<p>u32                         size;</p>
<p>u8                           type;</p>
<p>u16                         tag;</p>
<p>union {</p>
<p>struct p9_rversion rversion;</p>
<p>struct p9_rread rread;</p>
<p>struct p9_rreaddir rreaddir;</p>
<p>struct p9_rwalk rwalk;</p>
<p>} u</p>
<p>} P9Packet</td>
</tr>
</tbody>
</table>
<p>The P9 T-message and corresponding R-message numbers for the types we are interested in (the R-message is always T-message+1):</p>
<table>
<tbody>
<tr>
<td width="276">enum p9_msg_t {</p>
<p>P9_TREADDIR = 40,</p>
<p>P9_RREADDIR = 41,</p>
<p>P9_TVERSION = 100,</p>
<p>P9_RVERSION = 101,</p>
<p>P9_TWALK = 110,</p>
<p>P9_RWALK = 111,</p>
<p>P9_TREAD = 116,</p>
<p>P9_RREAD = 117,</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>At the message type layer, which follows the P9 protocol header, you can see the fields, which are of variable size, highlighted below:</p>
<table>
<tbody>
<tr>
<td width="300">struct p9_rwalk {</p>
<p>u16 <span style="color: #ff0000;">nwqid</span>;</p>
<p>struct p9_qid wqids[<span style="color: #ff0000;">P9_MAXWELEM</span>];</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="300">struct p9_rread {</p>
<p>u32 <span style="color: #ff0000;">count</span>;</p>
<p>u8 *<span style="color: #ff0000;">data</span>;</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="300">struct p9_rreaddir {</p>
<p>u32 <span style="color: #ff0000;">count</span>;</p>
<p>u8 *<span style="color: #ff0000;">data</span>;</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="300">struct p9_rversion {</p>
<p>u32 <span style="color: #ff0000;">msize</span>;</p>
<p>struct p9_str <span style="color: #ff0000;">version</span>;</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="300">struct p9_str {</p>
<p>u16 <span style="color: #ff0000;">len</span>;</p>
<p>char *<span style="color: #ff0000;">str</span>;</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>Based on the packet structure of the P9 protocol we need to hunt for message type confusion and memory corruption vulnerabilities such as out of bounds read/write.</p>
<p>So, what will a packet structure look like in memory? Figure 1 shows the protocol header and message type memory layout from WinDbg. The message size (msize) is negotiated to 0x10000 and the version string is “9P2000.W”.</p>
<p><img class="aligncenter size-full wp-image-102885" src="/wp-content/uploads/2020/07/fig-1.png" alt="" width="856" height="268" srcset="/wp-content/uploads/2020/07/fig-1.png 856w, /wp-content/uploads/2020/07/fig-1-300x94.png 300w, /wp-content/uploads/2020/07/fig-1-768x240.png 768w, /wp-content/uploads/2020/07/fig-1-205x64.png 205w" sizes="(max-width: 856px) 100vw, 856px" /></p>
<p><img class="aligncenter size-full wp-image-102918" src="/wp-content/uploads/2020/07/P9-packet.png" alt="" width="379" height="297" srcset="/wp-content/uploads/2020/07/P9-packet.png 379w, /wp-content/uploads/2020/07/P9-packet-300x235.png 300w, /wp-content/uploads/2020/07/P9-packet-165x129.png 165w" sizes="(max-width: 379px) 100vw, 379px" /></p>
<p style="text-align: center;"><strong>Figure 1</strong>. P9 packet for rversion message type</p>
<h2>Windows WSL P9 Communication Stack and Data Structures</h2>
<p><img class="aligncenter size-full wp-image-102891" src="/wp-content/uploads/2020/07/figure-2.png" alt="" width="779" height="474" srcset="/wp-content/uploads/2020/07/figure-2.png 779w, /wp-content/uploads/2020/07/figure-2-300x183.png 300w, /wp-content/uploads/2020/07/figure-2-768x467.png 768w, /wp-content/uploads/2020/07/figure-2-205x125.png 205w" sizes="(max-width: 779px) 100vw, 779px" /></p>
<p style="text-align: center;"><strong>Figure 2</strong>. Windows Plan 9 File System Protocol Implementation within WSL</p>
<p>The p9rdr.sys network mini-redirector driver registers the “\\Device\\P9Rdr” device with the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/the-rdbss-driver-and-library" target="_blank" rel="noopener noreferrer">Redirected Drive Buffering Subsystem</a> (RDBSS) using the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/mrx/nf-mrx-rxregisterminirdr" target="_blank" rel="noopener noreferrer">RxRegisterMinirdr</a> API as part of the p9rdr DriverEntry routine. During this registration, the following P9 APIs or driver routines are exposed to the RDBSS:</p>
<table>
<tbody>
<tr>
<td width="204">P9NotImplemented</p>
<p>P9Start</p>
<p>P9Stop</p>
<p>P9DevFcbXXXControlFile</p>
<p>P9CreateSrvCall</p>
<p>P9CreateVNetRoot</p>
<p>P9ExtractNetRootName</p>
<p>P9FinalizeSrvCall</p>
<p>P9FinalizeVNetRoot</p>
<p>P9Create</p>
<p>P9CheckForCollapsibleOpen</p>
<p>P9CleanupFobx</p>
<p>P9CloseSrvOpen</p>
<p>P9ForceClosed</p>
<p>P9ExtendFile</p>
<p>P9Flush</p>
<p>P9QueryDirectoryInfo</p>
<p>P9QueryVolumeInfo</p>
<p>P9QueryFileInfo</p>
<p>P9SetFileInfo</p>
<p>P9IsValidDirectory</p>
<p>P9Read</p>
<p>P9Write</td>
</tr>
</tbody>
</table>
<p>The p9rdr driver is not directly accessible from user mode using the DeviceIoControl API and all calls must go through the RDBSS.</p>
<p>As seen in Figure 2, when a user navigates to the WSL share at “\\wsl$” from Explorer, the RDBSS driver calls into the P9 driver through the previously registered APIs.</p>
<p><a href="https://github.com/chaos/diod" target="_blank" rel="noopener noreferrer">DIOD</a> is a file server implementation, that we modified to be a “malicious” P9 server, where we claim the “fsserver” socket name prior to the Windows OS in a form of squatting attack. Once we replaced the Microsoft P9 server with the DIOD server, we modified the “np_req_respond” function (explained in the fuzzing constraints section) so that we could control P9 packets to send malicious responses to the Windows kernel. Our malicious P9 server and socket hijacking have been explained in detail <a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/knock-knock-whos-there/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>So now we know how data travels from Explorer to the P9 driver but how does the P9 driver communicate with the malicious P9 server? They communicate over AF_UNIX sockets.</p>
<p>There are two important data structures used for controlling data flow within the P9 driver called P9Client and P9Exchange.</p>
<p>The P9Client and P9Exchange data structures, when reverse engineered to the fields relevant to this research, look like the following (fields not relevant to this analysis have been labelled as UINT64 for alignment):</p>
<table>
<tbody>
<tr>
<td width="246">typedef struct <strong>P9Client </strong>{<br />
PVOID * WskTransport_vftable<br />
PVOID * GlobalDevice<br />
UNINT64 RunRef<br />
WskSocket *WskData<br />
UINT64<br />
UINT64<br />
UINT_PTR<br />
PVOID *MidExchangeMgr_vftable<br />
PRDBSS_DEVICE_OBJECT *RDBSS<br />
UINT64<br />
PVOID **WskTransport_vftable<br />
PVOID **MidExchangeMgr_vftable<br />
P9Packet *P9PacketStart<br />
UINT64 MaxConnectionSize<br />
UINT64 Rmessage_size<br />
P9Packet *P9PacketEnd<br />
UINT_PTR<br />
UINT64<br />
UINT64<br />
UINT_PTR<br />
UINT64<br />
UINT64<br />
PVOID * Session_ReconnectCallback<br />
PVOID ** WskTransport_vftable<br />
UINT64<br />
UINT_PTR<br />
UINT_PTR<br />
UINT64<br />
UINT_PTR<br />
UINT64<br />
UINT64<br />
UINT64<br />
} <strong>P9Client</strong></td>
</tr>
</tbody>
</table>
<p>P9Client data structure memory layout in WinDbg:</p>
<p><img class="aligncenter size-full wp-image-102894" src="/wp-content/uploads/2020/07/figure-3.png" alt="" width="625" height="430" srcset="/wp-content/uploads/2020/07/figure-3.png 625w, /wp-content/uploads/2020/07/figure-3-300x206.png 300w, /wp-content/uploads/2020/07/figure-3-188x129.png 188w" sizes="(max-width: 625px) 100vw, 625px" /></p>
<table>
<tbody>
<tr>
<td width="246">typedef struct <strong>P9Exchange </strong>{<br />
UINT64<br />
UINT64<br />
P9Client *P9Client<br />
UINT64 Tmessage_type<br />
UINT64<br />
UINT_PTR<br />
PVOID *Lambda_PTR1<br />
PVOID *Lambda_PTR2<br />
PRX_CONTEXT *RxContextUINT64 Tmessage_size<br />
UINT64<br />
UINT64<br />
UINT64<br />
UINT64<br />
UINT64<br />
UINT64<br />
} <strong>P9Exchange</strong></td>
</tr>
</tbody>
</table>
<p>The P9Exchange data structure layout in WinDbg:</p>
<p><img class="aligncenter size-full wp-image-102897" src="/wp-content/uploads/2020/07/figure-4.png" alt="" width="996" height="231" srcset="/wp-content/uploads/2020/07/figure-4.png 996w, /wp-content/uploads/2020/07/figure-4-300x70.png 300w, /wp-content/uploads/2020/07/figure-4-768x178.png 768w, /wp-content/uploads/2020/07/figure-4-205x48.png 205w" sizes="(max-width: 996px) 100vw, 996px" /></p>
<p>To communicate with the P9 server, the P9 driver creates an <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/i-o-request-packets" target="_blank" rel="noopener noreferrer">I/O request packet</a> (IRP) to receive data from the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/introduction-to-winsock-kernel" target="_blank" rel="noopener noreferrer">Winsock Kernel</a> (WSK). An important point to note is that the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/using-mdls" target="_blank" rel="noopener noreferrer">Memory Descriptor List</a> (MDL) used to hold the data passed between the P9 server and Windows kernel P9 client is 0x10000 bytes (the max connection size mentioned earlier).</p>
<table width="684">
<tbody>
<tr>
<td width="684">virtual long WskTransport::Receive(){</p>
<p>UNINT64 <strong>MaxConnectionSize = 0x10000</strong>;</p>
<p>P9_IRP_OBJECT = RxCeAllocateIrpWithMDL(2, 0, 0i64);</p>
<p>P9_MDL = IoAllocateMdl(<strong>P9Client-&gt;P9PacketStart</strong>, MaxConnectionSize, 0, 0, 0i64);<br />
void MmBuildMdlForNonPagedPool(P9_MDL);<br />
P9_IRP_OBJECT-&gt;IoStackLocation-&gt;Parameters-&gt;MDL = &amp;P9_MDL;</p>
<p>P9_IRP_OBJECT-&gt;IoStackLocation-&gt;Parameters-&gt;P9Client = &amp;P9Client;</p>
<p>P9_IRP_OBJECT-&gt;IoStackLocation-&gt;Parameters-&gt;DataPath = &amp;P9Client::ReceiveCallback;<br />
P9_IRP_OBJECT-&gt;IoStackLocation-&gt;CompletionRoutine = p9fs::WskTransport::SendReceiveComplete<br />
WskProAPIReceive (*WskSocket, *P9_MDL, 0, *P9_IRP_OBJECT);<br />
}</td>
</tr>
</tbody>
</table>
<p>The MDL is mapped to the P9PacketStart field address within the P9Client data structure.</p>
<p><img class="aligncenter size-full wp-image-102900" src="/wp-content/uploads/2020/07/figure-5.png" alt="" width="432" height="152" srcset="/wp-content/uploads/2020/07/figure-5.png 432w, /wp-content/uploads/2020/07/figure-5-300x106.png 300w, /wp-content/uploads/2020/07/figure-5-205x72.png 205w" sizes="(max-width: 432px) 100vw, 432px" /></p>
<p><img class="aligncenter size-full wp-image-102903" src="/wp-content/uploads/2020/07/figure-6.png" alt="" width="293" height="228" srcset="/wp-content/uploads/2020/07/figure-6.png 293w, /wp-content/uploads/2020/07/figure-6-166x129.png 166w" sizes="(max-width: 293px) 100vw, 293px" /></p>
<p>On IRP completion, the WskTransport::SendReceiveComplete completion routine is called to retrieve the P9Client structure from the IRP to process the P9 packet response from the server:</p>
<table>
<tbody>
<tr>
<td width="623">int static WskTransport::SendreceiveComplete(IRP *P9_IRP_OBJECT){</p>
<p>P9Client = &amp;P9_IRP_OBJECT-&gt;IoStackLocation-&gt;Parameters-&gt;P9Client;</p>
<p>P9Client::ReceiveCallback(P9Client* P9Client);</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>The P9Client data structure is used within an IRP to receive the R-message data but what is the purpose of the P9Exchange data structure?</p>
<ol>
<li>When the P9 driver sends a T-message to the server, it must create an exchange so that it can track the state between the message type sent (T-message) and that returned by the server (R-Message).</li>
<li>It contains lambda functions to execute on the specific message type. The Tmessage_type field within the P9Exchange data structure ensures that the server can only send R-messages to the same T-message type it received from the P9 driver.</li>
<li>PRX_CONTEXT * RxContext structure is used to transfer data between Explorer and the p9rdr driver via the RDBSS driver.</li>
</ol>
<p>The flow of a WALK T-message can be seen below:</p>
<p><img class="aligncenter size-full wp-image-102906" src="/wp-content/uploads/2020/07/figure-7.png" alt="" width="403" height="175" srcset="/wp-content/uploads/2020/07/figure-7.png 403w, /wp-content/uploads/2020/07/figure-7-300x130.png 300w, /wp-content/uploads/2020/07/figure-7-205x89.png 205w" sizes="(max-width: 403px) 100vw, 403px" /></p>
<p>Within the P9Client::CreateExchange function, the MidExchangeManager::RegisterExchange is responsible for registering the P9Exchange data structure with the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/midatlax/nf-midatlax-rxassociatecontextwithmid" target="_blank" rel="noopener noreferrer">RDBSS using a multiplex ID (MID)</a> to distinguish between concurrent server and client requests.</p>
<table>
<tbody>
<tr>
<td width="623">MidExchangeManager::RegisterExchange (*P9Client, *P9Exchange){</p>
<p>NTSTATUS RxAssociateContextWithMid (PRX_MID_ATLAS P9Client-&gt;RDBSS, PVOID P9Exchange, PUSHORT NewMid);</p>
<p>}</td>
</tr>
</tbody>
</table>
<p><strong>The important fields within the P9Client and P9Exchange data structures which we will discuss further during the analysis:</strong></p>
<ol>
<li>PClient-&gt;MaxConnectionSize – set at the start of the connection and cannot be controlled by an attacker</li>
<li>P9Client-&gt;P9PacketStart – points to P9 packet received and can be fully controlled by an attacker</li>
<li>P9Client-&gt;Rmessage_size –can be fully controlled by an attacker</li>
<li>P9Exchange-&gt;Tmessage_type – set during T-message creation and cannot be controlled by an attacker</li>
<li>P9Exchange-&gt;RxContext – used to pass data from P9 driver through the RDBSS to Explorer</li>
</ol>
<p>Now that we know how the protocol works within the Windows kernel, the next stage is vulnerability hunting.</p>
<h2>Windows Kernel P9 Server Vulnerability Hunting</h2>
<h3>P9 Packet Processing Logic</h3>
<p>From a vulnerability perspective we want to audit the Windows kernel logic within p9rdr.sys, responsible for parsing traffic from the malicious P9 server. Figure 3 shows the source of the P9 packet and the sink, or where the packet processing completes within the p9rdr driver.</p>
<p><img class="aligncenter size-full wp-image-102909" src="/wp-content/uploads/2020/07/kernel.png" alt="" width="874" height="453" srcset="/wp-content/uploads/2020/07/kernel.png 874w, /wp-content/uploads/2020/07/kernel-300x155.png 300w, /wp-content/uploads/2020/07/kernel-768x398.png 768w, /wp-content/uploads/2020/07/kernel-205x106.png 205w" sizes="(max-width: 874px) 100vw, 874px" /></p>
<p style="text-align: center;"><strong>Figure 3</strong>. Windows Kernel Processing layers for the P9 protocol malicious server response parsing</p>
<p>Now that we have identified the code for parsing the P9 protocol message types of interest we need to audit the code for message type confusion and memory corruption vulnerabilities such as out of bounds read/write and overflows.</p>
<h2>Fuzzing constraints</h2>
<p>There were a number of constraints which made deploying automated fuzzing logic difficult:</p>
<ol>
<li>The R-message type sent from the malicious P9 server must match the T-message type sent by the Windows kernel</li>
<li>Timeouts in higher layers of the WSL stack</li>
</ol>
<p>The above challenges could, however, be overcome but since the protocol is relatively simple we decided to focus on reversing the processing logic validation. To verify the processing logic validation, we created some manual fuzzing capability within the malicious P9 server to test the variable length packet field boundaries identified from the protocol overview.</p>
<p>Below is an example RREAD R-message type which sends a malicious P9 packet in response to an RREAD T-message where we control the count and data variable length fields.</p>
<table>
<tbody>
<tr>
<td width="372"><a href="https://github.com/chaos/diod">srv.c</a></p>
<p>void</p>
<p>np_req_respond(Npreq *req, Npfcall *rc)</p>
<p>{</p>
<p>NP_ASSERT (rc != NULL);</p>
<p>xpthread_mutex_lock(&amp;req-&gt;lock);</p>
<p>&nbsp;</p>
<p>u32 count = 0xFFFFFFFF;</p>
<p>Npfcall *fake_rc;</p>
<p>u8 *data = malloc(0xFFF0);</p>
<p>memset(data, &#8220;A&#8221;, 0xFFF0);</p>
<p>&nbsp;</p>
<p>if (!(fake_rc = np_alloc_rread1(count)))</p>
<p>return NULL;</p>
<p>if (fake_rc-&gt;u.rread.data)</p>
<p>memmove(fake_rc-&gt;u.rread.data, data, count);</p>
<p>&nbsp;</p>
<p>if(rc-&gt;type == 0x75){</p>
<p>fprintf (stderr, &#8220;RREAD Packet Reply&#8221;);</p>
<p>req-&gt;rcall = fake_rc;</p>
<p>}</p>
<p>else{</p>
<p>req-&gt;rcall =rc;</p>
<p>}</p>
<p>if (req-&gt;state == REQ_NORMAL) {</p>
<p>np_set_tag(req-&gt;rcall, req-&gt;tag);</p>
<p>np_conn_respond(req);</p>
<p>}</p>
<p>xpthread_mutex_unlock(&amp;req-&gt;lock);</p>
<p>}</td>
</tr>
</tbody>
</table>
<h2>Validation Checks</h2>
<p>The data passed to the P9 driver is contained within a connection memory allocation of 0x10000 bytes (P9Client-&gt;P9PacketStart) and most of the processing is done within this memory allocation, with two exceptions where memmove is called within the P9Client::FillData and P9Client::Lambda_2275 functions (discussed below).</p>
<p>A message-type confusion attack is not possible since the P9Exchange data structure tracks the R-message to its corresponding T-message type.</p>
<p>In addition, the P9 driver uses a <a href="https://github.com/Microsoft/GSL" target="_blank" rel="noopener noreferrer">span reader </a>to process message type fields of static length. The P9Exchange structure stores the message type which is used to determine the number of fields within a message during processing.</p>
<p>While we can control the P9 packet size we cannot control the P9Client-&gt;MaxConnectionSize which means messages greater than or equal to 0x10000 will be dropped.</p>
<p>All variable size field checks within the message type layer of the protocol are checked against the P9Packet size field ensuring that a malicious field will not result in out of bounds read or write access outside of the 0x10000 connection memory allocation.</p>
<p>The processing logic functions identified previously were reverse engineered to understand the validation on the protocol’s fields, with specific focus on the variable length fields within message types rversion, rwalk and rread.</p>
<p>By importing the P9Client and P9Exchange data structures into IDA Pro, the reverse engineering process relatively straight forward to understand the packet validation logic. The functions below have been reversed to the level required for understanding the validation and are not representative of the entire function code base.</p>
<p>P9Client::ReceiveCallback validates that the Rmessage_size does not exceed the max connection size of 0x10000</p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::ReceiveCallback ( P9Client *P9Client){<br />
struct p9packet;uint64 MaxConnectionSize;uint64 Rmessage_size;MaxConnectionSize = P9Client-&gt; MaxConnectionSize;<br />
Rmessage_size = P9Client-&gt;Rmessage_size;if(MaxConnectionSize) {<br />
P9Packet = (struct p9packet *) P9Client-&gt; P9PacketStart;if (MaxConnectionSize &lt; 0 || !P9Packet) terminate(P9Packet);}if (Rmessage_size &gt;=0 &amp;&amp; P9Client-&gt;MaxConnectionSize &gt;= Rmessage_size)<strong><br />
</strong>{<br />
P9Client::HandleReply (*P9Client)<br />
} else{</p>
<p>terminate(P9Packet);</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>P9Client::HandleReply – <strong>there are multiple</strong> <strong>local DoS here which result in a Blue Screen Of Death (BSOD) depending on the size of P9Client-&gt;Rmessage_size and P9Client-&gt;P9PacketEnd-&gt;size, e.g. when P9Client-&gt;P9PacketEnd-&gt;size is zero terminate() is called which is BSOD.</strong></p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::HandleReply(P9Client *P9Client){</p>
<p>uint64 P9PacketHeaderSize = 7;</p>
<p>uint64 Rmessage_size = P9Client-&gt;Rmessage_size;</p>
<p>if (Rmessage_size &gt;=7){<br />
while(1){</p>
<p>P9PacketEnd = P9Client-&gt;P9PacketEnd;</p>
<p>if(!P9PacketEnd) break;</p>
<p>uint64 P9PacketSize = P9Client-&gt;P9PacketEnd-&gt;size;<br />
if (P9PacketSize &gt; P9Client-&gt;MaxConnectionSize); HandleIoError();</p>
<p>if (Rmessage_size &lt; P9PacketSize); P9Client::FillData();</p>
<p>if(Rmessage_size &lt; 4) terminate(); <em>// checking a P9 header size field exists in packet</em></p>
<p>if(Rmessage_size &gt; 5) fastfail(); <em>// checking a P9 header type field exists in packet</em></p>
<p>int message_type = P9PacketEnd-&gt;type;</p>
<p>if(Rmessage_size &lt; 7) fastfail(); <em>// checking a P9 header tag field exists in packet</em></p>
<p>uint64 tag = P9PacketEnd-&gt;tag;</p>
<p>uint64 P9message_size = P9PacketSize – P9PacketHeaderSize; <em>//getting size of message</em></p>
<p>if (Rmessage_size – 7 &lt; 0) terminate(); <em>// checking message layer exists after P9 header</em></p>
<p>if (Rmessage_size – 7 &lt; P9message_size); terminate();  <strong><em>//BSOD here as when set </em>P9PacketSize</strong> <strong><em>= 0 then subtracting 7 wraps around so P9message_size becomes greater than Rmessage_size.</em></strong></p>
<p>void P9Client::ProcessReply(P9Client *P9Client, Rmessage_type, tag, &amp;P9message_size);</p>
<p>}</p>
<p>}</p>
<p>else {</p>
<p>P9Client::FillData();</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>P9Client::FillData &#8211; we cannot reach this function with a large Rmessage_size to force an out of bounds write.</p>
<table>
<tbody>
<tr>
<td width="623">int P9Client::FillData (P9Client *P9Client){<br />
uint64 Rmessage_size = P9Client-&gt; Rmessage_size;uint_ptr P9PacketEnd = P9Client-&gt;P9PacketEnd;<br />
uint_ptr P9PacketStart = P9Client-&gt;P9PacketStart;if (P9PacketEnd != P9PacketStart) {<br />
memmove (P9PacketStart, P9PacketEnd, Rmessage_size);<br />
}</td>
</tr>
</tbody>
</table>
<p>ProcessReply checks the R-message type with that from the T-message within the P9Exchange data structure.</p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::ProcessReply(P9Client *P9Client, Rmessage_type, tag, &amp;P9message_size){<br />
P9Exchange *P9Exchange = MidExchangeManager::FindAndRemove(*P9Client, &amp;P9Exchange);if (P9Packet-&gt;tag &gt; 0) {<br />
int message_type_size = GetMessageSize (P9Exchange-&gt;Tmessage_type);<br />
if (P9message_size &gt;= message_type_size) {int rmessage_type = P9Exchange-&gt;MessageType;int rmessage_type = rmessage_type +1;}<br />
if(rmessage_type &gt; 72){<br />
Switch (MessageType){<br />
case 100:<br />
P9Client::ProcessVersionReply(P9Client *P9Client, P9Exchange, &amp;P9message_size);<br />
case 110:<br />
P9Client::ProcessWalkreply(Rmessage_type, P9Exchange, &amp;P9message_size);}<br />
}else {<br />
P9Client::ProcessReadReply(rmessage_type, P9Exchange, &amp;P9message_size);<br />
}}</td>
</tr>
</tbody>
</table>
<p>During the P9Client::ProcessReply function it calls MidExchangeManager::FindAndRemove to fetch the P9Exchange data structure <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/midatlax/nf-midatlax-rxmapanddissociatemidfromcontext">associated</a> with the R-messages corresponding T-message.</p>
<table>
<tbody>
<tr>
<td width="623">MidExchangeManager::FindAndRemove (*P9Client, &amp;P9Exchange){</p>
<p>NTSTATUS RxMapAndDissociateMidFromContext(PRX_MID_ATLAS P9Client-&gt;RDBSS_RxContext, USHORT Mid, &amp;P9Exchange);</p>
<p>}</td>
</tr>
</tbody>
</table>
<p>ProcessVersionReply checks the version sent by Client “P92000.L” which is 8 characters and checks the same length on return so the rversionlen does not affect the tryString function.</p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::ProcessVersionReply (*P9Client, *P9Exchange, &amp; P9message_size) {</p>
<p>char * rversion;<br />
int rversionlen = 0;</p>
<p>rversion = P9Client-&gt;P9PacketStart.u.rversion-&gt;version-&gt;str;</p>
<p>rversionlen = P9Client-&gt;P9PacketStart.u.rversion-&gt;version-&gt;len;</p>
<p>tryString (messagesize, &amp;rversion)</p>
<p>strcmp (Tversion, Rversion);<br />
}</td>
</tr>
</tbody>
</table>
<p>ProcessWalkReply checks that the total number of rwalk structures does not exceed the P9message_size</p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::ProcessWalkReply(rmessage_type, *P9Exchange, &amp;P9message_size){</p>
<p>uint16 nwqid = p9packet.rwalk.nwqid;</p>
<p>uint64 rwalkpacket_size = &amp;P9message_size &#8211; 2; <em>// 2 bytes of rwalk header for nwqid field</em></p>
<p>unit_ptr rwalkpacketstart = &amp;P9Client-&gt;P9PacketStart.u.rwalk-&gt;wqids;<br />
uint64 error_code = 0x0C0000186;<br />
uint64 rwalk_message_size = nwqid * 13; <em>// 0xd is size of an rwalk struct</em></p>
<p>if (rwalk_message_size &lt;= P9message_size) {</p>
<p>P9Exchange-&gt;Lambda_8972 (int, nwqid, &amp;rwalk_message_size, P9Exchange-&gt; RxContext, &amp; rwalkpacketstart); <em>// Lambda_8972 is Lambda_PTR1 for rwalk message type </em></p>
<p>} else {</p>
<p>P9Exchange-&gt;P9Client::SyncContextErrorCallback (error_code, P9Exchange-&gt; RxContext) <em>// SyncContextErrorCallback is Lambda_PTR2 for rwalk message type</em></p>
<p>}<br />
}</td>
</tr>
</tbody>
</table>
<p>ProcessReadReply checks the size of the count field does not exceed 0x8000 and writes it into an MDL within P9Exchange-&gt; RxContext to pass back up the RDBSS stack to view file contents within Explorer.</p>
<table>
<tbody>
<tr>
<td width="623">void P9Client::ProcessReadReply (rmessage_type, *P9Exchange, &amp;P9message_size){<br />
unint64 count = P9Client-&gt;P9PacketStart.u.rread-&gt;count;<br />
P9Exchange-&gt;Lambda_2275 (count, P9Exchange-&gt; RxContext, &amp;P9message_size);}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="623">Lambda_2275 (count, P9Exchange-&gt; RxContext, &amp;P9message_size) {</p>
<p>uint64 maxsize = P9Exchange-&gt; RxContext+offset; //max_size = 0x8000</p>
<p>unint64 MDL = P9Exchange-&gt; RxContext+offset;</p>
<p>if (count &gt; maxsize) terminate();</p>
<p>memmove (&amp;MDL, P9Client-&gt;P9PacketStart.u.rread-&gt;data, count);</p>
<p>}</td>
</tr>
</tbody>
</table>
<h2>Conclusion</h2>
<p>Through this research, we discovered a local Denial of Service (DoS) within the Windows kernel implementation of the P9 protocol. As explained, the vulnerability cannot be exploited to gain code execution within the Windows kernel so there is no risk to users from this specific vulnerability. As a pre-requisite to malicious P9 server attacks, an attacker must hijack the P9 server socket “fsserver”. Therefore, we can mitigate this attack by detecting and preventing hijacking of the socket “fsserver”. McAfee MVISION Endpoint and EDR can detect and prevent coverage against P9 server socket “fsserver” hijacking which you can read more about <a href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/knock-knock-whos-there/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>We hope this research provides insights into the following:</p>
<ol>
<li>The vulnerability hunting process for new features such as the WSL P9 protocol on the Windows 10 OS</li>
<li>Provide support for future research higher up the WSL communications stack which increases in complexity due to the implementation of a virtual Linux file system on Windows</li>
<li>The value of McAfee Advanced Threat Research (ATR) working closely with our product and innovation teams to provide protection for our customers</li>
</ol>
<p>Finally, a special thanks to <a href="https://www.mcafee.com/blogs/author/leandro-costantino/" target="_blank" rel="noopener noreferrer">Leandro Costantino</a> and <a href="https://www.mcafee.com/blogs/author/cedric-cochin/" target="_blank" rel="noopener noreferrer">Cedric Cochin</a> for their initial Windows 10 WSL P9 server research.</p>
        </div>
    </div>

    <div class="wrap-section">  
        <div class="container medium">
            <h3>About the Author</h3>
        </div>
    </div>

    <div class="wrap-section padding-small bg-light-gray author-container">  
        <div class="container medium"> 


                <div class="row">
                    <div class="col-sm-2 col-xs-4 text-center">
                        <a href="/blogs/author/eoin-carroll/"><img class="author" src="/wp-content/uploads/2019/03/Eoin-Carroll-Pic-1-300x300.jpg" /></a>
                        <ul class="social-networks">
                <li><a href="https://twitter.com/w3knight" rel="nofollow" target="_blank"><i class="symbol-twitter"></i><span>Twitter</span></a></li><li><a href="https://www.linkedin.com/in/eoin-carroll-641ba08/" rel="nofollow" target="_blank"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>                        </ul>
                    </div>
                    <div class="col-sm-10 col-xs-8">
                        <h3 class="red"><a href="/blogs/author/eoin-carroll/">Eoin Carroll</a></h3>
                        <p>Eoin Carroll is a Principal Engineer and Senior Vulnerability Researcher on the McAfee Advanced Threat Research team, focused on researching the trustworthiness of emerging computing platforms and protocols. He also analyzes critical industry vulnerabilities and innovates advanced threat defenses. He has 20 years of diverse experience, from electronic engineering to a variety of offensive and ...</p>						
                        <a href="/blogs/author/eoin-carroll/" class="caret-link">Read more posts from Eoin Carroll </a>
                    </div>
                </div><br/>
                                    </div>
    </div>

    <div class="wrap-section padding-top-xs">  
        <div class="container medium"> 
            <div class="row">
                            <div class="col-sm-6 col-xs-6">
            <a href="/blogs/consumer/security-software-and-device-performance/" rel="prev"><i class="fa fa-angle-left" aria-hidden="true"></i> Previous Article</a> 
                </div>
                <div class="col-sm-6 col-xs-6 text-right">
<a href="/blogs/other-blogs/life-at-mcafee/women-in-sales-part-1-opportunities-for-women-across-cybersecurity-sales/" rel="next">Next Article <i class="fa fa-angle-right" aria-hidden="true"></i></a>                </div>
            </div>
        </div>
    </div>
    <div class="wrap-section padding-top-xs"> 
        <div class="container medium">
                    <p class="small rule">Categories: <a href="/blogs/other-blogs/mcafee-labs/" rel="category tag">McAfee Labs</a><br /> 
            </p>	

        </div>		 
    </div>
    <div class="container medium">
                    <ol class="commentlist">
                    </ol>
             
    </div>
    
    <div class="wrap-section padding-top-small">  
        <div class="container medium">
                                </div>
    </div>
        <div class="wrap-section bg-red bg-image padding-medium" id="subscribe">
      <div class="container medium">
        <div class="row">
          <div class="col-sm-12">
            <div class="cta-component text-center">
              <h3>Subscribe to McAfee Securing Tomorrow Blogs</h3>
                         <form method="get" action="/blogs/subscribe/" class="form-inline">
            
              <input type="text" placeholder="Email address" name="subscriber_email" />
          
            <button type="submit" class="btn transparent">Subscribe</button>
          </form>
              
            </div>
          </div>
        </div>
      </div>
    </div>

</main>
<!--Footer of en-us starts here --> 
    
	<aside class="tools">
		<a href="#wrapper" class="back-to-top">Back to top</a>
	</aside>
  
  <div class="textwidget custom-html-widget"><div class="wrap-section padding-bottom-medium padding-top-small bg-dark-gray" id="footer">
    <div class="container medium">           
      <div class="row">
         <div class="col-sm-6 breadcrumb">
        	<ul class="breadcrumb-list">
        		<li><a class="symbols-label first" href="/blogs"><i class="symbol-shield"></i><span>McAfee Home</span></a></li>
        		<li><a class="symbols-label" href="/blogs"><i class="symbol-arrow-forward"></i><span>Securing Tomorrow</span></a></li>
					 </ul>
				</div>
        <div class="col-sm-6 social">
          <!-- <a id="usbl-integrated-button" class="symbols-label" href=""><i class="symbol-feedback"></i><span>Feedback</span></a> -->
          <ul class="social-networks">
            <li><a href="https://twitter.com/mcafee" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="symbol-twitter"></i><span>Twitter</span></a></li>
            <li><a href="http://www.facebook.com/mcafee" title="Facebook" target="_blank" rel="noopener noreferrer"><i class="symbol-facebook"></i><span>Facebook</span></a></li>
            <li><a href="https://www.linkedin.com/company/2336?trk=prof-exp-company-name" title="LinkedIn" target="_blank" rel="noopener noreferrer"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>
            <li><a href="http://www.youtube.com/mcafee" title="YouTube" target="_blank" rel="noopener noreferrer"><i class="symbol-youtube"></i><span>YouTube</span></a></li>
            <li><a href="/blogs/" title="Blog" target="_blank" rel="noopener noreferrer"><i class="symbol-blog"></i><span>Blog</span></a></li>
					</ul>
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col-sm-3">
          <a class="symbols-label" href="/enterprise/en-us/about/region-selector.html"><i class="symbol-language"></i><span>United States / English</span></a>
        </div>
        <div class="col-sm-9">
           <a href="//www.scanalert.com/RatingVerify?ref=www.mcafee.com" target="_blank" class="mcafee-secure" rel="noopener noreferrer"><img src="https://www.mcafee.com/enterprise/en-us/img/v1/common/logo-mcafee-secure.svg" alt="McAfee SECURE"/></a>
          <ul class="footer-menu">
            <li><a href="/enterprise/en-us/about/legal/privacy.html">Privacy</a></li>
            <li><a href="/enterprise/en-us/about/legal/notices.html">Legal Notices</a></li>
            <li><a href="/enterprise/en-us/about/legal/contracts-terms.html">Legal Contracts &amp; Terms</a></li>
            <li><a href="/enterprise/en-us/site-map.html">Site Map</a></li>
            <li>Copyright ©2020 McAfee, LLC</li>
          </ul>
        </div>
      </div>          
    </div>            	
  </div>
</div></div>


</body>	
<script type="text/javascript">
   if ($('div.author-block .meta').length > 0) {
      utag_data.tm_local_blogs_author = $('div.author-block .meta').text().split(' on ')[0].replace("By","").trim();
    }
    (function(a,b,c,d){
    a='//tags.tiqcdn.com/utag/mcafee/consumer-main/prod/utag.js'; // Note: Please use prod for production version and dev for dev version before release
    b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
    a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
    })();
</script>

<script type='text/javascript' src='/wp-content/plugins/metronet-profile-picture/js/mpp-frontend.js?ver=2.3.8'></script>
<script type='text/javascript'>
/* Highlight Search Terms 1.5 ( RavanH - http://status301.net/wordpress-plugins/highlight-search-terms/ ) */
var hlst_query = []; var hlst_areas = ["#groups-dir-list","#members-dir-list","div.bbp-topic-content,div.bbp-reply-content,li.bbp-forum-info,.bbp-topic-title,.bbp-reply-title","article","div.hentry","div.post","#content","#main","div.content","#middle","#container","div.container","div.page","#wrapper","body"];
</script>
<script type='text/javascript' src='/wp-content/plugins/highlight-search-terms/hlst-extend.min.js?ver=1.5'></script>
<script type='text/javascript' src='/wp-content/plugins/social-polls-by-opinionstage/public/js/shortcodes.js?ver=19.6.31'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpmm_object = {"ajax_url":"https:\/\/www.mcafee.com\/wp-admin\/admin-ajax.php","wpmm_responsive_breakpoint":"767px","wpmm_disable_mobile":"false"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/assets/js/wpmm.js?ver=1.3.1'></script>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/theme-script.js?ver=5.4.2'></script>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/skip-link-focus-fix.min.js?ver=20151215'></script>
<script type='text/javascript' src='/wp-content/plugins/super-socializer/js/front/social_login/general.js?ver=7.12.37'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=5.4.2'></script>
	
<script src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js?ver=10faaf528e636a046163bdb6753031b2"></script>
<script src="/wp-content/themes/securingtomorrow/js/jquery-lib.js"></script>
<script src="/wp-content/themes/securingtomorrow/js/main.js"></script>
<script src="/wp-content/themes/securingtomorrow/js/general_footer.js"></script>
<!-- Consumer Facebook Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '187610925152304');
  fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=187610925152304&ev=PageView&noscript=1"/></noscript>
<!-- End Facebook Pixel Code -->

<!-- Start linkedIn pixel -->
<script type="text/javascript">
_linkedin_partner_id = "68395";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);
</script><script type="text/javascript">
(function(){var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})();
</script>
<noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://dc.ads.linkedin.com/collect/?pid=68395&fmt=gif" />
</noscript>
<!-- End linkedIn pixel -->

<!-- Twitter universal website tag code -->
<script>
!function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
},s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
// Insert Twitter Pixel ID and Standard Event data below
twq('init','nxlgc');
twq('track','PageView');
</script>
<!-- Twitter universal website tag code -->

<script>
/* <![CDATA[ */
var google_conversion_id = 975085349;
var google_custom_params = window.google_tag_params;
var google_remarketing_only = true;
/* ]]> */
document.write('\x3Cscript type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">\x3C/script>');
//document.write('\x3Cnoscript>\x3Cimg height="1" width="1" style="border-style:none;display:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/975085349/?guid=ON&script=0"/>\x3C/noscript>');
</script>

<!-- Enterprise Facebook Pixel Code -->
<script>
// load Facebook
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '766537420057144');
fbq('track', "PageView");

//document.write('\x3Cnoscript>\x3Cimg height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=766537420057144&ev=PageView&noscript=1" />\x3C/noscript>');
</script>
<!-- Facebook Pixel Code -->

<!-- Adobe Launch START -->
<script src="//assets.adobedtm.com/launch-ENc117a6a508e14a879398dd6f37ed54a3.min.js"></script>
<!-- Adobe Launch END -->
<script>_satellite.pageBottom()</script>
</html>


<style>
    .commentlist {
        display: none;
    }
</style>
<!-- This website is like a Rocket, isn't it? Performance optimized by WP Rocket. Learn more: https://wp-rocket.me - Debug: cached@1616227261 -->