<!DOCTYPE html>
<html lang="en-US">

    <head>

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="profile" href="https://gmpg.org/xfn/11">
        <link rel="pingback" href="https://www.mcafee.com/xmlrpc.php">
                    <link rel="canonical" href="https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/">
                            <link rel="shortcut icon" href="https://www.mcafee.com/enterprise/en-us/img/favicon.ico">
        <!--<link rel="stylesheet" href="/wp-content/themes/securingtomorrow/css/responsive/blog.css" type="text/css">
        <link rel="stylesheet" href="/wp-content/themes/securingtomorrow/css/responsive/main.css" type="text/css">-->
        <link rel="stylesheet" href="/enterprise/www/css/main.min.css" type="text/css">
       
        	<script type="text/javascript">function theChampLoadEvent(e){var t=window.onload;if(typeof window.onload!="function"){window.onload=e}else{window.onload=function(){t();e()}}}</script>
		<script type="text/javascript">var theChampDefaultLang = 'en_US', theChampCloseIconPath = 'https://www.mcafee.com/wp-content/plugins/super-socializer/images/close.png';</script>
		<script> var theChampSiteUrl = 'https://www.mcafee.com/blogs', theChampVerified = 0, theChampEmailPopup = 0; </script>
		<style type="text/css">.the_champ_horizontal_sharing .theChampSharing{
					color: #fff;
				border-width: 0px;
		border-style: solid;
		border-color: transparent;
	}
		.the_champ_horizontal_sharing .theChampTCBackground{
		color:#666;
	}
		.the_champ_horizontal_sharing .theChampSharing:hover{
				border-color: transparent;
	}
	.the_champ_vertical_sharing .theChampSharing{
					color: #fff;
				border-width: 0px;
		border-style: solid;
		border-color: transparent;
	}
		.the_champ_vertical_sharing .theChampTCBackground{
		color:#666;
	}
		.the_champ_vertical_sharing .theChampSharing:hover{
				border-color: transparent;
	}
	@media screen and (max-width:783px){.the_champ_vertical_sharing{display:none!important}}div.heateor_ss_mobile_footer{display:none;}@media screen and (max-width:783px){i.theChampTCBackground{background-color:white!important}div.the_champ_bottom_sharing{width:100%!important;left:0!important;}div.the_champ_bottom_sharing li{width:12.5% !important;}div.the_champ_bottom_sharing .theChampSharing{width: 100% !important;}div.the_champ_bottom_sharing div.theChampTotalShareCount{font-size:1em!important;line-height:28px!important}div.the_champ_bottom_sharing div.theChampTotalShareText{font-size:.7em!important;line-height:0px!important}div.heateor_ss_mobile_footer{display:block;height:40px;}.the_champ_bottom_sharing{padding:0!important;display:block!important;width: auto!important;bottom:-2px!important;top: auto!important;}.the_champ_bottom_sharing .the_champ_square_count{line-height: inherit;}.the_champ_bottom_sharing .theChampSharingArrow{display:none;}.the_champ_bottom_sharing .theChampTCBackground{margin-right: 1.1em !important}}</style>
	
	<!-- This site is optimized with the Yoast SEO plugin v14.2 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>In NTDLL I Trust - Process Reimaging and Endpoint Security Solution Bypass | McAfee Blogs</title>
	<meta name="description" content="Process Reimaging Overview The Windows Operating System has inconsistencies in how it determines process image FILE_OBJECT locations, which impacts" />
	<meta name="robots" content="index, follow" />
	<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="In NTDLL I Trust - Process Reimaging and Endpoint Security Solution Bypass | McAfee Blogs" />
	<meta property="og:description" content="Process Reimaging Overview The Windows Operating System has inconsistencies in how it determines process image FILE_OBJECT locations, which impacts" />
	<meta property="og:url" content="/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/" />
	<meta property="og:site_name" content="McAfee Blogs" />
	<meta property="article:publisher" content="https://www.facebook.com/mcafee" />
	<meta property="article:published_time" content="2019-06-20T16:00:14+00:00" />
	<meta property="article:modified_time" content="2019-06-20T16:01:14+00:00" />
	<meta property="og:image" content="https://www.mcafee.com/wp-content/uploads/2019/04/Global-Cyber-security-concept-copy.jpg" />
	<meta property="og:image:width" content="1575" />
	<meta property="og:image:height" content="1125" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:creator" content="@w3knight" />
	<meta name="twitter:site" content="@mcafee" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://www.mcafee.com/blogs/#website","url":"https://www.mcafee.com/blogs/","name":"McAfee Blogs","description":"Securing Tomorrow. Today.","potentialAction":[{"@type":"SearchAction","target":"https://www.mcafee.com/blogs/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/#primaryimage","inLanguage":"en-US","url":"/wp-content/uploads/2019/04/Global-Cyber-security-concept-copy.jpg","width":1575,"height":1125},{"@type":"WebPage","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/#webpage","url":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/","name":"In NTDLL I Trust - Process Reimaging and Endpoint Security Solution Bypass | McAfee Blogs","isPartOf":{"@id":"https://www.mcafee.com/blogs/#website"},"primaryImageOfPage":{"@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/#primaryimage"},"datePublished":"2019-06-20T16:00:14+00:00","dateModified":"2019-06-20T16:01:14+00:00","author":{"@id":"https://www.mcafee.com/blogs/#/schema/person/6e361f03260be663c75dcf535cf8594d"},"description":"Process Reimaging Overview The Windows Operating System has inconsistencies in how it determines process image FILE_OBJECT locations, which impacts","breadcrumb":{"@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/"]}]},{"@type":"BreadcrumbList","@id":"https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/blogs/","url":"/blogs/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/","url":"/blogs/other-blogs/","name":"Other Blogs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/mcafee-labs/","url":"/blogs/other-blogs/mcafee-labs/","name":"McAfee Labs"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/","url":"/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/","name":"In NTDLL I Trust &#8211; Process Reimaging and Endpoint Security Solution Bypass"}}]},{"@type":["Person"],"@id":"https://www.mcafee.com/blogs/#/schema/person/6e361f03260be663c75dcf535cf8594d","name":"Eoin Carroll","description":"Eoin Carroll is a Principal Engineer and Senior Vulnerability Researcher on the McAfee Advanced Threat Research team, focused on researching the trustworthiness of emerging computing platforms and protocols. He also analyzes critical industry vulnerabilities and innovates advanced threat defenses. He has 20 years of diverse experience, from electronic engineering to a variety of offensive and defensive security roles. For the first decade of his career he worked as an electronic engineer in both the semiconductor and medical device industries, gaining a wealth of engineering and risk experience. During the second decade he has been building his career in platform security through Product Security, reverse engineering critical industry vulnerabilities and designing exploit protections. In addition, he has lead Product Security teams, mentored many Product Security Engineers/Architects, supported local universities to keep their security curriculum relevant to industry needs and regularly speaks at universities and STEM events to inspire the next generation of security talent. He is very passionate about analyzing the security models of emerging platforms and protocols against the current and future threat landscape. His work experience includes threat modeling, secure platform design, memory forensics, vulnerability and exploit analysis, reverse engineering, product engineering, operating system internals and incident response.","sameAs":["https://www.linkedin.com/in/eoin-carroll-641ba08/","https://twitter.com/w3knight"]}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//stackpath.bootstrapcdn.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="McAfee Blogs &raquo; Feed" href="https://www.mcafee.com/blogs/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.4.2"}};
			/*! This file is auto-generated */
			!function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='/wp-includes/css/dist/block-library/style.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_poll_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/poll/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_trivia_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/trivia/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_personality_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/personality/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_survey_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/survey/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_slideshow_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/slideshow/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='opinionStage_form_oswp_style_css_set-css'  href='/wp-content/plugins/social-polls-by-opinionstage/gutenberg/form/dist/blocks.style.build.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='mpp_gutenberg-css'  href='/wp-content/plugins/metronet-profile-picture/dist/blocks.style.build.css?ver=2.3.8' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='/wp-includes/css/dashicons.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpmm_css-css'  href='/wp-content/plugins/wp-megamenu/assets/css/wpmm.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp_megamenu_generated_css-css'  href='/wp-content/uploads/wp-megamenu/wp-megamenu.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='featuresbox_css-css'  href='/wp-content/plugins/wp-megamenu/addons/wpmm-featuresbox/wpmm-featuresbox.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='postgrid_css-css'  href='/wp-content/plugins/wp-megamenu/addons/wpmm-gridpost/wpmm-gridpost.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-bootstrap-pro-fontawesome-cdn-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='open-sans-google-font-css'  href='https://fonts.googleapis.com/css?family=Open+Sans%3A300%2C400&#038;ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='theme-css-css'  href='/wp-content/themes/securingtomorrow/style.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='the_champ_frontend_css-css'  href='/wp-content/plugins/super-socializer/css/front.css?ver=7.12.37' type='text/css' media='all' />
<link rel='stylesheet' id='addtoany-css'  href='/wp-content/plugins/add-to-any/addtoany.min.css?ver=1.15' type='text/css' media='all' />
<link rel='stylesheet' id='poppins-css'  href='//fonts.googleapis.com/css?family=Poppins%3A100%2C100italic%2C200%2C200italic%2C300%2C300italic%2Cregular%2Citalic%2C500%2C500italic%2C600%2C600italic%2C700%2C700italic%2C800%2C800italic%2C900%2C900italic&#038;ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='oswald-css'  href='//fonts.googleapis.com/css?family=Oswald%3A200%2C300%2Cregular%2C500%2C600%2C700&#038;ver=1.3.1' type='text/css' media='all' />
<script type='text/javascript' src='/wp-content/plugins/jquery-updater/js/jquery-3.4.1.min.js?ver=3.4.1'></script>
<script type='text/javascript' src='/wp-content/plugins/add-to-any/addtoany.min.js?ver=1.1'></script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/addons/wpmm-featuresbox/wpmm-featuresbox.js?ver=1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var postgrid_ajax_load = {"ajax_url":"https:\/\/www.mcafee.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/addons/wpmm-gridpost/wpmm-gridpost.js?ver=1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/html5.js?ver=3.7.0'></script>
<![endif]-->
<link rel='https://api.w.org/' href='https://www.mcafee.com/blogs/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.mcafee.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.mcafee.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.2" />
<link rel='shortlink' href='https://www.mcafee.com/blogs/?p=95608' />
<link rel="alternate" type="application/json+oembed" href="https://www.mcafee.com/blogs/wp-json/oembed/1.0/embed?url=%2Fblogs%2Fother-blogs%2Fmcafee-labs%2Fin-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://www.mcafee.com/blogs/wp-json/oembed/1.0/embed?url=%2Fblogs%2Fother-blogs%2Fmcafee-labs%2Fin-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass%2F&#038;format=xml" />

<script data-cfasync="false">
window.a2a_config=window.a2a_config||{};a2a_config.callbacks=[];a2a_config.overlays=[];a2a_config.templates={};
(function(d,s,a,b){a=d.createElement(s);b=d.getElementsByTagName(s)[0];a.async=1;a.src="https://static.addtoany.com/menu/page.js";b.parentNode.insertBefore(a,b);})(document,"script");
</script>
<script>
var utag_data = {
tm_global_pagename:"",
tm_global_page_publish_date:"",
tm_global_businessunit:"consumer",
tm_global_sitesection:"",
tm_global_sitesection_level2:"",
tm_global_sitesection_level3:"",
tm_global_platform:"web",
tm_global_culture_code:"en-us",
tm_global_country:"united states",
tm_global_geo:"na",
tm_global_channel:"direct",
tm_global_affiliate_id:"",
tm_global_affiliate_name:"",
tm_global_campaign_id:"",
tm_global_page_version:"",
tm_global_pageurl:location.href,
tm_global_clientid :"",
tm_global_trafficsource:"",
tm_global_sourcetype:"blog",
tm_global_wssversion:"",
tm_global_coe:"",
tm_global_coe_level2:"",
tm_local_blogs_author:""
}
var sec=location.pathname.replace("/blogs","").split("/"); utag_data.tm_global_pagename="[consumer:web]";
if(sec.length > 2) {
for(i=1;i<sec.length-1;i++) {
utag_data.tm_global_pagename+="|"+sec[i];
if(i==1){utag_data.tm_global_sitesection=sec[i]}
if(i==2){utag_data.tm_global_sitesection_level2=sec[i]}
if(i==3){utag_data.tm_global_sitesection_level3=sec[i]}
}
}
else {
utag_data.tm_global_sitesection="Homepage"
utag_data.tm_global_pagename+="|Homepage"
}

var today = new Date(); var dd = today.getDate(); var mm = today.getMonth() + 1; var yyyy = today.getFullYear();
if (dd < 10) { dd = '0' + dd;    } 
if (mm < 10) {mm = '0' + mm;  } 
utag_data.tm_global_page_publish_date = dd + '/' + mm + '/' + yyyy;

</script>

<script>
	var ISOTOPE_CACHE 				=  [];
	var ISOTOPE_AJAX_URL 			= 'https://www.mcafee.com/wp-admin/admin-ajax.php';
	var ISOTOPE_AJAX_URL_ENDPOINT 	= 'https://www.mcafee.com/wp-content/plugins/ae-isotope/endpoint.php';
	var ISOTOPE_AJAX_ITEMS			= 25;
	var ISOTOPE_CURRENT_CATEGORY	= '';
</script>		<meta property="fb:app_id" content="346056175795920" />
					<meta property="fb:admins" content="100007220654854" />
			<style type="text/css">.wp-megamenu-wrap .wpmm-nav-wrap > ul.wp-megamenu li.wpmm_dropdown_menu ul.wp-megamenu-sub-menu li.menu-item-has-children.wp-megamenu-item-101284.wpmm-submenu-right > ul.wp-megamenu-sub-menu {left: 100%;}</style><style type="text/css"></style><link rel="icon" href="/wp-content/uploads/2018/11/cropped-favicon-32x32.png" sizes="32x32" />
<link rel="icon" href="/wp-content/uploads/2018/11/cropped-favicon-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="/wp-content/uploads/2018/11/cropped-favicon-180x180.png" />
<meta name="msapplication-TileImage" content="/wp-content/uploads/2018/11/cropped-favicon-270x270.png" />
         <link rel="stylesheet" href="/enterprise/www/css/blog.css" type="text/css">
                <script type="text/javascript">
            var digitalData = {"page":{"pageInfo":{"pageName":"other-blogs:mcafee-labs:in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass","pageNameGlobal":"in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass","pageLanguage":"English","pageType":"","country":"us","geo":"NA","onsiteSearchTerm":"","onsiteSearchType":"","category":{"category":"other-blogs","subCategory1":"mcafee-labs"},"author":"Eoin Carroll","pubDate":"Jun 20, 2019","metaData":{"keywords":""}}},"user":{"userInfo":{"ip":"161.69.31.4"}}}        </script>
                <script type='application/ld+json'>{
            "@context": "http://schema.org",
            "@type": "Article",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://www.mcafee.com/blogs/other-blogs/mcafee-labs/in-ntdll-i-trust-process-reimaging-and-endpoint-security-solution-bypass/"
            },
           "headline": "In NTDLL I Trust &#8211; Process Reimaging and Endpoint Security Solution Bypass",
            "image": ["https://www.mcafee.com/wp-content/uploads/2019/04/Global-Cyber-security-concept-copy.jpg"],	
            "datePublished": "2019-06-20",
            "dateModified": "Jun 20, 2019",
            "author": {
                "@type": "Person",           
                "name": ["Eoin Carroll","Cedric Cochin","Steve Povolny","Steve Hearnden"]            
            },
            "publisher": {
                "@type": "Organization",
                "name": "McAfee",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://www.mcafee.com/enterprise/en-us/img/logos/mcafee-logo.png"
                }
            },
            "description": "Process Reimaging OverviewThe Windows Operating System has inconsistencies in how it determines process image FILE_OBJECT locations, which impacts non-EDR (Endpoint Detection and Response) Endpoint Security Solution’s (such as Microsoft Defender Realtime Protection), ability to detect the correct binaries loaded in"        
            }
        </script>
        <style>
            #wp-megamenu-blog>.wpmm-nav-wrap ul.wp-megamenu>li>a{
                color:#ffffff !important;
            }
        </style> 
    
    <script>!function(){function o(n,i){if(n&&i)for(var r in i)i.hasOwnProperty(r)&&(void 0===n[r]?n[r]=i[r]:n[r].constructor===Object&&i[r].constructor===Object?o(n[r],i[r]):n[r]=i[r])}try{var n=decodeURIComponent("%7B%20%22BW%22%3A%20%7B%20%22test_https%22%3A%20true%20%7D%20%7D");if(n.length>0&&window.JSON&&"function"==typeof window.JSON.parse){var i=JSON.parse(n);void 0!==window.BOOMR_config?o(window.BOOMR_config,i):window.BOOMR_config=i}}catch(r){window.console&&"function"==typeof window.console.error&&console.error("mPulse: Could not parse configuration",r)}}();</script>
                          <script>!function(a){var e="https://s.go-mpulse.net/boomerang/",t="addEventListener";if("False"=="True")a.BOOMR_config=a.BOOMR_config||{},a.BOOMR_config.PageParams=a.BOOMR_config.PageParams||{},a.BOOMR_config.PageParams.pci=!0,e="https://s2.go-mpulse.net/boomerang/";if(window.BOOMR_API_key="LXNDQ-3SP7Y-P3JVN-Y4HAH-VQNKC",function(){function n(e){a.BOOMR_onload=e&&e.timeStamp||(new Date).getTime()}if(!a.BOOMR||!a.BOOMR.version&&!a.BOOMR.snippetExecuted){a.BOOMR=a.BOOMR||{},a.BOOMR.snippetExecuted=!0;var i,_,o,r=document.createElement("iframe");if(a[t])a[t]("load",n,!1);else if(a.attachEvent)a.attachEvent("onload",n);r.src="javascript:void(0)",r.title="",r.role="presentation",(r.frameElement||r).style.cssText="width:0;height:0;border:0;display:none;",o=document.getElementsByTagName("script")[0],o.parentNode.insertBefore(r,o);try{_=r.contentWindow.document}catch(O){i=document.domain,r.src="javascript:var d=document.open();d.domain='"+i+"';void(0);",_=r.contentWindow.document}_.open()._l=function(){var a=this.createElement("script");if(i)this.domain=i;a.id="boomr-if-as",a.src=e+"LXNDQ-3SP7Y-P3JVN-Y4HAH-VQNKC",BOOMR_lstart=(new Date).getTime(),this.body.appendChild(a)},_.write("<bo"+'dy onload="document._l();">'),_.close()}}(),"".length>0)if(a&&"performance"in a&&a.performance&&"function"==typeof a.performance.setResourceTimingBufferSize)a.performance.setResourceTimingBufferSize();!function(){if(BOOMR=a.BOOMR||{},BOOMR.plugins=BOOMR.plugins||{},!BOOMR.plugins.AK){var e=""=="true"?1:0,t="",n="fb23dtlilz6gqycyd4vq-f-050e5d6ab-clientnsv4-s.akamaihd.net",i={"ak.v":"30","ak.cp":"108209","ak.ai":parseInt("250743",10),"ak.ol":"0","ak.cr":7,"ak.ipv":4,"ak.proto":"http/1.1","ak.rid":"16124d25","ak.r":30888,"ak.a2":e,"ak.m":"b","ak.n":"essl","ak.bpcip":"40.117.177.0","ak.cport":59410,"ak.gh":"23.201.31.214","ak.quicv":"","ak.tlsv":"tls1.3","ak.0rtt":"","ak.csrc":"-","ak.acc":"reno","ak.t":"1616387883","ak.ak":"hOBiQwZUYzCg5VSAfCLimQ==Fj47Ws92b3uNTgw9j+MZJE0YdT7P6MXj2aTlLIbTyYKS1S+r/g9s3k7eE+zttF1ib1u6mIyCfNQx39ajvxIp2GwMF/XhvhMhP1rxvu8sDU7pu3oHNTy+61ROqDuoVVxtl16iKr8GH+VdGvxuUqpWn3QSvzINZcM/lCFvVfyNTEI9dv/9JRxfPyvQF11LhhnT7waW74YE9vtW5mMdcwTSK8hLGnYNgaSK08eWoGiZKWDwCeI0JZH600QaJcJ7DyBYvy2hh6A2SexEn3PcaDJ/f9Jm5yo9vZ6N2e4BRFNP9bBZt5qgpnoVwH9mF5AF2V/RIa7uwGDZg8+8a92T1iqDKuMhl0PInBIMJ16hTRMcBZoNT9qEnamvL54RTVJW0N8AxgzVPjUaLHnt6DaNcxUuFbrvxpLgvWRoM6F71wiflQw=","ak.pv":"141","ak.dpoabenc":""};if(""!==t)i["ak.ruds"]=t;var _={i:!1,av:function(e){var t="http.initiator";if(e&&(!e[t]||"spa_hard"===e[t]))i["ak.feo"]=void 0!==a.aFeoApplied?1:0,BOOMR.addVar(i)},rv:function(){var a=["ak.bpcip","ak.cport","ak.cr","ak.csrc","ak.gh","ak.ipv","ak.m","ak.n","ak.ol","ak.proto","ak.quicv","ak.tlsv","ak.0rtt","ak.r","ak.acc","ak.t"];BOOMR.removeVar(a)}};BOOMR.plugins.AK={akVars:i,akDNSPreFetchDomain:n,init:function(){if(!_.i){var a=BOOMR.subscribe;a("before_beacon",_.av,null,null),a("onbeacon",_.rv,null,null),_.i=!0}return this},is_complete:function(){return!0}}}}()}(window);</script></head>

    <body  class="post-template-default single single-post postid-95608 single-format-standard wp-megamenu" id="short-header">
        <script src="/wp-content/themes/securingtomorrow/js/header_enterprise.js"></script>
        <div id="wrapper">
            <div class="textwidget custom-html-widget"><style>
	.headerbarContainer {
    background: rgba(0,0,0,0.9);
}
</style>
<header id="header">  
	<div class="headerbarContainer">
		<div class="headerbarContent">
			<div class="logo">
				 <img src="https://www.mcafee.com/enterprise/en-us/img/icons/logo-white.svg" alt="McAfee Logo"/>
			</div>
			<div class="quicklinks">
			 	<a class="symbols-label" href="https://www.mcafee.com/consumer/en-us/store/m0/index.html"><span>For Home</span></a>
			 	<a class="symbols-label" href="/enterprise/en-us/home.html"><span>For Enterprise</span></a>
			 	<a class="symbols-label" href="/enterprise/en-us/global-contact-us.html"><i class="symbol-contact"></i></a>
			</div>
		</div>
	</div>
</header>



<style>


@media screen and (min-width: 1025px) {
.hero{height: 756px !important;}
.hero.medium {
    min-height: 0;
    height: 640px  !important;
}
.hero.small {
    min-height: 0;
    height: 510px  !important;
}
.hero.title {
    height: 350px  !important;
}
	}
</style> 
<script>
$("document").ready(function(){
    $(".hero.title h1").each(function() {
        if ($(this).text().length > 50) {
            $(this).addClass("pt")
        }
    });
});
</script></div>  
		
<section class="hero title">
    <div class="bg-stretch">
        <img src="https://www.mcafee.com/wp-content/themes/securingtomorrow/img/light-shield-pattern.png" alt="">
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12 col-xs-12">
                <h1>In NTDLL I Trust &#8211; Process Reimaging and Endpoint Security Solution Bypass</h1>
            </div>
        </div>
    </div>
</section>

<main id="main">

    <nav class="anchor-links">
        <div class="container medium">
            <div style="float:left">
<nav id="wp-megamenu-blog" class="wp-megamenu-wrap   ">
			<div class="wpmm-fullwidth-wrap"></div>
			<div class="wpmm-nav-wrap wpmm-main-wrap-blog">
				<a href="javascript:;" class="wpmm_mobile_menu_btn show-close-icon"><i class="fa fa-bars"></i> Menu</a> 
					<ul id="menu-mcafee-blog-navigation-new-05020" class="wp-megamenu" ><li id="wp-megamenu-item-101279" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101279  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Consumer <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-5187079544375989129" class="wpmm-row wp-megamenu-item-5187079544375989129 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-1.2827420181307E+19" class="wpmm-col wpmm-col-12 wp-megamenu-item-1.2827420181307E+19 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101279 wpmm-submenu-right"><div class="menu-consumer-category-container"><ul id="menu-consumer-category" class="menu"><li id="menu-item-97453" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97453"><a href="/blogs/consumer/hackable/">Hackable? Podcast</a></li>
<li id="menu-item-97424" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97424"><a href="/blogs/consumer/consumer-threat-notices/">Consumer Threat Notices</a></li>
<li id="menu-item-97425" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97425"><a href="/blogs/consumer/family-safety/">Family Safety</a></li>
<li id="menu-item-97426" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97426"><a href="/blogs/consumer/identity-protection/">Identity Protection</a></li>
<li id="menu-item-97427" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97427"><a href="/blogs/consumer/mobile-and-iot-security/">Mobile and IoT Security</a></li>
<li id="menu-item-101334" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101334"><a href="/blogs/consumer/">All Consumer Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101280" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101280  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Enterprise <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-3041347491413482890" class="wpmm-row wp-megamenu-item-3041347491413482890 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-1.1731849692831E+19" class="wpmm-col wpmm-col-12 wp-megamenu-item-1.1731849692831E+19 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101280 wpmm-submenu-right"><div class="menu-enterprise-category-container"><ul id="menu-enterprise-category" class="menu"><li id="menu-item-97421" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97421"><a href="/blogs/enterprise/cloud-security/">Cloud Security</a></li>
<li id="menu-item-97451" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97451"><a href="/blogs/enterprise/endpoint-security/">Endpoint Security</a></li>
<li id="menu-item-97422" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97422"><a href="/blogs/enterprise/security-operations/">Security Operations</a></li>
<li id="menu-item-97452" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97452"><a href="/blogs/enterprise/data-security/">Data Security</a></li>
<li id="menu-item-101336" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101336"><a href="/blogs/enterprise/">All Enterprise Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101281" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101281  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#">Corporate <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-4553433334045857675" class="wpmm-row wp-megamenu-item-4553433334045857675 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-9.9595712825482E+18" class="wpmm-col wpmm-col-12 wp-megamenu-item-9.9595712825482E+18 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101281 wpmm-submenu-right"><div class="menu-other-blogs-container"><ul id="menu-other-blogs" class="menu"><li id="menu-item-97442" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97442"><a href="/blogs/other-blogs/executive-perspectives/">Executive Perspectives</a></li>
<li id="menu-item-97441" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-97441"><a href="/blogs/other-blogs/mcafee-labs/">McAfee Labs</a></li>
<li id="menu-item-97443" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97443"><a href="/blogs/other-blogs/life-at-mcafee/">Life at McAfee</a></li>
<li id="menu-item-97440" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97440"><a href="/blogs/other-blogs/podcast/">Podcast</a></li>
<li id="menu-item-97444" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97444"><a href="/blogs/other-blogs/mcafee-partners/">McAfee Partners</a></li>
<li id="menu-item-101340" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-101340"><a href="/blogs/other-blogs/">All Corporate Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-101282" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101282  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a href="/blogs/authors/">Authors</a></li>
<li id="wp-megamenu-item-101283" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101283  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a href="/blogs/subscribe/">Subscribe</a></li>
<li id="wp-megamenu-item-101284" class="menu-item menu-item-type-custom menu-item-object-custom wp-megamenu-item-101284  wpmm_mega_menu  wpmm-fadeindown wpmm-submenu-right"><a href="#"><span class='wpmm-selected-icon wpmm-selected-icon-left'><i class='fa fa-globe'></i></span> <b class="fa fa-angle-down"></b> </a>
<ul class="wp-megamenu-sub-menu" >
	<li id="wp-megamenu-item-6092481151706451854" class="wpmm-row wp-megamenu-item-6092481151706451854 wpmm-submenu-right">
	<ul class="wp-megamenu-sub-menu" >
		<li id="wp-megamenu-item-1.4128814397484E+19" class="wpmm-col wpmm-col-12 wp-megamenu-item-1.4128814397484E+19 wpmm-submenu-right">
		<ul class="wp-megamenu-sub-menu" >
			<li class="menu-item wpmm-type-widget menu-widget-class wpmm-type-widget wp-megamenu-item-101284 wpmm-submenu-right"><div class="menu-languages-category-container"><ul id="menu-languages-category" class="menu"><li id="menu-item-97433" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97433"><a href="/blogs/languages/italia/">Italia</a></li>
<li id="menu-item-97434" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97434"><a href="/blogs/languages/japanese/">日本語</a></li>
<li id="menu-item-97435" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97435"><a href="/blogs/languages/espanol/">Español</a></li>
<li id="menu-item-97436" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97436"><a href="/blogs/languages/francais/">Français</a></li>
<li id="menu-item-97437" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97437"><a href="/blogs/languages/german/">German</a></li>
<li id="menu-item-97438" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-97438"><a href="/blogs/languages/portugues/">Português</a></li>
<li id="menu-item-101338" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-101338"><a href="/blogs/languages/">All Language Blogs</a></li>
</ul></div></li>
		</ul>
</li>
	</ul>
</li>
</ul>
</li>
<li id="wp-megamenu-item-" class="wpmm-social-link wpmm-social-link- wp-megamenu-item-  wpmm_dropdown_menu  wpmm-fadeindown wpmm-submenu-right"><a target="_blank" ><i class=""></i></a></li>
</ul>
			</div>
		</nav>            </div>
            <div class="anchors right">
                <form role="search" method="get" class="blog-search search-form" action="https://www.mcafee.com/blogs/">
                    <button type="submit" class="search-submit"><i class="symbol-arrow-forward"></i></button>
                    <input type="search" class="search-field" placeholder="Search Blogs" value="" name="s" />


                </form>  
            </div>

        </div>
    </nav>

    <div class="wrap-section padding-top-xs"> 
        <div class="container medium">
 
        <div class="breadcrumb-container theme1">
            <ul itemscope itemtype="http://schema.org/BreadcrumbList">
                
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Mcafee" href="/"><span itemprop="name">Mcafee</span></a><span class="separator">/</span><meta itemprop="position" content="1"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Home" href="https://www.mcafee.com/blogs"><span itemprop="name">Home</span></a><span class="separator">/</span><meta itemprop="position" content="2"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="Other Blogs" href="/blogs/other-blogs/"><span itemprop="name">Other Blogs</span></a><span class="separator">/</span><meta itemprop="position" content="3"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="McAfee Labs" href="/blogs/other-blogs/mcafee-labs/"><span itemprop="name">McAfee Labs</span></a><span class="separator">/</span><meta itemprop="position" content="4"></li>
                    
                    <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a itemprop="item" title="In NTDLL I Trust 8211 Process Reimaging and Endpoint Security Solution Bypass" href="#"><span itemprop="name">In NTDLL I Trust 8211 Process Reimaging and Endpoint Security Solution Bypass</span></a><meta itemprop="position" content="5"></li>
                                   </ul>
        </div>
        <style type="text/css">
            .breadcrumb-container {
                font-size: 13px;
            }
            .breadcrumb-container ul {
                margin: 0;
                padding: 0;
            }
            .breadcrumb-container li {
                box-sizing: unset;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            .breadcrumb-container li a {
                box-sizing: unset;
                padding: 0 10px;
            }
            .breadcrumb-container {
                font-size: 12px  !important;
                padding: 0px;
                margin: 0px;
            }
            .breadcrumb-container li a{
                color:  #c01818  !important;
                font-size:  12px  !important;
                line-height:  12px  !important;
            }
            .breadcrumb-container li .separator {
                color: #53565a  !important;
                font-size:  12px  !important;
            }
                            .breadcrumb-container li:last-child .separator {
                    display: none;
                }
                
							
							
.breadcrumb-container.theme1 li {
	margin: 0;
	padding: 0;
}							
							
.breadcrumb-container.theme1 a {
	background: ;
	display: inline-block;
	margin: 0 5px;
	padding: 5px 10px;
	text-decoration: none;
}

.breadcrumb-container{}
.breadcrumb-container ul{}
.breadcrumb-container li{}
.breadcrumb-container a{}
.breadcrumb-container .separator{}
        </style>
                </div>		 
    </div>

    <div class="wrap-section padding-small article">  
        <div class="container medium"> 
            <div class="border-line"></div>

            <div class="author-block padding-bottom-xs">
                <img class="author" src="/wp-content/uploads/2019/03/Eoin-Carroll-Pic-1-300x300.jpg" />
                <div class="meta">By <a href="/blogs/author/eoin-carroll/" title="Posts by Eoin Carroll" class="author url fn" rel="author">Eoin Carroll</a>, <a href="/blogs/author/cedric-cochin/" title="Posts by Cedric Cochin" class="author url fn" rel="author">Cedric Cochin</a>, <a href="/blogs/author/steve-povolny/" title="Posts by Steve Povolny" class="author url fn" rel="author">Steve Povolny</a> and <a href="/blogs/author/steve-hearnden/" title="Posts by Steve Hearnden" class="author url fn" rel="author">Steve Hearnden</a> on Jun 20, 2019</div>
            </div>

                    <h3>Process Reimaging Overview</h3>
<p>The Windows Operating System has inconsistencies in how it determines process image FILE_OBJECT locations, which impacts non-EDR (Endpoint Detection and Response) Endpoint Security Solution’s (such as Microsoft Defender Realtime Protection), ability to detect the correct binaries loaded in malicious processes. This inconsistency has led McAfee’s Advanced Threat Research to develop a new post-exploitation evasion technique we call “Process Reimaging”. This technique is equivalent in impact to <a href="https://attack.mitre.org/techniques/T1093/" target="_blank" rel="noopener noreferrer">Process Hollowing</a> or <a href="https://attack.mitre.org/techniques/T1186/" target="_blank" rel="noopener noreferrer">Process Doppelganging</a> within the Mitre Attack Defense Evasion Category; however, it is , much easier to execute as it requires no code injection. While this bypass has been successfully tested against current versions of Microsoft Windows and Defender, it is highly likely that the bypass will work on any endpoint security vendor or product implementing the APIs discussed below.</p>
<p>The Windows Kernel, ntoskrnl.exe, exposes functionality through NTDLL.dll APIs to support User-mode components such as Endpoint Security Solution (ESS) services and processes. One such API is K32GetProcessImageFileName, which allows ESSs to verify a process attribute to determine whether it contains malicious binaries and whether it can be trusted to call into its infrastructure. The Windows Kernel APIs return stale and inconsistent FILE_OBJECT paths, which enable an adversary to bypass Windows operating system process attribute verification. We have developed a proof-of-concept which exploits this FILE_OBJECT location inconsistency by hiding the physical location of a process EXE.</p>
<p>The PoC allowed us to persist a malicious process (post exploitation) which does not get detected by Windows Defender.</p>
<p>The Process Reimaging technique cannot be detected by Windows Defender until it has a signature for the malicious file and blocks it on disk before process creation or performs a full scan on suspect machine post compromise to detect file on disk. In addition to Process Reimaging Weaponization and Protection recommendations, this blog includes a technical deep dive on reversing the Windows Kernel APIs for process attribute verification and Process Reimaging attack vectors. We use the SynAck Ransomware as a case study to illustrate Process Reimaging impact relative to Process Hollowing and Doppelganging; this illustration does not relate to Windows Defender ability to detect Process Hollowing or Doppelganging but the subverting of trust for process attribute verification.</p>
<h3>Antivirus Scanner Detection Points</h3>
<p>When an Antivirus scanner is active on a system, it will protect against infection by detecting running code which contains malicious content, and by detecting a malicious file at write time or load time.</p>
<p>The actual sequence for loading an image is as follows:</p>
<ul>
<li>FileCreate – the file is opened to be able to be mapped into memory.</li>
<li>Section Create – the file is mapped into memory.</li>
<li>Cleanup – the file handle is closed, leaving a kernel object which is used for PAGING_IO.</li>
<li>ImageLoad – the file is loaded.</li>
<li>CloseFile – the file is closed.</li>
</ul>
<p>If the Antivirus scanner is active at the point of load, it can use any one of the above steps (1,2 and 4) to protect the operating system against malicious code. If the virus scanner is not active when the image is loaded, or it does not contain definitions for the loaded file, it can query the operating system for information about which files make up the process and scan those files. Process Reimaging is a mechanism which circumvents virus scanning at step 4, or when the virus scanner either misses the launch of a process or has inadequate virus definitions at the point of loading.</p>
<p>There is currently no documented method to securely identify the underlying file associated with a running process on windows.</p>
<p>This is due to Windows’ inability to retrieve the correct image filepath from the NTDLL APIs.  This can be shown to evade Defender (MpMsEng.exe/MpEngine.dll) where the file being executed is a “Potentially Unwanted Program” such as mimikatz.exe. If Defender is enabled during the launch of mimikatz, it detects at phase 1 or 2 correctly.  If Defender is not enabled, or if the launched program is not recognized by its current signature files, then the file is allowed to launch. Once Defender is enabled, or the signatures are updated to include detection, then Defender uses K32GetProcessImageFileName to identify the underlying file. If the process has been created using our Process Reimaging technique, then the running malware is no longer detected. Therefore, any security service auditing running programs will fail to identify the files associated with the running process.</p>
<h3>Subverting Trust</h3>
<p>The <a href="https://attack.mitre.org/" target="_blank" rel="noopener noreferrer">Mitre ATT&amp;CK model</a> specifies post-exploitation tactics and techniques used by adversaries, based on real-world observations for Windows, Linux and macOS Endpoints per figure 1 below.</p>
<p><strong>Figure 1 – Mitre Enterprise ATT&amp;CK</strong></p>
<p><img class="alignnone wp-image-95609 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture1-3.png" alt="" width="1020" height="481" srcset="/wp-content/uploads/2019/06/Picture1-3.png 1020w, /wp-content/uploads/2019/06/Picture1-3-300x141.png 300w, /wp-content/uploads/2019/06/Picture1-3-768x362.png 768w" sizes="(max-width: 1020px) 100vw, 1020px" /></p>
<p>Once an adversary gains code execution on an endpoint, before lateral movement, they will seek to gain persistence, privilege escalation and defense evasion capabilities. They can achieve defense evasion using process manipulation techniques to get code executing in a trusted process. Process manipulation techniques have existed for a long time and evolved from Process Injection to Hollowing and Doppelganging with the objective of impersonating trusted processes. There are other Process manipulation techniques as documented by Mitre ATT&amp;CK and <a href="https://www.blackhat.com/asia-19/arsenal/schedule/index.html#unprotect-project-unprotect-malware-for-the-mass-14377" target="_blank" rel="noopener noreferrer">Unprotect Project</a>,  but we will focus on Process Hollowing and Process Doppelganging. Process manipulation techniques exploit legitimate features of the Windows Operating System to impersonate trusted process executable binaries and generally require code injection.</p>
<p>ESSs place inherent trust in the Windows Operating System for capabilities such as digital signature validation and process attribute verification. As demonstrated by <a href="https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf" target="_blank" rel="noopener noreferrer">Specter Ops</a>, ESSs’ trust in the Windows Operating system could be subverted for digital signature validation.</p>
<p>Similarly, Process Reimaging subverts an ESSs’ trust in the Windows Operating System for process attribute verification.</p>
<p>When a process is trusted by an ESS, it is perceived to contain no malicious code and may also be trusted to call into the ESS trusted infrastructure.</p>
<p><a href="https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/apply-mitres-attck-model-to-check-your-defenses/" target="_blank" rel="noopener noreferrer">McAfee ATR uses the Mitre ATT&amp;CK framework</a> to map adversarial techniques, such as defense evasion, with associated campaigns. This insight helps organizations understand adversaries’ behavior and evolution so that they can assess their security posture and respond appropriately to contain and eradicate attacks. <a href="https://github.com/advanced-threat-research/Yara-Rules" target="_blank" rel="noopener noreferrer">McAfee ATR creates and shares Yara rules</a> based on threat analysis to be consumed for protect and detect capabilities.</p>
<h3>Process Manipulation Techniques (SynAck Ransomware)</h3>
<p>McAfee Advanced Threat Research analyzed SynAck ransomware in 2018 and discovered it used Process Doppelganging with Process Hollowing as its fallback defense evasion technique. We use this malware to explain the Process Hollowing and Process Doppelganging techniques, so that they can be compared to Process Reimaging based on a real-world observation.</p>
<p>Process Manipulation defense evasion techniques continue to evolve. <a href="https://www.blackhat.com/eu-17/briefings/schedule/index.html#lost-in-transaction-process-doppelgnging-8811" target="_blank" rel="noopener noreferrer">Process Doppelganging was publicly announced in 2017</a>, requiring advancements in ESSs for protection and detection capabilities. Because process manipulation techniques generally exploit legitimate features of the Windows Operating system they can be difficult to defend against if the Antivirus scanner does not block prior to process launch.</p>
<h5>Process Hollowing</h5>
<p>“<a href="https://attack.mitre.org/techniques/T1093/">Process hollowing</a> occurs when a process is created in a suspended state then its memory is unmapped and replaced with malicious code. Execution of the malicious code is masked under a legitimate process and may evade defenses and detection analysis” (see figure 2 below)</p>
<p><strong>Figure 2 – SynAck Ransomware Defense Evasion with Process Hollowing</strong></p>
<p><img class="alignnone wp-image-95610 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture2-2.png" alt="" width="1350" height="658" srcset="/wp-content/uploads/2019/06/Picture2-2.png 1350w, /wp-content/uploads/2019/06/Picture2-2-300x146.png 300w, /wp-content/uploads/2019/06/Picture2-2-768x374.png 768w, /wp-content/uploads/2019/06/Picture2-2-1024x499.png 1024w, /wp-content/uploads/2019/06/Picture2-2-1026x500.png 1026w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<h5>Process Doppelganging</h5>
<p>“<a href="https://attack.mitre.org/techniques/T1186/" target="_blank" rel="noopener noreferrer">Process Doppelgänging</a> involves replacing the memory of a legitimate process, enabling the veiled execution of malicious code that may evade defenses and detection. Process Doppelgänging&#8217;s use of Windows Transactional NTFS (TxF) also avoids the use of highly-monitored API functions such as NtUnmapViewOfSection, VirtualProtectEx, and SetThreadContext” (see figure 3 below)</p>
<p><strong>Figure 3 – SynAck Ransomware Defense Evasion with Doppleganging</strong></p>
<p><img class="alignnone wp-image-95611 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture3-2.png" alt="" width="1350" height="658" srcset="/wp-content/uploads/2019/06/Picture3-2.png 1350w, /wp-content/uploads/2019/06/Picture3-2-300x146.png 300w, /wp-content/uploads/2019/06/Picture3-2-768x374.png 768w, /wp-content/uploads/2019/06/Picture3-2-1024x499.png 1024w, /wp-content/uploads/2019/06/Picture3-2-1026x500.png 1026w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<h5>Process Reimaging Weaponization</h5>
<p>The Windows Kernel APIs return stale and inconsistent FILE_OBJECT paths which enable an adversary to bypass windows operating system process attribute verification. This allows an adversary to persist a malicious process (post exploitation) by hiding the physical location of a process EXE (see figure 4 below).</p>
<p><strong>Figure 4 &#8211;</strong> <strong>SynAck Ransomware Defense Evasion with Process Reimaging</strong></p>
<p><img class="alignnone wp-image-95612 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture4-2.png" alt="" width="1350" height="656" srcset="/wp-content/uploads/2019/06/Picture4-2.png 1350w, /wp-content/uploads/2019/06/Picture4-2-300x146.png 300w, /wp-content/uploads/2019/06/Picture4-2-768x373.png 768w, /wp-content/uploads/2019/06/Picture4-2-1024x498.png 1024w, /wp-content/uploads/2019/06/Picture4-2-1029x500.png 1029w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<h3>Process Reimaging Technical Deep Dive</h3>
<p>NtQueryInformationProcess retrieves all process information from EPROCESS structure fields in the kernel and NtQueryVirtualMemory retrieves information from the Virtual Address Descriptors (VADs) field in EPROCESS structure.</p>
<p>The EPROCESS structure contains filename and path information at the following fields/offsets (see figure 5 below):</p>
<ul>
<li>+0x3b8 SectionObject (filename and path)</li>
<li>+0x448 ImageFilePointer<strong>*</strong> (filename and path)</li>
<li>+0x450 ImageFileName (filename)</li>
<li>+0x468 SeAuditProcessCreationInfo (filename and path)</li>
</ul>
<p><strong>* </strong>this field is only present in Windows 10</p>
<p><strong>Figure 5 – Code Complexity IDA Graph Displaying NtQueryInformationProcess Filename APIs within NTDLL</strong></p>
<p><img class="alignnone wp-image-95613 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture5-2.png" alt="" width="1025" height="600" srcset="/wp-content/uploads/2019/06/Picture5-2.png 1025w, /wp-content/uploads/2019/06/Picture5-2-300x176.png 300w, /wp-content/uploads/2019/06/Picture5-2-768x450.png 768w, /wp-content/uploads/2019/06/Picture5-2-1024x599.png 1024w, /wp-content/uploads/2019/06/Picture5-2-854x500.png 854w" sizes="(max-width: 1025px) 100vw, 1025px" /></p>
<p>Kernel API NtQueryInformationProcess is consumed by following the kernelbase/NTDLL APIs:</p>
<ul>
<li>K32GetModuleFileNameEx</li>
<li>K32GetProcessImageFileName</li>
<li>QueryFullProcessImageImageFileName</li>
</ul>
<p>The VADs hold a pointer to FILE_OBJECT for all mapped images in the process, which contains the filename and filepath (see figure 6 below).</p>
<p>Kernel API NtQueryVirtualMemory is consumed by following the kernelbase/NTDLL API:</p>
<ul>
<li>GetMappedFileName</li>
</ul>
<p><strong>Figure 6 &#8211; Code Complexity IDA Graph Displaying NtQueryVirtualMemory Filename API within NTDLL</strong></p>
<p><img class="alignnone wp-image-95614 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture6-2.png" alt="" width="891" height="550" srcset="/wp-content/uploads/2019/06/Picture6-2.png 891w, /wp-content/uploads/2019/06/Picture6-2-300x185.png 300w, /wp-content/uploads/2019/06/Picture6-2-768x474.png 768w, /wp-content/uploads/2019/06/Picture6-2-810x500.png 810w" sizes="(max-width: 891px) 100vw, 891px" /></p>
<p>Windows fails to update any of the above kernel structure fields when a FILE_OBJECT filepath is modified post-process creation. Windows does update FILE_OBJECT filename changes, for some of the above fields.</p>
<p>The VADs reflect any filename change for a loaded image after process creation, but they don’t reflect any rename of the filepath.</p>
<p>The EPROCESS fields also fail to reflect any renaming of the process filepath and only the ImageFilePointer field reflects a filename change.</p>
<p>As a result, the APIs exported by NtQueryInformationProcess and NtQueryVirtualMemory return incorrect process image file information when called by ESSs or other Applications (see Table 1 below).</p>
<p><strong>Table 1 OS/Kernel version and API Matrix</strong></p>
<p><img class="alignnone wp-image-95622 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.18.59-AM.png" alt="" width="1856" height="428" srcset="/wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.18.59-AM.png 1856w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.18.59-AM-300x69.png 300w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.18.59-AM-768x177.png 768w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.18.59-AM-1024x236.png 1024w" sizes="(max-width: 1856px) 100vw, 1856px" /></p>
<h5>Prerequisites for all Attack Vectors</h5>
<p>Process Reimaging targets the post-exploitation phase, whereby a threat actor has already gained access to the target system. This is the same prerequisite of Process Hollowing or Doppelganging techniques within the Defense Evasion category of the Mitre ATT&amp;CK framework.</p>
<h5>Process Reimaging Attack Vectors</h5>
<h6>FILE_OBJECT Filepath Changes</h6>
<p>Simply renaming the filepath of an executing process results in Windows OS returning the incorrect image location information for all APIs (See figure 7 below).  This impacts all Windows OS versions at the time of testing.</p>
<p><strong>Figure 7 FILE_OBJECT Filepath Changes &#8211; Filepath Changes Impact all Windows OS versions</strong></p>
<p><img class="alignnone wp-image-95615 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture7-1.png" alt="" width="1350" height="854" srcset="/wp-content/uploads/2019/06/Picture7-1.png 1350w, /wp-content/uploads/2019/06/Picture7-1-300x190.png 300w, /wp-content/uploads/2019/06/Picture7-1-768x486.png 768w, /wp-content/uploads/2019/06/Picture7-1-1024x648.png 1024w, /wp-content/uploads/2019/06/Picture7-1-790x500.png 790w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<h6>FILE_OBJECT Filename Changes</h6>
<p><strong>Filename Change &gt;= Windows 10</strong></p>
<p>Simply renaming the filename of an executing process results in Windows OS returning the incorrect image information for K32GetProcessImageFileName API (See figure 8.1.1 below). This has been confirmed to impact Windows 10 only.</p>
<p><strong>Figure 8.1.1 FILE_OBJECT Filename Changes &#8211; Filename Changes impact Windows &gt;= Windows 10</strong></p>
<p><img class="alignnone wp-image-95616 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture8-1.png" alt="" width="1350" height="854" srcset="/wp-content/uploads/2019/06/Picture8-1.png 1350w, /wp-content/uploads/2019/06/Picture8-1-300x190.png 300w, /wp-content/uploads/2019/06/Picture8-1-768x486.png 768w, /wp-content/uploads/2019/06/Picture8-1-1024x648.png 1024w, /wp-content/uploads/2019/06/Picture8-1-790x500.png 790w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<p>Per figure 8.1.2 below, GetModuleFileNameEx and QueryFullProcessImageImageFileName will get the correct filename changes due to a new EPROCESS field ImageFilePointer at offset 448.  The instruction there (mov r12, [rbx+448h]) references the ImageFilePointer from offset 448 into the EPROCESS structure.</p>
<p><strong>Figure 8.1.2 NtQueryInformationProcess (Windows 10) &#8211; </strong>Windows 10 RS1 x64 ntoskrnl version 10.0.14393.0</p>
<p><img class="alignnone wp-image-95617 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture9-1.png" alt="" width="847" height="639" srcset="/wp-content/uploads/2019/06/Picture9-1.png 847w, /wp-content/uploads/2019/06/Picture9-1-300x226.png 300w, /wp-content/uploads/2019/06/Picture9-1-768x579.png 768w, /wp-content/uploads/2019/06/Picture9-1-663x500.png 663w" sizes="(max-width: 847px) 100vw, 847px" /></p>
<p><strong>Filename Change &lt; Windows 10</strong></p>
<p>Simply renaming the filename of an executing process results in Windows OS returning the incorrect image information for K32GetProcessImageFileName, GetModuleFileNameEx and QueryFullProcessImageImageFileName APIs (See figure 8.2.1 below). This has been confirmed to impact Windows 7 and Windows 8.</p>
<p><strong>Figure 8.2.1 FILE_OBJECT Filename Changes &#8211; Filename Changes Impact Windows &lt; Windows 10</strong></p>
<p><img class="alignnone wp-image-95618 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture10-1.png" alt="" width="1350" height="862" srcset="/wp-content/uploads/2019/06/Picture10-1.png 1350w, /wp-content/uploads/2019/06/Picture10-1-300x192.png 300w, /wp-content/uploads/2019/06/Picture10-1-768x490.png 768w, /wp-content/uploads/2019/06/Picture10-1-1024x654.png 1024w, /wp-content/uploads/2019/06/Picture10-1-783x500.png 783w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<p>Per Figure8.2.2 below, GetModuleFileNameEx and QueryFullProcessImageImageFileName will get the incorrect filename (PsReferenceProcessFilePointer references EPROCESS offset 0x3b8 SectionObject).</p>
<p><strong>Figure 8.2.2 NtQueryInformationProcess (Windows 7 and 8) &#8211; </strong>Windows 7 SP1 x64 ntoskrnl version 6.1.7601.17514</p>
<p><img class="alignnone wp-image-95619 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture11-1.png" alt="" width="679" height="702" srcset="/wp-content/uploads/2019/06/Picture11-1.png 679w, /wp-content/uploads/2019/06/Picture11-1-290x300.png 290w, /wp-content/uploads/2019/06/Picture11-1-484x500.png 484w, /wp-content/uploads/2019/06/Picture11-1-24x24.png 24w" sizes="(max-width: 679px) 100vw, 679px" /></p>
<h6>LoadLibrary FILE_OBJECT reuse</h6>
<p>LoadLibrary FILE_OBJECT reuse leverages the fact that when a LoadLibrary or CreateProcess is called after a LoadLibrary and FreeLibrary on an EXE or DLL, the process reuses the existing image FILE_OBJECT in memory from the prior LoadLibrary.</p>
<p><strong>Exact Sequence is:</strong></p>
<ol>
<li>LoadLibrary (path\filename)</li>
<li>FreeLibrary (path\filename)</li>
<li>LoadLibrary (renamed path\filename) or CreateProcess (renamed path\filename)</li>
</ol>
<p>This results in Windows creating a VAD entry in the process at step 3 above, which reuses the same FILE_OBJECT still in process memory, created from step 1 above. The VAD now has incorrect filepath information for the file on disk and therefore the GetMappedFileName API will return the incorrect location on disk for the image in question.</p>
<p><strong>The following prerequisites are required to evade detection successfully:</strong></p>
<ul>
<li>The LoadLibrary or CreateProcess must use the exact same file on disk as the initial LoadLibrary</li>
<li>Filepath must be renamed (dropping the same file into a newly created path will not work)</li>
</ul>
<p><strong>The Process Reimaging technique can be used in two ways with LoadLibrary FILE_OBJECT reuse attack vector:</strong></p>
<ol>
<li>LoadLibrary (see figure 9 below)</li>
<li style="list-style-type: none;">
<ol>
<li>When an ESS or Application calls the GetMappedFileName API to retrieve a memory-mapped image file, Process Reimaging will cause Windows OS to return the incorrect path. This impacts all Windows OS versions at the time of testing.</li>
</ol>
</li>
</ol>
<p><strong>Figure 9 LoadLibrary FILE_OBJECT Reuse (LoadLibrary) &#8211; Process Reimaging Technique Using LoadLibrary Impacts all Windows OS Versions</strong></p>
<p><img class="alignnone wp-image-95620 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture12-1.png" alt="" width="1350" height="750" srcset="/wp-content/uploads/2019/06/Picture12-1.png 1350w, /wp-content/uploads/2019/06/Picture12-1-300x167.png 300w, /wp-content/uploads/2019/06/Picture12-1-768x427.png 768w, /wp-content/uploads/2019/06/Picture12-1-1024x569.png 1024w, /wp-content/uploads/2019/06/Picture12-1-900x500.png 900w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<p>2. CreateProcess (See figure 10 below)</p>
<ol>
<li style="list-style-type: none;">
<ol>
<li>When an ESS or Application calls the GetMappedFileName API to retrieve the process image file, Process Reimaging will cause Windows OS to return the incorrect path. This impacts all Windows OS versions at the time of testing.</li>
</ol>
</li>
</ol>
<p><strong>Figure 10 LoadLibrary FILE_OBJECT Reuse (CreateProcess) &#8211; Process Reimaging Technique using CreateProcess Impacts all Windows OS Versions</strong></p>
<p><img class="alignnone wp-image-95621 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Picture13-1.png" alt="" width="1350" height="770" srcset="/wp-content/uploads/2019/06/Picture13-1.png 1350w, /wp-content/uploads/2019/06/Picture13-1-300x171.png 300w, /wp-content/uploads/2019/06/Picture13-1-768x438.png 768w, /wp-content/uploads/2019/06/Picture13-1-1024x584.png 1024w, /wp-content/uploads/2019/06/Picture13-1-877x500.png 877w" sizes="(max-width: 1350px) 100vw, 1350px" /></p>
<h3>Process Manipulation Techniques Comparison</h3>
<p><img class="alignnone wp-image-95623 size-full" src="https://securingtomorrow.mcafee.com/wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM.png" alt="" width="1818" height="628" srcset="/wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM.png 1818w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM-300x104.png 300w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM-768x265.png 768w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM-1024x354.png 1024w, /wp-content/uploads/2019/06/Screen-Shot-2019-06-14-at-10.19.54-AM-1447x500.png 1447w" sizes="(max-width: 1818px) 100vw, 1818px" /></p>
<h3>Windows Defender Process Reimaging Filepath Bypass Demo</h3>
<p class="Standard">This video simulates a zero-day malware being dropped (Mimikatz PUP sample) to disk and executed as the malicious process “phase1.exe”. Using the Process Reimaging Filepath attack vector we demonstrate that even if Defender is updated with a signature for the malware on disk it will not detect the running malicious process. Therefore, for non-EDR ESSs such as Defender Real-time Protection (used by Consumers and also Enterprises) the malicious process can dwell on a windows machine until a reboot or the machine receives a full scan post signature update.</p>
<p><iframe src="https://www.youtube.com/embed/dQogaxinTXk" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>
<h3>CVSS and Protection Recommendations</h3>
<h4>CVSS</h4>
<p>If a product uses any of the APIs listed in table 1 for the following use cases, then it is likely vulnerable:</p>
<ol>
<li>Process reputation of a remote process – any product using the APIs to determine if executing code is from a malicious file on disk</li>
</ol>
<p><strong>CVSS score 5.0 (Medium)</strong>  <a href="https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:R/S:U/C:N/I:H/A:N" target="_blank" rel="noopener noreferrer">https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:R/S:U/C:N/I:H/A:N</a> (same score as Doppelganging)</p>
<ol start="2">
<li>Trust verification of a remote process &#8211; any product using the APIs to verify trust of a calling process</li>
</ol>
<p><strong>CVSS score will be higher than 5.0; scoring specific to Endpoint Security Solution architecture</strong></p>
<h4>Protection Recommendations</h4>
<p>McAfee Advanced Threat Research submitted Process Reimaging technique to Microsoft on June 5<sup>th</sup>, 2018. Microsoft released a partial mitigation to Defender in the June 2019 Cumulative update for the Process Reimaging FILE_OBJECT filename changes attack vector only. This update was only for Windows 10 and does not address the vulnerable APIs in Table 1 at the OS level; therefore, ESSs are still vulnerable to Process Reimaging. Defender also remains vulnerable to the FILE_OBJECT filepath changes attack vector executed in the bypass demo video, and this attack vector affects all Windows OS versions.</p>
<p>New and existing Process Manipulation techniques which abuse legitimate Operating System features for defense evasion are difficult to prevent dynamically by monitoring specific API calls as it can lead to false positives such as preventing legitimate processes from executing.</p>
<p>A process which has been manipulated by Process Reimaging will be trusted by the ESS unless it has been traced by EDR or a memory scan which may provide deeper insight.</p>
<h6>Mitigations recommended to Microsoft</h6>
<ol>
<li>File System Synchronization (EPROCESS structures out of sync with the filesystem or File Control Block structure (FCB)
<ol>
<li>Allow the EPROCESS structure fields to reflect filepath changes as is currently implemented for the filename in the VADs and EPROCESS ImageFilePointer fields.</li>
<li>There are other EPROCESS fields which do not reflect changes to filenames and need to be updated, such as K32GetModuleFileNameEx on Windows 10 through the ImageFilePointer.</li>
</ol>
</li>
<li>API Usage (most returning file info for process creation time)
<ol>
<li>Defender (MpEngine.dll) currently uses K32GetProcessImageFileName to get process image filename and path when it should be using K32GetModuleFileNameEx.</li>
<li>Consolidate the duplicate APIs being exposed from NtQueryInformationProcess to provide easier management and guidance to consumers that require retrieving process filename information. For example, clearly state GetMappedFileName should only be used for DLLs and not EXE backing process).</li>
<li>Differentiate in API description whether the API is only limited to retrieving the filename and path at process creation or real-time at time of request.</li>
</ol>
</li>
<li>Filepath Locking
<ol>
<li>Lock filepath and name similar to lock file modification when a process is executing to prevent modification.</li>
<li>Standard user at a minimum should not be able to rename binary paths for its associated executing process.</li>
</ol>
</li>
<li>Reuse of existing FILE_OBJECT with LoadLibrary API <strong>(Prevent Process Reimaging)</strong>
<ol>
<li>LoadLibrary should verify any existing FILE_OBJECT it reuses, has the most up to date Filepath at load time.</li>
</ol>
</li>
<li>Short term mitigation is that Defender should at least flag that it found malicious process activity but couldn’t find associated malicious file on disk (right now it fails open, providing no notification as to any potential threats found in memory or disk).</li>
</ol>
<h6>Mitigation recommended to Endpoint Security Vendors</h6>
<p>The FILE_OBJECT ID must be tracked from FileCreate as the process closes its handle for the filename by the time the image is loaded at ImageLoad.</p>
<p>This ID must be managed by the Endpoint Security Vendor so that it can be leveraged to determine if a process has been reimaged when performing process attribute verification.</p>
        </div>
    </div>

    <div class="wrap-section">  
        <div class="container medium">
            <h3>About the Author</h3>
        </div>
    </div>

    <div class="wrap-section padding-small bg-light-gray author-container">  
        <div class="container medium"> 


                <div class="row">
                    <div class="col-sm-2 col-xs-4 text-center">
                        <a href="/blogs/author/eoin-carroll/"><img class="author" src="/wp-content/uploads/2019/03/Eoin-Carroll-Pic-1-300x300.jpg" /></a>
                        <ul class="social-networks">
                <li><a href="https://twitter.com/w3knight" rel="nofollow" target="_blank"><i class="symbol-twitter"></i><span>Twitter</span></a></li><li><a href="https://www.linkedin.com/in/eoin-carroll-641ba08/" rel="nofollow" target="_blank"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>                        </ul>
                    </div>
                    <div class="col-sm-10 col-xs-8">
                        <h3 class="red"><a href="/blogs/author/eoin-carroll/">Eoin Carroll</a></h3>
                        <p>Eoin Carroll is a Principal Engineer and Senior Vulnerability Researcher on the McAfee Advanced Threat Research team, focused on researching the trustworthiness of emerging computing platforms and protocols. He also analyzes critical industry vulnerabilities and innovates advanced threat defenses. He has 20 years of diverse experience, from electronic engineering to a variety of offensive and ...</p>						
                        <a href="/blogs/author/eoin-carroll/" class="caret-link">Read more posts from Eoin Carroll </a>
                    </div>
                </div><br/>
                            
                <div class="row">
                    <div class="col-sm-2 col-xs-4 text-center">
                        <a href="/blogs/author/cedric-cochin/"><img class="author" src="/wp-content/uploads/2018/06/CC_Blog-279x300.jpg" /></a>
                        <ul class="social-networks">
                <li><a href="https://twitter.com/th3c3dr1c" rel="nofollow" target="_blank"><i class="symbol-twitter"></i><span>Twitter</span></a></li><li><a href="https://www.linkedin.com/in/cochin/" rel="nofollow" target="_blank"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>                        </ul>
                    </div>
                    <div class="col-sm-10 col-xs-8">
                        <h3 class="red"><a href="/blogs/author/cedric-cochin/">Cedric Cochin</a></h3>
                        <p>Cedric Cochin is a Senior Security Architect, CyberThreat SME; and a Senior Principal Engineer on McAfee’s Future Threat Defense Technologies team. He 20 years of experience in information security. Cochin’s primary mission is to provide expertise to McAfee teams and serve as an expert on cybersecurity threats, understand the threat landscape and technologies to defeat ...</p>						
                        <a href="/blogs/author/cedric-cochin/" class="caret-link">Read more posts from Cedric Cochin </a>
                    </div>
                </div><br/>
                            
                <div class="row">
                    <div class="col-sm-2 col-xs-4 text-center">
                        <a href="/blogs/author/steve-povolny/"><img class="author" src="/wp-content/uploads/2019/04/steve_p_mcafee-300x261.png" /></a>
                        <ul class="social-networks">
                <li><a href="https://twitter.com/spovolny" rel="nofollow" target="_blank"><i class="symbol-twitter"></i><span>Twitter</span></a></li><li><a href="https://www.linkedin.com/in/steve-povolny-595a776/" rel="nofollow" target="_blank"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>                        </ul>
                    </div>
                    <div class="col-sm-10 col-xs-8">
                        <h3 class="red"><a href="/blogs/author/steve-povolny/">Steve Povolny</a></h3>
                        <p>Steve Povolny is the Head of McAfee Advanced Threat Research, which delivers groundbreaking vulnerability research spanning nearly every industry. With more than a decade of experience in network security, Steve is a recognized authority on hardware and software vulnerabilities, and regularly collaborates with influencers in academia, government, law enforcement, consumers and enterprise businesses of all ...</p>						
                        <a href="/blogs/author/steve-povolny/" class="caret-link">Read more posts from Steve Povolny </a>
                    </div>
                </div><br/>
                            
                <div class="row">
                    <div class="col-sm-2 col-xs-4 text-center">
                        <a href="/blogs/author/steve-hearnden/"><img class="author" src="/wp-content/uploads/2019/06/Eoin-300x169.jpg" /></a>
                        <ul class="social-networks">
                                        </ul>
                    </div>
                    <div class="col-sm-10 col-xs-8">
                        <h3 class="red"><a href="/blogs/author/steve-hearnden/">Steve Hearnden</a></h3>
                        <p>With over 20 years experience in the Anti-Virus Industry, Steve has been a key architect for change in gateway, desktop, and scanning technologies. Currently working in the kernel development team, Steve helps support the touch points between the scanning and protection technologies and the Windows operating system.</p>						
                        <a href="/blogs/author/steve-hearnden/" class="caret-link">Read more posts from Steve Hearnden </a>
                    </div>
                </div><br/>
                                    </div>
    </div>

    <div class="wrap-section padding-top-xs">  
        <div class="container medium"> 
            <div class="row">
                            <div class="col-sm-6 col-xs-6">
            <a href="/blogs/other-blogs/executive-perspectives/expanding-our-vision-to-expand-the-cybersecurity-workforce/" rel="prev"><i class="fa fa-angle-left" aria-hidden="true"></i> Previous Article</a> 
                </div>
                <div class="col-sm-6 col-xs-6 text-right">
<a href="/blogs/other-blogs/mcafee-labs/why-process-reimaging-matters/" rel="next">Next Article <i class="fa fa-angle-right" aria-hidden="true"></i></a>                </div>
            </div>
        </div>
    </div>
    <div class="wrap-section padding-top-xs"> 
        <div class="container medium">
                    <p class="small rule">Categories: <a href="/blogs/other-blogs/mcafee-labs/" rel="category tag">McAfee Labs</a><br /> 
            </p>	

        </div>		 
    </div>
    <div class="container medium">
                    <ol class="commentlist">
                    </ol>
             
    </div>
    
    <div class="wrap-section padding-top-small">  
        <div class="container medium">
                                </div>
    </div>
        <div class="wrap-section bg-red bg-image padding-medium" id="subscribe">
      <div class="container medium">
        <div class="row">
          <div class="col-sm-12">
            <div class="cta-component text-center">
              <h3>Subscribe to McAfee Securing Tomorrow Blogs</h3>
                         <form method="get" action="/blogs/subscribe/" class="form-inline">
            
              <input type="text" placeholder="Email address" name="subscriber_email" />
          
            <button type="submit" class="btn transparent">Subscribe</button>
          </form>
              
            </div>
          </div>
        </div>
      </div>
    </div>

</main>
<!--Footer of en-us starts here --> 
    
	<aside class="tools">
		<a href="#wrapper" class="back-to-top">Back to top</a>
	</aside>
  
  <div class="textwidget custom-html-widget"><div class="wrap-section padding-bottom-medium padding-top-small bg-dark-gray" id="footer">
    <div class="container medium">           
      <div class="row">
         <div class="col-sm-6 breadcrumb">
        	<ul class="breadcrumb-list">
        		<li><a class="symbols-label first" href="/blogs"><i class="symbol-shield"></i><span>McAfee Home</span></a></li>
        		<li><a class="symbols-label" href="/blogs"><i class="symbol-arrow-forward"></i><span>Securing Tomorrow</span></a></li>
					 </ul>
				</div>
        <div class="col-sm-6 social">
          <!-- <a id="usbl-integrated-button" class="symbols-label" href=""><i class="symbol-feedback"></i><span>Feedback</span></a> -->
          <ul class="social-networks">
            <li><a href="https://twitter.com/mcafee" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="symbol-twitter"></i><span>Twitter</span></a></li>
            <li><a href="http://www.facebook.com/mcafee" title="Facebook" target="_blank" rel="noopener noreferrer"><i class="symbol-facebook"></i><span>Facebook</span></a></li>
            <li><a href="https://www.linkedin.com/company/2336?trk=prof-exp-company-name" title="LinkedIn" target="_blank" rel="noopener noreferrer"><i class="symbol-linkedin"></i><span>LinkedIn</span></a></li>
            <li><a href="http://www.youtube.com/mcafee" title="YouTube" target="_blank" rel="noopener noreferrer"><i class="symbol-youtube"></i><span>YouTube</span></a></li>
            <li><a href="/blogs/" title="Blog" target="_blank" rel="noopener noreferrer"><i class="symbol-blog"></i><span>Blog</span></a></li>
					</ul>
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col-sm-3">
          <a class="symbols-label" href="/enterprise/en-us/about/region-selector.html"><i class="symbol-language"></i><span>United States / English</span></a>
        </div>
        <div class="col-sm-9">
           <a href="//www.scanalert.com/RatingVerify?ref=www.mcafee.com" target="_blank" class="mcafee-secure" rel="noopener noreferrer"><img src="https://www.mcafee.com/enterprise/en-us/img/v1/common/logo-mcafee-secure.svg" alt="McAfee SECURE"/></a>
          <ul class="footer-menu">
            <li><a href="/enterprise/en-us/about/legal/privacy.html">Privacy</a></li>
            <li><a href="/enterprise/en-us/about/legal/notices.html">Legal Notices</a></li>
            <li><a href="/enterprise/en-us/about/legal/contracts-terms.html">Legal Contracts &amp; Terms</a></li>
            <li><a href="/enterprise/en-us/site-map.html">Site Map</a></li>
            <li>Copyright ©2020 McAfee, LLC</li>
          </ul>
        </div>
      </div>          
    </div>            	
  </div>
</div></div>


</body>	
<script type="text/javascript">
   if ($('div.author-block .meta').length > 0) {
      utag_data.tm_local_blogs_author = $('div.author-block .meta').text().split(' on ')[0].replace("By","").trim();
    }
    (function(a,b,c,d){
    a='//tags.tiqcdn.com/utag/mcafee/consumer-main/prod/utag.js'; // Note: Please use prod for production version and dev for dev version before release
    b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
    a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
    })();
</script>

<script type='text/javascript' src='/wp-content/plugins/metronet-profile-picture/js/mpp-frontend.js?ver=2.3.8'></script>
<script type='text/javascript'>
/* Highlight Search Terms 1.5 ( RavanH - http://status301.net/wordpress-plugins/highlight-search-terms/ ) */
var hlst_query = []; var hlst_areas = ["#groups-dir-list","#members-dir-list","div.bbp-topic-content,div.bbp-reply-content,li.bbp-forum-info,.bbp-topic-title,.bbp-reply-title","article","div.hentry","div.post","#content","#main","div.content","#middle","#container","div.container","div.page","#wrapper","body"];
</script>
<script type='text/javascript' src='/wp-content/plugins/highlight-search-terms/hlst-extend.min.js?ver=1.5'></script>
<script type='text/javascript' src='/wp-content/plugins/social-polls-by-opinionstage/public/js/shortcodes.js?ver=19.6.31'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpmm_object = {"ajax_url":"https:\/\/www.mcafee.com\/wp-admin\/admin-ajax.php","wpmm_responsive_breakpoint":"767px","wpmm_disable_mobile":"false"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/wp-megamenu/assets/js/wpmm.js?ver=1.3.1'></script>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/theme-script.js?ver=5.4.2'></script>
<script type='text/javascript' src='/wp-content/themes/securingtomorrow/js/skip-link-focus-fix.min.js?ver=20151215'></script>
<script type='text/javascript' src='/wp-content/plugins/super-socializer/js/front/social_login/general.js?ver=7.12.37'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=5.4.2'></script>
	
<script src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js?ver=10faaf528e636a046163bdb6753031b2"></script>
<script src="/wp-content/themes/securingtomorrow/js/jquery-lib.js"></script>
<script src="/wp-content/themes/securingtomorrow/js/main.js"></script>
<script src="/wp-content/themes/securingtomorrow/js/general_footer.js"></script>
<!-- Consumer Facebook Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '187610925152304');
  fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=187610925152304&ev=PageView&noscript=1"/></noscript>
<!-- End Facebook Pixel Code -->

<!-- Start linkedIn pixel -->
<script type="text/javascript">
_linkedin_partner_id = "68395";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);
</script><script type="text/javascript">
(function(){var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})();
</script>
<noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://dc.ads.linkedin.com/collect/?pid=68395&fmt=gif" />
</noscript>
<!-- End linkedIn pixel -->

<!-- Twitter universal website tag code -->
<script>
!function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
},s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
// Insert Twitter Pixel ID and Standard Event data below
twq('init','nxlgc');
twq('track','PageView');
</script>
<!-- Twitter universal website tag code -->

<script>
/* <![CDATA[ */
var google_conversion_id = 975085349;
var google_custom_params = window.google_tag_params;
var google_remarketing_only = true;
/* ]]> */
document.write('\x3Cscript type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">\x3C/script>');
//document.write('\x3Cnoscript>\x3Cimg height="1" width="1" style="border-style:none;display:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/975085349/?guid=ON&script=0"/>\x3C/noscript>');
</script>

<!-- Enterprise Facebook Pixel Code -->
<script>
// load Facebook
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '766537420057144');
fbq('track', "PageView");

//document.write('\x3Cnoscript>\x3Cimg height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=766537420057144&ev=PageView&noscript=1" />\x3C/noscript>');
</script>
<!-- Facebook Pixel Code -->

<!-- Adobe Launch START -->
<script src="//assets.adobedtm.com/launch-ENc117a6a508e14a879398dd6f37ed54a3.min.js"></script>
<!-- Adobe Launch END -->
<script>_satellite.pageBottom()</script>
</html>


<style>
    .commentlist {
        display: none;
    }
</style>
<!-- This website is like a Rocket, isn't it? Performance optimized by WP Rocket. Learn more: https://wp-rocket.me - Debug: cached@1616227445 -->