
<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preload" href="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/clearbit-autocomplete.css" as="style">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://usageanalytics.coveo.com">
  <link rel="preconnect" href="https://paloaltonetworks.tt.omtrdc.net">
  <link rel="preconnect" href="https://platform.cloud.coveo.com">
  <link rel="preconnect" href="https://assets.adobedtm.com">
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
  <!-- Adobe -->
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {opacity: 0 !important}", 3000));
</script>
<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<!-- End Adobe -->
  
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">

  <!-- Typekit -->
  <!--
  <script src="//use.typekit.net/itd3sep.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>-->
  <!-- End Typekit -->

 


    


<link rel="apple-touch-icon" sizes="57x57" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/favicon-194x194.png" sizes="194x194">
<link rel="icon" type="image/png" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/manifest.json">
<link rel="mask-icon" href="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/safari-pinned-tab.svg" color="#8ad3de">
<link rel="shortcut icon" href="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/assets/images/icons/favicon.ico">
<meta name="msapplication-TileImage" content="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/mstile-144x144.png">
<meta name="msapplication-config" content="https://www.paloaltonetworks.com/etc/clientlibs/pan/img/favicons2020/browserconfig.xml">
<meta name="msapplication-TileColor" content="#da532c">




  <!-- Start WP HEAD -->
  <link rel="alternate" hreflang="en" href="https://blog.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/" />

	<!-- This site is optimized with the Yoast SEO plugin v14.2 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>CVE-2014-7911 – A Deep Dive Analysis of Android System Service Vulnerability and Exploitation</title>
	<meta name="description" content="Here&#039;s a deep dive analysis from Palo Alto Networks of Android system service vulnerability and exploitation." />
	<meta name="robots" content="index, follow" />
	<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<link rel="canonical" href="https://blog.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="CVE-2014-7911 – A Deep Dive Analysis of Android System Service Vulnerability and Exploitation" />
	<meta property="og:description" content="Here&#039;s a deep dive analysis from Palo Alto Networks of Android system service vulnerability and exploitation." />
	<meta property="og:url" content="https://blog.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/" />
	<meta property="og:site_name" content="Palo Alto Networks Blog" />
	<meta property="article:published_time" content="2015-01-06T14:00:34+00:00" />
	<meta property="article:modified_time" content="2015-01-05T19:23:25+00:00" />
	<meta property="og:image" content="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-500x289.png" />
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Palo Alto Networks Blog &raquo; Feed" href="https://blog.paloaltonetworks.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Palo Alto Networks Blog &raquo; Comments Feed" href="https://blog.paloaltonetworks.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Palo Alto Networks Blog &raquo; CVE-2014-7911 – A Deep Dive Analysis of Android System Service Vulnerability and Exploitation Comments Feed" href="https://blog.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/feed/" />
<meta property="og:date_created" content="January 6, 2015 at 6:00 AM"/>
<meta property="og:post_image" content=""/>
<meta property="og:post_id" content="7779"/>
<meta property="og:post_total_likes" content="1"/>
<meta property="og:post_length" content="2445"/>
<meta property="og:category" content="Malware"/>
<meta property="og:category" content="Mobility"/>
<meta property="og:category" content="Threat Prevention"/>
<meta property="og:category_link" content="https://blog.paloaltonetworks.com/category/malware-2/"/>
<meta property="og:category_link" content="https://blog.paloaltonetworks.com/category/mobility/"/>
<meta property="og:category_link" content="https://blog.paloaltonetworks.com/category/threat-prevention-2/"/>
<meta property="og:author" content="Yaron Lavi"/>
<meta property="og:author" content="Nadav Markus"/>
<meta property="og:authorloginname" content="Yaron Lavi"/>
<meta property="og:authorloginname" content="Nadav Markus"/>
<meta property="og:authorlink" content="https://blog.paloaltonetworks.com/author/yaron-lavi/"/>
<meta property="og:authorlink" content="https://blog.paloaltonetworks.com/author/nadav-markus/"/>
<meta property="og:author_image_link" content="https://blog.paloaltonetworks.com/wp-content/uploads/2020/03/panw_master-twitter-profile-pic-400x400-1.png"/>
<meta property="og:author_image_link" content="https://blog.paloaltonetworks.com/wp-content/uploads/2020/03/panw_master-twitter-profile-pic-400x400-1.png"/>
<meta property="og:section" content="Palo Alto Networks"/>
<meta property="og:recent_views" content="512"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"CVE-2014-7911 \u2013 A Deep Dive Analysis of Android System Service Vulnerability and Exploitation","name":"CVE-2014-7911 \u2013 A Deep Dive Analysis of Android System Service Vulnerability and Exploitation","description":"In this post we discuss CVE-2014-7911 and the various techniques that can be used to achieve privilege escalation. We also examine how some of these techniques can be blocked using several security &hellip;","url":"https:\/\/blog.paloaltonetworks.com\/2015\/01\/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation\/","mainEntityOfPage":"https:\/\/blog.paloaltonetworks.com\/2015\/01\/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation\/","datePublished":"January 6, 2015","articleBody":"In this post we discuss CVE-2014-7911 and the various techniques that can be used to achieve privilege escalation. We also examine how some of these techniques can be blocked using several security mechanisms.\r\nThe Vulnerability\r\nCVE-2014-7911 was presented here along with a very descriptive POC that was written by Jann Horn. Described briefly, the ObjectInputStream doesn't validate that the serialized object's class type, as described in the serialized object, is actually serializable. It creates an instance of the wanted class anyway with the deserialized values of the object. Therefore, one can create object of any class, and control its private variables, by serializing objects from another class, that would be deserialized as data members of the wanted class.\r\n\r\nLet's look at the example below:\r\n\r\nThe following snippet (copied from the original POC) shows a spoofed BinderProxy instance:\r\npackage AAdroid.os;\r\n\r\nimport java.io.Serializable;\r\n\r\npublic class BinderProxy implements Serializable {\r\n        private static final long serialVersionUID = 0;\r\n        public long mObject = 0x1337beef;\r\n        public long mOrgue = 0x1337beef;\r\n}\r\n\r\nIn the POC code that was provided above, an attacker serializes a class named AAdroid.os.BinderProxy and changes its name to android.os.BinderProxy after marshalling it, and before sending it to the system server.\r\n\r\nandroid.os.BinderProxy class isn't serializable, and it involves native code that handles mObject and mOrgue as pointers.\u00a0\r\n\r\nIf it was serializable, then the pointers valued wouldn't be deserialized, but their dereferenced values would.\r\n\r\nThe deserialization code in ObjectInputStream deserializes the sent object as an android.os.BinderProxy instance, leading to type confusion.\r\n\r\nAs mentioned earlier, this type confusion results in the native code reading pointer values from the attacker's spoofed android.os.BinderProxy, supposedly private fields, which the attacker modified.\r\n\r\nSpecifically, the field of interest is mOrgue.\r\n\r\nThe android.os.BinderProxy contains a finalize method that will result in native code invocation. This native code uses mOrgue as a pointer.\r\n\r\nThis is the finalize method:\r\nprotected void finalize() throws Throwable {\r\n\tdestroy();\r\n\tsuper.finalize();\r\n\treturn;\r\n\tException exception;\r\n\texception;\r\n\tsuper.finalize();\r\n\tthrow exception;\r\n}\r\n\r\nAnd this is the declaration of destroy:\r\nprivate final native void destroy();\r\nThe native destroy function:\r\nstatic void android_os_BinderProxy_destroy(JNIEnv* env, jobject obj)\r\n{\r\n    IBinder* b = (IBinder*)\r\n            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);\r\n    DeathRecipientList* drl = (DeathRecipientList*)\r\n            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);\r\n    LOGDEATH(\"Destroying BinderProxy %p: binder=%p drl=%p\\n\", obj, b, drl);\r\n    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, 0);\r\n    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, 0);\r\n    drl-&gt;decStrong((void*)javaObjectForIBinder);\r\n    b-&gt;decStrong((void*)javaObjectForIBinder);\r\n    IPCThreadState::self()-&gt;flushCommands();\r\n}\r\n\r\nEventually, the native code invokes decStrong\r\n(i.e., in drl-&gt;decStrong((void*)javaObjectForIBinder);)\r\nNote that at this point, drl is controlled by an attacker, as evident by the line\r\nDeathRecipientList* drl = (DeathRecipientList*)\r\n            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);\r\n\r\nSo decStrong is going to be called with us controlling 'this' pointer.\r\n\r\nLet's take a look on decStrong code from RefBase class source:\r\nvoid RefBase::decStrong(const void* id) const\r\n{\r\n    weakref_impl* const refs = mRefs;\r\n    refs-&gt;removeStrongRef(id);\r\n    const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);\r\n#if PRINT_REFS\r\n    ALOGD(\"decStrong of %p from %p: cnt=%d\\n\", this, id, c);\r\n#endif\r\n    ALOG_ASSERT(c &gt;= 1, \"decStrong() called on %p too many times\", refs);\r\n    if (c == 1) {\r\n        refs-&gt;mBase-&gt;onLastStrongRef(id);\r\n        if ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {\r\n            delete this;\r\n        }\r\n    }\r\n    refs-&gt;decWeak(id);\r\n}\r\n\r\nNote the line refs-&gt;mBase-&gt;onLastStrongRef(id);\u00a0These lines will eventually lead to arbitrary code execution.\r\n\r\nIn the following screenshot of RefBase::decStrong assembly, the attacker controls r0('this pointer')\r\n\r\n\r\nExploitation\r\nThe first use of the controlled register r0, which contains the 'this' pointer (drl) is in these lines:\r\nweakref_impl* const refs = mRefs;\r\nrefs-&gt;removeStrongRef(id);\r\nconst int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);\r\n\r\nThese lines are translated to the following assembly:\r\nldr     r4, [r0, #4]   # attacker controls r4\r\nmov     r6, r1\r\nmov     r0, r4\r\nblx     &lt;android_atomic_dec ()&gt;\r\n\r\nFirst, r4 is loaded with the mRefs variable.\r\nldr     r4, [r0, #4]   # attacker controls r4\r\nNote that r0 is the 'this' pointer of the drl, and mRefs is the first private variable following the virtual function table, hence it is 4 bytes after 'this' pointer.\r\n\r\nThen, android_atomic_dec is being called with &amp;refs-&gt;mStrong\r\n\tconst int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);\r\nThis is translated to:\r\nmov     r0, r4\r\n  blx     &lt;android_atomic_dec ()&gt;\r\n\r\nr0 now contains &amp;refs-&gt;mStrong.\r\n\r\nNote that the mStrong variable is the first data member of refs\u00a0(in the class weakref_impl), and that this class contains no virtual functions, hence it does not contain a vtable, so the mStrong variable is at offset 0 of r4.\r\n\r\nAs one can tell - \u00a0the line refs-&gt;removeStrongRef(id); is not present in the assembly\u00a0 simply because the compiler optimized and omitted it, since it has an empty implementation, as one can see from the following code:\r\nvoid removeStrongRef(const void* \/*id*\/) { }\r\nFollowing the call to android_atomic_dec are these lines of code:\r\nif (c == 1) {\r\n\trefs-&gt;mBase-&gt;onLastStrongRef(id);\r\n\r\nThese are translated to the following assembly lines:\r\ncmp     r0, #1\r\nbne.n   d1ea\r\nldr     r0, [r4, #8] \r\nmov     r1, r6\r\nldr     r3, [r0, #0] \r\nldr     r2, [r3, #12]\r\nblx     r2       \r\n\r\nNote that android_atomic_dec returns the value of the specified memory address before the decrement took place. So in order to invoke refs-&gt;mBase-&gt;onLastStrongRef(id) (blx r2), we must get refs-&gt;mStrong to get the value of 1.\r\n\r\nAs we can see up to now, an attacker has several constraints that he must adhere to if he wishes to gain code execution:\r\n\r\n\tdrl (our first controlled pointer, i.e. r0 when entering decStrong) must point to a readable memory location.\r\n\trefs-&gt;mStrong must have the value of 1\r\n\tThe dereference chain at the line refs-&gt;mBase-&gt;onLastStrongRef(id) must succeed and eventually point to an executable address.\r\n\r\nIn addition, an attacker must overcome the usual obstacles of exploitation - ASLR and DEP.\r\n\r\nOne can employ basic techniques to fulfill these requirements and overcome the mentioned security mechanisms, including heap spraying, stack pivoting and ROP. Let\u2019s look at these in detail.\r\nHeap spray\r\nAn attacker's first step will be to get a reliable readable address with arbitrary data - most commonly achieved by a heap spray.\r\n\r\nThe system server provides several core functionalities for the android device, many of which are exposed to applications via various service interfaces.\r\n\r\nA common paradigm to invoke a service in the context of the system server is like the following:\r\nLocationManager lm = (LocationManager)getSystemService(LOCATION_SERVICE);\r\nThe acquired manager allows us to invoke functionality in the system server on behalf of us, via IPC.\r\n\r\nSeveral services can be used by us for a heap spray, but for the purpose of this blog, we decided to use a heap spray that requires special app permissions, to prevent normal applications from utilizing this technique.\r\n\r\nThe location manager allows us to register test providers via the function addTestProvider - allowing us to pass an arbitrary name that contains arbitrary data. As we mentioned, one should enable developer options and enable the mock locations option in order to utilize this.\r\nlm.addTestProvider(builder.toString(), false, false, false, false, false, false, false, 1, 1);\r\nNote that this heap spray does have its limitations \u2013 the data is sprayed using the name field, which is Unicode. This imposes a limitation \u2013 we are limited to byte sequences which correspond to valid Unicode code points.\r\nSpray addresses manipulation\r\nAfter spraying the system server process memory address space, we encountered another issue - our chosen static address indeed pointed to readable data on each run, but not to the exact same offset in the spray chunk each time.\r\n\r\nWe decided to solve this problem by crafting a special spray that contains decreasing pointer values.\r\n\r\nHere is an illustration of the sprayed buffer, followed by an explanation of its structure:\r\n\r\n\r\nSTATIC_ADDRESS is the arbitrarily chosen static pointer in mOrgue.\r\nGADGET_BUFFER_OFFSET is the offset of GADGET_BUFFER from the beginning of the spray.\r\nIn each run of system server process, the static address we chose points to our controlled data, but with different offsets.\r\n\r\nr0 (which always hold the same chosen STATIC_ADDRESS) can fall to any offset in the \"Relative Address Chunk\", therefore point to any of the STATIC_ADDRESS + GADGET_BUFFER_OFFSET - 4N addresses, on each time.\r\n\r\nNote the following equation:\r\nGADGET_BUFFER = Beginning_of_spray + GADGET_BUFFER_OFFSET\r\nIn the case that r0 (=STATIC_ADDRESS) points to the beginning of the spray : STATIC_ADDRESS = Beginning_of_spray.\r\nHence: GADGET_BUFFER = STATIC_ADDRESS + GADGET_BUFFER_OFFSET\r\nOn any other case \u2013 r0(=STATIC_ADDRESS) points to an offset inside the spray (the offset is dword aligned):\r\nSTATIC_ADDRESS = Beginning_of_spray + 4N\r\nBeginning_of_spray = STATIC_ADDRESS \u2013 4N.\r\nHence: GADGET_BUFFER = STATIC_ADDRESS + GADGET_BUFFER_OFFSET \u2013 4N\r\n\r\nThe higher offset in the chunk that r0(=STATIC_ADDRESS) points to, the more we have to subtract to make the expression:\r\nSTATIC_ADDRESS + GADGET_BUFFER_OFFSET - 4N points to GADGET_BUFFER.\r\nNo matter to which offset in the chunk r0 points to, dereference it would give us the current address of GADGET_BUFFER.\u00a0\u00a0 \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \r\n\r\nBut where do we get if we dereference the other addresses in the chunk?\r\n\r\nAs farther as we go above r0, the farther the dereference would bring us below GADGET_BUFFER.\r\n\r\n\r\n\r\nNow that we have a valid working spray, let\u2019s go back to analyzing the assembly.\r\nldr \t  r4, [r0, #4]\r\nmov     r0, r4\r\nblx     &lt;android_atomic_dec ()&gt;\r\ncmp     r0, #1\r\n\r\nSo to overcome the second constraint \u2013 in which refs-&gt;mStrong must contain 1\r\nldr r4, [r0, #4] \u00a0--&gt; \u00a0 r4=[STATIC_ADDRESS + 4]\u00a0\u00a0\u00a0--&gt;\u00a0 r4 = GADGET_BUFFER-4\r\n[r4] should contain 1, hence [GADGET_BUFFER - 4] should contains 1.\r\n\r\nNow, after atomic_dec return value is indeed 1, we should overcome the other dereferences to get to the blx opcode.\r\ncmp     r0, #1\r\nbne.n   d1ea\r\n\r\nr4=GADGET_BUFFER - 4\r\nldr     r0, [r4, #8] \r\nr0 = [GADGET_BUFFER - 4 + 8] &lt;-&gt; r0 = [GADGET_BUFFER + 4]\r\nmov     r1, r6\r\nldr     r3, [r0, #0] \r\nr3 = [[GADGET_BUFFER + 4] + 0] &lt;-&gt; r3 = [[GADGET_BUFFER + 4]]\r\n\r\nNote\u00a0in order to succeed with this dereference, [GADGET_BUFFER + 4] should contain a KNOWN valid address.\r\n\r\nWe arbitrarily chose the known address - STATIC_ADDRESS.\r\n\r\n\r\nldr     r2, [r3, #12]\r\nr2 = [GADGET_BUFFER + 12]\r\nblx     r2\r\n\r\nSo now we can build the GADGET_BUFFER as following:\r\n\r\n\r\nROP CHAIN\r\nWe chose to run the \"system\" function with a predefined command line.\r\n\r\nIn order to control the r0 register, and make it point to the command line string, we should use some gadgets that would manipulate the registers.\r\n\r\nWe got only one function call, so to take control on the execution flow with our gadgets, we should use a stack pivot gadget.\r\n\r\nTherefore, the first function pointer is the preparations for the stack pivot gadget:\r\n\r\n\r\n\r\nWhere r5 equals to the original r0 (STATIC_ADDRESS) as one can see at the beginning of decStrong.\r\nmov     r0,r5  -  Restoring r0 to its original value.\r\n\r\nldr     r7, [r5]\r\n\r\nr7 = [r5]    r7=[STATIC_ADDRESS]    r7 = GADGET_BUFFER\r\nldr     r2, [r7,#0x54]\r\nr2 = [r7 + 0x54]    r2 = [GADGET_BUFFER + 84]\r\nblx     r2\r\n\r\nCall to the next gadget - which should be 21(=0x54 \/ 4) dwords from the beginning of GADGET_BUFFER\r\n\r\n\r\n\r\nThis gadget does the Stack Pivoting.\r\n\r\nSP register points to r7 \u2013 therefore the stack is under our control and points to GADGET_BUFFER.\r\n\r\nRet to the next gadget that should be kept 8 dwords from the beginning of GADGET_BUFFER\r\n\r\n(Note the pop\u00a0\u00a0\u00a0\u00a0 {r4-r11,pc} instruction, which pops 8 registers off the stack before popping pc).\r\n\r\n\r\nr0 = [r0 + 0x38]    r0 = GADGET_BUFFER - 0x38 (As explained before about the spray)\r\nNow r0 points to 56 (0x38) bytes before GADGET_BUFFER, so we have 52 command line chars, excluding the \"1\" for atomic_dec.\r\n\r\nRet to the next gadget that should be kept 10 dwords from the beginning of GADGET_BUFFER (2 dwords after the current gadget \u2013 pop\u00a0\u00a0\u00a0\u00a0 {r3,pc})\r\n\r\n\r\n\r\nThat is the last gadget where we call system!\r\n\r\nHere is an updated layout of the memory for this to happen:\r\n\r\n\r\nAndroid and ARM\r\nThere are two important issues we should keep in mind when choosing the gadgets addresses.\r\n\r\n\tThere is an ASLR mechanism on Android, and the addresses wouldn't be the same on each and every time. In order to know the correct address, we use the fact that both system server process, and our app are forked from the same process - ZYGOTE, meaning we share the same modules. So we get the address of the necessary modules in system server process, by parsing the maps file of our process. 'maps' is a file in \/proc\/&lt;pid&gt;\/maps which contains the memory layout and the loaded modules addresses.\r\n\tOn ARM CPU, there are two modes of opcode parsing: ARM (4 bytes per opcode) and THUMB (variable bytes per opcode \u2013 2 or 4). Meaning that the same address pointed by PC, could be parsed differently by the cpu when running in different modes. Parts of the gadgets we use are in the THUMB mode. In order to make the processor change its mode when parsing those gadgets, we change the pointer address from the actual address, to (address &amp; 1) - turning on the LSB, which make the cpu jmp to the correct address with THUMB mode.\r\n\r\nPAYLOAD\r\nAs described before, we use the \"system\" function to run our command line. The length of the command line is limited, and actually a command line can't be used for every purpose. So we decided to use a pre compiled elf, that being written to the file system, as an asset of our app. This elf can do anything with uid 1000 (the uid of system server). The command line we send as an argument to system is simply \u2013\r\n\"sh -c \" + file_path\r\n\r\nCONCLUSION\r\nAndroid has some common security mechanisms such as ASLR and DEP which should make an exploitation of vulnerability harder to achieve.\r\n\r\nMoreover, every application runs in its own process, so the IPC communication could be validated, and making guesses on memory layout shouldn't be intuitive. On the other hand, the fact that every process is forked from the same process makes ASLR irrelevant for vulnerabilities within zygote's sons and the binder connection from every process to system server could lead to heap spray as seen on this post. Those issues appear to be inherent in the Android OS design.\r\n\r\nPalo Alto Networks has been researching an Android security solution that based on our lab testing would have blocked this exploit (as well as other exploits) with multiple exploit mitigation modules. We hope to share more details in the coming months.","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"","width":"","height":""},"author":[{"@type":"Person","name":"Yaron Lavi"},{"@type":"Person","name":"Nadav Markus"}]}</script>		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/blog.paloaltonetworks.com\/wp-includes\/js\/wp-emoji-release.min.js"}};
			/*! This file is auto-generated */
			!function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='crayon-css'  href='https://blog.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://blog.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://blog.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://blog.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='contact-form-7-css'  href='https://blog.paloaltonetworks.com/wp-content/plugins/contact-form-7/includes/css/styles.css' type='text/css' media='all' />
<style id='contact-form-7-inline-css' type='text/css'>
.wpcf7 .wpcf7-recaptcha iframe {margin-bottom: 0;}.wpcf7 .wpcf7-recaptcha[data-align="center"] > div {margin: 0 auto;}.wpcf7 .wpcf7-recaptcha[data-align="right"] > div {margin: 0 0 0 auto;}
</style>
<link rel='stylesheet' id='dashicons-css'  href='https://blog.paloaltonetworks.com/wp-includes/css/dashicons.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://blog.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//blog.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//blog.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-menu-item-0-css'  href='//blog.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/menu-item/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='sage/css-css'  href='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/styles/main.css' type='text/css' media='all' />
<script>if (document.location.protocol != "https:") {document.location = document.URL.replace(/^http:/i, "https:");}</script><script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/jquery-3.5.1.min.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/jquery-migrate-1.4.1.min.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/blog.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js'></script>
<link rel='https://api.w.org/' href='https://blog.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blog.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://blog.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://blog.paloaltonetworks.com/?p=7779' />
<link rel="alternate" type="application/json+oembed" href="https://blog.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.paloaltonetworks.com%2F2015%2F01%2Fcve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://blog.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.paloaltonetworks.com%2F2015%2F01%2Fcve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:180,186,114,3,12,9,81,84,87,129,138,6,162;" />
  <script>var $ = jQuery;</script>
    <!-- Unit42 Scripts -->
  <script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  <!-- End Unit42 Scripts -->
<meta name="google-site-verification" content="G1onsZ_PNprWXTYsKyATpZKzp8IAJ1jlbavSwUDN5Uo" />
</head>
  <body data-rsssl=1 data-results-per-page="9" class="post-template-default single single-post postid-7779 single-format-standard cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation sidebar-primary">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <input type="hidden" id="searching" value=""/><header class="container-fluid container-blog sticky-top">
     
      <div class="pan-page-alert pan-page-alert-light">
    		<div class="pan-page-alert-text"><a href="https://www.paloaltonetworks.com/our-response-to-covid-19" data-page-track-value=":en_us: title :covid19" data-page-track="true">See our response to COVID-19</a></div>
    		<button type="button" class="pan-page-alert-close" aria-label="page alert close">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 1L6 6M6 6L11 1M6 6L1 11M6 6L11 11" stroke="#727272" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
		  </div>
    
	
      <div class="container-xl">
        <div class="row">
          <div class="col-logo">
            <a href="https://www.paloaltonetworks.com" class="nav-logo" nav-track="true" nav-track-breadcrumb="nav:logo" aria-label="paloaltonetworks">
              <svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M59.4806 4.69592C57.6725 4.69592 55.7941 5.18876 53.4694 6.43377L54.7609 9.62741C56.7798 8.50019 58.4474 8.00735 59.6687 8.00735C61.0542 8.00735 61.6648 8.52395 61.6648 9.20483V9.25133C61.6648 9.72143 61.2887 9.97974 60.3733 10.0738L58.777 10.238C54.7847 10.6606 53.1409 12.3985 53.1409 14.7934V14.9577C53.1409 17.2359 55.0192 19.0203 57.6725 19.0203C59.4197 19.0203 60.9374 18.2826 61.8601 16.9807L62.1577 18.7857H65.7739V10.5904C65.7739 6.71584 63.5432 4.69592 59.4806 4.69592ZM59.1283 15.8969C57.7903 15.8969 57.1559 15.3803 57.1559 14.5816V14.5351C57.1559 13.8305 57.5547 13.3139 59.0105 13.1031L59.6449 13.0091C60.5717 12.8799 61.141 12.7095 61.6648 12.3923V13.4317C61.6648 15.0052 60.6781 15.8969 59.1283 15.8969Z" fill="black" class="logo-text"></path>
                <path d="M25.4785 4.78994L20.8529 0.164276L16.2272 4.78994L18.5281 7.09192L6.92834 18.6917L11.554 23.3174L16.1797 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="#FA582D" class="logo-icon"></path>
                <path d="M11.6001 0.164063L0 11.7642L4.62603 16.3902L16.2262 4.79009L11.6001 0.164063Z" fill="#FA582D" class="logo-icon"></path>
                <path d="M27.7795 7.09215L16.1793 18.6923L20.8054 23.3183L32.4055 11.7182L27.7795 7.09215Z" fill="#FA582D" class="logo-icon"></path>
                <path d="M72.2314 0H68.1223V18.7857H72.2314V0Z" fill="black" class="logo-text"></path>
                <path d="M46.2362 4.69592C44.3681 4.69592 42.8679 5.52249 42.0424 6.81709L41.7283 4.93046H38.1121V23.4806H42.2211V17.051C43.0033 18.2567 44.4828 19.0193 46.2362 19.0193C49.5238 19.0193 52.2009 16.1077 52.2009 12.0916V11.6215C52.2009 7.60853 49.5238 4.69592 46.2362 4.69592ZM47.974 11.9759C47.974 14.0888 46.8705 15.6159 45.0387 15.6159C43.2068 15.6159 42.1033 14.0898 42.1033 11.9759V11.7414C42.1033 9.62741 43.2068 8.10137 45.0387 8.10137C46.8705 8.10137 47.974 9.62741 47.974 11.7414V11.9759Z" fill="black" class="logo-text"></path>
                <path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="black" class="logo-text"></path>
                <path d="M138.709 5.54211V5.47185C138.709 5.07304 138.404 4.79097 137.864 4.79097H136.924V6.9514H137.371V6.22299H137.867L138.24 6.9514H138.733L138.274 6.09694C138.553 6.01119 138.709 5.80248 138.709 5.54211ZM137.37 5.18979H137.863C138.145 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.144 5.82418 137.863 5.82418H137.37V5.18979Z" fill="black" class="logo-text"></path>
                <path d="M137.77 3.63997C136.502 3.63997 135.539 4.60292 135.539 5.87066C135.539 7.1384 136.502 8.10135 137.77 8.10135C139.037 8.10135 140 7.1384 140 5.87066C140 4.60292 139.037 3.63997 137.77 3.63997ZM137.77 7.79552C136.666 7.79552 135.868 6.99685 135.868 5.86963C135.868 4.7424 136.666 3.94373 137.77 3.94373C138.873 3.94373 139.672 4.7424 139.672 5.86963C139.672 6.99685 138.873 7.79552 137.77 7.79552Z" fill="black" class="logo-text"></path>
                <path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="black" class="logo-text"></path>
                <path d="M116.518 15.6159C115.321 15.6159 114.875 15.029 114.875 13.7613V8.10136H119.712V4.93148H114.875V1.76057L110.766 2.3712V14.159C110.766 17.3764 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="black" class="logo-text"></path>
                <path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="black" class="logo-text"></path>
                <path d="M81.2247 4.69592C77.0216 4.69592 74.0625 7.6075 74.0625 11.6236V12.0937C74.0625 16.1087 77.0216 19.0213 81.2247 19.0213C85.4278 19.0213 88.3869 16.1097 88.3869 12.0937V11.6236C88.3858 7.60853 85.4278 4.69592 81.2247 4.69592ZM84.159 11.9759C84.159 14.0888 83.0555 15.6159 81.2236 15.6159C79.3918 15.6159 78.2883 14.0898 78.2883 11.9759V11.7414C78.2883 9.62741 79.3918 8.10137 81.2236 8.10137C83.0555 8.10137 84.159 9.62741 84.159 11.7414V11.9759Z" fill="black" class="logo-text"></path>
                <path d="M98.0448 22.1168H99.0976L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0253 23.5312H99.0109V25.4964H98.0448V22.1168Z" fill="black" class="logo-text"></path>
                <path d="M102.816 22.1168H105.771L105.81 22.9372H103.826V23.4011H105.385V24.1491H103.826V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="black" class="logo-text"></path>
                <path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="black" class="logo-text"></path>
                <path d="M110.943 22.1168H112.024L112.574 24.4632H112.628L113.342 22.1168H114.333L115.032 24.4632H115.086L115.626 22.1168H116.66L115.771 25.4964H114.443L113.826 23.4589H113.797L113.168 25.4964H111.836L110.943 22.1168Z" fill="black" class="logo-text"></path>
                <path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.258 23.8071C120.258 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.915 24.7391 120.258 24.3909 120.258 23.8071Z" fill="black" class="logo-text"></path>
                <path d="M122.364 22.1168H124.334C125.232 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.45 24.2369 125.015 24.4105L125.816 25.4974H124.668L124.045 24.6089H123.378V25.4974H122.364V22.1168ZM124.203 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.203 22.933H123.377V23.8164H124.203Z" fill="black" class="logo-text"></path>
                <path d="M126.989 22.1168H128.003V23.3628H128.418L129.408 22.1168H130.548L130.553 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.003V25.4964H126.989V22.1168Z" fill="black" class="logo-text"></path>
                <path d="M131.402 25.2743V24.3475H131.407C131.972 24.6326 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3464 133.425 24.3031 132.701 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.913 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.387 22.84 132.952 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5405 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.953 25.5884C132.364 25.5884 131.895 25.4675 131.402 25.2743Z" fill="black" class="logo-text"></path>
              </svg>
            </a>
            <a href="https://blog.paloaltonetworks.com" class="nav-lockup active" >Blog</a>
          </div>
          <div class="col col-mobile">
            <button class="nav-toggle closed" id="nav-mobile-toggle">
              <svg class="menu-dashes open" width="21" height="16" viewBox="0 0 21 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="18.8125" y1="1.5" x2="1.5" y2="1.5" stroke="black" stroke-width="3" stroke-linecap="round"></line>
                <line x1="18.8125" y1="8" x2="1.5" y2="8" stroke="black" stroke-width="3" stroke-linecap="round"></line>
                <line x1="18.8125" y1="14.5" x2="1.5" y2="14.5" stroke="black" stroke-width="3" stroke-linecap="round"></line>
              </svg>
              <svg class="menu-x close" width="18" height="17" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="2.95117" y1="14.2207" x2="14.8534" y2="2.31847" stroke="black" stroke-width="3" stroke-linecap="round"></line>
                <line x1="1.5" y1="-1.5" x2="18.3323" y2="-1.5" transform="matrix(-0.707107 -0.707107 -0.707107 0.707107 14.998 16.3422)" stroke="black" stroke-width="3" stroke-linecap="round"></line>
              </svg>
                <span class="mobile-menu">Menu</span>
            </button>
          </div>
            <nav class="col col-navbar navbar" id="nav-mobile">
                <ul>
                    <li class="menu-item-home"><a href="https://blog.paloaltonetworks.com">Palo Alto Networks</a></li>
                                            
                    <li class="menu-item-object-net_sec_post">
                        <a href="https://blog.paloaltonetworks.com/network-security/">Network Security</a>
                    </li>
                    
                                            
                    <li class="menu-item-object-sase_post">
                        <a href="https://blog.paloaltonetworks.com/sase/">SASE</a>
                    </li>
                    
                                            
                    <li class="menu-item-object-cloud_sec_post">
                        <a href="https://blog.paloaltonetworks.com/prisma-cloud/">Cloud Native Security</a>
                    </li>
                    
                                            
                    <li class="menu-item-object-sec_ops_post">
                        <a href="https://blog.paloaltonetworks.com/security-operations/">Security Operations</a>
                    </li>
                    
                                        <li>
                <div class="search"  id="form-search">
                    <input type="text" name="search" autocomplete="off" id="postSearch1" placeholder="Search the Blog" />
                  
                    <button id="nav-search-open-toggle">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" >
                      <path d="M8.66675 15.3335C12.3487 15.3335 15.3335 12.3487 15.3335 8.66675C15.3335 4.9848 12.3487 2 8.66675 2C4.9848 2 2 4.9848 2 8.66675C2 12.3487 4.9848 15.3335 8.66675 15.3335Z" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                      <path d="M18.0007 18.0001L13.3784 13.3778" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                  </button>
                  
                  <button id="nav-search-close-toggle">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" >
                      <line x1="2.95117" y1="14.2207" x2="14.8534" y2="2.31847" stroke="black" stroke-width="3" stroke-linecap="round"></line>
                      <line x1="1.5" y1="-1.5" x2="18.3323" y2="-1.5" transform="matrix(-0.707107 -0.707107 -0.707107 0.707107 14.998 16.3422)" stroke="black" stroke-width="3" stroke-linecap="round"></line>
                    </svg>
                  </button>
                  
                </div>
              </li>
                </ul>
                        </nav>
          
            
        </div>
      </div>
    </header>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>-->
<script type="text/javascript">
    var main_nav_active_class = '';
    var main_nav_menu_item_name = 'menu-item-home';
    var str_subscription = '<div class="container-fluid container-newsletter-signup" >\
    <div class="container-lg">\
        <div class="row no-gutters row-newsletter-signup">\
            <div class="col-12 col-md-5 col-newsletter-signup-header">\
                <h2>Get updates!</h2>\
                <p class="lead">Sign up to receive the latest news</p>\
            </div>\
            <div class="col-12 col-md-7 col-newsletter-signup-form">\
                <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate="" class="subscribe-form clearfix" name="Unit42_Subscribe" id="subscribe_form1">\
                    <input type="hidden" value="subscribe-unit42" name="FormName">\
    <input id="field14" type="hidden" name="Qualifying_Campaign__c" value="70170000000lBnb">\
                         <input type="hidden" value="1086" name="formid">\
                         <input type="hidden" value="531-OCS-018" name="munchkinId">\
                         <input type="hidden" value="19887" name="lpId">\
                         <input type="hidden" value="1086" name="formVid">\
                         <input type="hidden" name="mkto_opt-in" value="true">\
                <div class="row no-gutters row-newsletter-signup-input">\
                    <div class="col-10 col-sm-11 col-newsletter-signup-input">\
                        <input type="email" name="Email" placeholder="Enter your email" id="input-newsletter-signup" class="subscribe-field rounded business_email" autocomplete="off">\
                    </div>\
                    <div class="col-2 col-sm-1 col-newsletter-signup-button">\
                        <button type="submit" value="Subscribe" disabled="disabled">\
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="12" viewBox="0 0 16 12" fill="none">\
                            <path d="M1 6L14.3333 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\
                            <path d="M9.33301 1L14.333 6L9.33301 11" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\
                            </svg>\
                        </button>\
                    </div>\
                </div>\
                <div class="email_invalid_msg">Please enter a valid email.</div>\
                <div class="row row-legal-disclaimer">\
                    <div class="col-12 col-legal-disclaimer">\
                        <p class="legal-disclaimer">By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>\
                    </div>\
                </div>\
                <div class="row row-recatcha d-none" id="row-recatcha">\
                    <div class="col-12 col-recatcha text-sm-center">\
                        <div id="captcha_container" class="google-recapth"></div>\
                    </div>\
                </div>\
                </form>\
            </div>\
        </div>\
    </div>\
</div>';
</script>
<article class="container-feed-master " id="main-container">
   <!--<div class="container-fluid container-breadcrumb"  data-aos="fade-in">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="https://blog.paloaltonetworks.com">Palo Alto Networks</a></li>
			          </ol>
        </nav>
    </div>-->
    
    <div class="container-fluid container-feed-article">
      <div class="container-lg">
        <div class="row row-feed-filters article-container container-inner" data-aos="fade-in" >
            <h1 class="blog-title">CVE-2014-7911 – A Deep Dive Analysis of Android System Service Vulnerability and Exploitation</h1>
              <div class="col-xs-12 col-sm-6 col-md-8 col-lg-8 col-xl-9 pad-0">
                   <div class="tags-item">
                    <a href="https://blog.paloaltonetworks.com/category/malware-2/">Malware</a> <a href="https://blog.paloaltonetworks.com/category/mobility/">Mobility</a> <a href="https://blog.paloaltonetworks.com/category/threat-prevention-2/">Threat Prevention</a>                    
                    <a href="https://blog.paloaltonetworks.com/tag/android/" rel="tag">Android</a><a href="https://blog.paloaltonetworks.com/tag/cve-2014-7911/" rel="tag">CVE-2014-7911</a><a href="https://blog.paloaltonetworks.com/tag/vulnerability/" rel="tag">vulnerability</a>                  </div>
              </div>
              <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4 col-xl-3 pad-0 mobile-links">
                   <ol class="react-items">
                    <li>
				
				
				13,562
			 people reacted</li>
                    <li class="line"></li>
                    <li>
                      <div class="metadata-likes ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'7779','like')">
                          <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4.74998 15.9999H2.49999C2.10217 15.9999 1.72064 15.8419 1.43934 15.5606C1.15803 15.2793 1 14.8977 1 14.4999V9.24995C1 8.85213 1.15803 8.4706 1.43934 8.18929C1.72064 7.90799 2.10217 7.74996 2.49999 7.74996H4.74998M9.99994 6.24997V3.24999C9.99994 2.65325 9.76289 2.08096 9.34094 1.65901C8.91898 1.23705 8.34669 1 7.74996 1L4.74998 7.74996V15.9999H13.2099C13.5717 16.004 13.9227 15.8772 14.1983 15.6429C14.474 15.4086 14.6557 15.0826 14.7099 14.7249L15.7449 7.97496C15.7775 7.75997 15.763 7.54047 15.7024 7.33165C15.6418 7.12283 15.5365 6.92968 15.3938 6.7656C15.2511 6.60151 15.0745 6.47041 14.8761 6.38138C14.6777 6.29234 14.4623 6.2475 14.2449 6.24997H9.99994Z" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                          </svg>
                          <span>1</span>
                      </div>
                    </li>
                  </ol>
              </div>
              <div class="container-lg author-desc-row">
                <div class="col-8 author-desc">
                  <div class="metadata-thumbnail" >
                                          <div class="metadata-thumbnail-author" style="background-image: url('https://blog.paloaltonetworks.com/wp-content/uploads/2020/03/panw_master-twitter-profile-pic-400x400-1.png')">
                                          </div>      
                  </div>
                  <div class="metadata-author" >
                    <span class="author-name">By <a href="https://blog.paloaltonetworks.com/author/yaron-lavi/" title="Posts by Yaron Lavi" class="author url fn" rel="author">Yaron Lavi</a> and <a href="https://blog.paloaltonetworks.com/author/nadav-markus/" title="Posts by Nadav Markus" class="author url fn" rel="author">Nadav Markus</a></span><br /> 
                      <time datetime="2015-01-06T14:00:34+00:00">January 6, 2015 at 6:00 AM</time><br />
                      13 min. read
                  </div>
                </div>
                <!--<div class="col-6 social-items">
                      <span class="links">
                        <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.28843 12.8112C4.28843 13.9855 3.32843 14.9375 2.1442 14.9375C0.959967 14.9375 0 13.9855 0 12.8112C0 11.6368 0.96 10.6848 2.14423 10.6848C3.32846 10.6848 4.28843 11.6368 4.28843 12.8112ZM10.1699 14.38C9.89019 9.2468 5.74406 5.13004 0.562199 4.85236C0.256339 4.83596 0 5.07967 0 5.38341V6.97945C0 7.25886 0.217299 7.49317 0.498449 7.5113C4.24282 7.75315 7.2442 10.7221 7.48858 14.4432C7.5069 14.722 7.74318 14.9375 8.0249 14.9375H9.63435C9.94068 14.9375 10.1864 14.6833 10.1699 14.38ZM14.9997 14.3896C14.7186 6.62601 8.41959 0.342913 0.552556 0.062845C0.250212 0.0520872 0 0.294304 0 0.594294V2.1903C0 2.47668 0.22885 2.70976 0.5174 2.72152C6.91848 2.9818 12.0562 8.07771 12.3187 14.4245C12.3305 14.7106 12.5655 14.9375 12.8544 14.9375H14.4638C14.7663 14.9375 15.0105 14.6894 14.9997 14.3896Z" fill="black"/>
                        </svg>
                      </span>
                      <span class="links">
                        <svg width="15" height="18" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.7857 11.25C10.9286 11.25 10.1484 11.6016 9.57254 12.1781L6.28125 10.016C6.47879 9.35508 6.47879 8.64141 6.28125 7.98398L9.57254 5.82188C10.1484 6.39844 10.9286 6.75 11.7857 6.75C13.5603 6.75 15 5.23828 15 3.375C15 1.51172 13.5603 0 11.7857 0C10.0112 0 8.57143 1.51172 8.57143 3.375C8.57143 3.71953 8.62165 4.06406 8.71875 4.39102L5.42746 6.55312C4.85156 5.97656 4.07143 5.625 3.21429 5.625C1.43973 5.625 0 7.13672 0 9C0 10.8633 1.43973 12.375 3.21429 12.375C4.07143 12.375 4.85156 12.0234 5.42746 11.4469L8.71875 13.609C8.62165 13.9395 8.57143 14.2805 8.57143 14.625C8.57143 16.4883 10.0112 18 11.7857 18C13.5603 18 15 16.4883 15 14.625C15 12.7617 13.5603 11.25 11.7857 11.25ZM11.7857 1.6875C12.673 1.6875 13.3929 2.44336 13.3929 3.375C13.3929 4.30664 12.673 5.0625 11.7857 5.0625C10.8984 5.0625 10.1786 4.30664 10.1786 3.375C10.1786 2.44336 10.8984 1.6875 11.7857 1.6875ZM3.21429 10.6875C2.32701 10.6875 1.60714 9.93164 1.60714 9C1.60714 8.06836 2.32701 7.3125 3.21429 7.3125C4.10156 7.3125 4.82143 8.06836 4.82143 9C4.82143 9.93164 4.10156 10.6875 3.21429 10.6875ZM11.7857 16.3125C10.8984 16.3125 10.1786 15.5566 10.1786 14.625C10.1786 13.6934 10.8984 12.9375 11.7857 12.9375C12.673 12.9375 13.3929 13.6934 13.3929 14.625C13.3929 15.5566 12.673 16.3125 11.7857 16.3125Z" fill="black"/>
                        </svg>
                      </span>
                </div>-->
                <div class="col-4 social-items">
                  <div class="links">
                      <a href="http://feeds.feedburner.com/PaloAltoNetworks" target="_blank"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4.28843 12.8112C4.28843 13.9855 3.32843 14.9375 2.1442 14.9375C0.959967 14.9375 0 13.9855 0 12.8112C0 11.6368 0.96 10.6848 2.14423 10.6848C3.32846 10.6848 4.28843 11.6368 4.28843 12.8112ZM10.1699 14.38C9.89019 9.2468 5.74406 5.13004 0.562199 4.85236C0.256339 4.83596 0 5.07967 0 5.38341V6.97945C0 7.25886 0.217299 7.49317 0.498449 7.5113C4.24282 7.75315 7.2442 10.7221 7.48858 14.4432C7.5069 14.722 7.74318 14.9375 8.0249 14.9375H9.63435C9.94068 14.9375 10.1864 14.6833 10.1699 14.38ZM14.9997 14.3896C14.7186 6.62601 8.41959 0.342913 0.552556 0.062845C0.250212 0.0520872 0 0.294304 0 0.594294V2.1903C0 2.47668 0.22885 2.70976 0.5174 2.72152C6.91848 2.9818 12.0562 8.07771 12.3187 14.4245C12.3305 14.7106 12.5655 14.9375 12.8544 14.9375H14.4638C14.7663 14.9375 15.0105 14.6894 14.9997 14.3896Z" fill="black"/>
                    </svg>
                    </a>
                  </div>
                  <div class="links">
                    <div class="dropdown dropup">
                      <a href="#!" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <svg width="15" height="18" viewBox="0 0 15 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.7857 11.25C10.9286 11.25 10.1484 11.6016 9.57254 12.1781L6.28125 10.016C6.47879 9.35508 6.47879 8.64141 6.28125 7.98398L9.57254 5.82188C10.1484 6.39844 10.9286 6.75 11.7857 6.75C13.5603 6.75 15 5.23828 15 3.375C15 1.51172 13.5603 0 11.7857 0C10.0112 0 8.57143 1.51172 8.57143 3.375C8.57143 3.71953 8.62165 4.06406 8.71875 4.39102L5.42746 6.55312C4.85156 5.97656 4.07143 5.625 3.21429 5.625C1.43973 5.625 0 7.13672 0 9C0 10.8633 1.43973 12.375 3.21429 12.375C4.07143 12.375 4.85156 12.0234 5.42746 11.4469L8.71875 13.609C8.62165 13.9395 8.57143 14.2805 8.57143 14.625C8.57143 16.4883 10.0112 18 11.7857 18C13.5603 18 15 16.4883 15 14.625C15 12.7617 13.5603 11.25 11.7857 11.25ZM11.7857 1.6875C12.673 1.6875 13.3929 2.44336 13.3929 3.375C13.3929 4.30664 12.673 5.0625 11.7857 5.0625C10.8984 5.0625 10.1786 4.30664 10.1786 3.375C10.1786 2.44336 10.8984 1.6875 11.7857 1.6875ZM3.21429 10.6875C2.32701 10.6875 1.60714 9.93164 1.60714 9C1.60714 8.06836 2.32701 7.3125 3.21429 7.3125C4.10156 7.3125 4.82143 8.06836 4.82143 9C4.82143 9.93164 4.10156 10.6875 3.21429 10.6875ZM11.7857 16.3125C10.8984 16.3125 10.1786 15.5566 10.1786 14.625C10.1786 13.6934 10.8984 12.9375 11.7857 12.9375C12.673 12.9375 13.3929 13.6934 13.3929 14.625C13.3929 15.5566 12.673 16.3125 11.7857 16.3125Z" fill="black"/>
                        </svg>
                      </a>

                      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                        <div class="share-dropdown">
                          <p><strong>SHARE</strong></p>
                          <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.paloaltonetworks.com%2F2015%2F01%2Fcve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation%2F" target="_blank">
                          <i class="fa fb-icon fa-facebook-official pop-up-icon" aria-hidden="true"></i></a>
                          
                          <a href="https://twitter.com/home?status=https%3A%2F%2Fblog.paloaltonetworks.com%2F2015%2F01%2Fcve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation%2F+-+CVE-2014-7911+%E2%80%93+A+Deep+Dive+Analysis+of+Android+System+Service+Vulnerability+and+Exploitation" target="_blank"><i class="fa tw-icon fa-twitter pop-up-icon" aria-hidden="true"></i></a>
                          <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fblog.paloaltonetworks.com%2F2015%2F01%2Fcve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation%2F&title=CVE-2014-7911+%E2%80%93+A+Deep+Dive+Analysis+of+Android+System+Service+Vulnerability+and+Exploitation&summary=&source=" target="_blank"><i class="fa lindn-icon fa-linkedin pop-up-icon" aria-hidden="true"></i></a>
                          <a href="//www.reddit.com/submit?url=https://blog.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/" target="_blank"><i class="fa blog-icon fa-stumbleupon-circle pop-up-icon" aria-hidden="true"></i></a>
                          
                          </div>                       
                        </div>
                      </div>
                    </div>
                </div>
              </div>
              <div class="entry-content article-description"><p>In this post we discuss CVE-2014-7911 and the various techniques that can be used to achieve privilege escalation. We also examine how some of these techniques can be blocked using several security mechanisms.</p>
<h3>The Vulnerability</h3>
<p>CVE-2014-7911 was presented <a href="http://seclists.org/fulldisclosure/2014/Nov/51" target="_blank">here</a> along with a very descriptive POC that was written by Jann Horn. Described briefly, the ObjectInputStream doesn&#8217;t validate that the serialized object&#8217;s class type, as described in the serialized object, is actually serializable. It creates an instance of the wanted class anyway with the deserialized values of the object. Therefore, one can create object of any class, and control its private variables, by serializing objects from another class, that would be deserialized as data members of the wanted class.</p>
<p><span style="text-decoration: underline;">Let&#8217;s look at the example below:</span><span id="more-7779"></span></p>
<p>The following snippet (copied from the original POC) shows a spoofed BinderProxy instance:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7005268061262" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
package AAdroid.os;

import java.io.Serializable;

public class BinderProxy implements Serializable {
        private static final long serialVersionUID = 0;
        public long mObject = 0x1337beef;
        public long mOrgue = 0x1337beef;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7005268061262-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7005268061262-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7005268061262-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7005268061262-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca7005268061262-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7005268061262-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca7005268061262-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7005268061262-8">8</div><div class="crayon-num" data-line="crayon-5f694bcca7005268061262-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7005268061262-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">AAdroid</span><span class="crayon-sy">.</span><span class="crayon-v">os</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7005268061262-2">&nbsp;</div><div class="crayon-line" id="crayon-5f694bcca7005268061262-3"><span class="crayon-e">import </span><span class="crayon-v">java</span><span class="crayon-sy">.</span><span class="crayon-v">io</span><span class="crayon-sy">.</span><span class="crayon-v">Serializable</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7005268061262-4">&nbsp;</div><div class="crayon-line" id="crayon-5f694bcca7005268061262-5"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">BinderProxy</span><span class="crayon-h"> </span><span class="crayon-r">implements</span><span class="crayon-h"> </span><span class="crayon-e">Serializable</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7005268061262-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-m">final</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">serialVersionUID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca7005268061262-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">mObject</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x1337beef</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7005268061262-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">mOrgue</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x1337beef</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca7005268061262-9"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>In the POC code that was provided above, an attacker serializes a class named AAdroid.os.BinderProxy and changes its name to android.os.BinderProxy after marshalling it, and before sending it to the system server.</p>
<p>android.os.BinderProxy class isn&#8217;t serializable, and it involves native code that handles mObject and mOrgue <strong>as pointers. </strong></p>
<p>If it was serializable, then the pointers valued wouldn&#8217;t be deserialized, but their dereferenced values would.</p>
<p>The deserialization code in ObjectInputStream deserializes the sent object as an android.os.BinderProxy instance, leading to type confusion.</p>
<p>As mentioned earlier, this type confusion results in the native code reading pointer values from the attacker&#8217;s spoofed android.os.BinderProxy, supposedly private fields, which the attacker modified.</p>
<p>Specifically, the field of interest is mOrgue.</p>
<p>The android.os.BinderProxy contains a finalize method that will result in native code invocation. This native code uses mOrgue as a pointer.</p>
<p><span style="text-decoration: underline;">This is the finalize method:</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca700b942591380" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
protected void finalize() throws Throwable {
	destroy();
	super.finalize();
	return;
	Exception exception;
	exception;
	super.finalize();
	throw exception;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca700b942591380-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700b942591380-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca700b942591380-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700b942591380-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca700b942591380-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700b942591380-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca700b942591380-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700b942591380-8">8</div><div class="crayon-num" data-line="crayon-5f694bcca700b942591380-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca700b942591380-1"><span class="crayon-m">protected</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">finalize</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">throws</span><span class="crayon-h"> </span><span class="crayon-e">Throwable</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700b942591380-2"><span class="crayon-h">	</span><span class="crayon-e">destroy</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700b942591380-3"><span class="crayon-h">	</span><span class="crayon-r">super</span><span class="crayon-sy">.</span><span class="crayon-e">finalize</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700b942591380-4"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700b942591380-5"><span class="crayon-h">	</span><span class="crayon-e">Exception </span><span class="crayon-v">exception</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700b942591380-6"><span class="crayon-h">	</span><span class="crayon-v">exception</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700b942591380-7"><span class="crayon-h">	</span><span class="crayon-r">super</span><span class="crayon-sy">.</span><span class="crayon-e">finalize</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700b942591380-8"><span class="crayon-h">	</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-v">exception</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700b942591380-9"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p><span style="text-decoration: underline;">And this is the declaration of destroy:</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca700e938543904" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
private final native void destroy();</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca700e938543904-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca700e938543904-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">final</span><span class="crayon-h"> </span><span class="crayon-m">native</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">destroy</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><span style="text-decoration: underline;">The native destroy function:</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca700f610310062" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
static void android_os_BinderProxy_destroy(JNIEnv* env, jobject obj)
{
    IBinder* b = (IBinder*)
            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);
    DeathRecipientList* drl = (DeathRecipientList*)
            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);
    LOGDEATH("Destroying BinderProxy %p: binder=%p drl=%p\n", obj, b, drl);
    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, 0);
    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, 0);
    drl-&gt;decStrong((void*)javaObjectForIBinder);
    b-&gt;decStrong((void*)javaObjectForIBinder);
    IPCThreadState::self()-&gt;flushCommands();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-8">8</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-10">10</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca700f610310062-12">12</div><div class="crayon-num" data-line="crayon-5f694bcca700f610310062-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca700f610310062-1"><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">android_os_BinderProxy_destroy</span><span class="crayon-sy">(</span><span class="crayon-e ">JNIEnv*</span><span class="crayon-h"> </span><span class="crayon-v">env</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">jobject </span><span class="crayon-v">obj</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">IBinder*</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">IBinder*</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">env</span><span class="crayon-o">-&gt;</span><span class="crayon-e">GetIntField</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gBinderProxyOffsets</span><span class="crayon-sy">.</span><span class="crayon-v">mObject</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">DeathRecipientList*</span><span class="crayon-h"> </span><span class="crayon-v">drl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">DeathRecipientList*</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">env</span><span class="crayon-o">-&gt;</span><span class="crayon-e">GetIntField</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gBinderProxyOffsets</span><span class="crayon-sy">.</span><span class="crayon-v">mOrgue</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">LOGDEATH</span><span class="crayon-sy">(</span><span class="crayon-s">"Destroying BinderProxy %p: binder=%p drl=%p\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">drl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">env</span><span class="crayon-o">-&gt;</span><span class="crayon-e">SetIntField</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gBinderProxyOffsets</span><span class="crayon-sy">.</span><span class="crayon-v">mObject</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">env</span><span class="crayon-o">-&gt;</span><span class="crayon-e">SetIntField</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gBinderProxyOffsets</span><span class="crayon-sy">.</span><span class="crayon-v">mOrgue</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">drl</span><span class="crayon-o">-&gt;</span><span class="crayon-e">decStrong</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">javaObjectForIBinder</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">b</span><span class="crayon-o">-&gt;</span><span class="crayon-e">decStrong</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">javaObjectForIBinder</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca700f610310062-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">IPCThreadState</span><span class="crayon-o">::</span><span class="crayon-e">self</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">-&gt;</span><span class="crayon-e">flushCommands</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca700f610310062-13"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>Eventually, the native code invokes decStrong</p>
<p style="padding-left: 30px;">(i.e., in drl-&gt;decStrong((<strong>void</strong>*)javaObjectForIBinder);)</p>
<p><strong>Note that at this point, drl is controlled by an attacker, as evident by the line</strong></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7010074727736" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
DeathRecipientList* drl = (DeathRecipientList*)
            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7010074727736-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7010074727736-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7010074727736-1"><span class="crayon-e ">DeathRecipientList*</span><span class="crayon-h"> </span><span class="crayon-v">drl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">DeathRecipientList*</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7010074727736-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">env</span><span class="crayon-o">-&gt;</span><span class="crayon-e">GetIntField</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">gBinderProxyOffsets</span><span class="crayon-sy">.</span><span class="crayon-v">mOrgue</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>So decStrong is going to be called with us controlling &#8216;this&#8217; pointer.</p>
<p>Let&#8217;s take a look on decStrong code from RefBase class <a href="https://android.googlesource.com/platform/system/core/+/master/libutils/RefBase.cpp" target="_blank">source</a>:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7012725467211" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
void RefBase::decStrong(const void* id) const
{
    weakref_impl* const refs = mRefs;
    refs-&gt;removeStrongRef(id);
    const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);
#if PRINT_REFS
    ALOGD("decStrong of %p from %p: cnt=%d\n", this, id, c);
#endif
    ALOG_ASSERT(c &gt;= 1, "decStrong() called on %p too many times", refs);
    if (c == 1) {
        refs-&gt;mBase-&gt;onLastStrongRef(id);
        if ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {
            delete this;
        }
    }
    refs-&gt;decWeak(id);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-8">8</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-10">10</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-12">12</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-14">14</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7012725467211-16">16</div><div class="crayon-num" data-line="crayon-5f694bcca7012725467211-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7012725467211-1"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">RefBase</span><span class="crayon-o">::</span><span class="crayon-e">decStrong</span><span class="crayon-sy">(</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-m">const</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">weakref_impl*</span><span class="crayon-h"> </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">refs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">mRefs</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-e">removeStrongRef</span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">int32</span><span class="crayon-sy">_</span>t<span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">android_atomic_dec</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mStrong</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-6"><span class="crayon-p">#if PRINT_REFS</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ALOGD</span><span class="crayon-sy">(</span><span class="crayon-s">"decStrong of %p from %p: cnt=%d\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">this</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-8"><span class="crayon-p">#endif</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ALOG_ASSERT</span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">&gt;=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"decStrong() called on %p too many times"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">refs</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mBase</span><span class="crayon-o">-&gt;</span><span class="crayon-e">onLastStrongRef</span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mFlags</span><span class="crayon-o">&amp;</span><span class="crayon-v">OBJECT_LIFETIME_MASK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">OBJECT_LIFETIME_STRONG</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">delete </span><span class="crayon-r">this</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7012725467211-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-e">decWeak</span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca7012725467211-17"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p><strong>Note the line refs-&gt;mBase-&gt;onLastStrongRef(id); These lines will eventually lead to arbitrary code execution.</strong></p>
<p>In the following screenshot of RefBase::decStrong assembly, the attacker controls r0(&#8216;this pointer&#8217;)</p>
<p><img class="aligncenter size-large wp-image-7780" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-500x289.png" alt="cve 1 6 15 1" width="500" height="289" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-500x289.png 500w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-230x133.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-510x295.png 510w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1-69x40.png 69w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-1.png 974w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<h3>Exploitation</h3>
<p>The first use of the controlled register r0, which contains the &#8216;this&#8217; pointer (drl) is in these lines:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7013792547476" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
weakref_impl* const refs = mRefs;
refs-&gt;removeStrongRef(id);
const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7013792547476-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7013792547476-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7013792547476-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7013792547476-1"><span class="crayon-e ">weakref_impl*</span><span class="crayon-h"> </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">refs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">mRefs</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7013792547476-2"><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-e">removeStrongRef</span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5f694bcca7013792547476-3"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">int32</span><span class="crayon-sy">_</span>t<span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">android_atomic_dec</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mStrong</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>These lines are translated to the following assembly:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7015096986884" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ldr     r4, [r0, #4]   # attacker controls r4
mov     r6, r1
mov     r0, r4
blx     &lt;android_atomic_dec ()&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7015096986884-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7015096986884-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7015096986884-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7015096986884-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7015096986884-1"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#4]&nbsp;&nbsp; # attacker controls r4</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7015096986884-2"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r6</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r1</span></div><div class="crayon-line" id="crayon-5f694bcca7015096986884-3"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r4</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7015096986884-4"><span class="crayon-v">blx</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">&lt;</span><span class="crayon-e">android_atomic_dec</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>First, r4 is loaded with the mRefs variable.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7016494835744" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ldr     r4, [r0, #4]   # attacker controls r4</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7016494835744-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7016494835744-1"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#4]&nbsp;&nbsp; # attacker controls r4</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><strong>Note that r0 is the &#8216;this&#8217; pointer of the drl, and mRefs is the first private variable following the virtual function table, hence it is 4 bytes after &#8216;this&#8217; pointer.</strong></p>
<p>Then, android_atomic_dec is being called with &amp;refs-&gt;mStrong</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7017903916171" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
	const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7017903916171-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7017903916171-1"><span class="crayon-h">	</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">int32</span><span class="crayon-sy">_</span>t<span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">android_atomic_dec</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mStrong</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>This is translated to:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7018094783303" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
mov     r0, r4
  blx     &lt;android_atomic_dec ()&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7018094783303-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7018094783303-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7018094783303-1"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r4</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7018094783303-2"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-v">blx</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">&lt;</span><span class="crayon-e">android_atomic_dec</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>r0 now contains &amp;refs-&gt;mStrong.</p>
<p><strong>Note that the mStrong variable is the first data member of refs (in the class weakref_impl), and that this class contains no virtual functions, hence it does not contain a vtable, so the mStrong variable is at offset 0 of r4.</strong></p>
<p>As one can tell &#8211;  the line refs-&gt;removeStrongRef(id); is not present in the assembly  simply because the compiler optimized and omitted it, since it has an empty implementation, as one can see from the following code:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7019864884244" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
void removeStrongRef(const void* /*id*/) { }</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7019864884244-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7019864884244-1"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">removeStrongRef</span><span class="crayon-sy">(</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-c">/*id*/</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Following the call to android_atomic_dec are these lines of code:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca701b394116031" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
if (c == 1) {
	refs-&gt;mBase-&gt;onLastStrongRef(id);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca701b394116031-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca701b394116031-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca701b394116031-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca701b394116031-2"><span class="crayon-h">	</span><span class="crayon-v">refs</span><span class="crayon-o">-&gt;</span><span class="crayon-v">mBase</span><span class="crayon-o">-&gt;</span><span class="crayon-e">onLastStrongRef</span><span class="crayon-sy">(</span><span class="crayon-v">id</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>These are translated to the following assembly lines:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca701d149966767" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
cmp     r0, #1
bne.n   d1ea
ldr     r0, [r4, #8] 
mov     r1, r6
ldr     r3, [r0, #0] 
ldr     r2, [r3, #12]
blx     r2       </textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca701d149966767-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca701d149966767-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca701d149966767-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca701d149966767-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca701d149966767-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca701d149966767-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca701d149966767-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca701d149966767-1"><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca701d149966767-2"><span class="crayon-v">bne</span><span class="crayon-sy">.</span><span class="crayon-i">n</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">d1ea</span></div><div class="crayon-line" id="crayon-5f694bcca701d149966767-3"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#8] </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca701d149966767-4"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r6</span></div><div class="crayon-line" id="crayon-5f694bcca701d149966767-5"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#0] </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca701d149966767-6"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#12]</span></div><div class="crayon-line" id="crayon-5f694bcca701d149966767-7"><span class="crayon-e">blx&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-i">r2</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p><strong>Note that android_atomic_dec returns the value of the specified memory address before the decrement took place. So in order to invoke refs-&gt;mBase-&gt;onLastStrongRef(id) (blx r2), we must get refs-&gt;mStrong to get the value of 1.</strong></p>
<p>As we can see up to now, an attacker has several constraints that he must adhere to if he wishes to gain code execution:</p>
<ol>
<li>drl (our first controlled pointer, i.e. r0 when entering decStrong) must point to a readable memory location.</li>
<li>refs-&gt;mStrong must have the value of 1</li>
<li>The dereference chain at the line refs-&gt;mBase-&gt;onLastStrongRef(id) must succeed and eventually point to an executable address.</li>
</ol>
<p>In addition, an attacker must overcome the usual obstacles of exploitation &#8211; <strong>ASLR</strong> and <strong>DEP</strong>.</p>
<p>One can employ basic techniques to fulfill these requirements and overcome the mentioned security mechanisms, including<strong> heap spraying, stack pivoting and ROP. </strong>Let’s look at these in detail<b>.</b></p>
<h3>Heap spray</h3>
<p>An attacker&#8217;s first step will be to get a reliable readable address with arbitrary data &#8211; most commonly achieved by a heap spray.</p>
<p>The system server provides several core functionalities for the android device, many of which are exposed to applications via various service interfaces.</p>
<p>A common paradigm to invoke a service in the context of the system server is like the following:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca701e273343265" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
LocationManager lm = (LocationManager)getSystemService(LOCATION_SERVICE);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca701e273343265-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca701e273343265-1"><span class="crayon-e">LocationManager </span><span class="crayon-v">lm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">LocationManager</span><span class="crayon-sy">)</span><span class="crayon-e">getSystemService</span><span class="crayon-sy">(</span><span class="crayon-v">LOCATION_SERVICE</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The acquired manager allows us to invoke functionality in the system server on behalf of us, via IPC.</p>
<p>Several services can be used by us for a heap spray, but for the purpose of this blog, we decided to use a heap spray that requires special app permissions, to prevent normal applications from utilizing this technique.</p>
<p>The location manager allows us to register test providers via the function addTestProvider &#8211; allowing us to pass an arbitrary name that contains arbitrary data. As we mentioned, one should enable developer options and enable the mock locations option in order to utilize this.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7020863892619" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
lm.addTestProvider(builder.toString(), false, false, false, false, false, false, false, 1, 1);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7020863892619-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7020863892619-1"><span class="crayon-v">lm</span><span class="crayon-sy">.</span><span class="crayon-e">addTestProvider</span><span class="crayon-sy">(</span><span class="crayon-v">builder</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p><strong>Note that this heap spray does have its limitations – the data is sprayed using the name field, which is Unicode. This imposes a limitation – we are limited to byte sequences which correspond to valid Unicode code points.</strong></p>
<h4 style="text-align: left; direction: ltr; unicode-bidi: embed;">Spray addresses manipulation</h4>
<p>After spraying the system server process memory address space, we encountered another issue &#8211; our chosen static address indeed pointed to readable data on each run, but not to the exact same offset in the spray chunk each time.</p>
<p>We decided to solve this problem by crafting a special spray that contains decreasing pointer values.</p>
<p>Here is an illustration of the sprayed buffer, followed by an explanation of its structure:</p>
<p><img class="aligncenter size-full wp-image-7783" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-2.png" alt="cve 1 6 15 2" width="490" height="582" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-2.png 490w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-2-230x273.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-2-252x300.png 252w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-2-33x40.png 33w" sizes="(max-width: 490px) 100vw, 490px" /></p>
<p style="text-align: left;"><strong>STATIC_ADDRESS</strong> is the arbitrarily chosen static pointer in mOrgue.<br />
<strong>GADGET_BUFFER_OFFSET</strong> is the offset of GADGET_BUFFER from the beginning of the spray.</p>
<p>In each run of system server process, the static address we chose points to our controlled data, but with different offsets.</p>
<p>r0 (which <strong>always </strong>hold the same chosen <strong>STATIC_ADDRESS</strong>) can fall to any offset in the &#8220;Relative Address Chunk&#8221;, therefore point to any of the <strong>STATIC_ADDRESS + GADGET_BUFFER_OFFSET &#8211; 4N</strong> addresses, on each time.</p>
<p><strong>Note the following equation:</strong></p>
<p style="padding-left: 30px;"><strong>GADGET_BUFFER = Beginning_of_spray + GADGET_BUFFER_OFFSET</strong></p>
<p>In the case that r0 <strong>(=STATIC_ADDRESS</strong>) points to the beginning of the spray : STATIC_ADDRESS = Beginning_of_spray.</p>
<p style="padding-left: 30px;">Hence: <strong>GADGET_BUFFER =</strong> <strong>STATIC_ADDRESS + GADGET_BUFFER_OFFSET</strong></p>
<p>On any other case – r0<strong>(=STATIC_ADDRESS</strong>) points to an offset inside the spray (the offset is dword aligned):</p>
<p style="padding-left: 30px;">STATIC_ADDRESS = Beginning_of_spray + 4N</p>
<p style="padding-left: 30px;">Beginning_of_spray = STATIC_ADDRESS – 4N.</p>
<p style="padding-left: 30px;">Hence: <strong>GADGET_BUFFER =</strong> <strong>STATIC_ADDRESS + GADGET_BUFFER_OFFSET – 4N<br />
</strong></p>
<p>The higher offset in the chunk that r0(=STATIC_ADDRESS) points to, the more we have to subtract to make the expression:</p>
<p style="padding-left: 30px;">STATIC_ADDRESS + GADGET_BUFFER_OFFSET &#8211; 4N points to GADGET_BUFFER.</p>
<p><strong>No matter to which offset in the chunk r0 points to, dereference it</strong> <strong>would give us the current address of GADGET_BUFFER.                          </strong></p>
<p>But where do we get if we dereference the other addresses in the chunk?</p>
<p>As farther as we go <strong>above</strong> r0, the farther the dereference would bring us<strong> below</strong> GADGET_BUFFER.</p>
<p><img class="aligncenter size-large wp-image-7784" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3-500x312.png" alt="cve 1 6 15 3" width="500" height="312" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3-500x312.png 500w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3-230x143.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3-479x300.png 479w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3-63x40.png 63w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-3.png 847w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<p>Now that we have a valid working spray, let’s go back to analyzing the assembly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7022560480626" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ldr 	  r4, [r0, #4]
mov     r0, r4
blx     &lt;android_atomic_dec ()&gt;
cmp     r0, #1</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7022560480626-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7022560480626-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7022560480626-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7022560480626-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7022560480626-1"><span class="crayon-e">ldr 	&nbsp;&nbsp;</span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#4]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7022560480626-2"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r4</span></div><div class="crayon-line" id="crayon-5f694bcca7022560480626-3"><span class="crayon-v">blx</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">&lt;</span><span class="crayon-e">android_atomic_dec</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7022560480626-4"><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#1</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>So to overcome the second constraint – in which refs-&gt;mStrong must contain 1</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7024982617206" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ldr r4, [r0, #4]  --&gt;   r4=[STATIC_ADDRESS + 4]   --&gt;  r4 = GADGET_BUFFER-4</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7024982617206-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7024982617206-1"><span class="crayon-e">ldr </span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#4]  --&gt;   r4=[STATIC_ADDRESS + 4]   --&gt;  r4 = GADGET_BUFFER-4</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>[r4] should contain 1, hence [GADGET_BUFFER &#8211; 4] should contains 1.</p>
<p>Now, after atomic_dec return value is indeed 1, we should overcome the other dereferences to get to the blx opcode.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7025043421256" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
cmp     r0, #1
bne.n   d1ea

r4=GADGET_BUFFER - 4
ldr     r0, [r4, #8] 
r0 = [GADGET_BUFFER - 4 + 8] &lt;-&gt; r0 = [GADGET_BUFFER + 4]
mov     r1, r6
ldr     r3, [r0, #0] 
r3 = [[GADGET_BUFFER + 4] + 0] &lt;-&gt; r3 = [[GADGET_BUFFER + 4]]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7025043421256-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7025043421256-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7025043421256-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7025043421256-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca7025043421256-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7025043421256-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca7025043421256-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7025043421256-8">8</div><div class="crayon-num" data-line="crayon-5f694bcca7025043421256-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7025043421256-1"><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7025043421256-2"><span class="crayon-v">bne</span><span class="crayon-sy">.</span><span class="crayon-i">n</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">d1ea</span></div><div class="crayon-line" id="crayon-5f694bcca7025043421256-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7025043421256-4"><span class="crayon-v">r4</span><span class="crayon-o">=</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5f694bcca7025043421256-5"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#8] </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7025043421256-6"><span class="crayon-v">r0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-v">r0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5f694bcca7025043421256-7"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">r6</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7025043421256-8"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#0] </span></div><div class="crayon-line" id="crayon-5f694bcca7025043421256-9"><span class="crayon-v">r3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-v">r3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p><strong>Note in order to succeed with this dereference, [GADGET_BUFFER + 4] should contain a KNOWN valid address.</strong></p>
<p>We arbitrarily chose the known address &#8211; STATIC_ADDRESS.</p>
<p><img class="aligncenter wp-image-7785 size-medium" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-4-230x103.png" alt="cve 1 6 15 4" width="230" height="103" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-4-230x103.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-4-88x40.png 88w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-4.png 251w" sizes="(max-width: 230px) 100vw, 230px" /></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7027867830905" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ldr     r2, [r3, #12]
r2 = [GADGET_BUFFER + 12]
blx     r2</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7027867830905-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7027867830905-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7027867830905-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7027867830905-1"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-p">#12]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7027867830905-2"><span class="crayon-v">r2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5f694bcca7027867830905-3"><span class="crayon-e">blx&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r2</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>So now we can build the GADGET_BUFFER as following:</p>
<p><img class="aligncenter size-full wp-image-7786" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-5.png" alt="cve 1 6 15 5" width="447" height="779" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-5.png 447w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-5-230x400.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-5-172x300.png 172w" sizes="(max-width: 447px) 100vw, 447px" /></p>
<h3>ROP CHAIN</h3>
<p>We chose to run the &#8220;system&#8221; function with a predefined command line.</p>
<p>In order to control the r0 register, and make it point to the command line string, we should use some gadgets that would manipulate the registers.</p>
<p>We got only one function call, so to take control on the execution flow with our gadgets, we should use a <strong>stack pivot</strong> gadget.</p>
<p>Therefore, the first function pointer is the preparations for the stack pivot gadget:</p>
<p><img class="aligncenter size-full wp-image-7790" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-61.png" alt="cve 1 6 15 6" width="316" height="90" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-61.png 316w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-61-230x65.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-61-140x40.png 140w" sizes="(max-width: 316px) 100vw, 316px" /></p>
<p>Where r5 equals to the original r0 (STATIC_ADDRESS) as one can see at the beginning of decStrong.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca7029566159268" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
mov     r0,r5  -  Restoring r0 to its original value.

ldr     r7, [r5]

r7 = [r5]    r7=[STATIC_ADDRESS]    r7 = GADGET_BUFFER
ldr     r2, [r7,#0x54]
r2 = [r7 + 0x54]    r2 = [GADGET_BUFFER + 84]
blx     r2</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca7029566159268-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7029566159268-2">2</div><div class="crayon-num" data-line="crayon-5f694bcca7029566159268-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7029566159268-4">4</div><div class="crayon-num" data-line="crayon-5f694bcca7029566159268-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7029566159268-6">6</div><div class="crayon-num" data-line="crayon-5f694bcca7029566159268-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f694bcca7029566159268-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca7029566159268-1"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r0</span><span class="crayon-sy">,</span><span class="crayon-v">r5</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">Restoring </span><span class="crayon-e">r0 </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">its </span><span class="crayon-e">original </span><span class="crayon-v">value</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7029566159268-2">&nbsp;</div><div class="crayon-line" id="crayon-5f694bcca7029566159268-3"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r5</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7029566159268-4">&nbsp;</div><div class="crayon-line" id="crayon-5f694bcca7029566159268-5"><span class="crayon-v">r7</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r5</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">r7</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">STATIC_ADDRESS</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">r7</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GADGET_BUFFER</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7029566159268-6"><span class="crayon-e">ldr&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r7</span><span class="crayon-sy">,</span><span class="crayon-p">#0x54]</span></div><div class="crayon-line" id="crayon-5f694bcca7029566159268-7"><span class="crayon-v">r2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r7</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">0x54</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">r2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">84</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f694bcca7029566159268-8"><span class="crayon-e">blx&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">r2</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Call to the next gadget &#8211; which should be 21(=0x54 / 4) dwords from the beginning of GADGET_BUFFER</p>
<p><img class="aligncenter size-full wp-image-7789" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-71.png" alt="cve 1 6 15 7" width="237" height="47" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-71.png 237w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-71-230x45.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-71-201x40.png 201w" sizes="(max-width: 237px) 100vw, 237px" /></p>
<p>This gadget does the Stack Pivoting.</p>
<p>SP register points to r7 – therefore the stack is under our control and points to <strong>GADGET_BUFFER</strong><strong>.</strong></p>
<p>Ret to the next gadget that should be kept <strong>8</strong> dwords from the beginning of GADGET_BUFFER</p>
<p>(Note the <strong>pop</strong>     {r4<strong>&#8211;</strong>r11<strong>,</strong>pc} instruction, which pops <strong>8</strong> registers off the stack before popping pc).</p>
<p><img class="aligncenter size-full wp-image-7791" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-8.png" alt="cve 1 6 15 8" width="266" height="40" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-8.png 266w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-8-230x34.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-8-240x36.png 240w" sizes="(max-width: 266px) 100vw, 266px" /></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f694bcca702b781003256" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
r0 = [r0 + 0x38]    r0 = GADGET_BUFFER - 0x38 (As explained before about the spray)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f694bcca702b781003256-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f694bcca702b781003256-1"><span class="crayon-v">r0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">r0</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">0x38</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">r0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">GADGET_BUFFER</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">0x38</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-st">As</span><span class="crayon-h"> </span><span class="crayon-e">explained </span><span class="crayon-e">before </span><span class="crayon-e">about </span><span class="crayon-e">the </span><span class="crayon-v">spray</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Now r0 points to 56 (0x38) bytes before GADGET_BUFFER, so we have 52 command line chars, excluding the &#8220;1&#8221; for atomic_dec.</p>
<p>Ret to the next gadget that should be kept 10 dwords from the beginning of GADGET_BUFFER (2 dwords after the current gadget – <strong>pop</strong>     {r3<strong>,</strong>pc})</p>
<p><img class="aligncenter size-full wp-image-7792" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-9.png" alt="cve 1 6 15 9" width="197" height="27" /></p>
<p>That is the last gadget where we call system!</p>
<p>Here is an updated layout of the memory for this to happen:</p>
<p><img class="aligncenter size-full wp-image-7793" src="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-10.png" alt="cve 1 6 15 10" width="457" height="759" srcset="https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-10.png 457w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-10-230x381.png 230w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-10-180x300.png 180w, https://blog.paloaltonetworks.com/wp-content/uploads/2015/01/cve-1-6-15-10-24x40.png 24w" sizes="(max-width: 457px) 100vw, 457px" /></p>
<h4>Android and ARM</h4>
<p>There are two important issues we should keep in mind when choosing the gadgets addresses.</p>
<ul>
<li>There is an ASLR mechanism on Android, and the addresses wouldn&#8217;t be the same on each and every time. In order to know the correct address, we use the fact that both system server process, and our app are forked from the same process &#8211; ZYGOTE, meaning we share the same modules. So we get the address of the necessary modules in system server process, by parsing the maps file of our process. &#8216;maps&#8217; is a file in /proc/&lt;pid&gt;/maps which contains the memory layout and the loaded modules addresses.</li>
<li>On ARM CPU, there are two modes of opcode parsing: ARM (4 bytes per opcode) and THUMB (variable bytes per opcode – 2 or 4). Meaning that the same address pointed by PC, could be parsed differently by the cpu when running in different modes. <strong>Parts of the gadgets we use are in the THUMB mode. </strong>In order to make the processor change its mode when parsing those gadgets, we <strong>change</strong> the pointer address from the actual address, to (address &amp; 1) &#8211; turning on the LSB, which make the cpu jmp to the correct address with THUMB mode.</li>
</ul>
<h3>PAYLOAD</h3>
<p>As described before, we use the &#8220;system&#8221; function to run our command line. The length of the command line is limited, and actually a command line can&#8217;t be used for every purpose. So we decided to use a pre compiled elf, that being written to the file system, as an asset of our app. This elf can do anything with uid 1000 (the uid of system server). The command line we send as an argument to system is simply –</p>
<p style="padding-left: 30px;">&#8220;sh -c &#8221; + file_path</p>
<h3>CONCLUSION</h3>
<p>Android has some common security mechanisms such as ASLR and DEP which should make an exploitation of vulnerability harder to achieve.</p>
<p>Moreover, every application runs in its own process, so the IPC communication could be validated, and making guesses on memory layout shouldn&#8217;t be intuitive. On the other hand, the fact that every process is forked from the same process makes ASLR irrelevant for vulnerabilities within zygote&#8217;s sons and the binder connection from every process to system server could lead to heap spray as seen on this post. Those issues appear to be inherent in the Android OS design.</p>
<p>Palo Alto Networks has been researching an Android security solution that based on our lab testing would have blocked this exploit (as well as other exploits) with multiple exploit mitigation modules. We hope to share more details in the coming months.</p>
</div>
            </div>

        </div>       
    </div>
  </article>


<script type="text/javascript">
    $('body').on('mouseover', '.idc_ul_cont_not_liked_inner', function(e) {
          $(this).find('svg').children('path').attr('stroke','#FF2E00');
          //$(this).attr('src','https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/blue-like-icon.png');
      });
      $('body').on('mouseout', '.idc_ul_cont_not_liked_inner', function(e) {
          $(this).find('svg').children('path').attr('stroke','#000000');
          //$(this).attr('src','https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/grey-like-icon.png');
      });
      
    $(document).ready(function(){
        //Moving single post page subscribe box one paragraph above from last
        var cont_width = $(".entry-content").width();
        cont_width = Math.round(cont_width/2);//
        var p_tag_found = false;
        var child_count = $( ".entry-content").children().length;
        var last_p_tag = ''; //2nd p tag 
        var p_tag_traverse_cnt = 0;
        var p_arr = [];
        var next_tag_is_image_container = false;
        for(var i = 0; i < child_count ; i++){
            var p_el = $('.entry-content').children().eq(i);
            /*
            var tag_name = $(p_el).prop('tagName');
            if(tag_name != 'UL' || tag_name == 'P'){
                continue
            }
            */
            
              var temp_text = $(p_el).html();
              temp_text = temp_text.trim();
              
              
              var found_in_child = $( p_el ).find( "img, iframe, video, figure" );
                
              if(temp_text == '&nbsp;' || temp_text == ''){
                 continue;
              }
              else{
                  p_arr.push(p_el);
              }
        }
        console.log(p_arr);
        

        $.each(p_arr, function (index,value) {
            
            if(next_tag_is_image_container){
                next_tag_is_image_container = false;
                return;
            }
            
            var found_img1 = $(p_arr[index]).find( "img, iframe, video, figure" );//finding any image
            var found_txt1 = $(p_arr[index]).text().trim();
            if(found_img1.length != 0 && found_txt1 == ''){//if image exists inside paragraph, with no sibling text
                return;
            }
                
                var p_el = value;
                var current_tag_name = $(p_el).prop('tagName');
                if(current_tag_name == 'IMG' || current_tag_name == 'IFRAME' || current_tag_name == 'VIDEO' || current_tag_name == 'FIGURE'){
                    return;
                }
              
              
                  p_tag_traverse_cnt++;
                  var next_of_p = p_arr[index+1];
                  var next_tag = $(next_of_p).prop('tagName');
                  
                  
                  if(p_tag_traverse_cnt == 3){
                      //If next element is UL, then add subscription box after UL
                      
                      //if next element is image or video, add the box after 3rd paragraph
                      
                      if(next_tag == 'IMG' || next_tag == 'IFRAME' || next_tag == 'VIDEO' || next_tag == 'FIGURE'){
                          //Check if image is not right aligned
                          var img_width = $(next_of_p).width();
                          
                          if(img_width > cont_width){//If image is not right aligned
                              next_tag_is_image_container = true;
                                return;
                          }
                          
                          
                      }
                      //Check if image or video exist as a child element
                      var found_in_child = $( next_of_p ).find( "img, iframe, video, figure" );
                      //console.log(found_in_child[0].width);
                      //console.log(found_in_child);
                      if(found_in_child.length != 0){
                             var img_width = found_in_child[0].width;
                             console.log(img_width+" "+cont_width);
                          if(img_width > cont_width){//If image is not right aligned
                              next_tag_is_image_container = true;
                                return;
                          }
                          
                      }
                      
                      if(next_tag == 'UL' && current_tag_name != 'UL'){
                          last_p_tag = next_of_p;
                          return false;    
                      }
                      else{
                          last_p_tag = p_el;
                          return false;    
                      }
                      
                  }    
                  if(p_tag_traverse_cnt > 3){
                       //If next element is UL, then add subscription box after UL
                      if(next_tag == 'UL' && current_tag_name != 'UL'){
                          last_p_tag = next_of_p;
                          return false;     
                      }
                      else{
                          last_p_tag = p_el;
                          return false;   
                      }
                  }
              
        });
        
        
        if(last_p_tag != ''){
            $( last_p_tag ).after('<div style="clear:both;"></div>',$('.subscribe-form-inner'));
        }
        // $( ".entry-content p:last-child" ).before($('.subscribe-form-inner'));
        
    });
    $('a').each(function() {
        if(this.id == 'share_btn'){
            return;
        }
        var a = new RegExp('/' + window.location.host + '/');
        if(!a.test(this.href)) {
            $(this).click(function(event) {
                event.preventDefault();
                event.stopPropagation();
                window.open(this.href, '_blank');
            });
        }
     });
     $('.comment-form-cookies-consent input[type=checkbox]').prop('checked','checked');
     //$('.form-submit input[type=submit]').after( '<img class="ajax-loader" style="display:none;" src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/backgrounds/ajax-loader.gif" alt="Sending ...">' );
     //Hide manage subscription link
     
     if($('.subscribe-to-comments input[type=checkbox]').length == 0){
         $('.subscribe-to-comments').hide();
     }
     
          $('.form-submit input[type=submit]').attr('disabled',true);
          function enableCommentBtn(){
         $('.form-submit input[type=submit]').attr('disabled',false);
     }
     function disableCommentBtn(){
         $('.form-submit input[type=submit]').attr('disabled',true);
     }
    </script>
<div id="search-result-continer" style="display:none;min-height: 343px;">
    <!--<div id="search-result-heading" class="container-fluid container-breadcrumb"  data-aos="fade-in" style="display:none;">
       <div class="container-lg">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="https://blog.paloaltonetworks.com">Palo Alto Networks</a></li>
              <li class="breadcrumb-item search-term"></li>
          </ol>
        </nav>
       </div>
    </div>-->
    <div class="container-fluid container-feed-cards">
        <div class="container-lg">
            <div class="row row-feed">
                <div class="col col-feed">
                    
                    <div id="ajax_loader" class="text-center pb-40 pt-40">
                  <span>Loading...</span>
			</div>
      <div id="notfound2" class="text-center pt-40 pb-40" style="display: none;">Sorry, no results were found.</div>
      
                    <div class="row row-feed articles_container CoveoResultList" data-layout="list" data-wait-animation="fade" data-fields-to-include="@articlecategory, @articleauthor, @articlepublishedtime, @articlecategory, @articleauthorlink, @articledescription, @articlepostimage, @articlepublishedtimestring, @articleauthorimagelink, @articlepostid, @articlepostlength, @articlecategorylink, @uri" data-result-container-selector='#test_id' id="test_id">
                        <script id="customTemplate" type="text/underscore" class="result-template">
            <% JSON.stringify(raw) %>
              <article data-article-id="<% if(typeof raw.articlepostid !== "undefined") { print(raw.articlepostid); } %>" class="feed-card h-100 pan-coveo-search-list">
                <%if (typeof raw.articlepostimage =='undefined') { 
                    raw.articlepostimage = 'https://blog.paloaltonetworks.com/wp-content/uploads/2016/11/blog-generic-banner-1.jpg';
                 } %>
                        
                <%if (typeof raw.articlepostimage !='undefined') { %> 
                <div onclick="location.href='<%= raw.uri %>'" class="feed-card-thumbnail" style="background-image: url(<%= raw.articlepostimage %>);">
                <% if(typeof raw.articlepostid !== "undefined") { %>
                <!--<div class="total_number_view left-bottom"><span class="people-reacted<% if(typeof raw.articlepostid !== "undefined") { print(raw.articlepostid); } %>">#</span> people reacted</div>-->
                <% } %>
                  
                </div>
                <% } %>

                <div class="feed-card-content">
                <p class="label">
                <%  _.each(raw.articlecategory,function(item,key,list) { %> <a <% if(typeof raw.articlepostid == "undefined"){print(' target="_blank"');} %>  href="<% if(typeof raw.articleauthorimagelink !== "undefined"){ print(raw.articlecategorylink[key]); } else{ print("#");}  %>" class="author url fn" rel="author"><%= item %></a><%if (key+1 < raw.articlecategory.length) { %>,<%  } %><%  }); %>
                            </p>
                  <h3><a <% if(typeof raw.articlepostid == "undefined"){print(' target="_blank"');} %> class="CoveoResultLink"><% var title_article = title.substr(0,75); print(title_article); var title_length = title.length; if(title_length > 75){print("...")} %></a></h3>
                  </div>
                  
                  <div class="feed-card-metadata">
			<div class="metadata-thumbnail">
			<div class="metadata-thumbnail-author">
	  		<img src="<% if(typeof raw.articleauthorimagelink !== "undefined"){ var image_link = raw.articleauthorimagelink[0]; if(image_link.indexOf("unit42.paloaltonetworks.com") != -1 ){ print("https://blog.paloaltonetworks.com/wp-content/themes/PaloAltoNetworksBlog/dist/images/unit42-logo1.jpg");} else{ print(image_link);} }else{ print("https://blog.paloaltonetworks.com/wp-content/uploads/2016/10/Social_BlogIcon_10.13.16.png"); } %>" width="75" height="75" alt="Avatar" class="avatar avatar-75 wp-user-avatar wp-user-avatar-75 photo avatar-default">			</div>
		</div>
		
		<div class="metadata-author">
                    <span class="author-name">
				By <%  _.each(raw.articleauthor,function(item,key,list) { %> <a <% if(typeof raw.articlepostid == "undefined"){print(' target="_blank"');} %> title="Posts by <%= item %>" href="<%= raw.articleauthorlink[key] %>" class="author url fn" rel="author"><%= item %></a><%if (key+1 < raw.articleauthor.length) { %><%if (key+1 == raw.articleauthor.length-1) { %> and <% } else { %>,<% } } %><%  }); %>                        <br>
                        <time datetime="<%= raw.articlepublishedtimestring %>"><%= raw.articlepublishedtimestring %></time>
                        <br>
                       <% if(typeof raw.articlepostlength !== "undefined"){ print(Math.ceil(raw.articlepostlength/200) + " min. read"); } %>
                    
                    </span>
		</div>
    <div class="metadata-likes ldc-ul_cont idc_ul_cont_not_liked" onclick="<%  print("alter_ul_post_values(this,'"+ raw.articlepostid +"','like')"); %>">
        
        <svg class=" " width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.74998 15.9999H2.49999C2.10217 15.9999 1.72064 15.8419 1.43934 15.5606C1.15803 15.2793 1 14.8977 1 14.4999V9.24995C1 8.85213 1.15803 8.4706 1.43934 8.18929C1.72064 7.90799 2.10217 7.74996 2.49999 7.74996H4.74998M9.99994 6.24997V3.24999C9.99994 2.65325 9.76289 2.08096 9.34094 1.65901C8.91898 1.23705 8.34669 1 7.74996 1L4.74998 7.74996V15.9999H13.2099C13.5717 16.004 13.9227 15.8772 14.1983 15.6429C14.474 15.4086 14.6557 15.0826 14.7099 14.7249L15.7449 7.97496C15.7775 7.75997 15.763 7.54047 15.7024 7.33165C15.6418 7.12283 15.5365 6.92968 15.3938 6.7656C15.2511 6.60151 15.0745 6.47041 14.8761 6.38138C14.6777 6.29234 14.4623 6.2475 14.2449 6.24997H9.99994Z" stroke="#727272" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <span class="<%  print("article-like-id"+raw.articlepostid);  %>"></span></span>
        
    </div>
	
</div>
              </article>
          </script>
          
                </div>     
                      <div class="col">
	
          <div class="loadmore text-center loadmore_main" style="display: none;">
      <button type="button" class="btn  load_more_btn" data-firstres="0">Load more</button>
    </div>
                    </div>
                      <div class="container" style="display: none;">
  
               

    <!-- Each DOM element with a class starting with "coveo-" (lowercase) is for CSS or alignment purpose only. -->
    <div class='coveo-search-section'>
      <div class="coveo-results-column">
        <!--selected breadcrumb-->
        <div class="CoveoBreadcrumb">
          <div class="coveo-breadcrumb-clear-all" title="Clear All Filters" tabindex="0">
            <div class="coveo-icon coveo-breadcrumb-icon-clear-all"></div>
            <div>Clear </div>
          </div>
        </div>
        <span class="CoveoSort coveo-sort-selection" data-sort-criteria="@articlepublishedtime descending" data-caption="Date"></span>
        <div class="coveo-results-header">
          <div class="coveo-summary-section">
            <span class="CoveoQuerySummary"></span>
          </div>
        </div>
      </div>
    </div>
                      </div>
      
          
            </div>
        </div>            
    </div>
</div>
</div>

<script type="text/javascript">
    document.write(str_subscription);
</script>
<section class="pan-mega-footer">
    <div class="container">
        <div class="row pan-mega-footer-links">
            <div class="col-xs-12 col-sm-4 col-md-3">
                <div class="footerTitle1 title baseComponent parbase">
                    <p>Popular Resources</p>
                </div>
                <div class="footerList1 list baseComponent parbase">
                    <ul class=" list-unstyled">
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Blog" href="https://blog.paloaltonetworks.com/">Blog</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Careers" href="https://jobs.paloaltonetworks.com/">Careers</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Communities" href="https://www.paloaltonetworks.com/communities">Communities</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Content Library" href="https://www.paloaltonetworks.com/resources">Content Library</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Cyberpedia" href="https://www.paloaltonetworks.com/cyberpedia">Cyberpedia</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Event Center" href="https://events.paloaltonetworks.com">Event Center</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Investors" href="https://investors.paloaltonetworks.com/investor-relations/overview/default.aspx">Investors</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Tech Docs" href="https://docs.paloaltonetworks.com/">Tech Docs</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Unit 42" href="https://unit42.paloaltonetworks.com/">Unit 42</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Popular Resources:Sitemap" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-xs-12 col-sm-4 col-md-3">
                <div class="footerTitle2 title baseComponent parbase">
                    <p>Legal Notices</p>
                </div>
                <div class="footerList2 list baseComponent parbase">
                    <ul class=" list-unstyled">
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Legal Notices:Privacy" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Legal Notices:Trust Center" href="https://www.paloaltonetworks.com/legal-notices/trust-center">Trust Center</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Legal Notices:Terms of Use" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a>
                        </li>
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Legal Notices:Documents" href="https://www.paloaltonetworks.com/legal">Documents</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-xs-12 col-sm-4 col-md-3">
                <div class="footerTitle3 title baseComponent parbase">
                    <p>Account</p>
                </div>
                <div class="footerList3 list baseComponent parbase">
                    <ul class=" list-unstyled">
                        <li>
                            <a class="" data-page-track="true" data-page-track-value="footer:Account:Manage Subscriptions" href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a>
                        </li>
                    </ul>
                </div>
                <div class="vulnerabilityHtml html baseComponent parbase">
                    <div style="margin-top: 30px">
                        <a href="https://www.paloaltonetworks.com/security-disclosure" style="color: #C63F24; font-family: Arial,sans-serif; font-size: 14px; font-style: normal; font-weight: normal; line-height: normal">Report a Vulnerability</a>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-3 footer-social-col">
                <div class="content">                
                    <ul class="list-inline">
                        <li class="list-inline-item">
                            <a href="https://www.facebook.com/PaloAltoNetworks/" target="_blank"><img alt="Facebook" class="lozad" data-loaded="true" data-src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Facebook-black.svg" src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Facebook-black.svg"></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.linkedin.com/company/palo-alto-networks" target="_blank"><img alt="Linkedin" class="lozad" data-loaded="true" data-src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Linkedin-black.svg" src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Linkedin-black.svg"></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://twitter.com/PaloAltoNtwks" target="_blank"><img alt="Twitter" class="lozad" data-loaded="true" data-src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Twitter-black.svg" src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Twitter-black.svg"></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.youtube.com/user/paloaltonetworks" target="_blank"><img alt="Youtube" class="lozad" data-loaded="true" data-src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Youtube-black.svg" src="https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/svg/Youtube-black.svg"></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
<footer class="pan-footer">
    <div class="container">
        <span><p>&copy; 2020 Palo Alto Networks, Inc. All rights reserved.<br></p>
        </span>
    </div>
</footer>
<div class="CoveoSearchbox" data-enable-search-as-you-type="false" data-enable-omnibox="true" data-omnibox-timeout="1000" data-placeholder="Search the blog" data-enable-query-suggest-addon="false" data-trigger-query-on-clear="true" id="pan-coveo-input" style="display: none;"></div>



<script type="text/javascript">
    jQuery('body').attr('data-pipeline', "New Research Center Pipeline");
    var timerIsCoveoDefined = '';
    var resultTotalCount;
    //var root = document.getElementById('coveo-container');
    var root = document.body;
    var isloadCoveoLibraryCalled = false;
    var screenwidth = window.screen.width;
    var isIE11 = !!navigator.userAgent.match(/Trident.*rv\:11\./);
    var topSearch = true;
    //Coveo code
    function loadCoveoLibrary() {
        if (isloadCoveoLibraryCalled) {
            return;
        }
        isloadCoveoLibraryCalled = true;
        $.getScript("https://static.cloud.coveo.com/searchui/v2.3679/js/CoveoJsSearch.Lazy.min.js");
        timerIsCoveoDefined = setInterval(isCoveoDefined, 1000);
    }
    function isCoveoDefined() {
        if (typeof Coveo !== 'undefined') {
            console.log("Coveo object is now defined.")
            executeCoveoSearch();
            clearInterval(timerIsCoveoDefined);
            $('#postSearch1, #postSearch2').attr('title', '');
            $('#postSearch1, #postSearch2').prop("readonly", false);
            $('.dropdown-menu a').css('pointer-events','auto');
        }
    }
    function executeCoveoSearch() {

        var settings = {
            "async": false,
            "url": "https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/coveosearch.getaccesstoken.php",
            //"url": "https://www.paloaltonetworks.com/apps/pan/public/coveosearch.getaccesstoken.json",
            "method": "GET",
        }


        jQuery.ajax(settings).done(function (response) {

            Coveo.SearchEndpoint.endpoints['default'] = new Coveo.SearchEndpoint({
                restUri: 'https://platform.cloud.coveo.com/rest/search',
                queryStringArguments: {
                    organizationId: 'paloaltonetworksintranet'                    
                },
                accessToken: response.token
            });
            Coveo.$$(root).on("querySuccess", function (e, data) {
                //console.log(data.query.q);
                if(!$('#searching').val()){
                    topSearch = false;
                }
                
                if(topSearch){
                    $([document.documentElement, document.body]).animate({
                        scrollTop: 0 
                    }, 1000);
                }
                
                if(topSearch){
                    $('nav.navbar li a.active').removeClass('active');
                }
                resultTotalCount = data.results.totalCount;
                //document.title = "Palo Alto Networks Blog";
                /*
                if(resultTotalCount > 0){
                    $('#search-result-heading .search-term').text(capitalizeFirstLetter(data.query.q));
                    $('#search-result-heading').show();
                }
                else{
                    $('#search-result-heading').hide();
                    $('#search-result-heading .search-term').text('');
                }
                */

            });
            Coveo.$$(root).on("newResultsDisplayed", function (e, args) {
                $('#ajax_loader').hide();
                $('#notfound2').hide();
                $('.load_more_btn').html('Load more');
                $('.load_more_btn').prop('disabled', false);
                $('.CoveoResult').addClass('col-xs-12 col-sm-6 col-md-6 col-lg-4 col-xl-4 col-feed-card grid-item');
                var article_ids = new Array();
                jQuery.each(jQuery('.pan-coveo-search-list'), function (i) {
                    var article_id_tmp = $(this).data("article-id");
                    if (article_id_tmp != '' && !jQuery(this).hasClass('num-like-retrieved')) {
                        article_ids.push(article_id_tmp);
                    }
                    if (article_id_tmp != '') {
                        //If this article is liked, make the thumb icon to blue
                        var article_liked_list = [];
                        var like_found = $.inArray(article_id_tmp, article_liked_list);
                        if (like_found != -1) {
                            $(this).find('.ldc-ul_cont').find('svg').children('path').attr('stroke', '#FF2E00');
                            $(this).find('.ldc-ul_cont').removeClass('idc_ul_cont_not_liked');
                        }
                    }
                });
                if (article_ids.length > 0) {
                    var saveData = $.ajax({
                        type: 'POST',
                        url: wp_vars.ajax_url,
                        data: {action: 'fetch_total_article_likes', article_ids_arr: JSON.stringify(article_ids)},
                        dataType: "json",
                        success: function (resultData) {
                            //var article_likes = JSON.parse(resultData);
                            jQuery.each(article_ids, function (i, val) {
                                $('.article-like-id' + val).text(resultData[val][0]);
                                //$('.people-reacted'+val).text(resultData[val][1]);
                                $('.article-like-id' + val).closest(".pan-coveo-search-list").addClass('num-like-retrieved');
                            });
                        }
                    });
                }
                //console.log($('.CoveoResult').length +'|'+ resultTotalCount);
                //console.log(Coveo.state(root, 'first'));
                if ($('.CoveoResult').length >= resultTotalCount) {
                    $('.load_more_btn').hide();
                } else {
                    $('.load_more_btn').show();
                }
                if (resultTotalCount <= 0) {
                    $('#notfound2').show();
                } else {
                    $('#notfound2').hide();
                }
                
                if (jQuery('.magic-box-input input').val() || $('.CoveoResult').length >= 1) {
                    if(topSearch){
                        jQuery('#main-container').hide();
                        $('#inner_cards').show();
                        jQuery('.loadmore_main2').hide();
                        jQuery('#search-result-continer').show();
                        jQuery('.loadmore_main').show();
                        $('#main-container .container-feed-cards .container-lg').removeAttr('style');
                        $('#search-result-continer .container-feed-cards .container-lg').removeAttr('style');
                    }
                    else{
                        jQuery('#main-container').show();
                        $('#inner_cards').hide();
                        jQuery('.loadmore_main2').hide();
                        jQuery('#search-result-continer').show();
                        jQuery('.loadmore_main').show();
                        $('#main-container .container-feed-cards .container-lg').attr('style','padding-bottom: 0;');
                        $('#search-result-continer .container-feed-cards .container-lg').attr('style','padding-top: 0;');
                    }
                } else {
                    jQuery('#search-result-continer').hide();
                    jQuery('.loadmore_main').hide();
                    $('#inner_cards').show();
                    jQuery('#main-container').show();
                    jQuery('.loadmore_main2').show();
                }
            });
            //Coveo.state(root, 'numberOfResults',9);
            //Coveo.state(Coveo.$$(document).find(".magic-box-input input"), 'f:@articlecategory' , 'Secure the Cloud');
            Coveo.SearchInterface.options.autoTriggerQuery.defaultValue = false;
            Coveo.init(root);
        });
    }

    $('body').on('blur', '.magic-box-input input, #postSearch1', function (e) {
        var has_hash = false;
        if (window.location.hash.length) {
            has_hash = true;
        }
        var to_append = '';
        if (has_hash) {
            to_append = window.location.hash.replace('#', '');
            to_append = '#' + to_append;
        }
        window.history.replaceState(null, null, "?search_field=" + $(this).val() + to_append);
    });

    $('.load_more_btn').on('click', function () {
        //Coveo.SearchEndpoint.endpoints["default"].options.queryStringArguments.numberOfResults = 8;
        load_more_clicked = true;

        var this_btn = $(this);
        $(this).addClass('is-clicked');
        $(this).html('Loading...');
        $(this).prop('disabled', true);
        //jQuery('.articles_container').masonry('reloadItems').masonry();
        //Coveo.SearchEndpoint.endpoints["default"].options.queryStringArguments.numberOfResults = 8;
        //Coveo.state(root, 'firstResult',$('.CoveoResult').length - 1);
        Coveo.$('.CoveoResultList').coveo('displayMoreResults', 9);
        //Coveo.SearchEndpoint.endpoints["default"].options.queryStringArguments.numberOfResults = 9;
        setTimeout(function () {
            this_btn.removeClass('is-clicked');
        }, 1900);
    });
    var interval;
    var timer2;

    if (isIE11) {
        executeCoveoSearch();
    }




    var captcha_rendered = false;
    var subscribeSuccess = false;

    jQuery('body').on('change paste keyup', '.business_email_bot', function () {
        jQuery(this).closest('form').find('.google-recapth').removeClass('d-none');
    });

    $('body').on('mouseover', '.idc_ul_cont_not_liked', function (e) {
        $(this).find('svg').children('path').attr('stroke', '#FF2E00');
        //$(this).attr('src','https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/blue-like-icon.png');
    });
    $('body').on('mouseout', '.idc_ul_cont_not_liked', function (e) {
        $(this).find('svg').children('path').attr('stroke', '#727272');
        //$(this).attr('src','https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/images/grey-like-icon.png');
    });




    $(document).ready(function () {
        getSerializedTracking("Unit42_Subscribe");

    });
    $('body').click(function () {
        $('.CoveoDidYouMean').hide();
    });

    jQuery('body').on('change paste keyup', '.business_email', function () {
        //console.log($('#captcha_container2').children().length);
        if ($('#captcha_container').length == 1 && $('#captcha_container').children().length == 0) {
            console.log("cap1");
            var loadCaptcha = function () {
                captchaContainer = grecaptcha.render('captcha_container', {
                    'sitekey': '6LeyHGkUAAAAAEwfqwKWxNqdht3xjSNf-j3bK7l2',
                    'callback': function (response) {
                        $("form[name='Unit42_Subscribe'] button[type='submit']").prop('disabled', false);
                        subscribeSuccess = true;
                    },
                    'expired-callback' : function(){
                        $("form[name='Unit42_Subscribe'] button[type='submit']").prop('disabled', true);
                        subscribeSuccess = false;
                    }
                });
            }
            loadCaptcha();
        }
        /*
        if ($('#captcha_container2').length == 1 && $('#captcha_container2').children().length == 0) {
            console.log("cap2");
            var loadCaptcha2 = function () {
                captchaContainer = grecaptcha.render('captcha_container2', {
                    'sitekey': '6LeyHGkUAAAAAEwfqwKWxNqdht3xjSNf-j3bK7l2',
                    'callback': function (response) {
                        $("form[name='contact_sales_modal'] input[type='submit']").prop('disabled', false);
                        subscribeSuccess = true;
                    }
                });
            }

            loadCaptcha2();
        }
        */
        setTimeout(function () {
            jQuery('#row-recatcha').removeClass('d-none');
            //jQuery('.articles_container').masonry('layout');
        }, 50);
    });


    jQuery('body').on('submit', 'form.subscribe-form', function () {
        var success = true;
        var form = jQuery(this);
        var mail = form.find('input[name="Email"]');
        if (mail.val() === '' || !isEmail(mail.val())) {
            mail.closest("form").addClass('has-error');
            success = false;
        } else {
            mail.closest("form").removeClass('has-error');
        }

        if (success && subscribeSuccess) {
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: form.serialize(),
                success: function (msg) {
                    form.html('<p style="color: #0c6;">You have been successfully subscribed</p>');
                    //masonry.masonry('layout');
                }
            });
        }
        return false;
    });


    function isEmail(email) {
        var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }


    $(document).ready(function () {
        //$('body').attr('data-results-per-page', '9');
        $("#dropdownMenuButton").click(function(){
            if (typeof Coveo === 'undefined') {
                //$(".dropdown-menu a").attr('disabled',"disabled");
                $('.dropdown-menu a').css('pointer-events','none');
                loadCoveoLibrary();
            }
        });
        
        $(".dropdown-menu a").click(function(e){
            $(this).parents(".dropdown").find('.btn').html($(this).text());
            $(this).parents(".dropdown").find('.btn').val($(this).data('value'));
            topSearch = false;
            e.preventDefault(); 
        });
        
        /**
         $('img').each(function() {
         var path = $(this).attr('src');
         $(this).attr('src', path.replace("http://blog-localhost.paloaltonetworks.com/wp-content/upload", "https://blog.paloaltonetworks.com/wp-content/upload"));
         });
         $('figure').each(function() {
         var path = $(this).attr('style');
         if (typeof path !== 'undefined'){
         $(this).attr('style', path.replace("http://blog-localhost.paloaltonetworks.com/wp-content/upload", "https://blog.paloaltonetworks.com/wp-content/upload"));
         }
         });
         * 
         */
        
        $(".pan-page-alert-close").click(function(){
            $("#nav-mobile").css("top", "72px");
          });
          $("#feed-clear").click(function(){
              //$('#mostRecentTab').trigger('click');
            $('#postSearch2').val('');
            $('#sec-search-clear').hide();
            jQuery('#search-result-continer').hide();
            jQuery('.loadmore_main').hide();
            $('#inner_cards').show();
            jQuery('#main-container').show();
            jQuery('.loadmore_main2').show();
            $('#main-container .container-feed-cards .container-lg').removeAttr('style');
            
            
            $('.col-feed-filter #dropdownMenuButton').val("Most Recent");
            $('.col-feed-filter #dropdownMenuButton').html("Most Recent");
            $('#mostRecentTab').addClass('coveo-selected');
            $('#mostPopularTab').removeClass('coveo-selected');
         
            
          });
          

        $('#postSearch2').focus(function () {
            if (typeof Coveo === 'undefined') {
                //$('#postSearch1, #postSearch2').attr('title', 'Loading...please wait');
                $('#postSearch1, #postSearch2').prop("readonly", true);
                loadCoveoLibrary();
            }
        });
        $('body').on('keyup', '#postSearch1, #postSearch2', function (e) {
            //cur_search_txt = jQuery('.magic-box-input input').val(); 
            if(this.id == 'postSearch2'){
                topSearch = false;
            }
            else{
                topSearch = true;
            }
            var typed_text;
            if(topSearch){
                typed_text = $('#postSearch1').val();
            }
            else{
                typed_text = $('#postSearch2').val();
                if((typed_text.length > 0) ){
                    $('#sec-search-clear').show();
                    //$('#feed-search').prop('disabled', false);
                }
                else{
                    $('#sec-search-clear').hide();
                    //$('#feed-search').prop('disabled', true);
                }
            }
            
            
            $('.magic-box-input input').val(typed_text);
            if ((typed_text.length > 0) && e.keyCode === 13) {
                if(topSearch && !$('#searching').val()){
                    location.href='https://blog.paloaltonetworks.com?search_field='+typed_text;
                    return;
                }
                //enterKeyPressed = true;
                if (screenwidth < 992) {
                    if(topSearch){
                    mobileToggle();
                }
                }
                $('.CoveoSearchButton').click();
            }
        });
    });
</script>


    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://blog.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#FA582D');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
    <script type='text/javascript'>
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/blog.paloaltonetworks.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"}};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/plugins/contact-form-7/includes/js/scripts.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/popper.min.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/bootstrap.min.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/aos.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wp_vars = {"ajax_url":"https:\/\/blog.paloaltonetworks.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/masonry2.js?v2'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-content/themes/panwblog2020/dist/scripts/jquery.cookie.js'></script>
<script type='text/javascript' src='https://blog.paloaltonetworks.com/wp-includes/js/wp-embed.min.js'></script>
  </body>
</html>

