<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://news.sophos.com/xmlrpc.php">
<link rel="alternate" hreflang="en-us" href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/" /><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl+ '&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x';f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5L6H3LN');</script>
<!-- End Google Tag Manager -->
<title>Emotet 101, stage 4: command and control &#8211; Sophos News</title>
<meta name='robots' content='max-image-preview:large' />
<!-- Jetpack Site Verification Tags -->
<meta name="google-site-verification" content="8r1qg681OjOolfxmHEY1IYupmTBdyKXc-OPfpgeQHFk" />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel='dns-prefetch' href='//v0.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Feed" href="https://news.sophos.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Comments Feed" href="https://news.sophos.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Emotet 101, stage 4: command and control Comments Feed" href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/news.sophos.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0' href='https://news.sophos.com/_static/??/wp-includes/css/dist/block-library/style.min.css,/wp-content/themes/sophosnews-2017/style.css,/wp-content/mu-plugins/jetpack-9.5/css/jetpack.css?m=1615460519' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify{text-align:justify;}
</style>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJzTLy/QzcxLzilNSS3WzwKiwtLUokoopZebmaeXVayjj0+Rbm5melFiSSpUsX2uraGZoamxkaGpmWEWAK8/Ihc='></script>
<link rel="https://api.w.org/" href="https://news.sophos.com/wp-json/" /><link rel="alternate" type="application/json" href="https://news.sophos.com/wp-json/wp/v2/posts/56436" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://news.sophos.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://news.sophos.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7" />
<link rel="canonical" href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/" />
<link rel='shortlink' href='https://news.sophos.com/?p=56436' />
<link rel="alternate" type="application/json+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F03%2F05%2Femotet-101-stage-4-command-and-control%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F03%2F05%2Femotet-101-stage-4-command-and-control%2F&#038;format=xml" />
<style type='text/css'>img#wpstats{display:none}</style><link rel="amphtml" href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/amp/">
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Emotet 101, stage 4: command and control" />
<meta property="og:url" content="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/" />
<meta property="og:description" content="The Emotet family could not do what it does without receiving a constant stream of instructions from its owners, or in the absence of the detailed level of feedback about its operating environment …" />
<meta property="article:published_time" content="2019-03-05T13:58:33+00:00" />
<meta property="article:modified_time" content="2019-11-26T15:10:52+00:00" />
<meta property="og:site_name" content="Sophos News" />
<meta property="og:image" content="https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?w=640" />
<meta property="og:image:secure_url" content="https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?w=640" />
<meta property="og:image:width" content="640" />
<meta property="og:image:height" content="334" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="Emotet 101, stage 4: command and control" />
<meta name="twitter:image" content="https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?w=640" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="fb:admins" content="28552295016" />

<!-- End Jetpack Open Graph Tags -->
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=32" sizes="32x32" />
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=192" sizes="192x192" />
<link rel="apple-touch-icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=180" />
<meta name="msapplication-TileImage" content="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=270" />
</head>

<body class="post-template-default single single-post postid-56436 single-format-standard group-blog">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5L6H3LN&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<header id="masthead" class="site-header">

		<div class="header-container">

			<div class="site-branding">
				<h1 class="site-title">
										<a class="site-logo" href="https://www.sophos.com/en-us.aspx" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- site-branding -->

			<nav class="primary-header-navigation" role="navigation">
				<ul id="menu-en-us-primary" class="menu"><li id="menu-item-33368" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33368"><a href="https://www.sophos.com/en-us/products.aspx">Products<div class="menu-item-description"></div></a></li>
<li id="menu-item-33382" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33382"><a href="https://www.sophos.com/en-us/solutions.aspx">Solutions<div class="menu-item-description"></div></a></li>
<li id="menu-item-33390" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33390"><a href="//www.sophos.com/en-us/partners.aspx">Partners<div class="menu-item-description"></div></a></li>
<li id="menu-item-33391" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33391"><a href="//www.sophos.com/en-us/support.aspx">Support<div class="menu-item-description"></div></a></li>
<li id="menu-item-33392" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33392"><a href="//www.sophos.com/en-us/company.aspx">Company<div class="menu-item-description"></div></a></li>
<li id="menu-item-33393" class="is-icon icon-download menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-33393"><a href="#">Downloads<div class="menu-item-description"></div></a>
<ul class="sub-menu">
	<li id="menu-item-33394" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33394"><a href="//www.sophos.com/en-us/products/free-trials.aspx">Free Trials<div class="menu-item-description">All product trials in one place.</div></a></li>
	<li id="menu-item-33395" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33395"><a href="//www.sophos.com/en-us/products/free-tools.aspx">Free Tools<div class="menu-item-description">Try our tools for use at home.</div></a></li>
	<li id="menu-item-33396" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33396"><a href="//www.sophos.com/en-us/products/request-a-quote.aspx">Get Pricing<div class="menu-item-description">The right price every time.</div></a></li>
</ul>
</li>
<li id="menu-item-33397" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33397"><a href="//www.sophos.com/en-us/search-results.aspx">Search<div class="menu-item-description"></div></a></li>
<li id="menu-item-33398" class="is-icon icon-account menu-item menu-item-type-custom menu-item-object-custom menu-item-33398"><a href="//www.sophos.com/en-us/login.aspx">Sign In<div class="menu-item-description"></div></a></li>
</ul>			</nav>

		</div>
	</header> <!-- site-header -->

	<div class="secondary-header">
		<div class="secondary-header-container container">
			<nav class="secondary-header-navigation" role="navigation">
				<ul id="menu-en-us-secondary" class="menu"><li id="menu-item-33399" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33399"><a href="//www.sophos.com/en-us/company.aspx">Overview</a></li>
<li id="menu-item-33401" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33401"><a href="//www.sophos.com/en-us/company/press.aspx">Press</a></li>
<li id="menu-item-33402" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33402"><a href="//secure2.sophos.com/en-us/company/events.aspx">Events</a></li>
<li id="menu-item-33403" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33403"><a href="//www.sophos.com/en-us/company/community.aspx">Community</a></li>
<li id="menu-item-33404" class="menu-item-blog menu-item menu-item-type-custom menu-item-object-custom menu-item-33404"><a href="/">Blog</a></li>
<li id="menu-item-33405" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33405"><a href="//secure2.sophos.com/en-us/company/careers.aspx">Careers</a></li>
<li id="menu-item-33406" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33406"><a href="//www.sophos.com/en-us/company/contact.aspx">Contact</a></li>
</ul>			</nav>
		</div>
	</div> <!-- secondary-header -->

	<div class="news-header">
		<div class="news-header-container container">

			<div class="news-branding">
				<h1 class="news-title">
					<a class="news-logo" href="https://news.sophos.com/en-us/" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- news-branding -->

			<div class="mobile-menu-toggle">
				<a href="#newsmenu">
											Menu									</a>
			</div>

			<div class="mobile-search-toggle">
				<a class="icon icon-search-secondary" href="#search">
					Search				</a>
			</div>

			<nav class="news-header-navigation" role="navigation">
				<ul id="menu-en-us-tertiary" class="menu"><li id="menu-item-33407" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33407"><a href="#search">Search</a></li>
</ul>			</nav>

			<div class="site-search-block" style="display: none;">
				<form role="search" class="search-form" method="get" action="https://news.sophos.com/en-us/">
					<fieldset>
						<div class="field">
							<input type="text" value="" name="s" class="search-field" placeholder="Search">
						</div>
						<div class="submit">
							<button type="submit" class="search-submit icon icon-search-secondary">
								Go							</button>
						</div>
					</fieldset>
				</form>
				<a class="icon" href="#search-close">
					Close				</a>
			</div>
		</div>
	</div> <!-- news-header -->

	<div id="content" class="site-content">
		<div class="content-container">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-56436" class="post-56436 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs category-sophoslabs-uncut tag-647528206 tag-bot tag-emotet tag-maldocs tag-malspam tag-malware tag-payload tag-pdf tag-sophos101 tag-spam tag-word tag-xml region-en-us">

	<header class="entry-header">

		<h1 class="entry-title">Emotet 101, stage 4: command and control</h1>
		<div class="entry-categories">
			<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a>&bull;<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>&bull;<a href="https://news.sophos.com/en-us/tag/101/">101</a>&bull;<a href="https://news.sophos.com/en-us/tag/bot/">bot</a>&bull;<a href="https://news.sophos.com/en-us/tag/emotet/">emotet</a>&bull;<a href="https://news.sophos.com/en-us/tag/maldocs/">maldocs</a>&bull;<a href="https://news.sophos.com/en-us/tag/malspam/">malspam</a>&bull;<a href="https://news.sophos.com/en-us/tag/malware/">malware</a>&bull;<a href="https://news.sophos.com/en-us/tag/payload/">payload</a>&bull;<a href="https://news.sophos.com/en-us/tag/pdf/">PDF</a>&bull;<a href="https://news.sophos.com/en-us/tag/sophos101/">Sophos101</a>&bull;<a href="https://news.sophos.com/en-us/tag/spam/">Spam</a>&bull;<a href="https://news.sophos.com/en-us/tag/word/">word</a>&bull;<a href="https://news.sophos.com/en-us/tag/xml/">XML</a>		</div>

		
		<div class="entry-meta">
			<span class="posted-on"><a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/" rel="bookmark">5 March 2019</a></span>		</div><!-- .entry-meta -->

		<div class="entry-social">
			
	<ul class="social-sharing" id="social-sharing">
		<li class="comments">
			<a href="#comments" title="Leave a Reply">
				1			</a>
		</li>
		<li class="twitter"><a class="js-share-modal" href="http://twitter.com/intent/tweet?text=Emotet%20101%2C%20stage%204%3A%20command%20and%20control%20https%3A%2F%2Fnews.sophos.com%2F%3Fp%3D56436" data-title="" title="Share on Twitter">Share on Twitter</a></li>
		<li class="facebook"><a class="js-share-modal" href="http://www.facebook.com/share.php?u=https://news.sophos.com/?p=56436&#038;title=Emotet%20101,%20stage%204:%20command%20and%20control" data-title="Emotet 101, stage 4: command and control" title="Share on Facebook">Share on Facebook</a></li>
		<li class="linkedin">
			<a
				href="http://www.linkedin.com/shareArticle?mini=true&url=https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/"
				data-title="Emotet 101, stage 4: command and control"
				title="Share on LinkedIn"
				onclick="window.open(this.href, '', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
			>
				Share on LinkedIn			</a>
		</li>
	</ul>

			</div><!-- .entry-social -->
	</header><!-- .entry-header -->

		<div class="entry-featured-image">
		<img width="640" height="334" src="https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?w=640" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" loading="lazy" srcset="https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg 800w, https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?resize=300,157 300w, https://news.sophos.com/wp-content/uploads/2016/09/remote-control.jpg?resize=768,401 768w" sizes="(max-width: 640px) 100vw, 640px" />	</div> <!-- .featured-image -->
	
	<div class="entry-meta">
		<span class="byline">By <span class="author vcard"><a href="https://news.sophos.com/en-us/author/andrew-brandt/" title="Posts by Andrew Brandt" class="author url fn" rel="author">Andrew Brandt</a></span></span>	</div><!-- .entry-meta -->

	<div class="entry-content">
		<p>The Emotet family could not do what it does without receiving a constant stream of instructions from its owners, or in the absence of the detailed level of feedback about its operating environment each bot sends home from an infected host machine. It also uses huge numbers of compromised websites that belong to other people or businesses to host copies of its main executable. These files get taken down quickly, so the network is in a constant state of flux.</p>
<figure id="attachment_56484" aria-describedby="caption-attachment-56484" style="width: 391px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/03/emotet-urls-big-list.png"><img loading="lazy" class=" wp-image-56484" src="https://news.sophos.com/wp-content/uploads/2019/03/emotet-urls-big-list.png" alt="" width="391" height="616" srcset="https://news.sophos.com/wp-content/uploads/2019/03/emotet-urls-big-list.png 472w, https://news.sophos.com/wp-content/uploads/2019/03/emotet-urls-big-list.png?resize=190,300 190w" sizes="(max-width: 391px) 100vw, 391px" /></a><figcaption id="caption-attachment-56484" class="wp-caption-text">A sampling of Emotet payload URLs</figcaption></figure>
<p>In many ways, the entire operation of Emotet hinges on the bot being able to send and receive regular installments of data and feedback, instructions and results, payloads and signals about task completion. If the bot cannot connect, it cannot do its job.</p>
<p>Each Emotet binary communicates with its command-and-control (C2) server in unusual ways, in some cases by using conventional network protocols in ways they were never intended. Emotet has a tendency to rely on the use of compromised, legitimate websites for hosting the malware itself, but it uses servers under the direct control of the botnet operators to receive messages from, and send instructions to, each node on the botnet.</p>
<p>Emotet typically uses the HTTP protocol to exfiltrate stolen data or receive instructions, but it does not strictly follow the conventions of that protocol, nor does it transmit that information in the clear.</p>
<figure id="attachment_56503" aria-describedby="caption-attachment-56503" style="width: 640px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/03/emotet-cookie-in-get-request.png"><img loading="lazy" class="size-full wp-image-56503" src="https://news.sophos.com/wp-content/uploads/2019/03/emotet-cookie-in-get-request.png" alt="" width="640" height="243" srcset="https://news.sophos.com/wp-content/uploads/2019/03/emotet-cookie-in-get-request.png 814w, https://news.sophos.com/wp-content/uploads/2019/03/emotet-cookie-in-get-request.png?resize=300,114 300w, https://news.sophos.com/wp-content/uploads/2019/03/emotet-cookie-in-get-request.png?resize=768,292 768w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption id="caption-attachment-56503" class="wp-caption-text">Emotet transmits data to the C2 server in the form of a &#8220;cookie&#8221; that isn&#8217;t really a cookie at all</figcaption></figure>
<p>The malware encrypts all the data it will transmit using a two-stage process, which it then transmits over&nbsp; unencrypted HTTP. It performs these communications with its C2 servers by performing an HTTP GET request that includes the passing of the data in the guise of a browser cookie. The header &nbsp;The server may respond with a simple acknowledgment or with a longer set of instructions or commands.</p>
<p>Here is an insider&#8217;s look into how Emotet communicates with its C2 servers.</p>
<h2>Emotet phone home</h2>
<p>Emotet periodically queries the list of running Windows processes and sends it to the C2 server. This routine serves as a good example of how the malware encrypts the data, transmits it, and interprets the results.</p>
<p>Emotet gathers some information about the infected system, and then serializes that data using<em> protobuf. </em></p>
<figure id="attachment_56506" aria-describedby="caption-attachment-56506" style="width: 640px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/03/data-to-be-exfil.png"><img loading="lazy" class="size-full wp-image-56506" src="https://news.sophos.com/wp-content/uploads/2019/03/data-to-be-exfil.png" alt="" width="640" height="494" srcset="https://news.sophos.com/wp-content/uploads/2019/03/data-to-be-exfil.png 765w, https://news.sophos.com/wp-content/uploads/2019/03/data-to-be-exfil.png?resize=300,231 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption id="caption-attachment-56506" class="wp-caption-text">The Emotet exfiltration data package, sending home a list of running programs</figcaption></figure>
<p>The malware uses certain constants (highlighted in red) to &#8220;sign&#8221; the formatted package of data it will exfiltrate (circled in blue). The data masked by a grey bar contains the computer name and the volume serial number of the infected system, hidden here to make it more difficult for the Emotet operators to identify our test system.</p>
<p>Here&#8217;s what those highlighted constants indicate:</p>
<p><em>after 0x08:</em>&nbsp;The byte after 0x08 is set to 0x00 when the initial API loading (crypt32.dll, urlmond.dll, user32.dll, userenv.dll, wininet.dll, wtsapi32.dll) is successful. After the first network communication, the bot increments this value, like an odometer, with every successive communication.</p>
<p><em>after 0x12</em>:&nbsp;The number that immediately follows the 0x12 (the first blue highlighted byte) is the length, in bytes, of a concatenation of the computer name and volume serial number information (derived from the GetVolumeInformationW&nbsp;function, lpVolumeSerialNumber) separated with an underscore, eg., computername_volumeserialnumber. The actual concatenation follows the length.</p>
<p><em>after 0x18:</em>&nbsp;The three bytes here is calculated from the native system information (RtlGetVersion, GetNativeSystemInfo)</p>
<p><em>after 0x20:</em> The session ID from the Process Environment Block (PEB)</p>
<p><em>after 0x2D</em>: CRC value (generated by RtlComputeCrc32) of the Emotet executable</p>
<p><em>after 0x32:</em>&nbsp;the comma-separated list of processes. (generated by Process32FirstW, Process32NextW) This section is terminated in the highlighted byte 0x3A at the end of the screenshot.</p>
<h2>Encrypting the message</h2>
<p>Once the above data structure is complete, Emotet serializes the data using <em>protobuf</em>, before compressing with zlib (and serializing again). Then it encrypts the message. The Emotet binary contains an RSA public key, which it uses with the CryptGenKey function call to generate an AES 128 symmetric encryption key pair.</p>
<p>Emotet encrypts the data block using this key, then encodes the encrypted data in base64, and finally transmits it by performing an HTTP GET request to the root directory of the C2 server. The malware actually transmits the data by attaching it as a “cookie” to the HTTP request headers (shown below), thereby making the “content” of the HTTP request empty.</p>
<p><a href="https://news.sophos.com/wp-content/uploads/2019/03/port-breakdown.png"><img loading="lazy" class="alignnone size-full wp-image-56507" src="https://news.sophos.com/wp-content/uploads/2019/03/port-breakdown.png" alt="" width="640" height="461" srcset="https://news.sophos.com/wp-content/uploads/2019/03/port-breakdown.png 758w, https://news.sophos.com/wp-content/uploads/2019/03/port-breakdown.png?resize=300,216 300w" sizes="(max-width: 640px) 100vw, 640px" /></a></p>
<p>The C2 servers can receive these communications on port 80, which is the default port for HTTP, but may also receive them on port 443, which is the default for HTTPS traffic, or on a number of other nonstandard ports, including but not limited to 7080, 8080, 8090, 50000, or several others. The table above shows the frequency breakdown of ports used by Emotet for command and control, taken from a sample set of about 3000 Emotet executables.</p>
<blockquote><p><strong>User tips for detecting Emotet network traffic</strong></p>
<p>Unencrypted HTTP traffic requests, with empty content and no exchange of SSL certificates, to ports normally used by HTTPS may indicate the presence of Emotet in your network.</p>
<p>HTTP traffic to other ports normally used by standard services, such as DNS (53) or SMTPS (465) is another red flag.</p>
<p>Empty (no content) HTTP GET requests with the unusually long cookie header, sent directly to internet IP addresses (as opposed to domain names), may be another.</p></blockquote>
<p>The response from the C2 server contains an encrypted blob of feedback, which the malware needs to decrypt and verify before it will act upon the instructions. The response to the transmission shown above contained an updated version of the Emotet malware application, itself, which the malware decrypted and then launched. The updated build of Emotet then supplants the prior build, and deletes the older version of the malware.</p>
<h4>Acknowledgments</h4>
<p>SophosLabs researchers Anand Ajjan, Krisztián Diriczi, Anton Kalinin, and Luca Nagy contributed to this section of the report.</p>
			</div><!-- .entry-content -->

</article><!-- #post-## -->

					<nav class="navigation post-navigation" role="navigation">
			<h2 class="screen-reader-text">Post navigation</h2>
			<div class="nav-links">
	   			<div class="nav-previous">
											<span class="nav-label">Prev</span>
						<a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-3-the-emotet-executable/" rel="prev">Emotet 101, stage 3: The Emotet executable</a>
						   			</div>
	   			<div class="nav-next">
											<span class="nav-label">Next</span>
						<a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-5-a-delivery-vehicle-for-more-malware/" rel="next">Emotet 101, stage 5: a delivery vehicle for more malware</a>
						   			</div>
		 	</div><!-- .nav-links -->
		</nav><!-- .navigation -->
		
			<div class="article-author-block article-co-authors-block">
	
					<h2 class="author-title">
				About the Author			</h2>
		
					<div class="author-block-container">
				<div class="author-profile">
					<img alt='' src='https://secure.gravatar.com/avatar/216532880604c8cf0600f4bc964cf01d?s=145&#038;d=blank&#038;r=g' class='avatar avatar-145 photo' height='145' width='145' />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/andrew-brandt/" title="Posts by Andrew Brandt" class="author url fn" rel="author">Andrew Brandt</a></h3>

					
					<div class="author-bio">
						<p>Andrew Brandt is a Principal Researcher for Sophos, specializing in security analytics and the forensic, retrospective analysis of malware infections and cyberattacks. In brief, he does whatever it takes to make life and business difficult for cybercriminals, spies, and other Internet miscreants. </p>
					</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
			</div>

			
<div id="comments" class="comments-area">

	
			<h2 class="comments-title">
			<span>1</span> Comment		</h2>

		<section class="comments-list">
		<article class="comment even thread-even depth-1  " id="comment-134666" itemprop="comment" itemscope itemtype="http://schema.org/Comment">
			<div class="comment-wrapper">
				<figure class="gravatar"><img alt='' src='https://secure.gravatar.com/avatar/79082c22d49ed5d836e3eae8da00dada?s=60&#038;d=blank&#038;r=g' srcset='https://secure.gravatar.com/avatar/79082c22d49ed5d836e3eae8da00dada?s=120&#038;d=blank&#038;r=g 2x' class='avatar avatar-60 photo' height='60' width='60' /></figure>
				<div class="comment-meta post-meta" role="complementary">
					<h2 class="comment-author">
													Anonymous											</h2>
					<time class="comment-meta-item" datetime="2019-06-03T03:41-04:00" itemprop="datePublished"><a href="#comment-134666" itemprop="url">03 June 2019 at 3:41 am</a></time>
														</div>
				<div class="comment-content post-content" itemprop="text">
					<p>Please share sample hashes</p>
					<a rel='nofollow' class='comment-reply-link' href='https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/?replytocom=134666#respond' data-commentid="134666" data-postid="56436" data-belowelement="comment-134666" data-respondelement="respond" data-replyto="Reply to " aria-label='Reply to '>Reply</a>				</div>
			</div>

	</article></section>
		
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/en-us/2019/03/05/emotet-101-stage-4-command-and-control/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://news.sophos.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name</label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" /></p>
<p class="comment-form-email"><label for="email">Email</label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes" /> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<input type="hidden" name="redirect_to" value="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-4-command-and-control/" id="redirect_to"><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='56436' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="2c815395e1" /></p><input type="hidden" id="ak_js" name="ak_js" value="163"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	
</div><!-- #comments -->

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area" role="complementary">
			
		<div id="second-article-wrapper" class="article-wrapper">
			<h3 class="widget-title">You might also enjoy...</h3>
			<article id="post-56438" class="second-featured post-56438 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs category-sophoslabs-uncut tag-647528206 tag-bot tag-emotet tag-maldocs tag-malspam tag-malware tag-payload tag-pdf tag-sophos101 tag-spam tag-word tag-xml region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2019/01/godaddy.jpg?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">05</span>
				<span class="month">Mar</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a> &bull; <a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-5-a-delivery-vehicle-for-more-malware/" rel="bookmark">Emotet 101, stage 5: a delivery vehicle for more malware</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-56434" class="second-featured post-56434 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs category-sophoslabs-uncut tag-647528206 tag-bot tag-emotet tag-maldocs tag-malspam tag-malware tag-payload tag-pdf tag-sophos101 tag-spam tag-word tag-xml region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2016/02/outil-de-suppression-des-virus1.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">05</span>
				<span class="month">Mar</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a> &bull; <a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-3-the-emotet-executable/" rel="bookmark">Emotet 101, stage 3: The Emotet executable</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-56432" class="second-featured post-56432 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs category-sophoslabs-uncut tag-647528206 tag-bot tag-emotet tag-maldocs tag-malspam tag-malware tag-payload tag-pdf tag-sophos101 tag-spam tag-word tag-xml region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2019/03/maldoctemplate3.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">05</span>
				<span class="month">Mar</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a> &bull; <a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-2-the-malicious-attachment-and-killchain/" rel="bookmark">Emotet 101, stage 2: The malicious attachment and killchain</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-56430" class="second-featured post-56430 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs category-sophoslabs-uncut tag-647528206 tag-bot tag-emotet tag-maldocs tag-malspam tag-malware tag-payload tag-pdf tag-sophos101 tag-spam tag-word tag-xml region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2013/10/spam_021.jpg?w=500');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">05</span>
				<span class="month">Mar</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a> &bull; <a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/03/05/emotet-101-stage-1-the-spam-lure/" rel="bookmark">Emotet 101, stage 1: The spam lure</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
		</div>

	</div> <!-- #secondary -->


		</div> <!-- .container -->
	</div> <!-- #content -->
	<footer>
		<section class="cta">
			<p>Start a Sophos demo in less than a minute. See exactly how our solutions work in a full environment without a commitment.</p>
			<a href="https://secure2.sophos.com/en-us/products/demos.aspx?cmp=70130000001xKqzAAE">Learn More</a>
		</section>
		<section class="connected">
			<div class="social">
				<h3>Stay Connected</h3>
				<ul>
					<li><a href="https://www.facebook.com/securitybysophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/facebook-icon.svg?la=en&amp;hash=1CA0A5A0E9C9999E7E079A5D32C86E9BF9C7AD1E" alt="Facebook"></a>
					</li>
					<li><a href="https://www.instagram.com/sophossecurity/" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/instagram-icon.svg?la=en&amp;hash=2B50C2B67C3023D9E7D4E1C3A16401EAD8F10F76" alt="Instagram"></a>
					</li>
					<li><a href="https://www.linkedin.com/company/sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/linkedin-icon.svg?la=en&amp;hash=B6D5378C1E1A16F239A4C862EAE3499B8EC1F3F9" alt="LinkedIn"></a></li>
					<li><a href="https://www.sophos.com/en-us/company/rss-feeds.aspx"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/rss-icon.svg?la=en&amp;hash=76C4DAFD331DC675814191A66794A778D8C6DCF7" alt="RSS"></a></li>
					<li><a href="https://twitter.com/Sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/twitter-icon.svg?la=en&amp;hash=9A90D9F99ABE6454741BBAAF9C3FB6966624C92D" alt="Twitter"></a></li>
					<li><a href="https://www.youtube.com/user/SophosProducts" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/youtube-icon.svg?la=en&amp;hash=CCCF647AFA78C8DB74D654DB9FEFBF0AC54F42D3" alt="YouTube"></a></li>
				</ul>
			</div>
			<ul class="links">
				<li><a href="https://www.sophos.com/en-us/company/careers.aspx">Careers </a></li>
				<li><a href="https://www.sophos.com/en-us/partners/partner-locator.aspx">Find a Partner</a></li>
				<li><a href="https://secure2.sophos.com/en-us/support.aspx">Support</a></li>
				<li><a href="https://www.sophos.com/en-us/threat-center/technical-papers.aspx">Technical Papers</a></li>
				<li><a href="https://www.sophos.com/en-us/security-news-trends/whitepapers.aspx">Whitepapers</a></li>
			</ul>
		</section>
		<section class="legal">
			<div class="copyright">&copy; 1997 - 2021 Sophos Ltd. All rights reserved</div>
			<ul>
				<li><a href="https://www.sophos.com/en-us/legal.aspx">Legal</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/sophos-group-privacy-policy.aspx">Privacy</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/cookie-information.aspx">Cookie Information</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/modern-slavery-act-transparency-statement.aspx">Modern Slavery Statement</a></li>
			</ul>
		</section>
		<div class="vip" style="background: #002939">
			Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=news.sophos.com" rel="generator nofollow" class="powered-by-wpcom">WordPress VIP</a>		</div>
	</footer>
	<script id='sophos-js-core-js-extra'>
var PG8Data = {"startPage":"1","maxPages":"1","nextLink":""};
</script>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJyVkMEOwiAMhl9IYCxuxoPxUQyyurFRIJQ5fXsxyxIPHkbSS/9+X5tULIFp7xK4JNIACCTIh8GTg4VYXcmTGClXhvxkgD1rXnOZA74GfKSD2LVD+1hAwytFRfv5NeJzMrbc0gqDMr0rFoOKyUEs9npVrHyzTTJO27kDWt+KmBewCMG+ORr3D8ot4B263/l2GWcW7NwbR0JNhhCSuGVXPHzEzF7xIlvZHNuqkefxA21LyhQ='></script>
<script src='https://stats.wp.com/e-202112.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.5.2',blog:'166161023',post:'56436',tz:'-4',srv:'news.sophos.com'} ]);
	_stq.push([ 'clickTrackerInit', '166161023', '56436' ]);
</script>
</body>
</html>
