<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://news.sophos.com/xmlrpc.php">
<link rel="alternate" hreflang="en-us" href="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/" /><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl+ '&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x';f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5L6H3LN');</script>
<!-- End Google Tag Manager -->
<title>A new Equation Editor exploit goes commercial, as maldoc attacks using it spike &#8211; Sophos News</title>
<meta name='robots' content='max-image-preview:large' />
<!-- Jetpack Site Verification Tags -->
<meta name="google-site-verification" content="8r1qg681OjOolfxmHEY1IYupmTBdyKXc-OPfpgeQHFk" />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel='dns-prefetch' href='//v0.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Feed" href="https://news.sophos.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Comments Feed" href="https://news.sophos.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; A new Equation Editor exploit goes commercial, as maldoc attacks using it spike Comments Feed" href="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/news.sophos.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0' href='https://news.sophos.com/_static/??/wp-includes/css/dist/block-library/style.min.css,/wp-content/themes/sophosnews-2017/style.css,/wp-content/mu-plugins/jetpack-9.5/css/jetpack.css?m=1615460519' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify{text-align:justify;}
</style>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJzTLy/QzcxLzilNSS3WzwKiwtLUokoopZebmaeXVayjj0+Rbm5melFiSSpUsX2uraGZoamxkaGpmWEWAK8/Ihc='></script>
<link rel="https://api.w.org/" href="https://news.sophos.com/wp-json/" /><link rel="alternate" type="application/json" href="https://news.sophos.com/wp-json/wp/v2/posts/58892" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://news.sophos.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://news.sophos.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7" />
<link rel="canonical" href="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/" />
<link rel='shortlink' href='https://news.sophos.com/?p=58892' />
<link rel="alternate" type="application/json+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F07%2F18%2Fa-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F07%2F18%2Fa-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike%2F&#038;format=xml" />
<style type='text/css'>img#wpstats{display:none}</style><link rel="amphtml" href="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/amp/">
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="A new Equation Editor exploit goes commercial, as maldoc attacks using it spike" />
<meta property="og:url" content="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/" />
<meta property="og:description" content="Weaponized RTF documents adopt CVE-2018-0798, another Equation Editor vulnerability" />
<meta property="article:published_time" content="2019-07-18T16:00:18+00:00" />
<meta property="article:modified_time" content="2019-07-31T18:32:36+00:00" />
<meta property="og:site_name" content="Sophos News" />
<meta property="og:image" content="https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?w=640" />
<meta property="og:image:secure_url" content="https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?w=640" />
<meta property="og:image:width" content="640" />
<meta property="og:image:height" content="334" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="A new Equation Editor exploit goes commercial, as maldoc attacks using it spike" />
<meta name="twitter:image" content="https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?w=640" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="fb:admins" content="28552295016" />

<!-- End Jetpack Open Graph Tags -->
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=32" sizes="32x32" />
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=192" sizes="192x192" />
<link rel="apple-touch-icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=180" />
<meta name="msapplication-TileImage" content="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=270" />
</head>

<body class="post-template-default single single-post postid-58892 single-format-standard group-blog">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5L6H3LN&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<header id="masthead" class="site-header">

		<div class="header-container">

			<div class="site-branding">
				<h1 class="site-title">
										<a class="site-logo" href="https://www.sophos.com/en-us.aspx" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- site-branding -->

			<nav class="primary-header-navigation" role="navigation">
				<ul id="menu-en-us-primary" class="menu"><li id="menu-item-33368" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33368"><a href="https://www.sophos.com/en-us/products.aspx">Products<div class="menu-item-description"></div></a></li>
<li id="menu-item-33382" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33382"><a href="https://www.sophos.com/en-us/solutions.aspx">Solutions<div class="menu-item-description"></div></a></li>
<li id="menu-item-33390" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33390"><a href="//www.sophos.com/en-us/partners.aspx">Partners<div class="menu-item-description"></div></a></li>
<li id="menu-item-33391" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33391"><a href="//www.sophos.com/en-us/support.aspx">Support<div class="menu-item-description"></div></a></li>
<li id="menu-item-33392" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33392"><a href="//www.sophos.com/en-us/company.aspx">Company<div class="menu-item-description"></div></a></li>
<li id="menu-item-33393" class="is-icon icon-download menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-33393"><a href="#">Downloads<div class="menu-item-description"></div></a>
<ul class="sub-menu">
	<li id="menu-item-33394" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33394"><a href="//www.sophos.com/en-us/products/free-trials.aspx">Free Trials<div class="menu-item-description">All product trials in one place.</div></a></li>
	<li id="menu-item-33395" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33395"><a href="//www.sophos.com/en-us/products/free-tools.aspx">Free Tools<div class="menu-item-description">Try our tools for use at home.</div></a></li>
	<li id="menu-item-33396" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33396"><a href="//www.sophos.com/en-us/products/request-a-quote.aspx">Get Pricing<div class="menu-item-description">The right price every time.</div></a></li>
</ul>
</li>
<li id="menu-item-33397" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33397"><a href="//www.sophos.com/en-us/search-results.aspx">Search<div class="menu-item-description"></div></a></li>
<li id="menu-item-33398" class="is-icon icon-account menu-item menu-item-type-custom menu-item-object-custom menu-item-33398"><a href="//www.sophos.com/en-us/login.aspx">Sign In<div class="menu-item-description"></div></a></li>
</ul>			</nav>

		</div>
	</header> <!-- site-header -->

	<div class="secondary-header">
		<div class="secondary-header-container container">
			<nav class="secondary-header-navigation" role="navigation">
				<ul id="menu-en-us-secondary" class="menu"><li id="menu-item-33399" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33399"><a href="//www.sophos.com/en-us/company.aspx">Overview</a></li>
<li id="menu-item-33401" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33401"><a href="//www.sophos.com/en-us/company/press.aspx">Press</a></li>
<li id="menu-item-33402" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33402"><a href="//secure2.sophos.com/en-us/company/events.aspx">Events</a></li>
<li id="menu-item-33403" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33403"><a href="//www.sophos.com/en-us/company/community.aspx">Community</a></li>
<li id="menu-item-33404" class="menu-item-blog menu-item menu-item-type-custom menu-item-object-custom menu-item-33404"><a href="/">Blog</a></li>
<li id="menu-item-33405" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33405"><a href="//secure2.sophos.com/en-us/company/careers.aspx">Careers</a></li>
<li id="menu-item-33406" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33406"><a href="//www.sophos.com/en-us/company/contact.aspx">Contact</a></li>
</ul>			</nav>
		</div>
	</div> <!-- secondary-header -->

	<div class="news-header">
		<div class="news-header-container container">

			<div class="news-branding">
				<h1 class="news-title">
					<a class="news-logo" href="https://news.sophos.com/en-us/" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- news-branding -->

			<div class="mobile-menu-toggle">
				<a href="#newsmenu">
											Menu									</a>
			</div>

			<div class="mobile-search-toggle">
				<a class="icon icon-search-secondary" href="#search">
					Search				</a>
			</div>

			<nav class="news-header-navigation" role="navigation">
				<ul id="menu-en-us-tertiary" class="menu"><li id="menu-item-33407" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33407"><a href="#search">Search</a></li>
</ul>			</nav>

			<div class="site-search-block" style="display: none;">
				<form role="search" class="search-form" method="get" action="https://news.sophos.com/en-us/">
					<fieldset>
						<div class="field">
							<input type="text" value="" name="s" class="search-field" placeholder="Search">
						</div>
						<div class="submit">
							<button type="submit" class="search-submit icon icon-search-secondary">
								Go							</button>
						</div>
					</fieldset>
				</form>
				<a class="icon" href="#search-close">
					Close				</a>
			</div>
		</div>
	</div> <!-- news-header -->

	<div id="content" class="site-content">
		<div class="content-container">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-58892" class="post-58892 post type-post status-publish format-standard has-post-thumbnail hentry category-sophoslabs-uncut tag-doc tag-cve-2018-0798 tag-equation-editor tag-exploit tag-maldoc tag-microsoft-office tag-microsoft-word tag-pdf tag-rtf region-en-us">

	<header class="entry-header">

		<h1 class="entry-title">A new Equation Editor exploit goes commercial, as maldoc attacks using it spike</h1>
		<div class="entry-categories">
			<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>&bull;<a href="https://news.sophos.com/en-us/tag/doc/">.doc</a>&bull;<a href="https://news.sophos.com/en-us/tag/cve-2018-0798/">CVE-2018-0798</a>&bull;<a href="https://news.sophos.com/en-us/tag/equation-editor/">Equation Editor</a>&bull;<a href="https://news.sophos.com/en-us/tag/exploit/">Exploit</a>&bull;<a href="https://news.sophos.com/en-us/tag/maldoc/">maldoc</a>&bull;<a href="https://news.sophos.com/en-us/tag/microsoft-office/">Microsoft Office</a>&bull;<a href="https://news.sophos.com/en-us/tag/microsoft-word/">Microsoft Word</a>&bull;<a href="https://news.sophos.com/en-us/tag/pdf/">PDF</a>&bull;<a href="https://news.sophos.com/en-us/tag/rtf/">RTF</a>		</div>

					<div class="entry-excerpt">
				<p>Weaponized RTF documents adopt CVE-2018-0798, another Equation Editor vulnerability</p>
			</div>
		
		<div class="entry-meta">
			<span class="posted-on"><a href="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/" rel="bookmark">18 July 2019</a></span>		</div><!-- .entry-meta -->

		<div class="entry-social">
			
	<ul class="social-sharing" id="social-sharing">
		<li class="comments">
			<a href="#comments" title="Leave a Reply">
				0			</a>
		</li>
		<li class="twitter"><a class="js-share-modal" href="http://twitter.com/intent/tweet?text=A%20new%20Equation%20Editor%20exploit%20goes%20commercial%2C%20as%20maldoc%20attacks%20using%20it%20spike%20https%3A%2F%2Fnews.sophos.com%2F%3Fp%3D58892" data-title="" title="Share on Twitter">Share on Twitter</a></li>
		<li class="facebook"><a class="js-share-modal" href="http://www.facebook.com/share.php?u=https://news.sophos.com/?p=58892&#038;title=A%20new%20Equation%20Editor%20exploit%20goes%20commercial,%20as%20maldoc%20attacks%20using%20it%20spike" data-title="A new Equation Editor exploit goes commercial, as maldoc attacks using it spike" title="Share on Facebook">Share on Facebook</a></li>
		<li class="linkedin">
			<a
				href="http://www.linkedin.com/shareArticle?mini=true&url=https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/"
				data-title="A new Equation Editor exploit goes commercial, as maldoc attacks using it spike"
				title="Share on LinkedIn"
				onclick="window.open(this.href, '', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
			>
				Share on LinkedIn			</a>
		</li>
	</ul>

			</div><!-- .entry-social -->
	</header><!-- .entry-header -->

		<div class="entry-featured-image">
		<img width="640" height="334" src="https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?w=640" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" loading="lazy" srcset="https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg 1206w, https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?resize=300,157 300w, https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?resize=768,401 768w, https://news.sophos.com/wp-content/uploads/2017/04/fichiers-rtf.jpg?resize=1024,535 1024w" sizes="(max-width: 640px) 100vw, 640px" />	</div> <!-- .featured-image -->
	
	<div class="entry-meta">
		<span class="byline">By <span class="author vcard"><a href="https://news.sophos.com/en-us/author/gabor-szappanos/" title="Posts by Gabor Szappanos" class="author url fn" rel="author">Gabor Szappanos</a></span></span>	</div><!-- .entry-meta -->

	<div class="entry-content">
		<p>There is a distinct point of maturation in the life cycle of an Office exploit: the point where it becomes generally available for the crimeware groups. Before that point the exploit has affected only a few selected victims of targeted attacks. From that point on it becomes widespread and threatens the general user population.</p>
<p>CVE-2018-0798, yet another Equation Editor vulnerability, reached this point of maturation around the end of June 2019.</p>
<h2>How the exploit works</h2>
<p>This exploit was used in targeted attacks we observed over the past several months, staying mostly under the radar. A <a href="https://www.anomali.com/blog/multiple-chinese-threat-groups-exploiting-cve-2018-0798-equation-editor-vulnerability-since-late-2018" target="_blank" rel="noopener">detailed description of the vulnerability</a> and its usage in targeted attacks, published earlier this month, explains the fundamentals.</p>
<p>At some point, someone appears to have integrated the exploit implementation that was used in the targeted attacks into a malicious Office document <em>builder</em> tool, with only minor changes. This sets the stage for much broader adoption of the attack technique.</p>
<p>The similarities are unmistakable: For example, the exploit trigger is exactly the same, and the shellcode (responsible for decrypting and executing the payload) is nearly identical to the shellcode used in the targeted attacks. Although CVE-2018-0798 is a relatively simple buffer overflow vulnerability, there are a few factors that make it difficult to tweak the exploit trigger itself, hence the virtually identical implementation.</p>
<p>The attack uses Equation Editor to put the malicious buffer through several transformations, and during processing the memory layout will be rather different from the file layout, which complicates analysis (and tweaking). Moreover, the attacker only controls the lower word of the return address on the stack. These complications make it less likely that the crimeware implementations will significantly change the exploit trigger.</p>
<p>The weaponized RTF files that are part of this campaign have a curious characteristic: some junk content near the header &#8212; content that fits a pattern normally seen in PDF files. It seems like the presence of this PDF header data content might be an attempt to confuse document filetype parsers in AV scanners.</p>
<figure id="attachment_58895" aria-describedby="caption-attachment-58895" style="width: 639px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58895 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image1.png" alt="" width="639" height="218" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image1.png 639w, https://news.sophos.com/wp-content/uploads/2019/07/t-image1.png?resize=300,102 300w" sizes="(max-width: 639px) 100vw, 639px" /><figcaption id="caption-attachment-58895" class="wp-caption-text">Malicous RTF file with PDF fragments</figcaption></figure>
<p>An interesting feature in the shellcode is that the Windows API functions are not called from the shellcode itself. Instead, the clearerr function from the msvcrt.dll is patched with a short code that invokes the desired API function.</p>
<p>The original code of clearerr looks like this:</p>
<figure id="attachment_58896" aria-describedby="caption-attachment-58896" style="width: 404px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58896 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image2.png" alt="" width="404" height="279" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image2.png 404w, https://news.sophos.com/wp-content/uploads/2019/07/t-image2.png?resize=300,207 300w" sizes="(max-width: 404px) 100vw, 404px" /><figcaption id="caption-attachment-58896" class="wp-caption-text">clearerr before the patch</figcaption></figure>
<p>This is replaced with a code that first checks if the API function was already hooked by a security software (the presence of 0xE9 and 0xEB indicate that the original entry of the API handler was patched, redirected to a monitoring function). If patching is detected, the shellcode will skip the first 5 bytes, the redirector, and jumps directly into the body of the function, done by the JMP EAX instruction.</p>
<figure id="attachment_58897" aria-describedby="caption-attachment-58897" style="width: 401px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58897 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image3.png" alt="" width="401" height="332" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image3.png 401w, https://news.sophos.com/wp-content/uploads/2019/07/t-image3.png?resize=300,248 300w" sizes="(max-width: 401px) 100vw, 401px" /><figcaption id="caption-attachment-58897" class="wp-caption-text">clearerr after the patch</figcaption></figure>
<p>The result of this trick is that all of the Windows API calls that the shellcode uses will appear to be initiated from msvcrt.dll, which makes it a much less suspicious activity for behavior monitoring software.</p>
<p>The only significant change in the crimeware cases is the extracted payload. The APT samples were self-contained, the final payload was stored in the RTF file. On the other hand, in the crimeware samples the payload is a very simple downloader trojan, that fetches the final payload from a hardcoded URL.</p>
<p>In both cases the RTF file contains an embedded payload. There were a few different implementations in the APT cases. In the most simple of them, the payload is embedded into the RTF file without any encryption, as illustrated in the following picture where the MZ marker of the embedded executable is clearly visible in the RTF content.</p>
<figure id="attachment_58899" aria-describedby="caption-attachment-58899" style="width: 640px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58899 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image4.png" alt="" width="640" height="184" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image4.png 785w, https://news.sophos.com/wp-content/uploads/2019/07/t-image4.png?resize=300,86 300w, https://news.sophos.com/wp-content/uploads/2019/07/t-image4.png?resize=768,221 768w" sizes="(max-width: 640px) 100vw, 640px" /><figcaption id="caption-attachment-58899" class="wp-caption-text">Embedded executable payload&#8217;s characteristic MZ header is clearly visible in RTF</figcaption></figure>
<p>In the typical cases a one-byte XOR algorithm is used where the encryption key changes for each data byte. This makes it more difficult to recognize the embedded content which at first looks like some random data.</p>
<figure id="attachment_58900" aria-describedby="caption-attachment-58900" style="width: 640px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58900 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image5.png" alt="" width="640" height="158" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image5.png 936w, https://news.sophos.com/wp-content/uploads/2019/07/t-image5.png?resize=300,74 300w, https://news.sophos.com/wp-content/uploads/2019/07/t-image5.png?resize=768,190 768w" sizes="(max-width: 640px) 100vw, 640px" /><figcaption id="caption-attachment-58900" class="wp-caption-text">Embedded encrypted content in RTF</figcaption></figure>
<p>The crimeware builder chose a bogus (yet more convenient) implementation of the latter, more details in the next section.</p>
<h2>The downloader component</h2>
<p>The CVE-2018-0798 exploit triggers the shellcode that decrypts the payload (one-byte XOR algorithm, the key is <strong>0xFC</strong>) and executes it. More precisely, the encryption algorithm is supposed to be a running key byte-wise XOR algorithm, but the APT sample that was used as a template for the crimeware builder used a bogus implementation of this algorithm.</p>
<p>Instead of key changing for each file position, the key changes only for the first 4 bytes, for the rest of the file it will be 0xFC. The following picture shows large blocks of 0xFC bytes in the embedded payload, which clearly reveals the encryption key.</p>
<figure id="attachment_58902" aria-describedby="caption-attachment-58902" style="width: 639px" class="wp-caption alignnone"><img loading="lazy" class="wp-image-58902 size-full" src="https://news.sophos.com/wp-content/uploads/2019/07/t-image6.png" alt="" width="639" height="275" srcset="https://news.sophos.com/wp-content/uploads/2019/07/t-image6.png 639w, https://news.sophos.com/wp-content/uploads/2019/07/t-image6.png?resize=300,129 300w" sizes="(max-width: 639px) 100vw, 639px" /><figcaption id="caption-attachment-58902" class="wp-caption-text">The encrypted downloader with the URL in it</figcaption></figure>
<p>It should not be a coincidence that the crimeware builder chose this implementation. It is much easier to patch only the hardcoded encoded URL in the RTF file with fixed key, than to recode the embedded EXE and rebuild the RTF file for every sample.</p>
<p>The program downloads the hardcoded URL, saves it to the %APPDATA% folder, then executes it.</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58903" src="https://news.sophos.com/wp-content/uploads/2019/07/image7-1.png" alt="" width="520" height="287" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image7-1.png 520w, https://news.sophos.com/wp-content/uploads/2019/07/image7-1.png?resize=300,166 300w" sizes="(max-width: 520px) 100vw, 520px" /></p>
<p>The critical Windows API function names are slightly obfuscated, the first character of the name is changed.</p>
<p>The same downloader executable is present in all recent crimeware sample; Only the hardcoded download URL changes. This is a good choice for the easy development of the builder.</p>
<h2>What the malicious spam messages look like</h2>
<p>We&#8217;ve observed several email distribution campaigns using these weaponized Office documents. The identified payload of the infection campaigns were all the &#8220;usual suspect&#8221; crimeware family payloads: Fareit, Lokibot, Formbook, or AzoruLT. The most widely distributed payload is Fareit.</p>
<p>We have observed that the spam campaigns use a wide selection of social engineering tropes.</p>
<p>Cargo arrival notice themed messages:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58904" src="https://news.sophos.com/wp-content/uploads/2019/07/image8-1.png" alt="" width="640" height="309" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image8-1.png 677w, https://news.sophos.com/wp-content/uploads/2019/07/image8-1.png?resize=300,145 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>Fedex tracking was particularly popular:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58905" src="https://news.sophos.com/wp-content/uploads/2019/07/image9-1.png" alt="" width="640" height="373" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image9-1.png 718w, https://news.sophos.com/wp-content/uploads/2019/07/image9-1.png?resize=300,175 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>And of course the order confirmation spam:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58907" src="https://news.sophos.com/wp-content/uploads/2019/07/image10-1.png" alt="" width="640" height="385" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image10-1.png 710w, https://news.sophos.com/wp-content/uploads/2019/07/image10-1.png?resize=300,180 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>Lokibot was distributed using a &#8220;payment advice&#8221;-themed message:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58908" src="https://news.sophos.com/wp-content/uploads/2019/07/image11-1.png" alt="" width="640" height="386" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image11-1.png 717w, https://news.sophos.com/wp-content/uploads/2019/07/image11-1.png?resize=300,181 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>And in messages that purported to contain a product inquiry:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58909" src="https://news.sophos.com/wp-content/uploads/2019/07/image12-1.png" alt="" width="640" height="342" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image12-1.png 728w, https://news.sophos.com/wp-content/uploads/2019/07/image12-1.png?resize=300,160 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>The &#8220;give us your best price quote&#8221; email was used to distribute Formbook:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-58910" src="https://news.sophos.com/wp-content/uploads/2019/07/image13-1.png" alt="" width="640" height="368" srcset="https://news.sophos.com/wp-content/uploads/2019/07/image13-1.png 728w, https://news.sophos.com/wp-content/uploads/2019/07/image13-1.png?resize=300,173 300w" sizes="(max-width: 640px) 100vw, 640px" />The vulnerability affects all Equation Editor versions (even the ones that were patched for CVE-2017-11882).</p>
<p>The patch for the CVE-2018-0802 exploit permanently &#8220;fixes&#8221; the vulnerability by eliminating the Equation Editor altogether.</p>
<p>Since the end of June, we&#8217;ve started to observe an increase in the use of this vulnerability in phishing campaigns. Since that time, we&#8217;ve observed about 200 new malicious RTF documents using this exploit. These documents are very similar to each other. This, and the large number of samples indicated that a builder tool that generates the weaponized .doc files probably is in circulation. We can expect the use of this exploit to rise, at least for the near future.</p>
<p>We have the following detections that provide generic coverage for the known samples:</p>
<p>Exp/20180798-A<br />
Troj/RtfExp-FB<br />
Troj/RtfExp-EY</p>
<p>Indicators of Compromise</p>
<p>File hashes for the samples analyzed in this report are on the <a href="https://github.com/sophoslabs/IoCs/blob/master/CVE-2018-0798%20RTFs" target="_blank" rel="noopener">SophosLabs Github</a>.</p>
			</div><!-- .entry-content -->

</article><!-- #post-## -->

					<nav class="navigation post-navigation" role="navigation">
			<h2 class="screen-reader-text">Post navigation</h2>
			<div class="nav-links">
	   			<div class="nav-previous">
											<span class="nav-label">Prev</span>
						<a href="https://news.sophos.com/en-us/2019/07/12/5-ways-to-avoid-a-gdpr-fine/" rel="prev">5 ways to avoid a GDPR fine</a>
						   			</div>
	   			<div class="nav-next">
											<span class="nav-label">Next</span>
						<a href="https://news.sophos.com/en-us/2019/07/22/3-reasons-attackers-love-your-servers/" rel="next">3 reasons attackers love your servers</a>
						   			</div>
		 	</div><!-- .nav-links -->
		</nav><!-- .navigation -->
		
			<div class="article-author-block article-co-authors-block">
	
					<h2 class="author-title">
				About the Author			</h2>
		
					<div class="author-block-container">
				<div class="author-profile">
					<img alt='' src='https://secure.gravatar.com/avatar/040a829707237b26ea3984dfc4621217?s=145&#038;d=blank&#038;r=g' class='avatar avatar-145 photo' height='145' width='145' />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/gabor-szappanos/" title="Posts by Gabor Szappanos" class="author url fn" rel="author">Gabor Szappanos</a></h3>

					
					<div class="author-bio">
						<p>Gabor graduated from the Eotvos Lorand University of Budapest with a degree in physics. His first job was in the Computer and Automation Research Institute, developing diagnostic software and hardware for nuclear power plants. He started antivirus work in 1995, and began developing freeware antivirus solutions in his spare time. Gabor joined VirusBuster in 2001 where he was responsible for taking care of macro virus and script malware and became head of the virus lab in 2002. In 2008 he became a member of the Board of Directors in AMTSO (Anti Malware Testing Standards Organization) and, in 2012, joined Sophos as a Principal Malware Researcher.</p>
					</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
			</div>

			
<div id="comments" class="comments-area">

	
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://news.sophos.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name</label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" /></p>
<p class="comment-form-email"><label for="email">Email</label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes" /> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<input type="hidden" name="redirect_to" value="https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/" id="redirect_to"><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='58892' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="60bf864762" /></p><input type="hidden" id="ak_js" name="ak_js" value="138"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	
</div><!-- #comments -->

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area" role="complementary">
			
		<div id="second-article-wrapper" class="article-wrapper">
			<h3 class="widget-title">You might also enjoy...</h3>
			<article id="post-72266" class="second-featured post-72266 post type-post status-publish format-standard has-post-thumbnail hentry category-mtr category-security-operations tag-mtr tag-ransomware tag-sidebar tag-sophos-managed-threat-response-mtr tag-sophos-mtr region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/08/sophos-news-ft-img-mtr_v3.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">03</span>
				<span class="month">Feb</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/mtr/">MTR</a> &bull; <a href="https://news.sophos.com/en-us/category/security-operations/">Security Operations</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/02/03/mtr-casebook-uncovering-a-backdoor-implant-in-a-solarwinds-orion-server/" rel="bookmark">MTR casebook: Uncovering a backdoor implant in a SolarWinds Orion server</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-72321" class="second-featured post-72321 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-sidebar tag-zero-trust tag-ztna region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2021/02/ZTNA-header.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">02</span>
				<span class="month">Feb</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/02/02/sophos-zero-trust-network-access-ztna-is-coming-soon/" rel="bookmark">Sophos zero trust network access (ZTNA) is coming soon</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-72021" class="second-featured post-72021 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-mtr tag-rapid-response tag-sidebar tag-sophos-mtr tag-sophos-rapid-response region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/08/sophos-news-ft-img-mtr_v1.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">19</span>
				<span class="month">Jan</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/01/19/451-research-impact-report-on-sophos-rapid-response-service/" rel="bookmark">451 Research Impact Report on Sophos Rapid Response service</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-71626" class="second-featured post-71626 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-edr tag-intercept-x-advanced-for-server-with-edr tag-intercept-x-with-edr tag-live-discover tag-sidebar region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/12/APIs-hero.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">17</span>
				<span class="month">Dec</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2020/12/17/sophos-edr-live-discover-apis-are-now-generally-available/" rel="bookmark">Sophos EDR Live Discover APIs are now generally available</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
		</div>

	</div> <!-- #secondary -->


		</div> <!-- .container -->
	</div> <!-- #content -->
	<footer>
		<section class="cta">
			<p>Start a Sophos demo in less than a minute. See exactly how our solutions work in a full environment without a commitment.</p>
			<a href="https://secure2.sophos.com/en-us/products/demos.aspx?cmp=70130000001xKqzAAE">Learn More</a>
		</section>
		<section class="connected">
			<div class="social">
				<h3>Stay Connected</h3>
				<ul>
					<li><a href="https://www.facebook.com/securitybysophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/facebook-icon.svg?la=en&amp;hash=1CA0A5A0E9C9999E7E079A5D32C86E9BF9C7AD1E" alt="Facebook"></a>
					</li>
					<li><a href="https://www.instagram.com/sophossecurity/" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/instagram-icon.svg?la=en&amp;hash=2B50C2B67C3023D9E7D4E1C3A16401EAD8F10F76" alt="Instagram"></a>
					</li>
					<li><a href="https://www.linkedin.com/company/sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/linkedin-icon.svg?la=en&amp;hash=B6D5378C1E1A16F239A4C862EAE3499B8EC1F3F9" alt="LinkedIn"></a></li>
					<li><a href="https://www.sophos.com/en-us/company/rss-feeds.aspx"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/rss-icon.svg?la=en&amp;hash=76C4DAFD331DC675814191A66794A778D8C6DCF7" alt="RSS"></a></li>
					<li><a href="https://twitter.com/Sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/twitter-icon.svg?la=en&amp;hash=9A90D9F99ABE6454741BBAAF9C3FB6966624C92D" alt="Twitter"></a></li>
					<li><a href="https://www.youtube.com/user/SophosProducts" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/youtube-icon.svg?la=en&amp;hash=CCCF647AFA78C8DB74D654DB9FEFBF0AC54F42D3" alt="YouTube"></a></li>
				</ul>
			</div>
			<ul class="links">
				<li><a href="https://www.sophos.com/en-us/company/careers.aspx">Careers </a></li>
				<li><a href="https://www.sophos.com/en-us/partners/partner-locator.aspx">Find a Partner</a></li>
				<li><a href="https://secure2.sophos.com/en-us/support.aspx">Support</a></li>
				<li><a href="https://www.sophos.com/en-us/threat-center/technical-papers.aspx">Technical Papers</a></li>
				<li><a href="https://www.sophos.com/en-us/security-news-trends/whitepapers.aspx">Whitepapers</a></li>
			</ul>
		</section>
		<section class="legal">
			<div class="copyright">&copy; 1997 - 2021 Sophos Ltd. All rights reserved</div>
			<ul>
				<li><a href="https://www.sophos.com/en-us/legal.aspx">Legal</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/sophos-group-privacy-policy.aspx">Privacy</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/cookie-information.aspx">Cookie Information</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/modern-slavery-act-transparency-statement.aspx">Modern Slavery Statement</a></li>
			</ul>
		</section>
		<div class="vip" style="background: #002939">
			Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=news.sophos.com" rel="generator nofollow" class="powered-by-wpcom">WordPress VIP</a>		</div>
	</footer>
	<script id='sophos-js-core-js-extra'>
var PG8Data = {"startPage":"1","maxPages":"1","nextLink":""};
</script>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJyVkMEOwiAMhl9IYCxuxoPxUQyyurFRIJQ5fXsxyxIPHkbSS/9+X5tULIFp7xK4JNIACCTIh8GTg4VYXcmTGClXhvxkgD1rXnOZA74GfKSD2LVD+1hAwytFRfv5NeJzMrbc0gqDMr0rFoOKyUEs9npVrHyzTTJO27kDWt+KmBewCMG+ORr3D8ot4B263/l2GWcW7NwbR0JNhhCSuGVXPHzEzF7xIlvZHNuqkefxA21LyhQ='></script>
<script src='https://stats.wp.com/e-202112.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.5.2',blog:'166161023',post:'58892',tz:'-4',srv:'news.sophos.com'} ]);
	_stq.push([ 'clickTrackerInit', '166161023', '58892' ]);
</script>
</body>
</html>
