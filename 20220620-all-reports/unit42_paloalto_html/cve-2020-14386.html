
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/cve-2020-14386/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="description" content="CVE-2020-14386 is a memory corruption vulnerability in the Linux kernel that can be used to escalate privileges to the root user on a Linux system."/>
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/cve-2020-14386/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel" />
<meta property="og:description" content="CVE-2020-14386 is a memory corruption vulnerability in the Linux kernel that can be used to escalate privileges to the root user on a Linux system." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/cve-2020-14386/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="CVE-2020-14386" />
<meta property="article:tag" content="Linux" />
<meta property="article:tag" content="privilege escalation" />
<meta property="article:tag" content="vulnerability" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2020-10-10T00:00:11+00:00" />
<meta property="article:modified_time" content="2020-10-09T23:10:34+00:00" />
<meta property="og:updated_time" content="2020-10-09T23:10:34+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/word-image-24.png" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/word-image-24.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="CVE-2020-14386 is a memory corruption vulnerability in the Linux kernel that can be used to escalate privileges to the root user on a Linux system." />
<meta name="twitter:title" content="CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/Vulnerability-r3d2-1.png" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel Comments Feed" href="https://unit42.paloaltonetworks.com/cve-2020-14386/feed/" />
<meta property="og:likes" content="0"/>
<meta property="og:readtime" content="8"/>
<meta property="og:views" content="1,357"/>
<meta property="og:date_created" content="October 9, 2020 at 5:00 PM"/>
<meta property="og:post_length" content="2293"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit-42/"/>
<meta property="og:author" content="Erica Naone"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/enaone/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:post_image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/Vulnerability-r3d2-1.png"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel","name":"CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel","description":"CVE-2020-14386 is a memory corruption vulnerability in the Linux kernel that can be used to escalate privileges to the root user on a Linux system.","url":"https:\/\/unit42.paloaltonetworks.com\/cve-2020-14386\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/cve-2020-14386\/","datePublished":"October 9, 2020","articleBody":"Executive Summary\r\nLately, I\u2019ve been investing time into auditing packet sockets source code in the Linux kernel. This led me to the discovery of CVE-2020-14386, a memory corruption vulnerability in the Linux kernel. Such a vulnerability can be used to escalate privileges from an unprivileged user into the root user on a Linux system. In this blog, I will provide a technical walkthrough of the vulnerability, how it can be exploited and how Palo Alto Networks customers are protected.\r\n\r\nA few years ago, several vulnerabilities were discovered in packet sockets (CVE-2017-7308 and CVE-2016-8655), and there are some publications, such as this one in the Project Zero blog and this in Openwall, which give some overview of the main functionality.\r\n\r\nSpecifically, in order for the vulnerability to be triggerable, we need the kernel to have AF_PACKET sockets enabled (CONFIG_PACKET=y) and the CAP_NET_RAW privilege for the triggering process, which can be obtained in an unprivileged user namespace if user namespaces are enabled (CONFIG_USER_NS=y) and accessible to unprivileged users. Surprisingly, this long list of constraints is satisfied by default in some distributions, like Ubuntu.\r\n\r\nPalo Alto Networks Cortex XDR customers can prevent this bug with a combination of the Behavioral Threat Protection (BTP) feature and Local Privilege Escalation Protection module, which monitor malicious behaviors across a sequence of events, and immediately terminate the attack when it is detected.\r\nTechnical Details\r\n(All of the code figures on this section are from the 5.7 kernel sources.)\r\n\r\nDue to the fact that the implementation of AF_PACKET sockets was covered in-depth in the Project Zero blog, I will omit some details that were already described in that article (such as the relation between frames and blocks) and go directly into describing the vulnerability and its root cause.\r\n\r\nThe bug stems from an arithmetic issue that leads to memory corruption. The issue lies in the tpacket_rcv function, located in (net\/packet\/af_packet.c) .\r\n\r\nThe arithmetic bug was introduced on July 19, 2008, in the commit 8913336 (\u201cpacket: add PACKET_RESERVE sockopt\u201d). However, it became triggerable for memory corruption only in February 2016, in the commit 58d19b19cd99 (\"packet: vnet_hdr support for tpacket_rcv\"). There were some attempts to fix it, such as commit bcc536\r\n\r\n(\u201cnet\/packet: fix overflow in check for tp_reserve\u201d) in May 2017 and commit edb58be (\u201cpacket: Don't write vnet header beyond end of buffer\u201d) in August 2017. However, those fixes were not enough to prevent memory corruption.\r\n\r\nLet\u2019s first have a look at the PACKET_RESERVE option:In order to trigger the vulnerability, a raw socket (AF_PACKET domain, SOCK_RAW type ) has to be created with a TPACKET_V2 ring buffer and a specific value for the PACKET_RESERVE option.\r\n\r\n[caption id=\"attachment_109090\" align=\"aligncenter\" width=\"900\"] (from https:\/\/man7.org\/linux\/man-pages\/man7\/packet.7.html)[\/caption]\r\n\r\nThe headroom that is mentioned in the manual is simply a buffer with size specified by the user, which will be allocated before the actual data of every packet received on the ring buffer. This value can be set from user-space via the setsockopt system call.\r\n\r\n\r\n\r\ncase PACKET_RESERVE:\r\n{\r\nunsigned int val;\r\nif (optlen != sizeof(val))\r\nreturn -EINVAL;\r\nif (copy_from_user(&amp;val, optval, sizeof(val)))\r\nreturn -EFAULT;\r\nif (val &gt; INT_MAX) \r\nreturn -EINVAL;\r\nlock_sock(sk);\r\n if (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) { \r\nret = -EBUSY;\r\n} else {\r\npo-&gt;tp_reserve = val;\r\nret = 0;\r\n}\r\nrelease_sock(sk);\r\nreturn ret;\r\n}\r\n\r\n\r\n\r\n\r\nFigure 1. Implementation of setsockopt \u2013 PACKET_RESERVE\r\nAs we can see in Figure 1, initially, there is a check that the value is smaller than INT_MAX. This check was added in this patch to prevent an overflow in the calculation of the minimum frame size in packet_set_ring. Later, it\u2019s verified that pages were not allocated for the receive\/transmit ring buffer. This is done to prevent inconsistency between the tp_reserve field and the ring buffer itself.\r\n\r\nAfter setting the value of tp_reserve, we can trigger allocation of the ring buffer itself via the setsockopt system call with optname of PACKET_RX_RING:\r\n\r\n\r\n\r\nCreate a memory-mapped ring buffer for asynchronous packet\r\n\r\nreception.\r\n\r\n\r\n\r\nFigure 2. From manual packet \u2013 PACKET_RX_RING option.\r\nThis is implemented in the packet_set_ring function. Initially, before the ring buffer is allocated, there are several arithmetic checks on the tpacket_req structure received from user-space:\r\n\r\n\r\n\r\nmin_frame_size = po-&gt;tp_hdrlen + po-&gt;tp_reserve;\r\n\r\n\u2026\r\n\r\n...\r\n\r\nif (unlikely(req-&gt;tp_frame_size &lt; min_frame_size))\r\ngoto out;\r\n\r\n\r\n\r\n\r\nFigure 3. Part of the sanity checks in the packet_set_ring function.\r\nAs we can see in Figure 3, first, the minimum frame size is calculated, and then it is verified versus the value received from user-space. This check ensures that there is space in each frame for the tpacket header structure (for its corresponding version) and tp_reserve number of bytes.\r\n\r\nLater, after doing all the sanity checks, the ring buffer itself is allocated via a call to alloc_pg_vec:\r\n\r\n\r\n\r\norder = get_order(req-&gt;tp_block_size);\r\n\r\npg_vec = alloc_pg_vec(req, order);\r\n\r\n\r\n\r\nFigure 4. Calling the ring buffer allocation function in the packet_set_ring function. \r\nAs we can see from the figure above, the block size is controlled from user-space. The alloc_pg_vec function allocates the pg_vec array and then allocates each block via the alloc_one_pg_vec_page function:\r\n\r\n\r\n\r\nstatic struct pgv *alloc_pg_vec(struct tpacket_req *req, int order)\r\n{\r\nunsigned int block_nr = req-&gt;tp_block_nr;\r\nstruct pgv *pg_vec;\r\nint i;\r\npg_vec = kcalloc(block_nr, sizeof(struct pgv), GFP_KERNEL | __GFP_NOWARN);\r\nif (unlikely(!pg_vec))\r\ngoto out;\r\nfor (i = 0; i &lt; block_nr; i++) {\r\npg_vec[i].buffer = alloc_one_pg_vec_page(order);\r\n\r\n\r\n\r\n\r\nFigure 5. alloc_pg_vec implementation.\r\nThe alloc_one_pg_vec_page function uses __get_free_pages in order to allocate the block pages:\r\n\r\n\r\n\r\nstatic char *alloc_one_pg_vec_page(unsigned long order)\r\n{\r\nchar *buffer;\r\ngfp_t gfp_flags = GFP_KERNEL | __GFP_COMP |\r\n__GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;\r\nbuffer = (char *) __get_free_pages(gfp_flags, order);\r\nif (buffer)\r\nreturn buffer;\r\n\r\n\r\n\r\n\r\nFigure 6. alloc_one_pg_vec_page implementation.\r\nAfter the blocks allocation, the pg_vec array is saved in the packet_ring_buffer structure embedded in the packet_sock structure representing the socket.\r\n\r\nWhen a packet is received on the interface, the socket bound to the tpacket_rcv function will be called and the packet data, along with the TPACKET metadata, will be written into the ring buffer. In a real application, such as tcpdump, this buffer is mmap\u2019d to the user-space and packet data can be read from it.\r\nThe Bug\r\nNow let\u2019s dive into the implementation of the tpacket_rcv function (Figure 7). First, skb_network_offset is called in order to extract the offset of the network header in the received packet into maclen. In our case, this size is 14 bytes, which is the size of an ethernet header. After that, netoff (which represents the offset of the network header in the frame) is calculated, taking into account the TPACKET header (fixed per version), the maclen and the tp_reserve value (controlled by the user).\r\n\r\nHowever, this calculation can overflow, as the type of tp_reserve is unsigned int and the type of netoff is unsigned short, and the only constraint (as we saw earlier) on the value of tp_reserve is to be smaller than INT_MAX.\r\n\r\n\r\n\r\nif (sk-&gt;sk_type == SOCK_DGRAM) {\r\n\r\n...\r\n\r\nelse {\r\nunsigned int maclen = skb_network_offset(skb);\r\nnetoff = TPACKET_ALIGN(po-&gt;tp_hdrlen +\r\n(maclen &lt; 16 ? 16 : maclen)) +\r\npo-&gt;tp_reserve;\r\nif (po-&gt;has_vnet_hdr) {\r\nnetoff += sizeof(struct virtio_net_hdr);\r\ndo_vnet = true;\r\n}\r\nmacoff = netoff - maclen;\r\n}\r\n\r\n\r\n\r\nFigure 7. The arithmetic calculation in tpacket_rcv\r\nAlso shown in Figure 7, if the PACKET_VNET_HDR option is set on the socket, sizeof(struct virtio_net_hdr) is added to it in order to account for the virtio_net_hdr structure, which should be right beyond the ethernet header. And finally, the offset of the ethernet header is calculated and saved into macoff.\r\n\r\nLater in that function, seen in Figure 8 below, the virtio_net_hdr structure is written into the ring buffer using the virtio_net_hdr_from_skb function. In Figure 8, h.raw points into the currently free frame in the ring buffer (which was allocated in alloc_pg_vec).\r\n\r\n\r\n\r\nif (do_vnet &amp;&amp;\r\nvirtio_net_hdr_from_skb(skb, h.raw + macoff -\r\nsizeof(struct virtio_net_hdr),\r\nvio_le(), true, 0))\r\ngoto drop_n_account;\r\n\r\n\r\n\r\n\r\nFigure 8. Call to virtio_net_hdr_from_skb function in tpacket_rcv\r\nInitially, I thought it might be possible to use the overflow in order to make netoff a small value, so macoff could receive a larger value (from the underflow) than the size of a block and write beyond the bounds of the buffer.\r\n\r\nHowever, this is prevented by the following check:\r\n\r\n\r\n\r\nif (po-&gt;tp_version &lt;= TPACKET_V2) {\r\nif (macoff + snaplen &gt; po-&gt;rx_ring.frame_size) {\r\n...\r\n...\r\nsnaplen = po-&gt;rx_ring.frame_size - macoff;\r\nif ((int)snaplen &lt; 0) {\r\nsnaplen = 0;\r\ndo_vnet = false;\r\n}\r\n}\r\n\r\n\r\n\r\nFigure 9. Another arithmetic check in the tpacket_rcv function.\r\nThis check is not sufficient to prevent memory corruption, as we can still make macoff a small integer value by overflowing netoff. Specifically, we can make macoff smaller than sizeof(struct virtio_net_hdr), which is 10 bytes, and write behind the bounds of the buffer using virtio_net_hdr_from_skb.\r\nThe Primitive\r\nBy controlling the value of macoff, we can initialize the virtio_net_hdr structure in a controlled offset of up to 10 bytes behind the ring buffer. The virtio_net_hdr_from_skb function starts by zeroing out the entire struct and then initializing some fields within the struct based on the skb structure.\r\n\r\n\r\n\r\nstatic inline int virtio_net_hdr_from_skb(const struct sk_buff *skb,\r\nstruct virtio_net_hdr *hdr,\r\nbool little_endian,\r\nbool has_data_valid,\r\nint vlan_hlen)\r\n{\r\n\r\nmemset(hdr, 0, sizeof(*hdr)); \/* no info leak *\/\r\n\r\nif (skb_is_gso(skb)) {\r\n\r\n...\r\n\r\nif (skb-&gt;ip_summed == CHECKSUM_PARTIAL) {\r\n\r\n\u2026\r\n\r\n\r\n\r\nFigure 10. Implementation of the virtio_net_hdr_from_skb function.\r\nHowever, we can set up the skb so only zeros will be written into the structure. This leaves us with the ability to zero 1-10 bytes behind a __get_free_pages allocation. Without doing any heap manipulation tactics, an immediate kernel crash will occur.\r\nPOC\r\nA POC code for triggering the vulnerability can be found in the following Openwall thread.\r\nPatch\r\nI submitted the following patch in order to fix the bug.\r\n\r\n\r\nFigure 11. My proposed patch for the bug.\r\nThe idea is that if we change the type of netoff from unsigned short to unsigned int, we can check whether it exceeds USHRT_MAX, and if so, drop the packet and prevent further processing.\r\nIdea for Exploitation\r\nOur idea for exploitation is to convert the primitive to a use-after-free. For this, we thought about decrementing a reference count of some object. For example, if an object has a refcount value of 0x10001, the corruption would look as follows:\r\n\r\n\r\nFigure 12. Zeroing out a byte in an object refcount.\r\nAs we can see in Figure 13 below, after corruption, the refcount will have a value of 0x1, so after releasing one reference, the object will be freed.\r\n\r\nHowever, in order to make this happen, the following constraints have to be satisfied:\r\n\r\n \tThe refcount has to be located in the last 1-10 bytes of the object.\r\n \tWe need to be able to allocate the object at the end of a page.\r\n\r\n \tThis is because get_free_pages returns a page-aligned address.\r\n\r\n\r\n\r\nWe used some grep expressions along with some manual analysis of code, and we came out with the following object:\r\n\r\n\r\n\r\nstruct sctp_shared_key {\r\nstruct list_head key_list;\r\nstruct sctp_auth_bytes *key;\r\nrefcount_t refcnt;\r\n__u16 key_id;\r\n__u8 deactivated;\r\n};\r\n\r\n\r\n\r\nFigure 13. Definition of the sctp_shared_key structure.\r\nIt seems like this object satisfies our constraints:\r\n\r\n \tWe can create an sctp server and a client from an unprivileged user context.\r\n\r\n \tSpecifically, the object is allocated in the sctp_auth_shkey_create function.\r\n\r\n\r\n \tWe can allocate the object at the end of a page.\r\n\r\n \tThe size of the object is 32 bytes and it is allocated via kmalloc. This means the object is allocated in the kmalloc-32 cache.\r\n \tWe were able to verify that we can allocate a kmalloc-32 slab cache page behind our get_free_pages allocation. So we will be able to corrupt the last object in that slab cache page.\r\n\r\n \tBecause of the reason 4096 % 32 = 0, there is no spare space in the end of the slab page, and the last object is allocated right behind our allocation. Other slab cache sizes may not be good for us, such as 96 bytes, because 4096 % 96 != 0.\r\n\r\n\r\n\r\n\r\n \tWe can corrupt the highest 2 bytes of the refcnt field.\r\n\r\n \tAfter compilation, the size of key_id and deactivated is 4 bytes each.\r\n \tIf we use the bug to corrupt 9-10 bytes, we will corrupt the 1-2 most significant bytes of the refcnt field.\r\n\r\n\r\n\r\nConclusion\r\nI was surprised that such simple arithmetic security issues still exist in the Linux kernel and haven\u2019t been previously discovered. Also, unprivileged user namespaces expose a huge attack surface for local privilege escalation, so distributions should consider whether they should enable them or not.\r\n\r\nPalo Alto Networks Cortex XDR stops threats on endpoints and coordinates enforcement with network and cloud security to prevent successful cyber attacks. To prevent the exploitation of this bug, the Behavioral Threat Protection (BTP) feature and Local Privilege Escalation Protection module in Cortex XDR would monitor malicious behaviors across a sequence of events and immediately terminate the attack when detected.","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2020\/10\/Vulnerability-r3d2-1.png","width":150,"height":75},"author":[{"@type":"Person","name":"Erica Naone"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"109087","token":"c4943ce270","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=109087' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fcve-2020-14386%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fcve-2020-14386%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-109087 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">CVE-2020-14386: Privilege Escalation Vulnerability in the Linux kernel</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-109087 entry-meta">
			
			
			<span class="post-views-count">1,357</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'109087','like')"><i class="ui ui-2"></i><span class="ml-5">0</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 8</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Fcve-2020-14386%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Fcve-2020-14386%2F+-+CVE-2020-14386%3A+Privilege+Escalation+Vulnerability+in+the+Linux+kernel" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fcve-2020-14386%2F&title=CVE-2020-14386%3A+Privilege+Escalation+Vulnerability+in+the+Linux+kernel&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/cve-2020-14386/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/enaone/" title="Posts by Erica Naone" class="author url fn" rel="author">Erica Naone</a>        </p>
        <p><time datetime="2020-10-10T00:00:11+00:00">October 9, 2020 at 5:00 PM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit-42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/cve-2020-14386/" rel="tag">CVE-2020-14386</a>, <a href="https://unit42.paloaltonetworks.com/tag/linux/" rel="tag">Linux</a>, <a href="https://unit42.paloaltonetworks.com/tag/privilege-escalation/" rel="tag">privilege escalation</a>, <a href="https://unit42.paloaltonetworks.com/tag/vulnerability/" rel="tag">vulnerability</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="900" height="450" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/Vulnerability-r3d2-1.png" class="attachment-single size-single" alt="The image represents the concept of a vulnerability, such as CVE-2020-14386" />            </figure>
                    <h2><a id="post-109087-_f8zz5wdou2h9"></a>Executive Summary</h2>
<p>Lately, I’ve been investing time into auditing packet sockets source code in the Linux kernel. This led me to the discovery of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-14386">CVE-2020-14386</a>, a memory corruption vulnerability in the Linux kernel. Such a vulnerability can be used to escalate privileges from an unprivileged user into the root user on a Linux system. In this blog, I will provide a technical walkthrough of the vulnerability, how it can be exploited and how Palo Alto Networks customers are protected.</p>
<p>A few years ago, several vulnerabilities were discovered in packet sockets (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7308">CVE-2017-7308</a> and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-8655">CVE-2016-8655</a>), and there are some publications, such as this one in the <a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">Project Zero blog</a> and this in <a href="https://www.openwall.com/lists/oss-security/2016/12/07/3">Openwall</a>, which give some overview of the main functionality.</p>
<p>Specifically, in order for the vulnerability to be triggerable, we need the kernel to have <span style="font-family: 'courier new', courier, monospace;">AF_PACKET</span> sockets enabled (<span style="font-family: 'courier new', courier, monospace;">CONFIG_PACKET=y</span>) and the <span style="font-family: 'courier new', courier, monospace;">CAP_NET_RAW</span> privilege for the triggering process, which can be obtained in an unprivileged user namespace if user namespaces are enabled (<span style="font-family: 'courier new', courier, monospace;">CONFIG_USER_NS=y</span>) and accessible to unprivileged users. Surprisingly, this long list of constraints is satisfied by default in some distributions, like Ubuntu.</p>
<p>Palo Alto Networks Cortex XDR customers can prevent this bug with a combination of the <a href="https://www.paloaltonetworks.com/resources/whitepapers/5-requirements-for-effective-endpoint-protection">Behavioral Threat Protection</a> (BTP) feature and <a href="https://docs.paloaltonetworks.com/cortex/cortex-xdr/cortex-xdr-pro-admin/endpoint-security/endpoint-security-concepts/endpoint-protection-modules.html">Local Privilege Escalation Protection</a> module, which monitor malicious behaviors across a sequence of events, and immediately terminate the attack when it is detected.</p>
<h2><a id="post-109087-_6xg1uo26gsk8"></a>Technical Details</h2>
<p>(All of the code figures on this section are from the 5.7 kernel sources.)</p>
<p>Due to the fact that the implementation of <span style="font-family: 'courier new', courier, monospace;">AF_PACKET</span> sockets was covered in-depth in the Project Zero blog, I will omit some details that were already described in that article (such as the relation between frames and blocks) and go directly into describing the vulnerability and its root cause.</p>
<p>The bug stems from an arithmetic issue that leads to memory corruption. The issue lies in the <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span> function, located in (<span style="font-family: 'courier new', courier, monospace;">net/packet/af_packet.c</span>) .</p>
<p>The arithmetic bug was introduced on July 19, 2008, in the commit <a href="https://github.com/torvalds/linux/commit/8913336a7e8d56e984109a3137d6c0e3362596a4">8913336</a> (“<span style="font-family: 'courier new', courier, monospace;">packet: add PACKET_RESERVE sockopt</span>”). However, it became triggerable for memory corruption only in February 2016, in the commit 58d19b19cd99 (&#8220;<span style="font-family: 'courier new', courier, monospace;">packet: vnet_hdr </span><span style="font-family: 'courier new', courier, monospace;">support for tpacket_rcv</span>&#8220;). There were some attempts to fix it, such as commit bcc536</p>
<p>(“<span style="font-family: 'courier new', courier, monospace;">net/packet: fix overflow in check for tp_reserve</span>”) in May 2017 and commit edb58be (“<span style="font-family: 'courier new', courier, monospace;">packet: Don&#8217;t write vnet header beyond end of buffer</span>”) in August 2017. However, those fixes were not enough to prevent memory corruption.</p>
<p>Let’s first have a look at the <span style="font-family: 'courier new', courier, monospace;">PACKET_RESERVE</span> option:In order to trigger the vulnerability, a raw socket (<span style="font-family: 'courier new', courier, monospace;">AF_PACKET</span> domain, <span style="font-family: 'courier new', courier, monospace;">SOCK_RAW</span> type ) has to be created with a <span style="font-family: 'courier new', courier, monospace;">TPACKET_V2</span> ring buffer and a specific value for the <span style="font-family: 'courier new', courier, monospace;">PACKET_RESERVE</span> option.</p>
<figure id="attachment_109090" aria-describedby="caption-attachment-109090" style="width: 900px" class="wp-caption aligncenter"><img class="wp-image-109090" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/word-image-24.png" alt="PACKET_RESERVE (with PACKET_RX_RING) - By default, a packet receive ring writes packets immediately following the metadata structure and alignment padding. This integer option reserves additional headroom. " width="900" height="108" /><figcaption id="caption-attachment-109090" class="wp-caption-text">(from <a href="https://man7.org/linux/man-pages/man7/packet.7.html">https://man7.org/linux/man-pages/man7/packet.7.html</a>)</figcaption></figure>
<p>The headroom that is mentioned in the manual is simply a buffer with size specified by the user, which will be allocated before the actual data of every packet received on the ring buffer. This value can be set from user-space via the <span style="font-family: 'courier new', courier, monospace;">setsockopt</span> system call.</p>
<table style="width: 103.952%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">case PACKET_RESERVE:</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">{</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">unsigned int val;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">if (optlen != sizeof(val))</span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">return -EINVAL;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">if (copy_from_user(&amp;val, optval, sizeof(val)))</span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">return -EFAULT;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;"><strong>if (val &gt; INT_MAX) </strong></span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">return -EINVAL;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">lock_sock(sk);</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;"><strong> if (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) { </strong></span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">ret = -EBUSY;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">} else {</span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">po-&gt;tp_reserve = val;</span></p>
<p style="padding-left: 120px;"><span style="font-family: 'courier new', courier, monospace;">ret = 0;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">}</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">release_sock(sk);</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">return ret;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">}</span></p>
</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 1. Implementation of <span style="font-family: 'courier new', courier, monospace;">setsockopt – PACKET_RESERVE</span></em></p>
<p>As we can see in Figure 1, initially, there is a check that the value is smaller than <span style="font-family: 'courier new', courier, monospace;">INT_MAX</span>. This check was added in <a href="https://lore.kernel.org/patchwork/patch/784412/">this patch</a> to prevent an overflow in the calculation of the minimum frame size in <span style="font-family: 'courier new', courier, monospace;">packet_set_ring</span><strong>. </strong>Later, it’s verified that pages were not allocated for the receive/transmit ring buffer. This is done to prevent inconsistency between the <span style="font-family: 'courier new', courier, monospace;">tp_reserve</span> field and the ring buffer itself.</p>
<p>After setting the value of tp_reserve<strong>,</strong> we can trigger allocation of the ring buffer itself via the setsockopt system call with optname of <span style="font-family: 'courier new', courier, monospace;">PACKET_RX_RING</span>:</p>
<table style="width: 103.781%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">Create a memory-mapped ring buffer for asynchronous packet</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">reception.</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 2. From manual packet –<span style="font-family: 'courier new', courier, monospace;"> PACKET_RX_RING</span> option.</em></p>
<p>This is implemented in the <span style="font-family: 'courier new', courier, monospace;">packet_set_ring</span> function<strong>. </strong>Initially, before the ring buffer is allocated, there are several arithmetic checks on the <span style="font-family: 'courier new', courier, monospace;">tpacket_req</span> structure received from user-space:</p>
<table style="width: 103.22%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">min_frame_size = po-&gt;tp_hdrlen + po-&gt;tp_reserve;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">…</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">&#8230;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">if (unlikely(req-&gt;tp_frame_size &lt; min_frame_size))</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">goto out;</span></p>
</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 3. Part of the sanity checks in the <span style="font-family: 'courier new', courier, monospace;">packet_set_ring</span> function.</em></p>
<p>As we can see in Figure 3, first, the minimum frame size is calculated, and then it is verified versus the value received from user-space. This check ensures that there is space in each frame for the <span style="font-family: 'courier new', courier, monospace;">tpacket</span> header structure (for its corresponding version) and <span style="font-family: 'courier new', courier, monospace;">tp_reserve</span> number of bytes.</p>
<p>Later, after doing all the sanity checks, the ring buffer itself is allocated via a call to <span style="font-family: 'courier new', courier, monospace;">alloc_pg_vec</span><strong>:</strong></p>
<table style="width: 102.555%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">order = get_order(req-&gt;tp_block_size);</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">pg_vec = alloc_pg_vec(req, order);</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 4. Calling the ring buffer allocation function in the <span style="font-family: 'courier new', courier, monospace;">packet_set_ring</span> function. </em></p>
<p>As we can see from the figure above, the block size is controlled from user-space. The <span style="font-family: 'courier new', courier, monospace;">alloc_pg_vec</span> function allocates the <span style="font-family: 'courier new', courier, monospace;">pg_vec</span> array and then allocates each block via the <span style="font-family: 'courier new', courier, monospace;">alloc_one_pg_vec_page</span> function:</p>
<table style="width: 102.65%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">static struct pgv *alloc_pg_vec(struct tpacket_req *req, int order)</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">{</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">unsigned int block_nr = req-&gt;tp_block_nr;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">struct pgv *pg_vec;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">int i;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">pg_vec = kcalloc(block_nr, sizeof(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">if (unlikely(!pg_vec))</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">goto out;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">for (i = 0; i &lt; block_nr; i++) {</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span></p>
</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 5. <span style="font-family: 'courier new', courier, monospace;">alloc_pg_vec</span> implementation.</em></p>
<p>The <span style="font-family: 'courier new', courier, monospace;">alloc_one_pg_vec_page</span> function uses <span style="font-family: 'courier new', courier, monospace;">__get_free_pages</span> in order to allocate the block pages:</p>
<table style="width: 102.454%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">static char *alloc_one_pg_vec_page(unsigned long order)</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">{</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">char *buffer;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">gfp_t gfp_flags = GFP_KERNEL | __GFP_COMP |</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">__GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">buffer = (char *) __get_free_pages(gfp_flags, order);</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">if (buffer)</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">return buffer;</span></p>
</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 6. <span style="font-family: 'courier new', courier, monospace;">alloc_one_pg_vec_page</span> implementation.</em></p>
<p>After the blocks allocation, the <span style="font-family: 'courier new', courier, monospace;">pg_vec</span> array is saved in the <span style="font-family: 'courier new', courier, monospace;">packet_ring_buffer</span> structure embedded in the <span style="font-family: 'courier new', courier, monospace;">packet_sock</span> structure representing the socket.</p>
<p>When a packet is received on the interface, the socket bound to the <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span> function will be called and the packet data, along with the <span style="font-family: 'courier new', courier, monospace;">TPACKET</span> metadata, will be written into the ring buffer. In a real application, such as tcpdump, this buffer is mmap’d to the user-space and packet data can be read from it.</p>
<h2><a id="post-109087-_oikyq41mrdu7"></a>The Bug</h2>
<p>Now let’s dive into the implementation of the <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span> function (Figure 7). First, <span style="font-family: 'courier new', courier, monospace;">skb_network_offset</span> is called in order to extract the offset of the network header in the received packet into <span style="font-family: 'courier new', courier, monospace;">maclen</span>. In our case, this size is 14 bytes, which is the size of an ethernet header. After that, netoff (which represents the offset of the network header in the frame) is calculated, taking into account the <span style="font-family: 'courier new', courier, monospace;">TPACKET</span> header (fixed per version), the <span style="font-family: 'courier new', courier, monospace;">maclen</span> and the <span style="font-family: 'courier new', courier, monospace;">tp_reserve</span> value (controlled by the user).</p>
<p>However, this calculation can overflow, as the type of <span style="font-family: 'courier new', courier, monospace;">tp_reserve</span> is <span style="font-family: 'courier new', courier, monospace;">unsigned</span> <span style="font-family: 'courier new', courier, monospace;">int</span> and the type of <span style="font-family: 'courier new', courier, monospace;">netoff</span> is <span style="font-family: 'courier new', courier, monospace;">unsigned</span> <span style="font-family: 'courier new', courier, monospace;">short</span>, and the only constraint (as we saw earlier) on the value of <span style="font-family: 'courier new', courier, monospace;">tp_reserve</span> is to be smaller than <span style="font-family: 'courier new', courier, monospace;">INT_MAX</span>.</p>
<table style="width: 102.487%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">if (sk-&gt;sk_type == SOCK_DGRAM) {</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">&#8230;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">else {</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">unsigned int maclen = skb_network_offset(skb);</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">netoff = TPACKET_ALIGN(po-&gt;tp_hdrlen +</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">(maclen &lt; 16 ? 16 : maclen)) +</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">po-&gt;tp_reserve;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">if (po-&gt;has_vnet_hdr) {</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">netoff += sizeof(struct virtio_net_hdr);</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">do_vnet = true;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">}</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">macoff = netoff &#8211; maclen;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">}</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 7. The arithmetic calculation in <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span></em></p>
<p>Also shown in Figure 7, if the <span style="font-family: 'courier new', courier, monospace;">PACKET_VNET_HDR</span> option is set on the socket, <span style="font-family: 'courier new', courier, monospace;">sizeof(struct virtio_net_hdr)</span> is added to it in order to account for the <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr</span> structure, which should be right beyond the ethernet header. And finally, the offset of the ethernet header is calculated and saved into <span style="font-family: 'courier new', courier, monospace;">macoff</span>.</p>
<p>Later in that function, seen in Figure 8 below, the <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr</span> structure is written into the ring buffer using the <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb</span> function. In Figure 8, <span style="font-family: 'courier new', courier, monospace;">h.raw</span> points into the currently free frame in the ring buffer (which was allocated in <span style="font-family: 'courier new', courier, monospace;">alloc_pg_vec</span>).</p>
<table style="width: 102.1%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">if (do_vnet &amp;&amp;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb(skb, h.raw + macoff &#8211;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">sizeof(struct virtio_net_hdr),</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">vio_le(), true, 0))</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">goto drop_n_account;</span></p>
</td>
</tr>
</tbody>
</table>
<p style="padding-left: 40px; text-align: center;"><em>Figure 8. Call to <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb</span> function in <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span></em></p>
<p>Initially, I thought it might be possible to use the overflow in order to make <span style="font-family: 'courier new', courier, monospace;">netoff</span> a small value, so <span style="font-family: 'courier new', courier, monospace;">macoff</span> could receive a larger value (from the underflow) than the size of a block and write beyond the bounds of the buffer.</p>
<p>However, this is prevented by the following check:</p>
<table style="width: 102.315%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">if (po-&gt;tp_version &lt;= TPACKET_V2) {</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">if (macoff + snaplen &gt; po-&gt;rx_ring.frame_size) {</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">&#8230;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">&#8230;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">snaplen = po-&gt;rx_ring.frame_size &#8211; macoff;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">if ((int)snaplen &lt; 0) {</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">snaplen = 0;</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">do_vnet = false;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">}</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">}</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 9. Another arithmetic check in the <span style="font-family: 'courier new', courier, monospace;">tpacket_rcv</span> function.</em></p>
<p>This check is not sufficient to prevent memory corruption, as we can still make <span style="font-family: 'courier new', courier, monospace;">macoff</span> a small integer value by overflowing <span style="font-family: 'courier new', courier, monospace;">netoff</span>. Specifically, we can make <span style="font-family: 'courier new', courier, monospace;">macoff</span> smaller than <span style="font-family: 'courier new', courier, monospace;">sizeof(struct virtio_net_hdr)</span>, which is 10 bytes, and write behind the bounds of the buffer using <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb</span><strong>.</strong></p>
<h4><a id="post-109087-_qwqsbr3ev794"></a><strong>The Primitive</strong></h4>
<p>By controlling the value of <span style="font-family: 'courier new', courier, monospace;">macoff</span>, we can initialize the <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr</span> structure in a controlled offset of up to 10 bytes behind the ring buffer. The <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb</span> function starts by zeroing out the entire struct and then initializing some fields within the struct based on the <span style="font-family: 'courier new', courier, monospace;">skb</span> structure.</p>
<table style="width: 102.301%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">static inline int virtio_net_hdr_from_skb(const struct sk_buff *skb,</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">struct virtio_net_hdr *hdr,</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">bool little_endian,</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">bool has_data_valid,</span></p>
<p style="padding-left: 80px;"><span style="font-family: 'courier new', courier, monospace;">int vlan_hlen)</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">{</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">memset(hdr, 0, sizeof(*hdr)); /* no info leak */</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">if (skb_is_gso(skb)) {</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">&#8230;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">if (skb-&gt;ip_summed == CHECKSUM_PARTIAL) {</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">…</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 10. Implementation of the <span style="font-family: 'courier new', courier, monospace;">virtio_net_hdr_from_skb</span> function.</em></p>
<p>However, we can set up the <span style="font-family: 'courier new', courier, monospace;">skb</span> so only zeros will be written into the structure. This leaves us with the ability to zero 1-10 bytes behind a <span style="font-family: 'courier new', courier, monospace;">__get_free_pages</span> allocation. Without doing any heap manipulation tactics, an immediate kernel crash will occur.</p>
<h4><a id="post-109087-_lnj1ectj3upb"></a><strong>POC</strong></h4>
<p>A POC code for triggering the vulnerability can be found in the following Openwall <a href="https://www.openwall.com/lists/oss-security/2020/09/03/3">thread</a>.</p>
<h4><a id="post-109087-_nvgnadx6spgk"></a><strong>Patch</strong></h4>
<p>I submitted the following <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=acf69c946233259ab4d64f8869d4037a198c7f06">patch</a> in order to fix the bug.</p>
<p><img class="aligncenter wp-image-109092" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/word-image-25.png" alt="The code shown represents the author's proposed patch for CVE-2020-14386. " width="900" height="416" /></p>
<p style="text-align: center;"><em>Figure 11. My proposed patch for the bug.</em></p>
<p>The idea is that if we change the type of <span style="font-family: 'courier new', courier, monospace;">netoff</span> from <span style="font-family: 'courier new', courier, monospace;">unsigned short</span> to <span style="font-family: 'courier new', courier, monospace;">unsigned int</span>, we can check whether it exceeds <span style="font-family: 'courier new', courier, monospace;">USHRT_MAX</span>, and if so, drop the packet and prevent further processing.</p>
<h2><a id="post-109087-_tfmxioa1t0no"></a>Idea for Exploitation</h2>
<p>Our idea for exploitation is to convert the primitive to a use-after-free. For this, we thought about decrementing a reference count of some object. For example, if an object has a refcount value of 0x10001, the corruption would look as follows:</p>
<p><img class="wp-image-109094" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/word-image-26.png" /><img class="aligncenter wp-image-109096" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2020/10/Screen-Shot-2020-10-09-at-5.16.27-PM.png" alt="This illustrates the process of zeroing out a byte in an object refcount, exploiting CVE-2020-14386. It shows the appearance before corruption, with an example refcount value of 0x10001, and after corruption, when the refcount = 0x1." width="500" height="307" /></p>
<p style="text-align: center;"><em>Figure 12. Zeroing out a byte in an object refcount.</em></p>
<p>As we can see in Figure 13 below, after corruption, the refcount will have a value of 0x1, so after releasing one reference, the object will be freed.</p>
<p>However, in order to make this happen, the following constraints have to be satisfied:</p>
<ul>
<li>The refcount has to be located in the last 1-10 bytes of the object.</li>
<li>We need to be able to allocate the object at the end of a page.
<ul>
<li>This is because <span style="font-family: 'courier new', courier, monospace;">get_free_pages</span> returns a page-aligned address.</li>
</ul>
</li>
</ul>
<p>We used some grep expressions along with some manual analysis of code, and we came out with the following object:</p>
<table style="width: 102.177%;">
<tbody>
<tr>
<td style="width: 100%;"><span style="font-family: 'courier new', courier, monospace;">struct sctp_shared_key {</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">struct list_head key_list;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">struct sctp_auth_bytes *key;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">refcount_t refcnt;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">__u16 key_id;</span></p>
<p style="padding-left: 40px;"><span style="font-family: 'courier new', courier, monospace;">__u8 deactivated;</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">};</span></td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Figure 13. Definition of the <span style="font-family: 'courier new', courier, monospace;">sctp_shared_key</span> structure.</em></p>
<p>It seems like this object satisfies our constraints:</p>
<ul>
<li>We can create an sctp server and a client from an unprivileged user context.
<ul>
<li>Specifically, the object is allocated in the <span style="font-family: 'courier new', courier, monospace;">sctp_auth_shkey_create</span> function.</li>
</ul>
</li>
<li>We can allocate the object at the end of a page.
<ul>
<li>The size of the object is 32 bytes and it is allocated via kmalloc. This means the object is allocated in the <span style="font-family: 'courier new', courier, monospace;">kmalloc-32</span> cache.</li>
<li>We were able to verify that we can allocate a <span style="font-family: 'courier new', courier, monospace;">kmalloc-32</span> slab cache page behind our get_free_pages allocation. So we will be able to corrupt the last object in that slab cache page.
<ul>
<li>Because of the reason 4096 % 32 = 0, there is no spare space in the end of the slab page, and the last object is allocated right behind our allocation. Other slab cache sizes may not be good for us, such as 96 bytes, because 4096 % 96 != 0.</li>
</ul>
</li>
</ul>
</li>
<li>We can corrupt the highest 2 bytes of the <span style="font-family: 'courier new', courier, monospace;">refcnt</span> field.
<ul>
<li>After compilation, the size of <span style="font-family: 'courier new', courier, monospace;">key_id</span> and <span style="font-family: 'courier new', courier, monospace;">deactivated</span> is 4 bytes each.</li>
<li>If we use the bug to corrupt 9-10 bytes, we will corrupt the 1-2 most significant bytes of the <span style="font-family: 'courier new', courier, monospace;">refcnt</span> field.</li>
</ul>
</li>
</ul>
<h2><a id="post-109087-_568b25rqnm16"></a>Conclusion</h2>
<p>I was surprised that such simple arithmetic security issues still exist in the Linux kernel and haven’t been previously discovered. Also, unprivileged user namespaces expose a huge attack surface for local privilege escalation, so distributions should consider whether they should enable them or not.</p>
<p>Palo Alto Networks Cortex XDR stops threats on endpoints and coordinates enforcement with network and cloud security to prevent successful cyber attacks. To prevent the exploitation of this bug, the <a href="https://www.paloaltonetworks.com/resources/whitepapers/5-requirements-for-effective-endpoint-protection">Behavioral Threat Protection</a> (BTP) feature and <a href="https://docs.paloaltonetworks.com/cortex/cortex-xdr/cortex-xdr-pro-admin/endpoint-security/endpoint-security-concepts/endpoint-protection-modules.html">Local Privilege Escalation Protection</a> module in Cortex XDR would monitor malicious behaviors across a sequence of events and immediately terminate the attack when detected.</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<div class="ignite20promo">
    <div class="container">
    <div class="ignite20text">
        <div>
            <div class="orange-bar-sm"></div><br/>
        <span class="promo-heading">Secure Today,<br/>for a Better<br/>Tomorrow</span>
        </div>
        <div class="promo-subtext"><span>Join us at IGNITE’20</span>
            <a href="https://ignitereg.paloaltonetworks.com/flow/paloaltonetworks/ignite20/regsc/login?source=unit42" onclick="return false;">
                <svg width="17" height="12" viewBox="0 0 17 12" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M1.41089 6L15.3143 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M10.1006 1L15.3144 6L10.1006 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
        </div>
        </div>
    </div> 
</div>
<script type="text/javascript">
    $('.ignite20promo').click(function(){
        window.open("https://ignitereg.paloaltonetworks.com/flow/paloaltonetworks/ignite20/regsc/login?source=unit42", "_blank"); 
    });
</script>    
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
