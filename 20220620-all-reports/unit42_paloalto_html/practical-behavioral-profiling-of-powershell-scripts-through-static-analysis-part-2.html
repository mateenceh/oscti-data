
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" />
<link rel="alternate" hreflang="ja" href="https://unit42.paloaltonetworks.jp/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)" />
<meta property="og:description" content="Part 2 of a 3-part blog series that offers a more technical perspective and begins looking at common obfuscation techniques and methods for hiding data within PowerShell that can be reversed." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="malware" />
<meta property="article:tag" content="obfuscation" />
<meta property="article:tag" content="Powershell" />
<meta property="article:tag" content="PowerShell Scripts" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2019-10-24T13:00:11+00:00" />
<meta property="article:modified_time" content="2019-10-24T07:53:28+00:00" />
<meta property="og:updated_time" content="2019-10-24T07:53:28+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Vulnerability-r3d2-1024x512.png" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Vulnerability-r3d2-1024x512.png" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="512" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="Part 2 of a 3-part blog series that offers a more technical perspective and begins looking at common obfuscation techniques and methods for hiding data within PowerShell that can be reversed." />
<meta name="twitter:title" content="Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Vulnerability-r3d2.png" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2) Comments Feed" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/feed/" />
<meta property="og:likes" content="8"/>
<meta property="og:readtime" content="14"/>
<meta property="og:views" content="15,291"/>
<meta property="og:date_created" content="October 24, 2019 at 6:00 AM"/>
<meta property="og:post_length" content="3940"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit-42/"/>
<meta property="og:author" content="Jeff White"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/jeff-white/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:post_image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/05/Vulnerability-r3d2-768x384-380x184.png"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)","name":"Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)","description":"Part 2 of a 3-part blog series that offers a more technical perspective and begins looking at common obfuscation techniques and methods for hiding data within PowerShell that can be reversed.","url":"https:\/\/unit42.paloaltonetworks.com\/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2\/","datePublished":"October 24, 2019","articleBody":"Executive Summary\r\nThis 3-part blog series focuses on a practical approach to static analysis of PowerShell scripts and developing a platform-independent Python script to carry out this task. This is Part 2 of a 3-part blog series and you can read Part 1 here to get caught up.\r\n\r\nOver the course of the series, I will talk about the ins and outs of behavioral profiling, cover common obfuscation and methods of hiding data within PowerShell scripts, and how we can go about building a scoring system to assess the risks of scripts. In general, I aim to aide other analysts and defenders in this endeavor with ideas and a functional foundation script to hit the ground running.\r\nIntroduction\r\nIn the first part of this blog, I touched on some general concepts around static analysis, behaviors in PowerShell, and things I needed to consider as I moved into the design phase, which will be the focus of this second blog.\r\n\r\nMy overarching goal is to profile behaviors and infer their intent in PowerShell scripts so I\u2019ll begin by looking at the script input first. Next, I\u2019ll cover the general process of normalizing and de-obfuscating common PowerShell obfuscation and code hiding techniques that you\u2019ll see in-the-wild (ITW) and provide examples of how script content is modified during processing to reveal more data. Finally, we\u2019ll take a look at the behaviors I\u2019ve identified as important for scoring and how they play into the overall assessment of risk in scoring.\r\nPowerShell Script Input\r\nInput can come in many flavors but for the sake of simplicity, I\u2019ll limit this discussion to PowerShell scripts and not other files which may contain PowerShell commands or embedded scripts, such as ScriptBlock Logs, VBScript, and JavaScript. Regardless of the type, it all begins the same way with preparing the data for processing throughout the rest of the script.\r\n\r\nIn this case, it\u2019s fairly straightforward to start. As I\u2019ll be dealing heavily with REGEX and string matching on ASCII based character sets used to define function names and other keywords in PowerShell, I need to remove the NULL bytes from the input data so that character encoding is less of a problem down the line. If you\u2019re not familiar with the default Windows code pages or Unicode, just know that they utilize two bytes to represent a character but, for our use-case, we are only interested in the characters which fall in the ASCII range. In a two-byte code page, which deals with the character encoding, the first byte will be NULL. For example, if we wanted to search for an exact match of the word \u201cHELLO\u201d but there are NULL bytes pre-pending each byte representing a character in the ASCII range, then this can lead to matching issues so we\u2019ll strip them out.\r\n\r\nThe string \u201c\\x00H\\x00E\\x00L\\x00L\\x00O\u201d becomes simply \u201cHELLO\u201d. This establishes a uniformity in characters to match against before I move the data further downstream for processing.\r\nPreparing Content for Profiling\r\nTo accurately profile the PowerShell behaviors, I need to normalize and de-obfuscate as much of the content as possible so that I have the highest opportunity of identifying behaviors in the content; whether they are in plain sight, hidden under multiple layers of obfuscation, or buried within various encoding algorithms.\r\n\r\nTo do this, the script creates two sets of data from the original content that will be scanned over continuously; one which contains the original content, sans the NULL bytes described earlier, and an alternate one wherein the script builds up new content that it discovers during processing. Sometimes there is little deviation from the original content and it\u2019s entirely driven based on identifying the obfuscation and content hiding methods that may have been employed.\r\n\r\nThere are two distinct phases here for preparing the content for profiling. One is for cleaning up the content and removing various types of obfuscation and one is for trying to unravel the various ways of burying data within the code that PowerShell supports, such as encryption, compression, and encoding. I\u2019ll step through each of these phases and go over the existing functions that I\u2019ve built into the script to achieve these goals but, before I move on, I need to talk about general obfuscation and how I approached processing.\r\n\r\nWhen you analyze malicious scripts, you\u2019ll frequently find multiple layers and types of obfuscation all contained within a script. What this means is that when the script removes obfuscation from code, it potentially reveals a new code that also needs to be analyzed again to see if it contains more obfuscation or requires more normalization and the process repeats itself. Given this, there needs to be a way to track the state of code and it\u2019s subsequent alteration so that the script can continue processing it until the state fails to change, this workflow is shown in the figure below.\r\n\r\n\r\nFigure 7. High-level Processing Flow\r\nAt a high level, this is relatively straight forward but in practice, there are more practical issues you may run into, such as the order in which the script process different types of obfuscation. These considerations and the order of de-obfuscation or normalization I use in the script were derived over the course of testing and iteration.\r\n\r\nAs the profiling script is not executing the code, I\u2019m less concerned with unraveling a functional script and more interested in unraveling the raw content; however, when the profiling script does attempt to reverse obfuscation than I try to maintain the integrity of the underlying code where possible. Once the state finally stops changing, the profiling script can move into the behavioral profiling process.\r\n\r\nIn the current iteration, there are numerous functions for normalizing and unraveling content so I\u2019ll dive into each of them, what their intent is, and discuss how they affect the code.\r\nNormalization \/ Obfuscation Removal\r\nThe identification of obfuscation is typically handled with simple searches or REGEX matches when dealing with non-single character obfuscation. Given the flexibility of PowerShell, you\u2019ll run across dozens of variations for the same commands that can be used so the REGEX patterns I\u2019ve created are designed to capture as many variants as possible, but there is always room for improvement and those included in the script just capture the variants found in my sample set.\r\n\r\nTo illustrate this idea, consider the following REGEX pattern for capturing variants of the Format String Operator Replacement technique.\r\n\\((?:\\s*)(\\\"|\\')((?:\\s*)\\{[0-9]{1,3}\\}(?:\\s*))+\\1(?:\\s*)-[fF](?:\r\n\\s*)(\\\"|\\').+?(\\\"|\\')(?:\\s*)\\)(?![^)])\r\nWhich can match on things like the following:\r\n(\"{1}{0}\" -F\"exa\" ,\"mple\")\r\n( \" {0} \" -F \"example\")\r\n( \"{1} {0} \" -F 'exa' , \"mple\" )\r\nBasic single-character obfuscation will be removed from the content during processing while the more complex ones will replace the content blocks inline. For each type of obfuscation dealt with, I\u2019ll provide a brief description and a real world example of it in action and what it should transform into.\r\n\r\n1. Backticks (`) are used for escaping characters in PowerShell and wrapping lines of code. It\u2019s commonly used in\r\nobfuscation to escape non-special characters and break-up words to prevent matching.\r\nif ( ${CoM`P`U`TERn`AME} -eq ${Nu`LL}\r\nif ( ${CoMPUTERnAME} -eq ${NuLL}\r\n2. Carets (^) are escape characters for Windows command line and when you find mixed scripting languages you\u2019ll\r\nfrequently see this.\r\necho i^eX(^\"^I^e^`X^`\r\necho ieX(\"Ie`X`\r\n3. Escaped Quotes (\\\u201d) are most commonly seen for substrings that need to be escaped and we\u2019ll want to remove the\r\nescaping so we can accurately profile across that boundary, where a backslash may interfere with pattern matching. In\r\nmalicious scripts, these substrings are frequently commands which will be unraveled or passed to new instances of\r\nPowerShell that can be profiled further. Additionally, it can be used to insert empty quotes for additional obfuscation\r\nlike below.\r\n(g\\'\\'v KUs).value.toString()\r\n(g''v KUs).value.toString()\r\n4. Empty Quotes (\u201c\u201d) are another trick that can be used to break up variables in PowerShell and otherwise break string\r\nmatching, so I remove those when necessary.\r\n(g''v KUs).value.toString()\r\n(gv KUs).value.toString()\r\n5. Spaces ( ) can be used to obfuscate in a way that is similar to CaMeL CaSe capitalization; it\u2019s used to confuse the reader\r\nwithout causing issues with how PowerShell interprets the code.\r\n-EX uNrEsTRIcteD -nOP -W HIdDEn \r\n-eC-EX uNrEsTRIcteD -nOP -W HIdDEn -eC\r\n6. Concatenation (+) of strings is another common technique for breaking up strings so the profiling script attempts to\r\nrebuild them. There are many ways of doing concatenation but this one focuses on the use of the addition symbol.\r\nNew-Object $(\"Sys\"+\"tem.Refl\"+\"ection.Ass\"+\"embl\"+\"yName\")\r\nNew-Object $(\"System.Reflection.AssemblyName\")\r\n\r\n \tType Conversion is another technique it looks for as the technique is commonly used for string obfuscation. This is the first of the \u201cbrute force\u201d functions in which the profiling script iterate over multiple base values (base8, base16, and base32) to build possible strings, along with trying to identify integers and hexadecimal values stored in lists that can be converted to ASCII.\r\n\r\n(\u20186e,6f,74,65,70,61,64'.SPLiT(\u2018,\u2019) |fOREAch {( [cHar]([COnVERt]::tOINt16(([STRINg]$_ ) ,16 ))) })-jOIn '')\r\nNotepad\r\n\r\n \tSplitting, as seen above, goes hand in hand with conversion and you\u2019ll frequently see in malicious scripts this obfuscation using a range of characters to split integers or hexadecimal values. In these cases, the script again takes a shotgun approach to strip out contiguous sets of values and try to decipher as much plain text as possible.\r\n\r\n27R2cQ20i27p27{29hdQa{7dpd~a'.SPLiT('{p}hiRQ~' )|\r\n27 2c 20 27 27 29 d a 7d d a\r\nLast, there are two more obfuscation types the profiling script tackles that are a bit more complicated in terms of identification and parsing due to PowerShells flexibility in how things can be called.\r\n\r\n7. Format String Operator Replacement has seen a sharp rise of adoption rates in\r\nmalicious scripts ever since Daniel Bohannon released Invoke-Obfuscation that uses\r\nthis token-style replacement heavily. The functions for statically parsing these with\r\nREGEX require that it considers nested layers of operator replacement, so it targets\r\nsmaller inner-versions first and slowly unravels it from the inside-out. It\u2019ll substitute\r\nthe parsed string with the replacement command until it\u2019s unable to identify anymore\r\nvariants in the content.\r\n('V'+(\"{1}{0}\" -f 'b',(\"{1}{0}\" -f 'A','aRi'))+'Le:'\r\n('VaRiAbLe:'\r\n8. For PowerShell\u2019s built-in string replacement function, the script again uses a REGEX\r\npattern to identify the many variations possible for this command and attempts to\r\nreplace strings across the content.\r\nOUT-fILe (\"C:c4yprogramdatac4yerror.txt\").rEpLAce((\"c4y\"),'\\')'\r\nOUT-fILe (\"C:\\programdata\\error.txt\")\r\nThese sets of de-obfuscation and normalization functions will be run and re-run again as new content is discovered or the state of the existing data changes.\r\nUnraveling Content\r\nSimilar to the above functions for de-obfuscation and normalization of content for profiling, the script also scans the content for certain artifacts to determine if there is additional content that may unraveled. In this next section, I\u2019ll step through the various methods it uses to identify and reveal the content statically.\r\n\r\n \tReversed content is one of the simpler types it\u2019ll deal with and, in my experience, isn\u2019t actually that common. In this case, it simply looks for reversed strings of common PowerShell methods and then take the entire content, reverses it, and appends it to the end of the alternate content stream.\r\n\r\nRAHC[+58]RAHC[+501]RAHC[((eCALpEr.)93]RAHC[]GNirtS[,'V3wfe'(eCALpEr.)).rEpLACe('efw3V',[StriNG][CHAR]39\r\n).rEpLACe(([CHAR]105+[CHAR]85+[CHAR\r\n\r\n \tAnother common method of hiding content from view is to utilize the Windows Stream objects which are effectively a class used to encode content. In this case, the profiling script identifies if the calls exist within the visible content and then attempts to deflate the stream. By default, Microsoft uses the same compression algorithm as gzip but the script will attempt to brute force it with a couple of different compression settings to expand coverage.\r\n\r\nNew-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String('Cy\/KLEnV9cgvLlFQz0jNycnXUSjPL8pJUVQHAA=='),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()\r\nWrite-Host 'hello, world!'\r\n\r\n \tNext is Base64, which is probably the most basic and universal encoding scheme around. Nothing fancy here but so it just takes every piece of content which matches a REGEX pattern for Base64 over a certain size (currently 30 bytes), decodes it, and append it to the alternate data stream for profiling.\r\n\r\nRAB5AG4AYQBtAGkAYwBBAHMAcwBlAG0AYgBsAHkA\r\nDynamicAssembly\r\n\r\n \tFinally, there is some basic decryption of Microsoft SecureStrings which use the default AES in CBC mode when the SecureString is created with a key. The script looks for the calls to decrypt these SecureStrings and then tries to identify the symmetric encryption key, all of the Base64 content, and the required IV to decrypt the content. I\u2019ve yet to see this technique used in-the-wild (ITW) for a small amount of data that I could use for illustrative purposes so I\u2019ve cobbled together a quick example instead.\r\n\r\n&gt; $SecureString = ConvertTo-SecureString \"EXAMPLE\" \r\n-AsPlainText -Force\r\n&gt; $StandardString = ConvertFrom-SecureString $SecureString\r\n&gt; $Key = \r\n(68,111,110,116,72,105,114,101,84,111,109,76,97,110,99,97,1\r\n15,116,101,114,70,65,67,84)\r\n&gt; $StandardString = ConvertFrom-SecureString $SecureString \r\n-Key $Key\r\n&gt; $StandardString\r\n\r\n76492d1116743f0423413b16050a5345MgB8AFAAZQBHAHoAeABvAG0AVAA\r\n5AGkAQgA1AEEATABsAGoANABnAFgATABSAFEAPQA9AHwAMAA0ADQANQBiAD\r\nEANQA2ADIAYgA3AGQAMwBmADIAZgA1ADYAYgA5AGUAZgAwADAAMgAyADYAZ\r\nQAzAGMAMQAzAA==\r\nThe string \u201cEXAMPLE\u201d is encrypted by the 24 bytes and a Base64 value is returned. The inner contents of this Base64 blob, which appear to be a non-publicly documented structure, contain the encrypted string and a Base64 encoded IV. The values are pipe (\u201c|\u201d) delimited so I\u2019ve highlighted the IV in RED and the encrypted data in BLUE. These are what the function will target for decryption.\r\n\\xef\\xae=\\\r\nxd9\\xddu\\xd7\\xae\\xf8\\xdd\\xfd8\\xdb~5\\xdd\\xbdz\\xd3\\x9d\\x1a\\xe7~92|PeGzxomT9iB5ALlj4gXLRQ==|0445b1562b7d3f2f56b\r\n9ef00226e3c13\r\nThis overview covers all of the techniques I\u2019ve found to be commonly used throughout malicious scripts, along with various types of de-obfuscation or normalization needed to reveal further content. While this by no means is intended to coverage of everything, it\u2019s a good base to start from.\r\nProfiling Known Malware Families\r\nOnce the profiling script has as much of the content revealed as possible, it then begins the identification phase. The script starts with first trying to look for known malware families and variants of them as this provides a quick way to score files based off of known indicators and establish intent very quickly. These are primarily REGEX patterns or collections of keywords that uniquely identify malicious scripts such as Magic Unicorn, Social Engineer Toolkit (SET), and Veil. The full list of the currently checked families are below and this section can be added to when new popular formats start appearing ITW.\r\n\r\n \tMagic Unicorn\r\n \tShellCode Injector\r\n \tICMP Shell\r\n \tSET\r\n \tPowerDump\r\n \tBashBunny\r\n \tVeil\r\n \tPowerWorm\r\n \tPowerShell Empire\r\n \tPowerfun\r\n \tMimikatz\r\n \tMimikittenz\r\n \tPowerSploit\r\n \tDynAmite\r\n \tInvoke-Obfuscation\r\n \tTXT C2\r\n \tRemote DLL\r\n \tCobalt Strike\r\n \tVdw0rm\r\n \tEmotet\r\n \tmateMiner\r\n \tDownAndExec\r\n \tBuckeye\r\n \tAPT34\r\n \tMuddyWater\r\n \tTennc Webshell\r\n \tPoshC2\r\n \tPosh-SecMod\r\n \tInvoke-TheHash\r\n \tNishang\r\n \tInvoke-CradleCrafter\r\n\r\nThese were all derived through the aforementioned manual analysis or from previous research. Whenever I found that I was seeing repeating scripts, or structures of scripts, it was a good indicator that it was generated from a framework or script and those usually lend themselves to profiling quite well. Again, it\u2019s not full coverage for any of the above but as you identify new variants or new families, you can add them as a way to expand your coverage.\r\nProfiling PowerShell Behaviors\r\nNext we move to the actual profiling of PowerShell behaviors. These are broken into three distinct contextual categories - behaviors generally only seen in malicious scripts, behaviors generally seen in both good and bad scripts (neutral), and finally behaviors generally only seen in benign scripts.\r\n\r\n\r\nFigure 8. Venn Diagram of behavioral overlap\r\nI\u2019ll list all of them below and their corresponding scores (taken directly from the script) while covering some basics of how they work.\r\nNegative Behaviors\r\n\r\n \t'Code Injection': 10.0\r\n \t'Key Logging': 3.0\r\n \t'Screen Scraping': 2.0\r\n \t'AppLocker Bypass': 2.0\r\n \t'AMSI Bypass': 2.0\r\n \t'Clear Logs': 2.0\r\n \t'Coin Miner': 6.0\r\n \t'Embedded File': 4.0\r\n \t'Abnormal Size': 2.0\r\n \t'Ransomware': 10.0\r\n \t'DNS C2': 2.0\r\n \t'Disabled Protections': 4.0\r\n \t'Negative Context': 10.0\r\n \t'Malicious Behavior Combo': 6.0\r\n \t'Known Malware': 10.0\r\n\r\nKeep in mind that we\u2019re trying to place a malicious script in the score range of 6+, with the higher the score the more confident we are in the verdict.\r\n\r\nFor the majority of these, profiling is carried out with simple keyword scanning or combinations of keywords. Let\u2019s take a look at a simple one and how the behavior is defined in the Python code.\r\nbehaviorCol[\"Disabled Protections\"] = [[\"REG_DWORD\", \"DisableAntiSpyware\"],\r\n    [\"REG_DWORD\", \"DisableAntiVirus\"],\r\n    [\"REG_DWORD\", \"DisableScanOnRealtimeEnable\"],\r\n    [\"REG_DWORD\", \"DisableBlockAtFirstSeen\"],\r\n    ]\r\nFor a script to be flagged as having the \u201cDisabled Protections\u201d behavior then, the content must contain one of four variations of \u201cREG_DWORD\u201d and a registry key that I\u2019ve observed in malicious scripts to disable common Windows protection mechanisms such as AntiSpyware and AntiVirus.\r\n\r\nTaking a look at another basic example for \u201cKey Logging\u201d shows various combinations of keywords that, when found together, are typically indicative of key logging activity.\r\n     behaviorCol[\"Key Logging\"] = [\r\n         [\"GetAsyncKeyState\", \"Windows.Forms.Keys\"],\r\n         [\"LShiftKey\", \"RShiftKey\", \"LControlKey\", \r\n\"RControlKey\"],\r\n    ]\r\nNow, for both \u201cDisabled Protections\u201d and \u201cKey Logging\u201d, the scores are \u201c4.0\u201d and \u201c3.0\u201d respectively, well below the \u201c6.0\u201d threshold for malicious activity. The reason behind this is that sometimes, even though behaviors are predominantly only seen in malicious scripts, they are also used in benign scripts and so I want additional behaviors to add context and push the score beyond the threshold, as opposed to something like \u201cRansomware\u201d or \u201cKnown Malware\u201d where the profiling script immediately sets it above the \u201c6.0\u201d threshold.\r\n\r\nA more complex behavior we can look at is \u201cCode Injection\u201d. This is a technique that follows a specific pattern of calls designed to carve out a segment of memory, move shellcode into the memory segment, and then finally transfer execution to the shellcode in memory. The problem is that at each phase of this, there are numerous methods which facilitate the respective functionality; the profiling script accounts for over 1300 variations alone. Thus, we\u2019ll check each individual keyword at each step and only proceed to the next set of keywords if we find one in the previous set. This allows us to keep analysis time low even though the number of variations significantly rises with each addition. Speed is equally important when profiling these at scale and a lot of the profiling script is designed in ways to decrease run time where possible.\r\n\r\nWhen you look at the above behaviors, you\u2019ll also note one called \u201cMalicious Behavior Combo\u201d towards the end. This one is intended to bump malicious scripts that do not exhibit enough behavioral information to generate a score above the target threshold an extra boost as a contextual modifier. The profiling script will look at all of the behaviors for the PowerShell script as a whole and then use it as its own behavior.\r\n\r\nThe combinations are checked against the aforementioned ground truth of the scripts being used for a baseline to validate the combination of behaviors do not negatively impact benign scripts. It\u2019s important to carefully monitor these as more data can reveal benign scripts which may match; however, this is a good example of using meta-data to influence scoring.\r\nbehaviorCombos = [\r\n    [\"Downloader\", \"One Liner\", \"Variable Extension\"],\r\n    [\"Downloader\", \"Script Execution\", \"Crypto\", \r\n\"Enumeration\"],\r\n        [\"Downloader\", \"Script Execution\", \"Persistence\", \r\n\"Enumeration\"],\r\n        [\"Downloader\", \"Script Execution\", \"Starts Process\", \r\n\"Enumeration\"],\r\n        [\"Script Execution\", \"One Liner\", \"Variable Extension\"],\r\n        ['Script Execution', 'Starts Process', 'Downloader', \r\n'One Liner'],\r\n        ['Script Execution', 'Downloader', 'Custom Web Fields'],\r\n        [\"Script Execution\", \"Hidden Window\", \"Downloader\"],\r\n        ['Script Execution', 'Crypto', 'Obfuscation'],\r\n        [\"Hidden Window\", \"Persistence\", \"Downloader\"],\r\n]\r\nNeutral Behaviors\r\n\r\n \t'Downloader': 1.5\r\n \t'Starts Process': 1.5\r\n \t'Script Execution': 1.5\r\n \t'Compression': 1.5\r\n \t'Hidden Window': 0.5\r\n \t'Custom Web Fields': 1.0\r\n \t'Persistence': 1.0\r\n \t'Sleeps': 0.5\r\n \t'Uninstalls Apps': 0.5\r\n \t'Obfuscation': 1.0\r\n \t'Crypto': 2.0\r\n \t'Enumeration': 0.5\r\n \t'Registry': 0.5\r\n \t'Sends Data': 1.0\r\n \t'Byte Usage': 1.0\r\n \t'SysInternals': 1.5\r\n \t'One Liner': 2.0\r\n \t'Variable Extension': 2.0\r\n\r\nThe neutral behaviors are, as the name suggests, neither good nor bad and follow a similar approach to the ones previously discussed. There are a couple of additional meta-behaviors that I want to highlight which are \u201cObfuscation\u201d, \u201cOne Liner\u201d, and \u201cVariable Extension\u201d as they illustrate more diversion from the keyword approach. Just to recap then, meta-behaviors are observed characteristics that are not a specific functionality or capability, but something that describes a characteristic of the PowerShell script.\r\n\r\n \tOne Liner - This one is self explanatory, a script that solely exists on one line. It\u2019s extremely common for malicious scripts or very simple PowerShell download cradles to be constrained on a singular line, whereas benign scripts typically have more structure and include multiple new-lines.\r\n \tObfuscation - This is a case where the script profiles the content for various attributes like character frequency, volume of symbol usage, and volume of variable declarations. These attributes are counted in various ways and highlight observed characteristics of malicious scripts.\r\n\r\n \tCharacter frequency analysis reflects standard deviations of character usage that were observed across malicious and benign script sample sets and, for example, will try to identify if \u201cw\u201d is used more than 500 times in the script, or a colon \u201c:\u201d used more than 100 times. There are 13 individual characters that fall into this category and 3 sets of dual characters (\u201c[\u201c and \u201c]\u201d) which come into play if the script has less than 50 lines; this is usually indicative of a dense clustering of the characters.\r\n \tSymbol usage is a specific type of obfuscation that I kept observed being used for variable declarations, such as below.\r\n\r\n\r\n\r\n${\/=\\__\/==\\_\/\\\/==\\_} = [AppDomain]::CurrentDomain\r\n\r\n \t\r\n\r\n \tRaw volume of PowerShell and JavaScript unique variable declarations over 40.\r\n\r\n\r\n\r\n3. Variable Extension - Another common obfuscation is taking advantage of\r\nPowerShell\u2019s ability to use wildcards (\u201c*\u201d) in variables. The profiling script will\r\ncount various commands for retrieving or setting variables and then count\r\nwildcards surrounded by ASCII characters. If those counts are over a certain\r\namount than it\u2019ll label the obfuscation type as variable extension. To show how it\r\nworks, the following code can be used to retrieve \u201cExecutionContext\u201d and are\r\noften seen chained together to build out other commands.\r\nGet-Item Variable:*xec*t\r\nExecutionContext\r\nIn general, the neutral behaviors are scored much lower so that multiple behaviors being flagged won\u2019t generally be enough on their own to cross the established malicious threshold.\r\nBenign Behaviors\r\n\r\n \t'Script Logging': -1.0\r\n \t'License': -2.0\r\n \t'Function Body': -2.0\r\n \t'Positive Context': -3.0\r\n\r\nThe benign behaviors rarely show up in malicious scripts and subtract from the overall score to help influence the context, subtracting from the totals to improve accuracy. For example, malicious scripts typically do not employ logging, licenses, or function preambles. The keyword here being \u201ctypically\u201d as sometimes you will find cases where the attacker downloads a script from a PowerShell offensive framework via Github and don\u2019t bother to clean it up. In these cases, there is almost always significant amounts of non-obfuscated behaviors to make up for any drops in score.\r\n\r\nFinally, \u201cPositive Context\u201d are specifically used when benign scripts exhibit so many behaviors it crosses the malicious threshold and I want to try and artificially lower their scores. This is more common when dealing with administrative type scripts found in enterprises that perform a wide sweeping range of administrative functions on an endpoint or bootstrap systems.\r\nConclusion\r\nIn this blog I covered common PowerShell techniques for hiding data that I have observed and shown how these can be cleaned up with normalization and by reversing various types of obfuscation. This is a critical step before furtherer unraveling content that will be used as the base for behavioral profiling.\r\n\r\nFor the next blog in this series, I\u2019ll take more of an in-depth look at how all of these things work together to profile scripts and talk about some observations I\u2019ve made when it comes to statically analyzing PowerShell scripts.\r\n\r\n&nbsp;","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2019\/10\/Vulnerability-r3d2-150x150.png","width":150,"height":150},"author":[{"@type":"Person","name":"Jeff White"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"100430","token":"b09d8c8c9d","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=100430' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-100430 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 2)</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-100430 entry-meta">
			
			
			<span class="post-views-count">15,291</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'100430','like')"><i class="ui ui-2"></i><span class="ml-5">8</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 14</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2%2F+-+Practical+Behavioral+Profiling+of+PowerShell+Scripts+through+Static+Analysis+%28Part+2%29" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2%2F&title=Practical+Behavioral+Profiling+of+PowerShell+Scripts+through+Static+Analysis+%28Part+2%29&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/jeff-white/" title="Posts by Jeff White" class="author url fn" rel="author">Jeff White</a>        </p>
        <p><time datetime="2019-10-24T13:00:11+00:00">October 24, 2019 at 6:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit-42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/malware/" rel="tag">malware</a>, <a href="https://unit42.paloaltonetworks.com/tag/obfuscation/" rel="tag">obfuscation</a>, <a href="https://unit42.paloaltonetworks.com/tag/powershell/" rel="tag">Powershell</a>, <a href="https://unit42.paloaltonetworks.com/tag/powershell-scripts/" rel="tag">PowerShell Scripts</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="768" height="384" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/05/Vulnerability-r3d2-768x384.png" class="attachment-single size-single" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/05/Vulnerability-r3d2-768x384.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/05/Vulnerability-r3d2-768x384-300x150.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/05/Vulnerability-r3d2-768x384-370x185.png 370w" sizes="(max-width: 768px) 100vw, 768px" />            </figure>
                    <p class="wpml-ls-statics-post_translations wpml-ls">This post is also available in: 
    <span class="wpml-ls-slot-post_translations wpml-ls-item wpml-ls-item-ja wpml-ls-first-item wpml-ls-last-item wpml-ls-item-legacy-post-translations"><a href="https://unit42.paloaltonetworks.jp/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/" class="wpml-ls-link"><span class="wpml-ls-native" lang="ja">日本語</span><span class="wpml-ls-display"><span class="wpml-ls-bracket"> (</span>Japanese<span class="wpml-ls-bracket">)</span></span></a></span></p><h2>Executive Summary</h2>
<p><span style="font-size: 12pt; font-family: georgia, palatino, serif;">This 3-part blog series focuses on a practical approach to static analysis of PowerShell scripts and developing a platform-independent Python script to carry out this task. This is Part 2 of a 3-part blog series and you can read Part 1 <a href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-1/">here</a> to get caught up.</span></p>
<p><span style="font-size: 12pt; font-family: georgia, palatino, serif;">Over the course of the series, I will talk about the ins and outs of behavioral profiling, cover common obfuscation and methods of hiding data within PowerShell scripts, and how we can go about building a scoring system to assess the risks of scripts. In general, I aim to aide other analysts and defenders in this endeavor with ideas and a functional foundation script to hit the ground running.</span></p>
<h2>Introduction</h2>
<p>In the first part of this blog, I touched on some general concepts around static analysis, behaviors in PowerShell, and things I needed to consider as I moved into the design phase, which will be the focus of this second blog.</p>
<p>My overarching goal is to profile behaviors and infer their intent in PowerShell scripts so I’ll begin by looking at the script input first. Next, I’ll cover the general process of normalizing and de-obfuscating common PowerShell obfuscation and code hiding techniques that you’ll see in-the-wild (ITW) and provide examples of how script content is modified during processing to reveal more data. Finally, we’ll take a look at the behaviors I’ve identified as important for scoring and how they play into the overall assessment of risk in scoring.</p>
<h4>PowerShell Script Input</h4>
<p>Input can come in many flavors but for the sake of simplicity, I’ll limit this discussion to PowerShell scripts and not other files which may contain PowerShell commands or embedded scripts, such as ScriptBlock Logs, VBScript, and JavaScript. Regardless of the type, it all begins the same way with preparing the data for processing throughout the rest of the script.</p>
<p>In this case, it’s fairly straightforward to start. As I’ll be dealing heavily with REGEX and string matching on ASCII based character sets used to define function names and other keywords in PowerShell, I need to remove the NULL bytes from the input data so that character encoding is less of a problem down the line. If you’re not familiar with the default Windows code pages or Unicode, just know that they utilize two bytes to represent a character but, for our use-case, we are only interested in the characters which fall in the ASCII range. In a two-byte code page, which deals with the character encoding, the first byte will be NULL. For example, if we wanted to search for an exact match of the word “HELLO” but there are NULL bytes pre-pending each byte representing a character in the ASCII range, then this can lead to matching issues so we’ll strip them out.</p>
<p>The string “\x00H\x00E\x00L\x00L\x00O” becomes simply “HELLO”. This establishes a uniformity in characters to match against before I move the data further downstream for processing.</p>
<h4>Preparing Content for Profiling</h4>
<p>To accurately profile the PowerShell behaviors, I need to normalize and de-obfuscate as much of the content as possible so that I have the highest opportunity of identifying behaviors in the content; whether they are in plain sight, hidden under multiple layers of obfuscation, or buried within various encoding algorithms.</p>
<p>To do this, the script creates two sets of data from the original content that will be scanned over continuously; one which contains the original content, sans the NULL bytes described earlier, and an alternate one wherein the script builds up new content that it discovers during processing. Sometimes there is little deviation from the original content and it’s entirely driven based on identifying the obfuscation and content hiding methods that may have been employed.</p>
<p>There are two distinct phases here for preparing the content for profiling. One is for cleaning up the content and removing various types of obfuscation and one is for trying to unravel the various ways of burying data within the code that PowerShell supports, such as encryption, compression, and encoding. I’ll step through each of these phases and go over the existing functions that I’ve built into the script to achieve these goals but, before I move on, I need to talk about general obfuscation and how I approached processing.</p>
<p>When you analyze malicious scripts, you’ll frequently find multiple layers and types of obfuscation all contained within a script. What this means is that when the script removes obfuscation from code, it potentially reveals a new code that also needs to be analyzed again to see if it contains more obfuscation or requires more normalization and the process repeats itself. Given this, there needs to be a way to track the state of code and it’s subsequent alteration so that the script can continue processing it until the state fails to change, this workflow is shown in the figure below.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-7.-High-level-Processing-Flow.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100439" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-7.-High-level-Processing-Flow.png" alt="" width="600" height="490" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-7.-High-level-Processing-Flow.png 634w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-7.-High-level-Processing-Flow-300x245.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-7.-High-level-Processing-Flow-370x302.png 370w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 7. High-level Processing Flow</em></span></p>
<p>At a high level, this is relatively straight forward but in practice, there are more practical issues you may run into, such as the order in which the script process different types of obfuscation. These considerations and the order of de-obfuscation or normalization I use in the script were derived over the course of testing and iteration.</p>
<p>As the profiling script is not executing the code, I’m less concerned with unraveling a functional script and more interested in unraveling the raw content; however, when the profiling script does attempt to reverse obfuscation than I try to maintain the integrity of the underlying code where possible. Once the state finally stops changing, the profiling script can move into the behavioral profiling process.</p>
<p>In the current iteration, there are numerous functions for normalizing and unraveling content so I’ll dive into each of them, what their intent is, and discuss how they affect the code.</p>
<h4>Normalization / Obfuscation Removal</h4>
<p>The identification of obfuscation is typically handled with simple searches or REGEX matches when dealing with non-single character obfuscation. Given the flexibility of PowerShell, you’ll run across dozens of variations for the same commands that can be used so the REGEX patterns I’ve created are designed to capture as many variants as possible, but there is always room for improvement and those included in the script just capture the variants found in my sample set.</p>
<p>To illustrate this idea, consider the following REGEX pattern for capturing variants of the Format String Operator Replacement technique.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972267442371522" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-mixed-highlight" title="Contains Mixed Languages"></span><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
\((?:\s*)(\"|\')((?:\s*)\{[0-9]{1,3}\}(?:\s*))+\1(?:\s*)-[fF](?:
\s*)(\"|\').+?(\"|\')(?:\s*)\)(?![^)])</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972267442371522-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972267442371522-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972267442371522-1"><span class="crayon-sy">\</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-v">s</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">\</span>"<span class="crayon-o">|</span><span class="crayon-sy">\</span>'<span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-e ">s*</span><span class="crayon-sy">)</span><span class="crayon-sy">\</span><span class="crayon-sy">{</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">-</span><span class="crayon-cn">9</span><span class="crayon-sy">]</span><span class="crayon-sy">{</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-cn">3</span><span class="crayon-sy">}</span><span class="crayon-sy">\</span><span class="crayon-sy">}</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-e ">s*</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-sy">\</span><span class="crayon-cn">1</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-e ">s*</span><span class="crayon-sy">)</span><span class="crayon-o">-</span><span class="crayon-sy">[</span><span class="crayon-v">fF</span><span class="crayon-sy">]</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972267442371522-2"><span class="crayon-sy">\</span><span class="crayon-e ">s*</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">\</span>"<span class="crayon-o">|</span><span class="crayon-sy">\</span>'<span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-o">+</span><span class="crayon-sy">?</span><span class="crayon-sy">(</span><span class="crayon-sy">\</span>"<span class="crayon-o">|</span><span class="crayon-sy">\</span>'<span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-e ">s*</span><span class="crayon-sy">)</span><span class="crayon-sy">\</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">?</span><span class="crayon-o">!</span><span class="crayon-sy">[</span><span class="crayon-o">^</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>Which can match on things like the following:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997226e143314133" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
("{1}{0}" -F"exa" ,"mple")
( " {0} " -F "example")
( "{1} {0} " -F 'exa' , "mple" )</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997226e143314133-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997226e143314133-2">2</div><div class="crayon-num" data-line="crayon-5f6928997226e143314133-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997226e143314133-1"><span class="crayon-sy">(</span><span class="crayon-s">"{1}{0}"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">F</span><span class="crayon-s">"exa"</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-s">"mple"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997226e143314133-2"><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-s">" {0} "</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">F</span><span class="crayon-h"> </span><span class="crayon-s">"example"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5f6928997226e143314133-3"><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-s">"{1} {0} "</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">F</span><span class="crayon-h"> </span><span class="crayon-s">'exa'</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"mple"</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Basic single-character obfuscation will be removed from the content during processing while the more complex ones will replace the content blocks inline. For each type of obfuscation dealt with, I’ll provide a brief description and a real world example of it in action and what it should transform into.</p>
<p>1. Backticks (`) are used for escaping characters in PowerShell and wrapping lines of code. It’s commonly used in<br />
obfuscation to escape non-special characters and break-up words to prevent matching.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972270462372077" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
if ( ${CoM`P`U`TERn`AME} -eq ${Nu`LL}
if ( ${CoMPUTERnAME} -eq ${NuLL}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972270462372077-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972270462372077-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972270462372077-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">CoM</span><span class="crayon-sy">`</span><span class="crayon-v">P</span><span class="crayon-sy">`</span><span class="crayon-v">U</span><span class="crayon-sy">`</span><span class="crayon-v">TERn</span><span class="crayon-sy">`</span><span class="crayon-v">AME</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">eq</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">Nu</span><span class="crayon-sy">`</span><span class="crayon-v">LL</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972270462372077-2"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">CoMPUTERnAME</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">eq</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-t">NuLL</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>2. Carets (^) are escape characters for Windows command line and when you find mixed scripting languages you’ll<br />
frequently see this.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972271481613415" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
echo i^eX(^"^I^e^`X^`
echo ieX("Ie`X`</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-5f69289972271481613415-1">1</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-5f69289972271481613415-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line crayon-marked-line crayon-top" id="crayon-5f69289972271481613415-1"><span class="crayon-i">echo</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">^</span><span class="crayon-v">eX</span><span class="crayon-sy">(</span><span class="crayon-o">^</span><span class="crayon-s">"^I^e^`X^`</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-5f69289972271481613415-2"><span class="crayon-s">echo ieX("</span><span class="crayon-v">Ie</span><span class="crayon-sy">`</span><span class="crayon-v">X</span><span class="crayon-sy">`</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>3. Escaped Quotes (\”) are most commonly seen for substrings that need to be escaped and we’ll want to remove the<br />
escaping so we can accurately profile across that boundary, where a backslash may interfere with pattern matching. In<br />
malicious scripts, these substrings are frequently commands which will be unraveled or passed to new instances of<br />
PowerShell that can be profiled further. Additionally, it can be used to insert empty quotes for additional obfuscation<br />
like below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972272734655862" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
(g\'\'v KUs).value.toString()
(g''v KUs).value.toString()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972272734655862-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972272734655862-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972272734655862-1"><span class="crayon-sy">(</span><span class="crayon-v">g</span><span class="crayon-sy">\</span>'<span class="crayon-sy">\</span>'<span class="crayon-i">v</span><span class="crayon-h"> </span><span class="crayon-v">KUs</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972272734655862-2"><span class="crayon-sy">(</span><span class="crayon-i">g</span><span class="crayon-s">''</span><span class="crayon-i">v</span><span class="crayon-h"> </span><span class="crayon-v">KUs</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>4. Empty Quotes (“”) are another trick that can be used to break up variables in PowerShell and otherwise break string<br />
matching, so I remove those when necessary.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972273809160142" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
(g''v KUs).value.toString()
(gv KUs).value.toString()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972273809160142-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972273809160142-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972273809160142-1"><span class="crayon-sy">(</span><span class="crayon-i">g</span><span class="crayon-s">''</span><span class="crayon-i">v</span><span class="crayon-h"> </span><span class="crayon-v">KUs</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972273809160142-2"><span class="crayon-sy">(</span><span class="crayon-e">gv </span><span class="crayon-v">KUs</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">value</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>5. Spaces ( ) can be used to obfuscate in a way that is similar to CaMeL CaSe capitalization; it’s used to confuse the reader<br />
without causing issues with how PowerShell interprets the code.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972274115799621" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
-EX uNrEsTRIcteD -nOP -W HIdDEn 
-eC-EX uNrEsTRIcteD -nOP -W HIdDEn -eC</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972274115799621-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972274115799621-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972274115799621-1"><span class="crayon-o">-</span><span class="crayon-e">EX </span><span class="crayon-v">uNrEsTRIcteD</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">nOP</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">W</span><span class="crayon-h"> </span><span class="crayon-v">HIdDEn</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972274115799621-2"><span class="crayon-o">-</span><span class="crayon-v">eC</span><span class="crayon-o">-</span><span class="crayon-e">EX </span><span class="crayon-v">uNrEsTRIcteD</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">nOP</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">W</span><span class="crayon-h"> </span><span class="crayon-v">HIdDEn</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">eC</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>6. Concatenation (+) of strings is another common technique for breaking up strings so the profiling script attempts to<br />
rebuild them. There are many ways of doing concatenation but this one focuses on the use of the addition symbol.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972275841078435" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
New-Object $("Sys"+"tem.Refl"+"ection.Ass"+"embl"+"yName")
New-Object $("System.Reflection.AssemblyName")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972275841078435-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972275841078435-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972275841078435-1"><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">"Sys"</span><span class="crayon-o">+</span><span class="crayon-s">"tem.Refl"</span><span class="crayon-o">+</span><span class="crayon-s">"ection.Ass"</span><span class="crayon-o">+</span><span class="crayon-s">"embl"</span><span class="crayon-o">+</span><span class="crayon-s">"yName"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972275841078435-2"><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-s">"System.Reflection.AssemblyName"</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<ul>
<li>Type Conversion is another technique it looks for as the technique is commonly used for string obfuscation. This is the first of the “brute force” functions in which the profiling script iterate over multiple base values (base8, base16, and base32) to build possible strings, along with trying to identify integers and hexadecimal values stored in lists that can be converted to ASCII.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972276384809817" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
(‘6e,6f,74,65,70,61,64'.SPLiT(‘,’) |fOREAch {( [cHar]([COnVERt]::tOINt16(([STRINg]$_ ) ,16 ))) })-jOIn '')
Notepad</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972276384809817-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972276384809817-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972276384809817-1"><span class="crayon-sy">(</span>‘<span class="crayon-cn">6e</span><span class="crayon-sy">,</span><span class="crayon-cn">6f</span><span class="crayon-sy">,</span><span class="crayon-cn">74</span><span class="crayon-sy">,</span><span class="crayon-cn">65</span><span class="crayon-sy">,</span><span class="crayon-cn">70</span><span class="crayon-sy">,</span><span class="crayon-cn">61</span><span class="crayon-sy">,</span><span class="crayon-cn">64</span><span class="crayon-s">'.SPLiT(‘,’) |fOREAch {( [cHar]([COnVERt]::tOINt16(([STRINg]$_ ) ,16 ))) })-jOIn '</span>'<span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972276384809817-2"><span class="crayon-v">Notepad</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<ul>
<li>Splitting, as seen above, goes hand in hand with conversion and you’ll frequently see in malicious scripts this obfuscation using a range of characters to split integers or hexadecimal values. In these cases, the script again takes a shotgun approach to strip out contiguous sets of values and try to decipher as much plain text as possible.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972278690596126" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
27R2cQ20i27p27{29hdQa{7dpd~a'.SPLiT('{p}hiRQ~' )|
27 2c 20 27 27 29 d a 7d d a</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972278690596126-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972278690596126-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972278690596126-1"><span class="crayon-cn">27R2cQ20i27p27</span><span class="crayon-sy">{</span><span class="crayon-cn">29hdQa</span><span class="crayon-sy">{</span><span class="crayon-cn">7dpd</span><span class="crayon-o">~</span><span class="crayon-i">a</span><span class="crayon-s">'.SPLiT('</span><span class="crayon-sy">{</span><span class="crayon-v">p</span><span class="crayon-sy">}</span><span class="crayon-v">hiRQ</span><span class="crayon-o">~</span>'<span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-o">|</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972278690596126-2"><span class="crayon-cn">27</span><span class="crayon-h"> </span><span class="crayon-cn">2c</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-h"> </span><span class="crayon-cn">27</span><span class="crayon-h"> </span><span class="crayon-cn">27</span><span class="crayon-h"> </span><span class="crayon-cn">29</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-cn">7d</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-v">a</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Last, there are two more obfuscation types the profiling script tackles that are a bit more complicated in terms of identification and parsing due to PowerShells flexibility in how things can be called.</p>
<p>7. Format String Operator Replacement has seen a sharp rise of adoption rates in<br />
malicious scripts ever since <a href="https://twitter.com/danielhbohannon">Daniel Bohannon</a> released <a href="https://github.com/danielbohannon/Invoke-Obfuscation">Invoke-Obfuscation</a> that uses<br />
this token-style replacement heavily. The functions for statically parsing these with<br />
REGEX require that it considers nested layers of operator replacement, so it targets<br />
smaller inner-versions first and slowly unravels it from the inside-out. It’ll substitute<br />
the parsed string with the replacement command until it’s unable to identify anymore<br />
variants in the content.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972279162186778" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
('V'+("{1}{0}" -f 'b',("{1}{0}" -f 'A','aRi'))+'Le:'
('VaRiAbLe:'</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972279162186778-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972279162186778-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972279162186778-1"><span class="crayon-sy">(</span><span class="crayon-s">'V'</span><span class="crayon-o">+</span><span class="crayon-sy">(</span><span class="crayon-s">"{1}{0}"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-s">'b'</span><span class="crayon-sy">,</span><span class="crayon-sy">(</span><span class="crayon-s">"{1}{0}"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-s">'A'</span><span class="crayon-sy">,</span><span class="crayon-s">'aRi'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-s">'Le:'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972279162186778-2"><span class="crayon-sy">(</span><span class="crayon-s">'VaRiAbLe:'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>8. For PowerShell’s built-in string replacement function, the script again uses a REGEX<br />
pattern to identify the many variations possible for this command and attempts to<br />
replace strings across the content.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997227a878316500" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
OUT-fILe ("C:c4yprogramdatac4yerror.txt").rEpLAce(("c4y"),'\')'
OUT-fILe ("C:\programdata\error.txt")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997227a878316500-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997227a878316500-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997227a878316500-1"><span class="crayon-v">OUT</span><span class="crayon-o">-</span><span class="crayon-e">fILe</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"C:c4yprogramdatac4yerror.txt"</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">rEpLAce</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-s">"c4y"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-s">'\')'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997227a878316500-2"><span class="crayon-v">OUT</span><span class="crayon-o">-</span><span class="crayon-e">fILe</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"C:\programdata\error.txt"</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>These sets of de-obfuscation and normalization functions will be run and re-run again as new content is discovered or the state of the existing data changes.</p>
<h4>Unraveling Content</h4>
<p>Similar to the above functions for de-obfuscation and normalization of content for profiling, the script also scans the content for certain artifacts to determine if there is additional content that may unraveled. In this next section, I’ll step through the various methods it uses to identify and reveal the content statically.</p>
<ul>
<li>Reversed content is one of the simpler types it’ll deal with and, in my experience, isn’t actually that common. In this case, it simply looks for reversed strings of common PowerShell methods and then take the entire content, reverses it, and appends it to the end of the alternate content stream.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997227b647389053" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
RAHC[+58]RAHC[+501]RAHC[((eCALpEr.)93]RAHC[]GNirtS[,'V3wfe'(eCALpEr.)).rEpLACe('efw3V',[StriNG][CHAR]39
).rEpLACe(([CHAR]105+[CHAR]85+[CHAR</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997227b647389053-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997227b647389053-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997227b647389053-1"><span class="crayon-v">RAHC</span><span class="crayon-sy">[</span><span class="crayon-o">+</span><span class="crayon-cn">58</span><span class="crayon-sy">]</span><span class="crayon-v">RAHC</span><span class="crayon-sy">[</span><span class="crayon-o">+</span><span class="crayon-cn">501</span><span class="crayon-sy">]</span><span class="crayon-v">RAHC</span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">eCALpEr</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span><span class="crayon-cn">93</span><span class="crayon-sy">]</span><span class="crayon-v">RAHC</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-v">GNirtS</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-s">'V3wfe'</span><span class="crayon-sy">(</span><span class="crayon-v">eCALpEr</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">rEpLACe</span><span class="crayon-sy">(</span><span class="crayon-s">'efw3V'</span><span class="crayon-sy">,</span><span class="crayon-sy">[</span><span class="crayon-t">StriNG</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-t">CHAR</span><span class="crayon-sy">]</span><span class="crayon-cn">39</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997227b647389053-2"><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">rEpLACe</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-t">CHAR</span><span class="crayon-sy">]</span><span class="crayon-cn">105</span><span class="crayon-o">+</span><span class="crayon-sy">[</span><span class="crayon-t">CHAR</span><span class="crayon-sy">]</span><span class="crayon-cn">85</span><span class="crayon-o">+</span><span class="crayon-sy">[</span><span class="crayon-t">CHAR</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p></p>
<ul>
<li>Another common method of hiding content from view is to utilize the Windows Stream objects which are effectively a class used to encode content. In this case, the profiling script identifies if the calls exist within the visible content and then attempts to deflate the stream. By default, Microsoft uses the same compression algorithm as gzip but the script will attempt to brute force it with a couple of different compression settings to expand coverage.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997227d070979219" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
New-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String('Cy/KLEnV9cgvLlFQz0jNycnXUSjPL8pJUVQHAA=='),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()
Write-Host 'hello, world!'</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997227d070979219-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997227d070979219-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997227d070979219-1"><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-sy">;</span><span class="crayon-e">iex</span><span class="crayon-sy">(</span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-e">StreamReader</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-v">Compression</span><span class="crayon-sy">.</span><span class="crayon-e">DeflateStream</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-v">MemoryStream</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FromBase64String</span><span class="crayon-sy">(</span><span class="crayon-s">'Cy/KLEnV9cgvLlFQz0jNycnXUSjPL8pJUVQHAA=='</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-sy">[</span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-v">Compression</span><span class="crayon-sy">.</span><span class="crayon-v">CompressionMode</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">Decompress</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ReadToEnd</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997227d070979219-2"><span class="crayon-v">Write</span><span class="crayon-o">-</span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-s">'hello, world!'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<ul>
<li>Next is Base64, which is probably the most basic and universal encoding scheme around. Nothing fancy here but so it just takes every piece of content which matches a REGEX pattern for Base64 over a certain size (currently 30 bytes), decodes it, and append it to the alternate data stream for profiling.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997227f748075452" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
RAB5AG4AYQBtAGkAYwBBAHMAcwBlAG0AYgBsAHkA
DynamicAssembly</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997227f748075452-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997227f748075452-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997227f748075452-1"><span class="crayon-e">RAB5AG4AYQBtAGkAYwBBAHMAcwBlAG0AYgBsAHkA</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997227f748075452-2"><span class="crayon-v">DynamicAssembly</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<ul>
<li>Finally, there is some basic decryption of Microsoft SecureStrings which use the default AES in CBC mode when the SecureString is created with a key. The script looks for the calls to decrypt these SecureStrings and then tries to identify the symmetric encryption key, all of the Base64 content, and the required IV to decrypt the content. I’ve yet to see this technique used in-the-wild (ITW) for a small amount of data that I could use for illustrative purposes so I’ve cobbled together a quick example instead.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972282622499911" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
&gt; $SecureString = ConvertTo-SecureString "EXAMPLE" 
-AsPlainText -Force
&gt; $StandardString = ConvertFrom-SecureString $SecureString
&gt; $Key = 
(68,111,110,116,72,105,114,101,84,111,109,76,97,110,99,97,1
15,116,101,114,70,65,67,84)
&gt; $StandardString = ConvertFrom-SecureString $SecureString 
-Key $Key
&gt; $StandardString

76492d1116743f0423413b16050a5345MgB8AFAAZQBHAHoAeABvAG0AVAA
5AGkAQgA1AEEATABsAGoANABnAFgATABSAFEAPQA9AHwAMAA0ADQANQBiAD
EANQA2ADIAYgA3AGQAMwBmADIAZgA1ADYAYgA5AGUAZgAwADAAMgAyADYAZ
QAzAGMAMQAzAA==</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972282622499911-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-2">2</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-4">4</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-6">6</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-8">8</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-10">10</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-12">12</div><div class="crayon-num" data-line="crayon-5f69289972282622499911-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972282622499911-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972282622499911-1"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">SecureString</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ConvertTo</span><span class="crayon-o">-</span><span class="crayon-i">SecureString</span><span class="crayon-h"> </span><span class="crayon-s">"EXAMPLE"</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-2"><span class="crayon-o">-</span><span class="crayon-v">AsPlainText</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Force</span></div><div class="crayon-line" id="crayon-5f69289972282622499911-3"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">StandardString</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ConvertFrom</span><span class="crayon-o">-</span><span class="crayon-i">SecureString</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">SecureString</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-4"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">Key</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5f69289972282622499911-5"><span class="crayon-sy">(</span><span class="crayon-cn">68</span><span class="crayon-sy">,</span><span class="crayon-cn">111</span><span class="crayon-sy">,</span><span class="crayon-cn">110</span><span class="crayon-sy">,</span><span class="crayon-cn">116</span><span class="crayon-sy">,</span><span class="crayon-cn">72</span><span class="crayon-sy">,</span><span class="crayon-cn">105</span><span class="crayon-sy">,</span><span class="crayon-cn">114</span><span class="crayon-sy">,</span><span class="crayon-cn">101</span><span class="crayon-sy">,</span><span class="crayon-cn">84</span><span class="crayon-sy">,</span><span class="crayon-cn">111</span><span class="crayon-sy">,</span><span class="crayon-cn">109</span><span class="crayon-sy">,</span><span class="crayon-cn">76</span><span class="crayon-sy">,</span><span class="crayon-cn">97</span><span class="crayon-sy">,</span><span class="crayon-cn">110</span><span class="crayon-sy">,</span><span class="crayon-cn">99</span><span class="crayon-sy">,</span><span class="crayon-cn">97</span><span class="crayon-sy">,</span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-6"><span class="crayon-cn">15</span><span class="crayon-sy">,</span><span class="crayon-cn">116</span><span class="crayon-sy">,</span><span class="crayon-cn">101</span><span class="crayon-sy">,</span><span class="crayon-cn">114</span><span class="crayon-sy">,</span><span class="crayon-cn">70</span><span class="crayon-sy">,</span><span class="crayon-cn">65</span><span class="crayon-sy">,</span><span class="crayon-cn">67</span><span class="crayon-sy">,</span><span class="crayon-cn">84</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5f69289972282622499911-7"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">StandardString</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ConvertFrom</span><span class="crayon-o">-</span><span class="crayon-i">SecureString</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">SecureString</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-8"><span class="crayon-o">-</span><span class="crayon-i">Key</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">Key</span></div><div class="crayon-line" id="crayon-5f69289972282622499911-9"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-i">StandardString</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-10">&nbsp;</div><div class="crayon-line" id="crayon-5f69289972282622499911-11"><span class="crayon-cn">76492d1116743f0423413b16050a5345MgB8AFAAZQBHAHoAeABvAG0AVAA</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-12"><span class="crayon-cn">5AGkAQgA1AEEATABsAGoANABnAFgATABSAFEAPQA9AHwAMAA0ADQANQBiAD</span></div><div class="crayon-line" id="crayon-5f69289972282622499911-13"><span class="crayon-e">EANQA2ADIAYgA3AGQAMwBmADIAZgA1ADYAYgA5AGUAZgAwADAAMgAyADYAZ</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972282622499911-14"><span class="crayon-v">QAzAGMAMQAzAA</span><span class="crayon-o">==</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>The string “EXAMPLE” is encrypted by the 24 bytes and a Base64 value is returned. The inner contents of this Base64 blob, which appear to be a non-publicly documented structure, contain the encrypted string and a Base64 encoded IV. The values are pipe (“|”) delimited so I’ve highlighted the IV in RED and the encrypted data in BLUE. These are what the function will target for decryption.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972284098006797" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
\xef\xae=\
xd9\xddu\xd7\xae\xf8\xdd\xfd8\xdb~5\xdd\xbdz\xd3\x9d\x1a\xe7~92|&lt;span style="color: #ff0000;"&gt;&lt;strong&gt;PeGzxomT9iB5ALlj4gXLRQ==&lt;/strong&gt;&lt;/span&gt;|&lt;span style="color: #0000ff;"&gt;&lt;strong&gt;0445b1562b7d3f2f56b
9ef00226e3c13&lt;/strong&gt;&lt;/span&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972284098006797-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972284098006797-2">2</div><div class="crayon-num" data-line="crayon-5f69289972284098006797-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972284098006797-1"><span class="crayon-sy">\</span><span class="crayon-v">xef</span><span class="crayon-sy">\</span><span class="crayon-v">xae</span><span class="crayon-o">=</span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972284098006797-2"><span class="crayon-v">xd9</span><span class="crayon-sy">\</span><span class="crayon-v">xddu</span><span class="crayon-sy">\</span><span class="crayon-v">xd7</span><span class="crayon-sy">\</span><span class="crayon-v">xae</span><span class="crayon-sy">\</span><span class="crayon-v">xf8</span><span class="crayon-sy">\</span><span class="crayon-v">xdd</span><span class="crayon-sy">\</span><span class="crayon-v">xfd8</span><span class="crayon-sy">\</span><span class="crayon-v">xdb</span><span class="crayon-o">~</span><span class="crayon-cn">5</span><span class="crayon-sy">\</span><span class="crayon-v">xdd</span><span class="crayon-sy">\</span><span class="crayon-v">xbdz</span><span class="crayon-sy">\</span><span class="crayon-v">xd3</span><span class="crayon-sy">\</span><span class="crayon-v">x9d</span><span class="crayon-sy">\</span><span class="crayon-v">x1a</span><span class="crayon-sy">\</span><span class="crayon-v">xe7</span><span class="crayon-o">~</span><span class="crayon-cn">92</span><span class="crayon-o">|</span><span class="crayon-o">&lt;</span><span class="crayon-e">span </span><span class="crayon-v">style</span><span class="crayon-o">=</span><span class="crayon-s">"color: #ff0000;"</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-v">strong</span><span class="crayon-o">&gt;</span><span class="crayon-v">PeGzxomT9iB5ALlj4gXLRQ</span><span class="crayon-o">==</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">strong</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">span</span><span class="crayon-o">&gt;</span><span class="crayon-o">|</span><span class="crayon-o">&lt;</span><span class="crayon-e">span </span><span class="crayon-v">style</span><span class="crayon-o">=</span><span class="crayon-s">"color: #0000ff;"</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-v">strong</span><span class="crayon-o">&gt;</span><span class="crayon-cn">0445b1562b7d3f2f56b</span></div><div class="crayon-line" id="crayon-5f69289972284098006797-3"><span class="crayon-cn">9ef00226e3c13</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">strong</span><span class="crayon-o">&gt;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">span</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>This overview covers all of the techniques I’ve found to be commonly used throughout malicious scripts, along with various types of de-obfuscation or normalization needed to reveal further content. While this by no means is intended to coverage of everything, it’s a good base to start from.</p>
<h4>Profiling Known Malware Families</h4>
<p>Once the profiling script has as much of the content revealed as possible, it then begins the identification phase. The script starts with first trying to look for known malware families and variants of them as this provides a quick way to score files based off of known indicators and establish intent very quickly. These are primarily REGEX patterns or collections of keywords that uniquely identify malicious scripts such as <a href="https://github.com/trustedsec/unicorn">Magic Unicorn</a>, <a href="https://github.com/trustedsec/social-engineer-toolkit">Social Engineer Toolkit (SET)</a>, and <a href="https://github.com/Veil-Framework">Veil</a>. The full list of the currently checked families are below and this section can be added to when new popular formats start appearing ITW.</p>
<ul>
<li>Magic Unicorn</li>
<li>ShellCode Injector</li>
<li>ICMP Shell</li>
<li>SET</li>
<li>PowerDump</li>
<li>BashBunny</li>
<li>Veil</li>
<li>PowerWorm</li>
<li>PowerShell Empire</li>
<li>Powerfun</li>
<li>Mimikatz</li>
<li>Mimikittenz</li>
<li>PowerSploit</li>
<li>DynAmite</li>
<li>Invoke-Obfuscation</li>
<li>TXT C2</li>
<li>Remote DLL</li>
<li>Cobalt Strike</li>
<li>Vdw0rm</li>
<li>Emotet</li>
<li>mateMiner</li>
<li>DownAndExec</li>
<li>Buckeye</li>
<li>APT34</li>
<li>MuddyWater</li>
<li>Tennc Webshell</li>
<li>PoshC2</li>
<li>Posh-SecMod</li>
<li>Invoke-TheHash</li>
<li>Nishang</li>
<li>Invoke-CradleCrafter</li>
</ul>
<p>These were all derived through the aforementioned manual analysis or from <a href="https://github.com/karttoon/curtaincuckoo">previous research</a>. Whenever I found that I was seeing repeating scripts, or structures of scripts, it was a good indicator that it was generated from a framework or script and those usually lend themselves to profiling quite well. Again, it’s not full coverage for any of the above but as you identify new variants or new families, you can add them as a way to expand your coverage.</p>
<h4>Profiling PowerShell Behaviors</h4>
<p>Next we move to the actual profiling of PowerShell behaviors. These are broken into three distinct contextual categories &#8211; behaviors generally only seen in malicious scripts, behaviors generally seen in both good and bad scripts (neutral), and finally behaviors generally only seen in benign scripts.</p>
<p><img class="aligncenter wp-image-100433" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/word-image-33.png" alt="" width="539" height="344" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/word-image-33.png 539w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/word-image-33-300x191.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/word-image-33-370x236.png 370w" sizes="(max-width: 539px) 100vw, 539px" /></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 8. Venn Diagram of behavioral overlap</em></span></p>
<p>I’ll list all of them below and their corresponding scores (taken directly from the script) while covering some basics of how they work.</p>
<h4>Negative Behaviors</h4>
<ul>
<li>&#8216;Code Injection&#8217;: 10.0</li>
<li>&#8216;Key Logging&#8217;: 3.0</li>
<li>&#8216;Screen Scraping&#8217;: 2.0</li>
<li>&#8216;AppLocker Bypass&#8217;: 2.0</li>
<li>&#8216;AMSI Bypass&#8217;: 2.0</li>
<li>&#8216;Clear Logs&#8217;: 2.0</li>
<li>&#8216;Coin Miner&#8217;: 6.0</li>
<li>&#8216;Embedded File&#8217;: 4.0</li>
<li>&#8216;Abnormal Size&#8217;: 2.0</li>
<li>&#8216;Ransomware&#8217;: 10.0</li>
<li>&#8216;DNS C2&#8217;: 2.0</li>
<li>&#8216;Disabled Protections&#8217;: 4.0</li>
<li>&#8216;Negative Context&#8217;: 10.0</li>
<li>&#8216;Malicious Behavior Combo&#8217;: 6.0</li>
<li>&#8216;Known Malware&#8217;: 10.0</li>
</ul>
<p>Keep in mind that we’re trying to place a malicious script in the score range of 6+, with the higher the score the more confident we are in the verdict.</p>
<p>For the majority of these, profiling is carried out with simple keyword scanning or combinations of keywords. Let’s take a look at a simple one and how the behavior is defined in the Python code.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972286888787468" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
behaviorCol["Disabled Protections"] = [["REG_DWORD", "DisableAntiSpyware"],
    ["REG_DWORD", "DisableAntiVirus"],
    ["REG_DWORD", "DisableScanOnRealtimeEnable"],
    ["REG_DWORD", "DisableBlockAtFirstSeen"],
    ]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972286888787468-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972286888787468-2">2</div><div class="crayon-num" data-line="crayon-5f69289972286888787468-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972286888787468-4">4</div><div class="crayon-num" data-line="crayon-5f69289972286888787468-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972286888787468-1"><span class="crayon-v">behaviorCol</span><span class="crayon-sy">[</span><span class="crayon-s">"Disabled Protections"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-s">"REG_DWORD"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"DisableAntiSpyware"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972286888787468-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"REG_DWORD"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"DisableAntiVirus"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f69289972286888787468-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"REG_DWORD"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"DisableScanOnRealtimeEnable"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972286888787468-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"REG_DWORD"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"DisableBlockAtFirstSeen"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f69289972286888787468-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>For a script to be flagged as having the “Disabled Protections” behavior then, the content must contain one of four variations of “REG_DWORD” and a registry key that I’ve observed in malicious scripts to disable common Windows protection mechanisms such as AntiSpyware and AntiVirus.</p>
<p>Taking a look at another basic example for “Key Logging” shows various combinations of keywords that, when found together, are typically indicative of key logging activity.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972289727627702" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
     behaviorCol["Key Logging"] = [
         ["GetAsyncKeyState", "Windows.Forms.Keys"],
         ["LShiftKey", "RShiftKey", "LControlKey", 
"RControlKey"],
    ]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972289727627702-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972289727627702-2">2</div><div class="crayon-num" data-line="crayon-5f69289972289727627702-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972289727627702-4">4</div><div class="crayon-num" data-line="crayon-5f69289972289727627702-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972289727627702-1"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">behaviorCol</span><span class="crayon-sy">[</span><span class="crayon-s">"Key Logging"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972289727627702-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">[</span><span class="crayon-s">"GetAsyncKeyState"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Windows.Forms.Keys"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f69289972289727627702-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">[</span><span class="crayon-s">"LShiftKey"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"RShiftKey"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"LControlKey"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972289727627702-4"><span class="crayon-s">"RControlKey"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f69289972289727627702-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Now, for both “Disabled Protections” and “Key Logging”, the scores are “4.0” and “3.0” respectively, well below the “6.0” threshold for malicious activity. The reason behind this is that sometimes, even though behaviors are predominantly only seen in malicious scripts, they are also used in benign scripts and so I want additional behaviors to add context and push the score beyond the threshold, as opposed to something like “Ransomware” or “Known Malware” where the profiling script immediately sets it above the “6.0” threshold.</p>
<p>A more complex behavior we can look at is “Code Injection”. This is a technique that follows a specific pattern of calls designed to carve out a segment of memory, move shellcode into the memory segment, and then finally transfer execution to the shellcode in memory. The problem is that at each phase of this, there are numerous methods which facilitate the respective functionality; the profiling script accounts for over 1300 variations alone. Thus, we’ll check each individual keyword at each step and only proceed to the next set of keywords if we find one in the previous set. This allows us to keep analysis time low even though the number of variations significantly rises with each addition. Speed is equally important when profiling these at scale and a lot of the profiling script is designed in ways to decrease run time where possible.</p>
<p>When you look at the above behaviors, you’ll also note one called “Malicious Behavior Combo” towards the end. This one is intended to bump malicious scripts that do not exhibit enough behavioral information to generate a score above the target threshold an extra boost as a contextual modifier. The profiling script will look at all of the behaviors for the PowerShell script as a whole and then use it as its own behavior.</p>
<p>The combinations are checked against the aforementioned ground truth of the scripts being used for a baseline to validate the combination of behaviors do not negatively impact benign scripts. It’s important to carefully monitor these as more data can reveal benign scripts which may match; however, this is a good example of using meta-data to influence scoring.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997228b810664071" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
behaviorCombos = [
    ["Downloader", "One Liner", "Variable Extension"],
    ["Downloader", "Script Execution", "Crypto", 
"Enumeration"],
        ["Downloader", "Script Execution", "Persistence", 
"Enumeration"],
        ["Downloader", "Script Execution", "Starts Process", 
"Enumeration"],
        ["Script Execution", "One Liner", "Variable Extension"],
        ['Script Execution', 'Starts Process', 'Downloader', 
'One Liner'],
        ['Script Execution', 'Downloader', 'Custom Web Fields'],
        ["Script Execution", "Hidden Window", "Downloader"],
        ['Script Execution', 'Crypto', 'Obfuscation'],
        ["Hidden Window", "Persistence", "Downloader"],
]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997228b810664071-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-2">2</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-4">4</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-6">6</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-8">8</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-10">10</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-12">12</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-14">14</div><div class="crayon-num" data-line="crayon-5f6928997228b810664071-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928997228b810664071-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997228b810664071-1"><span class="crayon-v">behaviorCombos</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"One Liner"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Variable Extension"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Script Execution"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Crypto"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-4"><span class="crayon-s">"Enumeration"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Script Execution"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Persistence"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-6"><span class="crayon-s">"Enumeration"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Script Execution"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Starts Process"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-8"><span class="crayon-s">"Enumeration"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Script Execution"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"One Liner"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Variable Extension"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">'Script Execution'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Starts Process'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Downloader'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-11"><span class="crayon-s">'One Liner'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">'Script Execution'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Downloader'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Custom Web Fields'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Script Execution"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Hidden Window"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">'Script Execution'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Crypto'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Obfuscation'</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5f6928997228b810664071-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-s">"Hidden Window"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Persistence"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Downloader"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928997228b810664071-16"><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p></p>
<h4>Neutral Behaviors</h4>
<ul>
<li>&#8216;Downloader&#8217;: 1.5</li>
<li>&#8216;Starts Process&#8217;: 1.5</li>
<li>&#8216;Script Execution&#8217;: 1.5</li>
<li>&#8216;Compression&#8217;: 1.5</li>
<li>&#8216;Hidden Window&#8217;: 0.5</li>
<li>&#8216;Custom Web Fields&#8217;: 1.0</li>
<li>&#8216;Persistence&#8217;: 1.0</li>
<li>&#8216;Sleeps&#8217;: 0.5</li>
<li>&#8216;Uninstalls Apps&#8217;: 0.5</li>
<li>&#8216;Obfuscation&#8217;: 1.0</li>
<li>&#8216;Crypto&#8217;: 2.0</li>
<li>&#8216;Enumeration&#8217;: 0.5</li>
<li>&#8216;Registry&#8217;: 0.5</li>
<li>&#8216;Sends Data&#8217;: 1.0</li>
<li>&#8216;Byte Usage&#8217;: 1.0</li>
<li>&#8216;SysInternals&#8217;: 1.5</li>
<li>&#8216;One Liner&#8217;: 2.0</li>
<li>&#8216;Variable Extension&#8217;: 2.0</li>
</ul>
<p>The neutral behaviors are, as the name suggests, neither good nor bad and follow a similar approach to the ones previously discussed. There are a couple of additional meta-behaviors that I want to highlight which are “Obfuscation”, “One Liner”, and “Variable Extension” as they illustrate more diversion from the keyword approach. Just to recap then, meta-behaviors are observed characteristics that are not a specific functionality or capability, but something that describes a characteristic of the PowerShell script.</p>
<ol>
<li>One Liner &#8211; This one is self explanatory, a script that solely exists on one line. It’s extremely common for malicious scripts or very simple PowerShell download cradles to be constrained on a singular line, whereas benign scripts typically have more structure and include multiple new-lines.</li>
<li>Obfuscation &#8211; This is a case where the script profiles the content for various attributes like character frequency, volume of symbol usage, and volume of variable declarations. These attributes are counted in various ways and highlight observed characteristics of malicious scripts.
<ul>
<li>Character frequency analysis reflects standard deviations of character usage that were observed across malicious and benign script sample sets and, for example, will try to identify if “w” is used more than 500 times in the script, or a colon “:” used more than 100 times. There are 13 individual characters that fall into this category and 3 sets of dual characters (“[“ and “]”) which come into play if the script has less than 50 lines; this is usually indicative of a dense clustering of the characters.</li>
<li>Symbol usage is a specific type of obfuscation that I kept observed being used for variable declarations, such as below.</li>
</ul>
</li>
</ol>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928997228e269756638" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
${/=\__/==\_/\/==\_} = [AppDomain]::CurrentDomain</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928997228e269756638-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928997228e269756638-1"><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-o">/=</span><span class="crayon-sy">\</span><span class="crayon-v">__</span><span class="crayon-o">/=</span><span class="crayon-o">=</span><span class="crayon-sy">\</span><span class="crayon-v">_</span><span class="crayon-o">/</span><span class="crayon-sy">\</span><span class="crayon-o">/=</span><span class="crayon-o">=</span><span class="crayon-sy">\</span><span class="crayon-v">_</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">AppDomain</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">CurrentDomain</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<ul>
<li style="list-style-type: none;">
<ul>
<li>Raw volume of PowerShell and JavaScript unique variable declarations over 40.</li>
</ul>
</li>
</ul>
<p>3. Variable Extension &#8211; Another common obfuscation is taking advantage of<br />
PowerShell’s ability to use wildcards (“*”) in variables. The profiling script will<br />
count various commands for retrieving or setting variables and then count<br />
wildcards surrounded by ASCII characters. If those counts are over a certain<br />
amount than it’ll label the obfuscation type as variable extension. To show how it<br />
works, the following code can be used to retrieve “ExecutionContext” and are<br />
often seen chained together to build out other commands.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289972290350659448" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Get-Item Variable:*xec*t
ExecutionContext</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289972290350659448-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289972290350659448-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289972290350659448-1"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">Item </span><span class="crayon-v">Variable</span><span class="crayon-o">:</span><span class="crayon-o">*</span><span class="crayon-e ">xec*</span><span class="crayon-i">t</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289972290350659448-2"><span class="crayon-v">ExecutionContext</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>In general, the neutral behaviors are scored much lower so that multiple behaviors being flagged won’t generally be enough on their own to cross the established malicious threshold.</p>
<h4>Benign Behaviors</h4>
<ul>
<li>&#8216;Script Logging&#8217;: -1.0</li>
<li>&#8216;License&#8217;: -2.0</li>
<li>&#8216;Function Body&#8217;: -2.0</li>
<li>&#8216;Positive Context&#8217;: -3.0</li>
</ul>
<p>The benign behaviors rarely show up in malicious scripts and subtract from the overall score to help influence the context, subtracting from the totals to improve accuracy. For example, malicious scripts typically do not employ logging, licenses, or function preambles. The keyword here being “typically” as sometimes you will find cases where the attacker downloads a script from a PowerShell offensive framework via Github and don’t bother to clean it up. In these cases, there is almost always significant amounts of non-obfuscated behaviors to make up for any drops in score.</p>
<p>Finally, “Positive Context” are specifically used when benign scripts exhibit so many behaviors it crosses the malicious threshold and I want to try and artificially lower their scores. This is more common when dealing with administrative type scripts found in enterprises that perform a wide sweeping range of administrative functions on an endpoint or bootstrap systems.</p>
<h2>Conclusion</h2>
<p>In this blog I covered common PowerShell techniques for hiding data that I have observed and shown how these can be cleaned up with normalization and by reversing various types of obfuscation. This is a critical step before furtherer unraveling content that will be used as the base for behavioral profiling.</p>
<p>For the next blog in this series, I’ll take more of an in-depth look at how all of these things work together to profile scripts and talk about some observations I’ve made when it comes to statically analyzing PowerShell scripts.</p>
<p>&nbsp;</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
