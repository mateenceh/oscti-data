
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" />
<link rel="alternate" hreflang="ja" href="https://unit42.paloaltonetworks.jp/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)" />
<meta property="og:description" content="The final post in a 3-part series that takes an in-depth look at how to run a profiling script on samples, how to interpret the output discusses some of the ways I think the script can be leveraged by an organization." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="Malicious PowerShell scripts" />
<meta property="article:tag" content="malware" />
<meta property="article:tag" content="PowerShell Scripts" />
<meta property="article:tag" content="profiling scripts" />
<meta property="article:tag" content="Static Analysis" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2019-10-25T13:00:53+00:00" />
<meta property="article:modified_time" content="2019-10-24T22:41:39+00:00" />
<meta property="og:updated_time" content="2019-10-24T22:41:39+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-1024x512.png" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-1024x512.png" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="512" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="The final post in a 3-part series that takes an in-depth look at how to run a profiling script on samples, how to interpret the output discusses some of the ways I think the script can be leveraged by an organization." />
<meta name="twitter:title" content="Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1.png" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3) Comments Feed" href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/feed/" />
<meta property="og:likes" content="7"/>
<meta property="og:readtime" content="9"/>
<meta property="og:views" content="17,083"/>
<meta property="og:date_created" content="October 25, 2019 at 6:00 AM"/>
<meta property="og:post_length" content="2322"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit-42/"/>
<meta property="og:author" content="Jeff White"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/jeff-white/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:post_image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-380x184.png"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)","name":"Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)","description":"The final post in a 3-part series that takes an in-depth look at how to run a profiling script on samples, how to interpret the output discusses some of the ways I think the script can be leveraged by an organization. ","url":"https:\/\/unit42.paloaltonetworks.com\/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3\/","datePublished":"October 25, 2019","articleBody":"Executive Summary\r\nThis 3-part blog series will focus on a practical approach to static analysis of PowerShell scripts and developing a platform-independent Python script to carry out this task. This is Part 3 of the series, but you can read Part 1 and Part\u00a0 2 to get caught up.\r\n\r\nIn this final blog, I\u2019ll walk through running the profiling script on samples and discuss how to interpret the output. Further, I\u2019ll talk about a few observations I made along the way after going through building a script for static analysis, cover some ways in which I think the script can be leveraged by an organization, and then finally wrap up with providing the PowerShellProfiler.py script that has been discussed throughout this blog.\r\nIntroduction\r\nFor my testing, I used a sample set of around 5,000 PowerShell scripts that I manually classified - roughly 3,000 Benign, 2,000 Malicious PowerShell scripts. I then started to identify behaviors contained within for profiling, along with script characteristics or other features that could be used as a guide to adjust the scoring for behaviors. By using this approach to create a baseline, I was able to familiarize myself with common techniques and low-hanging fruit that I then incorporated into the profiling script. This allowed me to focus the bulk of my subsequent analysis time on the samples which fell below the malicious target score threshold of \u201c6.0\u201d to figure out what, if anything, could be learned from them to further enhance the profiling process.\r\nUsing PowerShellProfiler.py\r\nFirst off, the profiling script can be retrieved from the Palo Alto Networks Unit42 GitHub. Inside you\u2019ll find PowerShellProfiler.py.\r\n\r\nTo use PowerShellProfiler.py, simply provide a file as input by using the \u201c-f\u201d flag and it will produce output similar to the below.\r\n$ python PowerShellProfiler.py -f 1\r\nb987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2\r\n.MLWR\r\n\r\n1b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2\r\n.MLWR , 18.5 , Elevated Risk , 0:00:00.028457 , [Downloader - \r\n1.5 | Starts Process - 1.5 | Script Execution - 1.5 | \r\nCompression - 1.5 | Enumeration - 0.5 | One Liner - 2.0 | Known \r\nMalware: Veil Stream - 10.0]\r\nThe structure of the output is as follows:\r\nFile Name , Score , Proposed Risk Rating , Analysis Time , \r\nBehaviors\r\nMost of the fields are self-explanatory and the output is kept very simple for quick review. The \u201cProposed Risk Rating\u201d field is derived from the gradient scale discussed in the first blog of this series and just offers guidance to the analyst as to what the risk may be at first glance. The \u201cScore\u201d field is an aggregate of the scores (positive and negative) seen in the \u201cBehaviors\u201d field found at the end of the output. Some behaviors will provide additional context, such as types of obfuscation and known malware families which can be seen in the example above.\r\n\r\nOptionally, there is a debug flag (\u201c-d\u201d) that can be used to print debugging information which is useful when trying to see how the script was modified or review unraveled content. It simply prints out all of the content it discovered post-normalization and de-obfuscation, so it\u2019s a good way to identify areas where you can look for new techniques for hiding code that need to be accounted for.\r\nStepping through Obfuscation\r\nSo what does this look like in action?\r\n\r\nUsing the file with the SHA256 hash of\r\n\u201c1b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2\u201d from above, you can see two behaviors in the original content before anything else is processed. There are multiple dotNET methods related to Stream objects that it uses to deflate a Base64 string and then execute it. The keywords \u201cConvert\u201d, \u201cFromBase64String\u201d, and \u201cText.Encoding\u201d trigger the flag for the \u201cCompression\u201d behavior and then \u201cInvoke-Expression\u201d triggers the Script Execution behavior.\r\n\r\n\r\nFigure 9. Original PowerShell script\r\nOnce the script deflates the content, it will begin the processing looping back over to normalize, de-obfuscate, and unravel any additional content.\r\n\r\n\r\nFigure 10. Decompressed script content\r\nYou can see by the obfuscation that it\u2019s heavily utilizing the format operator replacement technique to hide strings. It\u2019s also utilizing a number of string replacement functions which it will also attempt to run during processing. What we\u2019re left with from the profiling scripts perspective is shown below.\r\n\r\n\r\nFigure 11. PowerShell script with obfuscation removed\r\nThe remaining behaviors can be seen here. The keyword \u201cdownloadstring\u201d triggers the \u201cDownloader\u201d behavior, \u201cStart-Process\u201d for \u201cStarts Process\u201d behavior, and finally \u201c$env:username\u201d for the \u201cEnumeration\u201d behavior.\r\n\r\nThe last two behaviors focus more on the structure of the content instead of a specific keyword combination. For the meta-behavior \u201cOne Liner\u201d, it flags due to the original file being entirely on one line while the \u201cKnown Malware: Veil Stream\u201d behavior is based on the following two lines found in the original PowerShell script:\r\nInvoke-Expression $(New-Object IO.StreamReader ($(New-Object \r\nIO.Compression.DeflateStream\r\n)))), [IO.Compression.CompressionMode]::Decompress)), \r\n[Text.Encoding]::ASCII)).ReadToEnd();\r\nThese were identified through previous research and can be seen in the Veil Framework on GitHub for their PowerShell payload generation.\r\npayload_code += \"powershell.exe -NoP -NonI -W Hidden -Command \r\n\\\"Invoke-Expression $(New-Object IO.StreamReader ($(New-Object \r\nIO.Compression.DeflateStream ($(New-Object IO.MemoryStream \r\n(,$([Convert]::FromBase64String(\\\\\\\"%s\\\\\\\")))), \r\n[IO.Compression.CompressionMode]::Decompress)), \r\n[Text.Encoding]::ASCII)).ReadToEnd();\\\"\" % (encoded)\r\nAs the score is far above the target threshold of 6.0, it scores the file as likely Malicious.\r\nGeneral Observations about Static Analysis\r\nI\u2019ll briefly cover some general observations I\u2019ve made after going through this exercise and talk about some of the reasons why a sample may not lend itself to profiling or otherwise prevent the profiling script from hitting the targeted threshold for malicious activity.\r\n\r\n \tRemotely loading of content is a tactic more commonly seen in advanced attacks. Its purpose is to prevent exposure of the payload and prevent further analysis. In these cases, there may be little to no behavioral indicators beyond \u201cDownloader\u201d that trigger which is far too generic to be useful when inferring intent. Using keywords in the \u201cNegative Context\u201d will sometimes be the only feasible adjustment that can be made and should be used as a last resort due to the nightmare of managing word lists like this.\r\n \tMixed scripting languages are another area that can cause problems in determining intent due to the profiling script not being designed to de-obfuscate or normalize the other languages unique structures. When the obfuscation is more universal, such as Base64 or type conversion, it may still work to reveal contextual clues but in general it\u2019s not to be relied upon. These mixed language scripts, such as JavaScript and VBS, will frequently leverage PowerShell for a specific functionality, or vice versa. These polyglot scripts create a hole in the visibility we have into the overall behaviors without extending the script to cover additional scripting languages.\r\n \tUsing complex REGEX patterns..they are a blessing and a curse. Since I\u2019m trying to leave the patterns extremely loose so as to deal with the multitude of variations you\u2019ll find in PowerShell, it leaves the door open for mistakes in matching. This includes content being missed for profiling, over-matching, or the matched content being changed in such a way that it no longer matches behaviors as expected. It\u2019s a balancing act trying to find the sweet spot between identifying keywords no matter the obfuscation and avoiding false matches.\r\n \tStatic analysis, in general, can be thwarted by abusing the flexibility of PowerShell for more extreme obfuscation techniques which make programmatic approaches very challenging. When I stumble across these situations, there are usually meta-characteristics that can be identified since these samples stick out like a sore thumb but it\u2019s something to be wary of and the scores might not reflect the true nature of the script.\r\n \tSometimes a PowerShell script on the surface doesn\u2019t appear malicious in the terms I\u2019ve established as \u201cbad\u201d and thus doesn\u2019t score high, but in certain circles, the script may be considered as so. For example, a PowerShell script that changes the homepage for Internet Explorer every time a PC boots or a PowerShell script that profiles the network. Both things can be argued for and against as being Malicious at a high level but it helps to highlight that while context is important, context is also unique to the person interpreting the output.\r\n \tPowerShell is an evolving language both in functionality created by Microsoft and as an attack platform. As more offensive tools get released and new capabilities are adopted, behavioral keywords can become stale, so it requires more attention to stay on top of how things change over time.\r\n \tOpting to use a gradient scale for scoring instead of flat verdicts opens the door for ambiguity and it becomes increasingly difficult to measure the impact changes to the profiling script will have. During my development phase, I heavily leveraged my ground truth sample set to see how shifts in the score values of behaviors, the addition of new behaviors, and the addition of new unraveling or de-obfuscating functions impacted every file individually. Since the target threshold was relatively low (\u201c6.0\u201d), then it meant any change could have a significant impact in pushing samples in the wrong direction.\r\n\r\nScriptBlock Logging and Practical Use Cases\r\nTo pull everything together then, how might one utilize this PowerShell profiling script in real environments? I\u2019ll present a few ideas that I have on the topic as I start winding down this blog series.\r\n\r\nFor starters, the most obvious usage is to run the script early in your incident response process to get a feel for the behaviors that may be present in the PowerShell script. The behaviors can then help guide further research and defensive measures you can take. If a sample exhibits a \u201cDownloader\u201d behavior, then you can quickly focus on the domains or IP addresses called from the script to begin searching your network logging for activity indicative of it. Similarly, if there are \u201cEnumeration\u201d behaviors or \u201cPersistence\u201d behaviors, then the processing of the PowerShell script may reveal registry keys and values, file names, file paths, or other unique features that can then be leveraged for further pivoting and hunting.\r\n\r\nAnother approach is utilizing the profiling script for the bulk scanning of PowerShell scripts in your environment. You can deploy the profiling script to host systems and run it locally, though I would not recommend it, or pull the PowerShell scripts back to a central location for scanning - like in the cases where files are backed up in central repositories, though it may miss PowerShell scripts in odd locations. Regardless of how you collect them, using tools like GNU Parallels will let you process hundreds of thousands of files relatively quickly. The average processing time for an individual PowerShell script in my sample set was around 2 milliseconds so it scales nicely based on available resources. Once the files are processed, you can use the scores or combinations of behaviors to hone in quickly on files for further investigation.\r\n\r\nLastly, I\u2019ll talk about ScriptBlock logging. Let\u2019s assume that collecting the scripts for local analysis is too cumbersome for some reason but your organization has a SIEM or some kind of log collection system actively ingesting logs from your endpoints. In this scenario, your organization is likely on at least PowerShell version 5.0 where Microsoft introduced a feature for script tracing and logging. If you\u2019re not familiar with it, ScriptBlock logging is a feature that can be enabled on a host that logs the code blocks which PowerShell compiles and executes to the ETW event log (event ID 4104).\r\n\r\nOne major advantage to ScriptBlock logging is that when PowerShell compiles the code for execution, it can remove layers of obfuscation that the profiling script would otherwise attempt to do statically, but without the worry of \u201cgetting it right\u201d. Another advantage is that it allows for a constant \u201cstream\u201d of events from across your fleet of systems that you can check in near real-time and design alerts around to more rapidly identify potentially compromised hosts.\r\n\r\nOf course, it\u2019s not without its caveats and the one that comes to the forefront is that you do not necessarily have the full script for profiling. Additionally, one advantage static analysis has over dynamic is that it\u2019s not constrained to the execution path that a PowerShell script takes and so you have more potential coverage, whereas ScriptBlock events will only contain the code PowerShell ran. The second problem is that you really want the full set of code blocks that PowerShell logged to properly identify all of the behaviors presented for a particular case. The ScriptBlock events can be tied together by using various other meta-data contained within the events but it makes it slightly trickier to cobble together for profiling.\r\n\r\nThat being said, the screenshot below is from a ScriptBlock event for the same sample I showed in Figure 8 and it reveals the profiling script got pretty close to what PowerShell executed after all of the decompression, format operator replacement, and string replacements took place.\r\n\r\n\r\nFigure 12. ScriptBlock event with obfuscation removed\r\nBut it has the added benefit of showing the next block of code is executed, which the profiling script does not see, thus providing the potential for further profiling, such as possibly using a REGEX pattern to match on the URL structure and identify the malware family.\r\nFigure 13. Additional data revealed by ScriptBlock event\r\n\r\nConclusion\r\nStatic analysis isn\u2019t without its flaws but knowing what it\u2019s advantages are, we can utilize them to improve our ability to detect malicious PowerShell scripts. Hopefully, this series of blogs and tools offered can provide some ideas and methods to do just that.\r\n\r\nAt the end of the day, every tool that helps augment your defenses and allows you to focus your investigative efforts into more specific areas is a win in my book.\r\n\r\nThe PowerShellProfiler.py script can be downloaded from the Unit 42 GitHub page.\r\n\r\n&nbsp;","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2019\/08\/Vulnerability-r3d1-1-150x150.png","width":150,"height":150},"author":[{"@type":"Person","name":"Jeff White"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"100492","token":"b09d8c8c9d","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=100492' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-100492 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">Practical Behavioral Profiling of PowerShell Scripts through Static Analysis (Part 3)</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-100492 entry-meta">
			
			
			<span class="post-views-count">17,083</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'100492','like')"><i class="ui ui-2"></i><span class="ml-5">7</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 9</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3%2F+-+Practical+Behavioral+Profiling+of+PowerShell+Scripts+through+Static+Analysis+%28Part+3%29" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fpractical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3%2F&title=Practical+Behavioral+Profiling+of+PowerShell+Scripts+through+Static+Analysis+%28Part+3%29&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/jeff-white/" title="Posts by Jeff White" class="author url fn" rel="author">Jeff White</a>        </p>
        <p><time datetime="2019-10-25T13:00:53+00:00">October 25, 2019 at 6:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit-42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/malicious-powershell-scripts/" rel="tag">Malicious PowerShell scripts</a>, <a href="https://unit42.paloaltonetworks.com/tag/malware/" rel="tag">malware</a>, <a href="https://unit42.paloaltonetworks.com/tag/powershell-scripts/" rel="tag">PowerShell Scripts</a>, <a href="https://unit42.paloaltonetworks.com/tag/profiling-scripts/" rel="tag">profiling scripts</a>, <a href="https://unit42.paloaltonetworks.com/tag/static-analysis/" rel="tag">Static Analysis</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="900" height="450" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-900x450.png" class="attachment-single size-single" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-900x450.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-300x150.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-768x384.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-1024x512.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1-370x185.png 370w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/08/Vulnerability-r3d1-1.png 2001w" sizes="(max-width: 900px) 100vw, 900px" />            </figure>
                    <p class="wpml-ls-statics-post_translations wpml-ls">This post is also available in: 
    <span class="wpml-ls-slot-post_translations wpml-ls-item wpml-ls-item-ja wpml-ls-first-item wpml-ls-last-item wpml-ls-item-legacy-post-translations"><a href="https://unit42.paloaltonetworks.jp/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-3/" class="wpml-ls-link"><span class="wpml-ls-native" lang="ja">日本語</span><span class="wpml-ls-display"><span class="wpml-ls-bracket"> (</span>Japanese<span class="wpml-ls-bracket">)</span></span></a></span></p><h2>Executive Summary</h2>
<p>This 3-part blog series will focus on a practical approach to static analysis of PowerShell scripts and developing a platform-independent Python script to carry out this task. This is Part 3 of the series, but you can read <a href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-1/">Part 1</a> and <a href="https://unit42.paloaltonetworks.com/practical-behavioral-profiling-of-powershell-scripts-through-static-analysis-part-2/">Part  2</a> to get caught up.</p>
<p>In this final blog, I’ll walk through running the profiling script on samples and discuss how to interpret the output. Further, I’ll talk about a few observations I made along the way after going through building a script for static analysis, cover some ways in which I think the script can be leveraged by an organization, and then finally wrap up with providing the PowerShellProfiler.py script that has been discussed throughout this blog.</p>
<h2>Introduction</h2>
<p>For my testing, I used a sample set of around 5,000 PowerShell scripts that I manually classified &#8211; roughly 3,000 Benign, 2,000 Malicious PowerShell scripts. I then started to identify behaviors contained within for profiling, along with script characteristics or other features that could be used as a guide to adjust the scoring for behaviors. By using this approach to create a baseline, I was able to familiarize myself with common techniques and low-hanging fruit that I then incorporated into the profiling script. This allowed me to focus the bulk of my subsequent analysis time on the samples which fell below the malicious target score threshold of “6.0” to figure out what, if anything, could be learned from them to further enhance the profiling process.</p>
<h4>Using PowerShellProfiler.py</h4>
<p>First off, the profiling script can be retrieved from the <a href="https://github.com/pan-unit42/public_tools/blob/master/powershellprofiler/">Palo Alto Networks Unit42 GitHub</a>. Inside you’ll find PowerShellProfiler.py.</p>
<p>To use PowerShellProfiler.py, simply provide a file as input by using the “-f” flag and it will produce output similar to the below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289939344623229069" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ python PowerShellProfiler.py -f 1
b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2
.MLWR

1b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2
.MLWR , 18.5 , Elevated Risk , 0:00:00.028457 , [Downloader - 
1.5 | Starts Process - 1.5 | Script Execution - 1.5 | 
Compression - 1.5 | Enumeration - 0.5 | One Liner - 2.0 | Known 
Malware: Veil Stream - 10.0]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289939344623229069-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939344623229069-2">2</div><div class="crayon-num" data-line="crayon-5f69289939344623229069-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939344623229069-4">4</div><div class="crayon-num" data-line="crayon-5f69289939344623229069-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939344623229069-6">6</div><div class="crayon-num" data-line="crayon-5f69289939344623229069-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939344623229069-8">8</div><div class="crayon-num" data-line="crayon-5f69289939344623229069-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289939344623229069-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">python </span><span class="crayon-v">PowerShellProfiler</span><span class="crayon-sy">.</span><span class="crayon-v">py</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939344623229069-2"><span class="crayon-i">b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2</span></div><div class="crayon-line" id="crayon-5f69289939344623229069-3"><span class="crayon-sy">.</span><span class="crayon-i">MLWR</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939344623229069-4">&nbsp;</div><div class="crayon-line" id="crayon-5f69289939344623229069-5"><span class="crayon-cn">1b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939344623229069-6"><span class="crayon-sy">.</span><span class="crayon-i">MLWR</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">18.5</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Elevated </span><span class="crayon-i">Risk</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-cn">00</span><span class="crayon-o">:</span><span class="crayon-cn">00.028457</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Downloader</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5f69289939344623229069-7"><span class="crayon-cn">1.5</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">Starts </span><span class="crayon-v">Process</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">1.5</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">Script </span><span class="crayon-v">Execution</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">1.5</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939344623229069-8"><span class="crayon-v">Compression</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">1.5</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Enumeration</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">One </span><span class="crayon-v">Liner</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">2.0</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">Known </span></div><div class="crayon-line" id="crayon-5f69289939344623229069-9"><span class="crayon-v">Malware</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Veil </span><span class="crayon-v">Stream</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">10.0</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>The structure of the output is as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928993934b421274803" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
File Name , Score , Proposed Risk Rating , Analysis Time , 
Behaviors</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928993934b421274803-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928993934b421274803-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928993934b421274803-1"><span class="crayon-e">File </span><span class="crayon-i">Name</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">Score</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Proposed </span><span class="crayon-e">Risk </span><span class="crayon-i">Rating</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Analysis </span><span class="crayon-i">Time</span><span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928993934b421274803-2"><span class="crayon-v">Behaviors</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Most of the fields are self-explanatory and the output is kept very simple for quick review. The “Proposed Risk Rating” field is derived from the gradient scale discussed in the first blog of this series and just offers guidance to the analyst as to what the risk may be at first glance. The “Score” field is an aggregate of the scores (positive and negative) seen in the “Behaviors” field found at the end of the output. Some behaviors will provide additional context, such as types of obfuscation and known malware families which can be seen in the example above.</p>
<p>Optionally, there is a debug flag (“-d”) that can be used to print debugging information which is useful when trying to see how the script was modified or review unraveled content. It simply prints out all of the content it discovered post-normalization and de-obfuscation, so it’s a good way to identify areas where you can look for new techniques for hiding code that need to be accounted for.</p>
<h4>Stepping through Obfuscation</h4>
<p>So what does this look like in action?</p>
<p>Using the file with the SHA256 hash of<br />
“1b987ba4983d98a4c2776c8afb5aebbe418cdea1a7d4960c548fb947d404e4b2” from above, you can see two behaviors in the original content before anything else is processed. There are multiple dotNET methods related to Stream objects that it uses to deflate a Base64 string and then execute it. The keywords “Convert”, “FromBase64String”, and “Text.Encoding” trigger the flag for the “Compression” behavior and then “Invoke-Expression” triggers the Script Execution behavior.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100506 size-full" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script.png" alt="" width="1231" height="262" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script.png 1231w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script-300x64.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script-768x163.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script-1024x218.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script-900x192.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-9.-Original-PowerShell-script-370x79.png 370w" sizes="(max-width: 1231px) 100vw, 1231px" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 9. Original PowerShell script</em></span></p>
<p>Once the script deflates the content, it will begin the processing looping back over to normalize, de-obfuscate, and unravel any additional content.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100510 size-large" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-1024x402.png" alt="" width="1024" height="402" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-1024x402.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-300x118.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-768x302.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-900x354.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content-370x145.png 370w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-10.-Decompressed-script-content.png 1224w" sizes="(max-width: 1024px) 100vw, 1024px" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 10. Decompressed script content</em></span></p>
<p>You can see by the obfuscation that it’s heavily utilizing the format operator replacement technique to hide strings. It’s also utilizing a number of string replacement functions which it will also attempt to run during processing. What we’re left with from the profiling scripts perspective is shown below.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100513 size-large" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-1024x296.png" alt="" width="1024" height="296" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-1024x296.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-300x87.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-768x222.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-900x260.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed-370x107.png 370w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-11.-PowerShell-script-with-obfuscation-removed.png 1187w" sizes="(max-width: 1024px) 100vw, 1024px" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 11. PowerShell script with obfuscation removed</em></span></p>
<p>The remaining behaviors can be seen here. The keyword “downloadstring” triggers the “Downloader” behavior, “Start-Process” for “Starts Process” behavior, and finally “$env:username” for the “Enumeration” behavior.</p>
<p>The last two behaviors focus more on the structure of the content instead of a specific keyword combination. For the meta-behavior “One Liner”, it flags due to the original file being entirely on one line while the “Known Malware: Veil Stream” behavior is based on the following two lines found in the original PowerShell script:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f6928993934e954001113" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Invoke-Expression $(New-Object IO.StreamReader ($(New-Object 
IO.Compression.DeflateStream</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f6928993934e954001113-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f6928993934e954001113-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f6928993934e954001113-1"><span class="crayon-v">Invoke</span><span class="crayon-o">-</span><span class="crayon-i">Expression</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-i">StreamReader</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f6928993934e954001113-2"><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-v">Compression</span><span class="crayon-sy">.</span><span class="crayon-v">DeflateStream</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289939357088314576" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
)))), [IO.Compression.CompressionMode]::Decompress)), 
[Text.Encoding]::ASCII)).ReadToEnd();</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289939357088314576-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939357088314576-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289939357088314576-1"><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-v">Compression</span><span class="crayon-sy">.</span><span class="crayon-v">CompressionMode</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">Decompress</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939357088314576-2"><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ReadToEnd</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>These were identified through previous research and can be seen in the <a href="https://github.com/Veil-Framework/Veil/blob/master/tools/evasion/payloads/powershell/shellcode_inject/virtual.py#L114">Veil Framework on GitHub</a> for their PowerShell payload generation.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69289939358348539720" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
payload_code += "powershell.exe -NoP -NonI -W Hidden -Command 
\"Invoke-Expression $(New-Object IO.StreamReader ($(New-Object 
IO.Compression.DeflateStream ($(New-Object IO.MemoryStream 
(,$([Convert]::FromBase64String(\\\"%s\\\")))), 
[IO.Compression.CompressionMode]::Decompress)), 
[Text.Encoding]::ASCII)).ReadToEnd();\"" % (encoded)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69289939358348539720-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939358348539720-2">2</div><div class="crayon-num" data-line="crayon-5f69289939358348539720-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939358348539720-4">4</div><div class="crayon-num" data-line="crayon-5f69289939358348539720-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69289939358348539720-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69289939358348539720-1"><span class="crayon-v">payload_code</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">"powershell.exe -NoP -NonI -W Hidden -Command </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939358348539720-2"><span class="crayon-s">\"Invoke-Expression $(New-Object IO.StreamReader ($(New-Object </span></div><div class="crayon-line" id="crayon-5f69289939358348539720-3"><span class="crayon-s">IO.Compression.DeflateStream ($(New-Object IO.MemoryStream </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939358348539720-4"><span class="crayon-s">(,$([Convert]::FromBase64String(\\\"</span><span class="crayon-o">%</span><span class="crayon-v">s</span><span class="crayon-sy">\</span><span class="crayon-sy">\</span><span class="crayon-sy">\</span><span class="crayon-s">")))), </span></div><div class="crayon-line" id="crayon-5f69289939358348539720-5"><span class="crayon-s">[IO.Compression.CompressionMode]::Decompress)), </span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69289939358348539720-6"><span class="crayon-s">[Text.Encoding]::ASCII)).ReadToEnd();\""</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">encoded</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>As the score is far above the target threshold of 6.0, it scores the file as likely Malicious.</p>
<h4>General Observations about Static Analysis</h4>
<p>I’ll briefly cover some general observations I’ve made after going through this exercise and talk about some of the reasons why a sample may not lend itself to profiling or otherwise prevent the profiling script from hitting the targeted threshold for malicious activity.</p>
<ul>
<li>Remotely loading of content is a tactic more commonly seen in advanced attacks. Its purpose is to prevent exposure of the payload and prevent further analysis. In these cases, there may be little to no behavioral indicators beyond “Downloader” that trigger which is far too generic to be useful when inferring intent. Using keywords in the “Negative Context” will sometimes be the only feasible adjustment that can be made and should be used as a last resort due to the nightmare of managing word lists like this.</li>
<li>Mixed scripting languages are another area that can cause problems in determining intent due to the profiling script not being designed to de-obfuscate or normalize the other languages unique structures. When the obfuscation is more universal, such as Base64 or type conversion, it may still work to reveal contextual clues but in general it’s not to be relied upon. These mixed language scripts, such as JavaScript and VBS, will frequently leverage PowerShell for a specific functionality, or vice versa. These polyglot scripts create a hole in the visibility we have into the overall behaviors without extending the script to cover additional scripting languages.</li>
<li>Using complex REGEX patterns..they are a blessing and a curse. Since I’m trying to leave the patterns extremely loose so as to deal with the multitude of variations you’ll find in PowerShell, it leaves the door open for mistakes in matching. This includes content being missed for profiling, over-matching, or the matched content being changed in such a way that it no longer matches behaviors as expected. It’s a balancing act trying to find the sweet spot between identifying keywords no matter the obfuscation and avoiding false matches.</li>
<li>Static analysis, in general, can be thwarted by abusing the flexibility of PowerShell for more extreme obfuscation techniques which make programmatic approaches very challenging. When I stumble across these situations, there are usually meta-characteristics that can be identified since these samples stick out like a sore thumb but it’s something to be wary of and the scores might not reflect the true nature of the script.</li>
<li>Sometimes a PowerShell script on the surface doesn’t appear malicious in the terms I’ve established as “bad” and thus doesn’t score high, but in certain circles, the script may be considered as so. For example, a PowerShell script that changes the homepage for Internet Explorer every time a PC boots or a PowerShell script that profiles the network. Both things can be argued for and against as being Malicious at a high level but it helps to highlight that while context is important, context is also unique to the person interpreting the output.</li>
<li>PowerShell is an evolving language both in functionality created by Microsoft and as an attack platform. As more offensive tools get released and new capabilities are adopted, behavioral keywords can become stale, so it requires more attention to stay on top of how things change over time.</li>
<li>Opting to use a gradient scale for scoring instead of flat verdicts opens the door for ambiguity and it becomes increasingly difficult to measure the impact changes to the profiling script will have. During my development phase, I heavily leveraged my ground truth sample set to see how shifts in the score values of behaviors, the addition of new behaviors, and the addition of new unraveling or de-obfuscating functions impacted every file individually. Since the target threshold was relatively low (“6.0”), then it meant any change could have a significant impact in pushing samples in the wrong direction.</li>
</ul>
<h4>ScriptBlock Logging and Practical Use Cases</h4>
<p>To pull everything together then, how might one utilize this PowerShell profiling script in real environments? I’ll present a few ideas that I have on the topic as I start winding down this blog series.</p>
<p>For starters, the most obvious usage is to run the script early in your incident response process to get a feel for the behaviors that may be present in the PowerShell script. The behaviors can then help guide further research and defensive measures you can take. If a sample exhibits a “Downloader” behavior, then you can quickly focus on the domains or IP addresses called from the script to begin searching your network logging for activity indicative of it. Similarly, if there are “Enumeration” behaviors or “Persistence” behaviors, then the processing of the PowerShell script may reveal registry keys and values, file names, file paths, or other unique features that can then be leveraged for further pivoting and hunting.</p>
<p>Another approach is utilizing the profiling script for the bulk scanning of PowerShell scripts in your environment. You can deploy the profiling script to host systems and run it locally, though I would not recommend it, or pull the PowerShell scripts back to a central location for scanning &#8211; like in the cases where files are backed up in central repositories, though it may miss PowerShell scripts in odd locations. Regardless of how you collect them, using tools like GNU Parallels will let you process hundreds of thousands of files relatively quickly. The average processing time for an individual PowerShell script in my sample set was around 2 milliseconds so it scales nicely based on available resources. Once the files are processed, you can use the scores or combinations of behaviors to hone in quickly on files for further investigation.</p>
<p>Lastly, I’ll talk about ScriptBlock logging. Let’s assume that collecting the scripts for local analysis is too cumbersome for some reason but your organization has a SIEM or some kind of log collection system actively ingesting logs from your endpoints. In this scenario, your organization is likely on at least PowerShell version 5.0 where Microsoft introduced a feature for script tracing and logging. If you’re not familiar with it, ScriptBlock logging is a feature that can be enabled on a host that logs the code blocks which PowerShell compiles and executes to the ETW event log (event ID 4104).</p>
<p>One major advantage to ScriptBlock logging is that when PowerShell compiles the code for execution, it can remove layers of obfuscation that the profiling script would otherwise attempt to do statically, but without the worry of “getting it right”. Another advantage is that it allows for a constant “stream” of events from across your fleet of systems that you can check in near real-time and design alerts around to more rapidly identify potentially compromised hosts.</p>
<p>Of course, it’s not without its caveats and the one that comes to the forefront is that you do not necessarily have the full script for profiling. Additionally, one advantage static analysis has over dynamic is that it’s not constrained to the execution path that a PowerShell script takes and so you have more potential coverage, whereas ScriptBlock events will only contain the code PowerShell ran. The second problem is that you really want the full set of code blocks that PowerShell logged to properly identify all of the behaviors presented for a particular case. The ScriptBlock events can be tied together by using various other meta-data contained within the events but it makes it slightly trickier to cobble together for profiling.</p>
<p>That being said, the screenshot below is from a ScriptBlock event for the same sample I showed in Figure 8 and it reveals the profiling script got pretty close to what PowerShell executed after <span style="font-size: 10pt;">all</span> of the decompression, format operator replacement, and string replacements took place.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100515 size-large" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-1024x163.png" alt="" width="1024" height="163" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-1024x163.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-300x48.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-768x123.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-900x144.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed-370x59.png 370w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-12.-ScriptBlock-event-with-obfuscation-removed.png 1247w" sizes="(max-width: 1024px) 100vw, 1024px" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 12. ScriptBlock event with obfuscation removed</em></span></p>
<p>But it has the added benefit of showing the next block of code is executed, which the profiling script does not see, thus providing the potential for further profiling, such as possibly using a REGEX pattern to match on the URL structure and identify the malware family.</p>
<p style="text-align: center;"><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-100518 " src="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-1024x134.png" alt="" width="1024" height="134" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-1024x134.png 1024w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-300x39.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-768x100.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-900x118.png 900w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event-370x48.png 370w, https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/Figure-13.-Additional-data-revealed-by-ScriptBlock-event.png 1040w" sizes="(max-width: 1024px) 100vw, 1024px" /></a><span style="font-size: 10pt;"><em>Figure 13. Additional data revealed by ScriptBlock event</em></span></p>
<h2>Conclusion</h2>
<p>Static analysis isn’t without its flaws but knowing what it’s advantages are, we can utilize them to improve our ability to detect malicious PowerShell scripts. Hopefully, this series of blogs and tools offered can provide some ideas and methods to do just that.</p>
<p>At the end of the day, every tool that helps augment your defenses and allows you to focus your investigative efforts into more specific areas is a win in my book.</p>
<p>The PowerShellProfiler.py script can be downloaded from the <a href="https://github.com/pan-unit42/public_tools/blob/master/powershellprofiler/">Unit 42 GitHub page</a>.</p>
<p>&nbsp;</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
