
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <title>Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware</title>
<link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware/" />

<!-- This site is optimized with the Yoast SEO plugin v12.6.2 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://unit42.paloaltonetworks.com/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware" />
<meta property="og:description" content="#Unit 42 slices and dices CVE-2018-5002, uncovering new #CHAINSHOT malware." />
<meta property="og:url" content="https://unit42.paloaltonetworks.com/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware/" />
<meta property="og:site_name" content="Unit42" />
<meta property="article:tag" content="adobe" />
<meta property="article:tag" content="CHAINSHOT" />
<meta property="article:tag" content="CVE-2018-5002" />
<meta property="article:tag" content="zero-day" />
<meta property="article:section" content="Unit 42" />
<meta property="article:published_time" content="2018-09-06T20:00:48+00:00" />
<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" />
<meta property="og:image:secure_url" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" />
<meta property="og:image:width" content="600" />
<meta property="og:image:height" content="300" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="#Unit 42 slices and dices CVE-2018-5002, uncovering new #CHAINSHOT malware." />
<meta name="twitter:title" content="Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware" />
<meta name="twitter:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware Comments Feed" href="https://unit42.paloaltonetworks.com/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware/feed/" />
<meta property="og:likes" content="3"/>
<meta property="og:readtime" content="11"/>
<meta property="og:views" content="16,783"/>
<meta property="og:date_created" content="September 6, 2018 at 1:00 PM"/>
<meta property="og:post_length" content="3317"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit42/"/>
<meta property="og:author" content="Dominik Reichel"/>
<meta property="og:author" content="Esmid Idrizovic"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/dominik-reichel/"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/esmid-idrizovic/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware","name":"Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware","description":"#Unit 42 slices and dices CVE-2018-5002, uncovering new #CHAINSHOT malware.","url":"https:\/\/unit42.paloaltonetworks.com\/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware\/","datePublished":"September 6, 2018","articleBody":"This story begins with one of our blog authors, who, following the discovery of a new Adobe Flash 0-day, found several documents using the same exploit that were used in targeted attacks. We were also able to collect network captures including the encrypted malware payload. Armed with these initial weaponized documents, we uncovered additional attacker network infrastructure, were able to crack the 512-bit RSA keys, and decrypt the exploit and malware payloads. We have dubbed the malware \u2018CHAINSHOT\u2019, because it is a targeted attack with several stages and every stage depends on the input of the previous one.\n\nThis blog describes the process we took to analyze the malware, how we managed to decrypt the payloads, and then how we found parts of a new attack framework. We also found additional network infrastructure which indicates similar attacks were conducted against a wide range of targets with disparate interests. This attack chain is designed in a way that makes it very difficult to execute a single part on its own, be it the exploit or payload. To make our analysis easier, we reproduced the server-side infrastructure, by doing so we were able to conduct dynamic analysis and get a better understanding how the exploit and payload work together.\n\nThis serves as a follow-up of Icebrg\u2019s article which describes the initial findings.\n\n&nbsp;\n\nCracking a RSA Key\n\nFirst, let\u2019s recap how the overall attack chain works to understand at which point the RSA key is needed. The malicious Microsoft Excel document contains a tiny Shockwave Flash ActiveX object with the following properties:\n\n\nFigure 1. Malicious Shockwave Flash ActiveX object properties\nThe \u201cMovie\u201d property contains a URL to a Flash application which is downloaded in cleartext and then executed. The \u201cFlashVars\u201d property contains a long string with 4 URLs which are passed to the downloaded Flash application. The Flash application is an obfuscated downloader which creates a random 512-bit RSA key pair in memory of the process. While the private key remains only in memory, the public keys\u2019 modulus n is sent to the attacker\u2019s server. On the server side, the modulus is used together with the hardcoded exponent e 0x10001 to encrypt the 128-bit AES key which was used previously to encrypt the exploit and shellcode payload. The encrypted exploit or payload is sent back to the downloader which uses the in-memory private key to decrypt the AES key and the exploit or payload.\n\nAs the modulus is sent to the server of the attacker, it\u2019s also in our network capture. Together with the hardcoded exponent we have the public key which we can use to get the private key. Keep in mind that this was only possible because the attacker chose a key length of 512-bit which is known to be insecure. In order to do so, we have to factorize the modulus n into its two prime numbers p and q. Luckily this problem has already been solved previously, by an awesome public project \u2018Factoring as a Service\u2018. The project uses Amazon EC2\u2019s high computing power and can factorize large integers in just a matter of hours.\n\nFollowing this logic, let\u2019s take the following modulus of the public key sent to the attacker\u2019s server to get the shellcode payload.\n\n\nFigure 2. HTTP POST request for the encrypted shellcode payload with the modulus n in hexadecimal\nAfter removing the first 2 bytes which are used in this case to retrieve the 32-bit version of the shellcode payload, we have the following modulus in hexadecimal:\n0x7df305d5bcc659e5497e482bd0b507c44808deee8525f24b2712dc4a29f5c44e1e08c889a64521bbc67136ced11ace55b9bc2c1c7c96630aa515896b2f7341fd\nAfter we have factorized the integer, we get the following two prime numbers in decimal:\n\nP\n58243340170108004196473690380684093596548916771782361843168584750033311384553\nQ\n113257592704268871468251608331599268987586668983037892662393533567233998824693\nWith the help of p and q we can calculate the private key. We used a small public tool to create it in Privacy Enhanced Mail (PEM) format:\n-----BEGIN RSA PRIVATE KEY-----\nMIIBOgIBAAJAffMF1bzGWeVJfkgr0LUHxEgI3u6FJfJLJxLcSin1xE4eCMiJpkUh\nu8ZxNs7RGs5VubwsHHyWYwqlFYlrL3NB\/QIDAQABAkBog3SxE1AJItIkn2D0dHR4\ndUofLBCDF5czWlxAkqcleG6im1BptrNWdJyC5102H\/bMA9rhgQEDHx42hfyQiyTh\nAiEA+mWGmrUOSLL3TXGrPCJcrTsR3m5XHzPrh9vPinSNpPUCIQCAxI\/z9Jf10ufN\nPLE2JeDnGRULDPn9oCAqwsU0DWxD6QIhAPdiyRseWI9w6a5E6IXP+TpZSu00nLTC\nSih+\/kxvnOXlAiBZMc7VGVQ5f0H5tFS8QTisW39sDC0ONeCSPiADkliwIQIhAMDu\n3Dkj2yt7zz04\/H7KUV9WH+rdrhUmoGhA5UL2PzfP\n-----END RSA PRIVATE KEY-----\n\nWith the help of the private key we could now decrypt the 128-bit AES key. We used OpenSSL to do this:\nopenssl rsautl -decrypt -in enc_aes.bin -out dec_aes.bin -inkey private_key.pem\nThe encrypted AES key is extracted from the encrypted binary blob as described by Icebrg. It's at offset 0x4 and has the length of 0x40 bytes. Encrypted AES key:\n0x5BC64C5DC7EC96750CCB466935ED2183FE90212CB1BF6305F0B79B4B9D9261A4AC8A3E06F3E07D4037A40F4E221BB12E05B4DE2682B31617F177712BD12B501A\nDecrypted AES key:\n0xE4DF3353FD6D213E7400EEDA8B164FC0\nNow that we have the decrypted AES key, we can decrypt the actual payload. The Flash downloader uses a custom initialization vector (IV) for the AES algorithm which can be found at offset 0x44 in the encrypted blob and is 16 bytes long:\n0xCC6FC77B877584121AEBCBFD4C23B67C\nFor the final decryption we used OpenSSL again:\nopenssl enc -nosalt -aes-128-cbc -d -in payload.bin -out decrypted_payload -K E4DF3353FD6D213E7400EEDA8B164FC0 -iv CC6FC77B877584121AEBCBFD4C23B67C\nThe decrypted shellcode payload is additionally compressed with zlib which can be seen by looking at the first 2 magic bytes 0x789C. We decompressed it with Offzip. Finally, we have the decrypted shellcode payload. The same procedure can be used to decrypt the Flash exploit which isn\u2019t additionally zlib compressed.\n\n&nbsp;\n\nServer-side Reproduction\n\nAfter we had the decrypted Flash exploit and shellcode payloads, we started to do a static analysis which turned out to be a quite tedious task. This is due to the obfuscation in the exploit and the complexity of shellcode payload which contains its own two PE payloads. Next, we attempted to do a dynamic analysis which quickly turned out to be impossible, because every stage relies on data passed from the previous. The shellcode payload does not execute properly without the data passed to it from the exploit. The exploit does not execute on its own without the variables passed from the downloader and so on.\n\nDue to the difficulties of analyzing the code statically, we decided to reproduce a simplified version of the server-side PHP scripts in order to make a full dynamic analysis possible. As we had the decrypted exploit, shellcode payload and the PCAP, we had all the information required to do so. Specifically, we created the following setup:\n\n \tLocal Apache server with XAMPP, with the domain used in the attack configured to resolve to localhost\n \tA directory structure which mirrored that on the attackers\u2019 servers (as specified in the PCAPs)\n \tSetting of custom HTTP headers as per the PCAPs\u2019 responses.\n\nAll of the requested files are sent back gzip encoded, otherwise the attack chain doesn\u2019t work. We have uploaded the PHP scripts to our GitHub account, so you can also play with the different stages and see how it works.\n\n&nbsp;\n\nAdditional Details of the Flash Exploit\n\nWhile the exploit has been already described, we want to give some additional details surrounding it that we found during our analysis. In particular, we were interested in the part which transfers execution to the shellcode payload. While most parts of the decompiled ActionScript exploit code are obfuscated, luckily some method names were left in cleartext.\n\nBecause the decrypted shellcode payload doesn\u2019t run on its own when transformed into an executable, we have to figure out how execution works and if one or more parameters are passed. Therefore, the most interesting method for us is \u201cexecuteShellcodeWithCfg32\u201d which indicates we can find the passed data in it. It creates a small shellcode template and fills some placeholder values at runtime. The disassembled template looks as follows:\n\n\nFigure 3. Shellcode template with placeholders (red) in the Flash exploit to pass execution to the shellcode payload\nWhile the final prepared shellcode looks as follows:\n\n\nFigure 4. Runtime version of the shellcode template with filled placeholders\nLet\u2019s take a look at what values are set to the placeholders (0x11111111, 0x22222222, \u2026). The address 0xA543000 in Figure 4 is the entrypoint of the decrypted shellcode payload which has a small NOP sled in front of the actual code:\n\n\nFigure 5. Entrypoint of the shellcode template in memory\n&nbsp;\n\nThe address 0x771A1239 in Figure 4 is in the middle of the function NtPrivilegedServiceAuditAlarm in ntdll.dll:\n\n\nFigure 6. Windows API function NtPrivilegedServiceAuditAlarm\n&nbsp;\n\nHowever, we can also see in Figure 4 that before calling the API function via \u201ccall edx\u201d, the value 0x4D is moved into eax which is the ID of the API function NtProtectVirtualMemory. By doing so, the function NtProtectVirtualMemory is executed without calling it directly. This trick is likely used to bypass AVs\/sandboxes\/anti-exploit software which hook NtProtectVirtualMemory and the attacker probably chose NtPrivilegedServiceAuditAlarm as a trampoline as it\u2019s unlikely to be ever be monitored.\n\nThe data at this address 0x9DD200C in Figure 4 looks like a structure into which the last NTSTATUS return value of NtProtectVirtualMemory is copied. The address of this structure seems to be passed to the shellcode payload in ebx, however we haven\u2019t figured out what\u2019s its purpose is. Finally, shellcode payload is executed via \u201ccall edi\u201d\n\nTo sum up, the memory access rights of the shellcode payload are changed in 0x1000 byte blocks to RWE via NtProtectVirtualMemory. The last NTSTATUS code is saved into memory pointed to by ebx and the shellcode payload is executed.\n\nAnother interesting aspect of the exploit code is that it sends status messages when something goes wrong at every stage of the exploitation. These status messages are very similar to those send by the initial Flash downloader and are sent to the attacker\u2019s server via fake PNG files (see Icebrg). They also contain the \u201c\/stab\/\u201d directory in the URL and the actual message is also sent encoded via custom digit combinations. However, the status message of the exploitation code contains additional information in the form of abbreviations of the appropriate stage. By looking at those messages, we can get a better understanding how the exploit works. The following messages are possible:\n\n&nbsp;\n\n\n\nStatus message code\n\u00a0Description\n\n\n2-0-9-vp\nShort for VirtualProtect\n\n\n2-0-9-g3\nShort for something like gadget3 (ROP gadget) cause a byte array is created 0x5A5941584159C3 which disassembles to:\n\npop edx\n\npop ecx\n\ninc ecx\n\npop eax\n\ninc ecx\n\npop ecx\n\nretn\n\n\n2-0-9-RtlAllocateHeap\nSelf-explaining\n\n\n2-0-9-DeleteDC\nSelf-explaining\n\n\n2-0-9-GetDC\nSelf-explaining\n\n\n2-0-9-sprintf\nSelf-explaining\n\n\n2-0-9-VP\nShort for VirtualProtect\n\n\n2-0-9-RU\nShort for RtlUnwind\n\n\n2-0-9-NVP\nShort for NtProtectVirtualMemory\n\n\n2-0-9-NPSAA\nShort for NtPrivilegedServiceAuditAlarm\n\n\n2-0-9-G\nProbably short for Gadget\n\n\n2-0-9-SRP\nShort for something like StackReturnProcedure because two-byte arrays 0x81C4D8000000C3 and 0x81C4D0000000C3 are created which disassemble to:\n\nadd esp, 0D8h\n\nretn\n\n- and -\n\nadd esp, 0D0h\n\nretn\n\n\n2-0-9-PAX\nShort for something like PopEAX as a byte array 0x58C3 is created before which disassembles to:\n\npop eax\n\nretn\n\n\n\nTable 1. Status messages used in the Flash exploit code\nThe Shellcode Payload\n\nAfter the exploit successfully gains RWE permissions, execution is passed to the shellcode payload. The shellcode loads an embedded DLL internally named FirstStageDropper.dll, which we call CHAINSHOT, into memory and runs it by calling its export function \u201c__xjwz97\u201d. The DLL contains two resources, the first is x64 DLL internally named SecondStageDropper.dll and the second is a x64 kernelmode shellcode.\n\nFirstStageDropper.dll is responsible for injecting SecondStageDropper.dll into another process to execute it. While the shellcode payload only contains code to search for and bypass EMET, FirstStageDropper.dll also contains code for Kaspersky and Bitdefender. In case of EMET, it searches the loaded modules for emet.dll and emet64.dll, for Kaspersky it searches for klsihk.dll, and for Bitdefender it searches for avcuf32.dll and avcuf64.dll. It also collects and sends encrypted user system and process information data together with a unique hardcoded ID to the attacker's server. The data is sent to URLs that contain \u201c\/home\/\u201d and \u201c\/log\/\u201d directories and for encryption it uses the Rijndael algorithm. As the attacker server did not respond at the time of our analysis, we guess a command is sent back to execute the SecondStageDropper.dll.\n\nWhile the samples we obtained inject SecondStageDropper.dll in usermode via thread injection, the x64 shellcode seems to have an option to inject it from kernelmode. However, we haven\u2019t figured out what the exact purpose of it is, since it\u2019s never executed; it also searches for an additional resource which wasn\u2019t present in the samples we analyzed.\n\nThe kernelmode shellcode contains parts of Blackbone, an open source library for Windows memory hacking. The following functions are taken from its code:\n\n \tFindOrMapModule\n \tBBQueueUserApc\n \tBBCallRoutine\n \tBBExecuteInNewThread\n\nIt also contains code from TitanHide, using identical code to lookup SSDT in Win7 and Win10 as described by the author.\n\nSecondStageDropper.dll acts as a downloader for the final payload. It collects various information from the victim system, encrypts it, and sends it to the attacker\u2019s server. It also scans for the following processes and skips execution if found:\n\n&nbsp;\n\n\n\nProcess name\nSecurity Solution\n\n\nadawareservice.exe\n\nadawareservicetray.exe\nAdaware\n\n\nmbam.exe\nMalwarebytes\n\n\nbdagent.exe\n\nbdwtxag.exe\n\nseccecenter.exe (contains a typo, should be seccenter.exe)\n\nvsserv.exe\n\nupdatesrv.exe\n\nodscanui.exe\n\nodsw.exe\nBitdefender\n\n\nefainst.exe\n\nelaminst.exe\n\ninstca.exe\n\nmcui32.exe\n\nnavw32.exe\n\nncolow.exe\n\nnsbu.exe\n\nsrtsp_ca.exe\n\nsymdgnhc.exe\n\nsymerr.exe\n\ntuih.exe\n\nwfpunins.exe\n\nwscstub.exe\nSymantec \/ Norton\n\n\navp.exe\nKaspersky\n\n\nHitmanPro.exe\nSophos \/ HitmanPro\n\n\nabcde.exe\n?\n\n\n\nTable 2. Process name lookup list\n&nbsp;\n\nUnfortunately, at the time of the analysis we were unable to obtain additional files, so we were unable to figure out what the final stage is. However, CHAINSHOT contacts the following domains via HTTPS to get the final payload:\n\n \tcontact.planturidea[.]net\n \tdl.nmcyclingexperience[.]com\n \ttools.conductorstech[.]com\n\nIn both samples we analyzed the final domains used were the same. We have obtained two x86 versions of the shellcode payload with its embedded PE files and the kernelmode shellcode. While the shellcode payload, FirstStageDropper.dll and kernel shellcode do not differ, the SecondStageDropper.dll contains a couple of different strings. The following strings are different, possibly indicating they are changed for every victim, with the final payload directory being an MD5 representation of the \u201cproject name\u201d or something similar.\n\n\n\n\u00a0\nSample 1\nSample 2\n\n\nUser-agent\nMozilla\/5.0 (Windows NT 6.4; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/36.0.1985.143 Safari\/537.36 Edge\/12.0\nMozilla\/5.0 (Windows NT 6.3; Win64; x64; rv:10.0) Gecko\/20100101 Firefox\/10.0\n\n\nQueried final payload directories\n\n&nbsp;\n\/0cd173cf1caa2aa03a52b80d7521cc75e\n\n\/1cd173cf1caa2aa03a52b80d7521cc75e\n\/0fa0a5fc0d2e28cc3786e5d6eb273f1fa\n\n\/1fa0a5fc0d2e28cc3786e5d6eb273f1fa\n\n\nUnique string used in network communication\n148a028d-57c6-4094-b07d-720df09246dd\n3784113f-b04e-4c1e-b3be-6b0a22464921\n\n\n\nTable 3. String differences in SecondStageDropper.dll\n&nbsp;\n\nThe shellcode payload and PE files partly contain the same code indicating a framework was used to create them. For example, both the shellcode and CHAINSHOT itself make extensive use of the same exception handling with custom error codes. They also both use the same code to scan for and bypass EMET. Furthermore, other parts such as the OS version recognition are identical in all samples and the PE files\u2019 compilation timestamps are zeroed out. Another interesting fact is that FirstStageDropper.dll also sends status messages back to the attacker starting with digit \u201c9\u201d. For example, the following network capture from our local tests show a successful network communication up to the point where the attacker presumably sends back the command to execute SecondStageDropper.dll:\n\n\nFigure 7. Network capture of a successful attack reproduced locally in a VM\nAdditional Infrastructure\n\nOne of the domains reported by IceBrg had an associated SSL certificate which was documented in their write up. By searching for other IP addresses using the same certificate we were able to find a large number of associated domains that were likely also used in similar attack campaigns. Just like the domain contacted within the Excel documents analyzed, the additional domain names are created in a similar way using similar hosting providers and registrars and used names which are very similar to official websites to avoid suspicion. The list of domains can be found in the IOC section.\n\n&nbsp;\n\nConclusion\n\nWe uncovered part of a new toolkit which was used as a downloader alongside Adobe Flash exploit CVE-2018-5002 to target victims in the Middle East. This was possible because the attacker made a mistake in using insecure 512-bit RSA encryption. The malware sends user information encrypted to the attacker server and attempts to download a final stage implant. It was allegedly developed with the help of an unknown framework and makes extensive use of custom error handling. Because the attacker made another mistake in using the same SSL certificate for similar attacks, we were able to uncover additional infrastructure indicating a larger campaign.\n\nPalo Alto Networks customers are protected from this threat in the following ways:\n\n \tWildFire detects all malicious Excel documents, the Flash downloader and exploit and all CHAINSHOT samples with malicious verdicts\n \tAutoFocus customers can track the samples with the CVE-2018-5002 exploit and CHAINSHOT malware tags\n \tTraps detects and blocks the malicious Excel documents with the Flash exploit\n\nFinally, we\u2019d like to thank Tom Lancaster for his assistance in this investigation.\n\n&nbsp;\n\nIndicators of Compromise\n\nAdobe Flash Downloader\n\n189f707cecff924bc2324e91653d68829ea55069bc4590f497e3a34fa15e155c\n\n&nbsp;\n\nAdobe Flash Exploit (CVE-2018-5002)\n\n3e8cc2b30ece9adc96b0a9f626aefa4a88017b2f6b916146a3bbd0f99ce1e497\n\n&nbsp;\n\nCHAINSHOT Samples\n\nX86 Shellcode Payloads:\n\nd75de8f7a132e0eb922d4b57f1ce8db47dfcae4477817d9f737762e486283795\n\n2d7cb5ff4a449fa284721f83e352098c2fdea125f756322c90a40ad3ebc5e40d\n\n&nbsp;\n\nFirstStageDropper.dll:\n\na260d222dfc94b91a09485647c21acfa4a26469528ec4b1b49469db3b283eb9a\n\na09273b4cc08c39afe0c964f14cef98e532ae530eb60b93aec669731c185ea23\n\n&nbsp;\n\nSecondStageDropper.dll:\n\n43f7ae58e8e5471917178430f3425061d333b736974f4b2784ca543e3093204b\n\n3485c9b79dfd3e00aef9347326b9ccfee588018a608f89ecd6597da552e3872f\n\n&nbsp;\n\nInfrastructure\n\nftp[.]oceasndata[.]com\n\ndl[.]beanfile[.]com\n\neukaznews[.]com\n\nexclusivesstregis[.]com\n\nfishing-uae[.]com\n\napi[.]usecisco[.]info\n\ngulfnews[.]uae-travel-advisories[.]com\n\nqatar[.]eng-theguardian[.]com\n\nmalomatiaa[.]com\n\nnews[.]theqatarpeninsula[.]com\n\npeople[.]dohabayt[.]com\n\nqatar[.]doharotanatimes[.]com\n\nsites[.]oceasndata[.]com\n\nqatar[.]smallwarjournal[.]com\n\nqatarembassies[.]com\n\nsa[.]eukaznews[.]com\n\nsec[.]oceasndata[.]com\n\nrss[.]beanfile[.]com\n\nusecisco[.]info\n\nsmallwarjournal[.]com\n\nawareness-qcert[.]net\n\nspecials[.]fishing-uae[.]com\n\ntheqatarpeninsula[.]com\n\nuae-travel-advisories[.]com\n\neng-theguardian[.]com\n\nsecurityandpolicing[.]me\n\napi[.]qcybersecurity[.]org\n\nqatar-sse[.]com\n\napi[.]motc-gov[.]info\n\nyouraccount-security-check[.]com\n\napi[.]exclusivesstregis[.]com\n\nnewhorizonsdoha[.]com\n\nsandp2018[.]securityandpolicing[.]me\n\nicoinico[.]one\n\napi[.]dohabayt[.]com\n\nthelres[.]com\n\nnews[.]gulf-updates[.]com\n\nqatarconferences[.]thelres[.]com\n\napi[.]smallwarjournal[.]com\n\nqcybersecurity[.]org\n\nikhwan-portal[.]com\n\ngulf-updates[.]com\n\napi[.]qatar-sse[.]com\n\ninfo[.]awareness-qcert[.]net\n\napi[.]newhorizonsdoha[.]com\n\ninternationsplanet[.]com\n\nwww[.]winword[.]co\n\nwww[.]oceasndata[.]com\n\npeople[.]dohabayt[.]com\n\neng-defenseadvisers[.]com\n\nmotc-gov[.]info\n\nbeanfile[.]com\n\nnews[.]eng-defenseadvisers[.]com\n\nwinword[.]co\n\ndocuments[.]malomatiaa[.]com\n\nbern[.]qatarembassies[.]com\n\nsurveydoha[.]com\n\ndocuments[.]malomatiaa[.]com\n\ndohabayt[.]com\n\ndoharotanatimes[.]com\n\nactivity[.]youraccount-security-check[.]com\n\npoll[.]surveydoha[.]com\n\napi[.]thelres[.]com\n\nq-miles[.]com\n\nrewards[.]q-miles[.]com\n\noceasndata[.]com\n\napi[.]people[.]dohabayt[.]com\n\nbangkok[.]exclusivesstregis[.]com\n\nevents[.]ikhwan-portal[.]com\n\ncontact[.]planturidea[.]net\n\ndl[.]nmcyclingexperience[.]com\n\ntools[.]conductorstech[.]com","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2018\/04\/unit42-blog-600x300-150x150.jpg","width":150,"height":150},"author":[{"@type":"Person","name":"Dominik Reichel"},{"@type":"Person","name":"Esmid Idrizovic"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.1' type='text/css' media='all' />
<link rel='stylesheet' id='bodhi-svgs-attachment-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/svg-support/css/svgs-attachment.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.0.1' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":"89810","token":"b09d8c8c9d","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp-5.0.0.min.js?ver=5.0.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.3.5'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=89810' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.3.5 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>
  <body class="post-template-default single single-post postid-89810 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/"><img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" /></a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-98931" class="menu-item menu-item-type-post_type_archive menu-item-object-events menu-item-98931"><a href="https://unit42.paloaltonetworks.com/events/">Speaking Events</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>

  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">Slicing and Dicing CVE-2018-5002 Payloads: New CHAINSHOT Malware</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-89810 entry-meta">
			
			
			<span class="post-views-count">16,783</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'89810','like')"><i class="ui ui-2"></i><span class="ml-5">3</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 11</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware%2F+-+Slicing+and+Dicing+CVE-2018-5002+Payloads%3A+New+CHAINSHOT+Malware" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware%2F&title=Slicing+and+Dicing+CVE-2018-5002+Payloads%3A+New+CHAINSHOT+Malware&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/unit42-slicing-dicing-cve-2018-5002-payloads-new-chainshot-malware/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/dominik-reichel/" title="Posts by Dominik Reichel" class="author url fn" rel="author">Dominik Reichel</a> and <a href="https://unit42.paloaltonetworks.com/author/esmid-idrizovic/" title="Posts by Esmid Idrizovic" class="author url fn" rel="author">Esmid Idrizovic</a>        </p>
        <p><time datetime="2018-09-06T20:00:48+00:00">September 6, 2018 at 1:00 PM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/adobe/" rel="tag">adobe</a>, <a href="https://unit42.paloaltonetworks.com/tag/chainshot/" rel="tag">CHAINSHOT</a>, <a href="https://unit42.paloaltonetworks.com/tag/cve-2018-5002/" rel="tag">CVE-2018-5002</a>, <a href="https://unit42.paloaltonetworks.com/tag/zero-day/" rel="tag">zero-day</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="600" height="300" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" class="attachment-single size-single wp-post-image" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg 600w, https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300-300x150.jpg 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300-370x185.jpg 370w" sizes="(max-width: 600px) 100vw, 600px" />            </figure>
                    <p>This story begins with one of our blog authors, who, <a href="http://blogs.360.cn/post/cve-2018-5002-en.html">following the discovery of a new Adobe Flash 0-day</a>, found several documents using the same exploit that were used in targeted attacks. We were also able to collect network captures including the encrypted malware payload. Armed with these initial weaponized documents, we uncovered additional attacker network infrastructure, were able to crack the 512-bit RSA keys, and decrypt the exploit and malware payloads. We have dubbed the malware ‘CHAINSHOT’, because it is a targeted attack with several stages and every stage depends on the input of the previous one.</p>
<p>This blog describes the process we took to analyze the malware, how we managed to decrypt the payloads, and then how we found parts of a new attack framework. We also found additional network infrastructure which indicates similar attacks were conducted against a wide range of targets with disparate interests. This attack chain is designed in a way that makes it very difficult to execute a single part on its own, be it the exploit or payload. To make our analysis easier, we reproduced the server-side infrastructure, by doing so we were able to conduct dynamic analysis and get a better understanding how the exploit and payload work together.</p>
<p>This serves as a follow-up of Icebrg’s<a href="https://www.icebrg.io/blog/adobe-flash-zero-day-targeted-attack"> article</a> which describes the initial findings.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">Cracking a RSA Key</span></p>
<p>First, let’s recap how the overall attack chain works to understand at which point the RSA key is needed. The malicious Microsoft Excel document contains a tiny Shockwave Flash ActiveX object with the following properties:</p>
<p><img class="aligncenter wp-image-90047" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_1.png" alt="slicing_1" width="600" height="495" /></p>
<p style="text-align: center"><em>Figure 1. Malicious Shockwave Flash ActiveX object properties</em></p>
<p>The “Movie” property contains a URL to a Flash application which is downloaded in cleartext and then executed. The “FlashVars” property contains a long string with 4 URLs which are passed to the downloaded Flash application. The Flash application is an obfuscated downloader which creates a random 512-bit RSA key pair in memory of the process. While the private key remains only in memory, the public keys’ modulus n is sent to the attacker’s server. On the server side, the modulus is used together with the hardcoded exponent e 0x10001 to encrypt the 128-bit AES key which was used previously to encrypt the exploit and shellcode payload. The encrypted exploit or payload is sent back to the downloader which uses the in-memory private key to decrypt the AES key and the exploit or payload.</p>
<p>As the modulus is sent to the server of the attacker, it’s also in our network capture. Together with the hardcoded exponent we have the public key which we can use to get the private key. Keep in mind that this was only possible because the attacker chose a key length of 512-bit which is known to be insecure. In order to do so, we have to factorize the modulus n into its two prime numbers p and q. Luckily this problem has already been solved previously, by an awesome public project ‘<a href="https://github.com/eniac/faas/">Factoring as a Service</a>‘. The project uses Amazon EC2’s high computing power and can factorize large integers in just a matter of hours.</p>
<p>Following this logic, let’s take the following modulus of the public key sent to the attacker’s server to get the shellcode payload.</p>
<p><img class="aligncenter wp-image-90008" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_2.png" alt="slicing_2" width="600" height="121" /></p>
<p style="text-align: center"><em>Figure 2. HTTP POST request for the encrypted shellcode payload with the modulus n in hexadecimal</em></p>
<p>After removing the first 2 bytes which are used in this case to retrieve the 32-bit version of the shellcode payload, we have the following modulus in hexadecimal:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7be078631022" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
0x7df305d5bcc659e5497e482bd0b507c44808deee8525f24b2712dc4a29f5c44e1e08c889a64521bbc67136ced11ace55b9bc2c1c7c96630aa515896b2f7341fd</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7be078631022-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7be078631022-1"><span class="crayon-cn">0x7df305d5bcc659e5497e482bd0b507c44808deee8525f24b2712dc4a29f5c44e1e08c889a64521bbc67136ced11ace55b9bc2c1c7c96630aa515896b2f7341fd</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>After we have factorized the integer, we get the following two prime numbers in decimal:</p>
<p><strong>P</strong></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7c8965452000" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
58243340170108004196473690380684093596548916771782361843168584750033311384553</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7c8965452000-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7c8965452000-1"><span class="crayon-cn">58243340170108004196473690380684093596548916771782361843168584750033311384553</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><strong>Q</strong></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7cb513264719" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
113257592704268871468251608331599268987586668983037892662393533567233998824693</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7cb513264719-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7cb513264719-1"><span class="crayon-cn">113257592704268871468251608331599268987586668983037892662393533567233998824693</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>With the help of p and q we can calculate the private key. We used a small public <a href="https://github.com/daniellerch/snippets/blob/master/cryptography/get_priv_key.c">tool</a> to create it in Privacy Enhanced Mail (PEM) format:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7cd332139080" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
-----BEGIN RSA PRIVATE KEY-----
MIIBOgIBAAJAffMF1bzGWeVJfkgr0LUHxEgI3u6FJfJLJxLcSin1xE4eCMiJpkUh
u8ZxNs7RGs5VubwsHHyWYwqlFYlrL3NB/QIDAQABAkBog3SxE1AJItIkn2D0dHR4
dUofLBCDF5czWlxAkqcleG6im1BptrNWdJyC5102H/bMA9rhgQEDHx42hfyQiyTh
AiEA+mWGmrUOSLL3TXGrPCJcrTsR3m5XHzPrh9vPinSNpPUCIQCAxI/z9Jf10ufN
PLE2JeDnGRULDPn9oCAqwsU0DWxD6QIhAPdiyRseWI9w6a5E6IXP+TpZSu00nLTC
Sih+/kxvnOXlAiBZMc7VGVQ5f0H5tFS8QTisW39sDC0ONeCSPiADkliwIQIhAMDu
3Dkj2yt7zz04/H7KUV9WH+rdrhUmoGhA5UL2PzfP
-----END RSA PRIVATE KEY-----</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7cd332139080-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69288bad7cd332139080-2">2</div><div class="crayon-num" data-line="crayon-5f69288bad7cd332139080-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69288bad7cd332139080-4">4</div><div class="crayon-num" data-line="crayon-5f69288bad7cd332139080-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69288bad7cd332139080-6">6</div><div class="crayon-num" data-line="crayon-5f69288bad7cd332139080-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5f69288bad7cd332139080-8">8</div><div class="crayon-num" data-line="crayon-5f69288bad7cd332139080-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7cd332139080-1"><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-e">BEGIN </span><span class="crayon-e">RSA </span><span class="crayon-m">PRIVATE</span><span class="crayon-h"> </span><span class="crayon-v">KEY</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69288bad7cd332139080-2"><span class="crayon-e">MIIBOgIBAAJAffMF1bzGWeVJfkgr0LUHxEgI3u6FJfJLJxLcSin1xE4eCMiJpkUh</span></div><div class="crayon-line" id="crayon-5f69288bad7cd332139080-3"><span class="crayon-v">u8ZxNs7RGs5VubwsHHyWYwqlFYlrL3NB</span><span class="crayon-o">/</span><span class="crayon-e">QIDAQABAkBog3SxE1AJItIkn2D0dHR4</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69288bad7cd332139080-4"><span class="crayon-v">dUofLBCDF5czWlxAkqcleG6im1BptrNWdJyC5102H</span><span class="crayon-o">/</span><span class="crayon-e">bMA9rhgQEDHx42hfyQiyTh</span></div><div class="crayon-line" id="crayon-5f69288bad7cd332139080-5"><span class="crayon-v">AiEA</span><span class="crayon-o">+</span><span class="crayon-v">mWGmrUOSLL3TXGrPCJcrTsR3m5XHzPrh9vPinSNpPUCIQCAxI</span><span class="crayon-o">/</span><span class="crayon-e">z9Jf10ufN</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69288bad7cd332139080-6"><span class="crayon-v">PLE2JeDnGRULDPn9oCAqwsU0DWxD6QIhAPdiyRseWI9w6a5E6IXP</span><span class="crayon-o">+</span><span class="crayon-e">TpZSu00nLTC</span></div><div class="crayon-line" id="crayon-5f69288bad7cd332139080-7"><span class="crayon-v">Sih</span><span class="crayon-o">+</span><span class="crayon-o">/</span><span class="crayon-i">kxvnOXlAiBZMc7VGVQ5f0H5tFS8QTisW39sDC0ONeCSPiADkliwIQIhAMDu</span></div><div class="crayon-line crayon-striped-line" id="crayon-5f69288bad7cd332139080-8"><span class="crayon-cn">3Dkj2yt7zz04</span><span class="crayon-o">/</span><span class="crayon-v">H7KUV9WH</span><span class="crayon-o">+</span><span class="crayon-v">rdrhUmoGhA5UL2PzfP</span></div><div class="crayon-line" id="crayon-5f69288bad7cd332139080-9"><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span><span class="crayon-st">END</span><span class="crayon-h"> </span><span class="crayon-e">RSA </span><span class="crayon-m">PRIVATE</span><span class="crayon-h"> </span><span class="crayon-v">KEY</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">-</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>With the help of the private key we could now decrypt the 128-bit AES key. We used OpenSSL to do this:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7cf438433598" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
openssl rsautl -decrypt -in enc_aes.bin -out dec_aes.bin -inkey private_key.pem</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7cf438433598-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7cf438433598-1"><span class="crayon-e">openssl </span><span class="crayon-v">rsautl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">decrypt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">enc_aes</span><span class="crayon-sy">.</span><span class="crayon-v">bin</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">dec_aes</span><span class="crayon-sy">.</span><span class="crayon-v">bin</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">inkey </span><span class="crayon-v">private_key</span><span class="crayon-sy">.</span><span class="crayon-v">pem</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The encrypted AES key is extracted from the encrypted binary blob as described by Icebrg. It&#8217;s at offset 0x4 and has the length of 0x40 bytes. Encrypted AES key:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7e0001201657" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
0x5BC64C5DC7EC96750CCB466935ED2183FE90212CB1BF6305F0B79B4B9D9261A4AC8A3E06F3E07D4037A40F4E221BB12E05B4DE2682B31617F177712BD12B501A</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7e0001201657-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7e0001201657-1"><span class="crayon-cn">0x5BC64C5DC7EC96750CCB466935ED2183FE90212CB1BF6305F0B79B4B9D9261A4AC8A3E06F3E07D4037A40F4E221BB12E05B4DE2682B31617F177712BD12B501A</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Decrypted AES key:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7e3373672947" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
0xE4DF3353FD6D213E7400EEDA8B164FC0</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7e3373672947-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7e3373672947-1"><span class="crayon-cn">0xE4DF3353FD6D213E7400EEDA8B164FC0</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now that we have the decrypted AES key, we can decrypt the actual payload. The Flash downloader uses a custom initialization vector (IV) for the AES algorithm which can be found at offset 0x44 in the encrypted blob and is 16 bytes long:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7e5658952516" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
0xCC6FC77B877584121AEBCBFD4C23B67C</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7e5658952516-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7e5658952516-1"><span class="crayon-cn">0xCC6FC77B877584121AEBCBFD4C23B67C</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>For the final decryption we used OpenSSL again:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f69288bad7e6250691051" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
openssl enc -nosalt -aes-128-cbc -d -in payload.bin -out decrypted_payload -K E4DF3353FD6D213E7400EEDA8B164FC0 -iv CC6FC77B877584121AEBCBFD4C23B67C</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5f69288bad7e6250691051-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5f69288bad7e6250691051-1"><span class="crayon-e">openssl </span><span class="crayon-v">enc</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">nosalt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">aes</span><span class="crayon-o">-</span><span class="crayon-cn">128</span><span class="crayon-o">-</span><span class="crayon-v">cbc</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">.</span><span class="crayon-v">bin</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">decrypted_payload</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">K</span><span class="crayon-h"> </span><span class="crayon-v">E4DF3353FD6D213E7400EEDA8B164FC0</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">iv </span><span class="crayon-v">CC6FC77B877584121AEBCBFD4C23B67C</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>The decrypted shellcode payload is additionally compressed with zlib which can be seen by looking at the first 2 magic bytes 0x789C. We decompressed it with <a href="http://aluigi.altervista.org/mytoolz.htm">Offzip</a>. Finally, we have the decrypted shellcode payload. The same procedure can be used to decrypt the Flash exploit which isn’t additionally zlib compressed.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">Server-side Reproduction</span></p>
<p>After we had the decrypted Flash exploit and shellcode payloads, we started to do a static analysis which turned out to be a quite tedious task. This is due to the obfuscation in the exploit and the complexity of shellcode payload which contains its own two PE payloads. Next, we attempted to do a dynamic analysis which quickly turned out to be impossible, because every stage relies on data passed from the previous. The shellcode payload does not execute properly without the data passed to it from the exploit. The exploit does not execute on its own without the variables passed from the downloader and so on.</p>
<p>Due to the difficulties of analyzing the code statically, we decided to reproduce a simplified version of the server-side PHP scripts in order to make a full dynamic analysis possible. As we had the decrypted exploit, shellcode payload and the PCAP, we had all the information required to do so. Specifically, we created the following setup:</p>
<ul>
<li>Local Apache server with XAMPP, with the domain used in the attack configured to resolve to localhost</li>
<li>A directory structure which mirrored that on the attackers’ servers (as specified in the PCAPs)</li>
<li>Setting of custom HTTP headers as per the PCAPs’ responses.</li>
</ul>
<p>All of the requested files are sent back gzip encoded, otherwise the attack chain doesn’t work. We have uploaded the PHP scripts to our <a href="https://github.com/pan-unit42/iocs/tree/master/pb40">GitHub account</a>, so you can also play with the different stages and see how it works.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">Additional Details of the Flash Exploit</span></p>
<p>While the exploit has been already <a href="https://s.tencent.com/research/report/489.html">described</a>, we want to give some additional details surrounding it that we found during our analysis. In particular, we were interested in the part which transfers execution to the shellcode payload. While most parts of the decompiled ActionScript exploit code are obfuscated, luckily some method names were left in cleartext.</p>
<p>Because the decrypted shellcode payload doesn’t run on its own when transformed into an executable, we have to figure out how execution works and if one or more parameters are passed. Therefore, the most interesting method for us is “executeShellcodeWithCfg32” which indicates we can find the passed data in it. It creates a small shellcode template and fills some placeholder values at runtime. The disassembled template looks as follows:</p>
<p><img class="size-full wp-image-89969 aligncenter" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_3.png" alt="slicing_3" width="370" height="670" /></p>
<p style="text-align: center"><em>Figure 3. Shellcode template with placeholders (red) in the Flash exploit to pass execution to the shellcode payload</em></p>
<p>While the final prepared shellcode looks as follows:</p>
<p><img class="aligncenter wp-image-89930" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_4.png" alt="slicing_4" width="600" height="539" /></p>
<p style="text-align: center"><em>Figure 4. Runtime version of the shellcode template with filled placeholders</em></p>
<p>Let’s take a look at what values are set to the placeholders (0x11111111, 0x22222222, …). The address 0xA543000 in Figure 4 is the entrypoint of the decrypted shellcode payload which has a small NOP sled in front of the actual code:</p>
<p><img class="aligncenter wp-image-89891" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_5.png" alt="slicing_5" width="600" height="583" /></p>
<p style="text-align: center"><em>Figure 5. Entrypoint of the shellcode template in memory</em></p>
<p>&nbsp;</p>
<p>The address 0x771A1239 in Figure 4 is in the middle of the function NtPrivilegedServiceAuditAlarm in ntdll.dll:</p>
<p><img class="aligncenter wp-image-89852" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/slicing_6.png" alt="slicing_6" width="600" height="54" /></p>
<p style="text-align: center"><em>Figure 6. Windows API function NtPrivilegedServiceAuditAlarm</em></p>
<p>&nbsp;</p>
<p>However, we can also see in Figure 4 that before calling the API function via “call edx”, the value 0x4D is moved into eax which is the ID of the API function NtProtectVirtualMemory. By doing so, the function NtProtectVirtualMemory is executed without calling it directly. This trick is likely used to bypass AVs/sandboxes/anti-exploit software which hook NtProtectVirtualMemory and the attacker probably chose NtPrivilegedServiceAuditAlarm as a trampoline as it’s unlikely to be ever be monitored.</p>
<p>The data at this address 0x9DD200C in Figure 4 looks like a structure into which the last NTSTATUS return value of NtProtectVirtualMemory is copied. The address of this structure seems to be passed to the shellcode payload in ebx, however we haven’t figured out what’s its purpose is. Finally, shellcode payload is executed via “call edi”</p>
<p>To sum up, the memory access rights of the shellcode payload are changed in 0x1000 byte blocks to RWE via NtProtectVirtualMemory. The last NTSTATUS code is saved into memory pointed to by ebx and the shellcode payload is executed.</p>
<p>Another interesting aspect of the exploit code is that it sends status messages when something goes wrong at every stage of the exploitation. These status messages are very similar to those send by the initial Flash downloader and are sent to the attacker’s server via fake PNG files (see Icebrg). They also contain the “/stab/” directory in the URL and the actual message is also sent encoded via custom digit combinations. However, the status message of the exploitation code contains additional information in the form of abbreviations of the appropriate stage. By looking at those messages, we can get a better understanding how the exploit works. The following messages are possible:</p>
<p>&nbsp;</p>
<table align="center">
<tbody>
<tr>
<td width="300"><strong>Status message code</strong></td>
<td width="300"> <strong>Description</strong></td>
</tr>
<tr>
<td width="300">2-0-9-vp</td>
<td width="300">Short for VirtualProtect</td>
</tr>
<tr>
<td width="300">2-0-9-g3</td>
<td width="300">Short for something like gadget3 (ROP gadget) cause a byte array is created 0x5A5941584159C3 which disassembles to:</p>
<p>pop edx</p>
<p>pop ecx</p>
<p>inc ecx</p>
<p>pop eax</p>
<p>inc ecx</p>
<p>pop ecx</p>
<p>retn</td>
</tr>
<tr>
<td width="300">2-0-9-RtlAllocateHeap</td>
<td width="300">Self-explaining</td>
</tr>
<tr>
<td width="300">2-0-9-DeleteDC</td>
<td width="300">Self-explaining</td>
</tr>
<tr>
<td width="300">2-0-9-GetDC</td>
<td width="300">Self-explaining</td>
</tr>
<tr>
<td width="300">2-0-9-sprintf</td>
<td width="300">Self-explaining</td>
</tr>
<tr>
<td width="300">2-0-9-VP</td>
<td width="300">Short for VirtualProtect</td>
</tr>
<tr>
<td width="300">2-0-9-RU</td>
<td width="300">Short for RtlUnwind</td>
</tr>
<tr>
<td width="300">2-0-9-NVP</td>
<td width="300">Short for NtProtectVirtualMemory</td>
</tr>
<tr>
<td width="300">2-0-9-NPSAA</td>
<td width="300">Short for NtPrivilegedServiceAuditAlarm</td>
</tr>
<tr>
<td width="300">2-0-9-G</td>
<td width="300">Probably short for Gadget</td>
</tr>
<tr>
<td width="300">2-0-9-SRP</td>
<td width="300">Short for something like StackReturnProcedure because two-byte arrays 0x81C4D8000000C3 and 0x81C4D0000000C3 are created which disassemble to:</p>
<p>add esp, 0D8h</p>
<p>retn</p>
<p>&#8211; and &#8211;</p>
<p>add esp, 0D0h</p>
<p>retn</td>
</tr>
<tr>
<td width="300">2-0-9-PAX</td>
<td width="300">Short for something like PopEAX as a byte array 0x58C3 is created before which disassembles to:</p>
<p>pop eax</p>
<p>retn</td>
</tr>
</tbody>
</table>
<p style="text-align: center"><em>Table 1. Status messages used in the Flash exploit code</em></p>
<p><span style="font-size: 18pt">The Shellcode Payload</span></p>
<p>After the exploit successfully gains RWE permissions, execution is passed to the shellcode payload. The shellcode loads an embedded DLL internally named FirstStageDropper.dll, which we call CHAINSHOT, into memory and runs it by calling its export function “__xjwz97”. The DLL contains two resources, the first is x64 DLL internally named SecondStageDropper.dll and the second is a x64 kernelmode shellcode.</p>
<p>FirstStageDropper.dll is responsible for injecting SecondStageDropper.dll into another process to execute it. While the shellcode payload only contains code to search for and bypass EMET, FirstStageDropper.dll also contains code for Kaspersky and Bitdefender. In case of EMET, it searches the loaded modules for emet.dll and emet64.dll, for Kaspersky it searches for klsihk.dll, and for Bitdefender it searches for avcuf32.dll and avcuf64.dll. It also collects and sends encrypted user system and process information data together with a unique hardcoded ID to the attacker&#8217;s server. The data is sent to URLs that contain “/home/” and “/log/” directories and for encryption it uses the Rijndael algorithm. As the attacker server did not respond at the time of our analysis, we guess a command is sent back to execute the SecondStageDropper.dll.</p>
<p>While the samples we obtained inject SecondStageDropper.dll in usermode via thread injection, the x64 shellcode seems to have an option to inject it from kernelmode. However, we haven’t figured out what the exact purpose of it is, since it’s never executed; it also searches for an additional resource which wasn’t present in the samples we analyzed.</p>
<p>The kernelmode shellcode contains parts of <a href="https://github.com/DarthTon/Blackbone">Blackbone</a>, an open source library for Windows memory hacking. The following functions are taken from its code:</p>
<ul>
<li>FindOrMapModule</li>
<li>BBQueueUserApc</li>
<li>BBCallRoutine</li>
<li>BBExecuteInNewThread</li>
</ul>
<p>It also contains code from <a href="https://github.com/mrexodia/TitanHide">TitanHide</a>, using identical code to lookup SSDT in Win7 and Win10 as <a href="https://mrexodia.cf/reversing/2015/02/05/TitanHide">described</a> by the author.</p>
<p>SecondStageDropper.dll acts as a downloader for the final payload. It collects various information from the victim system, encrypts it, and sends it to the attacker’s server. It also scans for the following processes and skips execution if found:</p>
<p>&nbsp;</p>
<table align="center">
<tbody>
<tr>
<td width="300"><strong>Process name</strong></td>
<td width="300"><strong>Security Solution</strong></td>
</tr>
<tr>
<td width="300">adawareservice.exe</p>
<p>adawareservicetray.exe</td>
<td width="300">Adaware</td>
</tr>
<tr>
<td width="300">mbam.exe</td>
<td width="300">Malwarebytes</td>
</tr>
<tr>
<td width="300">bdagent.exe</p>
<p>bdwtxag.exe</p>
<p>seccecenter.exe (contains a typo, should be seccenter.exe)</p>
<p>vsserv.exe</p>
<p>updatesrv.exe</p>
<p>odscanui.exe</p>
<p>odsw.exe</td>
<td width="300">Bitdefender</td>
</tr>
<tr>
<td width="300">efainst.exe</p>
<p>elaminst.exe</p>
<p>instca.exe</p>
<p>mcui32.exe</p>
<p>navw32.exe</p>
<p>ncolow.exe</p>
<p>nsbu.exe</p>
<p>srtsp_ca.exe</p>
<p>symdgnhc.exe</p>
<p>symerr.exe</p>
<p>tuih.exe</p>
<p>wfpunins.exe</p>
<p>wscstub.exe</td>
<td width="300">Symantec / Norton</td>
</tr>
<tr>
<td width="300">avp.exe</td>
<td width="300">Kaspersky</td>
</tr>
<tr>
<td width="300">HitmanPro.exe</td>
<td width="300">Sophos / HitmanPro</td>
</tr>
<tr>
<td width="300">abcde.exe</td>
<td width="300">?</td>
</tr>
</tbody>
</table>
<p style="text-align: center"><em>Table 2. Process name lookup list</em></p>
<p>&nbsp;</p>
<p>Unfortunately, at the time of the analysis we were unable to obtain additional files, so we were unable to figure out what the final stage is. However, CHAINSHOT contacts the following domains via HTTPS to get the final payload:</p>
<ul>
<li>contact.planturidea[.]net</li>
<li>dl.nmcyclingexperience[.]com</li>
<li>tools.conductorstech[.]com</li>
</ul>
<p>In both samples we analyzed the final domains used were the same. We have obtained two x86 versions of the shellcode payload with its embedded PE files and the kernelmode shellcode. While the shellcode payload, FirstStageDropper.dll and kernel shellcode do not differ, the SecondStageDropper.dll contains a couple of different strings. The following strings are different, possibly indicating they are changed for every victim, with the final payload directory being an MD5 representation of the “project name” or something similar.</p>
<table align="center">
<tbody>
<tr>
<td width="123"><strong> </strong></td>
<td width="234"><strong>Sample 1</strong></td>
<td width="245"><strong>Sample 2</strong></td>
</tr>
<tr>
<td width="123">User-agent</td>
<td width="234">Mozilla/5.0 (Windows NT 6.4; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36 Edge/12.0</td>
<td width="245">Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:10.0) Gecko/20100101 Firefox/10.0</td>
</tr>
<tr>
<td width="123">Queried final payload directories</p>
<p>&nbsp;</td>
<td width="234">/0cd173cf1caa2aa03a52b80d7521cc75e</p>
<p>/1cd173cf1caa2aa03a52b80d7521cc75e</td>
<td width="245">/0fa0a5fc0d2e28cc3786e5d6eb273f1fa</p>
<p>/1fa0a5fc0d2e28cc3786e5d6eb273f1fa</td>
</tr>
<tr>
<td width="123">Unique string used in network communication</td>
<td width="234">148a028d-57c6-4094-b07d-720df09246dd</td>
<td width="245">3784113f-b04e-4c1e-b3be-6b0a22464921</td>
</tr>
</tbody>
</table>
<p style="text-align: center"><em>Table 3. String differences in SecondStageDropper.dll</em></p>
<p>&nbsp;</p>
<p>The shellcode payload and PE files partly contain the same code indicating a framework was used to create them. For example, both the shellcode and CHAINSHOT itself make extensive use of the same exception handling with custom error codes. They also both use the same code to scan for and bypass EMET. Furthermore, other parts such as the OS version recognition are identical in all samples and the PE files’ compilation timestamps are zeroed out. Another interesting fact is that FirstStageDropper.dll also sends status messages back to the attacker starting with digit “9”. For example, the following network capture from our local tests show a successful network communication up to the point where the attacker presumably sends back the command to execute SecondStageDropper.dll:</p>
<p><img class="aligncenter wp-image-90119" src="https://researchcenter.paloaltonetworks.com/wp-content/uploads/2018/09/figure7.png" alt="figure7" width="600" height="131" /></p>
<p style="text-align: center"><em>Figure 7. Network capture of a successful attack reproduced locally in a VM</em></p>
<p><span style="font-size: 18pt">Additional Infrastructure</span></p>
<p>One of the domains reported by IceBrg had an associated SSL certificate which was documented in their write up. By searching for other IP addresses using the same certificate we were able to find a large number of associated domains that were likely also used in similar attack campaigns. Just like the domain contacted within the Excel documents analyzed, the additional domain names are created in a similar way using similar hosting providers and registrars and used names which are very similar to official websites to avoid suspicion. The list of domains can be found in the IOC section.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">Conclusion</span></p>
<p>We uncovered part of a new toolkit which was used as a downloader alongside Adobe Flash exploit CVE-2018-5002 to target victims in the Middle East. This was possible because the attacker made a mistake in using insecure 512-bit RSA encryption. The malware sends user information encrypted to the attacker server and attempts to download a final stage implant. It was allegedly developed with the help of an unknown framework and makes extensive use of custom error handling. Because the attacker made another mistake in using the same SSL certificate for similar attacks, we were able to uncover additional infrastructure indicating a larger campaign.</p>
<p>Palo Alto Networks customers are protected from this threat in the following ways:</p>
<ul>
<li>WildFire detects all malicious Excel documents, the Flash downloader and exploit and all CHAINSHOT samples with malicious verdicts</li>
<li>AutoFocus customers can track the samples with the <a href="https://autofocus.paloaltonetworks.com/#/tag/Unit42.CVE-2018-5002">CVE-2018-5002</a> exploit and <a href="https://autofocus.paloaltonetworks.com/#/tag/Unit42.ChainShot">CHAINSHOT</a> malware tags</li>
<li>Traps detects and blocks the malicious Excel documents with the Flash exploit</li>
</ul>
<p>Finally, we’d like to thank Tom Lancaster for his assistance in this investigation.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">Indicators of Compromise</span></p>
<p><strong>Adobe Flash Downloader</strong></p>
<p>189f707cecff924bc2324e91653d68829ea55069bc4590f497e3a34fa15e155c</p>
<p>&nbsp;</p>
<p><strong>Adobe Flash Exploit (CVE-2018-5002)</strong></p>
<p>3e8cc2b30ece9adc96b0a9f626aefa4a88017b2f6b916146a3bbd0f99ce1e497</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt">CHAINSHOT Samples</span></p>
<p><strong>X86 Shellcode Payloads:</strong></p>
<p>d75de8f7a132e0eb922d4b57f1ce8db47dfcae4477817d9f737762e486283795</p>
<p>2d7cb5ff4a449fa284721f83e352098c2fdea125f756322c90a40ad3ebc5e40d</p>
<p>&nbsp;</p>
<p><strong>FirstStageDropper.dll:</strong></p>
<p>a260d222dfc94b91a09485647c21acfa4a26469528ec4b1b49469db3b283eb9a</p>
<p>a09273b4cc08c39afe0c964f14cef98e532ae530eb60b93aec669731c185ea23</p>
<p>&nbsp;</p>
<p><strong>SecondStageDropper.dll:</strong></p>
<p>43f7ae58e8e5471917178430f3425061d333b736974f4b2784ca543e3093204b</p>
<p>3485c9b79dfd3e00aef9347326b9ccfee588018a608f89ecd6597da552e3872f</p>
<p>&nbsp;</p>
<p><strong>Infrastructure</strong></p>
<p>ftp[.]oceasndata[.]com</p>
<p>dl[.]beanfile[.]com</p>
<p>eukaznews[.]com</p>
<p>exclusivesstregis[.]com</p>
<p>fishing-uae[.]com</p>
<p>api[.]usecisco[.]info</p>
<p>gulfnews[.]uae-travel-advisories[.]com</p>
<p>qatar[.]eng-theguardian[.]com</p>
<p>malomatiaa[.]com</p>
<p>news[.]theqatarpeninsula[.]com</p>
<p>people[.]dohabayt[.]com</p>
<p>qatar[.]doharotanatimes[.]com</p>
<p>sites[.]oceasndata[.]com</p>
<p>qatar[.]smallwarjournal[.]com</p>
<p>qatarembassies[.]com</p>
<p>sa[.]eukaznews[.]com</p>
<p>sec[.]oceasndata[.]com</p>
<p>rss[.]beanfile[.]com</p>
<p>usecisco[.]info</p>
<p>smallwarjournal[.]com</p>
<p>awareness-qcert[.]net</p>
<p>specials[.]fishing-uae[.]com</p>
<p>theqatarpeninsula[.]com</p>
<p>uae-travel-advisories[.]com</p>
<p>eng-theguardian[.]com</p>
<p>securityandpolicing[.]me</p>
<p>api[.]qcybersecurity[.]org</p>
<p>qatar-sse[.]com</p>
<p>api[.]motc-gov[.]info</p>
<p>youraccount-security-check[.]com</p>
<p>api[.]exclusivesstregis[.]com</p>
<p>newhorizonsdoha[.]com</p>
<p>sandp2018[.]securityandpolicing[.]me</p>
<p>icoinico[.]one</p>
<p>api[.]dohabayt[.]com</p>
<p>thelres[.]com</p>
<p>news[.]gulf-updates[.]com</p>
<p>qatarconferences[.]thelres[.]com</p>
<p>api[.]smallwarjournal[.]com</p>
<p>qcybersecurity[.]org</p>
<p>ikhwan-portal[.]com</p>
<p>gulf-updates[.]com</p>
<p>api[.]qatar-sse[.]com</p>
<p>info[.]awareness-qcert[.]net</p>
<p>api[.]newhorizonsdoha[.]com</p>
<p>internationsplanet[.]com</p>
<p>www[.]winword[.]co</p>
<p>www[.]oceasndata[.]com</p>
<p>people[.]dohabayt[.]com</p>
<p>eng-defenseadvisers[.]com</p>
<p>motc-gov[.]info</p>
<p>beanfile[.]com</p>
<p>news[.]eng-defenseadvisers[.]com</p>
<p>winword[.]co</p>
<p>documents[.]malomatiaa[.]com</p>
<p>bern[.]qatarembassies[.]com</p>
<p>surveydoha[.]com</p>
<p>documents[.]malomatiaa[.]com</p>
<p>dohabayt[.]com</p>
<p>doharotanatimes[.]com</p>
<p>activity[.]youraccount-security-check[.]com</p>
<p>poll[.]surveydoha[.]com</p>
<p>api[.]thelres[.]com</p>
<p>q-miles[.]com</p>
<p>rewards[.]q-miles[.]com</p>
<p>oceasndata[.]com</p>
<p>api[.]people[.]dohabayt[.]com</p>
<p>bangkok[.]exclusivesstregis[.]com</p>
<p>events[.]ikhwan-portal[.]com</p>
<p>contact[.]planturidea[.]net</p>
<p>dl[.]nmcyclingexperience[.]com</p>
<p>tools[.]conductorstech[.]com</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>

<script type="text/javascript" src="https://researchcenter.paloaltonetworks.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.9"></script>
        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2020 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
            <script type="text/javascript">
            (function(){
                document.addEventListener('DOMContentLoaded', function(){
                    let wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                    if ( wpp_widgets ) {
                        for (let i = 0; i < wpp_widgets.length; i++) {
                            let wpp_widget = wpp_widgets[i];
                            WordPressPopularPosts.theme(wpp_widget);
                        }
                    }
                });
            })();
        </script>
                <script>
            var WPPImageObserver = null;

            function wpp_load_img(img) {
                if ( ! 'imgSrc' in img.dataset || ! img.dataset.imgSrc )
                    return;

                img.src = img.dataset.imgSrc;

                if ( 'imgSrcset' in img.dataset ) {
                    img.srcset = img.dataset.imgSrcset;
                    img.removeAttribute('data-img-srcset');
                }

                img.classList.remove('wpp-lazyload');
                img.removeAttribute('data-img-src');
                img.classList.add('wpp-lazyloaded');
            }

            function wpp_observe_imgs(){
                let wpp_images = document.querySelectorAll('img.wpp-lazyload'),
                    wpp_widgets = document.querySelectorAll('.popular-posts-sr');

                if ( wpp_images.length || wpp_widgets.length ) {
                    if ( 'IntersectionObserver' in window ) {
                        WPPImageObserver = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    let img = entry.target;
                                    wpp_load_img(img);
                                    WPPImageObserver.unobserve(img);
                                }
                            });
                        });

                        if ( wpp_images.length ) {
                            wpp_images.forEach(function(image) {
                                WPPImageObserver.observe(image);
                            });
                        }

                        if ( wpp_widgets.length ) {
                            for (var i = 0; i < wpp_widgets.length; i++) {
                                let wpp_widget_images = wpp_widgets[i].querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widgets[i].shadowRoot ) {
                                    wpp_widget_images = wpp_widgets[i].shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    wpp_widget_images.forEach(function(image) {
                                        WPPImageObserver.observe(image);
                                    });
                                }
                            }
                        }
                    } /** Fallback for older browsers */
                    else {
                        if ( wpp_images.length ) {
                            for (var i = 0; i < wpp_images.length; i++) {
                                wpp_load_img(wpp_images[i]);
                                wpp_images[i].classList.remove('wpp-lazyloaded');
                            }
                        }

                        if ( wpp_widgets.length ) {
                            for (var j = 0; j < wpp_widgets.length; j++) {
                                let wpp_widget = wpp_widgets[j],
                                    wpp_widget_images = wpp_widget.querySelectorAll('img.wpp-lazyload');

                                if ( ! wpp_widget_images.length && wpp_widget.shadowRoot ) {
                                    wpp_widget_images = wpp_widget.shadowRoot.querySelectorAll('img.wpp-lazyload');
                                }

                                if ( wpp_widget_images.length ) {
                                    for (var k = 0; k < wpp_widget_images.length; k++) {
                                        wpp_load_img(wpp_widget_images[k]);
                                        wpp_widget_images[k].classList.remove('wpp-lazyloaded');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                wpp_observe_imgs();

                // When an ajaxified WPP widget loads,
                // Lazy load its images
                document.addEventListener('wpp-onload', function(){
                    wpp_observe_imgs();
                });
            });
        </script>
        <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
