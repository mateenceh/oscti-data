<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'ESET Research',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Casbaneiro: Dangerous cooking with a secret ingredient | WeLiveSecurity</title>
<meta name="description" content="ESET researchers publish an in-depth analysis of the Casbaneiro banking trojan that mainly targets Brazilian and Mexican banking applications."/>
<link rel="canonical" href="https://www.welivesecurity.com/2019/10/03/casbaneiro-trojan-dangerous-cooking/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="pt_BR" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Casbaneiro: Dangerous cooking with a secret ingredient | WeLiveSecurity" />
<meta property="og:description" content="ESET researchers publish an in-depth analysis of the Casbaneiro banking trojan that mainly targets Brazilian and Mexican banking applications." />
<meta property="og:url" content="https://www.welivesecurity.com/2019/10/03/casbaneiro-trojan-dangerous-cooking/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2019-10-03T09:30:54+00:00" />
<meta property="article:modified_time" content="2019-10-24T11:14:31+00:00" />
<meta property="og:updated_time" content="2019-10-24T11:14:31+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2019/10/casbaneiro-M.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2019/10/casbaneiro-M.jpg" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="768" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET researchers publish an in-depth analysis of the Casbaneiro banking trojan that mainly targets Brazilian and Mexican banking applications." />
<meta name="twitter:title" content="Casbaneiro: Dangerous cooking with a secret ingredient | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2019/10/casbaneiro-M.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel="alternate" href="https://www.welivesecurity.com/br/2019/10/03/casbaneiro-particularidades-deste-trojan-bancario-que-afeta-o-brasil-e-o-mexico/" hreflang="pt" />
<link rel="alternate" href="https://www.welivesecurity.com/2019/10/03/casbaneiro-trojan-dangerous-cooking/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2019/10/03/casbaneiro-troyano-bancario-afecta-brasil-mexico/" hreflang="es" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/2019/10/03/casbaneiro-particularidades-deste-trojan-bancario-que-afeta-o-brasil-e-o-mexico/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2019/10/03/casbaneiro-troyano-bancario-afecta-brasil-mexico/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/2019/10/03/casbaneiro-particularidades-deste-trojan-bancario-que-afeta-o-brasil-e-o-mexico/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2019/10/03/casbaneiro-troyano-bancario-afecta-brasil-mexico/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2019/10/casbaneiro-2.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>Casbaneiro: Dangerous cooking with a secret ingredient</h1>
<div class="excerpt">Número dois in our series demystifying Latin American banking trojans</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2020/04/android-fullpage-1024x576-Copy-222x179.jpg" alt="ESET Research">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                    ESET Research                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2019-10-03 11:30:54">3 Oct 2019 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F&text=Casbaneiro: Dangerous cooking with a secret ingredient%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>Número dois in our series demystifying Latin American banking trojans</p>
                            </div>

                            <p>Most reverse engineers would agree that quite often one can learn something new on the job. However, it is not every day you learn how to cook a delicious meal while analyzing malware. This unique experience is provided by a malware family we discuss in this blog post – Casbaneiro.</p>
<h2><big>Characteristics</big></h2>
<p>Casbaneiro, also known as Metamorfo, is a typical Latin American banking trojan that targets banks and cryptocurrency services in Brazil and Mexico (Figure 1). It uses the social engineering method described in the introduction to our <a href="https://www.welivesecurity.com/2019/08/01/banking-trojans-amavaldo/" target="_blank" rel="noopener">previous article</a><u>,</u> where fake pop-up windows are displayed. These pop-ups try to persuade potential victims to enter sensitive information; if successful, that information is then stolen.</p>
<div id="attachment_130359" style="width: 760px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap.png"><img class="wp-image-130359" src="/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap-1024x550.png" alt="" width="750" height="403" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap-1024x550.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap-300x161.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap-768x413.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure01_CasbaneiroHeatMap.png 1206w" sizes="(max-width: 750px) 100vw, 750px" /></a><p class="wp-caption-text"><i>Figure 1. Countries affected by Casbaneiro</i></p></div>
<p>The backdoor capabilities of this malware are typical of Latin American banking trojans. It can take screenshots and send them to its C&amp;C server, simulate mouse and keyboard actions and capture keystrokes, download and install updates to itself, restrict access to various websites, and download and execute other executables.</p>
<p>Casbaneiro collects the following information about its victims:</p>
<ul>
<li>List of installed antivirus products</li>
<li>OS version</li>
<li>Username</li>
<li>Computer name</li>
<li>Whether any of the following software is installed:
<ul>
<li>Diebold Warsaw GAS Tecnologia (an application to protect access to online banking)</li>
<li>Trusteer</li>
<li>Several Latin American banking applications</li>
</ul>
</li>
</ul>
<p>Although there seem to be at least four different variants of this malware, the core of all of them is almost identical to the code in <a href="https://github.com/Maickonn/Delphi_Remote_Access_PC" target="_blank" rel="noopener">this GitHub repository</a>. However, it is practically impossible to separate them from each other, mainly because some variants using different versioning use the same string decryption key, and the same mechanisms are used in different variants.</p>
<p>Moreover, the differences are not important from the functionality point of view. Therefore, we will refer to all these variants as Casbaneiro.</p>
<p>Casbaneiro is easy to identify by its use of a huge string table, with several hundred entries. Strings are retrieved by accessing this table by index. Curiously, whenever the malware needs to obtain a string, the whole string table is constructed in memory from stored chunks of encrypted text, the desired string is decrypted and the whole table is discarded again. You can see an example in Figure 2.</p>
<div id="attachment_130360" style="width: 760px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure02_StringTable.png"><img class="wp-image-130360" src="/wp-content/uploads/2019/09/Figure02_StringTable.png" alt="" width="750" height="619" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure02_StringTable.png 910w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure02_StringTable-300x248.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure02_StringTable-768x634.png 768w" sizes="(max-width: 750px) 100vw, 750px" /></a><p class="wp-caption-text"><i>Figure 2. Casbaneiro obtaining a string by index (0x205) and decrypting it</i></p></div>
<p>There are strong indicators that this malware family is closely connected to Amavaldo, which we described in our <a href="https://www.welivesecurity.com/2019/08/01/banking-trojans-amavaldo/">first post in this series</a> about Latin American banking trojans. We will mention these similarities later in this article.</p>
<h2><big>Hijacking clipboard data</big></h2>
<p>Casbaneiro can also try to steal victim’s cryptocurrency. It does so by monitoring the content of the clipboard and if the data seem to be a cryptocurrency wallet, it replaces them with the attacker’s own. This technique is not new; it has been used by <a href="https://www.welivesecurity.com/2018/03/14/stealing-bitcoin-download-com/" target="_blank" rel="noopener">other</a> <a href="https://www.welivesecurity.com/2019/04/30/buhtrap-backdoor-ransomware-advertising-platform/" target="_blank" rel="noopener">malware</a> in the past – even the infamous <a href="https://www.welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/" target="_blank" rel="noopener">BackSwap</a> banking trojan implemented it in its earliest stages.</p>
<p>The attacker’s wallet is hardcoded in the binary and we have encountered only one. By examining it, we can see payments were already made at the time of writing.</p>
<div id="attachment_130361" style="width: 471px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure03_BitcoinWallet.png"><img class="wp-image-130361 size-full" src="/wp-content/uploads/2019/09/Figure03_BitcoinWallet.png" alt="" width="461" height="318" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure03_BitcoinWallet.png 461w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure03_BitcoinWallet-300x207.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure03_BitcoinWallet-151x103.png 151w" sizes="(max-width: 461px) 100vw, 461px" /></a><p class="wp-caption-text"><i>Figure 3. Detail of the attacker&#8217;s bitcoin wallet</i></p></div>
<h2><big>Cryptography</big></h2>
<p>Casbaneiro utilizes several cryptographic algorithms, each one to protect a different type of data. We describe them in the following sections.</p>
<h3>Command encryption</h3>
<p>Commands received from the C&amp;C server are encrypted using AES-256. The <a href="https://github.com/synopse/SynPDF/blob/master/SynCrypto.pas" target="_blank" rel="noopener">SynCrypto</a> Delphi library is used. The AES key is derived via SHA-256 from a password stored in the binary. It is not stored as a string but concatenated from separate pieces at runtime, as you can see in Figure 4.</p>
<div id="attachment_130362" style="width: 332px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure04_AesKey.png"><img class="wp-image-130362 size-full" src="/wp-content/uploads/2019/09/Figure04_AesKey.png" alt="" width="322" height="355" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure04_AesKey.png 322w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure04_AesKey-272x300.png 272w" sizes="(max-width: 322px) 100vw, 322px" /></a><p class="wp-caption-text"><i>Figure 4. Constructing the password &#8220;ze102030ca” used to derive the AES key</i></p></div>
<h3>String encryption</h3>
<p>The algorithm used to encrypt strings, comes from this <a href="https://books.google.com/books?id=0PdDnywBKl0C&amp;printsec=frontcover" target="_blank" rel="noopener">book</a> and is used in other Latin American banking trojans as well. Pseudocode of the decryption algorithm can be seen in Figure 5. The same key is used for all strings. Similar to the command encryption, the key is again concatenated from parts at runtime, only this time it consists of many more parts (see Figure 6). Notice how whitespace strings are added as well, but trimmed later on, therefore having no impact.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60577a99979f8047563234" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; clear: none; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
def decrypt_string(data_enc, key):
	data_dec = str()

	data_enc = unhexlify(data_enc)
	prev = data_enc[0]

	for i, c in enumerate(data_enc[1:]):
		x = c ^ key[i % len(key)]

		if x &lt; prev:
			x = x + 255 - prev
		else:
			x -= prev

		prev = c
		data_dec += chr(x)

	return data_dec</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60577a99979f8047563234-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-2">2</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-4">4</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-6">6</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-8">8</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-10">10</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-12">12</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-14">14</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-16">16</div><div class="crayon-num" data-line="crayon-60577a99979f8047563234-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a99979f8047563234-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60577a99979f8047563234-1"><span class="crayon-e">def </span><span class="crayon-e">decrypt_string</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-2"><span class="crayon-h">	</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-4"><span class="crayon-h">	</span><span class="crayon-v">data_enc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">unhexlify</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-5"><span class="crayon-h">	</span><span class="crayon-v">prev</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data_enc</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-6">&nbsp;</div><div class="crayon-line" id="crayon-60577a99979f8047563234-7"><span class="crayon-h">	</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">enumerate</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-8"><span class="crayon-h">		</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">^</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-10"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">prev</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-11"><span class="crayon-h">			</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">255</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">prev</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-12"><span class="crayon-e">		</span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-13"><span class="crayon-h">			</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">-=</span><span class="crayon-h"> </span><span class="crayon-e">prev</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-14">&nbsp;</div><div class="crayon-line" id="crayon-60577a99979f8047563234-15"><span class="crayon-e">		</span><span class="crayon-v">prev</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">c</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-16"><span class="crayon-h">		</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">chr</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a99979f8047563234-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a99979f8047563234-18"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">data_dec</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p><em>Figure 5. String decryption pseudocode</em></p>
<div id="attachment_130363" style="width: 299px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure05_02_StringDecryption.png"><img class="wp-image-130363 size-full" src="/wp-content/uploads/2019/09/Figure05_02_StringDecryption.png" alt="" width="289" height="293" /></a><p class="wp-caption-text"><i>Figure 6. Part of code that concatenates the string decryption key shown in Figure 5. The valid key parts are marked red. The obfuscation by whitespace strings is marked purple.</i></p></div>
<h3>Payload encryption</h3>
<p>In some Casbaneiro campaigns, the actual banking trojan is encrypted and associated with an injector. The algorithm used to decrypt the main payload binary in such cases is exactly the same as the Amavaldo injector uses. Pseudocode is found in Figure 7.</p>
<h3>Remote configuration data encryption</h3>
<p>Finally, a fourth algorithm is used to decrypt configuration data not stored in the binary file but obtained remotely. We provide examples of such situations below.</p>
<p>You can clearly see in Figures 7 and 8 that this and the payload decryption algorithms are almost identical, only one uses plaintext and the other one ciphertext to update the key. We strongly suspect that the author rewrote the code by hand from the same source and made a mistake in one of the cases.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60577a9997a07325445749" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
def decrypt_payload(data_enc, key1, key2, key3):
	data_dec = str()

	for c in data_enc:
		x = data_enc[i] ^ (k3 &gt;&gt; 8) &amp; 0xFF
		data_dec += chr(x)
		key3 = ((x + key3) &amp; 0xFF) * key1 + key2

	return data_dec</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60577a9997a07325445749-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a07325445749-2">2</div><div class="crayon-num" data-line="crayon-60577a9997a07325445749-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a07325445749-4">4</div><div class="crayon-num" data-line="crayon-60577a9997a07325445749-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a07325445749-6">6</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-60577a9997a07325445749-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a07325445749-8">8</div><div class="crayon-num" data-line="crayon-60577a9997a07325445749-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60577a9997a07325445749-1"><span class="crayon-e">def </span><span class="crayon-e">decrypt_payload</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key3</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a07325445749-2"><span class="crayon-h">	</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a07325445749-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a07325445749-4"><span class="crayon-h">	</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">data_enc</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a07325445749-5"><span class="crayon-h">		</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data_enc</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">^</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">k3</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a07325445749-6"><span class="crayon-h">		</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">chr</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-60577a9997a07325445749-7"><span class="crayon-h">		</span><span class="crayon-v">key3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">key3</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">key1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">key2</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a07325445749-8">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a07325445749-9"><span class="crayon-e">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">data_dec</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p><em>Figure 7. Payload decryption algorithm</em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60577a9997a0b481305461" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
def decrypt_remote_data(data_enc, key1, key2, key3):
	data_dec = str()

	for c in data_enc:
		x = data_enc[i] ^ (k3 &gt;&gt; 8) &amp; 0xFF
		data_dec += chr(x)
		key3 = ((data_enc[i] + key3) &amp; 0xFFFF) * key1 + key2

	return data_dec</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60577a9997a0b481305461-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0b481305461-2">2</div><div class="crayon-num" data-line="crayon-60577a9997a0b481305461-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0b481305461-4">4</div><div class="crayon-num" data-line="crayon-60577a9997a0b481305461-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0b481305461-6">6</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-60577a9997a0b481305461-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0b481305461-8">8</div><div class="crayon-num" data-line="crayon-60577a9997a0b481305461-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60577a9997a0b481305461-1"><span class="crayon-e">def </span><span class="crayon-e">decrypt_remote_data</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">key3</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0b481305461-2"><span class="crayon-h">	</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a0b481305461-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0b481305461-4"><span class="crayon-h">	</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">data_enc</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a0b481305461-5"><span class="crayon-h">		</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data_enc</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">^</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">k3</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0b481305461-6"><span class="crayon-h">		</span><span class="crayon-v">data_dec</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">chr</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-60577a9997a0b481305461-7"><span class="crayon-h">		</span><span class="crayon-v">key3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">data_enc</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">key3</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFF</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">key1</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">key2</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0b481305461-8">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a0b481305461-9"><span class="crayon-e">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">data_dec</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p><em>Figure 8. Remote data decryption algorithm</em></p>
<h2><big>Distribution</big></h2>
<p>We believe that a malicious email is usually at the beginning of Casbaneiro distribution chains. Some campaigns were described by <a href="https://www.fireeye.com/blog/threat-research/2018/04/metamorfo-campaign-targeting-brazilian-users.html" target="_blank" rel="noopener">FireEye</a>, <a href="https://blog.talosintelligence.com/2018/11/metamorfo-brazilian-campaigns.html" target="_blank" rel="noopener">Cisco</a> and <a href="https://blog.ensilo.com/metamorfo-avast-abuser" target="_blank" rel="noopener">enSilo</a>. If you have read our <a href="https://www.welivesecurity.com/2019/08/01/banking-trojans-amavaldo/" target="_blank" rel="noopener">previous article</a>, you may notice that the campaign described by Cisco uses a PowerShell script very similar to the one utilized by Amavaldo. Even though some parts differ, both scripts clearly come from a common source and use the same obfuscation methods.</p>
<p>While writing this article, we noticed a new campaign using a similar technique to the one described by enSilo, with only a few changes. The Avast executable is no longer abused and the main payload, <span style="font-family: courier new, courier, monospace;">jesus.dmp</span>, is no longer encrypted and therefore not associated with an injector. Finally, the installation folder has been changed to <span style="font-family: courier new, courier, monospace;">%APPDATA%\Sun\Javar\%RANDOM%\</span>. Since this most recent Casbaneiro campaign uses the bit.ly URL shortener, we can learn more about it from Figure 9.</p>
<div id="attachment_130365" style="width: 760px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign.png"><img class="wp-image-130365" src="/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign-1024x652.png" alt="" width="750" height="477" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign-1024x652.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign-300x191.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign-768x489.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign-65x42.png 65w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure07_BitlyCurrentCampaign.png 1188w" sizes="(max-width: 750px) 100vw, 750px" /></a><p class="wp-caption-text"><i>Figure 9. bit.ly statistics for the latest Casbaneiro campaign</i></p></div>
<p>Besides that, we identified two other, earlier campaigns during our research.</p>
<h3>Campaign 1: Fishy financial manager update</h3>
<p>In this campaign, the victim is persuaded to download and install what may seem to be a legitimate update of financial software (see Figure 10). Instead of that, the installer:</p>
<ul>
<li>downloads an archive containing:
<ul>
<li>Casbaneiro masquerading as <span style="font-family: courier new, courier, monospace;">Spotify.exe</span></li>
<li>other legitimate DLLs</li>
</ul>
</li>
<li>extracts the content of the archive to <span style="font-family: courier new, courier, monospace;">%APPDATA%\Spotify\</span></li>
<li>sets up persistence using <span style="font-family: courier new, courier, monospace;">HKCU\Software\Microsoft\Windows\CurrentVersion\Run, Spotify = %APPDATA%\Spotify\Spotify.exe</span></li>
</ul>
<p>We have also encountered cases where the payload masquerades as OneDrive or WhatsApp. In those cases, the name of the folder is changed accordingly.</p>
<div id="attachment_130366" style="width: 438px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure08_MsiMessageBox.png"><img class="wp-image-130366 size-full" src="/wp-content/uploads/2019/09/Figure08_MsiMessageBox.png" alt="" width="428" height="188" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure08_MsiMessageBox.png 428w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure08_MsiMessageBox-300x132.png 300w" sizes="(max-width: 428px) 100vw, 428px" /></a><p class="wp-caption-text"><i>Figure 10. Fake update installer. (Translation: Title: Wait.. Updating Financial Manager [BB]. Text: Please wait for Windows configuration to be done.. Updating Financial Manager [BB]. Gathering necessary information.)</i></p></div>
<h3>Campaign 2: What’s cooking? A fowl Windows activator</h3>
<p>This campaign is very similar to the one described by enSilo; it uses an MSI installer with an embedded JavaScript downloader. Only this time, the installer comes bundled together with the Re‑Loader cracking tool allowing unofficial activation of Windows or Microsoft Office. When executed, Casbaneiro is secretly downloaded and executed first, followed by Re‑Loader.</p>
<p>The attacker used this approach when the expected software is actually installed together with the malware. This method is not very common for Latin American banking trojans. It is more dangerous to the intended victims, because it may give them less reason to suspect anything has gone wrong.</p>
<div id="attachment_130367" style="width: 319px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure09_ReLoader.png"><img class="wp-image-130367 size-full" src="/wp-content/uploads/2019/09/Figure09_ReLoader.png" alt="" width="309" height="315" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure09_ReLoader.png 309w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure09_ReLoader-294x300.png 294w" sizes="(max-width: 309px) 100vw, 309px" /></a><p class="wp-caption-text"><i>Figure 11. The Re-Loader cracking tool installed together with Casbaneiro</i></p></div>
<h2><big>Do you C what I C?</big></h2>
<p>The operators have gone to great lengths to hide the actual C&amp;C server domain and port, and it is one of the most interesting Casbaneiro features. Let’s explore where the C&amp;C servers have been hidden…</p>
<h3>1) Stored encrypted in the binary</h3>
<p>Encryption is definitely the simplest method to hide the C&amp;C server. The domain is encrypted with a hardcoded key and the port is just hardcoded. We have encountered cases where the port has been stored in the data section, in the Delphi form data, or randomly chosen from a range.</p>
<h3>2) Embedded in a document</h3>
<p>A more advanced method is to store the data somewhere online, in this case on Google Docs. One way Casbaneiro uses this method can be seen in Figure 12, where the document is full of junk text. The encrypted domain is hexadecimal encoded and then stored between “!” delimiters. The encryption used is that used for all other strings, and the port is hardcoded in the binary.</p>
<div id="attachment_130368" style="width: 621px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure10_CncInDocument.png"><img class="wp-image-130368 size-full" src="/wp-content/uploads/2019/09/Figure10_CncInDocument.png" alt="" width="611" height="329" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure10_CncInDocument.png 611w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure10_CncInDocument-300x162.png 300w" sizes="(max-width: 611px) 100vw, 611px" /></a><p class="wp-caption-text"><i>Figure 12. C&amp;C server domain (highlighted red) encrypted and hexadecimal encoded, hidden inside an online document</i></p></div>
<p>Another way this method is used involves multiple delimiters. An example can be seen in Figure 13, where different delimiters are used for the C&amp;C port, C&amp;C domain and the URL used to submit victim information. Initially, this method was used to store only the port; the other configuration data were added in later variants.</p>
<div id="attachment_130369" style="width: 622px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure11_RemoteConfigInDocument.png"><img class="wp-image-130369" src="/wp-content/uploads/2019/09/Figure11_RemoteConfigInDocument.png" alt="" width="612" height="100" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure11_RemoteConfigInDocument.png 618w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure11_RemoteConfigInDocument-300x49.png 300w" sizes="(max-width: 612px) 100vw, 612px" /></a><p class="wp-caption-text"><i>Figure 13. C&amp;C server port (“thedoor”), domain (“sundski”) and the victim information submission URL (“contict”) encrypted and stored in an online document</i></p></div>
<h3>3) Embedded in a crafted website</h3>
<p>In this approach, the operators set up a fake website (Figure 14) mimicking this <a href="https://www.horariodebrasilia.org/" target="_blank" rel="noopener">legitimate one</a> showing the current time in Brazil. The real C&amp;C domain is hidden inside the web page’s metadata, as can be seen in Figure 15, and the port is hardcoded in the binary. We have encountered at least three such identical websites with different URLs.</p>
<div id="attachment_130370" style="width: 760px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure12_CraftedWebsite.png"><img class="wp-image-130370" src="/wp-content/uploads/2019/09/Figure12_CraftedWebsite.png" alt="" width="750" height="484" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure12_CraftedWebsite.png 984w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure12_CraftedWebsite-300x194.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure12_CraftedWebsite-768x496.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure12_CraftedWebsite-65x42.png 65w" sizes="(max-width: 750px) 100vw, 750px" /></a><p class="wp-caption-text"><i>Figure 14. Website created by the attacker mimicking a legitimate one. (Partial translation: Brazilian time schedule. Set your watch with time schedule in Brazil, Brazil’s official time.)</i></p></div>
<div id="attachment_130371" style="width: 758px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata.png"><img class="wp-image-130371" src="/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata-1024x163.png" alt="" width="748" height="119" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata-1024x163.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata-300x48.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata-768x122.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure13_CraftedWebsiteMetadata.png 1295w" sizes="(max-width: 748px) 100vw, 748px" /></a><p class="wp-caption-text"><i>Figure 15. Comparison of metadata of the legitimate (left) and fake (right) websites. The google-site-verification tag holds the encrypted C&amp;C domain.</i></p></div>
<p>An important difference from the previous method is that the data are encrypted in a different way than all other strings, using the algorithm to decrypt remote configuration data described earlier. The three keys required are the first 12 bytes of the string, each taking 4 bytes.</p>
<h3>4) Embedded in a legitimate website</h3>
<p>If you have been wondering where the title of this blog post comes from, this section is for you!</p>
<p>Casbaneiro started to abuse YouTube to store its C&amp;C server domains. We have identified two different accounts used for this by the threat actor – one focused on cooking recipes and the other one on soccer.</p>
<p>So where is the C&amp;C server hidden? Each video on these channels contains a description. At the end of this description, there is a link to a bogus Facebook or Instagram URL (see Figure 17). The C&amp;C server domain is stored in this link, using the same encryption scheme as in the previous case – the key is stored at the beginning of the encrypted data. The port is, once again, hardcoded in the binary.</p>
<div id="attachment_130372" style="width: 747px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure14_YouTubeChannel.png"><img class="wp-image-130372" src="/wp-content/uploads/2019/09/Figure14_YouTubeChannel.png" alt="" width="737" height="330" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure14_YouTubeChannel.png 847w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure14_YouTubeChannel-300x134.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure14_YouTubeChannel-768x344.png 768w" sizes="(max-width: 737px) 100vw, 737px" /></a><p class="wp-caption-text"><i>Figure 16. One of the YouTube channels used by the attacker</i></p></div>
<div id="attachment_130373" style="width: 747px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure15_YouTubeVideoDescription.png"><img class="wp-image-130373 size-large" src="/wp-content/uploads/2019/09/Figure15_YouTubeVideoDescription-737x1024.png" alt="" width="737" height="1024" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure15_YouTubeVideoDescription-737x1024.png 737w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure15_YouTubeVideoDescription-216x300.png 216w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure15_YouTubeVideoDescription.png 744w" sizes="(max-width: 737px) 100vw, 737px" /></a><p class="wp-caption-text"><i>Figure 17. Description of one of the videos the attacker posted. At the bottom, the encrypted C&amp;C domain is embedded in a bogus Facebook link (red).</i></p></div>
<p>What makes this technique dangerous is that it does not raise much suspicion without context. Connecting to YouTube is not considered unusual and even if the video is examined, the link at the end of the video description may easily go unnoticed.</p>
<h3>5) Generated using a fake DNS entry</h3>
<p>The general idea of this method is to register a domain and associate it with a fake IP address so that the real IP address can be derived from it. The algorithm uses three input values:</p>
<ol>
<li>A <em>base domain (B) </em>&#8211; a domain used to derive other domains</li>
<li>A <em>list of suffixes (LS) </em>&#8211; a list of strings that will be used to derive other domains from the <em>base domain</em> <em>B</em></li>
<li>A <em>number (N) </em>&#8211; a number used to transform a fake IP address to the real one</li>
</ol>
<p>A different <em>base domain</em> is used for C&amp;C domain and port. We provide pseudocode in Figure 18. The basic logic of the algorithm is:</p>
<ol>
<li>Generate a domain from the <em>base domain B</em> and resolve it to a <em>fake IP address (FIP)</em></li>
<li>Add a <em>number N</em> to the <em>fake IP address FIP</em> to get the real IP address</li>
<li>To get the port, sum the octets of the real IP address and multiply by 7</li>
</ol>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60577a9997a0e037819397" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
def get_real_ip(base_domain, suffix, n):
	items = base_domain.split(".", 1)
	items[0] += suffix
	generated_domain = '.'.join(items)

	if is_registered(generated_domain):
		fake_ip = resolve(generated_domain)
		return fake_ip + n
	else:
		return 0

def get_real_domain(base_domain, strings_list, n):
	# First, try to resolve the base domain without suffix
	real_ip = get_real_ip(base_domain, "", n)
	if not real_ip:

		# If that fails, try the suffixes one by one
		for suffix in string_list:
			real_ip = get_real_ip(base_domain, suffix, n)
			if real_ip:
				break

	return real_ip

def get_real_port(base_domain, strings_list, n):
	# Do all the steps as when getting the domain
	ip = get_real_domain(base_domain, strings_list, n)	

	# Get the octets of the ip, sum them and multiply by 7
	octets = str(ip).split('.')
	return sum(octets) * 7</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-2">2</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-4">4</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-6">6</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-8">8</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-10">10</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-12">12</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-14">14</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-16">16</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-18">18</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-20">20</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-22">22</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-24">24</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-26">26</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-28">28</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-60577a9997a0e037819397-30">30</div><div class="crayon-num" data-line="crayon-60577a9997a0e037819397-31">31</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60577a9997a0e037819397-1"><span class="crayon-e">def </span><span class="crayon-e">get_real_ip</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">suffix</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-2"><span class="crayon-h">	</span><span class="crayon-v">items</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">base_domain</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">"."</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-3"><span class="crayon-h">	</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-e">suffix</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-4"><span class="crayon-e">	</span><span class="crayon-v">generated_domain</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'.'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">items</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-6"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">is_registered</span><span class="crayon-sy">(</span><span class="crayon-v">generated_domain</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-7"><span class="crayon-h">		</span><span class="crayon-v">fake_ip</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">resolve</span><span class="crayon-sy">(</span><span class="crayon-v">generated_domain</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-8"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">fake_ip</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-i">n</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-9"><span class="crayon-h">	</span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-10"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-12"><span class="crayon-e">def </span><span class="crayon-e">get_real_domain</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">strings_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-13"><span class="crayon-h">	</span><span class="crayon-p"># First, try to resolve the base domain without suffix</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-14"><span class="crayon-h">	</span><span class="crayon-v">real_ip</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_real_ip</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-15"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">real_ip</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-16">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a0e037819397-17"><span class="crayon-h">		</span><span class="crayon-p"># If that fails, try the suffixes one by one</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-18"><span class="crayon-h">		</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">suffix </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">string_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-19"><span class="crayon-h">			</span><span class="crayon-v">real_ip</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_real_ip</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">suffix</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-20"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">real_ip</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-21"><span class="crayon-h">				</span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-22">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a0e037819397-23"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">real_ip</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-24">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a0e037819397-25"><span class="crayon-e">def </span><span class="crayon-e">get_real_port</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">strings_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-26"><span class="crayon-h">	</span><span class="crayon-p"># Do all the steps as when getting the domain</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-27"><span class="crayon-h">	</span><span class="crayon-v">ip</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_real_domain</span><span class="crayon-sy">(</span><span class="crayon-v">base_domain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">strings_list</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n</span><span class="crayon-sy">)</span><span class="crayon-h">	</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-28">&nbsp;</div><div class="crayon-line" id="crayon-60577a9997a0e037819397-29"><span class="crayon-h">	</span><span class="crayon-p"># Get the octets of the ip, sum them and multiply by 7</span></div><div class="crayon-line crayon-striped-line" id="crayon-60577a9997a0e037819397-30"><span class="crayon-h">	</span><span class="crayon-v">octets</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">str</span><span class="crayon-sy">(</span><span class="crayon-v">ip</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60577a9997a0e037819397-31"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-v">octets</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">7</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p><em>Figure 18. Pseudocode of the algorithm used to generate C&amp;C domain and port using a fake DNS entry</em></p>
<h2><big>Download &amp; Execute functionality</big></h2>
<p>Most of the Latin American banking trojans, including Casbaneiro, have a way to download and execute other executables, usually via a backdoor command. However, Casbaneiro employs a different implementation of this functionality. We initially thought of it as an update mechanism because newer versions of the banking trojan were distributed by it but, as we found out later, not exclusively. Two different mechanisms are used; let’s explore them.</p>
<h3>Via XML document</h3>
<p>One way that this functionality is used is by downloading an XML document. Data stored in this document between the <span style="font-family: courier new, courier, monospace;">&lt;xmlUpdate&gt;##</span> and <span style="font-family: courier new, courier, monospace;">##&lt;/xmlUpdate&gt;</span> labels are encrypted using the algorithm for remote data provided in Figure 8.</p>
<p>Once decrypted, the data may contain the following tags:</p>
<ul>
<li><span style="font-family: courier new, courier, monospace;">&lt;newdns&gt;</span> – new C&amp;C server domain</li>
<li><span style="font-family: courier new, courier, monospace;">&lt;newport&gt;</span> – new C&amp;C server port</li>
<li><span style="font-family: courier new, courier, monospace;">&lt;downexec&gt;</span> – a URL to use to download and execute a file</li>
</ul>
<h3>Via special configuration file</h3>
<p>We believe this approach is used in (probably a subset of) Casbaneiro samples that are being sold to other cybercriminals. In this method, a configuration file is downloaded (as shown in Figure 19). It consists of multiple lines, each one containing:</p>
<ul>
<li>An ID of the buyer</li>
<li>Payload archive filename</li>
<li>Main URL where the archive is located</li>
<li>Backup URL where the archive is located</li>
<li>Version (not used)</li>
<li>A number (not used)</li>
<li>Date (not used)</li>
</ul>
<p>The latter three values seem to be ignored completely. The date “07/05/2018”, for example, is used even in the newest configuration files at the time of writing.</p>
<div id="attachment_130375" style="width: 761px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure17_DownExecConfigFile.png"><img class="wp-image-130375" src="/wp-content/uploads/2019/09/Figure17_DownExecConfigFile-1024x419.png" alt="" width="751" height="307" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure17_DownExecConfigFile-1024x419.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure17_DownExecConfigFile-300x123.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure17_DownExecConfigFile-768x314.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure17_DownExecConfigFile.png 1333w" sizes="(max-width: 751px) 100vw, 751px" /></a><p class="wp-caption-text"><i>Figure 19. Configuration file obtained by Casbaneiro</i></p></div>
<p>Each Casbaneiro sample using this method has the buyer’s ID hardcoded in its data. When it downloads such configuration file, it parses it and finds the line that is intended for the specific buyer’s ID and downloads and executes the payload.</p>
<p>As you can see in Figure 19, the payload is mostly the same for all the buyers. However, we have encountered a situation where a sample downloaded such a configuration file and its buyer’s ID was not present. This way of distributing additional payloads gives the “main author” (probably the seller) the ability to exclude some buyers.</p>
<p>Besides Casbaneiro updates, we have seen two more payloads being distributed by this method, which are covered in the next two sections.</p>
<h3>Email tool</h3>
<p>A tool written in C# automatically registers a large number of new email accounts using the Brasil Online (BOL) email platform and sends the credentials back to the attacker. If you have read our <a href="https://www.welivesecurity.com/2019/08/01/banking-trojans-amavaldo/" target="_blank" rel="noopener">previous article</a>, this may seem very familiar to you. That is because, as far as functionality goes, this tool does exactly the same thing. It is also a variant of the spam tool described by <a href="https://blog.talosintelligence.com/2018/11/metamorfo-brazilian-campaigns.html" target="_blank" rel="noopener">Cisco</a>.</p>
<h3>Password stealer</h3>
<p>Another payload we have seen being distributed by this functionality is a very simple Outlook password stealer. This malware, once executed, first displays a message box stating, in Portuguese, there is an issue with the victim’s Outlook account. After that, it displays a fake Microsoft login page requesting Outlook credentials.</p>
<div id="attachment_130376" style="width: 365px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure18_PwdStealerMsgBox.png"><img class="wp-image-130376 size-full" src="/wp-content/uploads/2019/09/Figure18_PwdStealerMsgBox.png" alt="" width="355" height="154" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure18_PwdStealerMsgBox.png 355w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure18_PwdStealerMsgBox-300x130.png 300w" sizes="(max-width: 355px) 100vw, 355px" /></a><p class="wp-caption-text"><i>Figure 20. Message box displayed by the password stealer. (Translation: Dear client, we have detected a problem with your Outlook account. Please check your account and avoid permanent blockage!)</i></p></div>
<div id="attachment_130377" style="width: 760px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/09/Figure19_PwdStealerWindow.png"><img class="wp-image-130377" src="/wp-content/uploads/2019/09/Figure19_PwdStealerWindow-1024x598.png" alt="" width="750" height="438" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure19_PwdStealerWindow-1024x598.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure19_PwdStealerWindow-300x175.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure19_PwdStealerWindow-768x449.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure19_PwdStealerWindow-257x149.png 257w, https://www.welivesecurity.com/wp-content/uploads/2019/09/Figure19_PwdStealerWindow.png 1234w" sizes="(max-width: 750px) 100vw, 750px" /></a><p class="wp-caption-text"><i>Figure 21. Window displayed by the password stealer that tries to obtain the victim&#8217;s Outlook credentials. (Translation: Microsoft free personal email recover account. Begin session. Login, Password. Next)</i></p></div>
<h2><big>Conclusion</big></h2>
<p>In this article, we talked about Casbaneiro, another Latin American banking trojan. We have shown that it shares the common characteristics for this type of malware, such as using fake pop-up windows and containing backdoor functionality. In some campaigns, it splits its functionality into an injector and the actual banking trojan. It also masquerades as a legitimate application in most of the campaigns and targets Brazil and Mexico.</p>
<p>We have also shown strong indicators leading us to believe that Casbaneiro is closely related to Amavaldo. Both pieces of malware use the same, uncommon cryptographic algorithm in the injector component, they have used a very similar PowerShell script in one of their campaigns and they have been seen distributing a very similar email tool.</p>
<p>We have described various techniques Casbaneiro employs in order to hide its C&amp;C server address. These include using remotely stored documents, both legitimate and fake websites and fake DNS entries.</p>
<p>Finally, we have described two techniques used by Casbaneiro to update itself or download and execute additional payloads.</p>
<p><em>For any inquiries, contact us as threatintel@eset.com. Indicators of Compromise can also be found on <a href="https://github.com/eset/malware-ioc/tree/master/casbaneiro" target="_blank" rel="noopener">our GitHub</a>.</em></p>
<h2><big>Indicators of Compromise (IoCs)</big></h2>
<h3>Hashes</h3>
<h4>Campaign 1: Fishy financial manager update</h4>

<table id="tablepress-757" class="tablepress tablepress-id-757">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1</th><th class="column-2">Description</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">F07932D8A36F3E36F2552DADEDAD3E22EFA7AAE1</td><td class="column-2">MSI installer</td><td class="column-3">Win32/TrojanDownloader.Banload.YJD trojan</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">BCDF0DDF98E3AA7D5C67063B9926C5D1C0CA6F3A</td><td class="column-2">Downloaded payload</td><td class="column-3">Win32/Spy.Casbaneiro.AJ trojan</td>
</tr>
</tbody>
</table>

<h4>Campaign 2: What’s cooking? A fowl Windows activator</h4>

<table id="tablepress-758" class="tablepress tablepress-id-758">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1</th><th class="column-2">Description</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">8745197972071EDE08AA9F7FBEC029BED56151C2</td><td class="column-2">MSI installer</td><td class="column-3">JS/TrojanDownloader.Agent.TNX trojan</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">BC909B76858402B3CBB5EFD6858FD5954A5E3FD8</td><td class="column-2">Re-Loader</td><td class="column-3">MSIL/HackTool.WinActivator.J potentially unsafe application</td>
</tr>
</tbody>
</table>

<h4>Campaign 3: The most recent one</h4>

<table id="tablepress-759" class="tablepress tablepress-id-759">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1</th><th class="column-2">Description</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">DD2799C10954293C8E7D75CD4BE2686ADD9AC2D4</td><td class="column-2">MSI installer</td><td class="column-3">JS/TrojanDownloader.Agent.TNX trojan</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">9DFFEB147D89ED58C98252B54C07FAE7D5F9FEA7</td><td class="column-2">Downloaded payload</td><td class="column-3">Win32/Spy.Casbaneiro.AJ trojan</td>
</tr>
</tbody>
</table>

<h4>Files distributed by Download &amp; Execute</h4>

<table id="tablepress-760" class="tablepress tablepress-id-760">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1</th><th class="column-2">Description</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">C873ED94E582D24FAAE6403A17BF2DF497BE04EB</td><td class="column-2">Email tool</td><td class="column-3">MSIL/SpamTool.Agent.O trojan</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">B3630A866802D6F3C1FA2EC487A6795A21833418</td><td class="column-2">Password stealer</td><td class="column-3">Win32/PSW.Agent.OGH trojan</td>
</tr>
</tbody>
</table>

<h3>Filenames</h3>
<ul>
<li>%APPDATA%\Spotify\Spotify.exe</li>
<li>%APPDATA%\OneDrive\OneDrive.exe</li>
<li>%APPDATA%\WhatsApp\WhatsApp.exe</li>
<li>%APPDATA%\Sun\Javar\%RANDOM%\%RANDOM%.exe</li>
<li>%APPDATA%\DMCache\%RANDOM%\%RANDOM%.exe</li>
</ul>
<h3>Run key &amp; values</h3>
<ul>
<li>HKCU\Software\Microsoft\Windows\CurrentVersion\Run
<ul>
<li>Spotify = %APPDATA%\Spotify\Spotify.exe</li>
<li>OneDrive = %APPDATA%\OneDrive\OneDrive.exe</li>
<li>WhatsApp = %APPDATA%\WhatsApp\WhatsApp.exe</li>
<li>%Random% = %APPDATA%\Sun\Javar\%RANDOM%\%RANDOM%.exe</li>
<li>%Random% = %APPDATA%\DMCache\%RANDOM%\%RANDOM%.exe</li>
</ul>
</li>
</ul>
<h3>C&amp;C servers</h3>
<ul>
<li>hostsize.sytes[.]net:7880</li>
<li>agosto2019.servepics[.]com:2456</li>
<li>noturnis.zapto[.]org</li>
<li>4d9p5678.myvnc[.]com</li>
<li>seradessavez.ddns[.]net:14875</li>
</ul>
<h3>Bitcoin wallet</h3>
<ul>
<li>18sn7w8ktbBNgsX8LeeeLMqKS84xMG54si</li>
</ul>
<h2><big>MITRE ATT&amp;CK techniques</big></h2>

<table id="tablepress-761" class="tablepress tablepress-id-761">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Tactic</th><th class="column-2">ID</th><th class="column-3">Name</th><th class="column-4">Description</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td rowspan="2" class="column-1">Initial Access</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1192/" rel="noopener" target="_blank">T1192</a></td><td class="column-3">Spearphishing Link</td><td class="column-4">Some Casbaneiro campaigns start with a malicious link in an email.</td>
</tr>
<tr class="row-3 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1193/" rel="noopener" target="_blank">T1193</a></td><td class="column-3">Spearphishing Attachment</td><td class="column-4">Some Casbaneiro campaigns start with a malicious email attachment.</td>
</tr>
<tr class="row-4 even">
	<td rowspan="2" class="column-1">Execution</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1073/" rel="noopener" target="_blank">T1073</a></td><td class="column-3">DLL Side-Loading</td><td class="column-4">Some campaigns bundle a legitimate executable so as to use this technique in order to execute Casbaneiro.</td>
</tr>
<tr class="row-5 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1086/" rel="noopener" target="_blank">T1086</a></td><td class="column-3">PowerShell</td><td class="column-4">One distribution chain uses an obfuscated PowerShell script.</td>
</tr>
<tr class="row-6 even">
	<td class="column-1">Persistence</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1060/" rel="noopener" target="_blank">T1060</a></td><td class="column-3">Registry Run Keys / Startup Folder</td><td class="column-4">Casbaneiro downloaders set up persistence via Run key.</td>
</tr>
<tr class="row-7 odd">
	<td rowspan="3" class="column-1">Defense Evasion</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1140/" rel="noopener" target="_blank">T1140</a></td><td class="column-3">Deobfuscate/Decode Files or Information</td><td class="column-4">Casbaneiro uses encrypted remote configuration data and its commands are encrypted too.</td>
</tr>
<tr class="row-8 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1036/" rel="noopener" target="_blank">T1036</a></td><td class="column-3">Masquerading</td><td class="column-4">Casbaneiro sometimes masquerades as or is bundled with a legitimate application.</td>
</tr>
<tr class="row-9 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1064/" rel="noopener" target="_blank">T1064</a></td><td class="column-3">Scripting</td><td class="column-4">PowerShell and JavaScript are used in Casbaneiro distribution chains.</td>
</tr>
<tr class="row-10 even">
	<td class="column-1">Credential Access</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1056/" rel="noopener" target="_blank">T1056</a></td><td class="column-3">Input Capture</td><td class="column-4">Casbaneiro contains a command to execute a keylogger. It also steals contents from fake windows it displays.</td>
</tr>
<tr class="row-11 odd">
	<td rowspan="4" class="column-1">Discovery</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1083/" rel="noopener" target="_blank">T1083</a></td><td class="column-3">File and Directory Discovery</td><td class="column-4">Casbaneiro searches for various filesystem paths in order to determine what applications are installed on the victim's machine.</td>
</tr>
<tr class="row-12 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1057/" rel="noopener" target="_blank">T1057</a></td><td class="column-3">Process Discovery</td><td class="column-4">Casbaneiro searches for various process names in order to determine what applications are running on the victim's machine.</td>
</tr>
<tr class="row-13 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1063/" rel="noopener" target="_blank">T1063</a></td><td class="column-3">Security Software Discovery</td><td class="column-4">Casbaneiro scans the system for installed security software.</td>
</tr>
<tr class="row-14 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1082/" rel="noopener" target="_blank">T1082</a></td><td class="column-3">System Information Discovery</td><td class="column-4">Casbaneiro extracts the version of the operating system.</td>
</tr>
<tr class="row-15 odd">
	<td rowspan="2" class="column-1">Collection</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1115/" rel="noopener" target="_blank">T1115</a></td><td class="column-3">Clipboard Data</td><td class="column-4">Casbaneiro captures and replaces bitcoin wallets in clipboard.</td>
</tr>
<tr class="row-16 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1113/" rel="noopener" target="_blank">T1113</a></td><td class="column-3">Screen Capture</td><td class="column-4">Casbaneiro contains a command to take screenshots.</td>
</tr>
<tr class="row-17 odd">
	<td rowspan="2" class="column-1">Command and Control</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1024/" rel="noopener" target="_blank">T1024</a></td><td class="column-3">Custom Cryptographic Protocol</td><td class="column-4">Casbaneiro uses three different custom cryptographic protocols.</td>
</tr>
<tr class="row-18 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1032/" rel="noopener" target="_blank">T1032</a></td><td class="column-3">Standard Cryptographic Protocol</td><td class="column-4">Casbaneiro encrypts its commands using the standard AES protocol.</td>
</tr>
<tr class="row-19 odd">
	<td class="column-1">Exfiltration</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1041/" rel="noopener" target="_blank">T1041</a></td><td class="column-3">Exfiltration Over Command and Control Channel</td><td class="column-4">Casbaneiro sends the data it collects to its C&amp;C server.</td>
</tr>
</tbody>
</table>


                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                    ESET Research                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2019-10-03 11:30:54">3 Oct 2019 - 11:30AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    			
		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="//liondigital.us3.list-manage.com/subscribe/post?u=b76f82b1cc198ab1d80665c99&amp;id=102b0810e2" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
					<input type="text" name="email" value="" placeholder="Email...">
					<button>
						Submit					</button>
				</div>
			</form>		
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybercrime/" class="category-tag-btn">Cybercrime</a>                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/fbi-cybercrime-losses-2020-ic3-623x432.jpg"
                                                         alt="Casbaneiro: Dangerous cooking with a secret ingredient">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/">
                                                    FBI: Cybercrime losses topped US$4.2 billion in 2020                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/exchange-servers-under-siege-10-apt-groups-623x432.jpg"
                                                         alt="Casbaneiro: Dangerous cooking with a secret ingredient">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/">
                                                    Exchange servers under siege from at least 10 APT groups                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/apple-m1-macs-malware-1-623x432.jpg"
                                                         alt="Casbaneiro: Dangerous cooking with a secret ingredient">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/">
                                                    Malware authors already taking aim at Apple M1 Macs                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/eset-kobalos-hpc-high-performance-computing-malware-research-623x432.jpg"
                                                         alt="Casbaneiro: Dangerous cooking with a secret ingredient">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/">
                                                    Kobalos – A complex Linux threat to high performance computing infrastructure                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F10%2F03%2Fcasbaneiro-trojan-dangerous-cooking%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.1.76.32619db9.pro-awus -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"130321 https:\/\/ba-infohub-web01-v.hq.eset.com\/?p=130321","disqusShortname":"welivesecurity","disqusTitle":"Casbaneiro: Dangerous cooking with a secret ingredient","disqusUrl":"https:\/\/www.welivesecurity.com\/2019\/10\/03\/casbaneiro-trojan-dangerous-cooking\/","postId":"130321"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>