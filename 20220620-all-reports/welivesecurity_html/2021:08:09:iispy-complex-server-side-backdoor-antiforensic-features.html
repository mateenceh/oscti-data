<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/css/main.css?id=09d01dd87b618f2315ce" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Zuzana Hromcová',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>

<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features | WeLiveSecurity</title>
<meta name="description" content="ESET research desribes IISpy, a malicious IIS extension that employs nifty tricks in an attempt to secure long-term espionage on compromised IIS servers."/>
<link rel="canonical" href="https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features | WeLiveSecurity" />
<meta property="og:description" content="ESET research desribes IISpy, a malicious IIS extension that employs nifty tricks in an attempt to secure long-term espionage on compromised IIS servers." />
<meta property="og:url" content="https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2021-08-09T09:30:46+00:00" />
<meta property="article:modified_time" content="2021-08-09T12:57:08+00:00" />
<meta property="og:updated_time" content="2021-08-09T12:57:08+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2021/08/iispy-iis-malware-backdoor-cyberespionage.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2021/08/iispy-iis-malware-backdoor-cyberespionage.jpg" />
<meta property="og:image:width" content="623" />
<meta property="og:image:height" content="415" />
<meta property="og:image:alt" content="iispy-iis-malware-backdoor-cyberespionage" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET research desribes IISpy, a malicious IIS extension that employs nifty tricks in an attempt to secure long-term espionage on compromised IIS servers." />
<meta name="twitter:title" content="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2021/08/iispy-iis-malware-backdoor-cyberespionage.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel="alternate" href="https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2021/08/09/iispy-backdoor-servidor-iis-funciones-anti-forenses/" hreflang="es" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2021/08/09/iispy-backdoor-servidor-iis-funciones-anti-forenses/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2021/08/09/iispy-backdoor-servidor-iis-funciones-anti-forenses/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong>					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2021/08/iispy-iis-malware-backdoor-espionage.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features</h1>
<div class="excerpt">The second in our series on IIS threats dissects a malicious IIS extension that employs nifty tricks in an attempt to secure long-term espionage on the compromised servers </div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/zhromcova/" title="Zuzana Hromcová">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2018/06/zuzana.hromcova@eset.sk_-222x179.jpg" alt="Zuzana Hromcová">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/zhromcova/" title="Zuzana Hromcová">
                    Zuzana Hromcová                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2021-08-09 11:30:46">9 Aug 2021 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F&text=IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>The second in our series on IIS threats dissects a malicious IIS extension that employs nifty tricks in an attempt to secure long-term espionage on the compromised servers </p>
                            </div>

                            <p>ESET researchers have discovered and analyzed a previously undocumented backdoor, implemented as an extension for <em>Internet</em> <em>Information Services</em> (IIS), Microsoft’s web server software. The backdoor, which we named IISpy, uses a variety of tricks to interfere with the server’s logging and to evade detection, in order to perform long-term espionage. IISpy is detected by ESET security solutions as Win{32,64}/BadIIS.</p>
<p><em>This blogpost is the second installment in our series where ESET researchers put IIS web server threats under the microscope – the <a href="https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/" target="_blank" rel="noopener">previous part</a> discusses IIS malware used for cybercrime. For a comprehensive guide to how to detect, analyze and remove IIS malware, refer to our white paper Anatomy of native IIS malware, where IISpy is featured as one of the studied families (Group 7).</em></p>
<div class="nwg-promo document clearfix">
            <div class="text">
                <p>
                     <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf" target="_blank">Anatomy of native IIS malware</a>
                </p>
                <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf" class="my-btn document" target="_blank">
                    Download Research Paper
                </a>
            </div>
            <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf" target="_blank" class="no-fancy download">
                <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/pdf-document-big.png" alt="" class="document">
            </a>
        </div>
<h2>Attack overview</h2>
<p>According to ESET telemetry, this backdoor has been active since at least July 2020, and has been used with <em>Juicy Potato</em> (detected as Win64/HackTool.JuicyPotato by ESET security solutions), which is a privilege escalation tool. We suspect the attackers first obtain initial access to the IIS server via some vulnerability, and then use <em>Juicy Potato</em> to obtain the administrative privileges that are <a href="https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview" target="_blank" rel="noopener">required to install</a> IISpy as a native IIS extension.</p>
<p>According to our telemetry, IISpy affects a small number of IIS servers located in Canada, the USA and the Netherlands – but this is likely not the full picture, as it is still common for administrators to not use any security software on servers, and thus our visibility into IIS servers is limited.</p>
<p>Because IISpy is configured as an IIS extension, it can see all the HTTP requests received by the compromised IIS server, and shape the HTTP response that the server will answer with. IISpy uses this channel to implement its C&amp;C communication, which allows it to operate as a <em>passive network implant</em>. As shown in Figure 1, the operator (not the backdoor) initiates the connection by sending a special HTTP request to the compromised server. The backdoor recognizes the attacker request, extracts and executes the embedded backdoor commands, and modifies the HTTP response to include the command output.</p>
<p>The following backdoor commands are supported:</p>
<ul>
<li>Get system information</li>
<li>Upload/download files</li>
<li>Execute files or shell commands</li>
<li>Create a reverse shell</li>
<li>Create/list/move/rename/delete files and folders</li>
<li>Create a mapping between a local and a remote drive</li>
<li>Exfiltrate collected data</li>
</ul>
<p>IISpy ignores all other HTTP requests sent to the compromised IIS server by its legitimate visitors – of course, these are still handled by the benign server modules.</p>
<div id="attachment_153635" style="width: 809px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-1.-IISpy-backdoor-control-mechanism.png"><img class="wp-image-153635" src="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-1.-IISpy-backdoor-control-mechanism-300x99.png" alt="Figure 1. IISpy backdoor control mechanism" width="799" height="263" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-1.-IISpy-backdoor-control-mechanism-300x99.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-1.-IISpy-backdoor-control-mechanism-768x253.png 768w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-1.-IISpy-backdoor-control-mechanism-1024x337.png 1024w" sizes="(max-width: 799px) 100vw, 799px" /></a><p class="wp-caption-text"><em>Figure 1. IISpy backdoor control mechanism</em></p></div>
<h2><span lang="EN-CA">Network communication</span></h2>
<p>The control requests from IISpy’s operators have a predefined structure, with a specific (hidden) relationship between the <span style="font-family: courier new, courier, monospace;">Cookie</span> and <span style="font-family: courier new, courier, monospace;">Host</span> headers, and the URL. To identify such requests, IISpy first computes the MD5 hash of both the URL and <span style="font-family: courier new, courier, monospace;">Host</span> header of an inbound HTTP request, and splits each MD5 into four double words:</p>
<ul>
<li><span style="font-family: courier new, courier, monospace;">&lt;h0&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt; = md5(Host Header value)</span></li>
<li><span style="font-family: courier new, courier, monospace;">&lt;r0&gt;&lt;r1&gt;&lt;r2&gt;&lt;r3&gt; = md5(Raw URL value)</span></li>
</ul>
<p>Then, it verifies that the Cookie header contains a substring built from these values:</p>
<ul>
<li><span style="font-family: courier new, courier, monospace;">&lt;r1&gt;&lt;h2&gt;=&lt;h3&gt;&lt;r2&gt;&lt;r3&gt;&lt;r0&gt;&lt;h0&gt;&lt;h1&gt;</span></li>
</ul>
<p>Figure 2 illustrates how this substring is assembled. Backdoor commands are embedded in the HTTP body, AES&#8209;CBC encrypted and base64 encoded.</p>
<div id="attachment_153636" style="width: 810px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format.png"><img class="wp-image-153636" src="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format-300x87.png" alt="Figure 2. IISpy control HTTP request format" width="800" height="232" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format-300x87.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format-768x222.png 768w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format-1024x296.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-2.-IISpy-control-HTTP-request-format.png 1503w" sizes="(max-width: 800px) 100vw, 800px" /></a><p class="wp-caption-text"><em>Figure 2. IISpy control HTTP request format</em></p></div>
<p>Note that this structure of control requests is unique to IISpy: all the other known IIS backdoors (that we have documented in our white paper <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf" target="_blank" rel="noopener"><em>Anatomy of native IIS malware</em></a>) are controlled by hardcoded passwords, specific URIs or custom HTTP headers. As opposed to those “secrets”, IISpy’s control requests are more difficult to fingerprint and find in logs, which is an attempt to keep its C&amp;C communication unnoticed.</p>
<p>Another such trick is used for the other side of the communication: IISpy embeds its encrypted and encoded response within a fake PNG image, between the PNG file headers as a <span style="font-family: courier new, courier, monospace;">TEXT</span> or <span style="font-family: courier new, courier, monospace;">BLOB</span> chunk. To reply to a control HTTP request, IISpy replaces the original HTTP response body (sent by the IIS server) with the fake PNG file, and sets the <span style="font-family: courier new, courier, monospace;">Content-Type</span> header to <span style="font-family: courier new, courier, monospace;">image/png</span> to give more credibility to this charade.</p>
<p>Both sides of the C&amp;C communication are AES-CBC encrypted and base64 encoded, using these parameters:</p>
<ul>
<li>Encryption key: <span style="font-family: courier new, courier, monospace;">DA1F8BE19D9122F6499D72B90299CAB080E9D599C57E802CD667BF53CCC9EAB2</span></li>
<li>IV: <span style="font-family: courier new, courier, monospace;">668EDC2D7ED614BF8F69FF614957EF83EE</span></li>
</ul>
<h2><span lang="EN-CA">Technical analysis</span></h2>
<p>From the technical standpoint, IISpy is implemented as a native IIS module – a C++ DLL deployed in the <nobr><span style="font-family: courier new, courier, monospace;">%windir%\system32\inetsrv\</span></nobr> or the <span style="font-family: courier new, courier, monospace;">%windir%\SysWOW64\inetsrv</span> folder on the compromised IIS server, under the name <span style="font-family: courier new, courier, monospace;">cache.dll</span> or <span style="font-family: courier new, courier, monospace;">logging.dll</span>.</p>
<p>IISpy is configured as an IIS extension in the <nobr><span style="font-family: courier new, courier, monospace;">%windir%\system32\inetsrv\config\ApplicationHost.config</span></nobr> configuration file, and so it is loaded automatically by the IIS Worker Process (<span style="font-family: courier new, courier, monospace;">w3wp.exe</span>), which handles all requests sent to the IIS web server. As far as execution and persistence goes, configuring IISpy as an IIS module itself checks all the boxes – all that’s left to implement inside the malicious module is the actual request processing (and as a bonus, a few anti-detection and anti-forensic tricks). We cover both in this section.</p>
<h3><span lang="EN-CA">Module design</span></h3>
<p>IISpy is written using the <a href="https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/native-code-api-reference" target="_blank" rel="noopener">IIS C++ API</a>, and uses instances of <a href="https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/ihttpcontext-interface" target="_blank" rel="noopener">IHttpContext</a>, <a href="https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class" target="_blank" rel="noopener">IHttpRequest</a> and <a href="https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/ihttpresponse-interface" target="_blank" rel="noopener">IHttpResponse</a> interfaces to parse HTTP requests and manipulate the HTTP responses.</p>
<p>As required by all native IIS modules, it exports a function called <span style="font-family: courier new, courier, monospace;">RegisterModule</span>, where it creates an instance of its core classes and registers their methods for server events using the <span style="font-family: courier new, courier, monospace;">IHttpModuleRegistrationInfo::SetRequestNotifications</span> method, as shown in Figure 3.</p>
<div id="attachment_153637" style="width: 795px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-3.-IISpys-RegisterModule-export.png"><img class="wp-image-153637 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-3.-IISpys-RegisterModule-export.png" alt="Figure 3. IISpy's RegisterModule export" width="785" height="665" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-3.-IISpys-RegisterModule-export.png 785w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-3.-IISpys-RegisterModule-export-300x254.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-3.-IISpys-RegisterModule-export-768x651.png 768w" sizes="(max-width: 785px) 100vw, 785px" /></a><p class="wp-caption-text"><em>Figure 3. IISpy&#8217;s RegisterModule export</em></p></div>
<p>IISpy’s core class is inherited from <a href="https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class">CHttpModule</a> and, as seen in Figure 4, overrides three of its methods – event handlers for the server events:</p>
<ul>
<li><span style="font-family: courier new, courier, monospace;">OnBeginRequest</span> is called every time the server starts processing a new HTTP request, and IISpy uses this handler to parse it in search of attacker requests</li>
<li><span style="font-family: courier new, courier, monospace;">OnEndRequest</span>, called with the last step within the HTTP <a href="https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture#request-processing-in-iis" target="_blank" rel="noopener">request-processing pipeline</a>, implements IISpy’s backdoor interpreter</li>
<li><span style="font-family: courier new, courier, monospace;">OnLogRequest</span>, called right before the IIS server logs a processed HTTP request, implements IISpy’s anti-logging feature</li>
</ul>
<p>IISpy registers these handlers with the highest priority (via the <span style="font-family: courier new, courier, monospace;">IHttpModuleRegistrationInfo::SetPriorityForRequestNotification</span> API). Since several IIS modules (malicious and regular) can be registered for the same event, this ensures that IISpy’s handler will be executed before any other handlers registered for the same event.</p>
<div id="attachment_153638" style="width: 588px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-4.-IISpys-core-class-implements-three-event-handlers.png"><img class="wp-image-153638 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-4.-IISpys-core-class-implements-three-event-handlers.png" alt="Figure 4. IISpy's core class implements three event handlers" width="578" height="567" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-4.-IISpys-core-class-implements-three-event-handlers.png 578w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-4.-IISpys-core-class-implements-three-event-handlers-300x294.png 300w" sizes="(max-width: 578px) 100vw, 578px" /></a><p class="wp-caption-text"><em>Figure 4. IISpy&#8217;s core class implements three event handlers</em></p></div>
<h3><span lang="EN-CA">Backdoor commands</span></h3>
<p>In its <span style="font-family: courier new, courier, monospace;">OnEndRequest</span> handler, IISpy decrypts the HTTP body of an attacker’s request and extracts its parameters, which are organized as key-value pairs and listed in Table 1.</p>
<p><em>Table 1. IISpy attacker request parameters</em></p>

<table id="tablepress-979" class="tablepress tablepress-id-979">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Key</th><th class="column-2">Value</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">/mode</span></td><td class="column-2">Command type</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">/action</span></td><td class="column-2">Command</td>
</tr>
<tr class="row-4 even">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">/path<br />
/binary<br />
/data<br />
…</span></td><td class="column-2">Command arguments (see Table 2 for full list)</td>
</tr>
<tr class="row-5 odd">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">/credential/username</span></td><td class="column-2">Local user username, used for impersonation</td>
</tr>
<tr class="row-6 even">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">/credential/password</span></td><td class="column-2">Local user password, used for impersonation</td>
</tr>
</tbody>
</table>

<p>If the credentials are present, IISpy uses them to log in as the user (via <span style="font-family: courier new, courier, monospace;">LogonUserW</span>, <span style="font-family: courier new, courier, monospace;">ImpersonateLoggedOnUser</span>) to execute the backdoor commands in the user’s context. The backdoor commands and arguments are also organized as nested key-value pairs, as listed in Table 2.</p>
<p><em>Table 2. IISpy backdoor commands and arguments</em></p>

<table id="tablepress-981" class="tablepress tablepress-id-981">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Command type  (<span style="font-family: courier new, courier, monospace;">/mode</span>  value)</th><th class="column-2">Command (<span style="font-family: courier new, courier, monospace;">/action</span>  value)</th><th class="column-3">Arguments (key names)</th><th class="column-4">Command description</th><th class="column-5">Returned data (map structure or description)</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">init</span></td><td class="column-2">N/A</td><td class="column-3">N/A</td><td class="column-4">Collects basic system information: computer name and domain, username and domain, logical drives information.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/computer/domain<br />
/computer/name<br />
/user/domain<br />
/user/name<br />
/-<br />
&nbsp;&nbsp;/name<br />
&nbsp;&nbsp;/type<br />
</span></td>
</tr>
<tr class="row-3 odd">
	<td rowspan="7" class="column-1"><span style="font-family: courier new, courier, monospace;">file</span></td><td class="column-2"><span style="font-family: courier new, courier, monospace;">list</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path</span></td><td class="column-4">Collects information about the files in the specified folder.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/-<br />
&nbsp;&nbsp;/name<br />
&nbsp;&nbsp;/attr<br />
&nbsp;&nbsp;/size<br />
&nbsp;&nbsp;/create<br />
&nbsp;&nbsp;/access<br />
&nbsp;&nbsp;/write</span><br />
</td>
</tr>
<tr class="row-4 even">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">get</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/binary</span></td><td class="column-4">Downloads the file with the specified name from the compromised IIS server.</td><td class="column-5">The contents of the file, encrypted and embedded within a fake PNG image (a PNG header followed by non-image data).</td>
</tr>
<tr class="row-5 odd">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">create</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/directory<br />
/data<br />
</span></td><td class="column-4">Creates a new file or directory in the specified path. Optional <span style="font-family: courier new, courier, monospace;">/data</span> argument can hold the file content.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/-<br />
&nbsp;&nbsp;/file<br />
&nbsp;&nbsp;/attr<br />
&nbsp;&nbsp;/size<br />
&nbsp;&nbsp;/create<br />
&nbsp;&nbsp;/access<br />
&nbsp;&nbsp;/write</span><br />
</td>
</tr>
<tr class="row-6 even">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">upload</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/data<br />
</span></td><td class="column-4">Uploads a file with the specified name to the compromised server. The  <span style="font-family: courier new, courier, monospace;">/data</span> entry contains base64-encoded file content.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/-<br />
&nbsp;&nbsp;/file<br />
&nbsp;&nbsp;/attr<br />
&nbsp;&nbsp;/size<br />
&nbsp;&nbsp;/create<br />
&nbsp;&nbsp;/access<br />
&nbsp;&nbsp;/write<br />
</span></td>
</tr>
<tr class="row-7 odd">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">delete</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/files<br />
&nbsp;&nbsp;/name<br />
&nbsp;&nbsp;/attr<br />
</span></td><td class="column-4">Deletes the list of files/directories in the given path.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/files<br />
&nbsp;&nbsp;/code<br />
&nbsp;&nbsp;/name<br />
</span></td>
</tr>
<tr class="row-8 even">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">move</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/dest<br />
/copy<br />
/files<br />
&nbsp;&nbsp;/name<br />
&nbsp;&nbsp;/new</span><br />
</td><td class="column-4">Copies or renames files from the list, from the source directory to the destination directory.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/files<br />
&nbsp;&nbsp;/code<br />
&nbsp;&nbsp;/name<br />
</span></td>
</tr>
<tr class="row-9 odd">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">time</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/path<br />
/create<br />
/access<br />
/write</span></td><td class="column-4">Modifies file timestamps</td><td class="column-5">N/A</td>
</tr>
<tr class="row-10 even">
	<td rowspan="2" class="column-1"><span style="font-family: courier new, courier, monospace;">drive</span></td><td class="column-2"><span style="font-family: courier new, courier, monospace;">map</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/letter<br />
/share<br />
/username<br />
/password</span></td><td class="column-4">Creates a mapping between a local and a remote drive, using the specified credentials for the network resource.</td><td class="column-5">N/A</td>
</tr>
<tr class="row-11 odd">
	<td class="column-2"><span style="font-family: courier new, courier, monospace;">remove</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/letter</span></td><td class="column-4">Removes an existing drive mapping</td><td class="column-5">N/A</td>
</tr>
<tr class="row-12 even">
	<td class="column-1"><span style="font-family: courier new, courier, monospace;">cmd</span></td><td class="column-2"><span style="font-family: courier new, courier, monospace;">exec</span></td><td class="column-3"><span style="font-family: courier new, courier, monospace;">/cmd</span></td><td class="column-4">Executes the specified command, either under the context of the current user, or the user provided in arguments. Returns the command output.</td><td class="column-5"><span style="font-family: courier new, courier, monospace;">/output</span></td>
</tr>
</tbody>
</table>

<p>After executing the backdoor command, IISpy encrypts and encodes its return data and uses it to modify the HTTP response to the attacker’s request. The return data is also organized as key-value pairs, with the entries listed in Table 2, plus two additional entries based on the <span style="font-family: courier new, courier, monospace;">GetLastError</span> result (or custom error messages):</p>
<ul>
<li><span style="font-family: courier new, courier, monospace;">/error/code</span></li>
<li><span style="font-family: courier new, courier, monospace;">/error/message</span></li>
</ul>
<h3><span lang="EN-CA">Anti-logging feature</span></h3>
<p>Finally, IISpy implements the <span style="font-family: courier new, courier, monospace;">OnLogRequest</span> event handler – called right before the IIS server logs a processed HTTP request. The backdoor uses this handler to modify the log entries for requests coming from the attackers to make them look like casual requests. As shown in Figure 5, these steps are taken:</p>
<ul>
<li>Rewrite the HTTP method in the request to <span style="font-family: courier new, courier, monospace;">GET</span></li>
<li>Rewrite the URL from the request to <span style="font-family: courier new, courier, monospace;">/</span></li>
<li>Delete these headers from the request: <span style="font-family: courier new, courier, monospace;">Cookie</span>, <span style="font-family: courier new, courier, monospace;">Origin</span>, <span style="font-family: courier new, courier, monospace;">Referer</span>, <span style="font-family: courier new, courier, monospace;">Sec-Fetch-Mode</span>, <span style="font-family: courier new, courier, monospace;">Sec-Fetch-Site</span>, <span style="font-family: courier new, courier, monospace;">Content-Type</span>, <span style="font-family: courier new, courier, monospace;">Content-Length</span>, <span style="font-family: courier new, courier, monospace;">X-Forwarded-IP</span>, <span style="font-family: courier new, courier, monospace;">X-Forwarded-For</span>, <span style="font-family: courier new, courier, monospace;">X-Forwarded-By</span>, <span style="font-family: courier new, courier, monospace;">X-Forwarded-Proto</span></li>
</ul>
<p>With the log entries modified this way, the attackers attempt to further hide traces of their malicious activities, to make potential forensic analysis more difficult.</p>
<div id="attachment_153639" style="width: 788px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests.png"><img class="wp-image-153639 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests.png" alt="Figure 5. IISpy modifies log entries for attacker requests" width="778" height="436" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests.png 778w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests-300x168.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests-768x430.png 768w, https://www.welivesecurity.com/wp-content/uploads/2021/08/Figure-5.-IISpy-modifies-log-entries-for-attacker-requests-143x79.png 143w" sizes="(max-width: 778px) 100vw, 778px" /></a><p class="wp-caption-text"><em>Figure 5. IISpy modifies log entries for attacker requests</em></p></div>
<h2>Conclusion</h2>
<p>IISpy is a complex server-side backdoor misusing the extensibility of IIS web server software for its persistence, execution and C&amp;C mechanisms. With its tricks to blend in with the regular network traffic, and to clear incriminating logs, it is designed for long term espionage on compromised IIS servers.</p>
<p>Organizations that handle sensitive data on their servers should be on the lookout, such as organizations that have the Outlook on the web (OWA) service enabled on their Exchange email servers – OWA is implemented via IIS, and makes an interesting target for espionage. In any case, the best way to keep IISpy out of your servers is to keep them up to date, and carefully consider which services are exposed to the internet, to reduce the risk of server exploitation.</p>
<p><em>Additional technical details on the malware, Indicators of Compromise and YARA rules can be found in our comprehensive <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf" target="_blank" rel="noopener">white paper</a>, and on </em><a href="https://github.com/eset/malware-ioc/tree/master/badiis" target="_blank" rel="noopener"><em>GitHub</em></a><em>. For any inquiries, or to make sample submissions related to the subject, contact us at: </em><a href="mailto:threatintel@eset.com"><em>threatintel@eset.com</em></a><em>.</em></p>
<p><em>Stay tuned for the last installment of this series where we cover malicious IIS extensions used for SEO fraud.</em></p>
<div class="update-block"> <strong><em>Read next:</em></strong><br />
<em><a href="https://www.welivesecurity.com/2021/08/06/anatomy-native-iis-malware/" target="_blank" rel="noopener">Anatomy of native IIS malware</a></em><br />
<em><a href="https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/" target="_blank" rel="noopener">IIStealer: A server‑side threat to e‑commerce transactions</a></em> </div>
<h2>Indicators of Compromise (IoCs)</h2>
<h3>ESET detection names</h3>
<p>Win32/BadIIS.F<br />
Win64/BadIIS.U</p>
<h3>SHA-1</h3>
<p><span style="font-family: courier new, courier, monospace;">22F8CA2EB3AF377E913B6D06B5A3618D294E4331</span><br />
<span style="font-family: courier new, courier, monospace;">435E3795D934EA8C5C7F4BCFEF2BEEE0E3C76A54</span><br />
<span style="font-family: courier new, courier, monospace;">CED7BC6E0F1A15465E61CFEC87AAEF98BD999E15</span></p>
<h3>Filenames</h3>
<p><span style="font-family: courier new, courier, monospace;">cache.dll</span><br />
<span style="font-family: courier new, courier, monospace;">logging.dll</span></p>
<h2>MITRE ATT&amp;CK techniques</h2>
<p><em>Note: This table was built using </em><a href="https://attack.mitre.org/resources/versions/" target="_blank" rel="noopener"><em>version 9</em></a><em> of the MITRE ATT&amp;CK framework</em>.<br />

<table id="tablepress-982" class="tablepress tablepress-id-982">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Tactic</th><th class="column-2">ID</th><th class="column-3">Name</th><th class="column-4">Description</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td rowspan="2" class="column-1">Resource Development</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1587/001/" rel="noopener" target="_blank">T1587.001</a></td><td class="column-3">Develop Capabilities: Malware</td><td class="column-4">IISpy is a custom-made malware family.</td>
</tr>
<tr class="row-3 odd">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1588/002/" rel="noopener" target="_blank">T1588.002</a></td><td class="column-3">Obtain Capabilities: Tool</td><td class="column-4">Operators of IISpy have used  Juicy Potato , a local privilege escalation tool.</td>
</tr>
<tr class="row-4 even">
	<td class="column-1">Initial Access</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1190/" rel="noopener" target="_blank">T1190</a></td><td class="column-3">Exploit Public-Facing Application</td><td class="column-4">IISpy likely obtains its initial access to the IIS server via some vulnerability in the web application or on the server, before it uses the privilege escalation tool  Juicy Potato  to obtain the administrative privileges that are required to install a native IIS module.</td>
</tr>
<tr class="row-5 odd">
	<td rowspan="2" class="column-1">Execution</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1059/003/" rel="noopener" target="_blank">T1059.003</a></td><td class="column-3">Command and Scripting Interpreter: Windows Command Shell</td><td class="column-4">IISpy supports a backdoor command that uses the Windows command shell to execute shell commands on the compromised IIS server.</td>
</tr>
<tr class="row-6 even">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1569/002/" rel="noopener" target="_blank">T1569.002</a></td><td class="column-3">System Services: Service Execution</td><td class="column-4">IIS server (and by extension, IISpy) persists as a Windows service.</td>
</tr>
<tr class="row-7 odd">
	<td class="column-1">Persistence</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1546/" rel="noopener" target="_blank">T1546</a></td><td class="column-3">Event Triggered Execution</td><td class="column-4">IISpy is loaded by IIS Worker Process (w3wp.exe) when the IIS server receives an inbound HTTP request.</td>
</tr>
<tr class="row-8 even">
	<td class="column-1">Privilege Escalation</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1068/" rel="noopener" target="_blank">T1068</a></td><td class="column-3">Exploitation for Privilege Escalation</td><td class="column-4">Operators of IISpy have used a local privilege escalation tool  Juicy Potato  to elevate privileges.</td>
</tr>
<tr class="row-9 odd">
	<td rowspan="3" class="column-1">Defense Evasion</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1134/001/" rel="noopener" target="_blank">T1134.001</a></td><td class="column-3">Access Token Manipulation: Token Impersonation/Theft</td><td class="column-4">IISpy has the ability to execute backdoor commands in another user’s context (via <span style="font-family: courier new, courier, monospace;">  LogonUserW, ImpersonateLoggedOnUser</span>).</td>
</tr>
<tr class="row-10 even">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1070/" rel="noopener" target="_blank">T1070</a></td><td class="column-3">Indicator Removal on Host</td><td class="column-4">IISpy has the ability to sanitize logging of attacker requests on the IIS server.</td>
</tr>
<tr class="row-11 odd">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1070/006/" rel="noopener" target="_blank">T1070.006</a></td><td class="column-3">Indicator Removal on Host: Timestomp</td><td class="column-4">IISpy supports a backdoor command to modify file timestamps.</td>
</tr>
<tr class="row-12 even">
	<td class="column-1">Collection</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1005/" rel="noopener" target="_blank">T1005</a></td><td class="column-3">Data from Local System</td><td class="column-4">IISpy supports a backdoor command to collect and exfiltrate files from the compromised IIS server.</td>
</tr>
<tr class="row-13 odd">
	<td rowspan="5" class="column-1">Command and Control</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1071/001/" rel="noopener" target="_blank">T1071.001</a></td><td class="column-3">Application Layer Protocol: Web Protocols</td><td class="column-4">IISpy is a passive network implant: Adversaries send HTTP requests to the compromised IIS server to control the backdoor.</td>
</tr>
<tr class="row-14 even">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1001/" rel="noopener" target="_blank">T1001</a></td><td class="column-3">Data Obfuscation</td><td class="column-4">IISpy operators send commands with a specially constructed combination of URLs,  Host  headers and cookies.<br />
IISpy exfiltrates data in a fake PNG file (a PNG header followed by non-image data), in an attempt to make its C&amp;C traffic look like regular network traffic.</td>
</tr>
<tr class="row-15 odd">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1132/001/" rel="noopener" target="_blank">T1132.001</a></td><td class="column-3">Data Encoding: Standard Encoding</td><td class="column-4">IISpy encodes the C&amp;C communication with base64 encoding.</td>
</tr>
<tr class="row-16 even">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1573/001/" rel="noopener" target="_blank">T1573.001</a></td><td class="column-3">Encrypted Channel: Symmetric Cryptography</td><td class="column-4">IISpy uses AES-CBC to encrypt C&amp;C communication.</td>
</tr>
<tr class="row-17 odd">
	<td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1105/" rel="noopener" target="_blank">T1105</a></td><td class="column-3">Ingress Tool Transfer</td><td class="column-4">IISpy supports a backdoor command to upload additional tools to the compromised IIS server.</td>
</tr>
<tr class="row-18 even">
	<td class="column-1">Exfiltration</td><td class="column-2"><a href="https://attack.mitre.org/versions/v9/techniques/T1041/" rel="noopener" target="_blank">T1041</a></td><td class="column-3">Exfiltration Over C2 Channel</td><td class="column-4">IISpy supports a backdoor command to exfiltrate data and files from the compromised IIS server.</td>
</tr>
</tbody>
</table>
</p>
<p><a class="no-fancy" href="https://www.eset.com/int/business/services/threat-intelligence/?utm_source=welivesecurity.com&amp;utm_medium=referral&amp;utm_campaign=wls-research&amp;utm_content=iispy-complex-server-side-backdoor-antiforensic-features" target="_blank" rel="noopener"><img class="aligncenter wp-image-152551" src="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png" alt="" width="899" height="290" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png 918w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-300x97.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-768x248.png 768w" sizes="(max-width: 899px) 100vw, 899px" /></a></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/zhromcova/" title="Zuzana Hromcová">
                    Zuzana Hromcová                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2021-08-09 11:30:46">9 Aug 2021 - 11:30AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="https://enjoy.eset.com/pub/rf" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
                    <input type="text" name="EMAIL_ADDRESS_" value="" placeholder="Email...">
                    <input type="hidden" name="NEWSLETTER" value="We Live Security">

                    <input type="hidden" name="_ri_" value="X0Gzc2X%3DAQpglLjHJlTQGgXv4jDGEK4KW2uhw0qgUzfwuivmOJOPCgzgo9vsI3VwjpnpgHlpgneHmgJoXX0Gzc2X%3DAQpglLjHJlTQGzbD6yU2pAgzaJM16bkTA7tOwuivmOJOPCgzgo9vsI3">
                    <input type="hidden" name="_ei_" value="Ep2VKa8UKNIAPP_2GAEW0bY">
                    <input type="hidden" name="_di_" value="m0a5n0j02duo9clmm4btuu5av8rdtvqfqd03v1hallrvcob47ad0">
                    <input type="hidden" name="EMAIL_PERMISSION_STATUS_" value="O">
                    <input type="hidden" name="CONTACT_SOURCE_MOST_RECENT" value="WLS_Subscribe_Form">
                    <button>
						Submit					</button>
				</div>
			</form>
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/08/iistealer-iis-malware-credit-card-information-theft-1-623x415.jpg"
                                                         alt="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/">
                                                    IIStealer: A server-side threat to e-commerce transactions                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/08/06/anatomy-native-iis-malware/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/07/wls_anatomy-iis-malware-2021_1770540524_1000x667-623x432.jpg"
                                                         alt="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/08/06/anatomy-native-iis-malware/">
                                                    Anatomy of native IIS malware                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/07/20/url-shortener-services-android-malware-banking-sms-trojans/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/07/Android-URL-shortener-1-623x432.jpg"
                                                         alt="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/07/20/url-shortener-services-android-malware-banking-sms-trojans/">
                                                    Some URL shortener services distribute Android malware, including banking or SMS trojans                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/07/07/bandidos-at-large-spying-campaign-latin-america/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-malware-latin-america-623x415.jpg"
                                                         alt="IISpy: A complex server&#8209;side backdoor with anti&#8209;forensic features">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/07/07/bandidos-at-large-spying-campaign-latin-america/">
                                                    Bandidos at large: A spying campaign in Latin America                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy Policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2021%2F08%2F09%2Fiispy-complex-server-side-backdoor-antiforensic-features%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/js/main.js?id=fef3139dcedd23afc232"></script>
    <!-- Version: v1.4.1.0bbcde.pro.azeu -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"153415 https:\/\/backend.welivesecurity.com\/?p=153415","disqusShortname":"welivesecurity","disqusTitle":"IISpy: A complex server\u2011side backdoor with anti\u2011forensic features","disqusUrl":"https:\/\/www.welivesecurity.com\/2021\/08\/09\/iispy-complex-server-side-backdoor-antiforensic-features\/","postId":"153415"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>
