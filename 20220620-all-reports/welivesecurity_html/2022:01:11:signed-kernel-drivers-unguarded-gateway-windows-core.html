<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/css/main.css?id=09d01dd87b618f2315ce" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Michal Poslušný',
        'ArticleCategory': 'ESET Research',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>

<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Signed kernel drivers – Unguarded gateway to Windows’ core | WeLiveSecurity</title>
<link rel="canonical" href="https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="de_DE" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Signed kernel drivers – Unguarded gateway to Windows’ core | WeLiveSecurity" />
<meta property="og:description" content="ESET researchers look at malware that abuses vulnerabilities in kernel drivers and outline mitigation techniques against this type of exploitation" />
<meta property="og:url" content="https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:tag" content="BYOD" />
<meta property="article:tag" content="Windows" />
<meta property="article:section" content="ESET Research" />
<meta property="article:published_time" content="2022-01-11T10:30:28+00:00" />
<meta property="article:modified_time" content="2022-01-14T10:58:32+00:00" />
<meta property="og:updated_time" content="2022-01-14T10:58:32+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2022/01/windows-1200x628.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2022/01/windows-1200x628.jpg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="628" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET researchers look at malware that abuses vulnerabilities in kernel drivers and outline mitigation techniques against this type of exploitation" />
<meta name="twitter:title" content="Signed kernel drivers – Unguarded gateway to Windows’ core | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2022/01/windows-1200x628.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel="alternate" href="https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2022/01/11/controladores-kernel-firmados-puerta-desprotegida-acceder-nucleo-windows/" hreflang="es" />
<link rel="alternate" href="https://www.welivesecurity.com/deutsch/2022/01/13/signierte-kernel-treiber-unbewachte-zugaenge-zum-windows-kern/" hreflang="de" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">

<script>(window.BOOMR_mq=window.BOOMR_mq||[]).push(["addVar",{"rua.upush":"false","rua.cpush":"false","rua.upre":"false","rua.cpre":"false","rua.uprl":"false","rua.cprl":"false","rua.cprf":"false","rua.trans":"","rua.cook":"false","rua.ims":"false","rua.ufprl":"false","rua.cfprl":"false","rua.isuxp":"false","rua.texp":"norulematch"}]);</script>
                              <script>!function(e){var n="https://s.go-mpulse.net/boomerang/";if("False"=="True")e.BOOMR_config=e.BOOMR_config||{},e.BOOMR_config.PageParams=e.BOOMR_config.PageParams||{},e.BOOMR_config.PageParams.pci=!0,n="https://s2.go-mpulse.net/boomerang/";if(window.BOOMR_API_key="7R9SM-QGSYF-QDLJK-UETXR-SPM6B",function(){function e(){if(!o){var e=document.createElement("script");e.id="boomr-scr-as",e.src=window.BOOMR.url,e.async=!0,i.parentNode.appendChild(e),o=!0}}function t(e){o=!0;var n,t,a,r,d=document,O=window;if(window.BOOMR.snippetMethod=e?"if":"i",t=function(e,n){var t=d.createElement("script");t.id=n||"boomr-if-as",t.src=window.BOOMR.url,BOOMR_lstart=(new Date).getTime(),e=e||d.body,e.appendChild(t)},!window.addEventListener&&window.attachEvent&&navigator.userAgent.match(/MSIE [67]\./))return window.BOOMR.snippetMethod="s",void t(i.parentNode,"boomr-async");a=document.createElement("IFRAME"),a.src="about:blank",a.title="",a.role="presentation",a.loading="eager",r=(a.frameElement||a).style,r.width=0,r.height=0,r.border=0,r.display="none",i.parentNode.appendChild(a);try{O=a.contentWindow,d=O.document.open()}catch(_){n=document.domain,a.src="javascript:var d=document.open();d.domain='"+n+"';void(0);",O=a.contentWindow,d=O.document.open()}if(n)d._boomrl=function(){this.domain=n,t()},d.write("<bo"+"dy onload='document._boomrl();'>");else if(O._boomrl=function(){t()},O.addEventListener)O.addEventListener("load",O._boomrl,!1);else if(O.attachEvent)O.attachEvent("onload",O._boomrl);d.close()}function a(e){window.BOOMR_onload=e&&e.timeStamp||(new Date).getTime()}if(!window.BOOMR||!window.BOOMR.version&&!window.BOOMR.snippetExecuted){window.BOOMR=window.BOOMR||{},window.BOOMR.snippetStart=(new Date).getTime(),window.BOOMR.snippetExecuted=!0,window.BOOMR.snippetVersion=12,window.BOOMR.url=n+"7R9SM-QGSYF-QDLJK-UETXR-SPM6B";var i=document.currentScript||document.getElementsByTagName("script")[0],o=!1,r=document.createElement("link");if(r.relList&&"function"==typeof r.relList.supports&&r.relList.supports("preload")&&"as"in r)window.BOOMR.snippetMethod="p",r.href=window.BOOMR.url,r.rel="preload",r.as="script",r.addEventListener("load",e),r.addEventListener("error",function(){t(!0)}),setTimeout(function(){if(!o)t(!0)},3e3),BOOMR_lstart=(new Date).getTime(),i.parentNode.appendChild(r);else t(!1);if(window.addEventListener)window.addEventListener("load",a,!1);else if(window.attachEvent)window.attachEvent("onload",a)}}(),"".length>0)if(e&&"performance"in e&&e.performance&&"function"==typeof e.performance.setResourceTimingBufferSize)e.performance.setResourceTimingBufferSize();!function(){if(BOOMR=e.BOOMR||{},BOOMR.plugins=BOOMR.plugins||{},!BOOMR.plugins.AK){var n=""=="true"?1:0,t="",a="qcw62iqx3ygdgyrx542a-f-b1348d7a6-clientnsv4-s.akamaihd.net",i="false"=="true"?2:1,o={"ak.v":"32","ak.cp":"1251022","ak.ai":parseInt("757730",10),"ak.ol":"0","ak.cr":15,"ak.ipv":4,"ak.proto":"http/1.1","ak.rid":"60339ace","ak.r":40197,"ak.a2":n,"ak.m":"dscr","ak.n":"ff","ak.bpcip":"128.173.237.0","ak.cport":36522,"ak.gh":"23.222.12.47","ak.quicv":"","ak.tlsv":"tls1.3","ak.0rtt":"","ak.csrc":"-","ak.acc":"reno","ak.t":"1647832884","ak.ak":"hOBiQwZUYzCg5VSAfCLimQ==RJyyCKd5DZy+pqT28lCyc1d8YvOvuxaGCeDLWLu/ECg37Y63LEo257AWhhSltvr50SO3N+2qewEOQrPWB+aEUpiV28xxyGoB4nvozmI+84BI9J0b4aUXrfzwOMHUt15g58brCkUK7DA7KV5ghPGfNwFqu19MkUKo+MC4aFHj56n8PZig0JPBHgg7/Fk84G0iuHwTEhvKJWKf2GqWUyJlM3SrD4p2hKg7RQJe38fnMETBxlu+zNqIf6ksqMG5lpPT/LjdaKcJQekVM4IYHZ4sUkFRYFlVZkLaaDBfKydrFgSShFy/kr79W5U3rc6TAgE2EY7t84JdTzQ2Z4lqORwFs3dNWK+yJTzo+PLl0BhcdWKT6eJNb41H6NzHaTmWINd79CUJnyGRcPfxv7FfZHoLfcEWMvqlX+lHjTkZ7uy546M=","ak.pv":"11","ak.dpoabenc":"","ak.tf":i};if(""!==t)o["ak.ruds"]=t;var r={i:!1,av:function(n){var t="http.initiator";if(n&&(!n[t]||"spa_hard"===n[t]))o["ak.feo"]=void 0!==e.aFeoApplied?1:0,BOOMR.addVar(o)},rv:function(){var e=["ak.bpcip","ak.cport","ak.cr","ak.csrc","ak.gh","ak.ipv","ak.m","ak.n","ak.ol","ak.proto","ak.quicv","ak.tlsv","ak.0rtt","ak.r","ak.acc","ak.t","ak.tf"];BOOMR.removeVar(e)}};BOOMR.plugins.AK={akVars:o,akDNSPreFetchDomain:a,init:function(){if(!r.i){var e=BOOMR.subscribe;e("before_beacon",r.av,null,null),e("onbeacon",r.rv,null,null),r.i=!0}return this},is_complete:function(){return!0}}}}()}(window);</script></head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2022/01/11/controladores-kernel-firmados-puerta-desprotegida-acceder-nucleo-windows/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2022/01/13/signierte-kernel-treiber-unbewachte-zugaenge-zum-windows-kern/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="http://welivesecurity.com/category/ukraine-crisis-digital-security-resource-center/">
                                            Ukraine Crisis – Digital Security Resource Center                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/we-live-progress/">
                                            We Live Progress                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2022/01/11/controladores-kernel-firmados-puerta-desprotegida-acceder-nucleo-windows/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2022/01/13/signierte-kernel-treiber-unbewachte-zugaenge-zum-windows-kern/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong>					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2022/01/signed-kernel-drivers-windows-vulnerabilities-1.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>Signed kernel drivers – Unguarded gateway to Windows’ core</h1>
<div class="excerpt">ESET researchers look at malware that abuses vulnerabilities in kernel drivers and outline mitigation techniques against this type of exploitation
</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/mposlusny/" title="Michal Poslušný">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2017/09/Michal-Poslusny-2-222x179.jpg" alt="Michal Poslušný">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mposlusny/" title="Michal Poslušný">
                    Michal Poslušný                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2022-01-11 11:30:28">11 Jan 2022 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F&text=Signed kernel drivers – Unguarded gateway to Windows’ core%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>ESET researchers look at malware that abuses vulnerabilities in kernel drivers and outline mitigation techniques against this type of exploitation</p>
                            </div>

                            <p>There are various types of kernel drivers; the first that come to mind are device drivers that provide a software interface to hardware devices like <a href="https://en.wikipedia.org/wiki/Plug_and_play" target="_blank" rel="noopener"><em>plug and play</em></a> interfaces or <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/filter-drivers" target="_blank" rel="noopener"><em>filter drivers</em></a>. These low-level system components have a strict development process including scrutiny regarding security. However, there are additional “software” drivers that are designed to run in Ring 0 and provide specific, non-hardware related features like software debugging and diagnostics, system analysis, etc. As you can see below, these are prone to extend the attack surface significantly.</p>
<p>While directly loading a malicious, unsigned driver is no longer possible in the newer versions of Windows (unless driver signature enforcement is explicitly disabled during boot) and kernel rootkits are considered to be a thing of the past, there are still ways to load malicious code into the kernel. While actual vulnerabilities and exploits that achieve that get a lot of attention, there is a much easier way: abusing legitimate, signed drivers. There are many drivers from various hardware and software vendors lying around that offer functionality to fully access the kernel with minimal effort.</p>
<p>Vulnerabilities in signed drivers are mostly utilized by game cheat developers to circumvent anti-cheat mechanisms, but they have also been observed being used by several APT groups and in commodity malware alike.</p>
<p>This paper discusses the types of vulnerabilities that commonly occur in kernel drivers, provides several case studies of malware utilizing such vulnerable drivers, analyzes examples of vulnerable drivers that we discovered during our research, and outlines effective mitigation techniques against this type of exploitation. While this problem is not new and relevant research about the topic has been presented in the past, mainly during 2018 and 2019 ([1], [2], [3]), it is still a problem as of this writing.</p>
<h2>Common types of driver vulnerabilities</h2>
<p>While every vulnerability is different, similar types of vulnerabilities seem to be recurrent in unrelated kernel drivers. This may be partially caused by <a href="https://github.com/LibreHardwareMonitor/LibreHardwareMonitor/blob/master/WinRing0/OpenLibSys.c" target="_blank" rel="noopener"><em>(ancient) driver code samples</em></a> that were created back when access to kernel mode was not restricted to signed drivers and developers did not take security into consideration (malware could simply load unsigned rootkit drivers instead). The following sections describe the vulnerabilities most frequently observed in drivers from a large variety of, and even high-profile, hardware and software vendors.</p>
<h3>MSR read/write</h3>
<p><a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-software-developers-manual-volume-4-model-specific-registers.html" target="_blank" rel="noopener"><em>Model-specific registers</em></a> (MSRs) were introduced in Pentium 80586 CPUs in 1993. MSRs can be thought of as “global variables” of a CPU (or of a specific core). Some contain various information about the processor or specific CPU core – such as temperature, power, …. Additionally, there are also many MSRs that contain data critical for the working of a system, such as <span style="font-family: courier new, courier, monospace;">IA32_LSTAR</span> (<span style="font-family: courier new, courier, monospace;">0xC0000082</span>) for <span style="font-family: courier new, courier, monospace;">SYSCALL</span> or <span style="font-family: courier new, courier, monospace;">IA32_SYSENTER_EIP</span> (<span style="font-family: courier new, courier, monospace;">0x00000176</span>) for <span style="font-family: courier new, courier, monospace;">SYSENTER</span>, both of which contain pointers to an address in the kernel where the CPU jumps when a <span style="font-family: courier new, courier, monospace;">SYSCALL</span> or <span style="font-family: courier new, courier, monospace;">SYSENTER</span> instruction is executed. On newer Windows x64 platforms such as Windows 10 or 11, <span style="font-family: courier new, courier, monospace;">SYSCALL</span> is used for both AMD and Intel CPUs where <span style="font-family: courier new, courier, monospace;">IA32_LSTAR</span> should point to the <span style="font-family: courier new, courier, monospace;">KiSystemCall64</span> function found in <span style="font-family: courier new, courier, monospace;">ntoskrnl.exe</span>. The mechanism of the transition to Windows kernel when executing <span style="font-family: courier new, courier, monospace;">SYSCALL</span> is displayed in Figure 1.</p>
<div id="attachment_158056" style="width: 910px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows.png"><img class="wp-image-158056" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows-300x54.png" alt="" width="900" height="163" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows-300x54.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows-768x139.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows-1024x186.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-1.-How-SYSCALL-is-handled-in-x64-Windows.png 1190w" sizes="(max-width: 900px) 100vw, 900px" /></a><p class="wp-caption-text"><em>Figure 1. How <span style="font-family: courier new, courier, monospace;">SYSCALL</span> is handled in x64 Windows</em></p></div>
<p>MSRs are indexed by a number and accessed by the privileged <a href="https://www.felixcloutier.com/x86/rdmsr" target="_blank" rel="noopener"><em>RDMSR</em></a> and <a href="https://www.felixcloutier.com/x86/wrmsr" target="_blank" rel="noopener"><em>WRMSR</em></a> instructions, which can only be executed in kernel mode. Many commercial drivers implement functionality for user-mode applications to access these instructions through an IOCTL mechanism. This is usually intended to be able to read or write a few specific innocent MSRs (like CPU voltage, temperature, …), but developers sometimes do not add any additional checks to restrict access to critical MSRs, such as the example seen in Figure 2. This gives potential attackers an opportunity to, for example, patch the <span style="font-family: courier new, courier, monospace;">SYSCALL/SYSENTER</span> entry point MSRs, which are pointers to a function that handles any system call from user mode.</p>
<div id="attachment_158057" style="width: 687px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-2.-Vulnerable-MSR-IOCTL-handler-in-the-AMDPowerProfiler.sys-driver.png"><img class="wp-image-158057 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-2.-Vulnerable-MSR-IOCTL-handler-in-the-AMDPowerProfiler.sys-driver.png" alt="" width="677" height="208" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-2.-Vulnerable-MSR-IOCTL-handler-in-the-AMDPowerProfiler.sys-driver.png 677w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-2.-Vulnerable-MSR-IOCTL-handler-in-the-AMDPowerProfiler.sys-driver-300x92.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-2.-Vulnerable-MSR-IOCTL-handler-in-the-AMDPowerProfiler.sys-driver-522x160.png 522w" sizes="(max-width: 677px) 100vw, 677px" /></a><p class="wp-caption-text"><em>Figure 2. Vulnerable MSR IOCTL handler in the <span style="font-family: courier new, courier, monospace;">AMDPowerProfiler.sys</span> driver</em></p></div>
<p>Overwriting the system call pointer was trivial and very powerful on older CPUs and systems before mitigations like Supervisor Mode Execution Prevention (SMEP) were introduced. On such systems, simply changing the pointer to the address of an arbitrary user-mode executable buffer containing malicious code, and then immediately executing a system call instruction on a same CPU core, was enough to gain kernel-level code execution. This is no longer the case with newer systems due to modern exploitation mitigations. That being said, with clever use of various techniques, it is still possible to bypass most of these mitigations and achieve kernel-level code execution on Windows 10 or even brand-new Windows 11 systems (as of December 2021).</p>
<p>All the mitigations in the following sections are in place on most modern machines and need to be bypassed to achieve successful kernel-mode exploitation.</p>
<h4><em><strong>SMEP</strong></em></h4>
<p>SMEP is a protection mechanism introduced in 2011 in Intel processors based on the Ivy Bridge architecture and enabled by default since Windows 8.0. It prevents execution of code in user-mode pages from Ring 0, and is implemented by assigning a user-mode or kernel-mode value to a flag bit on every virtual memory page in the page table. If a system attempts to execute code in a user-mode page from kernel space, a <span style="font-family: courier new, courier, monospace;">0x000000FC</span> error (<span style="font-family: courier new, courier, monospace;">ATTEMPTED_EXECUTE_OF_NOEXECUTE_MEMORY</span>) will be triggered and cause a BSOD. SMEP can be dynamically toggled on and off during execution with its status saved in the <span style="font-family: courier new, courier, monospace;">CR4</span> register for each CPU core individually (see Figure 3).</p>
<div id="attachment_158058" style="width: 910px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-3.-CR4-register-flags-of-a-CPU-image-credit-Wikipedia.png"><img class="wp-image-158058" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-3.-CR4-register-flags-of-a-CPU-image-credit-Wikipedia-300x250.png" alt="" width="900" height="750" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-3.-CR4-register-flags-of-a-CPU-image-credit-Wikipedia-300x250.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-3.-CR4-register-flags-of-a-CPU-image-credit-Wikipedia-768x640.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-3.-CR4-register-flags-of-a-CPU-image-credit-Wikipedia.png 816w" sizes="(max-width: 900px) 100vw, 900px" /></a><p class="wp-caption-text"><em>Figure 3. <span style="font-family: courier new, courier, monospace;">CR4</span> register flags of a CPU (image credit: Wikipedia)</em></p></div>
<p>SMEP mitigates the naïve exploitation technique of abusing an MSR R/W IOCTL in order to change the <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR to point directly to malicious user-mode code. That being said, since the attacker is in control of the stack that is passed to kernel mode on system calls, they may utilize a technique called a <a href="https://en.wikipedia.org/wiki/Return-oriented_programming" target="_blank" rel="noopener"><em>ROP chain</em></a> to manipulate the stack. By placing a chain of return addresses on the stack, the attacker can arrange to execute a carefully picked set of instructions in kernel mode by changing the <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR via a vulnerable IOCTL. With the stack suitably prepared, executing the system call instruction results in the first “gadget” in the ROP chain executing and when complete its code will “return” to the next gadget in the chain, which was supplied on the stack with the rest of the chain.</p>
<p>The functionality of such a ROP chain is limited by the availability of suitable code chunks, called gadgets, available in the kernel’s modules. Since an attacker can read kernel modules from the file system and knows at which addresses the modules are loaded, the gadgets can be easily looked up and if those gadgets exist, a working ROP chain can then be constructed.</p>
<p>To properly initialize the transition to kernel, the ROP chain needs to swap the <span style="font-family: courier new, courier, monospace;">GS</span> register using the <span style="font-family: courier new, courier, monospace;">SWAPGS</span> instruction. On 64-bit Windows, the GS register holds the address of the Thread Environment Block (TEB) in user mode, and the address of the Kernel Processor Control Region (KPCR) in kernel mode. Therefore, it is crucial that those two addresses change before any operations happen in the kernel. It is no surprise that the <span style="font-family: courier new, courier, monospace;">SWAPGS</span> instruction is also the first instruction in the Windows kernel <span style="font-family: courier new, courier, monospace;">KiSystemCall64</span> function.</p>
<p>The next step is restoring the original value of the <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR using the <span style="font-family: courier new, courier, monospace;">WRMSR</span> instruction, in order to avoid executing the ROP chain on the next execution of the <span style="font-family: courier new, courier, monospace;">SYSCALL</span> instruction.</p>
<p>At this point, the malicious code properly executes in the kernel and the attacker can execute whatever payload is desired. This can be additional ROP gadgets to, for example, disable SMEP or SMAP protections by overwriting <span style="font-family: courier new, courier, monospace;">CR4</span>, or even be direct calls to an exported <span style="font-family: courier new, courier, monospace;">ntoskrnl</span> API function.</p>
<p>The attacker can overwrite <span style="font-family: courier new, courier, monospace;">CR4</span> utilizing a <span style="font-family: courier new, courier, monospace;">MOV CR4</span> gadget to disable SMEP and also SMAP, which is covered in the next section. They then can proceed to execute a user-mode payload directly. The only difficulty with this approach is precalculating a valid <span style="font-family: courier new, courier, monospace;">CR4</span> value. Although most of the <span style="font-family: courier new, courier, monospace;">CR4</span> values can be guessed from user mode by running the <span style="font-family: courier new, courier, monospace;">CPUID</span> instruction, there may be some inconsistencies between different versions of Windows.</p>
<p>To transition back to user mode safely, once the attacker’s ROP chain has run they need to execute the <span style="font-family: courier new, courier, monospace;">SWAPGS</span> instruction again and then execute the <span style="font-family: courier new, courier, monospace;">SYSRET</span> instruction.</p>
<p>Older exploits bypassing SMEP are described in [4], (2015).</p>
<h4><em><strong>SMAP</strong></em></h4>
<p>Supervisor Mode Access Prevention (SMAP) is a newer mitigation that has been introduced to complement SMEP and further restrict access from the kernel to user-mode pages – it disallows both reads and writes. Just as SMEP, its status is stored as a bit in the <span style="font-family: courier new, courier, monospace;">CR4</span> register (see Figure 3).</p>
<p>SMAP should render the previously described ROP chain technique useless, since the stack containing the ROP chain is in fact a user-mode page. A system with SMAP active will bluescreen the moment it tries to access the stack after transitioning to the kernel via the system call.</p>
<p>SMAP can also be temporarily disabled by setting the <span style="font-family: courier new, courier, monospace;">AC</span> flag in the <span style="font-family: courier new, courier, monospace;">EFLAGS</span> CPU register. This feature is also the downfall of this mitigation in regard to MSR exploitation – it turns out the <span style="font-family: courier new, courier, monospace;">AC</span> flag can be set from user mode, right before transitioning to kernel mode, by utilizing the <span style="font-family: courier new, courier, monospace;">POPF</span> and <span style="font-family: courier new, courier, monospace;">PUSHF</span> instructions. This is caused by the <span style="font-family: courier new, courier, monospace;">SFMASK</span> MSR that controls which <span style="font-family: courier new, courier, monospace;">EFLAGS</span> register bits are cleared when the <span style="font-family: courier new, courier, monospace;">SYSCALL</span> instruction is executed. Even on the newest Windows 11 machines, the mask does not have the <span style="font-family: courier new, courier, monospace;">AC</span> flag bit set, which means it is not cleared upon transitioning to the kernel so SMAP can be disabled by the user.</p>
<p>As the <span style="font-family: courier new, courier, monospace;">SFMASK</span> is controlled by another MSR (<span style="font-family: courier new, courier, monospace;">0xC0000084</span>), even if Microsoft changed <span style="font-family: courier new, courier, monospace;">SFMASK</span> to implicitly clear the <span style="font-family: courier new, courier, monospace;">AC</span> flag, theoretically the attacker could patch this MSR prior to the exploitation anyway.</p>
<p>It is worth noting that SMAP has only recently been enabled by default in Windows 10 x64 with newer hardware.</p>
<h4><em><strong>KVA shadowing</strong></em></h4>
<p>KVA shadowing was introduced as a software mitigation for the <a href="https://meltdownattack.com/" target="_blank" rel="noopener"><em>Meltdown</em></a> CPU vulnerability discovered at the end of 2017.</p>
<p>The basic idea of this mitigation is that the virtual address space is split into two – user mode and kernel mode. The user-mode address space has access only to very restricted parts of the <span style="font-family: courier new, courier, monospace;">ntoskrnl</span> module, specifically a single code section called <span style="font-family: courier new, courier, monospace;">.KVASCODE</span> that is responsible for low-level operations like entering and leaving the kernel when handling a system call. This is handled by implementing “Shadow” equivalents of the responsible functions, like <span style="font-family: courier new, courier, monospace;">KiSystemCall64Shadow</span> that works as the original <span style="font-family: courier new, courier, monospace;">KiSystemCall64</span>, but contains differences responsible for handling KVA shadowing and switching the address space context properly (see Figure 4). The rest of the kernel is completely separated and mapped to its own address space and cannot be accessed even directly by the CPU from user-mode address space until the context is appropriately switched.</p>
<div id="attachment_158059" style="width: 910px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function.png"><img class="wp-image-158059" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function-300x272.png" alt="" width="900" height="817" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function-300x272.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function-768x697.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function-1024x930.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function-60x53.png 60w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-4.-Comparison-of-KiSystemCall64-and-KiSystemCall64Shadow-versions-of-the-system-call-handler-–-minor-differences-can-be-spotted-at-the-beginning-of-the-function.png 1044w" sizes="(max-width: 900px) 100vw, 900px" /></a><p class="wp-caption-text"><em>Figure 4. Comparison of <span style="font-family: courier new, courier, monospace;">KiSystemCall64</span> and <span style="font-family: courier new, courier, monospace;">KiSystemCall64Shadow</span> versions of the system call handler – minor differences can be spotted at the beginning of the function</em></p></div>
<p>While KVA shadowing was designed as a fix for the Meltdown vulnerability, it also potentially causes trouble for other kinds of vulnerabilities, including the MSR one.</p>
<p>There are generally two approaches to disable the mitigation – one is to disable it as a setting in the registry. This requires admin access and a reboot afterwards for the changes to take effect.</p>
<p>Alternatively, when building a ROP chain for MSR exploitation, an attacker tries to find gadgets exclusively in the <span style="font-family: courier new, courier, monospace;">.KVASCODE</span> section of the <span style="font-family: courier new, courier, monospace;">ntoskrnl</span> module – since that section handles the system call transition, it is possible to build a working ROP chain.</p>
<p>Similar mitigation was also introduced in Linux systems, where it is called Kernel Page Table Isolation (KPTI).</p>
<h3>Physical memory read/write</h3>
<p>Being able to directly read and write physical memory seems to be a common feature in many low-level kernel drivers. This is achieved by mapping a specific range of physical memory to a virtual memory buffer that can be read or written and even passed to a user-mode application. There are several ways to achieve this, the most common one being an ability to map the <span style="font-family: courier new, courier, monospace;">\Device\PhysicalMemory</span> section to virtual memory, as shown in Figure 5.</p>
<div id="attachment_158061" style="width: 756px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-5.-Physical-memory-map-vulnerability-in-Passmark-DirectIO64.sys-driver.png"><img class="wp-image-158061 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-5.-Physical-memory-map-vulnerability-in-Passmark-DirectIO64.sys-driver.png" alt="" width="746" height="557" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-5.-Physical-memory-map-vulnerability-in-Passmark-DirectIO64.sys-driver.png 746w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-5.-Physical-memory-map-vulnerability-in-Passmark-DirectIO64.sys-driver-300x224.png 300w" sizes="(max-width: 746px) 100vw, 746px" /></a><p class="wp-caption-text"><em>Figure 5. Physical memory map vulnerability in Passmark <span style="font-family: courier new, courier, monospace;">DirectIO64.sys</span> driver</em></p></div>
<p>A potential drawback for the attackers is that they first need to translate the virtual address to a physical one. Drivers that implement physical memory I/O sometimes also offer an IOCTL for physical to virtual address translation, but even if the driver does not have any such address conversion, there are still many ways to utilize this feature.</p>
<p>The most straightforward use case is simply to walk through all the physical memory looking for specific artifacts that represent critical data structures that the attacker wants to find. For example, the attacker might try to look for the <span style="font-family: courier new, courier, monospace;">EPROCESS</span> structure of the malicious process and elevate it to SYSTEM privileges by stealing a token from a more privileged process or modifying its rights. Some of these strategies are demonstrated <a href="https://www.jackson-t.ca/lg-driver-lpe.html" target="_blank" rel="noopener">here</a> and <a href="https://h0mbre.github.io/atillk64_exploit/" target="_blank" rel="noopener">here</a>.</p>
<p>Since physical memory mappings disregard any virtual memory protection features, it is also possible to write to executable memory pages. This gives the attacker an opportunity to look up specific kernel modules and chunks of code, carefully modify them and, if patched code can be executed via a system API or an IOCTL of a driver, to achieve malicious kernel-level code execution.</p>
<h3>Virtual memory read/write</h3>
<p>Virtual memory access IOCTLs are not as commonly found in these drivers as physical memory ones, but they have very similar repercussions. Utilizing these is even easier, as there is no address translation needed and all the virtual kernel addresses found from user mode can be accessed directly. A potential downside is that the access is limited by the memory protection of the target address, so it is not possible to write read-only memory pages without changing the protection first.</p>
<p>Therefore, this vulnerability is commonly used to manipulate various kernel data structures to achieve things like elevating a malicious process to SYSTEM rights by stealing tokens from such kernel structures.</p>
<p>The most common way this vulnerability arises is via an IOCTL with a simple pointer dereference in kernel mode, so it can be hard to detect this vulnerability using heuristic methods.</p>
<h2>Case studies</h2>
<p>When malware actors need to run malicious code in the Windows kernel on x64 systems with driver signature enforcement (DSE) in place, carrying a vulnerable signed kernel driver seems to be a viable option for doing so. This technique is known as Bring Your Own Vulnerable Driver (BYOVD) and has been observed being used in the wild by both high-profile APT actors and in commodity malware.</p>
<p>In the following sections we present some examples.</p>
<h3>Slingshot APT</h3>
<p>Slingshot is a cyberespionage platform that was uncovered by Kaspersky in 2018 [5] and is believed to have been active since at least 2012. The actors behind this malware decided to implement their main module, called Cahnadr, as a kernel-mode driver. On older x86 systems, the driver would be loaded directly by the user-mode module. On newer systems with active DSE, they decided to implement a custom driver loader that leverages the following signed kernel drivers with MSR vulnerabilities: <a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/09133534/The-Slingshot-APT_report_ENG_final.pdf" target="_blank" rel="noopener"><em>Goad</em></a>, SpeedFan (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-5633" target="_blank" rel="noopener"><em>CVE-2007-5633</em></a>), Sandra (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-1592" target="_blank" rel="noopener"><em>CVE-2010-1592</em></a>), and ElbyCDIO (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-0824" target="_blank" rel="noopener"><em>CVE-2009-0824</em></a>). The exploitation targeted pre-Windows 8 systems, so the exploitation was a simple modification of the <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR to point to a malicious payload in a user-mode buffer.</p>
<p>Note that the Kaspersky researchers estimated these threat actors to have been active from 2012 to 2018, which means that these exploits were quite old and well known, but that was no reason for the attackers to stop using them as the certificates of those vulnerable drivers were never revoked.</p>
<h3>InvisiMole</h3>
<p>In 2018, fellow ESET researchers uncovered a sophisticated APT actor that they named InvisiMole [6]. The group has been tracked by ESET ever since and in 2020 an extensive <a href="https://www.welivesecurity.com/wp-content/uploads/2020/06/ESET_InvisiMole.pdf"><em>white paper</em></a> about the group and its toolset was published. In that white paper, our colleagues reported that InvisiMole used the BYOVD technique, exploiting the MSR vulnerability in the <span style="font-family: courier new, courier, monospace;">speedfan.sys</span> driver (CVE-2007-5633) to load a malicious unsigned driver. While this campaign was targeting older x86 systems and the exploitation using a malicious driver was trivial from the modern standpoint, due to the fact there were no mitigations like SMEP in place, it was still an interesting case showing that the group behind this malware is very technically capable.</p>
<p>Later during that investigation, however, a newer variant of the InvisiMole malware using the BYOVD technique was discovered. This variant is the only case to date that we have observed of MSR exploitation on Windows 10 x64 systems being used in the wild by a malicious actor. It employs advanced techniques to bypass mitigations like SMEP and even SMAP. That being said, the exploitation is mitigated by KVA shadowing, which the authors failed to take care of. Coincidentally, MSR exploitation was used to deploy a malicious driver that attempted to disable our security products. Although the whole compromise chain is more extensive, we will focus on a specific part of the malware that leverages the BYOVD technique and MSR exploitation that happens in the main user-mode module.</p>
<h4><em><strong>User-mode module</strong></em></h4>
<p>InvisiMole’s authors seem to have developed a sophisticated ROP chain exploitation framework that they use for MSR exploitation – although the sample contains many debug messages in the code, we were not able to identify and link them to any known projects. This leads us to believe the framework is an original work of these malware authors and that non-negligible resources have been spent on developing it. The framework is an extensive C++ codebase with various classes.</p>
<p>It appears that InvisiMole’s authors did not know about the possibility of setting the <span style="font-family: courier new, courier, monospace;">AC</span> flag with the <span style="font-family: courier new, courier, monospace;">PUSHF</span> and <span style="font-family: courier new, courier, monospace;">POPF</span> instructions as described in the <em>SMAP</em> section, and instead chose a very complex ROP gadget found in the <span style="font-family: courier new, courier, monospace;">MiDbgCopyMemory</span> kernel function that starts with the privileged <span style="font-family: courier new, courier, monospace;">STAC</span> instruction, which is dedicated to setting the AC flag (see Figure 6). On top of that, InvisiMole utilizes the <span style="font-family: courier new, courier, monospace;">IRETQ</span> instruction after every gadget that explicitly sets the <span style="font-family: courier new, courier, monospace;">RFLAGS</span> register with the <span style="font-family: courier new, courier, monospace;">AC</span> flag set, which stabilizes the exploit even further.</p>
<div id="attachment_158062" style="width: 589px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-6.-ROP-gadget-used-by-InvisiMole-to-disable-SMAP-mitigation.png"><img class="wp-image-158062 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-6.-ROP-gadget-used-by-InvisiMole-to-disable-SMAP-mitigation.png" alt="" width="579" height="454" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-6.-ROP-gadget-used-by-InvisiMole-to-disable-SMAP-mitigation.png 579w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-6.-ROP-gadget-used-by-InvisiMole-to-disable-SMAP-mitigation-300x235.png 300w" sizes="(max-width: 579px) 100vw, 579px" /></a><p class="wp-caption-text"><em>Figure 6. ROP gadget used by InvisiMole to disable SMAP mitigation</em></p></div>
<p>The initial gadget jumps directly to the <span style="font-family: courier new, courier, monospace;">STAC</span> instruction, which immediately disables SMAP by setting the AC flag. Since this gadget appears in the middle of the <span style="font-family: courier new, courier, monospace;">MiDbgCopyMemory</span> function, the malware carefully prepares the stack and registers to safely leave the function. Once the <span style="font-family: courier new, courier, monospace;">MiDbgCopyMemory</span> function returns, the ROP chain proceeds to the <span style="font-family: courier new, courier, monospace;">SWAPGS</span> gadget [7] in order to properly switch to kernel mode, followed by the <span style="font-family: courier new, courier, monospace;">WRMSR</span> gadget to set the <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR back to its original value. At this point, InvisiMole will proceed with executing the payload, which may be an exported kernel function or the entry point of a loaded malicious driver.</p>
<h4><strong>Driver loader</strong></h4>
<p>The driver loading technique is quite complex – InvisiMole will first install a “driver loader” – another kernel driver module that is used to load the malicious payload (yet another driver) passed as an argument. To initialize the driver loader, InvisiMole executes several separate MSR exploitations, where every instance carries a dedicated ROP chain with a single API call payload. The malware will start by executing <span style="font-family: courier new, courier, monospace;">ExAllocatePoolWithTag</span> to allocate an executable kernel memory buffer for the loader, followed by preparing the image in user mode to reflect its future address in the kernel – sections are moved to their virtual offsets; imports are resolved, and relocations fixed. Once the image is ready, it is copied over from user mode to the allocated kernel buffer using <span style="font-family: courier new, courier, monospace;">memcpy</span> from the <span style="font-family: courier new, courier, monospace;">ntoskrnl</span> module.</p>
<p>To transfer code execution to the loader once it is copied to the kernel, InvisiMole’s authors also leverage the MSR vulnerability and designed several dedicated PE exports in the loader (see Figure 7 for an example) that are intended to handle transitions from user-mode system calls. It works very similarly to the ROP chain gadgets – swap the <span style="font-family: courier new, courier, monospace;">GS</span> register, swap the user-mode and kernel-mode stacks, save all registers on the stack, restore the original <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR value and then call the actual function. Once finished, this process is reversed.</p>
<div id="attachment_158154" style="width: 910px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1.png"><img class="wp-image-158154" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1-300x159.png" alt="" width="900" height="476" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1-300x159.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1-768x406.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1-1024x542.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-7.-Exported-function-in-the-driver-loader-module-that-is-called-by-changing-LSTAR-MSR-1.png 1495w" sizes="(max-width: 900px) 100vw, 900px" /></a><p class="wp-caption-text"><em>Figure 7. Exported function in the driver loader module that is called by changing <span style="font-family: courier new, courier, monospace;">LSTAR</span> MSR</em></p></div>
<p>When the loader is properly initialized in the kernel, an export named <span style="font-family: courier new, courier, monospace;">_Start64</span> is executed by changing LSTAR MSR to the export address in the kernel. After handling the transition to the kernel, _Start64 registers a deferred routine that is responsible for loading the payload driver, and returns to user mode. The deferred loader routine will attempt to initialize the payload driver in a “proper” fashion – creating registry keys and kernel driver objects, performing all the necessary steps to register the driver in the system as if the operating system were loading the driver itself, and eventually calling <span style="font-family: courier new, courier, monospace;">IoCreateDriver</span>. The proper initialization approach was chosen so the loaded payload driver can process I/O request packets and communicate with a user-mode module using IOCTLs.</p>
<h4><strong>Payload driver</strong></h4>
<p>The payload driver offers IOCTL functionality for disabling various notification callbacks (see Figure 8), mostly aimed at disarming third-party security solutions, and the possibility of protecting a file in the file system. The specific commands are passed from the user-mode module. Interestingly, the user-mode module will attempt to disable various parts of ESET protection in the kernel.</p>
<div id="attachment_158155" style="width: 535px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-8.-IOCTL-handler-in-the-InvisiMole-payload-driver-1.png"><img class="wp-image-158155 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-8.-IOCTL-handler-in-the-InvisiMole-payload-driver-1.png" alt="" width="525" height="584" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-8.-IOCTL-handler-in-the-InvisiMole-payload-driver-1.png 525w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-8.-IOCTL-handler-in-the-InvisiMole-payload-driver-1-270x300.png 270w" sizes="(max-width: 525px) 100vw, 525px" /></a><p class="wp-caption-text">Figure 8. IOCTL handler in the InvisiMole payload driver</p></div>
<h3>RobbinHood</h3>
<p>Seeing a BYOVD technique in commodity malware that aims to reach as many people as possible is rare, but the RobbinHood ransomware family shows that it may still prove useful [8].</p>
<p>This ransomware leverages a vulnerable GIGABYTE motherboard driver <span style="font-family: courier new, courier, monospace;">GDRV.SYS</span> (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2018-19320" target="_blank" rel="noopener"><em>CVE-2018-19320</em></a>; see Figure 9 and Figure 10) to disable DSE in order to install its own malicious driver.</p>
<div id="attachment_158065" style="width: 683px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-9.-GIODrv-driver-exploitation-in-RobbinHood-sample.png"><img class="wp-image-158065 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-9.-GIODrv-driver-exploitation-in-RobbinHood-sample.png" alt="" width="673" height="612" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-9.-GIODrv-driver-exploitation-in-RobbinHood-sample.png 673w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-9.-GIODrv-driver-exploitation-in-RobbinHood-sample-300x273.png 300w" sizes="(max-width: 673px) 100vw, 673px" /></a><p class="wp-caption-text"><em>Figure 9. GIODrv driver exploitation in RobbinHood sample</em></p></div>
<p>The way DSE is disabled depends on the Windows version – on Windows 7 and older, an <span style="font-family: courier new, courier, monospace;">nt!g_CiEnabled</span> variable is modified directly in the ntoskrnl module. On newer Windows 8 through Windows 11 systems, the variable <span style="font-family: courier new, courier, monospace;">ci!g_CiOptions</span> in the<span style="font-family: courier new, courier, monospace;"> ci.dll</span> module is modified instead. Finding this variable is slightly more complicated and it looks like the authors adopted a method found in an open-source project called <a href="https://github.com/hfiref0x/DSEFix" target="_blank" rel="noopener"><em>DSEFix</em></a> that is available on GitHub. Moreover, since Windows 8.1, the variables in <span style="font-family: courier new, courier, monospace;">ci.dll</span> are protected by <a href="https://en.wikipedia.org/wiki/Kernel_Patch_Protection" target="_blank" rel="noopener"><em>PathcGuard</em></a> and tampering with the module will eventually cause the system to BSOD, even if the variable is changed back to an original value.</p>
<p>The malicious driver is then used to kill a long list of processes and delete their files, mainly focusing on endpoint protection software and other utilities. Since the termination is done from kernel mode, most self-protection mechanisms employed by security software are circumvented and the technique is more likely to succeed than attempting to disarm the protections from user mode.</p>
<div id="attachment_158066" style="width: 489px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-10.-WriteVirtualMemory-IOCTL-handler-in-GIODrv.png"><img class="wp-image-158066 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-10.-WriteVirtualMemory-IOCTL-handler-in-GIODrv.png" alt="" width="479" height="468" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-10.-WriteVirtualMemory-IOCTL-handler-in-GIODrv.png 479w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-10.-WriteVirtualMemory-IOCTL-handler-in-GIODrv-300x293.png 300w" sizes="(max-width: 479px) 100vw, 479px" /></a><p class="wp-caption-text"><em>Figure 10. <span style="font-family: courier new, courier, monospace;">WriteVirtualMemory</span> IOCTL handler in GIODrv</em></p></div>
<h3>LoJax</h3>
<p>In 2018, ESET researchers discovered the <a href="https://www.welivesecurity.com/2018/09/27/lojax-first-uefi-rootkit-found-wild-courtesy-sednit-group/" target="_blank" rel="noopener">first-ever UEFI rootkit used in the wild</a>. In order to have access to victims’ UEFI modules, the malware utilizes a powerful utility called RWEverything.</p>
<p>The RWEverything driver was recently disabled by Microsoft directly in Windows 10 and 11 using the HVCI memory integrity feature described in the <em>Virtualization-based security</em> section.</p>
<h2>Discovered vulnerabilities</h2>
<p>During our research we decided not only to catalog existing vulnerabilities, but also to look for new ones. We set up YARA rules to hunt for kernel drivers with specific functionality and indicators of being potentially vulnerable. We also created a proof-of-concept exploitation framework for testing the newly found drivers and confirming that they are exploitable.</p>
<p>We went through hundreds of different kernel drivers that matched our criteria and aside from finding the already discovered drivers, we also found three drivers previously not known to be vulnerable, some containing several unrelated bugs. The fact that even after several independent research groups tackled this area we were still able to find new vulnerabilities, even from reputable vendors, shows that Windows driver security is still an issue.</p>
<p>While we were looking for all kinds of vulnerabilities described in previous sections, finding ones with MSR access turned out to be the easiest, appearing most commonly due to the use of special privileged instructions (<span style="font-family: courier new, courier, monospace;">RDMSR</span>/<span style="font-family: courier new, courier, monospace;">WRMSR</span>) that give away this functionality. Interestingly enough, in many cases it would turn out that this class of drivers also contained other kinds of vulnerabilities like arbitrary physical or virtual memory read and write functions.</p>
<h3>AMD μProf (CVE-2021-26334)</h3>
<p>We have identified an MSR vulnerability in the <span style="font-family: courier new, courier, monospace;">AMDPowerProfiler.sys</span> kernel driver, which is a part of <a href="https://developer.amd.com/amd-uprof/" target="_blank" rel="noopener"><em>AMD μProf</em></a> profiling software.</p>
<p>What makes this driver stand out is that once the underlying software package is installed, the driver runs on every system boot. The unfiltered MSR IOCTL access combined with the lack of <span style="font-family: courier new, courier, monospace;">FILE_DEVICE_SECURE_OPEN</span> flags (see Figure 11) and on-boot presence gives the attacker a good opportunity to exploit the driver even as an unprivileged user – this is an advantage compared to the BYOVD approach when the attacker needs to load the driver themselves.</p>
<div id="attachment_158067" style="width: 784px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-11.-AMD-uProf-kernel-driver-device-creation-without-the-FILE_DEVICE_SECURE_OPEN-flag-allowing-non-admin-access.png"><img class="wp-image-158067 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-11.-AMD-uProf-kernel-driver-device-creation-without-the-FILE_DEVICE_SECURE_OPEN-flag-allowing-non-admin-access.png" alt="" width="774" height="200" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-11.-AMD-uProf-kernel-driver-device-creation-without-the-FILE_DEVICE_SECURE_OPEN-flag-allowing-non-admin-access.png 774w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-11.-AMD-uProf-kernel-driver-device-creation-without-the-FILE_DEVICE_SECURE_OPEN-flag-allowing-non-admin-access-300x78.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-11.-AMD-uProf-kernel-driver-device-creation-without-the-FILE_DEVICE_SECURE_OPEN-flag-allowing-non-admin-access-768x198.png 768w" sizes="(max-width: 774px) 100vw, 774px" /></a><p class="wp-caption-text"><em>Figure 11. AMD uProf kernel driver device creation without the <span style="font-family: courier new, courier, monospace;">FILE_DEVICE_SECURE_OPEN</span> flag allowing non-admin access</em></p></div>
<p>On the other hand, the software is a niche utility for developers and not a package distributed to a large number of systems. We have not identified any other vulnerability in the driver.</p>
<p>The vulnerable IOCTL is <span style="font-family: courier new, courier, monospace;">IOCTL_ACCESS_MSR</span> (<span style="font-family: courier new, courier, monospace;">0x222030</span>).</p>
<p>AMD acknowledged the vulnerability (<a href="https://www.amd.com/en/corporate/product-security/bulletin/amd-sb-1016" target="_blank" rel="noopener"><em>CVE-2021-26334</em></a>) and released a fix in the November 2021 <a href="https://www.amd.com/en/corporate/product-security/bulletin/amd-sb-1016" target="_blank" rel="noopener"><em>Patch Tuesday</em></a> release.</p>
<h3>Passmark software</h3>
<p>Passmark is a company offering various computer benchmark and diagnostic tools. To achieve such functionality in user mode, a lot of low-level system features need to be accessed by leveraging a kernel-mode driver.</p>
<p>Passmark’s <span style="font-family: courier new, courier, monospace;">DirectIo32.sys</span> and <span style="font-family: courier new, courier, monospace;">DirectIo64.sys</span> kernel drivers are a common framework shared and distributed among several of the vendor’s applications – namely BurnInTest, PerformanceTest and OSForensics.</p>
<p>The driver contains direct, unfiltered MSR R/W access (<a href="https://github.com/eset/vulnerability-disclosures/blob/master/CVE-2020-15480/CVE-2020-15480.md" target="_blank" rel="noopener"><em>CVE-2020-15480</em></a>), an ability to map physical memory (<a href="https://github.com/eset/vulnerability-disclosures/blob/master/CVE-2020-15481/CVE-2020-15481.md" target="_blank" rel="noopener"><em>CVE-2020-15481</em></a>) for both reading and writing, and the IOCTL handler also contains a buffer overflow (<a href="https://github.com/eset/vulnerability-disclosures/blob/master/CVE-2020-15479/CVE-2020-15479.md" target="_blank" rel="noopener"><em>CVE-2020-15479</em></a>) due to blindly copying, without any size check, an IOCTL input buffer of arbitrary size to a local variable on the stack.</p>
<p>Passmark acknowledged these vulnerabilities and released a fixed version soon thereafter.</p>
<h4><em><strong>CVE-2020-15479</strong></em></h4>
<p>When the driver receives an IOCTL request from a user-mode program, it will first copy the requested input buffer into a local buffer on the stack. The size of the <span style="font-family: courier new, courier, monospace;">memmove</span> is based only on the size of the input buffer (see Figure 12) and does not consider the capacity of the stack buffer. This may lead to a buffer overflow, if a large enough IOCTL buffer is provided. There are multiple unchecked <span style="font-family: courier new, courier, monospace;">memmove</span> calls in the IOCTL handler function and several IOCTLs can be used to leverage the buffer overflow.</p>
<div id="attachment_158068" style="width: 727px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-12.-Buffer-overflows-in-the-vulnerable-Passmark-drivers.png"><img class="wp-image-158068 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-12.-Buffer-overflows-in-the-vulnerable-Passmark-drivers.png" alt="" width="717" height="360" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-12.-Buffer-overflows-in-the-vulnerable-Passmark-drivers.png 717w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-12.-Buffer-overflows-in-the-vulnerable-Passmark-drivers-300x151.png 300w" sizes="(max-width: 717px) 100vw, 717px" /></a><p class="wp-caption-text"><em>Figure 12. Buffer overflows in the vulnerable Passmark drivers</em></p></div>
<h4><em><strong>CVE-2020-15480</strong></em></h4>
<p>This driver offers <span style="font-family: courier new, courier, monospace;">RDMSR</span> and <span style="font-family: courier new, courier, monospace;">WRMSR</span> functionality exposed via an IOCTL that allows an unprivileged user-mode program to read and write arbitrary CPU MSRs without any additional checks. The vulnerable IOCTLs are <span style="font-family: courier new, courier, monospace;">IOCTL_READ_MSR</span> (<span style="font-family: courier new, courier, monospace;">0x80112060</span>) and <span style="font-family: courier new, courier, monospace;">IOCTL_WRITE_MSR</span> (<span style="font-family: courier new, courier, monospace;">0x80112088</span>).</p>
<h4><em><strong>CVE-2020-15481</strong></em></h4>
<p>Physical memory mapping functionality is exposed via a single control code – <span style="font-family: courier new, courier, monospace;">IOCTL_MAP_PHYSICAL_MEMORY</span> (<span style="font-family: courier new, courier, monospace;">0x80112044</span>). The implementation is split into two parts: the primary version is done through the <span style="font-family: courier new, courier, monospace;">ZwMapViewOfSection</span> API; if for some reason this method fails, the function also implements a secondary approach as a backup, through the <span style="font-family: courier new, courier, monospace;">MmMapIoSpace</span> and <span style="font-family: courier new, courier, monospace;">MmMapLockedPages</span> kernel APIs. Both are illustrated in Figure 13.</p>
<div id="attachment_158069" style="width: 825px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers.png"><img class="wp-image-158069 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers.png" alt="" width="815" height="709" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers.png 815w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers-300x261.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers-768x668.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers-87x77.png 87w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers-60x53.png 60w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-13.-Physical-memory-IOCTL-implementation-in-Passmarks-drivers-85x75.png 85w" sizes="(max-width: 815px) 100vw, 815px" /></a><p class="wp-caption-text"><em>Figure 13. Physical memory IOCTL implementation in Passmark&#8217;s drivers</em></p></div>
<h3>Devid Espenschied PC Analyser</h3>
<p>PC Analyser is another utility for inspecting various details about the machine. The <span style="font-family: courier new, courier, monospace;">PCADRVX64.sys</span> kernel driver distributed with the application contains two separate vulnerabilities – unfiltered MSR access (<a href="https://github.com/eset/vulnerability-disclosures/blob/master/CVE-2020-28921/CVE-2020-28921.md" target="_blank" rel="noopener"><em>CVE-2020-28921</em></a>) and ability to read from and write to arbitrary physical memory addresses (<a href="https://github.com/eset/vulnerability-disclosures/blob/master/CVE-2020-28922/CVE-2020-28922.md" target="_blank" rel="noopener"><em>CVE-2020-28922</em></a>). When creating the driver device, the <span style="font-family: courier new, courier, monospace;">FILE_DEVICE_SECURE_OPEN</span> flag is unspecified, allowing unprivileged users to retrieve a handle to the driver.</p>
<p>Devid Espenschied acknowledged the vulnerabilities and released an updated version.</p>
<h4><em><strong>CVE-2020-28921</strong></em></h4>
<p>As with previous drivers, MSR access is unrestricted (see Figure 14) and the IOCTL code handler contains <span style="font-family: courier new, courier, monospace;">FILE_ANY_ACCESS</span> flags allowing even an unprivileged user to leverage the functionality.</p>
<div id="attachment_158070" style="width: 604px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-14.-MSR-IOCTL-implementation-in-PC-Analyser-driver.png"><img class="wp-image-158070 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-14.-MSR-IOCTL-implementation-in-PC-Analyser-driver.png" alt="" width="594" height="513" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-14.-MSR-IOCTL-implementation-in-PC-Analyser-driver.png 594w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-14.-MSR-IOCTL-implementation-in-PC-Analyser-driver-300x259.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-14.-MSR-IOCTL-implementation-in-PC-Analyser-driver-60x53.png 60w" sizes="(max-width: 594px) 100vw, 594px" /></a><p class="wp-caption-text"><em>Figure 14. MSR IOCTL implementation in PC Analyser driver</em></p></div>
<h4><em><strong>CVE-2020-28922</strong></em></h4>
<p>The driver’s physical memory read and write functionality is implemented with separate IOCTLs based on the size of the read or write request. It offers the following control codes, none of which make any checks on the memory addresses targeted by the request:</p>
<p style="margin-left: 5%; margin-right: 5%;"><span style="font-family: courier new, courier, monospace;"><span style="font-family: courier new, courier, monospace;">IOCTL_READ_PHYSICAL_MEMORY_BYTE (0x82002400)</span><br />
<span style="font-family: courier new, courier, monospace;">IOCTL_READ_PHYSICAL_MEMORY_WORD (0x82002500)</span><br />
<span style="font-family: courier new, courier, monospace;">IOCTL_READ_PHYSICAL_MEMORY_DWORD (0x82002600)</span><br />
<span style="font-family: courier new, courier, monospace;">IOCTL_WRITE_PHYSICAL_MEMORY_BYTE (0x82002700)</span><br />
<span style="font-family: courier new, courier, monospace;">IOCTL_WRITE_PHYSICAL_MEMORY_WORD (0x82002800)</span><br />
<span style="font-family: courier new, courier, monospace;">IOCTL_WRITE_PHYSICAL_MEMORY_DWORD (0x82002900)</span> </span></p>
<h2>Mitigations</h2>
<p>While we have already mentioned several mechanisms employed by the CPU and/or the operating system, most of them can be bypassed with some clever techniques and are not very effective if the attacker prepares for them ahead of time. In this section we would like to mention some mitigation ideas that are actually effective at completely stopping the abuse of vulnerable drivers.</p>
<h3>Virtualization-based security</h3>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs" target="_blank" rel="noopener"><em>Virtualization-based security</em></a> or VBS is a feature introduced in Windows 10 that leverages hardware virtualization and makes the kernel sandboxed by a hypervisor in order to secure the operating system with various protections.</p>
<p>VBS offers several protection features with the most prominent one being Hypervisor-Protected Code Integrity (HVCI), which also comes as a standalone feature. HVCI enforces code integrity in the kernel and allows only signed code to be executed. It also employs blocklisting functionality, where a known piece of code signed by a specific, valid signature can be blocklisted and not allowed to be run or to be loaded. One of the drivers <a href="https://twitter.com/dwizzzleMSFT/status/1334560031342096384" target="_blank" rel="noopener"><em>that has been blocklisted already</em></a> via this method is the RWEverything utility.</p>
<p>HVCI effectively prevents vulnerable drivers from being abused to execute unsigned kernel code or load malicious drivers (regardless of the exploitation method used) and it seems that malware abusing vulnerable drivers to load malicious code was one of the <a href="https://www.microsoft.com/security/blog/2021/01/11/new-surface-pcs-enable-virtualization-based-security-vbs-by-default-to-empower-customers-to-do-more-securely/" target="_blank" rel="noopener"><em>main motivations behind Microsoft implementing this feature</em></a>:</p>
<p style="margin-left: 5%; margin-right: 5%;">VBS provides significant security gains against practical attacks including several we saw last year, including human-operated <em>ransomware attacks like RobbinHood and sophisticated malware attacks like Trickbot, which employ kernel drivers and techniques that can be mitigated by HVCI</em>. Our research shows that there were 60% fewer active malware reports from machines reporting detections to Microsoft 365 Defender with HVCI enabled compared to systems without HVCI. The Surface Book 3 shipped in May 2020 and the Surface Laptop Go shipped in October 2020, and users may not have noticed they are running VBS and are therefore better protected based on the work done under the hood. <em>[emphasis added]</em></p>
<p>Aside from enforcing kernel code integrity, VBS also secures important MSRs and disallows any changes to them. Unsurprisingly, this protection also affects the LSTAR MSR and mitigates all of the exploitation possibilities described above.</p>
<p>While VBS is an effective protection against MSR exploitation and running malicious code in the kernel in general, the adoption of this new feature is quite limited, as it has <a href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs" target="_blank" rel="noopener"><em>several hardware requirements</em></a> that only newer machines can fulfill. There are also some drawbacks with the most notable being <a href="https://www.tomshardware.com/news/windows-11-gaming-benchmarks-performance-vbs-hvci-security"><em>a performance hit</em></a>, which may be quite noticeable depending on the workload. While <a href="https://www.pcgamer.com/windows-11-pcs-can-hobble-gaming-performance/" target="_blank" rel="noopener"><em>some benchmarks estimate the performance hit being as high as 25%</em></a> in specific video games, the <a href="https://www.tomshardware.com/news/windows-11-gaming-benchmarks-performance-vbs-hvci-security" target="_blank" rel="noopener"><em>more detailed benchmarking by Tom’s Hardware</em></a> estimates the performance hit being around 5% depending on the specific benchmarks and hardware configuration (see Figure 15), which is still not a negligible amount and may lead some users to consider turning this feature off. There might also be some compatibility issues with legacy drivers and software. With the release of Windows 11, Microsoft has decided to enable HVCI by default for all compatible devices.</p>
<div id="attachment_158071" style="width: 638px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-15.-VBS-benchmark-results-by-Tom’s-Hardware.png"><img class="wp-image-158071 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-15.-VBS-benchmark-results-by-Tom’s-Hardware.png" alt="" width="628" height="240" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-15.-VBS-benchmark-results-by-Tom’s-Hardware.png 628w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-15.-VBS-benchmark-results-by-Tom’s-Hardware-300x115.png 300w" sizes="(max-width: 628px) 100vw, 628px" /></a><p class="wp-caption-text"><em>Figure 15. VBS benchmark results by <a href="https://www.tomshardware.com/news/windows-11-gaming-benchmarks-performance-vbs-hvci-security" target="_blank" rel="noopener"><em>Tom’s Hardware</em></a></em></p></div>
<h4><em><strong>Third-party hypervisor</strong></em></h4>
<p>Similar to Microsoft’s VBS, with new enough hardware, a third-party security solution may deploy its own custom hypervisor. Running the operating system under a hypervisor gives a detailed oversight of the state of the machine and provides the possibility of inspecting and intercepting any event including execution of a specific instruction. As with VBS, this comes at a cost, namely performance and compatibility.</p>
<h3>Certificate revocation</h3>
<p>On modern Windows systems, drivers need to have a valid signature based on an “acceptable” certificate. Hence, revoking the certificate of a vulnerable driver would be an easy way to “disarm” it and render it useless in most cases.</p>
<p>Sadly, revocation rarely ever happens and of the vulnerable drivers documented in our research above, not a single one of them has had its signature revoked. There are probably a multitude of reasons why such revocations are not happening, but the primary ones are likely to be time and cost. As nobody requires the revocation, it does not make much sense from the vendor’s standpoint to ask for revocation, as this will be a costly and time-consuming process. Moreover, a signing certificate is usually shared among other projects, so the potential revocation because of a single driver could hinder the development of every project.</p>
<p>Further, during our research we <a href="https://decoded.avast.io/martinchlumecky/dirtymoe-3/" target="_blank" rel="noopener"><em>learned</em></a> that drivers with revoked certificates are not always blocked and that this problem is more complicated than it seemed at first. Revocation may not be the easiest solution after all.</p>
<h3>Driver blocklisting</h3>
<p>Driver blocklisting is a practice adopted by both Microsoft and various third-party security product vendors. Several of the most notorious vulnerable drivers are detected by ESET security products and deleted when found on a system. Microsoft also opted to blocklist drivers not only with its security solution, but also directly by the operating system utilizing their HVCI mitigation, which is part of virtualization-based security. While blocklisting is effective, it is not a proactive solution – only previously discovered vulnerable drivers can be blocklisted, and it must be done manually by each vendor. This means that this mitigation will not be effective against previously unknown, zero-day driver vulnerabilities that may be used in a sophisticated APT attack.</p>
<p>Probably the most prominent blocklisted driver is the Capcom “anti-cheat” driver <span style="font-family: courier new, courier, monospace;">Capcom.sys</span>, which explicitly implements an IOCTL that simply executes the contents of the provided buffer in kernel mode (see Figure 16). To be able to execute a buffer provided from user mode, it even temporarily disables SMEP!</p>
<p>When discovered, the driver made several headlines and many unsigned driver loader tools were created based on abusing this function of the driver. Consequently, the driver was eventually <a href="https://www.virustotal.com/gui/file/da6ca1fb539f825ca0f012ed6976baf57ef9c70143b7a1e88b4650bf7a925e24" target="_blank" rel="noopener"><em>blocklisted by many security product vendors</em></a> including Microsoft and ESET.</p>
<div id="attachment_158072" style="width: 410px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver.png"><img class="wp-image-158072" src="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver.png" alt="" width="400" height="350" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver.png 286w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver-87x77.png 87w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver-60x53.png 60w, https://www.welivesecurity.com/wp-content/uploads/2022/01/Figure-16.-Code-snippet-from-Capcom-anti-cheat-driver-85x75.png 85w" sizes="(max-width: 400px) 100vw, 400px" /></a><p class="wp-caption-text"><em>Figure 16. Code snippet from Capcom anti-cheat driver</em></p></div>
<h2>Conclusion</h2>
<p>Vulnerable drivers have been a known problem for a long time and have been abused by the game-cheating community and malware authors alike, and while some effort has been made to mitigate the effects, it is still an ongoing battle. It seems that all the responsible parties involved want to solve this problem – the vendors we contacted were incredibly proactive during the disclosure process, eager to fix the vulnerabilities we uncovered. Microsoft is trying to strengthen the operating system from the inside and last but not least, third-party security vendors are trying to come up with clever ways to detect and mitigate such drivers themselves.</p>
<p>However, it seems that there is still a piece missing – a common, unified way of handling these issues including more thorough “disarming” of the drivers, whether by revoking or blocklisting their certificates, or some public, shared blocklists adopted by the security companies.<br />
<small></small></p>
<h2>Bibliography</h2>
<p><small><br />
[1] J. Desimone and G. Landau, &#8220;<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Desimone-Kernel-Mode-Threats-and-Practical-Defenses.pdf">BlackHat 2018: Kernel-mode Threats and Practical Defences</a>,&#8221; 9 August 2018. [Online].<br />
[2] R. Warns and T. Harrison, &#8220;<a href="https://downloads.immunityinc.com/infiltrate2019-slidepacks/ryan-warns-timothy-harrison-device-driver-debauchery-msr-madness/MSR_Madness_v2.9_INFILTRATE.pptx" target="_blank" rel="noopener">INFILTRATE 2019: Device Driver Debauchery and MSR Madness</a>,&#8221; 2 May 2019. [Online].<br />
[3] J. Michael and M. Skhatov, &#8220;<a href="https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-27-Jesse-Michael-Get-off-the-kernel-if-you-cant-drive.pdf" target="_blank" rel="noopener">Defcon 27: Get off the Kernel if you can&#8217;t Drive</a>,&#8221; 13 August 2019. [Online].<br />
[4] N. Economou and E. Nissim, &#8220;ekoparty 2015: <a href="https://www.coresecurity.com/sites/default/files/2020-06/Windows%20SMEP%20bypass%20U%20equals%20S_0.pdf" target="_blank" rel="noopener">Windows SMEP bypass: U=S</a>,&#8221; 2015. [Online].<br />
[5] A. Shulmin, S. Yunakovsky, V. Berdnikov and A. Dolgushev, &#8220;<a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/09133534/The-Slingshot-APT_report_ENG_final.pdf" target="_blank" rel="noopener">The Slingshot APT</a>,&#8221; 6 March 2018. [Online].<br />
[6] Z. Hromcová and A. Cherepanov, &#8220;<a href="https://www.welivesecurity.com/wp-content/uploads/2020/06/ESET_InvisiMole.pdf" target="_blank" rel="noopener">InvisiMole: The Hidden Part of the Story – Unearthing InvisiMole&#8217;s Espionage Toolset and Strategic Cooperations</a>,&#8221; 18 June 2020. [Online].<br />
[7] A. Ionescu, &#8220;UMPOwn: Ring 3 to Ring 0 in 3 acts,&#8221; in PoC||GTFO, vol. 2, No Starch Press, 2018, p. 768.<br />
[8] A. Brandt and M. Loman, &#8220;<a href="https://news.sophos.com/en-us/2020/02/06/living-off-another-land-ransomware-borrows-vulnerable-driver-to-remove-security-software/" target="_blank" rel="noopener">Living off another land: Ransomware borrows vulnerable driver to remove security software</a>,&#8221; Sophos, 7 February 2020. [Online].</small></p>
<p><a class="no-fancy" href="https://www.eset.com/int/business/services/threat-intelligence/?utm_source=welivesecurity.com&amp;utm_medium=referral&amp;utm_campaign=wls-research&amp;utm_content=signed-kernel-drivers-unguarded-gateway-windows-core" target="_blank" rel="noopener"><img class="aligncenter wp-image-152551" src="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png" alt="" width="899" height="290" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png 918w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-300x97.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-768x248.png 768w" sizes="(max-width: 899px) 100vw, 899px" /></a></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mposlusny/" title="Michal Poslušný">
                    Michal Poslušný                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2022-01-11 11:30:28">11 Jan 2022 - 11:30AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="https://enjoy.eset.com/pub/rf" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
                    <input type="text" name="EMAIL_ADDRESS_" value="" placeholder="Email...">
                    <input type="hidden" name="NEWSLETTER" value="We Live Security">

                    <input type="hidden" name="_ri_" value="X0Gzc2X%3DAQpglLjHJlTQGgXv4jDGEK4KW2uhw0qgUzfwuivmOJOPCgzgo9vsI3VwjpnpgHlpgneHmgJoXX0Gzc2X%3DAQpglLjHJlTQGzbD6yU2pAgzaJM16bkTA7tOwuivmOJOPCgzgo9vsI3">
                    <input type="hidden" name="_ei_" value="Ep2VKa8UKNIAPP_2GAEW0bY">
                    <input type="hidden" name="_di_" value="m0a5n0j02duo9clmm4btuu5av8rdtvqfqd03v1hallrvcob47ad0">
                    <input type="hidden" name="EMAIL_PERMISSION_STATUS_" value="O">
                    <input type="hidden" name="CONTACT_SOURCE_MOST_RECENT" value="WLS_Subscribe_Form">
                    <button>
						Submit					</button>
				</div>
			</form>
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/01/25/watering-hole-deploys-new-macos-malware-dazzlespy-asia/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/01/dazzlespy-malware-macos-623x415.jpg"
                                                         alt="Signed kernel drivers – Unguarded gateway to Windows’ core">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/01/25/watering-hole-deploys-new-macos-malware-dazzlespy-asia/">
                                                    Watering hole deploys new macOS malware, DazzleSpy, in Asia                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/01/18/donot-go-do-not-respawn/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/01/donot-team-malware-eset-research-623x415.jpg"
                                                         alt="Signed kernel drivers – Unguarded gateway to Windows’ core">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/01/18/donot-go-do-not-respawn/">
                                                    DoNot Go! Do not respawn!                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2021/12/15/dirty-dozen-latin-america-amavaldo-zumanek/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/12/banking-trojans-latin-america-research-623x415.jpg"
                                                         alt="Signed kernel drivers – Unguarded gateway to Windows’ core">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/12/15/dirty-dozen-latin-america-amavaldo-zumanek/">
                                                    The dirty dozen of Latin America: From Amavaldo to Zumanek                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2021/12/02/launching-eset-research-podcast-peek-behind-scenes-eset-discoveries/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/12/eset-research-code-logo-thumbnail-623x432.png"
                                                         alt="Signed kernel drivers – Unguarded gateway to Windows’ core">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/12/02/launching-eset-research-podcast-peek-behind-scenes-eset-discoveries/">
                                                    Launching ESET Research Podcast: A peek behind the scenes of ESET discoveries                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy Policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F01%2F11%2Fsigned-kernel-drivers-unguarded-gateway-windows-core%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/js/main.js?id=fef3139dcedd23afc232"></script>
    <!-- Version: v1.7.3.41514b.pro.azeu -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"158055 https:\/\/backend.welivesecurity.com\/?p=158055","disqusShortname":"welivesecurity","disqusTitle":"Signed kernel drivers \u2013 Unguarded gateway to Windows\u2019 core","disqusUrl":"https:\/\/www.welivesecurity.com\/2022\/01\/11\/signed-kernel-drivers-unguarded-gateway-windows-core\/","postId":"158055"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>
